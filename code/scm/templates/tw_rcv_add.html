<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=big5">
   <title>===:::::::::: 積物料輔助系統 [ 驗收 資料 ] ::::::::::===</title>
<link rel=stylesheet type="text/css" href="./bom.css">

{literal}
<style type="text/css">
<!--
#Layer1 {
background: #333333;
opacity:0.45;
filter: alpha(opacity=26);
position:absolute;
top:0px;
left:0px; 
height:expression(window.document.body.clientHeight);
}
-->
</style>
<script language="javascript" src="./js/open_detial.js"></script>
<script type="text/javascript" src="./js/jquery.min.js"></script>
<script type="text/javascript" src="./js/jquery.blockUI.js"></script>

<Script language="javascript">
  
function roundAmount(n)   {   
	var s = "" + Math.round(n * 100) /   100   
	var i = s.indexOf('.')   
	if (i < 0) return s + ".00"   
	var t = s.substring(0, i + 1) + s.substring(i + 1, i + 3)   
	if (i + 2 == s.length) t += "0"   
	return t   
}

function roundAmount2(n)   {   
	var s = "" + Math.round( n * 100 ) / 100   
	var i = s.indexOf('.')   
	if ( i < 0 ) return s
	var t = s.substring( 0 , i )
		return t   
}  
  
function check(r,ship_qty)
{
	ship_qty = parseFloat(ship_qty);
	// 輸入值
	var rcv = r.value;
	
	if (rcv > ship_qty)
	{
		r.value = prompt("Export Q'TY : " + ship_qty +
								"  but Receive Q'TY : " + parseFloat( rcv ) + "  Pls re-input for Receive Q'TY : " , ship_qty);
	}
	return;
}

function show_rcvd_qty(ship_link_id)
{
	var url ="tw_receive.php?PHP_action=recv_qty_show&PHP_ship_link_id="+ship_link_id;
	var nm = 'rcvd';
	window.open2(url,nm,'toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,copyhistory=no,width=600,height=500 top=50, left=100');
}

function disabled_append(){
    /*var cq = 0;
    $("input[id^=un_qty]").each(function(i, elm) {
        if ( $(elm).val() > '0' && $(elm).val() != '0.00' ) {
            cq++;
        }
    });
    
    if ( cq == 0 ) {
        alert('Data error!!!');
        return false;
    }*/

	$.blockUI({ message: '<div><h4>Appending...</h4></div>'});
	//document.getElementById("Layer1").style.display='block';
}

$(document).ready(function() {
    select_checkbox = function(status){
        if ( status == 'Reply' ) {
            $("input[id^=un_qty]").each(function(i, elm) {
                $(elm).val($("#MK_"+$(elm).attr("id")).val());
            });
            invoice();
        } else {
            $("input[id^=un_qty]").each(function(i, elm) {
                $(elm).val('0');
            });
            invoice();
        }
    }
    
    Ditto = function(id){
		$("#PHP_qty_"+id).val($("#MK_un_qty_"+id).val()).change();
    }
});

var pre_det_id;
function chk_qty(r,det_id){
	var sum_avg_qty = 0;
	var qty = Number($("#PHP_qty_"+det_id).val());
	
	$("input[id^=link_qty_"+det_id+"]").each(function(i, elm) {
		sum_avg_qty += Number($(elm).val());
	});
	
	if(pre_det_id == det_id)
		document.getElementById('descript').innerHTML = "";
	
	if(sum_avg_qty != qty){
		$("#update_rcv").attr("disabled",true);
		$("#descript").css("display","");
		document.getElementById('descript').innerHTML += "=====Order Q'ty=====&nbsp;&nbsp;<br>";
		$("input[id^=link_qty_"+det_id+"]").each(function(i, elm) {
			document.getElementById('descript').innerHTML += $(elm).val() + "&nbsp;" + "<BR>";
		});
		document.getElementById('descript').innerHTML += "<hr>";
		document.getElementById('descript').innerHTML += "Total " + sum_avg_qty + "<br>";
		document.getElementById('descript').innerHTML += "Not Equal Rcv qty " + qty + "<br>";
		var pos = $(r).offset();  
		var x = pos.left-50;  
		var y = pos.top;  
		$("#descript").css("top",y+"px");
		$("#descript").css("left",x+70+"px");
	}else{
		document.getElementById('descript').innerHTML = "";
		$("#descript").css("display","none");
		$("#update_rcv").attr("disabled",false);
	}
	pre_det_id = det_id;
}

function avg_qty(rcv_qty,det_id,po_qty){
	var rcv_qty = Number(rcv_qty);
	var tmp_qty = sum_tmp_qty = percent = count = k = 0;
	var un_qty = Number($("#m_un_qty_"+det_id).text());
	if(rcv_qty > un_qty){
		alert(	"++++++ Receive is illegial!! ++++++\r" +
								"\r       Receive remain Q'TY : " + un_qty +
								"\r       but input receive Q'TY : " + rcv_qty +
								"\r\rClick OK. Set Receive Q'TY = " + un_qty );
		$("#PHP_qty_"+det_id).val(un_qty);
		$("#PHP_qty_"+det_id).change();
		return;
	}
	
	percent = rcv_qty / po_qty;
	percent = roundAmount(percent);
	$("input[id^=link_qty_"+det_id+"]").each(function(i, elm) {
		count++;
	});
	
	$("input[id^=po_qty_"+det_id+"]").each(function(i, elm) {
		k++;
		str = $(elm).attr("id").split("po_qty");
		
		if( k != count ){
			tmp_qty = roundAmount( Number($(elm).val()) * percent );
			sum_tmp_qty += Number(tmp_qty);
			$("#link_qty"+str[1]).val(tmp_qty);
			
		}else{
			sum_tmp_qty = roundAmount(sum_tmp_qty);
			$("#link_qty"+str[1]).val(roundAmount(rcv_qty - sum_tmp_qty));
		}
	});
}

function re_cal_all_avg(){
	$("input[id^=PHP_qty_]").each(function(i, elm) {
		str = $(elm).attr("id").split("PHP_qty_");
		avg_qty($("#PHP_qty_"+str[1]).val(), str[1], $("#PHP_po_qty_"+str[1]).val())
	});
}
</script>
{/literal}
<body topmargin="10" onload="">
<div id="Layer1" style="display : none;" ><table width="100%" height="100%"><tr><td align="center" valign="middle" ><img src="./images/ajpk.gif" border=0 width="66" height="66"></td></tr></table></div>
<div id="descript" style="position:absolute;width:150px;background-color:#f5e700;text-align:right;display:none"></div>
<form METHOD="POST" name="rcvd_add" action="{$PHP_SELF}">
<br>
<table cellspacing=1 cellpadding=4 cols=1 width=900 bgcolor=#003300>
	<tr><td class="des" align=center height=28>[<b> Taiwan Receiving&nbsp; <span class=ylw10>Append&nbsp;</span>Record </b> ] </td></tr>
</table>

{if $msg_YES}
     <table border=1 cellpadding=4 cellspacing=0 cols=1 width=900>
      <tr bgcolor=#ffffff>
        <td width=90 class=gry10 align=center><img src="images/alert.gif" border=0></td>
        <td class=bgdy>{section name=SEC_MSG loop=$msg} {$msg[SEC_MSG]}<br>{/section}</td>
      </tr>
     </table>
{/if}

<table border=0 cellspacing=2 cellpadding=2 width=900 bgcolor=#FFFFFF>
  <tr>
    <td colspan=10 class=frnt align=center><hr size=2 width=98%></td>
    
  </tr>
  <tr>
		<td width=100 class=snvy align=right bgcolor=#E9F7E8><b>Receiving # : </b> &nbsp;</td>
		<td width=120 align=left>&nbsp;	<b>{$rcv_num}</b></td>
		<td width=60 class=snvy align=right bgcolor=#E9F7E8><b>Dept : </b> &nbsp;</td>
		<td width=60 align=left>&nbsp; <b>{$dept}　</b></td>
		<td width=120 class=snvy align=right bgcolor=#E9F7E8><b>Receiver : </b> &nbsp;</td>
		<td width=240 align=left>&nbsp;	<b>{$user}</b></td>
	</tr>
	<tr>
		<td width=100 class=snvy  align=right bgcolor=#E9F7E8><b>Ship #: </b> &nbsp;</td>
		<td width=120 align=left>&nbsp; <b>S{$po_supl_ship.id}</b></td>
		<td width=60 class=snvy align=right bgcolor=#E9F7E8><b>Ship : </b> &nbsp;</td>
		<td width=60 align=left>&nbsp; <b>{$po_supl_ship.dist}</b>
			<input type="hidden" name="PHP_dist" class=select value="{$po_supl_ship.dist}">
		</td>
		<td width=120 class=snvy  align=right bgcolor=#E9F7E8><b></b> &nbsp;</td>
		<td width=240 align=left>&nbsp; <b></b>
			
		</td>
		<input type="hidden" name="PHP_dept" value="{$dept}">
  </tr>
  <tr>
    <td colspan=10 class=frnt align=center><hr size=2 width=98%></td>
  </tr>
</table>


<input name="radio" type="radio" value="" Onclick="select_checkbox('Clear');"/> Clear All Receive Q'ty 
<input name="radio" type="radio" value="" Onclick="select_checkbox('Reply');"/> Reply All Receive Q'ty 

<table border="2" width="980" cellspacing=0 cellpadding=5 id="table1">	
	<tr bgcolor="#584E5C" height=30>
		<td width="110" class=back align="center"><b>Invoice #</b></td>
		<td width="70"  class=back align="center"><b>Order #</b></td>
		<td width="90"  class=back align="center"><b>P / O #</b></td>
		<td width="100" class=back align="center"><b>Material #</b></td>		
		<td width="120" class=back align="center"><b>color/cat</b></td>		
		<td width="90"  class=back align="center"><b>Export Q'ty</b></td>		
		<td width="90" class=back align="center"><b>Rcvd. Q'ty</b></td>	
		<td width="70" class=back align="center"><b>Remain</b></td>
		<td width="100" class=back align="center"><b>Receiving</b></td>
	</tr>
{section name=PUR_D loop=$po_supl_ship_det}
	{section name=DET_D loop=$po_supl_ship_det[PUR_D].po_det_link}
	<tr>
		<td align="center"><input type=text name="PHP_inv[{$po_supl_ship_det[PUR_D].po_det_link[DET_D].id}]" size=15 class=select value="{$po_supl_ship_det[PUR_D].invoice_num}" readonly></td>
		<td  align="left" nowrap>
 	  	{section name=AP loop=$po_supl_ship_det[PUR_D].po_det_link[DET_D].orders}
 	 	  	<a href="javascript:po_bom_view('{$po_supl_ship_det[PUR_D].po_det_link[DET_D].orders[AP].order_num}','{$po_supl_ship_det[PUR_D].po_num}')" style='cursor:pointer'>{$po_supl_ship_det[PUR_D].po_det_link[DET_D].orders[AP].order_num}</a>&nbsp;<br>
			<input type="hidden" id="link_qty_{$po_supl_ship_det[PUR_D].po_det_link[DET_D].id}_{$po_supl_ship_det[PUR_D].po_det_link[DET_D].orders[AP].id}" name="PHP_link_qty[{$po_supl_ship_det[PUR_D].po_det_link[DET_D].id}][{$po_supl_ship_det[PUR_D].po_det_link[DET_D].orders[AP].id}]" value="{$po_supl_ship_det[PUR_D].po_det_link[DET_D].orders[AP].qty}">
			<input type="hidden" id="po_qty_{$po_supl_ship_det[PUR_D].po_det_link[DET_D].id}_{$po_supl_ship_det[PUR_D].po_det_link[DET_D].orders[AP].id}" value="{$po_supl_ship_det[PUR_D].po_det_link[DET_D].orders[AP].po_qty}">
			<input type="hidden" name="PHP_ord_num[{$po_supl_ship_det[PUR_D].po_det_link[DET_D].id}][{$po_supl_ship_det[PUR_D].po_det_link[DET_D].orders[AP].id}]" value="{$po_supl_ship_det[PUR_D].po_det_link[DET_D].orders[AP].order_num}">
		{/section}
		</td>
		<td align="center" nowrap>
			<a href="javascript:po_show('{$po_supl_ship_det[PUR_D].ap_num}','')" style='cursor:pointer'><b>{$po_supl_ship_det[PUR_D].po_num}&nbsp;</b></a>
		</td>
		<td align="center" nowrap>
			  <a href="javascript:{if $po_supl_ship_det[PUR_D].po_det_link[DET_D].mat_cat == 'l'}Show_fab{else}Show_acc{/if}('{$po_supl_ship_det[PUR_D].po_det_link[DET_D].mat_code}')" style='cursor:pointer'>{$po_supl_ship_det[PUR_D].po_det_link[DET_D].mat_id}</a>
		</td>
		<td align="left"><small>{$po_supl_ship_det[PUR_D].po_det_link[DET_D].color}</small>&nbsp;</td>
		<td align="right" nowrap>{$po_supl_ship_det[PUR_D].po_det_link[DET_D].qty|number_format:"2f"} {$po_supl_ship_det[PUR_D].po_det_link[DET_D].po_unit}</td>
		<td align="right" nowrap>
			<a href="javascript:show_rcvd_qty({$po_supl_ship_det[PUR_D].po_det_link[DET_D].id})" style='cursor:pointer'>
			{$po_supl_ship_det[PUR_D].po_det_link[DET_D].rcvd_qty} {$po_supl_ship_det[PUR_D].po_det_link[DET_D].po_unit}</a>
		</td>	
		<td align="right" nowrap>
			<font color={if $po_supl_ship_det[PUR_D].un_qty >= 0}navy{/if} {if $po_supl_ship_det[PUR_D].po_det_link[DET_D].un_qty < 0}red{/if}>
			<b><span id="m_un_qty_{$po_supl_ship_det[PUR_D].po_det_link[DET_D].id}">{$po_supl_ship_det[PUR_D].po_det_link[DET_D].un_qty}</span></b></font>
		</td>
		<td cellpadding=2 align="right" nowrap> <a href="javascript:Ditto('{$po_supl_ship_det[PUR_D].po_det_link[DET_D].id}');">=></a>
			<input type=text id="PHP_qty_{$po_supl_ship_det[PUR_D].po_det_link[DET_D].id}" name="PHP_qty[{$po_supl_ship_det[PUR_D].po_det_link[DET_D].id}]" size=11 class=select value="{$po_supl_ship_det[PUR_D].po_det_link[DET_D].un_qty}" onchange="this.value=this.value.replace(/[^\d\.]/g,'');avg_qty(this.value,'{$po_supl_ship_det[PUR_D].po_det_link[DET_D].id}','{$po_supl_ship_det[PUR_D].po_det_link[DET_D].ttl_po_qty}');" style=text-align:center {if $po_supl_ship_det[PUR_D].po_det_link[DET_D].un_qty <= 0}readonly{/if}>
        </td>
			<input type="hidden" name="PHP_ap_num[{$po_supl_ship_det[PUR_D].po_det_link[DET_D].id}]" value="{$po_supl_ship_det[PUR_D].ap_num}">
			<input type="hidden" name="PHP_mat_cat[{$po_supl_ship_det[PUR_D].po_det_link[DET_D].id}]" value="{$po_supl_ship_det[PUR_D].po_det_link[DET_D].mat_cat}">
			<input type="hidden" name="PHP_mat_id[{$po_supl_ship_det[PUR_D].po_det_link[DET_D].id}]" value="{$po_supl_ship_det[PUR_D].po_det_link[DET_D].mat_id}">
			<input type="hidden" name="PHP_size[{$po_supl_ship_det[PUR_D].po_det_link[DET_D].id}]" value="{$po_supl_ship_det[PUR_D].po_det_link[DET_D].size}">
			<input type="hidden" name="PHP_color[{$po_supl_ship_det[PUR_D].po_det_link[DET_D].id}]" value="{$po_supl_ship_det[PUR_D].po_det_link[DET_D].color}">
			<input type="hidden" name="PHP_link_id[{$po_supl_ship_det[PUR_D].po_det_link[DET_D].id}]" value="{$po_supl_ship_det[PUR_D].po_det_link[DET_D].id}">
	</tr>
	{/section}
{/section}
</table>
<br>


<table width="900" border="0" cellspacing="6" cellpadding="6">
  <tr>
    <td>&nbsp;</td>
    <td width="10%" align="right" nowrap>Receiving Date：<b>{$date}</b></td>
    <td width="10%" align="right" nowrap>User：<font color="#0000FF"><b>{$user}</b></font></td>
  </tr>
</table>
<table border=0 cellspacing=0 cellpadding=0 cols=2 width=900>
 <tr> 
 	<td>
	{if $back_str}
		<input type=button onClick="window.location.href='{$PHP_SELF}?PHP_action=rcvd_add_search{$back_str}'" value=" << go back " class=select_e style="cursor:pointer; width=99%">
	{else}&nbsp;
	{/if}
	</td>
  <td align=center>
  	<input type="hidden" name="PHP_back_str" value="{$back_str}">
    <input type="hidden" name="PHP_ship_id" value="{$po_supl_ship.id}">
    <input type="hidden" name="PHP_action" value="do_rcv_add">
    	
		<input type=submit value="[ Append above record ]" class=select_e style="cursor:pointer; width=95%" onClick="return disabled_append()">

   </td>
 </tr>
</table>
</form>


<!--------- footer ---------->
{include file="footer.html"}
