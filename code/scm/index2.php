<?php
session_start();
session_register	('SCACHE');
session_register	('PAGE');
session_register	('TEMP');
session_register	('authority');
session_register	('where_str');
session_register	('parm');
session_register	('PHP_ses_etd');
session_register	('PHP_unstatus');
session_register	('sch_parm');
session_register	('sub_ti');
$PHP_action = !empty($PHP_action) ? $PHP_action : '' ;
// echo $PHP_action.'<br>';
if( @$_SESSION['USER']['ADMIN']['dept'] == "SA" ) {
	// echo $PHP_action.'<br>';
	// print_r($_GET);
	// echo '<p>';
	// print_r($_POST);
	// echo '<p>';
}
##################  2004/11/10  ########################
#			index.php  主程式
#		for Carnival SCM [Sample]  management
#			Jack Yang     2004/11/10
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#
#	  order status :
#		status == 0			waitt'g for IE rec.
#		status == 1			wait for submit
#		status == 2			waitt'g for CFM
#		status == 3			waitt'g for APV
#		status == 4			APVED
#		status == 5			Reject
#		status == 6			SCHDL CFMing
#		status == 7			SCHDL CFMed
#		status == 8			PRODUCING
#		status == 10		= FINISHED =
#		status == 12		== SHIPPED ==
#		
#   2005/08/31 改由資料庫抓 su [以 ie 計算填入 ]
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


//	case "fty_mon_schedule":	job 81-2-1	FTY SCHEDULE 工廠月排產 

//	case "sales_forecast":		job 91  業務預算
//	case "forecast_search":		job 91S  預算search
//	case "forecast_add":		job 91A  預算 ADD
//	case "do_forecast_add":		job 91A  預算 ADD
//	case "forecast_update":		job 91A  預算更新
//	case "do_forecast_update":	job 91E  預算更新





#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//		job 39  [生產製造][生產產能]
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//	case "shp_out":			job 39-4-1    SHIPPING 月報表
//	case "fty_etp_monthy":	job 39-3-1    FTY SCHEDULE 排產 月報表
//	case "etp_monthy":		job 39-2-1    SALES ETP 月報表
//	case "monthy_daily_ouput":	job 39-1-2    每日產出量 月報表
//	case "daily_ouput":			job 39-1-3    每日產出量 報表
//	case "order_output":		job 39-1-4     訂單 產出量記錄 報表

//	case "schedule_excel":		job 36X    確認訂單 記錄轉成 excel 檔
//	case "ie_excel":			job 35X    生產記錄轉成 excel 檔
//	case "pdt_excel":			job 38X    生產 記錄轉成 excel 檔
//	case "order_excel":			job 101X    訂單 記錄轉成 excel 檔


//	case "IE_record":			job 35   IE 記錄
//	case "ie_search":
//	case "ie_record_view":
//	case "add_ie1":
//	case "cfm_ie1":
//	case "add_ie2":
//	case "cfm_ie2":
//	case "smpl_apv_record":		job 105  樣本確認 記錄
//	case "smpl_apv_rec_search":
//	case "smpl_apv_rec_view":
//	case "add_smpl_apv_date":
//	*** 8 ********* CAPACITY **************
//	case "capacity_search":		job 81  生產產能
//	case "do_capacity_search":
//	case "capacity_add":
//	case "do_capacity_add":
//	case "capacity_update":
//	case "do_capacity_edit":
//	*** 3 ********* PRODUCTIOIN ***********
//	case "production":			job 38  生產記錄
//	case "production_search":
//	case "add_production":
//	case "finish_production":
//  case "re_open_finish":
//	case "del_production":
//	case "del_shipping":

//	case "shipping":			job 39  出口記錄
//	case "shipping_search":
//	case "add_shipping":


//	case "ord_schedule":		 job 106  訂單 進度
//	case "ord_schedule_search":
//	case "ord_schedule_view":
//	case "cfm_pd_schedule":		job 37  訂 單 排 程  確認 			
//	case "cfm_schedule_view":
//	case "do_cfm_pd_schedule":
//	case "material_schedule":	job 104  主副料進度
//	case "mat_schedule_search":
//	case "mat_schedule_view":
//	case "do_mat_schedule":
//	case "mat_ship":
//	case "macc_ship":
//	case "acc_ship":
//	case "pd_schedule":			job 36  生產排程
//	case "schedule_search":
//	case "schedule_view":
//	case "do_pd_schedule":
//	
//	case "ag":					AG  樣本進度追蹤  [8, 3 ]
//	case "ag_search":
//	case "ag_add":
//	case "fabric_excel":
//	case "fabric_print_search":
//	case "do_fabric_print_search":
//	case "fabric_label_print":
//	case "fabric_label":
//	case "test2":
//	case "bom":				BOM  生產用料  [4, 1 ]
//	case "bom_print":
//	case "bom_search_wi":
//	case "bom_add":
//	case "do_bom_add":
//	case "bom_view":
//	case "do_bom_del":
//	case "wi":				job 31  製作令
//	case "wi_search":
//	case "wi_add":
//	case "do_wi_add_1":
//	case "del_colorway":    // 新增製作令
//	case "add_colorway":      // 新增製作令
//	case "do_wi_add_qty":
//	case "do_wi_add_2":
//	case "wi_view":
//	case "wi_edit":
//	case "edit_del_colorway":
//	case "edit_add_colorway":
//	case "do_wi_edit":
//	case "wi_del":
//	case "ti":				 生產說明
//	case "ti_search_wi":   //  先找出製造令.......
//	case "ti_add":
//	case "ti_view":
//	case "do_ti_add":
//	case "do_ti_del":
//	case "show_size_des_search":		====== 為了 新增製造令 使用
//	case "size_des":		 size_des 部份
//	case "size_des_add":
//	case "do_size_des_add":
//	case "size_des_view":
//	case "size_des_edit":
//	case "size_des_edit":
//	case "size_des_del":


//	case "smpl_acc":		樣本副料 
//	case "smpl_acc_search":
//	case "smpl_acc_add":
//	case "smpl_acc_view":
//	case "show_acc_search":
//	case "do_smpl_acc_add":
//	case "do_smpl_acc_del":

//	case "smpl_mat":		樣本主料
//	case "smpl_mat_search":
//	case "smpl_mat_add":
//	case "smpl_mat_view":
//	case "show_lots_search":
//	case "do_smpl_lots_add":
//	case "do_smpl_lots_del":

//	case "smpl":
//	case "smpl_search":
//	case "smpl_add":
//	case "do_smpl_add":
//	case "smpl_copy":
//	case "copy_smpl_add":
//	case "smpl_view":
//	case "smpl_edit":
//	case "do_smpl_edit":
//	case "smpl_del":
//	case "show_smpl_search":
//	case "acc":
//	case "acc_add":
//	case "do_acc_search":
//	case "do_acc_add":
//	case "acc_view":
//	case "acc_edit":
//	case "do_acc_edit":
//	case "acc_del":
//	case "lots":
//	case "do_lots_search":
//	case "lots_add":
//	case "do_lots_add":
//	case "lots_view":
//	case "lots_edit":
//	case "do_lots_edit":
//	case "lots_del":
//	case "supl":
//	case "supl_search":
//	case "supl_add":
//	case "do_supl_add":
//	case "supl_view":
//	case "supl_edit":
//	case "do_supl_edit":
//	case "supl_del":

//	case "cust":			job 11  cust
//	case "cust_add":
//	case "do_cust_add":
//	case "cust_view":
//	case "cust_edit":
//	case "do_cust_edit":
//	case "cust_del":
//	case "user":			job 62   USER  
//	case "user_add":
//	case "do_user_add":
//	case "cfm_user_add":
//	case "user_view":
//	case "user_edit":
//	case "do_user_edit":
//	case "user_disable":
//	case "user_enable":
//	case "user_del":
//	case "team":			job 61  team
//	case "team_add":
//	case "do_team_add":
//	case "team_view":
//	case "team_edit":
//	case "do_team_edit":
//	case "team_del":
//	case "fabric":			JOB  9-1   研究開發 [ 布料開發]
//	case "fabric_search":
//	case "fabric_add":
//	case "do_fabric_add":
//	case "fabric_view":
//	case "fabric_edit":
//	case "do_fabric_edit":
//	case "fabric_del":
//	case "supl_type":
//	case "do_supl_type_add":
//	case "supl_type_update":
//	case "do_supl_type_updat":
//	case "supl_type_del":
//	case "dept":
//	case "do_dept_add":
//	case "dept_update":
//	case "do_dept_updat":
//	case "dept_del":
//	case "smpl_type":
//	case "do_smpl_type_add":
//	case "smpl_type_update":
//	case "do_smpl_type_updat":
//	case "smpl_type_del":
//	case "style_type":
//	case "do_style_type_add":
//	case "style_type_update":
//	case "do_style_type_updat":
//	case "style_type_del":
//	case "season":
//	case "do_season_add":
//	case "season_update":
//	case "do_season_updat":
//	case "season_del":


#		system part
//	case "login":
//	case "exe_login":         (default;)
//	case "main":							notice
//	case "do_login":
//	case "changePass":
//	case "do_change_pass":
//	case "logout":
//	case "change_passwd":
//	case "change_passwd_step2":

//	case "show_page":
//	case "display_page":
//	case "log_admin":			   job 63  system log //  呈現  admin log 主頁
//	case "log_admin_show":		   查尋 admin log 檔內容
//	case "log_admin_cfm_delete":   刪除 admin log 檔
//	case "log_admin_delete":	   刪除 admin log 檔
//


#		order part
//	case "order_entry":			job 101  訂 單
//	case "order_search":
//	case "order_view":			job 101 oreder record view
//	case "order_add":			job 101 order record add
//	case "do_order_add":
//	case "order_edit":
//	case "do_order_edit":
//	case "send_order_cfm":
//	case "order_cfm":			job 102  訂 單 確 認  [  高階授權 的 job ]
//	case "order_cfm_view":
//	case "do_order_cfm":
//	case "reject_order_cfm":
//	case "order_apv":			job 103  訂 單 核 可 
//	case "order_apv_view":
//	case "reject_order_apv":	

//	case "revise_order":		job 101R   revise order 更新訂單 記錄
//	case "do_order_revise":		job 101R   do revise order 記錄
//	case "revise_order_view":	
//  case "shift_order":		轉換訂單 承製工廠	shift order
//  case "do_order_shift":

//	case "apply": 請購

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

require_once "config.php";
require_once "config.admin.php";

$PHP_SELF = $_SERVER['PHP_SELF'];

$perm = $GLOBALS['power'];

require_once "init.object.php";

$op = array();

//系統提示參數取得
session_register	('alt_value');
$para_cm = $para->get(0,'una-production_etd');
$alt_value['una_prd'] = $para_cm['set_value'];
$para_cm = $para->get(0,'un-submit_etd');
$alt_value['un_sub'] = $para_cm['set_value'];
$para_cm = $para->get(0,'un-schedule_etd');
$alt_value['un_schld'] = $para_cm['set_value'];
$para_cm = $para->get(0,'unfinish_etd');
$alt_value['un_fish'] = $para_cm['set_value'];
$para_cm = $para->get(0,'un-eta_etd');
$alt_value['un_eta'] = $para_cm['set_value'];
$para_cm = $para->get(0,'un-smplapv_etd');
$alt_value['un_smpl'] = $para_cm['set_value'];
$para_cm = $para->get(0,'no_patten');
$alt_value['no_pttn'] = $para_cm['set_value'];
$para_cm = $para->get(0,'smpl_apv_undo');
$alt_value['smpl_apv_undo'] = $para_cm['set_value'];
$para_cm = $para->get(0,'none_wiws');
$alt_value['none_wiws'] = $para_cm['set_value'];
$para_cm = $para->get(0,'valid_sample');
$alt_value['valid_smpl'] = $para_cm['set_value'];


//系統Message刪除量
$tmp = $para->get(0,'msg_del');
$msg_del = $tmp['set_value'];

session_register	('FTY_ETD_LIMIT');
$FTY_ETD_LIMIT = '2008-10-31';

//訂單ETD,ETP限制
$tmp = $para->get(0,'ord_append_ETP');
$ord_append_ETP_limit = increceDaysInDate($TODAY,$tmp['set_value']);
$tmp = $para->get(0,'ord_append_ETD');
$ord_append_ETD_limit = increceDaysInDate($TODAY,$tmp['set_value']);

$ord_submit_ETP_limit = $TODAY;
$tmp = $para->get(0,'ord_submit_ETD');
$ord_submit_ETD_limit = increceDaysInDate($TODAY,$tmp['set_value']);

//系統提示參數取得
session_register	('pre_su');
$para_cm = $para->get(0,'top_su');
$pre_su['t'] = $para_cm['set_value'];
$para_cm = $para->get(0,'button_su');
$pre_su['b'] = $para_cm['set_value'];

//工繳取得
session_register	('FTY_CM');
$para_cm = $para->get(0,'hj-cm');
$FTY_CM['HJ'] = $para_cm['set_value'];
$para_cm = $para->get(0,'ly-cm');
$FTY_CM['LY'] = $para_cm['set_value'];
$para_cm = $para->get(0,'cf-cm');
$FTY_CM['CF'] = $para_cm['set_value'];

$FTY_CM['SC'] = 0;

//系統提示參數取得
session_register	('ti_style');
$para_cm = $para->get(0,'VS');
$tmp = $para_cm['set_value'];
$ti_style['VS'] =explode('|',$tmp);
$para_cm = $para->get(0,'BZ');
$tmp = $para_cm['set_value'];
$ti_style['BZ'] =explode('|',$tmp);
$para_cm = $para->get(0,'JK');
$tmp = $para_cm['set_value'];
$ti_style['JK'] =explode('|',$tmp);
$para_cm = $para->get(0,'BS');
$tmp = $para_cm['set_value'];
$ti_style['BS'] =explode('|',$tmp);
$para_cm = $para->get(0,'DR');
$tmp = $para_cm['set_value'];
$ti_style['DR'] =explode('|',$tmp);
$para_cm = $para->get(0,'PT');
$tmp = $para_cm['set_value'];
$ti_style['PT'] =explode('|',$tmp);
$para_cm = $para->get(0,'SH');
$tmp = $para_cm['set_value'];
$ti_style['SH'] =explode('|',$tmp);
$para_cm = $para->get(0,'SO');
$tmp = $para_cm['set_value'];
$ti_style['SO'] =explode('|',$tmp);
$para_cm = $para->get(0,'SK');
$tmp = $para_cm['set_value'];
$ti_style['SK'] =explode('|',$tmp);
$para_cm = $para->get(0,'TP');
$tmp = $para_cm['set_value'];
$ti_style['TP'] =explode('|',$tmp);


session_register	('un_rcv_date');
$para_cm = $para->get(0,'un_rcv_date');
$un_rcv_date = $para_cm['set_value'] * -1;

session_register	('ACT_FNL_IE');
$para_cm = $para->get(0,'act_final_ie');
$ACT_FNL_IE = $para_cm['set_value'] ;

session_register	('hd_ary');
$_SESSION['hd_ary'] = array();
$_SESSION['hd_ary']['2011']['02'] = array ('01','02','03','04','05','07','08');

$max_file_size = 3145728; //3 Mb




switch ($PHP_action) {
//=======================================================
case "test":
$im =  imagecreatetruecolor ( 300, 200);  
$black = imagecolorallocate ($im,  0, 0, 0 );  
$white = imagecolorallocate ($im,  255, 255, 255 );  

// imagefilledrectangle ($im,10, 0,399,99 ,$white);  
imagerectangle ($im,20, 20,250,190 ,$black);  

header ("Content-type: image/png" );  
imagepng ($im); 

exit;

	require_once('class.schedule.graph.php');	
	$SCH = new ScheduleGraph;
	$SCH->title = "test schedule graph";
		
	echo '<img src="class.schedule.graph.php?' . $SCH->create_query_string().'" />';

	$im = imagecreate(50,50);
exit;		
		$time1 ="2007-04-11";
		$time2 ="2007-04-13";

		if ($time1 > $time2){
			echo "<br>time1 ===>".$time1." grater then  time2 ==>".$time2;
			$diff = countDays($time2, $time1);
			echo "  for differnet days ===>".$diff;
		}elseif($time2 > $time1){
			echo "<br>time2 ===>".$time2." > grater then  time1 ==>".$time1;
			$diff = countDays($time2, $time1);
			echo "  for differnet days ===>".$diff;
		}else{
			echo "no one is bigger.....";
		}



	exit;
	
	
	function filter_z_value($val) {

 		return ($val > 0);
	} // end func

		$arr = array(  'monday'=>100,
						'tuesday' =>50,
						'wednesday'=>60,
						'thersday'=>0,
						'friday' =>30,
						'saterday'=>0,
						'sunday'=>70,
			);
		$result = array_filter($arr, 'filter_0_value');
		print_r($arr);
		echo "<br><br>";
		print_r($result);
break;


#++++++++++++++    SAMPLE ORDER +++++++++++++  2006/11/08  +++++++++++++++++
#		 job 54    請購記錄 
#++++++++++++++++++++++++++++++++++++++++++++  2006/11/09  +++++++++++++++++
#		case "apply":						job 51
#		case "apply_search_bom":			job 51
#		case "apply_add_search":			job 51
#		case "do_apply_add_search":			job 51
#		case "apply_wi_view":				job 51
#		case "apply_bom_view":				job 51
#		case "apply_ext_bom_view":			job 51
#		case "apply_add":					job 51
#		case "get_ship_ajax":				job 51
# 		case "apply_special_add":			job 51
#	 	case "apply_special_add_ajax":		job 51
#		case "apply_ext_add":				job 51
#		case "apply_spc_add_det":			job 51
#		case "apply_add_det":				job 51
#		case "del_ap_det_ajax":				job 51
#		case "del_ap_spc_ajax":				job 51
#		case "do_apply_del":				job 51
#		case "do_apply_add":				job 51
#		case "do_apply_spc_add1":			job 51
#		case "do_apply_spc_add2":			job 51
#		case "apply_edit":					job 51
#		case "mat_edit":					job 51
#		case "do_apply_edit":				job 51
#		case "apply_search":				job 51
#		case "pa_print":					job 51
#		case "apply_view":					job 51
#		case "do_apply_logs_add":			job 51
#		case "apply_submit":				job 51
#		case "apply_cfm_search":			job 52
#		case "apply_cfm_view":				job 52
#		case "do_apply_cfm":				job 52
#		case "reject_apply_cfm":			job 52
#		case "apply_apv_search":			job 53
#		case "apply_apv_view":				job 53
#		case "do_apply_apv":				job 53
#		case "reject_apply_apv":			job 53
#		case "apply_revise":				job 51
#		case  "bom_close_pa":				jbo 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "apply":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    case "apply":
		check_authority('037',"view");
		$where_str = $manager = $manager_v = $dept_id = '';
		$dept_ary = array();
		$sales_dept_ary = get_full_sales_dept(); // 取出 業務的部門 [不含K0] ------
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
		$user_team = $GLOBALS['SCACHE']['ADMIN']['team_id'];   // 判定進入身份的指標
		
		$op['factory'] = $arry2->select($FACTORY,'','PHP_factory','select','');
		
			if($user_team == 'MD'){
				// 如果是業務部進入 則dept_code 指定該業務部---
				$dept_id = $user_dept;  
			}

		if (!$dept_id) {    // 當不是業務部人[也不含 K0 的人 ]進入時
			$manager = 1;
			$manager_v = 1;
			//業務部門 select選單
			$dept_ary = $arry2->select($sales_dept_ary,$GLOBALS['SCACHE']['ADMIN']['dept'],"PHP_dept_code","select","");  
		} else {
//			$where_str = " WHERE dept = '".$dept_id."' ";			
		}

		$where_str=$where_str."order by cust_s_name"; //依cust_s_name排序
		if(!$cust_def = $cust->get_fields('cust_init_name',$where_str)){;  //取出客戶簡稱
			$op['msg'][] = "sorry! there is no any customer record in your team, please add customer first!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
		for ($i=0; $i< sizeof($cust_def); $i++)
		{
			$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
		}

		$op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue); 
		$op['factory_select'] = $arry2->select($SHIP,'','PHP_SCH_fty','select','');
		$op['cust_sch_select'] =  $arry2->select($cust_value,'','PHP_SCH_cust','select','',$cust_def_vue); 


		$op['manager_flag'] = $manager;
		$op['manager_v_flag'] = $manager_v;
		$op['dept_id'] = $dept_id;
		$op['dept_ary'] = $dept_ary;

		$op['msg'] = $order->msg->get(2);

//080725message增加		
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];
		  	
		page_display($op, '037', $TPL_APLY);			    	    
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "apply_search_bom":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "apply_search_bom":   //  先找出製造令.......
check_authority('037',"view");

if (!isset($PHP_full))$PHP_full = 0;

if (!$op = $bom->search_cfm()) {
	$op['msg']= $wi->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}
// op 被清除了 需再判斷一次 
// print_r($op['wi']);
for ($i=0; $i< sizeof($op['wi']); $i++)
{
	$op['wi'][$i]['acc_ap'] = $bom->get_aply($op['wi'][$i]['id'], 'bom_acc');
	$op['wi'][$i]['lots_ap'] = $bom->get_aply($op['wi'][$i]['id'], 'bom_lots');
}
//print_r($op['wi']);
$op['msg']= $bom->msg->get(2);				
$back_str="&PHP_dept_code=".$PHP_dept_code."&PHP_cust=".$PHP_cust."&PHP_num=".$PHP_num."&PHP_full=".$PHP_full;
if ($GLOBALS['SCACHE']['ADMIN']['dept'] == 'SA') 
{
	$op['close_flag'] = 1;
}

$op['back_str']=$back_str;
//print_r($op);
if (isset($PHP_special))
{
	//echo "test";
	page_display($op, '037', $TPL_APLY_SPC_BOM_LIST);
}else{
	//echo "test1";
	page_display($op, '037', $TPL_APLY_BOM_LIST);
}
break;



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "apply_add_search":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "apply_add_search":   //  先找出製造令.......

		check_authority('037',"view");
			
		$op['dept_id'] = $PHP_dept;
		$op['cust'] = $PHP_cust;
		$op['item'] = $PHP_item;
		page_display($op, '037', $TPL_APLY_ADD_SCH);
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# case "do_apply_add_search": job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "do_apply_add_search": //  先找出製造令.......
check_authority('037',"view");

if (!$op = $bom->search_cfm()) {
	$op['msg']= $wi->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}

for ($i=0; $i< sizeof($op['wi']); $i++)
{
	$op['wi'][$i]['acc_ap'] = $bom->get_aply($op['wi'][$i]['id'], 'bom_acc');
	$op['wi'][$i]['lots_ap'] = $bom->get_aply($op['wi'][$i]['id'], 'bom_lots');
}

$op['msg']= $bom->msg->get(2);				
echo $back_str="&PHP_dept_code=".$PHP_dept_code."&PHP_cust=".$PHP_cust."&PHP_num=".$PHP_num;
$op['back_str']=$back_str;
$op['dept_id'] = $PHP_dept_code;
$op['cust'] = $PHP_cust;

$op['item'] = $PHP_item;
page_display($op, '037', $TPL_APLY_ADD_SCH);
break;



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# case "apply_wi_view":			job 54
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "apply_wi_view":
check_authority('037',"view");

// 將 製造令 完整show out ------
// wi 主檔

if (!$op = $wi->get_all($PHP_id)) { //取出該筆 製造令記錄 ID
	$op['msg']= $wi->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}

//--------------------------------------------------------------------------
//  wi_qty 數量檔
$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
$T_wiqty = $wiqty->search(1,$where_str);

$num_colors = count($T_wiqty);

// 取出 size_scale ----------------------------------------------
$size_A = $size_des->get($op['smpl']['size']);
$op['smpl']['size_scale']=$size_A['size_scale'];
	//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
$sizing = explode(",", $size_A['size']);

// 做出 size table-------------------------------------------
$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
$op['show_breakdown'] = $reply['html'];
$op['total'] = $reply['total'];
//-----------------------------------------------------------------

// 取出  BOM  主料記錄 --------------------------------------------------------------
$op['bom_lots_NONE']= '';
$op['lots_use'] = $po->get_lots_det($op['wi']['id']);  //取出該筆 bom 內ALL主料記錄
//print_r($op['lots_use']);
// print_r($op['lots_use']['bom']);
$num_bom_lots = count($op['lots_use']);
if (!$num_bom_lots){	$op['bom_lots_NONE'] = "1";		}

// 取出  BOM  副料記錄 --------------------------------------------------------------
$op['bom_acc_NONE']= '';
$op['acc_use'] = $po->get_acc_det($op['wi']['id']);  //取出該筆 bom 內ALL副料記錄
$num_bom_acc = count($op['acc_use']);
if (!$num_bom_acc){	$op['bom_acc_NONE'] = "1";		}


// 取出  BOM  工廠採購主料記錄 --------------------------------------------------------------
 // $op['bom_lots_NONE']= '';
 // $op['fty_lots_use'] = $apply->get_lots_det($op['wi']['id'],1);  //取出該筆 bom 內ALL主料記錄
 // $num_bom_lots = count($op['fty_lots_use']);
 // if (!$num_bom_lots){	$op['fty_lots_NONE'] = "1";		}

// 取出  BOM  工廠採購副料記錄 --------------------------------------------------------------
// $op['bom_acc_NONE']= '';
// $op['fty_acc_use'] = $apply->get_acc_det($op['wi']['id'],1);  //取出該筆 bom 內ALL副料記錄
// $num_bom_acc = count($op['fty_acc_use']);
// if (!$num_bom_acc){	$op['fty_acc_NONE'] = "1";		}




// 取出  BOM  客戶提供主料記錄 --------------------------------------------------------------
 // $op['bom_lots_NONE']= '';
 // $op['cust_lots_use'] = $apply->get_lots_det($op['wi']['id'],2);  //取出該筆 bom 內ALL主料記錄
 // $num_bom_lots = count($op['cust_lots_use']);
 // if (!$num_bom_lots){	$op['cust_lots_NONE'] = "1";		}

// 取出  BOM  客戶提供副料記錄 --------------------------------------------------------------
// $op['bom_acc_NONE']= '';
// $op['cust_acc_use'] = $apply->get_acc_det($op['wi']['id'],2);  //取出該筆 bom 內ALL副料記錄
// $num_bom_acc = count($op['cust_acc_use']);
// if (!$num_bom_acc){	$op['cust_acc_NONE'] = "1";		}



//  取出 Pre-Purchase Order 預先採購記錄 --------------------------------------------------------------
$op['pp_mat_NONE']= '';
$op['pp_order'] = $po->get_pp_order($op['wi']['wi_num']);  //取出該筆 bom 內ALL加購記錄
#print_r($op['pp_order']);
$num_ext_mat = count($op['pp_order']);
if (!$num_ext_mat){	$op['pp_mat_NONE'] = "1";}
for($i=0; $i<sizeof($op['pp_order']); $i++)
{
	if ($op['pp_order'][$i]['mat_cat'] =='a') $op['pp_acc_mk'] = 1;
	if ($op['pp_order'][$i]['mat_cat'] =='l') $op['pp_lots_mk'] = 1;
}

//  取出  BOM  預先採購記錄 --------------------------------------------------------------
$op['pp_mat_NONE']= '';
$op['pp_mat'] = $po->get_unadd_pp($op['wi']['wi_num']);  //取出該筆 bom 內ALL加購記錄
#print_r($op['pp_mat']);
$num_ext_mat = count($op['pp_mat']);
if (!$num_ext_mat){	$op['pp_mat_NONE'] = "1";}
for($i=0; $i<sizeof($op['pp_mat']); $i++)
{
	if ($op['pp_mat'][$i]['mat_cat'] =='a') $op['pp_acc_mk'] = 1;
	if ($op['pp_mat'][$i]['mat_cat'] =='l') $op['pp_lots_mk'] = 1;
}

// 取出 BOM Disable 計錄中己採購主料者 #此在紀錄已有採購的物料，在顯示頁面要註記不顯示，以防重複採購 --------------------------------------------------------------
$op['dis_lots_NONE']= '';
$op['dis_lots'] = $bom->get_dis_lots($op['wi']['id']);  //取出該筆 bom 內記錄
$num_lots = count($op['dis_lots']);
if (!$num_lots){	$op['dis_lots_NONE'] = "1";}

// 取出 BOM Disable 計錄中己採購副料者 --------------------------------------------------------------
$op['dis_acc_NONE']= '';
$op['dis_acc'] = $bom->get_dis_acc($op['wi']['id']);  //取出該筆 bom 內記錄
$num_acc = count($op['dis_acc']);
if (!$num_acc){	$op['dis_acc_NONE'] = "1";}

$user_team = $GLOBALS['SCACHE']['ADMIN']['team_id'];   // 判定進入身份的指標
if($user_team == 'PM') $op['fty_flag'] = 1;

// print_r($op['lots_use']);

$op['msg'] = $wi->msg->get(2);
if (isset($PHP_msg)) $op['msg'][] = $PHP_msg;
if (isset($_SESSION['msg'])) {
	$op['msg'][] = $_SESSION['msg'];
	unset($_SESSION['msg']);
}
// print_r($op['acc_use']['bom']);
if (!isset($PHP_sr)) $PHP_sr =1;
if (isset($PHP_item))
{
	//echo "test";
	$back_str="?PHP_action=do_apply_add_search&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_cust=".$PHP_cust."&PHP_num=".$PHP_num."&PHP_item=".$PHP_item;
	$op['item'] = $PHP_item;
	$op['back_str']=$back_str;
	page_display($op, '022', $TPL_APLY_VIEW_WI_SUB);		
}else{
	//echo "test1";
	$back_str="?PHP_action=apply_search_bom&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_cust=".$PHP_cust."&PHP_num=".$PHP_num."&PHP_full=".$PHP_full;
	$op['back_str']=$back_str;

	$back_str2="?PHP_action=apply_search_bom&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_cust=".$PHP_cust."&PHP_num=".$PHP_num."&PHP_full=".$PHP_full;
	$op['back_str2']=$back_str2;

	page_display($op, '037', $TPL_APLY_VIEW_WI);		
}
break;

	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	 case "apply_bom_view":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "apply_bom_view":

		check_authority('037',"view");
		//-------------------- 將 製造令 show out ------------------

		//  wi 主檔 + smpl 樣本檔
		$op['wi'] = $wi->get($PHP_id);
		$op['smpl'] = $order->get($op['wi']['smpl_id']);
		//-------------------- wi_qty 數量檔 -------------------------------
		$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		$T_wiqty = $wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);
		$op['num_colors'] = $num_colors;
		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
		$op['show_breakdown'] = $reply['html'];
		$op['total'] = $reply['total'];   // 總件數
		//-----------------------------------------------------------------

		// 相片的URL決定 ------------------------------------------------------
				$style_dir	= "./picture/";  
				$no_img		= "./images/graydot.gif";
			if(file_exists($style_dir.$op['wi']['style_code'].".jpg")){
				$op['wi']['pic_url'] = $style_dir.$op['wi']['style_code'].".jpg";
			} else {
				$op['wi']['pic_url'] = $no_img;
			}

		//  取出  BOM  主料記錄 --------------------------------------------------------------
		 $op['bom_lots_NONE']= '';
	 	 $op['bom_lots_list'] = $apply->get_lots_det($op['wi']['id']);  //取出該筆 bom 內ALL主料記錄
		 $num_bom_lots = count($op['bom_lots_list']);
		 if (!$num_bom_lots){	$op['bom_lots_NONE'] = "1";		}

		//  取出  BOM  副料記錄 --------------------------------------------------------------
		$op['bom_acc_NONE']= '';
		$op['bom_acc_list'] = $apply->get_acc_det($op['wi']['id']);  //取出該筆 bom 內ALL副料記錄
		$num_bom_acc = count($op['bom_acc_list']);
		if (!$num_bom_acc){	$op['bom_acc_NONE'] = "1";		}


			$back_str="?PHP_action=apply_search_bom&PHP_sr=".$PHP_sr_startno."&PHP_dept_code=".$PHP_dept_code."&PHP_cust=".$PHP_cust."&PHP_num=".$PHP_num."&PHP_full=".$PHP_full;
			$op['back_str']=$back_str;

		$op['mat_id'] = $PHP_bom_id;
		$op['mat_cate'] = $PHP_mat_cat;
		// echo $op['mat_cate'];
		page_display($op, '037', $TPL_APLY_SPC_VIEW_BOM);
		break;		
		
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "apply_ext_bom_view":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "apply_ext_bom_view":

		check_authority('037',"view");

		// 將 製造令 完整show out ------
		//  wi 主檔

			if(!$op = $wi->get_all($PHP_id)){    //取出該筆 製造令記錄 ID
						$op['msg']= $wi->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
			}

//--------------------------------------------------------------------------
		//  wi_qty 數量檔
		$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		$T_wiqty = $wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);

		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
		$op['show_breakdown'] = $reply['html'];
		$op['total'] = $reply['total'];
		//-----------------------------------------------------------------

		//  取出  BOM  主料記錄 --------------------------------------------------------------
		 $op['bom_lots_NONE']= '';
	 	 $op['lots_use'] = $apply->get_lots_det($op['wi']['id']);  //取出該筆 bom 內ALL主料記錄
		 $num_bom_lots = count($op['lots_use']);
		 if (!$num_bom_lots){	$op['bom_lots_NONE'] = "1";		}

		//  取出  BOM  副料記錄 --------------------------------------------------------------
		$op['bom_acc_NONE']= '';
		$op['acc_use'] = $apply->get_acc_det($op['wi']['id']);  //取出該筆 bom 內ALL副料記錄
		$num_bom_acc = count($op['acc_use']);
		if (!$num_bom_acc){	$op['bom_acc_NONE'] = "1";		}


		//  取出  BOM  加購記錄 --------------------------------------------------------------
		$op['ext_mat_NONE']= '';
		$op['ext_mat'] = $po->get_ext_ap($op['wi']['wi_num']);  //取出該筆 bom 內ALL加購記錄
		$num_ext_mat = count($op['ext_mat']);
		if (!$num_ext_mat){	$op['ext_mat_NONE'] = "1";		}

		//  取出  BOM  Disable計錄中己採購主料者 --------------------------------------------------------------
		$op['dis_lots_NONE']= '';
		$op['dis_lots'] = $bom->get_dis_lots($op['wi']['id']);  //取出該筆 bom 內記錄
		$num_lots = count($op['dis_lots']);
		if (!$num_lots){	$op['dis_lots_NONE'] = "1";}

		//  取出  BOM  Disable計錄中己採購副料者 --------------------------------------------------------------
		$op['dis_acc_NONE']= '';
		$op['dis_acc'] = $bom->get_dis_acc($op['wi']['id']);  //取出該筆 bom 內記錄
		$num_acc = count($op['dis_acc']);
		if (!$num_acc){	$op['dis_acc_NONE'] = "1";}


		$op['msg'] = $wi->msg->get(2);		
		
		if (isset($PHP_msg))$op['msg'][]=$PHP_msg;

		$back_str="?PHP_action=apply_search_bom&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_cust=".$PHP_cust."&PHP_num=".$PHP_num."&PHP_special=1";
		$op['back_str']=$back_str;
		page_display($op, '037', $TPL_APLY_EXT_VIEW_BOM);		

		break;
			
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "apply_add":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "apply_add":
check_authority('037',"add");		
$wi_id = $PHP_wi_id;
if(!$ord = $wi->get($PHP_wi_id)){    //取出該筆 製造令記錄 ID
	$op['msg']= $wi->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}

$parm_madd= array(
	'cust'  		=>	$ord['cust'],
	'dept'			=>	$ord['dept'],
	'sup_code'		=>	$PHP_vendor,
	'ap_user'		=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
	'ap_date'		=>	$TODAY,
	'ap_special'	=>	0,
);

// 建po編號
$head="PA".date('y')."-";	//A+日期+部門=請購單開頭
$parm_madd['ap_num']=$apply->get_no($head,'ap_num','ap');	//取得請購的最後編號
$new_id = $apply->add($parm_madd);	//新增AP資料庫
$tmp_num = substr($parm_madd['ap_num'],2);
$po_num = "PO".$tmp_num;
$f1=$apply->update_fields('po_num',$po_num, $parm_madd['ap_num']);


if ($PHP_item == 'lots')
{
	$parm_mat = array (
		'field_name'	=>	'vendor1',		//主料加入供應商資料
		'field_value'	=>	$PHP_vendor,
		'code'			=>	$PHP_mat_code
	);
	
	$lots->update_field_code($parm_mat);
	$where_str = "WHERE id = ". $PHP_bom_id;
	$mat=$bom->search('bom_lots', $where_str);

	$fd='bom_lots';
	$mat_cat='l';

} else {

	$parm_mat = array (	
		'field_name'	=>	'vendor1',		//副料加入供應商資料
		'field_value'	=>	$PHP_vendor,
		'code'			=>	$PHP_mat_code
	);
	
	$acc->update_field_code($parm_mat);
	$where_str = "WHERE id = ". $PHP_bom_id;
	$mat=$bom->search('bom_acc', $where_str);		
	
	$fd='bom_acc';
	$mat_cat='a';				
}

for ($i=0; $i<sizeof($mat); $i++)
{
	$tmp_qty=explode(',',$mat[$i]['qty']);
	$qty=0;
	
	for ($j=0; $j<sizeof($tmp_qty); $j++)
	{
		$qty=$qty+$tmp_qty[$j];
	}
	
	$parm_dadd = array(
		'ap_num'	=>	$parm_madd['ap_num'],
		'bom_id'	=>	$mat[$i]['id'],
		'eta'		=>	$PHP_eta,
		'qty'		=>	$qty,
		'unit'		=>	$PHP_unit,
		'mat_cat'	=>	$mat_cat,

		'order_num'	=>	$PHP_order_num,
		'wi_id'	    =>	$wi_id,
		'mat_id'	=>	$PHP_mat_id,
		'used_id'	=>	$PHP_used_id,
		'color'	    =>	$PHP_color,
		'size'	    =>	$PHP_size,
        
	);

	$parm_mat = array($mat[$i]['id'],'ap_mark',$parm_madd['ap_num'],$fd);

	$f2 = $bom->update_field($parm_mat);			
	$f1 = $apply->add_det($parm_dadd);	//新增AP資料庫
    $log->log_add(0,"MODE",$GLOBALS['SCACHE']['ADMIN']['login_id'].'index2.php?'.$PHP_action.',ap_num='.$PHP_ap_num.',bom_id='.$mat[$i]['id'].',mat_id='.$PHP_mat_id.',mat_cat='.$mat_cat.',color='.$PHP_color);
}



$op = $apply->get($parm_madd['ap_num']);

//記錄新增message
$message = "Successfully Appended PO : ".$po_num;
$op['msg'][] = $message;
$log->log_add(0,"307A",$message);

//組合畫面List
if (isset($op['ap_det']))
{
	$op['ap_det2'] = $apply->group_ap($op['ap_det']);	//組同請購明細
}


$op['CURRENCY_select'] = $arry2->select($CURRENCY,'','PHP_CURRENCY','select','');
$op['FACTORY_select'] = $arry2->select($SHIP,'','PHP_FACTORY','select',"ship_show(this)");

for ($i=0; $i< 4; $i++)
{
	if ($op['ap']['dm_way'] == $dm_way[1][$i]) $op['ap']['dm_way']=$dm_way[0][$i];
}

$op['dm_way_select'] = $arry2->select($dm_way[0],$op['ap']['dm_way'],"PHP_dm_way","select","");

page_display($op, '037', $TPL_APLY_ADD);			    	    
break;
	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "apply_stock":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    case "apply_stock":
		check_authority('037',"add");		


			if(!$ord = $wi->get($PHP_wi_id)){    //取出該筆 製造令記錄 ID
						$op['msg']= $wi->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
			}
		
		if ($PHP_item == 'lots')
		{
			$where_str = "WHERE id = ". $PHP_mat_id;
			$mat=$bom->search('bom_lots', $where_str);

			$fd='bom_lots';	
			$mat_cat='l';		
		}else{			
			$where_str = "WHERE id = ". $PHP_mat_id;
			$mat=$bom->search('bom_acc', $where_str);		

			$fd='bom_acc';
			$mat_cat='a';				
		}
		for ($i=0; $i<sizeof($mat); $i++)
		{

			$parm_mat = array($mat[$i]['id'],'ap_mark','stock',$fd);
			$f2 = $bom->update_field($parm_mat);			
		}

	//記錄新增message
		$message = "Successfully ADD stock ON Order : ".$ord['wi_num'];
		//$op['msg'][] = $message;
		$log->log_add(0,"51A",$message);
				 
	$redirect_str ="index2.php?PHP_action=apply_wi_view&other=other&PHP_sr".$PHP_sr_startno."&PHP_dept_code=".$PHP_dept_code."&PHP_cust=".$PHP_cust."&PHP_num=".$PHP_num."&PHP_msg=".$message."&PHP_id=".$PHP_wi_id."&PHP_full=".$PHP_full;
  redirect_page($redirect_str);

		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	 case "get_ship_ajax":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "get_ship_ajax":
	if ($PHP_ship)
	{
		echo $SHIP_TO[$PHP_ship]['Name'].'|'.$SHIP_TO[$PHP_ship]['Addr'].'|'.$SHIP_TO[$PHP_ship]['TEL'].'|'.$SHIP_TO[$PHP_ship]['FAX'].'|'.$SHIP_TO[$PHP_ship]['Attn'];
	}else{
		echo '||||';
	}

	break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# case "apply_special_add":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    case "apply_special_add":
		check_authority('037',"add");		
		
		if ($PHP_ap_num == '')
		{	
				if(!$ord = $wi->get(0,$PHP_wi_num)){    //取出該筆 製造令記錄 ID
							$op['msg']= $wi->msg->get(2);
							$layout->assign($op);
							$layout->display($TPL_ERROR);  		    
							break;
				}
			
				$parm_madd= array(  'cust'  			=>	$ord['cust'],
														'dept'				=>	$ord['dept'],
														'sup_code'		=>	$PHP_vendor,
														'ap_user'			=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
														'ap_date'			=>	$TODAY,
														'ap_special'	=>	1,
														);
				$PHP_sup=$PHP_vendor;

			$head="PA".date('y')."-";	//A+日期+部門=請購單開頭
			$parm_madd['ap_num']=$apply->get_no($head,'ap_num','ap');	//取得請購的最後編號
			$new_id = $apply->add($parm_madd);	//新增AP資料庫
			$PHP_ap_num=$parm_madd['ap_num'];
//建po編號
			$tmp_num = substr($parm_madd['ap_num'],2);
			$po_num = "PO".$tmp_num;
			$f1=$apply->update_fields('po_num',$po_num, $PHP_ap_num);

		}
		
		if ($PHP_item == 'lots')
		{
			$mat_cat='l';	
			$parm_mat = array (	'field_name'	=>	'vendor1',
													'field_value'	=>	$PHP_sup,
													'code'				=>	$PHP_mat_code
												);
			$lots->update_field_code($parm_mat);

	
		}else{			
			$mat_cat='a';		
			$parm_mat = array (	'field_name'	=>	'vendor1',
													'field_value'	=>	$PHP_sup,
													'code'				=>	$PHP_mat_code
												);
			$acc->update_field_code($parm_mat);		


		}



		$parm_dadd = array( 'ap_num'		=>	$PHP_ap_num,
													'mat_id'	=>	$PHP_mat_id,
													'eta'			=>	$PHP_eta,
													'qty'			=>	$PHP_qty,
													'unit'		=>	$PHP_unit,
													'mat_cat'	=>	$mat_cat,
													);
		$f1 = $apply->add_det($parm_dadd);	
	
		$op = $apply->get($PHP_ap_num);
		
		$message = "Successfully appended PO : ".$po_num;
		$op['msg'][] = $message;
		$log->log_add(0,"54A",$message);
		
		$op['wi_num'] = $PHP_wi_num;
		
	//  wi 主檔 + smpl 樣本檔
		$op['wi'] = $wi->get(0,$PHP_wi_num);
		$op['smpl'] = $order->get($op['wi']['smpl_id']);
		//-------------------- wi_qty 數量檔 -------------------------------
		$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		$T_wiqty = $wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);
		$op['num_colors'] = $num_colors;
		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
		$op['show_breakdown'] = $reply['html'];
		$op['total'] = $reply['total'];   // 總件數
		//-----------------------------------------------------------------

		// 相片的URL決定 ------------------------------------------------------
				$style_dir	= "./picture/";  
				$no_img		= "./images/graydot.gif";
			if(file_exists($style_dir.$op['wi']['style_code'].".jpg")){
				$op['wi']['pic_url'] = $style_dir.$op['wi']['style_code'].".jpg";
			} else {
				$op['wi']['pic_url'] = $no_img;
			}

		//  取出  BOM  主料記錄 --------------------------------------------------------------
		 $op['bom_lots_NONE']= '';
	 	 $op['bom_lots_list'] = $apply->get_lots_det($op['wi']['id']);  //取出該筆 bom 內ALL主料記錄
		 $num_bom_lots = count($op['bom_lots_list']);
		 if (!$num_bom_lots){	$op['bom_lots_NONE'] = "1";		}

		//  取出  BOM  副料記錄 --------------------------------------------------------------
		$op['bom_acc_NONE']= '';
		$op['bom_acc_list'] = $apply->get_acc_det($op['wi']['id']);  //取出該筆 bom 內ALL副料記錄
		$num_bom_acc = count($op['bom_acc_list']);
		if (!$num_bom_acc){	$op['bom_acc_NONE'] = "1";		}


		$op['pa_num'] = $PHP_ap_num;
		$op['revise'] = $PHP_revise;
		page_display($op, '037', $TPL_APLY_SPC_VIEW_BOM);
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "apply_ext_add":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "apply_ext_add":
		check_authority('037',"add");		
		
			if(!$ord = $wi->get(0,$PHP_wi_num)){    //取出該筆 製造令記錄 ID
						$op['msg']= $wi->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
			}
			
			$parm_madd= array(  'cust'  			=>	$ord['cust'],
													'dept'				=>	$ord['dept'],
													'sup_code'		=>	'',
													'ap_user'			=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
													'ap_date'			=>	$TODAY,
													'ap_special'	=>	2,
													);
		$op['ap'] = $parm_madd;
		
		
		$op['wi_num'] = $PHP_wi_num;
		$op['item'] = $PHP_item;
		$op['CURRENCY_select'] = $arry2->select($CURRENCY,'','PHP_CURRENCY','select','');
		$op['FACTORY_select'] = $arry2->select($SHIP,'','PHP_FACTORY','select',"ship_show(this)");
		$op['ACC_select'] = $arry2->select($ACC_PRICE_UNIT,'','PHP_unit','select','');
		$op['FAB_select'] = $arry2->select($LOTS_PRICE_UNIT,'','PHP_unit','select','');

		$op['dm_way_select'] = $arry2->select($dm_way[0],'',"PHP_dm_way","select","");

		$op['revise'] = $PHP_revise;
		page_display($op, '037', $TPL_APLY_EXT_ADD);			    	    
		break;
		
		
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "apply_spc_add_det":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "apply_spc_add_det":
		check_authority('037',"add");		
		
		if(strstr($PHP_use_for,'&#'))	$PHP_use_for = $ch_cov->check_cov($PHP_use_for);
		

		if ($PHP_ap_num =='')  //若沒有pa編號時,先建立請購單(母)
		{			
			if(!$ord = $wi->get(0,$PHP_wi_num)){    //取出該筆 製造令記錄 ID
				$op['msg']= $wi->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}			
			$parm_madd= array(  'cust'  			=>	$ord['cust'],
													'dept'				=>	$ord['dept'],
													'sup_code'		=>	$PHP_vendor,
													'ap_user'			=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
													'ap_date'			=>	$TODAY,
													'ap_special'	=>	2,
													);
			$head="PA".date('y')."-";	//A+日期+部門=請購單開頭
			$parm_madd['ap_num']=$apply->get_no($head,'ap_num','ap');	//取得請購的最後編號
			$new_id = $apply->add($parm_madd);	//新增AP資料庫
			$message = "Successfully appended PA : ".$parm_madd['ap_num'];
			$op['msg'][] = $message;
			$log->log_add(0,"51A",$message);
			$PHP_ap_num = $parm_madd['ap_num'];
//建po編號
			$tmp_num = substr($PHP_ap_num,2);
			$po_num = "PO".$tmp_num;
			$f2=$apply->update_fields('po_num',$po_num, $PHP_ap_num);

		}

		
		if ($PHP_item == 'lots')
		{
			$parm_mat = array (	'field_name'	=>	'vendor1',
													'field_value'	=>	$PHP_vendor,
													'code'				=>	$PHP_mat_code
												);
			$lots->update_field_code($parm_mat);

	  	$mat_cat='l';
		}else{
			$mat_cat='a';		
			$parm_mat = array (	'field_name'	=>	'vendor1',
													'field_value'	=>	$PHP_vendor,
													'code'				=>	$PHP_mat_code
												);
			$acc->update_field_code($parm_mat);
	
		}
		
		
		$parm_dadd = array( 'ap_num'		=>	$PHP_ap_num,
												'mat_code'	=>	$PHP_mat_code,
												'ord_num'		=>	$PHP_wi_num,
												'color'			=>	$PHP_color,
												'eta'				=>	$PHP_eta,
												'qty'				=>	$PHP_qty,
												'unit'			=>	$PHP_unit,
												'mat_cat'		=>	$mat_cat,
												'use_for'		=>	$PHP_use_for,
								);
		$f1 = $apply->add_special($parm_dadd);	//新增AP資料庫

		$op = $apply->get($PHP_ap_num);
		$message = "Successfully appended detial for PO  : ".$op['ap']['po_num'];
		$op['msg'][] = $message;
		$log->log_add(0,"54A",$message);
		
		$op['wi_num'] = $PHP_wi_num;
		$op['item'] = $PHP_item;
		$op['CURRENCY_select'] = $arry2->select($CURRENCY,$op['ap']['currency'],'PHP_CURRENCY','select','');
		$op['FACTORY_select'] = $arry2->select($SHIP,$op['ap']['arv_area'],'PHP_FACTORY','select',"ship_show(this)");
		$op['ACC_select'] = $arry2->select($ACC_PRICE_UNIT,'','PHP_unit','select','');
		$op['FAB_select'] = $arry2->select($LOTS_PRICE_UNIT,'','PHP_unit','select','');
		for ($i=0; $i< 4; $i++)
		{
			if ($op['ap']['dm_way'] == $dm_way[1][$i]) $op['ap']['dm_way']=$dm_way[0][$i];
		}

		$op['dm_way_select'] = $arry2->select($dm_way[0],$op['ap']['dm_way'],"PHP_dm_way","select","");

		$op['revise'] = $PHP_revise;

			if (isset($PHP_SCH_num))
			{
				$back_str="&PHP_dept_code=".$PHP_dept_code."&PHP_SCH_num=".$PHP_SCH_num."&PHP_SCH_fty=".$PHP_SCH_fty."&PHP_SCH_cust=".$PHP_SCH_cust."&PHP_SCH_supl=".$PHP_SCH_supl."&PHP_sr_startno=".$PHP_sr_startno;
				$op['back_str']=$back_str;
			}

	if ($op['ap']['arv_area'])
	{
		$op['ap']['ship_name'] = $SHIP_TO[$op['ap']['arv_area']]['Name'];
		$op['ap']['ship_addr'] = $SHIP_TO[$op['ap']['arv_area']]['Addr'];
		$op['ap']['ship_tel']  = $SHIP_TO[$op['ap']['arv_area']]['TEL'];
		$op['ap']['ship_fax']  = $SHIP_TO[$op['ap']['arv_area']]['FAX'];
		$op['ap']['ship_attn'] = $SHIP_TO[$op['ap']['arv_area']]['Attn'];
	}

		page_display($op, '037', $TPL_APLY_EXT_ADD);			    	    
		break;
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "apply_add_det":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "apply_add_det":

check_authority('037',"add");		
$wi_id = $PHP_wi_id;
if(!$ord = $wi->get($PHP_wi_id)){    //取出該筆 製造令記錄 ID
	$op['msg']= $wi->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}
			
if ($PHP_item == 'lots')
{
	$parm_mat = array (	'field_name' => 'vendor1','field_value' => $PHP_vendor,'code' => $PHP_mat_code);
	$lots->update_field_code($parm_mat);	// 加入主料供應商

	$where_str = "WHERE id = ". $PHP_bom_id;
	$mat=$bom->search('bom_lots', $where_str);
	$fd='bom_lots';	
	$mat_cat='l';		
}else{
	$parm_mat = array (	'field_name' =>	'vendor1' , 'field_value' => $PHP_vendor , 'code' => $PHP_mat_code );
	$acc->update_field_code($parm_mat);		// 加入副料供應商

	$where_str = "WHERE id = ".$PHP_bom_id;
	$mat=$bom->search('bom_acc', $where_str);		
	$fd='bom_acc';
	$mat_cat='a';				
}

for ($i=0; $i<sizeof($mat); $i++)
{
	$tmp_qty=explode(',',$mat[$i]['qty']);
	$qty=0;

	for ($j=0; $j<sizeof($tmp_qty); $j++)
	{
		$qty=$qty+$tmp_qty[$j];
	}
	
	$parm_dadd = array(
		'ap_num'	=>	$PHP_ap_num,
		'bom_id'	=>	$mat[$i]['id'],
		'eta'		=>	$PHP_eta,
		'qty'		=>	$qty,
		'unit'		=>	$PHP_unit,
		'mat_cat'	=>	$mat_cat,

		'order_num'	=>	$PHP_order_num,
		'wi_id'	    =>	$wi_id,
		'mat_id'	=>	$PHP_mat_id,
		'used_id'	=>	$PHP_used_id,
		'color'	    =>	$PHP_color,
		'size'	    =>	$PHP_size,

	);

	$parm_mat = array($mat[$i]['id'],'ap_mark',$PHP_ap_num,$fd);
	$f2 = $bom->update_field($parm_mat);			
	$f1 = $apply->add_det($parm_dadd);	//新增AP資料庫
    $log->log_add(0,"MODE",$GLOBALS['SCACHE']['ADMIN']['login_id'].'index2.php?'.$PHP_action.',ap_num='.$PHP_ap_num.',bom_id='.$mat[$i]['id'].',mat_id='.$PHP_mat_id.',mat_cat='.$mat_cat.',color='.$PHP_color);
}


$op = $apply->get($PHP_ap_num);

//組合畫面List
if (isset($op['ap_det']))
{
	$op['ap_det2'] = $apply->group_ap($op['ap_det']);	//組同請購明細
}

if ($op['ap']['arv_area'])
{
$op['ap']['ship_name'] = $SHIP_TO[$op['ap']['arv_area']]['Name'];
$op['ap']['ship_addr'] = $SHIP_TO[$op['ap']['arv_area']]['Addr'];
$op['ap']['ship_tel']  = $SHIP_TO[$op['ap']['arv_area']]['TEL'];
$op['ap']['ship_fax']  = $SHIP_TO[$op['ap']['arv_area']]['FAX'];
$op['ap']['ship_attn'] = $SHIP_TO[$op['ap']['arv_area']]['Attn'];
}

$msg = "Successfully add PO : ".$op['ap']['po_num']." detial";
$op['msg'][]=$msg;

$log->log_add(0,"037A",$msg);

//記錄修改者+修改日
$apply->update_2fields('au_user','au_date',$GLOBALS['SCACHE']['ADMIN']['login_id'],$TODAY,$op['ap']['id']);


$op['CURRENCY_select'] = $arry2->select($CURRENCY,$op['ap']['currency'],'PHP_CURRENCY','select','');
$op['FACTORY_select'] = $arry2->select($SHIP,$op['ap']['arv_area'],'PHP_FACTORY','select',"ship_show(this)");
for ($i=0; $i< 4; $i++)
{
	if ($op['ap']['dm_way'] == $dm_way[1][$i]) $op['ap']['dm_way']=$dm_way[0][$i];
}

$op['dm_way_select'] = $arry2->select($dm_way[0],$op['ap']['dm_way'],"PHP_dm_way","select","");

$op['revise'] = $PHP_revise;
// print_r($op); #PHP_vendor sup_code
page_display($op, '037', $TPL_APLY_ADD);			    	    
break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "del_ap_det_ajax":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "del_ap_det_ajax":
check_authority('037',"add");	

$del_id = explode('|',$PHP_id);
for ($i = 0; $i < sizeof($del_id); $i++)		
{
	$f1=$apply->mat_del($del_id[$i]);
}

# 舊的資料抓取要抓 AP_MARK ， 之後的資料就部會再用~ 暫時先保留
$del_mat_id = explode('|',$PHP_mat_id);
if ($PHP_mat_cat == 'l') 
{
	for($i=0; $i<sizeof($del_mat_id); $i++) $apply->bom_del('bom_lots',$PHP_ap_num, $del_mat_id[$i]);

}else if ($PHP_mat_cat == 'a'){
	for($i=0; $i<sizeof($del_mat_id); $i++) $apply->bom_del('bom_acc',$PHP_ap_num, $del_mat_id[$i]);

}

//記錄修改者+修改日

$tmp_num = substr($PHP_ap_num,2);
$po_num = "PO".$tmp_num;

$msg = "Successfully delete PO : ".$po_num." mat : ".$PHP_mat_code;
$log->log_add(0,"51A",$msg);

echo $msg;
break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "del_ap_spc_ajax":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "del_ap_spc_ajax":
		check_authority('037',"add");	
		$f1=$apply->special_del($PHP_id);
		
		$tmp_num = substr($PHP_ap_num,2);
		$po_num = "PO".$tmp_num;


		$msg = "Successfully delete PO : ".$po_num." mat : ".$PHP_mat_code." color & cat: ".$PHP_color;
		$log->log_add(0,"51A",$msg);

		echo $msg;
		break;
	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "do_apply_del":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "do_apply_del":
		//check_authority(5,2,"add");	
		$op = $apply->get($PHP_ap_num);
		if (!$admin->is_power("037","add"))
		{
			if (($op['ap']['ap_user'] != $GLOBALS['SCACHE']['ADMIN']['login_id'])){
				$op['msg'][]= "sorry! you don't have this Authoritys !";
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
		}

		if ($op['ap']['special'] == 0)
		{
			for ($i =0; $i< sizeof($op['ap_det']); $i++)
			{
				if ($op['ap_det'][$i]['mat_cat'] == 'l') 
				{
					$parm_del = array($op['ap_det'][$i]['bom_id'], 'ap_mark','','bom_lots');
				}else if ($op['ap_det'][$i]['mat_cat'] == 'a'){
					$parm_del = array($op['ap_det'][$i]['bom_id'], 'ap_mark','','bom_acc');
				}
				$bom->update_field($parm_del);			
			}
		}
	
		$f1 = $apply->del_pa($PHP_ap_num);
		$f1 = $po->del_po($PHP_ap_num);

		$msg = "Successfully delete PO : ".$op['ap']['po_num'];
		$log->log_add(0,"51A",$msg);
		if ($PHP_back_act == 'apply_wi_view')
		{
			$redirect = "index2.php?PHP_action=".$PHP_back_act."&PHP_sr".$PHP_sr_startno."&PHP_dept_code=".$PHP_dept_code."&PHP_cust=".$PHP_cust."&PHP_num=".$PHP_num."&PHP_msg=".$msg."&PHP_id=".$PHP_id."&PHP_full=".$PHP_full;
		}else if($PHP_back_act == 'apply_ext_bom_view'){
			$redirect = "index2.php?PHP_action=".$PHP_back_act."&PHP_sr".$PHP_sr_startno."&PHP_dept_code=".$PHP_dept_code."&PHP_cust=".$PHP_cust."&PHP_num=".$PHP_num."&PHP_special=1&PHP_msg=".$msg."&PHP_id=".$PHP_id;							
		}else{
			$redirect = "index2.php?PHP_action=".$PHP_back_act."&PHP_dept_code=".$PHP_dept_code."&PHP_SCH_num=".$PHP_SCH_num."&PHP_SCH_fty=".$PHP_SCH_fty."&PHP_SCH_cust=".$PHP_SCH_cust."&PHP_SCH_supl=".$PHP_SCH_supl."&PHP_sr_startno=".$PHP_sr_startno."&PHP_msg=".$msg;
		}

		redirect_page($redirect);

		break;	
	
	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "do_apply_add":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "do_apply_add":
		check_authority('037',"add");	
	
	if (isset($PHP_SCH_num))
	{
		$back_str="?PHP_action=apply_search&PHP_dept_code=".$PHP_dept_code."&PHP_SCH_num=".$PHP_SCH_num."&PHP_SCH_fty=".$PHP_SCH_fty."&PHP_SCH_cust=".$PHP_SCH_cust."&PHP_SCH_supl=".$PHP_SCH_supl."&PHP_sr_startno=".$PHP_sr_startno;
	}else{
			$wi_id = $wi->get_field($op['ap_det2'][0]['ord_num'],'id');
			$back_str="?PHP_action=apply_wi_view&PHP_sr=&PHP_dept_code=".$op['ap']['dept']."&PHP_cust=".$op['ap']['cust']."&PHP_num=&PHP_full=&PHP_id=".$wi_id['id'];
			$op['back_str']=$back_str;
			$op['add_back'] = 'apply_wi_view';
	}
	$op['back_str']=$back_str;
		if ($op['ap']['revise'] > 0 || $op['ap']['apv_user']) $op['ap']['revise'] =$op['ap']['revise']+1;

	$redirect_str = 'po.php?PHP_action=po_add&PHP_aply_num='.$PHP_ap_num;

	redirect_page($redirect_str);

	if ($PHP_revise == 1)
	{
		page_display($op, '037', $TPL_APLY_SHOW_REV);
	}else{
		page_display($op, '037', $TPL_APLY_SHOW);			    	    
	}
	break;



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "do_apply_spc_add1":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "do_apply_spc_add1":
		check_authority('037',"add");	
		$redirect_str = 'po.php?PHP_action=po_add&PHP_aply_num='.$PHP_ap_num;
		redirect_page($redirect_str);
		
		$op = $apply->get($PHP_ap_num);		
		$op['ap_det2'] = $apply->group_ap($op['ap_det']);	//組同請購明細

		$op['CURRENCY_select'] = $arry2->select($CURRENCY,$op['ap']['currency'],'PHP_CURRENCY','select','');
		$op['FACTORY_select'] = $arry2->select($SHIP,$op['ap']['arv_area'],'PHP_FACTORY','select',"ship_show(this)");
		for ($i=0; $i< 4; $i++)
		{
			if ($op['ap']['dm_way'] == $dm_way[1][$i]) $op['ap']['dm_way']=$dm_way[0][$i];
		}
		$op['dm_way_select'] = $arry2->select($dm_way[0],$op['ap']['dm_way'],"PHP_dm_way","select","");

		if ($op['ap']['arv_area'])
		{
			$op['ap']['ship_name'] = $SHIP_TO[$op['ap']['arv_area']]['Name'];
			$op['ap']['ship_addr'] = $SHIP_TO[$op['ap']['arv_area']]['Addr'];
			$op['ap']['ship_tel']  = $SHIP_TO[$op['ap']['arv_area']]['TEL'];
			$op['ap']['ship_fax']  = $SHIP_TO[$op['ap']['arv_area']]['FAX'];
			$op['ap']['ship_attn'] = $SHIP_TO[$op['ap']['arv_area']]['Attn'];
		}

		$op['back_str']=$PHP_back_str;
		$op['revise'] = $PHP_revise;
		page_display($op, '037', $TPL_APLY_SPC_ADD);			    	    
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "do_apply_spc_add2":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "do_apply_spc_add2":
		check_authority('037',"add");	
			if (isset($PHP_SCH_num))
			{
				$back_str="?PHP_action=apply_search&PHP_dept_code=".$PHP_dept_code."&PHP_SCH_num=".$PHP_SCH_num."&PHP_SCH_fty=".$PHP_SCH_fty."&PHP_SCH_cust=".$PHP_SCH_cust."&PHP_SCH_supl=".$PHP_SCH_supl."&PHP_sr_startno=".$PHP_sr_startno;				
			}else{
				if (isset($op['ap_det2'][0]['ord_num']))
				{
					$wi_id = $wi->get_field($op['ap_det2'][0]['ord_num'],'id');
					$back = "apply_wi_view";
				}else{
					$wi_id = $wi->get_field($op['ap_spec'][0]['ord_num'],'id');
					$back = "apply_ext_bom_view";
				}
				$back_str="?PHP_action=".$back."&PHP_sr=&PHP_dept_code=".$op['ap']['dept']."&PHP_cust=".$op['ap']['cust']."&PHP_num=&PHP_full=&PHP_id=".$wi_id['id'];
				$op['add_back'] = $back;
			}
			$op['back_str']=$back_str;
		if ($op['ap']['revise'] > 0 || $op['ap']['apv_user']) $op['ap']['revise'] =$op['ap']['revise']+1;

	$redirect_str = 'po.php?PHP_action=po_add&PHP_aply_num='.$PHP_ap_num;
	redirect_page($redirect_str);

	
		if ($PHP_revise == 1)
		{
			page_display($op, '037', $TPL_APLY_SHOW_REV);
		}else{
			page_display($op, '037', $TPL_APLY_SHOW);			    	    
		}		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "apply_edit":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    case "apply_edit":
		check_authority('037',"edit");		
	$where_str="AND( item like '%special%')";		
	$op = $apply->get($PHP_aply_num,$where_str);

				
//組合畫面List
	if (isset($op['ap_det']))
	{
			$op['ap_det2'] = $apply->group_ap($op['ap_det']);	//組同請購明細
	}
	
	
	if ($op['ap']['arv_area'])
	{
		$op['ap']['ship_name'] = $SHIP_TO[$op['ap']['arv_area']]['Name'];
		$op['ap']['ship_addr'] = $SHIP_TO[$op['ap']['arv_area']]['Addr'];
		$op['ap']['ship_tel']  = $SHIP_TO[$op['ap']['arv_area']]['TEL'];
		$op['ap']['ship_fax']  = $SHIP_TO[$op['ap']['arv_area']]['FAX'];
		$op['ap']['ship_attn'] = $SHIP_TO[$op['ap']['arv_area']]['Attn'];
	}

		$op['CURRENCY_select'] = $arry2->select($CURRENCY,$op['ap']['currency'],'PHP_CURRENCY','select','');
		$op['FACTORY_select'] = $arry2->select($SHIP,$op['ap']['arv_area'],'PHP_FACTORY','select',"ship_show(this)");
		for ($i=0; $i< 4; $i++)
		{
			if ($op['ap']['dm_way'] == $dm_way[1][$i]) $op['ap']['dm_way']=$dm_way[0][$i];
		}

		$op['dm_way_select'] = $arry2->select($dm_way[0],$op['ap']['dm_way'],"PHP_dm_way","select","");


		$op['back_str']=$PHP_back_str;
		
		page_display($op, '037', $TPL_APLY_EDIT);			    	    
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "mat_edit":			job 51
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "mat_edit":
//		check_authority('037',"edit");
		$id = explode('|',$PHP_id_comp);
		$s_total=0;
		$tmp=0;
		if ($PHP_special == 2){$PHP_table = 'ap_special';}else{$PHP_table = 'ap_det';}
		for ($i=0; $i< sizeof($id); $i++)		//取得每項的請購量,並加總
		{
			$where_str = "id = ".$id[$i];
			$row[$i]=$po->get_det_field('ap_qty',$PHP_table,$where_str);
			$s_total = $s_total + $row[$i]['ap_qty'];
		}		
		for ($i=0; $i< (sizeof($id)-1); $i++)		//計算每項採購量(平分)
		{
			$avg_qty[$i] = $PHP_qty * ($row[$i]['ap_qty'] / $s_total);
			$avg_qty[$i] = number_format($avg_qty[$i],2,'.','');
			$tmp = $tmp + $avg_qty[$i];
		}	
		$tmp_qty = $PHP_qty - $tmp;
		$avg_qty[$i] = $tmp_qty;
		$avg_qty[$i] = number_format($avg_qty[$i],2,'.','');
		
		
		for ($i=0; $i< sizeof($id); $i++)		//加入DB
		{
			$f1=$apply->update_fields_id('ap_qty',$avg_qty[$i], $id[$i], $PHP_table);
			$f1=$apply->update_fields_id('eta',$PHP_eta, $id[$i], $PHP_table);
		}	

		$tmp_num = substr($PHP_ap_num,2);
		$po_num = "PO".$tmp_num;
		
		$message = "Successfully add P/O detial : ".$po_num."record。";
		$log->log_add(0,"51E",$message);		
		
		$message = "Successfully Edit P/O : ".$po_num." record";
		echo $message;
break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case  "bom_close_pa":	 
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 case "bom_close_pa":
 	check_authority('037',"del");
 	
 	$parm=array($PHP_id,'ap_mark','x','bom_lots');
	$bom->update_wi_field($parm);

 	$parm=array($PHP_id,'ap_mark','x','bom_acc');
	$bom->update_wi_field($parm);

	$message= "Remark BOM [".$PHP_wi_num."] was purchased";
					# 記錄使用者動態
	$log->log_add(0,"51A",$message);
	echo $message;
 break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case  "get_sup":	 
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "show_supplier_add":
 	check_authority("002","view");

		$op['supl_cat'] = $PHP_cat;
		$op['country_select'] = $arry2->select($COUNTRY,'','PHP_country','select','');  	
		$op['usance_select'] = $arry2->select($usance,"","PHP_usance","select","");
		$op['dm_way_select'] = $arry2->select($dm_way[0],"","PHP_dm_way","select","");
		$op['item']=$PHP_item;
		$op['add_view']=1;
		page_display($op, "002", $TPL_EX_SUPL_ADD);
		break;
		


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case  "do_supl_add":	 	JOB 12A
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "do_ex_supl_add":

		check_authority("002","add");	
			
		$parm = array(	"supl_cat"			=>	$PHP_supl_cat,
						"vndr_no"			=>	$PHP_vndr_no,
						"country"			=>	$PHP_country,
						"supl_s_name"		=>	$PHP_supl_s_name,
						"supl_f_name"		=>	$PHP_supl_f_name,
						"uni_no"			=>	$PHP_uni_no,
						"cntc_phone"		=>	$PHP_cntc_phone,
						"cntc_addr"			=>	$PHP_cntc_addr,
						"cntc_person1"		=>	$PHP_cntc_person1,
						"cntc_cell1"		=>	$PHP_cntc_cell1,
						"email1"			=>	$PHP_email1,
						"cntc_person2"		=>	$PHP_cntc_person2,
						"cntc_cell2"		=>	$PHP_cntc_cell2,
						"email2"			=>	$PHP_email2,
						"cntc_fax"			=>	$PHP_cntc_fax,
						"usance"			=>	$PHP_usance,						
						"dm_way"			=>	$PHP_dm_way
				);

				$op['supl'] = $parm;

		$f1 = $supl->add($parm);
//		$f1=1;
		if ($f1) {  // 成功輸入資料時
			$PHP_supl_s_name=$PHP_vndr_no;
			if (!$op['supl'] = $supl->get(0,$PHP_vndr_no)) {	//搜尋列表
				$op['msg']= $supl->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}

			$message= "Append supl:".$parm['supl_s_name'];

					# 記錄使用者動態
			$log->log_add(0,"12A",$message);
			
			$op['msg'][] = $message;
			// 取出全部的 供應商類別代號
			$cat_def = $supl_type->get_fields('supl_type');   
			$op['cat_select'] = $arry2->select($cat_def,"","PHP_supl_cat","select","");
			$op['item']=$PHP_item;
			$op['cfm_view']=1;
			page_display($op, "002",  $TPL_EX_SUPL_ADD);
			break;
	
	
		}	else {  // 當沒有成功輸入新增user的欄位時....

			$op['supl'] = $parm;
			$op['supl_cat'] = $parm['supl_cat'];
			$op['msg'] = $supl->msg->get(2);


			$cat_def = $supl_type->get_fields('supl_type'); 
			$op['cat_select'] = $arry2->select($cat_def,"","PHP_supl_cat","select",""); 
			$op['country_select'] = $arry2->select($COUNTRY,$PHP_country,'PHP_country','select','');  
			
			$op['usance_select'] = $arry2->select($usance,$PHP_usance,"PHP_usance","select","");
			$op['dm_way_select'] = $arry2->select($dm_way[0],$PHP_dm_way,"PHP_dm_way","select","");	
			$op['item']=$PHP_item;
			$op['add_view']=1;
			page_display($op, "002", $TPL_EX_SUPL_ADD);
			break;

		}
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case  "get_sup":	 
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "show_supplier_search":

$op['country_select'] = $arry2->select($COUNTRY,'','PHP_country','select','');  	//國別做成下拉式
$cat_def = $SUPL_TYPE;   // 取出全部的 供應商類別 [ config.php ]
$op['cat_select'] = $arry2->select($cat_def,"","PHP_supl_cat","select",""); 	//供應商類別做成下拉式
if(isset($PHP_cat))$op['cat_select']=$PHP_cat."<input type=hidden name='PHP_supl_cat' value='$PHP_cat'>";
$op['item']=$PHP_item;
$op['ap_supl']=$ap_supl;

page_display($op, "002", $TPL_SUPNO);
break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "do_get_sup":	 	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "do_get_sup":
		if(isset($PHP_supl_s_name))
		{
			
			$sch_parm = array();
			$sch_parm = array(	
						"PHP_supl_cat"			=>  $PHP_supl_cat,
						"PHP_country"				=>	$PHP_country,
						"PHP_supl_s_name"		=>	$PHP_supl_s_name,
						"PHP_supl_f_name"		=>	$PHP_supl_f_name,
						"PHP_sr_startno"		=>	$PHP_sr_startno,
						"PHP_action"				=>	$PHP_action						
				);

		}else{		
			if(isset($PHP_sr_startno))$sch_parm['PHP_sr_startno'] = $PHP_sr_startno;
		}
		
		if(isset($PHP_sort)){
			$sch_parm['SCH_sort'] = $PHP_sort;
		}

		if (!$op = $supl->search(0)) {		//搜尋條件下的供應商資料
			$op['msg']= $supl->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		for ($i=0; $i<sizeof($op['supl']); $i++)
		{
			$op['supl'][$i]['supl_s_name'] = str_replace("'"," ",$op['supl'][$i]['supl_s_name']);
		}
		$op['country_select'] = $arry2->select($COUNTRY,'','PHP_country','select','');  	//國別做成下拉式
		$cat_def = $SUPL_TYPE;   // 取出全部的 供應商類別代號 [ config.php ]
		$op['cat_select'] = $arry2->select($cat_def,"","PHP_supl_cat","select",""); 	//供應商類別做成下拉式
		if($sch_parm['PHP_supl_cat'])$op['cat_select']=$sch_parm['PHP_supl_cat']."<input type=hidden name='PHP_supl_cat' value='".$sch_parm['PHP_supl_cat']."'>";
		$op['msg']= $supl->msg->get(2);
		$op['item']=$PHP_item;
		page_display($op, "002", $TPL_SUPNO);
		break;
		
		
		





#++++++++++++++    SAMPLE ORDER +++++++++++++  2006/11/08  +++++++++++++++++
#		 job 92    樣本 報價工作單記錄系統 
#++++++++++++++++++++++++++++++++++++++++++++  2006/11/09  +++++++++++++++++
#		case "offer":			job 92
#		case "add_offer":		job 92A
#		case "do_add_offer":	job 92A
#		case "offer_search":	job 92V
#		case "offer_view":		job 92V offer view
#		case "offer_edit":
#		case "do_offer_edit":


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "offer":	job 92
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "offer":

check_authority('062',"view");

$where_str = $manager = $dept_id = '';
$dept_ary = array();

$sales_dept_ary = get_sales_dept(); //  [不含K0] ------
$my_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標

// $my_dept = $GLOBALS['MY_DEPT']; 
$my_team = $GLOBALS['SCACHE']['ADMIN']['team_id'];

for ($i=0; $i<count($sales_dept_ary);$i++){
	if($my_dept == $sales_dept_ary[$i]){
		// 如果是業務部進入 則dept_code 指定該業務部---
		$dept_id = $sales_dept_ary[$i];  
		$where_str = " WHERE dept = '".$dept_id."' ";
	}
}

if (!$dept_id) { // 當不是業務部人[也不含 K0 的人 ]進入時
	$manager = 1;
	// 業務部門 select選單
	$dept_ary = $arry2->select($sales_dept_ary,$GLOBALS['SCACHE']['ADMIN']['dept'],"PHP_dept_code","select",'get_dept(this)');  
}

$op['manager_flag'] = $manager;
$op['dept_id'] = $dept_id;
$op['dept_ary'] = $dept_ary;

// creat cust combo box	 取出 客戶代號

$where_str=$where_str."order by cust_s_name"; //依cust_s_name排序
if(!$cust_def = $cust->get_fields('cust_init_name',$where_str)){;  //取出客戶簡稱
	$op['msg'][] = "sorry! there is no any customer record in your team, please add customer first!";
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}

$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
for ($i=0; $i< sizeof($cust_def); $i++)
{
	$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
}

$op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','check_add(this)',$cust_def_vue); 

if (count($cust_def) == 0){  // 當找不到客戶資料時......
	$op['msg'][] = "sorry! selected department doesn't have any customer record yet, please add customer for this Team first !";
	$layout->assign($op);
	$layout->display($TPL_ERROR);		    	    
	break;
}

//080725message增加		
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];

		page_display($op,'062', $TPL_OFFER);			
		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "add_offer":	job 92A
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "add_offer":

		check_authority('062',"add");

		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];  

			$op['cust_id'] = $PHP_cust;

		// 傳入參數


			$where_str="ORDER BY cust_s_name"; //依cust_s_name排序
			$cust_def = $cust->get_fields('cust_init_name',$where_str);
			$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
			for ($i=0; $i< sizeof($cust_def); $i++)
			{
				$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
			}
			
			$op['agent_select'] =  $arry2->select($cust_value,'','PHP_agent','select','',$cust_def_vue); 



		$op['of']['date'] = $TODAY;
		$op['of']['cust'] = $PHP_cust;
		$op['of']['merchan'] = $GLOBALS['SCACHE']['ADMIN']['login_id']; 
		$op['of']['dept_code'] = $PHP_dept_code;
		$op['of']['fty'] = $arry2->select($FACTORY,'','PHP_fty','select','');

		// create new PS number ------
		$sr_key = substr($THIS_YEAR,2,2).substr($TODAY,5,2).substr($TODAY,8,2).'-';

		$op['num'] = $sr_key.'xx';
		
		page_display($op,'062', $TPL_OFFER_ADD);			
		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "do_add_offer":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "offer_fab_add":
		check_authority('062',"add");
		if (!$PHP_id)	
		{
			$sr_key = substr($THIS_YEAR,2,2).substr($TODAY,5,2).substr($TODAY,8,2).'-';
			$num = $offer->get_new_number($sr_key); 
			$f1 = $offer->add_offer($num);
			$PHP_id = $f1;
			$PHP_num=$num;
		}
		$where_str = "WHERE id = ".$PHP_id;
		$item = $offer->get_one_field($PHP_group."_item",$where_str);
		$usage = $offer->get_one_field($PHP_group."_usage",$where_str);
		$price = $offer->get_one_field($PHP_group."_price",$where_str);
		$yy = $offer->get_one_field($PHP_group."_yy",$where_str);
		$num = $offer->get_one_field("num",$where_str);
		if(!$item)
		{
			$parm = array("item"	=>	$PHP_item,
										"usage"	=>	$PHP_usage,
										"price"	=>	$PHP_price,
										"yy"		=>	$PHP_yy,										
										"id"		=>	$PHP_id,
										);
		}else{
			$parm = array("item"	=>	$item."|".$PHP_item,
										"usage"	=>	$usage."|".$PHP_usage,
										"price"	=>	$price."|".$PHP_price,
										"yy"		=>	$yy."|".$PHP_yy,
										"id"		=>	$PHP_id,
										);
		}
		$f1 = $offer-> update_det($parm,$PHP_group);
		$message = "Add Material [ ".$PHP_item." ] detial";
		$s_total =$PHP_price * $PHP_yy;  //物料單筆小計
		//echo $s_total;
		$f_total = $PHP_cost + $s_total;  //金額總計
		$l_total = $f_total / $PHP_gm; //金額總計(包括GM)
		if ($PHP_group =='fab') $group_name ="Fabric";
		if ($PHP_group =='acc') $group_name ="Trimming";
		if ($PHP_group =='other') $group_name ="Other/Treatment";
		if ($PHP_group =='inter') $group_name ="InterLining";
		if ($PHP_group =='fus') $group_name ="Fusible";
		if (!$PHP_usage) $PHP_usage='&nbsp;';
		echo $message."|".$PHP_num."|".$PHP_id."|".$group_name."|".$PHP_item."|".$PHP_usage."|".$PHP_price."|".$PHP_yy."|";
		echo number_format($s_total,2,'.','')."|";
		echo "<input type='image' src='images/del.png'  onclick=\"del_det('$PHP_id','$PHP_group','$PHP_item','$PHP_usage',this)\">|";	
		echo number_format($f_total,2,'.','')."|".number_format($l_total,2,'.','');
exit;
	break;
	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "offer_mat_del":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "offer_mat_del":
		check_authority('062',"add");
		$where_str = "WHERE id = ".$PHP_id;
		$item = $offer->get_one_field($PHP_group."_item",$where_str);
		$usage = $offer->get_one_field($PHP_group."_usage",$where_str);
		$price = $offer->get_one_field($PHP_group."_price",$where_str);
		$yy = $offer->get_one_field($PHP_group."_yy",$where_str);
		$num = $offer->get_one_field("num",$where_str);
		$ary_item = explode('|',$item);
		$ary_usage = explode('|',$usage);
		$ary_price = explode('|',$price);
		$ary_yy = explode('|',$yy);
		$del_price=$del_yy=0;
		$new_item=$new_usage=$new_price=$new_yy='';
		for ($i=0; $i<sizeof($ary_item); $i++)
		{
			if(!isset($ary_usage[$i]))$ary_usage[$i]='';
			if($ary_usage[$i] == $PHP_usage && $ary_item[$i] == $PHP_item)
			{
				$del_price=$ary_price[$i];
				$del_yy = $ary_yy[$i];
			}else{
				$new_item.=$ary_item[$i]."|";
				$new_usage.=$ary_usage[$i]."|";
				$new_price.=$ary_price[$i]."|";
				$new_yy.=$ary_yy[$i]."|";
			}
		}
		$new_item = substr($new_item,0,-1);
		$new_usage = substr($new_usage,0,-1);
		$new_price = substr($new_price,0,-1);
		$new_yy = substr($new_yy,0,-1);
		$parm = array("item"	=>	$new_item,
									"usage"	=>	$new_usage,
									"price"	=>	$new_price,
									"yy"		=>	$new_yy,										
									"id"		=>	$PHP_id,
									);

		$f1 = $offer-> update_det($parm,$PHP_group);
		$message = "Delete Material [ ".$PHP_item." ]";
		$s_total =$del_price * $del_yy;  //物料單筆小計
		//echo $s_total;
		$f_total = $PHP_cost - $s_total;  //金額總計
		$l_total = $f_total / $PHP_gm; //金額總計(包括GM)

		echo $message."|";
		echo number_format($f_total,2,'.','')."|".number_format($l_total,2,'.','');
exit;
	break;	

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "do_add_offer":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "do_add_offer":

		check_authority('062',"edit");
			$PHP_cons = $PHP_cons1."|".$PHP_cons2."|".$PHP_cons3;
			$parm = array("id"	=>	$PHP_id,
					"num"						=>	$PHP_num,
					"merchan"				=>	$PHP_merchan,
					"dept"					=>	$PHP_dept_code,
					"buyer"					=>	$PHP_cust,
					"agent"					=>	$PHP_agent,
					"style"					=>	$PHP_style,
					"des"						=>	$PHP_des,
					"fab"						=>	$PHP_fab,
					"cons"					=>	$PHP_cons,
					"spt"						=>	$PHP_spt,

					"tech"					=>	$PHP_tech,
					
					"cm"						=>	$PHP_cm,
					"tt_cost"				=>	$PHP_cost,
					"gm_rate"				=>	$PHP_gm,

					"fty"						=>	$PHP_fty,
					"comm"					=>	$PHP_comm,
					"quota"					=>	$PHP_quota,
					"pic"						=>	$PHP_pic,
					"pic_upload"		=>	$PHP_pic_upload,
				);
		// check 輸入資料之正確	------------------------	
//		$op['of'] = $parm;  // 先將參數轉給 $op ----


		// 其它的處理 ---  將nl轉成br
			$parm['des'] = nl2br($parm['des']);
			$parm['fab'] = nl2br($parm['fab']);
			$parm['cons'] = nl2br($parm['cons']);
			$parm['tech'] = nl2br($parm['tech']);

		//------------ add to DB   --------------------------
		if (!$f = $offer->edit($parm)) {  
			$op['msg'] = $offer->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
		  break;
		}  // end if (!$F1)--------- 成功輸入 ---------------


		
		// 取出該筆 record 資料 -----------------------------
		if (!$op['of']=$offer->get($PHP_id)) {
			$op['msg']= $offer->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$message = " Add OFFER record: [".$op['of']['num']."]";
		$op['msg'][] = $message;
			# 記錄使用者動態
		$log->log_add(0,"92A",$message);


		$op['of_log'] = $offer->get_log($PHP_id);  //取出該筆記錄
		// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/offer/".$op['of']['num'].".jpg")){
			$op['picture'] = "./offer/".$op['of']['num'].".jpg";
		} else {
			$op['picture'] = "./images/graydot.gif";
		}

		// HTML 文件參數
		$op['of'] = $offer->create_items($op['of']);

		$back_str = "index2.php?PHP_action=offer_search&PHP_dept_code=&PHP_num=&PHP_cust=&PHP_style=&SCH_str=&SCH_end=&SCH_agt=";
		$op['back_str'] = $back_str;
		$op['of_sub'] = $arry2->select($OFFER_LOG,'','PHP_subject','select','');

		page_display($op,'062', $TPL_OFFER_SHOW);			
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "offer_comment":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "offer_comment":

		check_authority('062',"add");		
		$PHP_c_date=$PHP_c_user=$PHP_s_date=$PHP_s_user='';
		if ($PHP_com)
		{
			$PHP_c_date = $TODAY;
			$PHP_c_user = $GLOBALS['SCACHE']['ADMIN']['login_id'];
			$PHP_com = nl2br($PHP_com); 
		}
		if ($PHP_status)
		{
			$PHP_s_date = $TODAY;
			$PHP_s_user = $GLOBALS['SCACHE']['ADMIN']['login_id'];
			$PHP_status = nl2br($PHP_status);
		}

		$parm = array(	
						"of_num"			=>	$PHP_of_num,
						"subject"			=>	$PHP_subject,
						"comment"			=>	$PHP_com,
						"status"			=>	$PHP_status,
						"c_date"			=>	$PHP_c_date,
						"c_user"			=>	$PHP_c_user,
						"s_date"			=>	$PHP_s_date,
						"s_user"			=>	$PHP_s_user,
		);
		$message = '';
		if ($PHP_subject)
		{
			//------------ add to DB   --------------------------
			if (!$f = $offer->add_log($parm)) {  
				$op['msg'] = $offer->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
			  break;
			}  // end if (!$F1)--------- 成功輸入 ---------------
		}else{
			$message = "Please select Subject First";
		}
	//	redirect_page($redir_str);
		
		$redir_str = "index2.php?PHP_action=offer_view&PHP_id=".$PHP_of_id."&cgiget=".$PHP_back_str."&PHP_msg=".$message;
		redirect_page($redir_str);
//		page_display($op,'062', $TPL_OFFER_SHOW);			
		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "offer_comment":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "edit_offer_comment":
		check_authority('062',"add");

		if ($PHP_com && !isset($PHP_c_date))
		{
			$PHP_c_date = $TODAY;
			$PHP_c_user = $GLOBALS['SCACHE']['ADMIN']['login_id'];
			$PHP_com = nl2br($PHP_com); 
			$parm = array(	
						"of_num"			=>	$PHP_of_num,
						"comment"			=>	$PHP_com,
						"c_date"			=>	$PHP_c_date,
						"c_user"			=>	$PHP_c_user,
						"id"					=>	$PHP_log_id,
			);
			$f = $offer->edit_log($parm,1);
		}
		if ($PHP_status && !isset($PHP_s_date))
		{
			$PHP_s_date = $TODAY; 
			$PHP_s_user = $GLOBALS['SCACHE']['ADMIN']['login_id'];
			$PHP_status = nl2br($PHP_status);
			$parm = array(	
						"of_num"			=>	$PHP_of_num,
						"status"			=>	$PHP_status,
						"s_date"			=>	$PHP_s_date,
						"s_user"			=>	$PHP_s_user,
						"id"					=>	$PHP_log_id,
			);
			$f = $offer->edit_log($parm,2);

		}
		
		$redir_str = "index2.php?PHP_action=offer_view&PHP_id=".$PHP_of_id."&cgiget=".$PHP_back_str;
		redirect_page($redir_str);
//		page_display($op,'062', $TPL_OFFER_SHOW);			
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "offer_search":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "offer_search":

		check_authority('062',"view");

		$parm = array(	"dept"		=>  $PHP_dept_code,
						"num"			=>  $PHP_num,
						"buyer"		=>	$PHP_cust,
						"style"		=>	$PHP_style,
						"agt"			=> 	$SCH_agt,
						"str"			=>	$SCH_str,
						"end"			=>	$SCH_end
				);

		// ---- 利用PHP_dept_code判定是否 業務部門進入
		if (!$op = $offer->search(1)) {  
			$op['msg']= $offer->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		// ---- 如果 不是 呈承辦業務部門進入時...
		if (!$PHP_dept_code) {   
			$op['manager_flag'] = 1;
		}

		$op['dept_id'] = $PHP_dept_code;

		$op['msg']= $offer->msg->get(2);
		$op['cgi']= $parm;

		page_display($op,'062', $TPL_OFFER_LIST);			
		break;
	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 92V offer view
#		case "offer_view":		job 92V offer view
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "offer_view":

		check_authority('062',"view");

	if (isset($PHP_ver))
	{
		$op['of'] = $offer->get(0,$PHP_of_num,$PHP_ver);  //取出該筆記錄
		$op['none'] = 1;		
		$parm = $op['of'];
	}else{
		$op['of'] = $offer->get($PHP_id);  //取出該筆記錄
		if (!$op['of']) {
			$op['msg'] = $offer->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		
		$parm = $op['of'];
		
		// 加入返回前頁 --------------
				
		$back_str = trim($cgiget)."&PHP_sr_startno=".$PHP_sr_startno."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_style=".$PHP_style."&SCH_agt=".$SCH_agt."&SCH_str=".$SCH_str."&SCH_end=".$SCH_end;

		$back_str2 = "PHP_action=offer_view&PHP_id=".$PHP_id."&PHP_num=".$parm['num'];

		$op['back_str2'] = $back_str2;
		$op['back_str'] = $back_str;		
	}
	$op['of_log'] = $offer->get_log($op['of']['num']);  //取出該筆記錄

	$op['search'] = '1';
		// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/offer/".$op['of']['num'].".jpg")){
			$op['picture'] = "./offer/".$op['of']['num'].".jpg";
		} else {
			$op['picture'] = "./images/graydot.gif";
		}
		$total=0;
		$op['of'] = $offer->create_items($op['of']);

		for ($i=0; $i < ($op['of']['ver']-1); $i++) 
		{
			$op['of']['ver_ary'][$i] = ($i+1);
		}
		$op['msg'] = $offer->msg->get(2);
		if(isset($PHP_msg) && $PHP_msg) $op['msg'][]=$PHP_msg;
		$op['of_sub'] = $arry2->select($OFFER_LOG,'','PHP_subject','select','');
		page_display($op,'062', $TPL_OFFER_SHOW);			
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 92V offer view
#		case "offer_view":		job 92V offer view
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "offer_submit":

		check_authority('062',"view");
		
		$f1= $offer->update_field($PHP_id, 'status', 1);
		
		$op['of'] = $offer->get($PHP_id);  //取出該筆記錄
		if (!$op['of']) {
			$op['msg'] = $offer->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['of_log'] = $offer->get_log($op['of']['num']);  //取出該筆記錄		
		$parm = $op['of'];
		
		// 加入返回前頁 --------------
		$op['back_str'] = $PHP_back_str;
	$op['search'] = '1';
		// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/offer/".$op['of']['num'].".jpg")){
			$op['picture'] = "./offer/".$op['of']['num'].".jpg";
		} else {
			$op['picture'] = "./images/graydot.gif";
		}
		$total=0;
		$op['of'] = $offer->create_items($op['of']);

//		$op['of']['tt_cost'] = get_currency($op['of']['tt_cost']);
		for ($i=0; $i < ($op['of']['ver']-1); $i++) 
		{
			$op['of']['ver_ary'][$i] = ($i+1);
		}
		$message= "Successfully submit offer :".$op['of']['num'];
		$op['msg'][] = $message;
		$log->log_add(0,"92A",$message);
		$op['of_sub'] = $arry2->select($OFFER_LOG,'','PHP_subject','select','');

		page_display($op,'062', $TPL_OFFER_SHOW);			
		break;



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "offer_edit":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "offer_edit":

		check_authority('062',"edit");

		$my_dept = $GLOBALS['SCACHE']['ADMIN']['dept']; 

		if (!$parm = $offer->get($PHP_id)) {
			$op['msg'] = $offer->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		if ($parm['cons']) { $parm['cons'] = str_replace("<br />","",$parm['cons']);}
		if ($parm['tech']) { $parm['tech'] = str_replace("<br />","",$parm['tech']);}
		if ($parm['remark']) { $parm['remark'] = str_replace("<br />","",$parm['remark']);}
		if($my_dept != "RD"){  // 如果是研發部門人員進入時......
  // 如果是 SA 進入時......
			if ($parm['des']) { $parm['des'] = str_replace("<br />","",$parm['des']);}
			if ($parm['fab']) { $parm['fab'] = str_replace("<br />","",$parm['fab']);}
		}

		//  HTML 需要的參數 ---------------------------------------------
		$op['cust_id'] = $PHP_cust;
		$op['back_str'] = $PHP_back_str;
		$op['of'] = $parm;
		$op['my_dept'] = $my_dept;

		// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/offer/".$op['of']['num'].".jpg")){
			$op['picture'] = "./offer/".$op['of']['num'].".jpg";
		} else {
			$op['picture'] = "./images/graydot.gif";
		}

		$total=0;
		$op['of'] = $offer->create_items($op['of']);
		$op['of']['fty'] = $arry2->select($FACTORY,$op['of']['fty'],'PHP_fty','select','');

		$where_str="ORDER BY cust_s_name"; //依cust_s_name排序
		$cust_def = $cust->get_fields('cust_init_name',$where_str);
		$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
		for ($i=0; $i< sizeof($cust_def); $i++)
		{
			$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
		}
		$op['agent_select'] =  $arry2->select($cust_value,$op['of']['agent'],'PHP_agent','select','',$cust_def_vue); 

		page_display($op,'062', $TPL_OFFER_SA_EDIT);
	/*
		if($my_dept == "RD"){
			page_display($op,'062', $TPL_OFFER_RD_EDIT);			
		}else{
			page_display($op,'062', $TPL_OFFER_SA_EDIT);
		}
	*/
		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "do_offer_edit":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "do_offer_edit":

		check_authority('062',"edit");
		$PHP_my_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];
		$PHP_cons = $PHP_cons1."|".$PHP_cons2."|".$PHP_cons3;
		if($PHP_my_dept == 'RD'){
			$parm = array("id"			=>	$PHP_id,
									"num"				=>	$PHP_num,
									"my_dept"		=>	$PHP_my_dept,
									"spt"				=>	$PHP_spt,
									"cons"			=>	$PHP_cons,
									"tech"			=>	$PHP_tech,
									"remark"		=>	$PHP_remark,

									"back_str"	=>	$PHP_back_str,
					);

		}else{
			$parm = array("id"	=>	$PHP_id,
					"my_dept"				=>	$PHP_my_dept,
					"num"						=>	$PHP_num,
					"merchan"				=>	$PHP_merchan,
					"dept"					=>	$PHP_dept_code,
					"buyer"					=>	$PHP_cust,
					"agent"					=>	$PHP_agent,
					"style"					=>	$PHP_style,
					"des"						=>	$PHP_des,
					"fab"						=>	$PHP_fab,
					"cons"					=>	$PHP_cons,
					"spt"						=>	$PHP_spt,

					"tech"					=>	$PHP_tech,
					
					"cm"						=>	$PHP_cm,
					"tt_cost"				=>	$PHP_cost,
					"gm_rate"				=>	$PHP_gm,

					"fty"						=>	$PHP_fty,
					"comm"					=>	$PHP_comm,
					"quota"					=>	$PHP_quota,
					
					"pic"						=>	$PHP_pic,
					"pic_upload"		=>	$PHP_pic_upload,
					"back_str"			=>	$PHP_back_str,
				);
		}

		// check 輸入資料之正確	------------------------	
		$op['of'] = $parm;  // 先將參數轉給 $op ----


		// 其它的處理 ---  將nl轉成br
		if($PHP_my_dept == 'RD'){
			$parm['cons'] = nl2br($parm['cons']);
			$parm['tech'] = nl2br($parm['tech']);
		}else{
			$parm['des'] = nl2br($parm['des']);
			$parm['fab'] = nl2br($parm['fab']);
			$parm['cons'] = nl2br($parm['cons']);
			$parm['tech'] = nl2br($parm['tech']);
		}

		//------------ add to DB   --------------------------
		if (!$f = $offer->edit($parm)) {  
			$op['msg'] = $offer->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
		  break;
		}  // end if (!$F1)--------- 成功輸入 ---------------

		$message = " update OFFER sheet:[".$PHP_num."]";
		$op['msg'][] = $message;

			# 記錄使用者動態
		$log->log_add(0,"92A",$message);
		
		// 取出該筆 record 資料 -----------------------------
		if (!$op['of']=$offer->get($f)) {
			$op['msg']= $offer->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['of_log'] = $offer->get_log($op['of']['num']);  //取出該筆記錄
		// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/offer/".$op['of']['num'].".jpg")){
			$op['picture'] = "./offer/".$op['of']['num'].".jpg";
		} else {
			$op['picture'] = "./images/graydot.gif";
		}

		// HTML 文件參數
		$op['back_str'] = $parm['back_str'];

		$total=0;
		$op['of'] = $offer->create_items($op['of']);

		for ($i=0; $i < ($op['of']['ver']-1); $i++) 
		{
			$op['of']['ver_ary'][$i] = ($i+1);
		}
		$op['of_log'] = $offer->get_log($op['of']['num']);  //取出該筆記錄		
		$op['of_sub'] = $arry2->select($OFFER_LOG,'','PHP_subject','select','');
	
		page_display($op,'062', $TPL_OFFER_SHOW);			
		break;




#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "offer_revise":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "offer_revise":

		check_authority('062',"edit");

		$my_dept = $GLOBALS['SCACHE']['ADMIN']['dept']; 

		if (!$parm = $offer->get($PHP_id)) {
			$op['msg'] = $offer->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		if ($parm['cons']) { $parm['cons'] = str_replace("<br />","",$parm['cons']);}
		if ($parm['tech']) { $parm['tech'] = str_replace("<br />","",$parm['tech']);}
		if ($parm['remark']) { $parm['remark'] = str_replace("<br />","",$parm['remark']);}

		if($my_dept != "RD"){  // 如果是研發部門人員進入時......
  // 如果是 SA 進入時......
			if ($parm['des']) { $parm['des'] = str_replace("<br />","",$parm['des']);}
			if ($parm['fab']) { $parm['fab'] = str_replace("<br />","",$parm['fab']);}
		}

		//  HTML 需要的參數 ---------------------------------------------
		$op['cust_id'] = $parm['buyer'];
		$back_str='';
		if(isset($PHP_style))
			$back_str = trim($cgiget)."&PHP_sr_startno=".$PHP_sr_startno."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_style=".$PHP_style;
		$op['back_str'] = $back_str;
		$op['of'] = $parm;
		$op['my_dept'] = $my_dept;

		// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/offer/".$op['of']['num'].".jpg")){
			$op['picture'] = "./offer/".$op['of']['num'].".jpg";
		} else {
			$op['picture'] = "./images/graydot.gif";
		}

		$total=0;
		$op['of'] = $offer->create_items($op['of']);

		$op['of']['fty'] = $arry2->select($FACTORY,$op['of']['fty'],'PHP_fty','select','');

		$where_str="ORDER BY cust_s_name"; //依cust_s_name排序
		$cust_def = $cust->get_fields('cust_init_name',$where_str);
		$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
		for ($i=0; $i< sizeof($cust_def); $i++)
		{
			$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
		}
		$op['agent_select'] =  $arry2->select($cust_value,$op['of']['agent'],'PHP_agent','select','',$cust_def_vue); 


		if($my_dept == "RD"){
			page_display($op,'062', $TPL_OFFER_RD_REV);			
		}else{
			page_display($op,'062', $TPL_OFFER_SA_REV);
		}

		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "do_offer_revise":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "do_offer_revise":

		check_authority('062',"edit");
		$PHP_my_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];
		$PHP_cons = $PHP_cons1."|".$PHP_cons2."|".$PHP_cons3;

		if($PHP_my_dept == 'RD'){
			$parm = array("id"		=>	$PHP_id,
					"num"			=>	$PHP_num,
					"spt"			=>	$PHP_spt,
					"cons"			=>	$PHP_cons,
					"tech"			=>	$PHP_tech,
					"remark"		=>	$PHP_remark,
					"ver"			=>	($PHP_ver+1),
					"k_date"		=>	$TODAY,
					"merchan"		=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
					"back_str"		=>	$PHP_back_str,
					);

		}else{
			$parm = array("id"	=>	$PHP_id,
					"num"						=>	$PHP_num,
					"dept"					=>	$PHP_dept_code,
					"buyer"					=>	$PHP_cust,
					"agent"					=>	$PHP_agent,
					"style"					=>	$PHP_style,
					"des"						=>	$PHP_des,
					"fab"						=>	$PHP_fab,
					"cons"					=>	$PHP_cons,
					"spt"						=>	$PHP_spt,

					"tech"					=>	$PHP_tech,

					"cm"						=>	$PHP_cm,
					"tt_cost"				=>	$PHP_cost,
					"gm_rate"				=>	$PHP_gm,

					"fty"						=>	$PHP_fty,
					"comm"					=>	$PHP_comm,
					"quota"					=>	$PHP_quota,

					"pic"						=>	$PHP_pic,
					"pic_upload"		=>	$PHP_pic_upload,
					"ver"						=>	($PHP_ver+1),
					"k_date"				=>	$TODAY,
					"merchan"				=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
					"back_str"			=>	$PHP_back_str,
				);
		}

		// check 輸入資料之正確	------------------------	
		$op['of'] = $parm;  // 先將參數轉給 $op ----


		// 其它的處理 ---  將nl轉成br
		if($PHP_my_dept == 'RD'){
			$parm['cons'] = nl2br($parm['cons']);
			$parm['tech'] = nl2br($parm['tech']);
		}else{
			$parm['des'] = nl2br($parm['des']);
			$parm['fab'] = nl2br($parm['fab']);
			$parm['cons'] = nl2br($parm['cons']);
			$parm['tech'] = nl2br($parm['tech']);
		}

		//------------ add to DB   --------------------------
		if (!$f = $offer->revise($parm)) {  
			$op['msg'] = $offer->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
		  break;
		}  // end if (!$F1)--------- 成功輸入 ---------------

		$message = " REVISE OFFER sheet:[".$PHP_num."]";
		$op['msg'][] = $message;

			# 記錄使用者動態
		$log->log_add(0,"92A",$message);
		
		// 取出該筆 record 資料 -----------------------------
		if (!$op['of']=$offer->get($f)) {
			$op['msg']= $offer->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

//增加版本remark
		$PHP_status = $PHP_com = "RENEW New Version :[ ".$parm['ver']." ] On :[".$TODAY."]";
		$PHP_s_date = $PHP_c_date = $TODAY;
		$PHP_s_user = $PHP_c_user = $GLOBALS['SCACHE']['ADMIN']['login_id'];
		$parm = array(	
						"of_num"			=>	$op['of']['num'],
						"subject"			=>	'others',
						"comment"			=>	$PHP_com,
						"status"			=>	$PHP_status,
						"c_date"			=>	$PHP_c_date,
						"c_user"			=>	$PHP_c_user,
						"s_date"			=>	$PHP_s_date,
						"s_user"			=>	$PHP_s_user,
		);

		//------------ add to DB   --------------------------
		if (!$f = $offer->add_log($parm)) {  
			$op['msg'] = $offer->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
		  break;
		}  // end if (!$F1)--------- 成功輸入 ---------------




		$op['of_log'] = $offer->get_log($op['of']['num']);  //取出該筆記錄
		// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/offer/".$op['of']['num'].".jpg")){
			$op['picture'] = "./offer/".$op['of']['num'].".jpg";
		} else {
			$op['picture'] = "./images/graydot.gif";
		}

		// HTML 文件參數
		$op['back_str'] = $PHP_back_str;

		$total=0;
		$op['of'] = $offer->create_items($op['of']);

		for ($i=0; $i < ($op['of']['ver']-1); $i++) 
		{
			$op['of']['ver_ary'][$i] = ($i+1);
		}
		$op['none']=1;
		$op['of_log'] = $offer->get_log($op['of']['num']);  //取出該筆記錄
		$op['of_sub'] = $arry2->select($OFFER_LOG,'','PHP_subject','select','');

		page_display($op,'062', $TPL_OFFER_SHOW);			
		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 92V offer view
#		case "offer_view":		job 92V offer view
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "offer_print_a":

		check_authority('062',"view");

	if (isset($PHP_ver))
	{
		$of = $offer->get(0,$PHP_of_num,$PHP_ver);  //取出該筆記錄
	}else{
		$of = $offer->get($PHP_id);  //取出該筆記錄
	}

		// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/offer/".$of['num'].".jpg")){
			$op['picture'] = "./offer/".$of['num'].".jpg";
		} else {
			$op['picture'] = "./images/graydot.jpg";
		}
		$of = $offer->create_item_pdf($of);

//---------------------------------- 資料庫作業結束 ------------------------------


include_once($config['root_dir']."/lib/class.pdf_offer_a.php");

$print_title = "OFFER";

$print_title2 = "VER.".$of['ver']."  on  ".$of['k_date'];
$PHP_id = $of['num'];
/*
$creat=$user->get(0,$of['merchan']);
	if ($creat['name'])$of['merchan'] = $creat['name'];
*/
$creator = $of['merchan'];

$pdf=new PDF_offer_a();
$pdf->SetAutoPageBreak("on");
$pdf->AliasNbPages(); 
$pdf->AddBig5Font();
$pdf->Open();
$pdf->AddPage();
$pdf->SetFont('Arial','B',14);
// [表匡] 訂單基本資料
$pdf->hend_title($of);

		$Y = $pdf->getY();
		
		$img_size = GetImageSize($op['picture']);
		
		if ($img_size[0] > $img_size[1])
		{
			$pdf->Image($op['picture'],10,28,40,0);
		}else{
			$pdf->Image($op['picture'],10,28,0,40);
		}
		
		$pdf->ln();
		$Y = $pdf->getY();
		$X = $pdf->getX();
		$pdf->setXY(10,$Y+5);
		$pdf->descript('Style Description : ',$of['des']);
		$pdf->descript('Fabrication : ',$of['fab']);
		$pdf->descript('Fab. Consump. : ',$of['cons']);
		$pdf->ln();
		$pdf->Cell(185,5,"-------------------- unit cost --------------------",0,0,'C');
		$pdf->ln();
		$pdf->Table_title(); //Unit Cost的Title
		
		$pdf->Table_cost_a($of['fab_cat']); //主料
		$pdf->Table_cost_a($of['fus_cat']);	//fusible
		$pdf->Table_cost_a($of['inter_cat']); //interling
		$pdf->Table_cost_a($of['acc_cat']);		//accessory
		$pdf->Table_cost_a($of['oth_cat']);		//other

		//CM內容
		$pdf->Table_cost("C.M.", number_format($of['cm'],2,'.',''));
		$pdf->Table_cost("Quota", number_format($of['quota'],2,'.',''));


		//Mark-Up內容
		$pdf->Table_cost("Mark-Up", $of['gm_rate']."%");

		//Commission內容
		$pdf->Table_cost("Commission", $of['comm']."%");

		//Total Costing內容
		$pdf->Table_cost("Total Costing", number_format($of['tt_cost'],2,'.',''));

		$pdf->ln();
		//Technical / Equipment Advisements:
		$pdf->SetFont('Arial','',8);	
		$pdf->cell(50,5,"Technical / Equipment Advisements:",0,0,'R');
		$pdf->cell(135,5,$of['tech'],0,0,'L');		
		
		$name=$of['num'].'_a.pdf';
$pdf->Output($name,'D');
break;	


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 92V offer view
#		case "offer_view":		job 92V offer view
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "offer_print_b":

		check_authority('062',"view");

	if (isset($PHP_ver))
	{
		$of = $offer->get(0,$PHP_of_num,$PHP_ver);  //取出該筆記錄
	}else{
		$of = $offer->get($PHP_id);  //取出該筆記錄
	}

		// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/offer/".$of['num'].".jpg")){
			$op['picture'] = "./offer/".$of['num'].".jpg";
		} else {
			$op['picture'] = "./images/graydot.jpg";
		}
		$of = $offer->create_item_pdf($of);

//---------------------------------- 資料庫作業結束 ------------------------------


include_once($config['root_dir']."/lib/class.pdf_offer_a.php");

$print_title = "OFFER";

$print_title2 = "VER.".$of['ver']."  on  ".$of['k_date'];
$PHP_id = $of['num'];
//$creat=$user->get(0,$of['merchan']);
//	if ($creat['name'])$of['merchan'] = $creat['name'];

$creator = $of['merchan'];

$pdf=new PDF_offer_a();
$pdf->SetAutoPageBreak("on");
$pdf->AliasNbPages(); 
$pdf->AddBig5Font();
$pdf->Open();
$pdf->AddPage();

$pdf->SetFont('Arial','B',14);
// [表匡] 訂單基本資料
$pdf->hend_title($of);

		$Y = $pdf->getY();
		
		$img_size = GetImageSize($op['picture']);
		
		if ($img_size[0] > $img_size[1])
		{
			$pdf->Image($op['picture'],10,28,40,0);
		}else{
			$pdf->Image($op['picture'],10,28,0,40);
		}
		
		$pdf->ln();
		$Y = $pdf->getY();
		$X = $pdf->getX();
		$pdf->setXY(10,$Y+5);
		$pdf->descript('Style Description : ',$of['des']);
		$pdf->descript('Fabrication : ',$of['fab']);
		$pdf->descript('Fab. Consump. : ',$of['cons']);
		$pdf->ln();
		$pdf->Cell(185,5,"---------- unit cost ----------",0,0,'C');
		$pdf->ln();
		$pdf->Table_title(); //Unit Cost的Title
		
		$pdf->Table_cost_a($of['fab_cat']); //主料
		$pdf->Table_cost_a($of['fus_cat']);	//fusible
		$pdf->Table_cost_a($of['inter_cat']); //interling
		$pdf->Table_cost_a($of['acc_cat']);		//accessory
		$pdf->Table_cost_a($of['oth_cat']);		//other

		//CM-TP內容 (CM與mark-up合併)
		$pdf->Table_cost("CMTP", number_format($of['cmtp'],2,'.',''));

		//Total Costing內容
		$pdf->Table_cost("Total Costing", number_format($of['tt_cost'],2,'.',''));

		$pdf->ln();
		//Technical / Equipment Advisements:
		$pdf->SetFont('Arial','',8);	
		$pdf->cell(50,5,"Technical / Equipment Advisements:",0,0,'R');
		$pdf->cell(135,5,$of['tech'],0,0,'L');		
		
		$name=$of['num'].'_b.pdf';
$pdf->Output($name,'D');
break;	


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 92V offer view
#		case "offer_view":		job 92V offer view
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "offer_print_c":

		check_authority('062',"view");

	if (isset($PHP_ver))
	{
		$of = $offer->get(0,$PHP_of_num,$PHP_ver);  //取出該筆記錄
	}else{
		$of = $offer->get($PHP_id);  //取出該筆記錄
	}

		// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/offer/".$of['num'].".jpg")){
			$op['picture'] = "./offer/".$of['num'].".jpg";
		} else {
			$op['picture'] = "./images/graydot.jpg";
		}
		$of = $offer->create_item_pdf($of);

//---------------------------------- 資料庫作業結束 ------------------------------


include_once($config['root_dir']."/lib/class.pdf_offer_a.php");

$print_title = "OFFER";

$print_title2 = "VER.".$of['ver']."  on  ".$of['k_date'];
$PHP_id = $of['num'];
//$creat=$user->get(0,$of['merchan']);
//	if ($creat['name'])$of['merchan'] = $creat['name'];

$creator = $of['merchan'];

$pdf=new PDF_offer_a();
$pdf->AliasNbPages(); 
$pdf->AddBig5Font();
$pdf->Open();
$pdf->AddPage();
$pdf->SetAutoPageBreak("on");
$pdf->SetFont('Arial','B',14);
// [表匡] 訂單基本資料
$pdf->hend_title($of);

		$Y = $pdf->getY();
		
		$img_size = GetImageSize($op['picture']);
		
		if ($img_size[0] > $img_size[1])
		{
			$pdf->Image($op['picture'],10,28,40,0);
		}else{
			$pdf->Image($op['picture'],10,28,0,40);
		}
		
		$pdf->ln();
		$Y = $pdf->getY();
		$X = $pdf->getX();
		$pdf->setXY(10,$Y+5);
		$pdf->descript('Style Description : ',$of['des']);
		$pdf->descript('Fabrication : ',$of['fab']);
		$pdf->descript('Fab. Consump. : ',$of['cons']);
		$pdf->ln();
		$pdf->Cell(185,5,"---------- unit cost ----------",0,0,'C');
		$pdf->ln();

		//Total Costing內容
		$pdf->Table_cost("Total Costing", number_format($of['tt_cost'],2,'.',''));

		$pdf->ln();
		//Technical / Equipment Advisements:
		$pdf->SetFont('Arial','',8);	
		$pdf->cell(50,5,"Technical / Equipment Advisements:",0,0,'R');
		$pdf->cell(135,5,$of['tech'],0,0,'L');		
		
		$name=$of['num'].'_b.pdf';
$pdf->Output($name,'D');
break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 92V offer view
#		case "offer_view":		job 92V offer view
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "offer_to_order":

		check_authority('065',"add");

		$of = $offer->get($PHP_id);  //取出該筆記錄
		// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/offer/".$of['num'].".jpg")){
			$op['order']['pic'] = "./offer/".$of['num'].".jpg";
		} else {
			$op['order']['pic'] = "./images/graydot.jpg";
		}
		$of = $offer->create_items($of);
		
		//訂單資料整理

		// 取出年碼...
		$dt = decode_date(1);
		$year_code = substr($dt['year'],-1);
		
//*****//2006.12.08	修改sample為下拉式 start
		$s_date=increceDaysInDate($TODAY,-1200); //12個月前
		$where="where last_update > '".$s_date."' and cust='".$of['buyer']."'  order by num";
		
		$smpl_no=$smpl_ord->get_fields("num",$where);		
	    $j=0;
	    if ($smpl_no){
		$sml_no[0]=substr($smpl_no[0],0,9);
		for($i=1;$i< sizeof($smpl_no); $i++)
		{
			if($sml_no[$j] != substr($smpl_no[$i],0,9)){	
				$j++;
				$sml_no[$j]=substr($smpl_no[$i],0,9);
			}
		}
		}else{
			$sml_no=array('');
		}
		$op['smpl_no']=$arry2->select($sml_no,'','PHP_smpl_ord','select','');
//*****//2006.12.08	修改sample為下拉式	end

		$where_str="ORDER BY cust_s_name"; //依cust_s_name排序
		$cust_def = $cust->get_fields('cust_init_name',$where_str);
		$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
		for ($i=0; $i< sizeof($cust_def); $i++)
		{
			$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
		}
		$op['agent_select'] =  $arry2->select($cust_value,$of['agent'],'PHP_agent','select','',$cust_def_vue); 

		// creat style type combo box
		$style_def = $style_type->get_fields('style_type');   // 取出 款式類別
//		$op['style'] =  $arry2->select($style_def,'','PHP_style','select','');  	
		// creat apparel unit combo box
		$op['unit'] = $arry2->select($APPAREL_UNIT,'pc','PHP_unit','select','');  	

		// creat factory combo box
		if (substr($of['dept'],0,1)=='H'){//判斷進入者的部門是否代表工廠			
			$op['factory'] = "HJ";
			$op['fac_flag']=1;	
		}elseif (substr($of['dept'],0,1)=='L'){		
			$op['factory'] = "LY";
			$op['fac_flag']=1;			
		}else{
			$op['factory'] = $arry2->select($FACTORY,$of['fty'],'PHP_factory','select',''); 	
		}  


		// pre  訂單編號....
		$op['order_precode'] = substr($of['dept'],1,1).$of['buyer'].$year_code."-xxx";
		if ($of['dept']=="HJ" || $of['dept']=="LY")		$op['order_precode'] = substr($of['dept'],0,1).$of['buyer'].$year_code."-xxx";
		// 2005/07/30 加入 由 menu進入新增後的 back page 只向 全部列表
		$op['back_str'] = "/yankee/index2.php?PHP_action=order_search&PHP_sr_startno=0&PHP_dept_code=&PHP_order_num=&PHP_cust=&PHP_ref=&PHP_factory=";

		$op['cust_id'] = $of['buyer'];
		$op['dept_id'] = $of['dept'];
		$op['order']['ref'] = $of['style'];
		$op['order']['uprice'] = $of['tt_cost'];
		$op['order']['mat_useage'] =0;
		$op['order']['mat_u_cost'] =0;
		$op['order']['interline'] =0;
		$op['order']['fusible'] =0;
		$op['order']['acc_u_cost'] =0;
		for ($i=0; $i<sizeof($of['fab_cat']); $i++)
		{
			$op['order']['mat_useage'] += $of['fab_cat'][$i]['fq'];
			$op['order']['mat_u_cost'] += $of['fab_cat'][$i]['fc'];
		}
		$op['order']['mat_u_cost'] = $op['order']['mat_u_cost'] / $op['order']['mat_useage'];
		for ($i=0; $i<sizeof($of['inter_cat']); $i++)
		{
			$op['order']['interline'] += $of['inter_cat'][$i]['ic'];
		}
		for ($i=0; $i<sizeof($of['fus_cat']); $i++)
		{
			$op['order']['fusible'] += $of['fus_cat'][$i]['fsc'];
		}
		for ($i=0; $i<sizeof($of['acc_cat']); $i++)
		{
			$op['order']['acc_u_cost'] += $of['acc_cat'][$i]['ac'];
		}		
		$op['order']['quota_fee']=$of['quota'];
		$op['order']['comm_fee']= $of['tt_cost'] * ($of['comm']/100);
		$op['order']['cm']= $of['cm'];
		$op['order']['oth'] = 0;
		$op['order']['oth_treat'] ='';
		for ($i=0; $i<sizeof($of['oth_cat']); $i++)
		{
			if ($of['oth_cat'][$i]['oi'] == 'embroidery' )
			{
				$op['order']['emb'] = $of['oth_cat'][$i]['oc'];
			}else if($of['oth_cat'][$i]['oi'] == 'garment wash'){
				$op['order']['wash'] = $of['oth_cat'][$i]['oc'];
			}else{
				$op['order']['oth'] += $of['oth_cat'][$i]['oc'];
				$op['order']['oth_treat'].=$of['oth_cat'][$i]['oi'].",";				
			}
		}	
		$op['order']['oth_treat'] =substr($op['order']['oth_treat'],0,-1);
		$op['offer'] = $of['num'];
		page_display($op,'065', $TPL_ORDER_ADD);	
break;

















#++++++++++++++    SAMPLE ORDER +++++++++++++  2006/09/04  +++++++++++++++++
#		 job 20    樣本系統 
#++++++++++++++++++++++++++++++++++++++++++++  2006/10/09  +++++++++++++++++
#		case "smpl_ord":	job 21
#		case "smpl_ord_add":
#		case "do_smpl_ord_add":
#		case "smpl_follow_order":
#		case "do_smpl_ord_follow":
#		case "smpl_ord_edit":
#		case "do_smpl_ord_edit":
#		case "smpl_ord_search":
#		case "smpl_ord_view":
#		case "smpl_ord_del":	刪除樣本單(2007/03/19)
#		case "smpl_ord_sumb": 	核可樣本單(2009/03/19)
#		case "do_smpl_logs_add":       樣本 logs 寫入  (分類)
#		case "smpl_supplier":	job 22
#		case "smpl_supplier_search":
#		case "smpl_supplier_view":
#		case "smpl_wi_rcvd":
#		case "smpl_wi_back":	抹去 原來 W/I 收到的記錄 (只限當天可改)
#		case "smpl_pttn_rcvd":
#		case "smpl_pttn_back":	抹去 原來 pattern 收到的記錄 (只限當天可改)
#		case "smpl_fab_rcvd":
#		case "smpl_fab_back":	抹去 原來 fabric 收到的記錄 (只限當天可改)
#		case "smpl_acc_rcvd":
#		case "smpl_acc_back":	抹去 原來 fabric 收到的記錄 (只限當天可改)
#		case "smpl_schedule":	job 23 樣本排產 [ pattern, Sample ]
#		case "smpl_schedule_search"
#		case "smpl_schedule_view":
#		case "smpl_pttn_schd":
#		case "smpl_smpl_schd":
#		case "smpl_output":		job 24
#		case "smpl_output_search":
#		case "smpl_output_view":
#		case "upload_smpl_pattern":
#		case "upload_smpl_marker":
#		case "smpl_pttn_download":
#		case "smpl_marker_download":
#		case "smpl_complete":
#		case "smpl_case_close":
#		case "pttn_resend":
#		case "marker_resend":
#		case "smpl_SPT":
#
#
#
#
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "smpl_ord":	job 21
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "smpl_ord":
check_authority("008","view");

$op['dept_select'] = $arry2->select(get_dept_group(),"","PHP_dept_code","select","get_dept(this)"); 

// 取出 客戶代號
$where_str ='';
$where_str = $where_str."order by cust_s_name"; //依cust_s_name排序
if(!$cust_def = $cust->get_fields('cust_init_name',$where_str)){;  //取出客戶簡稱
    $op['msg'][] = "sorry! there is no any customer record in your team, please add customer first!";
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}

$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
for ( $i=0; $i< sizeof($cust_def); $i++ ) {
    $cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
}

$op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','check_add(this)',$cust_def_vue); 
$op['cust_select2'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue); 

// ------ 決定 factory 的參數 = 陣列? 數值?  RD人員進入時有差別 ----
if($S = $smpl_ord->is_sample_team($user_team)){
    $op['factory'] = $user_team."<input type='hidden' name='PHP_factory' value='".$user_team."'>";
}else{
    $op['factory'] = $arry2->select($SAMPLER,'','PHP_factory','select','');  	
}

if($user_team=="RD"){
    $op['factory'] = $user_dept."<input type='hidden' name='PHP_factory' value='".$user_dept."'>";
}
// --------------------------------------------------------------------
$smpl_def = $smpl_type->get_fields('smpl_type');   // 取出 款式類別
$op['smpl_type'] =  $arry2->select($smpl_def,'','SCH_smpl_type','select','');  

$op['msg'] = $order->msg->get(2);

//080725message增加		
$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
$op['max_notify'] = $note['max_no'];		

page_display($op, "008", $TPL_SMPL_ORD);			
break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 21A     SMPL ORDER record add
#		case "smpl_ord_add":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "smpl_ord_add":
check_authority("008","add");

$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];
$dept_id = $GLOBALS['SCACHE']['ADMIN']['dept'];
$user_team = $GLOBALS['SCACHE']['ADMIN']['team_id'];
$where_str ='';

if (!$PHP_dept_code) {   // 如果沒有先選部門別時.....[ 只可能是 manager 登入 ]
	if (!$PHP_cust) {    // 如果也沒有先選部門客戶時
		$op['msg'][] = "sorry! please select the <b>customer</b> and <b>Team</b>!";
	} else {
		$op['msg'][] = "sorry! please select the working <b>Team</b> !";
	}
		$op['manager_flag'] = 1;
	$sales_dept_ary = get_sales_dept(); // 取出 業務的部門 [不含K0] ------
	//業務部門 select選單
	$op['dept_ary'] = $arry2->select($sales_dept_ary,$GLOBALS['SCACHE']['ADMIN']['dept'],"PHP_dept_code","select","");

	$where_str=$where_str."order by cust_s_name";
if(!$cust_def = $cust->get_fields('cust_init_name',$where_str)){
	$op['msg'][] = "sorry! there is no any customer record in your team, please add customer first!";
	$layout->assign($op);
	$layout->display($TPL_ERROR);
	break;
}
if(!$cust_def_vue = $cust->get_fields('cust_s_name',$where_str)){;  
	$op['msg'][] = "sorry! there is no any customer record in your team, please add customer first!";
	$layout->assign($op);
	$layout->display($TPL_ERROR);
	break;
}

for ($i=0; $i< sizeof($cust_def); $i++){
	$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];
}

$op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue);
	// creat factory combo box
	$op['factory'] = $arry2->select($SAMPLER,'','PHP_factory','select','');  	
	if($user_team=="RD"){
		$op['factory'] = $user_dept."<input type='hidden' name='PHP_factory' value='".$user_dept."'>";
	}
	page_display($op, "008", $TPL_SMPL_ORD);			
	break;

}  // end if (!$PHP_dept_code).................. 

// 先用輸入之部門別找尋客戶資料 查看是否有客戶資料屬於這個部門
$where_str =" WHERE dept ='$PHP_dept_code' ";
$where_str=$where_str."order by cust_s_name";
$cust_def = $cust->get_fields('cust_init_name',$where_str);   // 取出 客戶代號
$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);
for ($i=0; $i< sizeof($cust_def); $i++)
{
	$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];
}
if (count($cust_def) == 0){  // 當找不到客戶資料時......
	$op['msg'][] = "sorry! selected department doesn't have any customer record yet, please add customer for this Team first !";
	 $layout->assign($op);
	 $layout->display($TPL_ERROR);		    	    
		break;
} else {

    if (!$PHP_cust) {	//有部門別 無選擇客人/且部門有客人資料時[不一定是manager進入]
     
        // creat cust combo box
        sort($cust_def);
        $op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue);

        $op['msg'][] = "sorry! please select your customer !";
        $op['dept_id'] = $PHP_dept_code;

        // creat factory combo box
            $op['factory'] = $arry2->select($SAMPLER,'','PHP_factory','select','');
        if($user_team=="RD") {
            $op['factory'] = $user_dept."<input type='hidden' name='PHP_factory' value='".$user_dept."'>";
        }
        
        page_display($op, "008", $TPL_SMPL_ORD);
        break;

    } // end if (!$PHP_cust).................. 
    
} // endif (count($cust_def) == 0)

// dept 及 cust 皆有輸入時 ................
$where_str = " WHERE (cust_s_name='".$PHP_cust."' AND dept='".$PHP_dept_code."') ";
$s1 = $cust->search(0,$where_str);  // 查看選定客戶及 部門是否有衝突...........

if ($s1['record_NONE']) {
	$op['msg'][] = "sorry! the selected custormer is not belongs to your dept.。";
	$op['dept_id'] = $PHP_dept_code;

	// creat cust combo box
	$where_str =" WHERE dept ='$PHP_dept_code' ";
	$where_str=$where_str."order by cust_s_name";
	$cust_def = $cust->get_fields('cust_init_name',$where_str);   // 取出 客戶代號
	$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);   // 取出 客戶代號
	for ($i=0; $i< sizeof($cust_def); $i++)
	{
		$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];
	}
	$op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue);

	// creat factory combo box
	$op['factory'] = $arry2->select($SAMPLER,'','PHP_factory','select','');

	page_display($op, "008", $TPL_SMPL_ORD);
	break;
}

// 當部門及客戶不配合時結束[輸入選擇 皆正確時]
$op['msg']= $order->msg->get(2);
$op['cust_id'] = $PHP_cust;

// 取出年碼...
$dt = decode_date(1);
$year_code = substr($dt['year'],-1);

// creat ETD, FETA, AETA, PETA date combo box
// 預設 customer pattern support為 yes
$op['order']['pttn_suppt'] = 1;

// creat factory combo box
$op['factory'] = $arry2->select($SAMPLER,'','PHP_factory','select','');
// creat style type combo box
$style_def = $style_type->get_fields('style_type');   // 取出 款式類別
$op['style_type'] =  $arry2->select($style_def,'','PHP_style_type','select','');
// creat apparel unit combo box
$op['unit'] = $arry2->select($APPAREL_UNIT,'','PHP_unit','select','');

// creat STYLE CAT. combo box
$op['style_cat'] = $arry2->select($STYLE_CAT,'','PHP_style_cat','select','');
// creat SMPL TYPE combo box
$smpl_def = $smpl_type->get_fields('smpl_type');   // 取出 款式類別
$op['smpl_type'] =  $arry2->select($smpl_def,'','PHP_smpl_type','select','');

// 取出選項資料 及傳入之參數
$op['dept_id']	 = $PHP_dept_code;
// pre  訂單編號....
$op['order_precode'] = "S".$year_code.$PHP_cust."xxxx-X";

page_display($op, "008", $TPL_SMPL_ORD_ADD);
break;



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# case "do_smpl_ord_add":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "do_smpl_ord_add":
check_authority("008","add");

# 設定權限
$encoded = 0;
foreach($SMPL_TYPE as $key => $val){
	if( !empty($_POST['PHP_smpl_stype'][$key]) ){
		$encoded = $encoded | $val;
	}
}

// 取出年碼... 以輸入時之年為年碼[兩位]
$dt = decode_date(1);
$year_code = substr($dt['year'],-1);

$parm = array(
	"dept"			=>	$PHP_dept,
	"cust"			=>	$PHP_cust,
	"ref"			=>	$PHP_ref,
	"factory"		=>	$PHP_factory,
	"style_type"	=>	$PHP_style_type,
	"qty"			=>	$PHP_rq + $PHP_backup,
	"rq"			=>	$PHP_rq,
	"backup"		=>	$PHP_backup,
	"unit"			=>	$PHP_unit,
	"smpl_type"		=>	$PHP_smpl_type,
	"style_cat"		=>	$PHP_style_cat,
	"orders"		=>	"",
	"pic"			=>	$PHP_pic,
	"pic_upload"	=>	$PHP_pic_upload,					
	"pttn_suppt"	=>	$PHP_pttn_suppt,
	"etd"			=>	$PHP_etd,
	"feta"			=>	$PHP_feta,
	"aeta"			=>	$PHP_aeta,
	"peta"			=>	$PHP_peta,
	"creator"		=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
	"open_date"		=>	$dt['date'],
	"updator"		=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
	"last_update"	=>	$dt['date'],
	"smpl_code"		=>	$encoded,
	"ie"		    =>	$PHP_ie,
	"des"			=>	$PHP_des,
	"spt"			=>	$PHP_spt
);

$parm['fab_substu'] = (isset($PHP_fab_substu)) ? $PHP_fab_substu : '';
$parm['acc_substu'] = (isset($PHP_acc_substu)) ? $PHP_acc_substu : '';
		
// check 輸入資料之正確	------------------------	
$op['smpl_ord'] = $parm;

if (!$f1 = $smpl_ord->check($parm)) {  // 輸入資料 不正確時
	
	$op['msg'] = $smpl_ord->msg->get(2);

	// 列出 新增 訂單的視窗 ---------------------------------------------
	$op['cust_id'] = $PHP_cust;
	$op['dept_id'] = $PHP_dept;

	$op['msg']= $smpl_ord->msg->get(2);
	
	// creat factory combo box
	$op['factory'] = $arry2->select($SAMPLER,$parm['factory'],'PHP_factory','select','');
	
	// creat style type combo box
	$style_def = $style_type->get_fields('style_type');   // 取出 款式類別
	$op['style_type'] =  $arry2->select($style_def,$parm['style_type'],'PHP_style_type','select','');
	
	// creat apparel unit combo box
	$op['unit'] = $arry2->select($APPAREL_UNIT,$parm['unit'],'PHP_unit','select','');  	

	// creat STYLE CAT. combo box
	$op['style_cat'] = $arry2->select($STYLE_CAT,$parm['style_cat'],'PHP_style_cat','select','');
	
	// creat SMPL TYPE combo box
	// $op['smpl_type'] = $arry2->select($SMPL_TYPE,'','PHP_smpl_type','select','');
	
	$smpl_def = $smpl_type->get_fields('smpl_type');   // 取出 款式類別
	$op['smpl_type'] =  $arry2->select($smpl_def,$parm['smpl_type'],'PHP_smpl_type','select','');  	

	// 取出選項資料 及傳入之參數
	$op['dept_id']	 = $PHP_dept;
	
	// pre  訂單編號....
	$op['order_precode'] = "S".$year_code.$PHP_cust."xxxx-X";
	
	if(isset($PHP_num)) $parm['num'] = $PHP_num;
	$op['order'] = $parm;
	$op['order']['des'] = $_POST['PHP_des'];

	foreach($SMPL_TYPE as $key => $val){
		if( !empty($_POST['PHP_smpl_stype'][$key]) ){
			$op['order']['stype'][$key] = 1;
		}
	}
	
	if(isset($PHP_num))
	{
		page_display($op, "008", $TPL_SMPL_ORD_FOLLOW);
	}else{
		page_display($op, "008", $TPL_SMPL_ORD_ADD);			
	}
	break;
	
} // end check [ 資料輸入正確時 ]
		
//  編製 訂 單 號碼 也同時更新dept檔內的num值[csv]
if(isset($PHP_num))
{
	$parm['num'] = $PHP_num;
} else {
	$smpl_serious = $dept->get_smpl_num($year_code, $PHP_cust);  
	$parm['num'] = $smpl_serious."-1";  
}

//------------------ add to DB ie
$f1 = $smpl_ord->add($parm);

if (!$f1) {  // 沒有成功寫入資料庫時
	$op['msg'] = $smpl_ord->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}
// end if (!$F1)--------- 成功輸入 ---------------------------------

$message = " Append New SAMPLE order: [".$parm['num']."]";
$log->log_add(0,"008A",$message);
$redir_str = "index2.php?PHP_action=smpl_ord_view&PHP_id=".$f1."&PHP_msg=".$message;
redirect_page($redir_str);


		
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "smpl_follow_order":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "smpl_follow_order":

		check_authority("008","add");

		$parm = $smpl_ord->get($PHP_id);
		if (!$parm) {
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		// 列出 新增 訂單的視窗 ---------------------------------------------
			$op['cust_id'] = $parm['cust'];
			$op['dept_id'] = $parm['dept'];

		// 新訂單號碼 -----------------------------------------start
			$body = substr($parm['num'],0,10);
		//  取出最大 訂單延伸碼  ... 設定 新訂單號碼
		$orderA = $smpl_ord->get_order_like($body);
		if (!$orderA) {
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		sort($orderA);
		$code = substr($orderA[count($orderA)-1]['num'],10) + 1;
		$new_num = $body."$code";
		// 新訂單號碼 -----------------------------------------end

			$op['msg']= $smpl_ord->msg->get(2);
	
		// creat factory combo box
		$op['factory'] = $arry2->select($SAMPLER,$parm['factory'],'PHP_factory','select','');  	
		// creat style type combo box
		$style_def = $style_type->get_fields('style_type');   // 取出 款式類別
		$op['style_type'] =  $arry2->select($style_def,$parm['style'],'PHP_style_type','select','');  	
		// creat unit combo box
		$op['unit'] = $arry2->select($APPAREL_UNIT,$parm['unit'],'PHP_unit','select','');  	

		// creat STYLE CAT. combo box
		$op['style_cat'] = $arry2->select($STYLE_CAT,'','PHP_style_cat','select','');  	
		// creat SMPL TYPE combo box
		$smpl_def = $smpl_type->get_fields('smpl_type');   // 取出 款式類別
		$op['smpl_type'] =  $arry2->select($smpl_def,'','PHP_smpl_type','select','');  	

		// 取出選項資料 及傳入之參數
		$op['dept_id']	 = $parm['dept'];
		// pre  訂單編號....
		$op['order_precode'] = $new_num;

		$op['order'] = $parm;
		$op['order']['num'] = $new_num;
		$op['order']['pttn_suppt'] = '1';
		$op['order']['fab_substu'] = '';
		$op['order']['acc_substu'] = '';
		$op['order']['rq'] = '';
		$op['order']['backup'] = '';


		page_display($op, "008", $TPL_SMPL_ORD_FOLLOW);			
		break;



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# case "smpl_ord_edit":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "smpl_ord_edit":
check_authority("008","edit");

$parm = $smpl_ord->get($PHP_id);
if (!$parm) {
	$op['msg'] = $smpl_ord->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}

// 列出 新增 訂單的視窗 ---------------------------------------------
$op['cust_id'] = $PHP_cust;

//如果是 copy sample order 的話，讓業務能修改客戶
if($PHP_copy_flag){
	$op['PHP_copy_flag'] = 1;
	$where_str="order by cust_s_name";
	$cust_def = $cust->get_fields('cust_init_name',$where_str);
	$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);
	for ($i=0; $i< sizeof($cust_def); $i++)	$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];
	
	$op['cust_id'] =  $arry2->select($cust_value,$PHP_cust,'PHP_cust','select',"change_cust()",$cust_def_vue);
}

$op['msg']= $smpl_ord->msg->get(2);
if($PHP_msg) $op['msg'][]=$PHP_msg;

// 檢查 相片是否存在
if(file_exists($GLOBALS['config']['root_dir']."/smpl_pic/".$parm['num'].".jpg")){
	$op['main_pic'] = "./smpl_pic/".$parm['num'].".jpg";
} else {
	$op['main_pic'] = "./images/graydot.gif";
}

// creat factory combo box
$op['factory'] = $arry2->select($SAMPLER,$parm['factory'],'PHP_factory','select','');  	

// creat style type combo box
$style_def = $style_type->get_fields('style_type');   // 取出 款式類別
$op['style_type'] =  $arry2->select($style_def,$parm['style'],'PHP_style_type','select','');  	
// creat apparel unit combo box
$op['unit'] = $arry2->select($APPAREL_UNIT,$parm['unit'],'PHP_unit','select','');  	

// creat STYLE CAT. combo box
$op['style_cat'] = $arry2->select($STYLE_CAT,$parm['style_cat'],'PHP_style_cat','select','');  	

// creat SMPL TYPE combo box
$smpl_def = $smpl_type->get_fields('smpl_type');   // 取出 款式類別
$op['smpl_type'] =  $arry2->select($smpl_def,$parm['smpl_type'],'PHP_smpl_type','select','');  	

// 取出選項資料 及傳入之參數
$op['dept_id']	 = $PHP_dept;

$op['order'] = $parm;
$op['order']['smpl_code'] += 0;
foreach($SMPL_TYPE as $key => $val){
	$op['order']['stype'][$key] = ( !empty($op['order']['smpl_code']) && $op['order']['smpl_code'] & $val )? 1 : 0 ;
}

page_display($op, "008", $TPL_SMPL_ORD_EDIT);			
break;



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "do_smpl_ord_edit":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "do_smpl_ord_edit":
check_authority("008","edit");

// 取出年碼... 以輸入時之年為年碼[兩位]
$dt = decode_date(1);
$year_code = substr($dt['year'],-1);

$encoded = 0;
foreach($SMPL_TYPE as $key => $val){
	if( !empty($_POST['PHP_smpl_stype'][$key]) ){
		$encoded = $encoded | $val;
	}
}

$parm = array(
	"id"			=>	$PHP_id,
	"num"			=>	$PHP_num,
	"dept"			=>	$PHP_dept,
	"cust"			=>	$PHP_cust,
	"ref"			=>	$PHP_ref,
	"factory"		=>	$PHP_factory,
	"style_type"	=>	$PHP_style_type,
	"qty"			=>	$PHP_rq + $PHP_backup,
	"rq"			=>	$PHP_rq,
	"backup"		=>	$PHP_backup,
	"unit"			=>	$PHP_unit,
	"smpl_type"		=>	$PHP_smpl_type,
	"style_cat"		=>	$PHP_style_cat,

	"pic"			=>	$PHP_pic,
	"pic_upload"	=>	$PHP_pic_upload,
	"pttn_suppt"	=>	$PHP_pttn_suppt,
	"etd"			=>	$PHP_etd,
	"feta"			=>	$PHP_feta,
	"aeta"			=>	$PHP_aeta,
	"peta"			=>	$PHP_peta,
	"updator"		=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
	"last_update"	=>	$dt['date'],
	"smpl_code"		=>	$encoded,
	"des"			=>	$PHP_des
);

$parm['fab_substu'] = (isset($PHP_fab_substu)) ? $PHP_fab_substu : '';
$parm['acc_substu'] = (isset($PHP_acc_substu)) ? $PHP_acc_substu : '';

// check 輸入資料之正確	------------------------	
	$op['smpl_ord'] = $parm;

if (!$f1 = $smpl_ord->check($parm)) {  // 輸入資料 不正確時
	$op['msg'] = $smpl_ord->msg->get(2);

	// 列出 新增 訂單的視窗 ---------------------------------------------
	$op['cust_id'] = $PHP_cust;
	$op['dept_id'] = $PHP_dept;

	$op['msg']= $smpl_ord->msg->get(2);
	$op['main_pic']=$PHP_main_pic;
	// creat factory combo box
	$op['factory'] = $arry2->select($SAMPLER,$parm['factory'],'PHP_factory','select','');  	

	// creat style type combo box
	$style_def = $style_type->get_fields('style_type');   // 取出 款式類別
	$op['style_type'] =  $arry2->select($style_def,$parm['style_type'],'PHP_style_type','select','');  	

	// creat apparel unit combo box
	$op['unit'] = $arry2->select($APPAREL_UNIT,$parm['unit'],'PHP_unit','select','');  	

	// creat STYLE CAT. combo box
	$op['style_cat'] = $arry2->select($STYLE_CAT,$parm['style_cat'],'PHP_style_cat','select','');  	

	// creat SMPL TYPE combo box
	$smpl_def = $smpl_type->get_fields('smpl_type');   // 取出 款式類別
	$op['smpl_type'] =  $arry2->select($smpl_def,$parm['smpl_type'],'PHP_smpl_type','select','');  	

	// 取出選項資料 及傳入之參數
	$op['dept_id']	 = $PHP_dept;
	// pre  訂單編號....
	$op['order_precode'] = "S".$year_code.$PHP_cust."xxxx-X";

	$op['order'] = $parm;

	foreach($SMPL_TYPE as $key => $val){
		if( !empty($_POST['PHP_smpl_stype'][$key]) ){
			$op['order']['stype'][$key] = 1;
		}
	}
	
	page_display($op, "008", $TPL_SMPL_ORD_EDIT);			
	break;
}
// 輸入項正確後............after check input.........
// ========= add Eddition to DB =======
if (!$smpl_ord->edit($parm)) {
	$op['msg'] = $smpl_ord->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;	    
}

//如果copy sample時,業務有修改客戶時,重新修改樣品單號碼
if($PHP_num <> $PHP_new_num){
	$smpl_ord->update_field2("cust",$PHP_cust,"num = '".$PHP_num."'","smpl_ord");
	$smpl_ord->update_field2("num",$PHP_new_num,"num = '".$PHP_num."'","smpl_ord");
	$smpl_ord->update_field2("cust",$PHP_cust,"wi_num = '".$PHP_num."'","smpl_wi");
	$smpl_ord->update_field2("wi_num",$PHP_new_num,"wi_num = '".$PHP_num."'","smpl_wi");
	$smpl_ord->update_field2("smpl_code",$PHP_new_num,"smpl_code = '".$PHP_num."'","smpl_lots_use");
	$smpl_ord->update_field2("smpl_code",$PHP_new_num,"smpl_code = '".$PHP_num."'","smpl_acc_use");
}

$message = " update sample order:[".$PHP_new_num."]";
$log->log_add(0,"008E",$message);

$redir_str = "index2.php?PHP_action=smpl_ord_view&PHP_id=".$PHP_id."&PHP_msg=".$message;
redirect_page($redir_str);



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "smpl_ord_search":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "smpl_ord_search":

		check_authority("008","view");

		if (!isset($SCH_wi))		$SCH_wi	='';
		if (!isset($SCH_close))	$SCH_close	='';
		if (!isset($SCH_pend))	$SCH_pend	='';

		if(isset($PHP_num))
		{
			
			$sch_parm = array();
			$sch_parm = array(	"PHP_dept_code"		=>  $PHP_dept_code,
													"PHP_num"					=>  $PHP_num,
													"PHP_cust"				=>	$PHP_cust,
													"PHP_ref"					=>	$PHP_ref,
													"PHP_factory"			=>	$PHP_factory,
													"PHP_op_str"			=>	$PHP_op_str,
													"PHP_op_fsh"			=>	$PHP_op_fsh,
													'SCH_wi'					=>	$SCH_wi,
													'SCH_close'				=>	$SCH_close,
													'SCH_pend'        =>	$SCH_pend,
													"PHP_sr_startno"	=>	$PHP_sr_startno,
													'SCH_smpl_type'		=>	$SCH_smpl_type,
													"PHP_action"			=>	$PHP_action												
				);			

			}else{
				if(isset($PHP_sr_startno))$sch_parm['PHP_sr_startno'] = $PHP_sr_startno;
			}

		

		// ---- 利用PHP_dept_code判定是否 業務部門進入
		if (!$op = $smpl_ord->search(1, $sch_parm['PHP_dept_code'])) {  
			$op['msg']= $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
				// 檢查 相片是否存在 2007.03.23

	for ($i=0; $i < sizeof($op['sorder']); $i++)
	{
		if(file_exists($GLOBALS['config']['root_dir']."/smpl_pic/s_".$op['sorder'][$i]['num'].".jpg")){
			$op['sorder'][$i]['main_pic'] = "./smpl_pic/s_".$op['sorder'][$i]['num'].".jpg";
		} else {
			$op['sorder'][$i]['main_pic'] = "./images/graydot.gif";
		}
		$img_size = GetImageSize($op['sorder'][$i]['main_pic']);
		if ($img_size[0] < $img_size[1]) $op['sorder'][$i]['height'] = 1;

	}
		// ---- 如果 不是 呈辦業務部門進入時...
		if (!$sch_parm['PHP_dept_code']) {   
			$op['manager_flag'] = 1;
		}

		$op['dept_id'] = $sch_parm['PHP_dept_code'];

		$op['msg']= $smpl_ord->msg->get(2);
		$op['cgi']= $parm;
		if(isset($PHP_msg)) $op['msg'][] = $PHP_msg;
		page_display($op, "008", $TPL_SMPL_ORD_LIST);			
		break;

		
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "smpl_ord_del": add on 20070319
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "smpl_ord_del":

		check_authority("008","edit");

		$f1=$smpl_ord->del($PHP_id);

		$redir_str = "index2.php?PHP_action=smpl_ord_search";
		redirect_page($redir_str);
		
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "smpl_ord_del_full": add on 20070319
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "smpl_ord_del_full":

		check_authority("008","del");

		$smpl_ord->del($PHP_id);  	    		// 刪除 樣單主檔
		$smpl_output->del($PHP_num);   		  // 刪除 樣單output檔
		$smpl_wi->del($PHP_wi_id); 			    // 刪除 wi 主檔資料 
		$smpl_wiqty->del($PHP_wi_id,'1');		// 刪除 wi qty 數量檔資料			
		$smpl_ti->del($PHP_wi_id,'1');      // 刪除 TI 說明檔資料
		
		$message = "Success Delete sample : [".$PHP_num."]";
		$log->log_add(0,"21D",$message);
		$redir_str = "index2.php?PHP_action=smpl_ord_search";
		redirect_page($redir_str);
		


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 21V sample oreder submit [add by 2007 03 19]
#		case "smpl_ord_sumb":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "smpl_ord_sumb":
check_authority("008","view");

$f1	=	$smpl_ord->update_status($PHP_id,'0');

$up_parm = array (	'field_name'	=>	'submit_date',
										'field_value'	=>	$TODAY,
										'id'					=>	$PHP_id
										);
$f1 = $smpl_ord->update_field($up_parm);

$redir_str = "index2.php?PHP_action=smpl_ord_view&PHP_id=".$PHP_id;
redirect_page($redir_str);


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 21V sample oreder submit [add by 2007 03 19]
#		case "do_smpl_etd_edit":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "do_smpl_etd_edit":

		check_authority("008","view");

		if($PHP_etd < date('Y-m-d'))		
		{
			$message = "your submit ETD date is due !!";
		}else{
		
			$up_parm = array (	'field_name'	=>	'etd',
													'field_value'	=>	$PHP_etd,
													'id'					=>	$PHP_id
													);
			$f1 = $smpl_ord->update_field($up_parm);
			if($PHP_wi_id)
			{
				$up_parm = array($PHP_wi_id, 'etd', $PHP_etd);
				$f1 = $smpl_wi->update_field($up_parm);
			}	
			$message = "Success UPDATE sample  etd : [".$PHP_num."]";
			$log->log_add(0,"21D",$message);
		}

	
		$redir_str = "index2.php?PHP_action=smpl_ord_view&PHP_id=".$PHP_id."&PHP_msg=".$message;
		redirect_page($redir_str);


	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 21V sample oreder view
#		case "smpl_ord_view":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "smpl_ord_view":
check_authority("008","view");

$op['order'] = $smpl_ord->get($PHP_id);  //取出該筆記錄

if (!$op['order']) {
	$op['msg'] = $order->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}

$op['order']['stype'] =  '';
$op['order']['smpl_code'] += 0;
foreach($SMPL_TYPE as $key => $val){
	$op['order']['stype'] .= ( !empty($op['order']['smpl_code']) && $op['order']['smpl_code'] & $val )? $key.' , ' : '' ;
}

// 檢查 相片是否存在
if(file_exists($GLOBALS['config']['root_dir']."/smpl_pic/".$op['order']['num'].".jpg")){
	$op['main_pic'] = "./smpl_pic/".$op['order']['num'].".jpg";
} else {
	$op['main_pic'] = "./images/graydot.gif";
}

// 取出 smpl_log 本訂單 之歷史50筆的計記錄  -------------------
$logs = $smpl_log->search50($op['order']['num']);  //取出該訂單全部log記錄
if (!$logs){
	$op['msg'] = $smpl_log->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}

$smpl=substr($op['order']['num'],0,9);
if (!$op['ord_link']= $order->smpl_search($smpl))
{
	$op['ord_link_non']=1;
}

//取出 sample Reference
if($op['order']['smpl_ref'])
	$op['smpl_ref'] = $smpl_ord->get_fieldvalue('', "*", $op['order']['smpl_ref']);

$op['logs'] = $logs['log'];
$op['log_records'] = $logs['records'];

// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來判斷有無資料
//--------------------------------

$parm = $op['order'];
$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];

if (substr($user_dept,0,1)=="H" || substr($user_dept,0,1)=="L")  //判斷使用者部門是否為工廠
{                                                                //以分隔修改等權限
	if ($user_dept == $op['order']['dept'])$op['dept_edit']=1;
	if ($user_dept =="H0" && substr($op['order']['dept'],0,1)=="H")$op['dept_edit']=1;
	if ($user_dept =="L0" && substr($op['order']['dept'],0,1)=="L")$op['dept_edit']=1;			
} else {
	$op['dept_edit']=1;
}

// 加入返回前頁 --------------
$img_size = GetImageSize($op['main_pic']);
if ($img_size[0] < $img_size[1]) $op['height'] = 1;

// creat LOG SUBJ combo box
$op['logs_subj'] = $arry2->select($SMPL_LOG_SUBJ,'','PHP_subj','select','');  	

//取出copy此樣品單的相關聯樣品單
$op['copy_ref'] = $smpl_ord->get_fields_value("id, num, qty, etd, open_date", " smpl_ref = '".$op['order']['num']."'");

$op['msg'] = $smpl_ord->msg->get(2);
$op['search'] = '1';
$op['user_e']=$GLOBALS['SCACHE']['ADMIN']['name'];
if(isset($PHP_msg))$op['msg'][] = $PHP_msg;

page_display($op, "008", $TPL_SMPL_ORD_SHOW);			
break;



//-------------------------------------------------------------------------------------
//			 job 101X    訂單 記錄轉成 excel 檔
//-------------------------------------------------------------------------------------
	case "smpl_execk":

		if(!$admin->is_power("008","view") && !$admin->is_power("008","view")){  // 加入讓生企也能取excel檔 2006/0106
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		// ---- 利用PHP_dept_code判定是否 業務部門進入
		if (!$ord = $smpl_ord->search(1, $sch_parm['PHP_dept_code'],1000)) {  
			$op['msg']= $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$a = $ord['max_no'];

	
	require_once($config['root_dir']."/lib/spreadsheets/Worksheet.php");
	require_once($config['root_dir']."/lib/spreadsheets/Workbook.php");

	  function HeaderingExcel($filename) {
		  header("Content-type: application/vnd.ms-excel");
		  header("Content-Disposition: attachment; filename=$filename" );
		  header("Expires: 0");
		  header("Cache-Control: must-revalidate, post-check=0,pre-check=0");
		  header("Pragma: public");
		  }

	  // HTTP headers
	  HeaderingExcel('smpl_order.xls');
	 
	  // Creating a workbook
	  $workbook = new Workbook("-");

	  // Creating the first worksheet
	  $worksheet1 =& $workbook->add_worksheet('order list');

		$now = $GLOBALS['THIS_TIME'];

	// 寫入 title

	  // Format for the headings
	  $formatot =& $workbook->add_format();
	  $formatot->set_size(10);
	  $formatot->set_align('center');
	  $formatot->set_color('white');
	  $formatot->set_pattern();
	  $formatot->set_fg_color('navy');

	  $f2 =& $workbook->add_format();
	  $f2->set_size(10);
	  $f2->set_align('center');
	  $f2->set_color('navy');
	  $f2->set_pattern();
	  $f2->set_fg_color('white');
	  $ary = array(12,5,5,8,8,8,14,8,5,3,15,20,12,10,15,20,15,15,3,10,10,8,8,1,12,12,12,12,12,30,20);
	  for ($i=0; $i < 31; $i++)	$worksheet1->set_column(0,$i,$ary[$i]);

	  $worksheet1->write_string(0,1,"Sample Order List");
	  $worksheet1->write(0,3,$now);
	  $ary = array("Smpl order#","cust","dept.","smpl type","style #","style cat.","ETD","style type","IE","","cust. pattern ETA","cust. pattern receive",
	  				"W/I ETA","W/I receive","Factory ETA","Factory receive","Acc. ETA","Acc. received","unit","reuire q'ty","backup q'ty","Q'ty","finish Q'ty",
	  				"","Pattern-ETF","Pattern-done","Sample-ETF","Sample-done","sample apvd","ORDERS","status");
	  for ($i=0; $i < 31; $i++)	 $worksheet1->write_string(1,$i,$ary[$i],$formatot);

	  // Format for the numbers
	  $formatnum =& $workbook->add_format();
	  $formatnum->set_size(10);
	  $formatnum->set_align('center');
	  $formatnum->set_color('black');
	  $formatnum->set_fg_color('B8D7D8');

	for ($i=0;$i < sizeof($ord['sorder']);$i++){
			$smpl_init = substr($ord['sorder'][$i]['num'],0,-2);
			$ord['sorder'][$i]['orders'] = '';
			if(!isset($ord_str[$smpl_init]))
			{
				$ord_str[$smpl_init] = '';

				$ord_ary= $order->smpl_search($smpl_init);			
				for($x=0; $x<sizeof($ord_ary); $x++)$ord_str[$smpl_init] .= $ord_ary[$x]['order_num'].',';
				$ord_str[$smpl_init] = substr($ord_str[$smpl_init] ,0,-1);
			}
			$ord['sorder'][$i]['orders'] = $ord_str[$smpl_init];			
			if ($ord['sorder'][$i]['status'] == 0) { $status_des ="W/I expect.";
			}elseif($ord['sorder'][$i]['status'] == '1') { $status_des ="PTTN. expect";
			}elseif($ord['sorder'][$i]['status'] == '2') { $status_des ="FAB. expect";
			}elseif($ord['sorder'][$i]['status'] == '3') { $status_des ="ACC. expect";
			}elseif($ord['sorder'][$i]['status'] == '4') { $status_des ="PTTN schdle";
			}elseif($ord['sorder'][$i]['status'] == '5') { $status_des ="SMPL schdle";
			}elseif($ord['sorder'][$i]['status'] == '6') { $status_des ="DEVELOPING";
			}elseif($ord['sorder'][$i]['status'] == '7') { $status_des ="* PENDING *";
			}elseif($ord['sorder'][$i]['status'] == '10') { $status_des =" case close ";
			}else{ $status_des ='';}

	if ($ord['sorder'][$i]['pttn_suppt'])
	{
		if ($ord['sorder'][$i]['peta']=='0000-00-00')$ord['sorder'][$i]['peta']='N/A';
		if ($ord['sorder'][$i]['rcvd_pttn']=='0000-00-00')$ord['sorder'][$i]['peta']='N/A';

	}else{
		$ord['sorder'][$i]['peta']="not support";
		$ord['sorder'][$i]['rcvd_pttn']="no need";
	}
	
	if ($ord['sorder'][$i]['fab_substu'])
	{

		$ord['sorder'][$i]['feta']="substitude";
		$ord['sorder'][$i]['rcvd_fab']="no need";

	}else{
		if ($ord['sorder'][$i]['feta']=='0000-00-00')$ord['sorder'][$i]['peta']='N/A';		
		if ($ord['sorder'][$i]['rcvd_fab']=='0000-00-00')$ord['sorder'][$i]['peta']='N/A';
	}

	if ($ord['sorder'][$i]['wi_date']=='0000-00-00')$ord['sorder'][$i]['wi_date']='N/A';	

	if ($ord['sorder'][$i]['acc_substu'])
	{

		$ord['sorder'][$i]['aeta']="substitude";
		$ord['sorder'][$i]['rcvd_acc']="no need";

	}else{
		if ($ord['sorder'][$i]['aeta']=='0000-00-00')$ord['sorder'][$i]['aeta']='N/A';		
		if ($ord['sorder'][$i]['rcvd_acc']=='0000-00-00')$ord['sorder'][$i]['peta']='N/A';
	}

	if ($ord['sorder'][$i]['schd_pttn']=='0000-00-00')$ord['sorder'][$i]['schd_pttn']='N/A';

	if ($ord['sorder'][$i]['done_pttn']=='0000-00-00')$ord['sorder'][$i]['done_pttn']='N/A';	
	
	if ($ord['sorder'][$i]['schd_smpl']=='0000-00-00')$ord['sorder'][$i]['schd_smpl']='N/A';	
	
	if ($ord['sorder'][$i]['done_smpl']=='0000-00-00')$ord['sorder'][$i]['done_smpl']='N/A';	
	if ($ord['sorder'][$i]['apv_date'] == '0000-00-00')$ord['sorder'][$i]['apv_date']='N/A';	
	  $worksheet1->write($i+2,0,$ord['sorder'][$i]['num'],$formatnum);
	  $worksheet1->write($i+2,1,$ord['sorder'][$i]['cust'],$f2);
	  $worksheet1->write($i+2,2,$ord['sorder'][$i]['dept'],$f2);
	  $worksheet1->write($i+2,3,$ord['sorder'][$i]['smpl_type']);
	  $worksheet1->write($i+2,4,$ord['sorder'][$i]['ref']);
	  $worksheet1->write($i+2,5,$ord['sorder'][$i]['style_cat']);
	  $worksheet1->write($i+2,6,$ord['sorder'][$i]['etd']);
	  $worksheet1->write($i+2,7,$ord['sorder'][$i]['style']);
	  $worksheet1->write($i+2,8,$ord['sorder'][$i]['ie']);
	  $worksheet1->write($i+2,9,'',$formatnum);
	  
	  $worksheet1->write($i+2,10,$ord['sorder'][$i]['peta'],$f2);
	  $worksheet1->write($i+2,11,$ord['sorder'][$i]['rcvd_pttn']);
	  $worksheet1->write($i+2,12,$ord['sorder'][$i]['feta'],$f2);
	  $worksheet1->write($i+2,13,$ord['sorder'][$i]['rcvd_fab']);
	  $worksheet1->write($i+2,14,$ord['sorder'][$i]['wi_date'],$f2);
	  $worksheet1->write($i+2,15,'maker:'.$ord['sorder'][$i]['factory']);
	  $worksheet1->write($i+2,16,$ord['sorder'][$i]['aeta'],$f2);

	  $worksheet1->write($i+2,17,$ord['sorder'][$i]['rcvd_acc']);
	  $worksheet1->write($i+2,18,$ord['sorder'][$i]['unit'],$f2);
	  $worksheet1->write($i+2,19,$ord['sorder'][$i]['rq']);
	  $worksheet1->write($i+2,20,$ord['sorder'][$i]['backup']);
	  $worksheet1->write($i+2,21,$ord['sorder'][$i]['qty']);
	  $worksheet1->write($i+2,22,$ord['sorder'][$i]['qty_done']);
	   $worksheet1->write($i+2,23,'',$formatnum);
	  $worksheet1->write($i+2,24,$ord['sorder'][$i]['schd_pttn']);
	  $worksheet1->write($i+2,25,$ord['sorder'][$i]['done_pttn']);
	  $worksheet1->write($i+2,26,$ord['sorder'][$i]['schd_smpl']);
	  $worksheet1->write($i+2,27,$ord['sorder'][$i]['done_smpl']);
	  $worksheet1->write($i+2,28,$ord['sorder'][$i]['apv_date']);
	  $worksheet1->write($i+2,29,$ord['sorder'][$i]['orders']);
	  $worksheet1->write($i+2,30,$status_des,$f2);
	
	}


  $workbook->close();


	break;






#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "do_smpl_logs_add":       樣本 logs 寫入  (分類)
#					其中有 PENDING 和 REDOING 兩個特殊選項
#					皆授權給 24E 的權限才能使用 兩者會改變 SMPL ORDER 的 status
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "do_smpl_logs_add":

		if(!$admin->is_power("008","add") && !$admin->is_power("014","add") && !$admin->is_power("015","add") &&  !$admin->is_power("016","add")){ 
			$op['msg'][] = "sorry! you don't have this Authority !";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}


		$err_msg ='';
if(trim($PHP_subj) && trim($PHP_des)){  // subject & des 必需有資料

		// 將PENDING 設定為只有 24E 的專有權限
		if($PHP_subj == 'PENDING' || $PHP_subj == 'REDOING'){   
		  if(!$admin->is_power("016","edit")){
			$op['msg'][] = "sorry! you don't have this Authority !";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		  }
		}
		if(strstr($PHP_des,'&#'))	$PHP_des = $ch_cov->check_cov($PHP_des);
		
		$parm = array(	"subj"		=>	$PHP_subj,
						"user"		=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
						"num"		=>	$PHP_num,
						"des"		=>	$PHP_des,
						"k_time"	=>	$TODAY,
				);

		//當subject 是PENDING時 的特殊輸入 ---
		if($PHP_subj == 'PENDING'){   // 將PENDING 設定為只有 24E 的專有權限
			$parm['subj'] = '<span class=bgdy9>'.$PHP_subj.'</span>';
			$parm['des'] = '<span class=bgdy9>'.$PHP_des.'</span>';

			if(!$V = $smpl_ord->get_fieldvalue($PHP_id, 'status')){ //取出status
				$op['msg']= $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			
			if ($V['status'] == '7'){
				$op['msg'][] = "sorry! this order is under status <b>PENDING</b> already !";
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}else{   // 將原來的status 存入 remark
				$argu['id']			 = $PHP_id;
				$argu['field_name']  = 'remark';
				$argu['field_value'] = $V['status'];
				if(!$F = $smpl_ord->update_field($argu)){ //-存入remark
					$op['msg']= $smpl_ord->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
			
				// 更改 smpl order 的 status
				if(!$S = $smpl_ord->update_status($PHP_id, 7)){ 
					$op['msg']= $smpl_ord->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
			}
		}elseif($PHP_subj == 'REDOING'){
			//---取出status
			if(!$v = $smpl_ord->get_fieldvalue($PHP_id, 'status')){ 
				$op['msg']= $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}

			if($v['status'] == "7"){  // 確定現在訂單是 pending 時
				$parm['subj'] = '<span class=grn9>'.$PHP_subj.'</span>';
				$parm['des'] = '<span class=grn9>'.$PHP_des.'</span>';

				// 更改 smpl order 的 status [--由remark抓回來]

				if(!$R = $smpl_ord->get_fieldvalue($PHP_id, 'remark')){ //取出 remark
					$op['msg']= $smpl_ord->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}

				if(!$F = $smpl_ord->update_status($PHP_id, $R['remark'])){ //-存入status
					$op['msg']= $smpl_ord->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}

			}else{
				$op['msg'][] = "sorry! you cannot select <b>REDOING</b> as order is not <b>PENDING</b> !";
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
		}

		// -- 寫入 log table
		if(!$f1 = $smpl_log->add($parm)){
			$op['msg']= $smpl_log->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

} else {   //----if (trim($PHP_subj) && trim($PHP_des)) 沒有subj或 寫入des時

		$op['msg'][] =  "&nbsp;SORRY !! <b>Subject</b> selected and logs <b>Describe</b> are required!";
		$layout->assign($op);
		$layout->display($TPL_ERROR);  		    
		break;

}
		// 送出參數 ----- redir page
		if (!isset($SCH_wi))		$SCH_wi	='';
		if (!isset($SCH_close))	$SCH_close	='';
		if (!isset($SCH_pend))	$SCH_pend	='';
		if (!isset($SCH_pttnd))	$SCH_pttnd	='';
		if (!isset($SCH_fab))		$SCH_fab	='';
		if (!isset($SCH_acc))		$SCH_acc	='';
		if (!isset($SCH_ptno))	$SCH_ptno	='';
		if (!isset($SCH_ptdu))	$SCH_ptdu	='';
		if (!isset($SCH_usmp))	$SCH_usmp	='';
		if (!isset($SCH_smpdu))	$SCH_smpdu	='';
		if (!isset($SCH_qty))		$SCH_qty	='';
		if (!isset($SCH_ie))		$SCH_ie	='';
		if (!isset($SCH_mk))		$SCH_mk	='';
		if (isset($cgi_8))			$SCH_wi	= $cgi_8;
		if (isset($cgi_9))			$SCH_close = $cgi_9;
		if (isset($cgi_10))			$SCH_pend = $cgi_10;

		$cgi = '&cgino='.$cgino.'&cgi_1='.$cgi_1.'&cgi_2='.$cgi_2.'&cgi_3='.$cgi_3.'&cgi_4='.$cgi_4.'&cgi_5='.$cgi_5."&PHP_op_str=".$cgi_6."&cgi_6=".$cgi_6."&PHP_op_fsh=".$cgi_7."&cgi_7".$cgi_7."&cgi_8=".$SCH_wi."&cgi_9=".$SCH_close."&cgi_10=".$SCH_pend."&SCH_ptno=".$SCH_ptno."&SCH_ptdu=".$SCH_ptdu."&SCH_usmp=".$SCH_usmp."&SCH_smpdu=".$SCH_smpdu."&SCH_qty=".$SCH_qty."&SCH_ie=".$SCH_ie."&SCH_mk=".$SCH_ie."&SCH_wi=".$SCH_wi."&SCH_close=".$SCH_close."&SCH_pend=".$SCH_pend."&SCH_pttnd=".$SCH_pttnd."&SCH_fab=".$SCH_fab."&SCH_acc=".$SCH_acc;
		
		$redir_str = $PHP_SELF.'?PHP_action='.$back_action.'&PHP_id='.$PHP_id.'&cgiget='.$cgiget.$cgi;
		redirect_page($redir_str);
	break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "smpl_supplier":	job 22
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "smpl_supplier":
check_authority("014","view");

//---------------------------- 要注意改成  R&D 可 adding--------
$where_str = $manager = $dept_id = '';
$dept_ary = array();
$sales_dept_ary = get_sales_dept(); // 取出 業務的部門 [不含K0] ----

$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];  
$user_team = $GLOBALS['SCACHE']['ADMIN']['team_id'];

for ($i=0; $i<count($sales_dept_ary);$i++){
    if($user_dept == $sales_dept_ary[$i]){

        // 如果是業務部進入 則dept_code 指定該業務部---
        $dept_id = $sales_dept_ary[$i];  
    }
}

if (!$dept_id) {    // 當不是 業務部人[也不含 K0 的人 ]進入時
    $manager = 1;
    //業務部門 select選單
    $dept_ary = $arry2->select($sales_dept_ary,$GLOBALS['SCACHE']['ADMIN']['dept'],"PHP_dept_code","select","");  
}
$team = $GLOBALS['SCACHE']['ADMIN']['team_id'];
if(($user_dept == 'HJ' ||$user_dept == 'LY' ||$user_dept == 'CF' ) && $team<>'MD')
{
    $manager = 1;
    $manager_v = 1;
    //業務部門 select選單
    $dept_ary = $arry2->select($sales_dept_ary,$GLOBALS['SCACHE']['ADMIN']['dept'],"PHP_dept_code","select","");  
    $where_str ='';

}
$op['manager_flag'] = $manager;
$op['dept_id'] = $dept_id;
$op['dept_ary'] = $dept_ary;

$op['msg'] = $order->msg->get(2);

// creat cust combo box
// 取出 客戶代號
$where_str=$where_str."order by cust_s_name"; //依cust_s_name排序
$cust_def = $cust->get_fields('cust_init_name',$where_str);  //取出客戶簡稱
$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
for ($i=0; $i< sizeof($cust_def); $i++)$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現

$op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue); 

// -------- 決定 factory 的參數 = 陣列? 數值?  RD人員進入時有差別 ----
if($S = $smpl_ord->is_sample_team($user_team)){
    $op['factory'] = $user_team."<input type='hidden' name='PHP_factory' value='".$user_team."'>";
}else{
    $op['factory'] = $arry2->select($SAMPLER,'','PHP_factory','select','');  	
}
if($user_team=="RD"){
        $op['factory'] = $user_dept."<input type='hidden' name='PHP_factory' value='".$user_dept."'>";
}
// --------------------------------------------------------------------
$smpl_def = $smpl_type->get_fields('smpl_type');   // 取出 款式類別
$op['smpl_type'] =  $arry2->select($smpl_def,'','SCH_smpl_type','select','');

$op['dept_select'] = $arry2->select(get_dept_group(),"","PHP_dept","select","");

//080725message增加		
$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
$op['max_notify'] = $note['max_no'];		

page_display($op, "014", $TPL_SMPL_SUPPLIER);			
break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# case "smpl_supplier_search":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "smpl_supplier_search":
check_authority("014","view");

if (!isset($SCH_wi))		$SCH_wi	='';
if (!isset($SCH_close))	    $SCH_close	='';
if (!isset($SCH_pend))	    $SCH_pend	='';
if (!isset($SCH_pttnd))	    $SCH_pttnd	='';
if (!isset($SCH_fab))		$SCH_fab	='';
if (!isset($SCH_acc))		$SCH_acc	='';
if (!isset($SCH_ptno))	    $SCH_ptno	='';
if (!isset($SCH_ptdu))	    $SCH_ptdu	='';
if (!isset($SCH_usmp))	    $SCH_usmp	='';
if (!isset($SCH_smpdu))	    $SCH_smpdu	='';
if (!isset($SCH_qty))		$SCH_qty	='';
if (!isset($SCH_ie))		$SCH_ie	='';
if (!isset($SCH_mk))		$SCH_mk	='';

//新增search條件
$parm = array(
    "PHP_dept"		=>  $PHP_dept,
    "num"			=>  $PHP_num,
    "cust"			=>	$PHP_cust,
    "ref"			=>	$PHP_ref,
    "factory"		=>	$PHP_factory,
    'wi'			=>	$SCH_wi,
    'close'			=>	$SCH_close,
    'pend'			=>	$SCH_pend,
    'pttnd'			=>	$SCH_pttnd,
    'fab'			=>	$SCH_fab,
    'acc'			=>	$SCH_acc,
    'ptno'			=>	$SCH_ptno,
    'ptdu'			=>	$SCH_ptdu,
    'usmp'			=>	$SCH_usmp,
    'smpdu'			=>	$SCH_smpdu,
    'qty'			=>	$SCH_qty,
    'ie'			=>	$SCH_ie,
    'mk'			=>	$SCH_mk,
    "op_str"		=>	$PHP_op_str,
    "op_fsh"		=>	$PHP_op_fsh,
    'SCH_smpl_type' =>	$SCH_smpl_type,
);

$login_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];

// search 訂單為 supplier 呈現的部份 [ status < 4 ]
//	status : 0 : W/I wait		status : 1 : PTTN wait
//	status : 2 : FAB wait		status : 3 : ACC wait
//	status : 4 : PTTN schdl		status : 5 : SMPL schdl
//	status : 6 : PENDING
//  status : 10: case close

// 查尋 status  <  5 
if (!$op = $smpl_ord->supplier_search(1, $PHP_dept_code)) {  
    $op['msg']= $smpl_ord->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}

// 檢查 相片是否存在 2007.03.23		
for ($i=0; $i < sizeof($op['sorder']); $i++)
{
if(file_exists($GLOBALS['config']['root_dir']."/smpl_pic/s_".$op['sorder'][$i]['num'].".jpg")){
    $op['sorder'][$i]['main_pic'] = "./smpl_pic/s_".$op['sorder'][$i]['num'].".jpg";
} else {
    $op['sorder'][$i]['main_pic'] = "./images/graydot.gif";
}
$op['sorder'][$i]['wi_cfm'] = substr($op['sorder'][$i]['wi_cfm'],0,10);
$img_size = GetImageSize($op['sorder'][$i]['main_pic']);
if ($img_size[0] < $img_size[1]) $op['sorder'][$i]['height'] = 1;
}		


// -- 可利用 login_dept 判定是否 為 R&D 或更高管理人員進入 ?
// -- 可否可 EDIT , ADDING..... (功能 switch...)
if ($login_dept == "SA" || $login_dept == "GM" || $login_dept == "RD"){
    $op['manager_flag'] = 1;
}
$op['dept_id'] = $PHP_dept_code;
$op['today'] = $GLOBALS['TODAY'];  // 用為html判斷

$op['msg']= $smpl_ord->msg->get(2);
$op['cgi']= $parm;
$op['sub_back_str'] = "&SCH_ptno=".$SCH_ptno."&SCH_ptdu=".$SCH_ptdu."&SCH_usmp=".$SCH_usmp."&SCH_smpdu=".$SCH_smpdu."&SCH_qty=".$SCH_qty."&SCH_ie=".$SCH_ie."&SCH_mk=".$SCH_ie."&SCH_wi=".$SCH_wi."&SCH_close=".$SCH_close."&SCH_pend=".$SCH_pend."&SCH_pttnd=".$SCH_pttnd."&SCH_fab=".$SCH_fab."&SCH_acc=".$SCH_acc."&PHP_op_str=".$PHP_op_str."&PHP_op_fsh=".$PHP_op_fsh;
page_display($op, "014", $TPL_SMPL_SUPPLIER_LIST);			
break;

	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 22V sample SUPPLIER view
#		case "smpl_supplier_view":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "smpl_supplier_view":

		check_authority("014","view");

		//----- 取出該筆記錄
		$op['order'] = $smpl_ord->get($PHP_id);  
		if (!$op['order']) {
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/smpl_pic/".$op['order']['num'].".jpg")){
			$op['main_pic'] = "./smpl_pic/".$op['order']['num'].".jpg";
		} else {
			$op['main_pic'] = "./images/graydot.gif";
		}
		//----- 取出 smpl_log 本訂單 之歷史50筆的計記錄  -------------------
		$logs = $smpl_log->search50($op['order']['num']); 
		if (!$logs){
			$op['msg'] = $smpl_log->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['logs'] = $logs['log'];
		$op['log_records'] = $logs['records'];
	
		// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來判斷有無資料
		//--------------------------------
		$parm = $op['order'];

		// 加入返回前頁 --------------
		$back_str = $cgiget."&PHP_sr_startno=".$cgino."&PHP_dept_code=".$cgi_1."&PHP_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5."&SCH_ptno=".$SCH_ptno."&SCH_ptdu=".$SCH_ptdu."&SCH_usmp=".$SCH_usmp."&SCH_smpdu=".$SCH_smpdu."&SCH_qty=".$SCH_qty."&SCH_ie=".$SCH_ie."&SCH_mk=".$SCH_ie."&SCH_wi=".$SCH_wi."&SCH_close=".$SCH_close."&SCH_pend=".$SCH_pend."&SCH_pttnd=".$SCH_pttnd."&SCH_fab=".$SCH_fab."&SCH_acc=".$SCH_acc."&PHP_op_str=".$PHP_op_str."&PHP_op_fsh=".$PHP_op_fsh;
		
		$back_str2 = "PHP_action=smpl_ord_view&PHP_id=".$PHP_id."&PHP_num=".$parm['num'];
		// creat LOG SUBJ combo box
		$op['logs_subj'] = $arry2->select($SMPL_LOG_SUBJ,'','PHP_subj','select','');  	

		$op['back_str2'] = $back_str2;
		$op['back_str'] = $back_str;
		$op['search'] = '1';

		$img_size = GetImageSize($op['main_pic']);
		if ($img_size[0] < $img_size[1]) $op['height'] = 1;

		$op['msg'] = $smpl_ord->msg->get(2);

		page_display($op, "014", $TPL_SMPL_SUPPLIER_SHOW);			
		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "smpl_wi_rcvd":
#		job 22A					記錄 smpl_ord->status, smpl_ord->wi_date
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

	case "smpl_wi_rcvd":

		check_authority("014","add");

		$today = $GLOBALS['TODAY'];
		$parm = array(	"pd_id"		=>  $PHP_id,
						"ord_num"	=>  $PHP_num,
		);
##--*****新加頁碼 start
		$redir_str = "index2.php?PHP_action=smpl_supplier_search&PHP_sr_startno=".$PHP_sr_startno."&PHP_dept_code=".$PHP_dept."&PHP_num=".$PHP_nums."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&SCH_ptno=".$SCH_ptno."&SCH_ptdu=".$SCH_ptdu."&SCH_usmp=".$SCH_usmp."&SCH_smpdu=".$SCH_smpdu."&SCH_qty=".$SCH_qty."&SCH_ie=".$SCH_ie."&SCH_mk=".$SCH_ie."&SCH_wi=".$SCH_wi."&SCH_close=".$SCH_close."&SCH_pend=".$SCH_pend."&SCH_pttnd=".$SCH_pttnd."&SCH_fab=".$SCH_fab."&SCH_acc=".$SCH_acc."&PHP_op_str=".$PHP_op_str."&PHP_op_fsh=".$PHP_op_fsh;;
##--*****新加頁碼 end
	// 先寫入  smpl_ord 表內的 wi_date  ---------------
			$argu['field_name'] = 'wi_date';
			$argu['field_value'] = $today;
			$argu['id'] = $PHP_id;
	if(!$ord = $smpl_ord->update_field($argu)){
		$op['msg'][] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
	} 

	// --- 判斷如何更改 status   ######  ---------------
	$smpl = $smpl_ord->get($PHP_id);  //取出該筆記錄
	if (!$smpl) {
		$op['msg'] = $smpl_ord->msg->get(2);
		$layout->assign($op);
		$layout->display($TPL_ERROR);  		    
		break;
	}

		if ($smpl['pttn_suppt'] && $smpl['rcvd_pttn'] == '0000-00-00'){
			$new_status = 1;
		}elseif(!$smpl['fab_substu'] && $smpl['rcvd_fab'] == '0000-00-00'){
			$new_status = 2;
		}elseif(!$smpl['acc_substu'] && $smpl['rcvd_acc'] == '0000-00-00'){
			$new_status = 3;
		}else{
			$new_status = 4;
		}

	// ---- 寫入  smpl_ord 表內的 status  ---------------
			$argu['field_name'] = 'status';
			$argu['field_value'] = $new_status;
			$argu['id'] = $PHP_id;
	if(!$ord = $smpl_ord->update_field($argu)){
		$op['msg'][] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
	} 
		# 記錄使用者動態
		$message = "CFM received W/I of [".$PHP_num."] on:".$today;
		$log->log_add(0,"27A",$message);

	redirect_page($redir_str);
	break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "smpl_wi_back":	抹去 原來 W/I 收到記錄 (只限當天可改)
#		job 22x					記錄 smpl_ord->status, smpl_ord->wi_date
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

	case "smpl_wi_back":

		check_authority("014","add");

		$today = $GLOBALS['TODAY'];
		$parm = array(	"pd_id"		=>  $PHP_id,
						"ord_num"	=>  $PHP_num,
		);
##--*****新加頁碼 start
		$redir_str = "index2.php?PHP_action=smpl_supplier_search&PHP_sr_startno=".$PHP_sr_startno."&PHP_dept_code=".$PHP_dept."&PHP_num=".$PHP_nums."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory;
##--*****新加頁碼 end
		// 先寫入  smpl_ord 表內的 wi_date  ---------------
			$argu['field_name'] = 'wi_date';
			$argu['field_value'] = '0000-00-00';
			$argu['id'] = $PHP_id;
		if(!$ord = $smpl_ord->update_field($argu)){
			$op['msg'][] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 

	// 更改 status   ######  -----------------
	// 寫入  smpl_ord 表內的 status  ---------------
			$argu['field_name'] = 'status';
			$argu['field_value'] = 0;
			$argu['id'] = $PHP_id;
		if(!$ord = $smpl_ord->update_field($argu)){
			$op['msg'][] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 
				# 記錄使用者動態
		$message = "DELETE received W/I of [".$PHP_num."] on:".$today;
		$log->log_add(0,"27A",$message);

		redirect_page($redir_str);
		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "smpl_pttn_rcvd":
#		job 22x					記錄 smpl_ord->status, smpl_ord->rcvd_pttn
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

	case "smpl_pttn_rcvd":

		check_authority("014","add");

		$today = $GLOBALS['TODAY'];
		$parm = array(	"pd_id"		=>  $PHP_id,
						"ord_num"	=>  $PHP_num,
		);
##--*****新加頁碼 start
		$redir_str = "index2.php?PHP_action=smpl_supplier_search&PHP_sr_startno=".$PHP_sr_startno."&PHP_dept_code=".$PHP_dept."&PHP_num=".$PHP_nums."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&SCH_ptno=".$SCH_ptno."&SCH_ptdu=".$SCH_ptdu."&SCH_usmp=".$SCH_usmp."&SCH_smpdu=".$SCH_smpdu."&SCH_qty=".$SCH_qty."&SCH_ie=".$SCH_ie."&SCH_mk=".$SCH_ie."&SCH_wi=".$SCH_wi."&SCH_close=".$SCH_close."&SCH_pend=".$SCH_pend."&SCH_pttnd=".$SCH_pttnd."&SCH_fab=".$SCH_fab."&SCH_acc=".$SCH_acc."&PHP_op_str=".$PHP_op_str."&PHP_op_fsh=".$PHP_op_fsh;
##--*****新加頁碼 end
	// 先寫入  smpl_ord 表內的 rcvd_pttn  ---------------
			$argu['field_name'] = 'rcvd_pttn';
			$argu['field_value'] = $today;
			$argu['id'] = $PHP_id;
		if(!$ord = $smpl_ord->update_field($argu)){
			$op['msg'][] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 

	// -- 判斷如何更改 status   -----------------
		$smpl = $smpl_ord->get($PHP_id);  //取出該筆記錄
		if (!$smpl) {
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		if ($smpl['wi_date'] == '0000-00-00'){
			$new_status = 0;
		}elseif(!$smpl['fab_substu'] && $smpl['rcvd_fab'] == '0000-00-00'){
			$new_status = 2;
		}elseif(!$smpl['acc_substu'] && $smpl['rcvd_acc'] == '0000-00-00'){
			$new_status = 3;
		}else{
			$new_status = 4;
		}

	// 寫入  smpl_ord的 status  ---------------
			$argu['field_name'] = 'status';
			$argu['field_value'] = $new_status;
			$argu['id'] = $PHP_id;
		if(!$ord = $smpl_ord->update_field($argu)){
			$op['msg'][] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 
		# 記錄使用者動態
		$message = " CFM received Pattern of [".$PHP_num."] on:".$today;
		$log->log_add(0,"27A",$message);
		redirect_page($redir_str);
		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "smpl_pttn_back":	抹去 原來 pattern 收到的記錄 (只限當天可改)
#		job 22x					記錄 smpl_ord->status, smpl_ord->rcvd_pttn
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

	case "smpl_pttn_back":

		check_authority("014","add");

		$today = $GLOBALS['TODAY'];
		$parm = array(	"pd_id"		=>  $PHP_id,
						"ord_num"	=>  $PHP_num,
		);
##--*****新加頁碼 start
		$redir_str = "index2.php?PHP_action=smpl_supplier_search&PHP_sr_startno=".$PHP_sr_startno."&PHP_dept_code=".$PHP_dept."&PHP_num=".$PHP_nums."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&SCH_ptno=".$SCH_ptno."&SCH_ptdu=".$SCH_ptdu."&SCH_usmp=".$SCH_usmp."&SCH_smpdu=".$SCH_smpdu."&SCH_qty=".$SCH_qty."&SCH_ie=".$SCH_ie."&SCH_mk=".$SCH_ie."&SCH_wi=".$SCH_wi."&SCH_close=".$SCH_close."&SCH_pend=".$SCH_pend."&SCH_pttnd=".$SCH_pttnd."&SCH_fab=".$SCH_fab."&SCH_acc=".$SCH_acc."&PHP_op_str=".$PHP_op_str."&PHP_op_fsh=".$PHP_op_fsh;
##--*****新加頁碼 end
	// 先寫入 smpl_ord 表內的 rcvd_pttn  ---------------
			$argu['field_name'] = 'rcvd_pttn';
			$argu['field_value'] = '0000-00-00';
			$argu['id'] = $PHP_id;
		if(!$ord = $smpl_ord->update_field($argu)){
			$op['msg'][] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 

	// --- 判斷如何更改 status     -----------------
		$smpl = $smpl_ord->get($PHP_id);  //取出該筆記錄
		if (!$smpl) {
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		if ($smpl['wi_date'] == '0000-00-00'){
			$new_status = 0;
		}else{
			$new_status = 1;
		}

	// 寫入  smpl_ord 表內的 status  ---------------
			$argu['field_name'] = 'status';
			$argu['field_value'] = $new_status;
			$argu['id'] = $PHP_id;
		if(!$ord = $smpl_ord->update_field($argu)){
			$op['msg'][] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 
				# 記錄使用者動態
		$message = "DELETE received Pattern of [".$PHP_num."] on:".$today;
		$log->log_add(0,"27A",$message);

		redirect_page($redir_str);
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "smpl_fab_rcvd":
#		job 22x					記錄 smpl_ord->status, smpl_ord->rcvd_fab
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

	case "smpl_fab_rcvd":
		check_authority("014","add");

		$today = $GLOBALS['TODAY'];
		$parm = array(	"pd_id"		=>  $PHP_id,
						"ord_num"	=>  $PHP_num,
		);
##--*****新加頁碼 start
		$redir_str = "index2.php?PHP_action=smpl_supplier_search&PHP_sr_startno=".$PHP_sr_startno."&PHP_dept_code=".$PHP_dept."&PHP_num=".$PHP_nums."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&SCH_ptno=".$SCH_ptno."&SCH_ptdu=".$SCH_ptdu."&SCH_usmp=".$SCH_usmp."&SCH_smpdu=".$SCH_smpdu."&SCH_qty=".$SCH_qty."&SCH_ie=".$SCH_ie."&SCH_mk=".$SCH_ie."&SCH_wi=".$SCH_wi."&SCH_close=".$SCH_close."&SCH_pend=".$SCH_pend."&SCH_pttnd=".$SCH_pttnd."&SCH_fab=".$SCH_fab."&SCH_acc=".$SCH_acc."&PHP_op_str=".$PHP_op_str."&PHP_op_fsh=".$PHP_op_fsh;
##--*****新加頁碼 end
	// 先寫入  smpl_ord 表內的 rcvd_fab  ---------------
			$argu['field_name'] = 'rcvd_fab';
			$argu['field_value'] = $today;
			$argu['id'] = $PHP_id;
		if(!$ord = $smpl_ord->update_field($argu)){
			$op['msg'][] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 

	// --- 判斷如何更改 status  -----------------
		$smpl = $smpl_ord->get($PHP_id);  //取出該筆記錄
		if (!$smpl) {
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		if ($smpl['wi_date'] == '0000-00-00'){
			$new_status = 0;
		}elseif($smpl['pttn_suppt'] && $smpl['rcvd_pttn'] == '0000-00-00'){
			$new_status = 1;
		}elseif(!$smpl['acc_substu'] && $smpl['rcvd_acc'] == '0000-00-00'){
			$new_status = 3;
		}else{
			$new_status = 4;
		}

	// 寫入  smpl_ord 表內的 status  ---------------
			$argu['field_name'] = 'status';
			$argu['field_value'] = $new_status;
			$argu['id'] = $PHP_id;
		if(!$ord = $smpl_ord->update_field($argu)){
			$op['msg'][] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 
				# 記錄使用者動態
		$message = "CFM received fabric of [".$PHP_num."] on:".$today;
		$log->log_add(0,"27A",$message);
		redirect_page($redir_str);
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "smpl_fab_back":	抹去 原來 fabric 收到的記錄 (只限當天可改)
#		job 22x					記錄 smpl_ord->status, smpl_ord->rcvd_fab
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

	case "smpl_fab_back":

		check_authority("014","add");

		if(!$admin->is_power("014","add")){ 
			$op['msg'][] = "sorry! you don't have this permission !";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$today = $GLOBALS['TODAY'];
		$parm = array(	"pd_id"		=>  $PHP_id,
						"ord_num"	=>  $PHP_num,
		);
##--*****新加頁碼 start
		$redir_str = "index2.php?PHP_action=smpl_supplier_search&PHP_sr_startno=".$PHP_sr_startno."&PHP_dept_code=".$PHP_dept."&PHP_num=".$PHP_nums."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&SCH_ptno=".$SCH_ptno."&SCH_ptdu=".$SCH_ptdu."&SCH_usmp=".$SCH_usmp."&SCH_smpdu=".$SCH_smpdu."&SCH_qty=".$SCH_qty."&SCH_ie=".$SCH_ie."&SCH_mk=".$SCH_ie."&SCH_wi=".$SCH_wi."&SCH_close=".$SCH_close."&SCH_pend=".$SCH_pend."&SCH_pttnd=".$SCH_pttnd."&SCH_fab=".$SCH_fab."&SCH_acc=".$SCH_acc."&PHP_op_str=".$PHP_op_str."&PHP_op_fsh=".$PHP_op_fsh;
##--*****新加頁碼 end
	// 先寫入  smpl_ord 表內的 rcvd_fab  ---------------
			$argu['field_name'] = 'rcvd_fab';
			$argu['field_value'] = '0000-00-00';
			$argu['id'] = $PHP_id;
		if(!$ord = $smpl_ord->update_field($argu)){
			$op['msg'][] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 

	// --- 判斷如何更改 status   -----------------
		$smpl = $smpl_ord->get($PHP_id);  //取出該筆記錄
		if (!$smpl) {
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		if ($smpl['wi_date'] == '0000-00-00'){
			$new_status = 0;
		}elseif($smpl['pttn_suppt'] && $smpl['rcvd_pttn'] == '0000-00-00'){
			$new_status = 1;
		}else{
			$new_status = 2;
		}

	// 寫入  smpl_ord 表內的 status  ---------------
			$argu['field_name'] = 'status';
			$argu['field_value'] = $new_status;
			$argu['id'] = $PHP_id;
		if(!$ord = $smpl_ord->update_field($argu)){
			$op['msg'][] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 
				# 記錄使用者動態
		$message = "DELETE received fabric of [".$PHP_num."] on:".$today;
		$log->log_add(0,"27A",$message);

		redirect_page($redir_str);
		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "smpl_acc_rcvd":
#		job 22x					記錄 smpl_ord->status, smpl_ord->rcvd_acc
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

	case "smpl_acc_rcvd":

		check_authority("014","add");

		$today = $GLOBALS['TODAY'];
		$parm = array(	"pd_id"		=>  $PHP_id,
						"ord_num"	=>  $PHP_num,
		);
##--*****新加頁碼 start
		$redir_str = "index2.php?PHP_action=smpl_supplier_search&PHP_sr_startno=".$PHP_sr_startno."&PHP_dept_code=".$PHP_dept."&PHP_num=".$PHP_nums."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&SCH_ptno=".$SCH_ptno."&SCH_ptdu=".$SCH_ptdu."&SCH_usmp=".$SCH_usmp."&SCH_smpdu=".$SCH_smpdu."&SCH_qty=".$SCH_qty."&SCH_ie=".$SCH_ie."&SCH_mk=".$SCH_ie."&SCH_wi=".$SCH_wi."&SCH_close=".$SCH_close."&SCH_pend=".$SCH_pend."&SCH_pttnd=".$SCH_pttnd."&SCH_fab=".$SCH_fab."&SCH_acc=".$SCH_acc."&PHP_op_str=".$PHP_op_str."&PHP_op_fsh=".$PHP_op_fsh;
##--*****新加頁碼 end
	// 先寫入  smpl_ord 表內的 rcvd_acc  ---------------
			$argu['field_name'] = 'rcvd_acc';
			$argu['field_value'] = $today;
			$argu['id'] = $PHP_id;
		if(!$ord = $smpl_ord->update_field($argu)){
			$op['msg'][] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 

	// ---  判斷如何更改 status   -----------------
		$smpl = $smpl_ord->get($PHP_id);  //取出該筆記錄
		if (!$smpl) {
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		if ($smpl['wi_date'] == '0000-00-00'){
			$new_status = 0;
		}elseif($smpl['pttn_suppt'] && $smpl['rcvd_pttn'] == '0000-00-00'){
			$new_status = 1;
		}elseif(!$smpl['fab_substu'] && $smpl['rcvd_fab'] == '0000-00-00'){
			$new_status = 2;
		}else{
			$new_status = 4;
		}

	// 寫入  smpl_ord 表內的 status  ---------------
			$argu['field_name'] = 'status';
			$argu['field_value'] = $new_status;
			$argu['id'] = $PHP_id;
		if(!$ord = $smpl_ord->update_field($argu)){
			$op['msg'][] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 
		# 記錄使用者動態
		$message = "CFM received accessory of [".$PHP_num."] on:".$today;
		$log->log_add(0,"27A",$message);
		redirect_page($redir_str);
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "smpl_acc_back":	抹去 原來 fabric 收到的記錄 (只限當天可改)
#		job 22x					記錄 smpl_ord->status, smpl_ord->rcvd_acc
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

	case "smpl_acc_back":

		check_authority("014","add");

		$today = $GLOBALS['TODAY'];
		$parm = array(	"pd_id"		=>  $PHP_id,
						"ord_num"	=>  $PHP_num,
		);
##--*****新加頁碼 start
		$redir_str = "index2.php?PHP_action=smpl_supplier_search&PHP_sr_startno=".$PHP_sr_startno."&PHP_dept_code=".$PHP_dept."&PHP_num=".$PHP_nums."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&SCH_ptno=".$SCH_ptno."&SCH_ptdu=".$SCH_ptdu."&SCH_usmp=".$SCH_usmp."&SCH_smpdu=".$SCH_smpdu."&SCH_qty=".$SCH_qty."&SCH_ie=".$SCH_ie."&SCH_mk=".$SCH_ie."&SCH_wi=".$SCH_wi."&SCH_close=".$SCH_close."&SCH_pend=".$SCH_pend."&SCH_pttnd=".$SCH_pttnd."&SCH_fab=".$SCH_fab."&SCH_acc=".$SCH_acc."&PHP_op_str=".$PHP_op_str."&PHP_op_fsh=".$PHP_op_fsh;
##--*****新加頁碼 end
	// 先寫入  smpl_ord 表內的 rcvd_acc  ---------------
			$argu['field_name'] = 'rcvd_acc';
			$argu['field_value'] = '0000-00-00';
			$argu['id'] = $PHP_id;
		if(!$ord = $smpl_ord->update_field($argu)){
			$op['msg'][] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 
	// 叛斷如何更改 status   ######  -----------------
		$smpl = $smpl_ord->get($PHP_id);  //取出該筆記錄
		if (!$smpl) {
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		if ($smpl['wi_date'] == '0000-00-00'){
			$new_status = 0;
		}elseif($smpl['pttn_suttp'] && $smpl['rcvd_pttn'] == '0000-00-00'){
			$new_status = 1;
		}elseif(!$smpl['fab_substu'] && $smpl['rcvd_fab'] == '0000-00-00'){
			$new_status = 2;
		}else{
			$new_status = 3;
		}

	// 寫入  smpl_ord 表內的 status  ---------------
			$argu['field_name'] = 'status';
			$argu['field_value'] = $new_status;
			$argu['id'] = $PHP_id;
		if(!$ord = $smpl_ord->update_field($argu)){
			$op['msg'][] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 
		# 記錄使用者動態
		$message = "DELETE received accessory of [".$PHP_num."] on:".$today;
		$log->log_add(0,"27A",$message);
		redirect_page($redir_str);
		break;




#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "smpl_schedule":	job 23 樣本排產 [ pattern, Sample ]
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "smpl_schedule":
check_authority("015","view");

//--------- 要注意改成  R&D 可 adding--------
$where_str = $manager = $dept_id = '';
$dept_ary = array();
$sales_dept_ary = get_sales_dept(); // 取出 業務的部門 [不含K0] ------
$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept']; 
$user_team = $GLOBALS['SCACHE']['ADMIN']['team_id'];

for ($i=0; $i<count($sales_dept_ary);$i++){
    if($user_dept == $sales_dept_ary[$i]){
        // 如果是業務部進入 則dept_code 指定該業務部---
        $dept_id = $sales_dept_ary[$i];  
    }
}

if (!$dept_id) {    // 當不是業務部人[也不含 K0 的人 ]進入時
    $manager = 1;
    //業務部門 select選單
    $dept_ary = $arry2->select($sales_dept_ary,$GLOBALS['SCACHE']['ADMIN']['dept'],"PHP_dept_code","select","");  
}

$team = $GLOBALS['SCACHE']['ADMIN']['team_id'];
if(($user_dept == 'HJ' ||$user_dept == 'LY' ||$user_dept == 'CF' ) && $team<>'MD')
{
    $manager = 1;
    $manager_v = 1;
    //業務部門 select選單
    $dept_ary = $arry2->select($sales_dept_ary,$GLOBALS['SCACHE']['ADMIN']['dept'],"PHP_dept_code","select","");  
    $where_str ='';
}

$op['manager_flag'] = $manager;
$op['dept_id'] = $dept_id;
$op['dept_ary'] = $dept_ary;

$op['msg'] = $smpl_ord->msg->get(2);

// creat cust combo box
// 取出 客戶代號
$where_str=$where_str."order by cust_s_name"; //依cust_s_name排序
$cust_def = $cust->get_fields('cust_init_name',$where_str);
$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
for ($i=0; $i< sizeof($cust_def); $i++) $cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現

$op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue); 

// ------ 決定 factory 的參數 = 陣列? 數值?  RD人員進入時有差別 ----
if($S = $smpl_ord->is_sample_team($user_team)){
    $op['factory'] = $user_team."<input type='hidden' name='PHP_factory' value='".$user_team."'>";
}else{
    $op['factory'] = $arry2->select($SAMPLER,'','PHP_factory','select','');  	
}
if($user_team=="RD"){
    $op['factory'] = $user_dept."<input type='hidden' name='PHP_factory' value='".$user_dept."'>";
}
// --------------------------------------------------------------------
$smpl_def = $smpl_type->get_fields('smpl_type');   // 取出 款式類別
$op['smpl_type'] =  $arry2->select($smpl_def,'','SCH_smpl_type','select','');

$op['dept_select'] = $arry2->select(get_dept_group(),"","PHP_dept","select","");

//080725message增加		
$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
$op['max_notify'] = $note['max_no'];

page_display($op, "015", $TPL_SMPL_SCHEDULE);			
break;



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "smpl_schedule_search"
#			job23
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "smpl_schedule_search":
check_authority("015","view");

//新增search條件
if (!isset($SCH_wi))		$SCH_wi	='';
if (!isset($SCH_close))	$SCH_close	='';
if (!isset($SCH_pend))	$SCH_pend	='';
if (!isset($SCH_pttnd))	$SCH_pttnd	='';
if (!isset($SCH_fab))		$SCH_fab	='';
if (!isset($SCH_acc))		$SCH_acc	='';
if (!isset($SCH_ptno))	$SCH_ptno	='';
if (!isset($SCH_ptdu))	$SCH_ptdu	='';
if (!isset($SCH_usmp))	$SCH_usmp	='';
if (!isset($SCH_smpdu))	$SCH_smpdu	='';
if (!isset($SCH_qty))		$SCH_qty	='';
if (!isset($SCH_ie))		$SCH_ie	='';
if (!isset($SCH_mk))		$SCH_mk	='';

$parm = array(	"PHP_dept"		    =>  $PHP_dept,
                "num"				=>  $PHP_num,
                "cust"			    =>	$PHP_cust,
                "ref"				=>	$PHP_ref,
                "factory"		    =>	$PHP_factory,
                'wi'				=>	$SCH_wi,
                'close'			    =>	$SCH_close,
                'pend'			    =>	$SCH_pend,
                'pttnd'			    =>	$SCH_pttnd,
                'fab'				=>	$SCH_fab,
                'acc'				=>	$SCH_acc,
                'ptno'			    =>	$SCH_ptno,
                'ptdu'			    =>	$SCH_ptdu,
                'usmp'			    =>	$SCH_usmp,
                'smpdu'			    =>	$SCH_smpdu,
                'qty'				=>	$SCH_qty,
                'ie'				=>	$SCH_ie,
                'mk'				=>	$SCH_mk,
                "op_str"		    =>	$PHP_op_str,
                "op_fsh"		    =>	$PHP_op_fsh,
                'SCH_smpl_type'     =>	$SCH_smpl_type,
);

$login_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];

// search 訂單為 supplier 呈現的部份 [ status < 4 ]
//	status : 0 : W/I wait		status : 1 : PTTN wait
//	status : 2 : FAB wait		status : 3 : ACC wait
//	status : 4 : PTTN schdl		status : 5 : SMPL schdl
//	status : 6 : DEVELOPING		status : 7 : PENDING
//  status : 10: case close

// status  >  0  and  < 6   
if (!$op = $smpl_ord->schedule_search(1, $PHP_dept_code)) {  
    $op['msg']= $smpl_ord->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}
// 檢查 相片是否存在 2007.03.23		
for ($i=0; $i < sizeof($op['sorder']); $i++)
{
if(file_exists($GLOBALS['config']['root_dir']."/smpl_pic/s_".$op['sorder'][$i]['num'].".jpg")){
    $op['sorder'][$i]['main_pic'] = "./smpl_pic/s_".$op['sorder'][$i]['num'].".jpg";
} else {
    $op['sorder'][$i]['main_pic'] = "./images/graydot.gif";
}
$img_size = GetImageSize($op['sorder'][$i]['main_pic']);
if ($img_size[0] < $img_size[1]) $op['sorder'][$i]['height'] = 1;

}

//--- 可利用 login_dept 判定是否 為 R&D 或更高管理人員進入 ?
//--- 可否可 EDIT , ADDING..... (功能 switch...)
if ($login_dept == "SA" || $login_dept == "GM" || $login_dept == "RD"){
    $op['manager_flag'] = 1;
}

$op['dept_id'] = $PHP_dept_code;
$op['today'] = $GLOBALS['TODAY'];  // 用為html判斷

$op['msg']= $smpl_ord->msg->get(2);
$op['cgi']= $parm;
$op['sub_back_str'] = "&SCH_ptno=".$SCH_ptno."&SCH_ptdu=".$SCH_ptdu."&SCH_usmp=".$SCH_usmp."&SCH_smpdu=".$SCH_smpdu."&SCH_qty=".$SCH_qty."&SCH_ie=".$SCH_ie."&SCH_mk=".$SCH_ie."&SCH_wi=".$SCH_wi."&SCH_close=".$SCH_close."&SCH_pend=".$SCH_pend."&SCH_pttnd=".$SCH_pttnd."&SCH_fab=".$SCH_fab."&SCH_acc=".$SCH_acc."&PHP_op_str=".$PHP_op_str."&PHP_op_fsh=".$PHP_op_fsh;


    
page_display($op, "015", $TPL_SMPL_SCHEDULE_LIST);			
break;

	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#			job 23V sample SCHEDULE view
#		case "smpl_schedule_view":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "smpl_schedule_view":

		check_authority("015","view");

		//--------- 取出該筆記錄
		$op['order'] = $smpl_ord->get($PHP_id); 
		if (!$op['order']) {
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		
		// 檢查 相片是否存在 2007.03.23
		if(file_exists($GLOBALS['config']['root_dir']."/smpl_pic/".$op['order']['num'].".jpg")){
			$op['main_pic'] = "./smpl_pic/".$op['order']['num'].".jpg";
		} else {
			$op['main_pic'] = "./images/graydot.gif";
		}
		// --- 取出 smpl_log 本訂單 之歷史50筆的計記錄  -------------------
		$logs = $smpl_log->search50($op['order']['num']); 
		if (!$logs){
			$op['msg'] = $smpl_log->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['logs'] = $logs['log'];
		$op['log_records'] = $logs['records'];
		// --- 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來判斷有無資料
		//--------------------------------
		$parm = $op['order'];

		// 加入返回前頁 --------------
		$back_str = $cgiget."&PHP_sr_startno=".$cgino."&PHP_dept_code=".$cgi_1."&PHP_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5."&SCH_ptno=".$SCH_ptno."&SCH_ptdu=".$SCH_ptdu."&SCH_usmp=".$SCH_usmp."&SCH_smpdu=".$SCH_smpdu."&SCH_qty=".$SCH_qty."&SCH_ie=".$SCH_ie."&SCH_mk=".$SCH_ie."&SCH_wi=".$SCH_wi."&SCH_close=".$SCH_close."&SCH_pend=".$SCH_pend."&SCH_pttnd=".$SCH_pttnd."&SCH_fab=".$SCH_fab."&SCH_acc=".$SCH_acc."&PHP_op_str=".$PHP_op_str."&PHP_op_fsh=".$PHP_op_fsh;
		
		$op['back_str'] = $back_str;
		$op['sub_back_str'] = "&SCH_ptno=".$SCH_ptno."&SCH_ptdu=".$SCH_ptdu."&SCH_usmp=".$SCH_usmp."&SCH_smpdu=".$SCH_smpdu."&SCH_qty=".$SCH_qty."&SCH_ie=".$SCH_ie."&SCH_mk=".$SCH_ie."&SCH_wi=".$SCH_wi."&SCH_close=".$SCH_close."&SCH_pend=".$SCH_pend."&SCH_pttnd=".$SCH_pttnd."&SCH_fab=".$SCH_fab."&SCH_acc=".$SCH_acc."&PHP_op_str=".$PHP_op_str."&PHP_op_fsh=".$PHP_op_fsh;
		$op['cgi']= array( 'dept' 		=>	$cgi_1,
												'num'			=>	$cgi_2,
												'cust'		=>	$cgi_3,
												'ref'			=>	$cgi_4,
												'factory'	=>	$cgi_5
										 );	
		$op['cgistr_get'] = $cgiget;
		$op['start_no'] = $cgino;

		// creat LOG SUBJ combo box
		$op['logs_subj'] = $arry2->select($SMPL_LOG_SUBJ,'','PHP_subj','select','');  	
		$op['search'] = '1';

		# 記錄使用者動態
		$op['msg'] = $smpl_ord->msg->get(2);

		// 建立 兩個 日期的 combo list
		$op['cgistr_get'] = $cgiget;
		$img_size = GetImageSize($op['main_pic']);
		if ($img_size[0] < $img_size[1]) $op['height'] = 1;

		page_display($op, "015", $TPL_SMPL_SCHEDULE_SHOW);			
		break;



	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 28A sample SCHEDULE arrangement for PATTERN
#		case "smpl_pttn_schd":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "smpl_pttn_schd":

		check_authority("015","add");

		$parm = array(	"id"		=>  $PHP_id,
						"num"		=>  $PHP_num,
						"pttn_date"	=>	$PHP_pttn_date,
				);

		$op['order'] = $smpl_ord->get($PHP_id);  //取出該筆記錄
		if (!$op['order']) {
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		//---- 更改 status 記錄 ------
		$parm['status'] = ($op['order']['schd_smpl'] <> '0000-00-00') ?  6 : 5;

	if(!$PHP_pttn_date){   //輸入項 檢查
		$op['msg'] = $smpl_ord->msg->get(2);

	} else {
		if (!$A = $smpl_ord->add_pttn_schedule($parm)){
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['msg'][] = $message = " ADD Pattern Schedule of #".$parm['num']." by : ".$parm['pttn_date'];
				# 記錄使用者動態
		$log->log_add(0,"28A",$message);

		$op['order'] = $smpl_ord->get($PHP_id);  //取出該筆記錄
		if (!$op['order']) {
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
	}

	//----------------------------------------- 呈現 記錄 ---------
	// 取出 smpl_log 本訂單 之歷史50筆的計記錄  -------------------
		$logs = $smpl_log->search50($op['order']['num']); 
		if (!$logs){
			$op['msg'] = $smpl_log->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['logs'] = $logs['log'];
		$op['log_records'] = $logs['records'];
		// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來判斷有無資料
		//--------------------------------
		$parm = $op['order'];

		// 加入返回前頁 --------------
		$cgiget = $PHP_back;
		$back_str = $cgiget."&PHP_sr_startno=".$cgino."&PHP_dept_code=".$cgi_1."&PHP_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5."&SCH_ptno=".$SCH_ptno."&SCH_ptdu=".$SCH_ptdu."&SCH_usmp=".$SCH_usmp."&SCH_smpdu=".$SCH_smpdu."&SCH_qty=".$SCH_qty."&SCH_ie=".$SCH_ie."&SCH_mk=".$SCH_ie."&SCH_wi=".$SCH_wi."&SCH_close=".$SCH_close."&SCH_pend=".$SCH_pend."&SCH_pttnd=".$SCH_pttnd."&SCH_fab=".$SCH_fab."&SCH_acc=".$SCH_acc."&PHP_op_str=".$PHP_op_str."&PHP_op_fsh=".$PHP_op_fsh;
		
		$op['back_str'] = $back_str;
		$op['sub_back_str'] = "&SCH_ptno=".$SCH_ptno."&SCH_ptdu=".$SCH_ptdu."&SCH_usmp=".$SCH_usmp."&SCH_smpdu=".$SCH_smpdu."&SCH_qty=".$SCH_qty."&SCH_ie=".$SCH_ie."&SCH_mk=".$SCH_ie."&SCH_wi=".$SCH_wi."&SCH_close=".$SCH_close."&SCH_pend=".$SCH_pend."&SCH_pttnd=".$SCH_pttnd."&SCH_fab=".$SCH_fab."&SCH_acc=".$SCH_acc."&PHP_op_str=".$PHP_op_str."&PHP_op_fsh=".$PHP_op_fsh;
		$op['search'] = '1';
		$op['cgi']= array( 'dept' 		=>	$cgi_1,
												'num'			=>	$cgi_2,
												'cust'		=>	$cgi_3,
												'ref'			=>	$cgi_4,
												'factory'	=>	$cgi_5
										 );	
		$op['cgistr_get'] = $cgiget;
		$op['start_no'] = $cgino;
				// 檢查 相片是否存在 2007.03.23
		if(file_exists($GLOBALS['config']['root_dir']."/smpl_pic/".$op['order']['num'].".jpg")){
			$op['main_pic'] = "./smpl_pic/".$op['order']['num'].".jpg";
		} else {
			$op['main_pic'] = "./images/graydot.gif";
		}

		// creat LOG SUBJ combo box
		$op['logs_subj'] = $arry2->select($SMPL_LOG_SUBJ,'','PHP_subj','select','');  	
		$img_size = GetImageSize($op['main_pic']);
		if ($img_size[0] < $img_size[1]) $op['height'] = 1;

		page_display($op, "015", $TPL_SMPL_SCHEDULE_SHOW);			
		break;

	





#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "smpl_output":	job 29
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "smpl_output":
check_authority("016","view");

//------------ 要注意改成  R&D 可 adding--------
$where_str = $manager = $dept_id = '';
$dept_ary = array();
$sales_dept_ary = get_sales_dept(); // 取出 業務的部門 [不含K0] ------
$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
$user_team = $GLOBALS['SCACHE']['ADMIN']['team_id'];

for ($i=0; $i<count($sales_dept_ary);$i++){
    if($user_dept == $sales_dept_ary[$i]){
        // 如果是業務部進入 則dept_code 指定該業務部---
        $dept_id = $sales_dept_ary[$i];  
    }
}

if (!$dept_id) {    // 當不是業務部人[也不含 K0 的人 ]進入時
    $manager = 1;
    //業務部門 select選單
    $dept_ary = $arry2->select($sales_dept_ary,$GLOBALS['SCACHE']['ADMIN']['dept'],"PHP_dept_code","select","");  
}

$team = $GLOBALS['SCACHE']['ADMIN']['team_id'];
if(($user_dept == 'HJ' ||$user_dept == 'LY' ||$user_dept == 'CF' ) && $team<>'MD')
{
    $manager = 1;
    $manager_v = 1;
    //業務部門 select選單
    $dept_ary = $arry2->select($sales_dept_ary,$GLOBALS['SCACHE']['ADMIN']['dept'],"PHP_dept_code","select","");  
    $where_str ='';

}

$op['manager_flag'] = $manager;
$op['dept_id'] = $dept_id;
$op['dept_ary'] = $dept_ary;
$op['msg'] = $order->msg->get(2);

// creat cust combo box
// 取出 客戶代號
$where_str=$where_str."order by cust_s_name"; //依cust_s_name排序
$cust_def = $cust->get_fields('cust_init_name',$where_str);
$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
for ($i=0; $i< sizeof($cust_def); $i++) $cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現

$op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue); 

// -------- 決定 factory 的參數 = 陣列? 數值?  RD人員進入時有差別 ----
if($S = $smpl_ord->is_sample_team($user_team)){
    $op['factory'] = $user_team."<input type='hidden' name='PHP_factory' value='".$user_team."'>";
}else{
    $op['factory'] = $arry2->select($SAMPLER,'','PHP_factory','select','');  	
}

if($user_team=="RD"){
    $op['factory'] = $user_dept."<input type='hidden' name='PHP_factory' value='".$user_dept."'>";
}

$smpl_def = $smpl_type->get_fields('smpl_type');   // 取出 款式類別
$op['smpl_type'] =  $arry2->select($smpl_def,'','SCH_smpl_type','select','');  	

$op['dept_select'] = $arry2->select(get_dept_group(),"","PHP_dept","select",""); 
// --------------------------------------------------------------------

//080725message增加		
$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
$op['max_notify'] = $note['max_no'];

page_display($op, "016", $TPL_SMPL_OUTPUT);			
break;




#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "smpl_output_search":    JOB 24
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "smpl_output_search":
check_authority("016","view");

// print_r($_POST);

if (!isset($SCH_wi))    $SCH_wi	='';
if (!isset($SCH_close))	$SCH_close	='';
if (!isset($SCH_pend))	$SCH_pend	='';
if (!isset($SCH_pttnd))	$SCH_pttnd	='';
if (!isset($SCH_fab))   $SCH_fab	='';
if (!isset($SCH_acc))   $SCH_acc	='';
if (!isset($SCH_ptno))	$SCH_ptno	='';
if (!isset($SCH_ptdu))	$SCH_ptdu	='';
if (!isset($SCH_usmp))	$SCH_usmp	='';
if (!isset($SCH_smpdu))	$SCH_smpdu	='';
if (!isset($SCH_qty))   $SCH_qty	='';
if (!isset($SCH_ie))    $SCH_ie	='';
if (!isset($SCH_mk))    $SCH_mk	='';
if (!isset($SCH_smpl_type)) $SCH_smpl_type	='';
//新增search條件

if(isset($PHP_op_str))
{
    $sch_parm = array(	"PHP_dept"		    =>  $PHP_dept,
                        "PHP_num"           =>  $PHP_num,
                        "PHP_cust"			=>	$PHP_cust,
                        "PHP_ref"			=>	$PHP_ref,
                        "PHP_factory"		=>	$PHP_factory,
                        'SCH_wi'			=>	$SCH_wi,
                        'SCH_close'			=>	$SCH_close,
                        'SCH_pend'			=>	$SCH_pend,
                        'SCH_pttnd'			=>	$SCH_pttnd,
                        'SCH_fab'			=>	$SCH_fab,
                        'SCH_acc'			=>	$SCH_acc,
                        'SCH_ptno'			=>	$SCH_ptno,
                        'SCH_ptdu'			=>	$SCH_ptdu,
                        'SCH_usmp'			=>	$SCH_usmp,
                        'SCH_smpdu'			=>	$SCH_smpdu,
                        'SCH_qty'			=>	$SCH_qty,
                        'SCH_ie'			=>	$SCH_ie,
                        'SCH_mk'			=>	$SCH_mk,
                        'SCH_smpl_type'		=>	$SCH_smpl_type,
                        "PHP_op_str"		=>	$PHP_op_str,
                        "PHP_op_fsh"		=>	$PHP_op_fsh,
                        "PHP_sr_startno"	=>	$PHP_sr_startno,
                        "PHP_action"		=>	$PHP_action
    );			
} else {
    if(isset($PHP_sr_startno))$sch_parm['PHP_sr_startno'] = $PHP_sr_startno;
}

$login_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];
// search 訂單為 supplier 呈現的部份 [ status < 4 ]
//	status : 0 : W/I wait		status : 1 : PTTN wait
//	status : 2 : FAB wait		status : 3 : ACC wait
//	status : 4 : PTTN schdl		status : 5 : SMPL schdl
//	status : 6 : DEVELOPING
//	status : 7 : PENDING
//  status : 10: case close

// status  > 0 

if (!$op = $smpl_ord->output_search(1, $sch_parm['PHP_dept_code'])) {  
    $op['msg']= $smpl_ord->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}
// 檢查 相片是否存在 2007.03.23		
for ($i=0; $i < sizeof($op['sorder']); $i++)
{
$op['sorder'][$i] = $smpl_ord->get($op['sorder'][$i]['id']);

if(file_exists($GLOBALS['config']['root_dir']."/smpl_pic/s_".$op['sorder'][$i]['num'].".jpg")){
    $op['sorder'][$i]['main_pic'] = "./smpl_pic/s_".$op['sorder'][$i]['num'].".jpg";
} else {
    $op['sorder'][$i]['main_pic'] = "./images/graydot.gif";
}
$img_size = GetImageSize($op['sorder'][$i]['main_pic']);
if ($img_size[0] < $img_size[1]) $op['sorder'][$i]['height'] = 1;

}

$op['dept_id'] = $sch_parm['PHP_dept_code'];
$op['today'] = $GLOBALS['TODAY'];  // 用為html判斷

$op['msg']= $smpl_ord->msg->get(2);

page_display($op, "016", $TPL_SMPL_OUTPUT_LIST);			
break;



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 24V sample OUTPUT view
#		case "smpl_output_view":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "smpl_output_view":
check_authority("016","view");

if(isset($PHP_id))
{
    $op['order'] = $smpl_ord->get($PHP_id);  //取出該筆記錄
}else{
    $op['order'] = $smpl_ord->get('','',$PHP_smpl_num);  //取出該筆記錄
}
if (!$op['order']) {
    $op['msg'] = $smpl_ord->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}
        
$parm = array(
    "id"		=>  $PHP_id,
    "num"		=>  $PHP_num,
    "pttn_date"	=>	$PHP_pttn_date,
);

//---- 更改 status 記錄 ------
$parm['status'] = ($op['order']['schd_smpl'] <> '0000-00-00') ?  6 : 5;

if(!$PHP_pttn_date){   //輸入項 檢查
    $op['msg'] = $smpl_ord->msg->get(2);
} else {
    if (!$A = $smpl_ord->add_pttn_schedule($parm)){
        $op['msg'] = $smpl_ord->msg->get(2);
        $layout->assign($op);
        $layout->display($TPL_ERROR);  		    
        break;
    }

    $op['msg'][] = $message = " ADD Pattern Schedule of #".$parm['num']." by : ".$parm['pttn_date'];
            # 記錄使用者動態
    $log->log_add(0,"28A",$message);
}
        
        
		// 檢查 相片是否存在 2007.03.23
		if(file_exists($GLOBALS['config']['root_dir']."/smpl_pic/".$op['order']['num'].".jpg")){
			$op['main_pic'] = "./smpl_pic/".$op['order']['num'].".jpg";
		} else {
			$op['main_pic'] = "./images/graydot.gif";
		}

	//----- 計算 訂單 IE(SPT) 與上一版(同訂單)的 IE(SPT)的差異值 $diff
		$last_v = substr($op['order']['num'],10)-1;
		$last = substr($op['order']['num'],0,10).$last_v;
	
		if($last_v ==0){
			$op['diff'] = 100;
		}else{
			if (!$last_spt = $smpl_ord->get_fieldvalue('','spt', $last)) {
				$op['msg'] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			if($last_spt['spt']){
				$op['diff'] = ($op['order']['spt']/$last_spt['spt']) * 100;
			}else{
				$op['diff'] = 100;
			}
		}
	//---------------------- end of SPT treating -----------------------------

		// 取出 smpl_log 本訂單 之歷史50筆的計記錄  -------------------
		$logs = $smpl_log->search50($op['order']['num']); 
		if (!$logs){
			$op['msg'] = $smpl_log->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['logs'] = $logs['log'];
		$op['log_records'] = $logs['records'];
		// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來判斷有無資料
		//--------------------------------
		
		$parm = $op['order'];

		// 加入返回前頁 --------------
		
	
		$op['back_str'] = $op['back_str2'] = 'PHP_action=smpl_ord_view';
		$op['msg'] = $smpl_ord->msg->get(2);
		if(isset($PHP_msg))$op['msg'][] = $PHP_msg;


		$op['search'] = '1';

		// creat LOG SUBJ combo box
		$op['logs_subj'] = $arry2->select($SMPL_LOG_SUBJ,'','PHP_subj','select','');  	
		$op['fty_select'] = $arry2->select($SAMPLER,$op['order']['factory'],'PHP_fty','select',''); 

		$img_size = GetImageSize($op['main_pic']);
		if ($img_size[0] < $img_size[1]) $op['height'] = 1;

//增加前面版本連結
		$tmp_id = substr($op['order']['num'],-1,1);
		$smpl = substr($op['order']['num'],0,-2);
		if ($tmp_id > 1)
		{
			for ($i=1; $i< $tmp_id; $i++)
			{
				$op['ver_num'][($i-1)] = $smpl."-".$i;
			}
			$op['ver_show'] =$i;
		}	

		$smpl=substr($op['order']['num'],0,9);
		if (!$op['ord_link']= $order->smpl_search($smpl))
		{
			$op['ord_link_non']=1;
		}		
		
		$line = $smpl_sch->get_ord_line($op['order']['num']);
		$line_value = $line_key = array();
		for($i=0; $i < sizeof($line); $i++)
		{
			$line_value[] = $line[$i]['line'];
			$line_key[] = $line[$i]['id'];
		}
		$op['line_select'] = $arry2->select($line_value,'','PHP_line','select','',$line_key);
		
		$op['smpl_out'] = $smpl_output->search_output($op['order']['num']);
		
		page_display($op, "016", $TPL_SMPL_OUTPUT_SHOW);			
		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 29E sample SCHEDULE arrangement for SAMPLE
#		case "smpl_smpl_schd":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "edit_smpl_smpl_schd":

		check_authority("016","edit");

		$parm = array(	"id"				=>  $PHP_id,
										"num"				=>  $PHP_num,
										"smpl_date"	=>	$PHP_smpl_date,
										'status'		=>	6
				);
		//----- 取出該筆記錄
		if (!$A = $smpl_ord->add_smpl_schedule($parm)){
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
	}
	
		$message = " ADD Sample Schedule of ".$parm['num']." by : ".$parm['smpl_date'];				
		$log->log_add(0,"016E",$message); # 記錄使用者動態

	$redir_str = 'index2.php?PHP_action=smpl_output_view&PHP_id='.$PHP_id.'&PHP_msg='.$message;
	redirect_page($redir_str);		



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 29E sample SCHEDULE arrangement for PATTERN
#		case "edit_smpl_pttn_schd":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "edit_smpl_pttn_schd":
check_authority("016","edit");

$parm = array(
    "id"			=>  $PHP_id,
    "num"		    =>  $PHP_num,
    "pttn_date"	    =>	$PHP_pttn_date,
    'status'		=>	6
);

if (!$A = $smpl_ord->add_pttn_schedule($parm)){
    $op['msg'] = $smpl_ord->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}

$message = " ADD Pattern Schedule of ".$parm['num']." by : ".$parm['pttn_date'];
# 記錄使用者動態
$log->log_add(0,"016E",$message);

$redir_str = 'index2.php?PHP_action=smpl_output_view&PHP_id='.$PHP_id.'&PHP_msg='.$message;
redirect_page($redir_str);		


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "update_smpl_fty":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "update_smpl_fty":

		check_authority("016","edit");

		$parm = array(	"id"					=>  $PHP_id,
										"field_name"	=>  'factory',
										"field_value"	=>	$PHP_fty,
				);


		$smpl_ord->update_field($parm);

		$message = " Change factory of ".$PHP_num." by : ".$PHP_fty;
				# 記錄使用者動態
		$log->log_add(0,"29E",$message);

	$redir_str = 'index2.php?PHP_action=smpl_output_view&PHP_id='.$PHP_id.'&PHP_msg='.$message;
	redirect_page($redir_str);		

	
	
	
	
	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 24A sample pattern upload
#		case "upload_smpl_pattern":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "upload_smpl_pattern":

		check_authority("016","add");

		$filename = $_FILES['PHP_pttn']['name'];
		$ext =  strtolower(preg_replace("/.*\.([^.]+)$/","\\1", $filename));

		if ($ext == "mdl" || $ext == "zip"){   // 上傳檔的副檔名為 mdl 時 -----

			// upload pattern file to server
			$pttn_name = $PHP_num.'.mdl';  // 指定為 mdl 副檔名
			$upload = new Upload;
			//$upload->uploadFile(dirname($PHP_SELF).'/smpl_pttn/', 'pattern', 16, $pttn_name );
			$upload->uploadFile(dirname(__FILE__).'\smpl_pttn\\', 'pattern', 16, $pttn_name );
			if (!$upload){
				$op['msg'][] = $upload;
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			$today = $GLOBALS['TODAY'];
			$parm = array(	"done_pttn"		=>  $today,
				"last_update"	=>  $today,
				"updator"		=>  $GLOBALS['SCACHE']['ADMIN']['login_id'],
				"id"			=>  $PHP_id,
			);
			if (!$A = $smpl_ord->upload_pttn($parm)){
				$op['msg'] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			$message = "UPLOAD Pattern of ".$PHP_num;
		} else {  // 上傳檔的副檔名  不是  mdl 時 -----

			$message = "upload file is incorrect format ! Please re-send.";
		}
		
		
		
			$redir_str = 'index2.php?PHP_action=smpl_output_view&PHP_id='.$PHP_id.'&PHP_msg='.$message;
			redirect_page($redir_str);		

	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 29A sample marker upload     --- 
#		case "upload_smpl_marker":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "upload_smpl_marker":

		check_authority("016","add");

		$filename = $_FILES['PHP_marker']['name'];
		$ext =  strtolower(preg_replace("/.*\.([^.]+)$/","\\1", $filename));

		if ($ext == "pdf"){   // 上傳檔的副檔名為 mdl 時 -----
			// upload marker file to server  // 指定為 pdf 副檔名
			$marker_name = $PHP_num.'.mk'.'.pdf';
			$upload = new Upload;
			$upload->uploadFile(dirname($PHP_SELF).'/smpl_marker/', 'marker', 16, $marker_name );
			if (!$upload){
				$op['msg'][] = $upload;
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			$today = $GLOBALS['TODAY'];
			$parm = array(	"marker_date"	=>  $today,
											"last_update"	=>  $today,
											"updator"			=>  $GLOBALS['SCACHE']['ADMIN']['login_id'],
											"id"					=>  $PHP_id,
			);

			if (!$A = $smpl_ord->upload_marker($parm)){
				$op['msg'] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			$message = "UPLOAD Marker of ".$PHP_num;

		} else {  // 上傳檔的副檔名  不是  mdl 時 -----

			$message = "upload MARKER file is incorrect format, Please re-send.";
		}
		
			$redir_str = 'index2.php?PHP_action=smpl_output_view&PHP_id='.$PHP_id.'&PHP_msg='.$message;
			redirect_page($redir_str);		
		




#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 29V sample pattern download
#		case "smpl_pttn_download":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "smpl_pttn_download":

		if(!$admin->is_power("008","view")  && !$admin->is_power("016","view")){ 
			$op['msg'][] = "sorry! you don't have this Authority!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		// path example
		$myPath = './smpl_pttn/';

		// New Object
		$objDownload = new EasyDownload();

		// Set physical path
		$objDownload->setPath($myPath);

		// Set file name on the server (real full name)
		//$objDownload->setFileName($_GET["file"]);
		$objDownload->setFileName($PHP_num. '.mdl');

		// In case that it does not desire to effect download with original name.  
		// It configures the alternative name
		//$objDownload->setFileNameDown($_GET["fileName"] . $_GET["extension"]);
		$objDownload->setFileNameDown($PHP_num.'.mdl');

		// get file
		$objDownload->Send();

	break;

	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 24V sample MARKER download
#		case "smpl_marker_download":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "smpl_marker_download":

		if(!$admin->is_power("008","view")  &&  !$admin->is_power("016","view")){ 
			$op['msg'][] = "sorry! you don't have this Authority!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		// path example
		$myPath = './smpl_marker/';

		// New Object
		$objDownload = new EasyDownload();

		// Set physical path
		$objDownload->setPath($myPath);

		// Set file name on the server (real full name)
		//$objDownload->setFileName($_GET["file"]);
		$objDownload->setFileName($PHP_num. '.mk'.'.pdf');

		// In case that it does not desire to effect download with original name.  
		// It configures the alternative name
		//$objDownload->setFileNameDown($_GET["fileName"] . $_GET["extension"]);
		$objDownload->setFileName($PHP_num. '.mk'.'.pdf');

		// get file
		$objDownload->Send();

	break;
	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# job 24A smpl output @Mode Close
# case "smpl_complete":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "smpl_complete_ModeClose":
check_authority("016","add");

$today = $GLOBALS['TODAY'];
$parm = array(
    "id"            =>  $PHP_id,
    "qty"			=>  $PHP_qty,
    'line_id'		=>	$PHP_line,
    "fdate"			=>  $GLOBALS['TODAY'],
    "num"			=>  $PHP_num,
    "last_update"	=>  $GLOBALS['TODAY'],
    "updator"		=>  $GLOBALS['SCACHE']['ADMIN']['login_id'],
    "factory"		=>  $PHP_factory,
);

// 加入 smpl_output 表單記錄
if (!$C = $smpl_output->add($parm)){
    $op['msg'] = $smpl_output->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}

//  更新 smpl_ord 內的完成數量
if (!$A = $smpl_ord->add_complete($parm)){
    $op['msg'] = $smpl_ord->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}
$smpl_sch->reload_schedule($PHP_line, $PHP_num);

$message = "add complete qty :".$PHP_qty." of ".$PHP_num;
//----------------------------------------------------
$log->log_add(0,"29E",$message);

$redir_str = 'index2.php?PHP_action=smpl_output_view&PHP_id='.$PHP_id.'&PHP_msg='.$message;
redirect_page($redir_str);



	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 29E  case_close
#		case "smpl_case_close":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "smpl_case_close":
    check_authority("016","edit");

		$today = $GLOBALS['TODAY'];
		$ptn_Name=$_GET['PHP_patternName'];
		$parm = array(	"id"			=>  $PHP_id,
				"case_close"	=>  $GLOBALS['TODAY'],
				"last_update"	=>  $GLOBALS['TODAY'],
				"updator"		=>  $GLOBALS['SCACHE']['ADMIN']['login_id'],
				"status"		=>  10,
		);

		//  更新 smpl_ord 內的 記錄
		if (!$A = $smpl_ord->case_close($parm)){
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$message = " close-case of ".$PHP_num;
		//----------------------------------------------------
		$log->log_add(0,"29E",$message);

			if($ptn_Name=='sample_ord_show')
			{
				/* $redir_str = 'index2.php?PHP_action=smpl_output_view&PHP_id='.$PHP_id.'&PHP_msg='.$message; */
				$redir_str = 'index2.php?PHP_action=show_sample_det&PHP_smpl_num='.$PHP_num;
			}
			else
			{
				$redir_str = 'index2.php?PHP_action=smpl_output_view&PHP_id='.$PHP_id.'&PHP_msg='.$message;
			}
			redirect_page($redir_str);		

	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 29E pttn_resend   重新傳送 pattern
#		case "pttn_resend":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "pttn_resend":

		check_authority("016","edit");

		$today = $GLOBALS['TODAY'];
		$parm = array(	"id"			=>  $PHP_id,
				"done_pttn"		=>  '0000-00-00',
				"last_update"	=>  $today,
				"updator"		=>  $GLOBALS['SCACHE']['ADMIN']['login_id'],
		);
		$P = $smpl_ord->pttn_resend($parm);  // 重新送版
		if (!$P) {
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$message = "DEL exist pattern for resend for ".$PHP_num.'&PHP_msg='.$message;
		$log->log_add(0,"29E",$message);

		$redir_str = 'index2.php?PHP_action=smpl_output_view&PHP_id='.$PHP_id;
		redirect_page($redir_str);	


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 29E marker_resend   重新傳送 MARKER 
#		case "marker_resend":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "marker_resend":

		check_authority("016","edit");

		$today = $GLOBALS['TODAY'];
		$parm = array(	"id"			=>  $PHP_id,
				"marker_date"	=>  '0000-00-00',
				"last_update"	=>  $today,
				"updator"		=>  $GLOBALS['SCACHE']['ADMIN']['login_id'],
		);
		$P = $smpl_ord->marker_resend($parm);  // 重新送MARK
		if (!$P) {
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$message = "DEL exist MARKER for resend for ".$PHP_num;
		$log->log_add(0,"29E",$message);

		$redir_str = 'index2.php?PHP_action=smpl_output_view&PHP_id='.$PHP_id.'&PHP_msg='.$message;
		redirect_page($redir_str);		


	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 29A ADD SMPL SPT    填入 SPT ( IE) 
//		case "smpl_SPT":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "smpl_spt":

		check_authority("016","add");

		$today = $GLOBALS['TODAY'];

		$PHP_IE = number_format(($PHP_spt/$GLOBALS['IE_TIME']),2,'.','');
			
		$parm = array(	"id"	=>  $PHP_id,
				"spt"			=>  $PHP_spt,
				"ie"			=>  $PHP_IE,
				"last_update"	=>  $today,
				"updator"		=>  $GLOBALS['SCACHE']['ADMIN']['login_id'],
		);

		$P = $smpl_ord->add_spt($parm);  // 加入 spt
		if (!$P) {
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$message = " Add SPT :".$PHP_spt." for ".$PHP_num;
		$log->log_add(0,"29A",$message);

		
		$redir_str = 'index2.php?PHP_action=smpl_output_view&PHP_id='.$PHP_id.'&PHP_msg='.$message;
		redirect_page($redir_str);		


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 21A sample oreder apprval
#		case "smpl_appval":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "smpl_appval":		
		check_authority("008","add");
	
		// 資料庫要修改的參數 ----
		$PHP_smpl_ord=substr($PHP_num,0,9);
		$smpl=$smpl_ord->get(0,0,$PHP_smpl_ord);		
		$parm['num']		= $PHP_smpl_ord;
		$parm['field_name'] = 'apv_date';
		$parm['field_value']= $TODAY;
				
//*****//2006.12.19增加order的smpl_approval start
		$U = $order->update_smpl_apv_det($PHP_smpl_ord,$smpl['spt']);

//*****//2006.12.19增加order的smpl_approval end
		
		if (!$U = $smpl_ord->update_apv($parm)){
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		

		

		$message = " Sample APPROVAL for :#".$PHP_smpl_ord;
		# 記錄使用者動態
		$log->log_add(0,"21A",$message);
		
		// 送出參數 ----- redir page
		$cgi = '&cgino='.$cgino.'&cgi_1='.$cgi_1.'&cgi_2='.$cgi_2.'&cgi_3='.$cgi_3.'&cgi_4='.$cgi_4.'&cgi_5='.$cgi_5."&cgi_6=".$cgi_6."&cgi_7=".$cgi_7."&cgi_8=".$cgi_8."&cgi_9=".$cgi_9."&cgi_10=".$cgi_10;
		
		$redir_str = 'index2.php?PHP_action=smpl_ord_view&PHP_id='.$PHP_id.'&cgiget='.$PHP_back.$cgi;
		redirect_page($redir_str);
		break;

		

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#	case "smpl_fa":	job 22 sample的主副料加入
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "smpl_fa":

		check_authority("009","view");

		$where_str = $manager = $dept_id = '';
		$dept_ary = array();

		$sales_dept_ary = get_sales_dept(); //  [不含K0] ------
		
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept']; 
		$user_team = $GLOBALS['SCACHE']['ADMIN']['team_id'];
		
		for ($i=0; $i<count($sales_dept_ary);$i++){
			if($user_dept == $sales_dept_ary[$i]){
				// 如果是業務部進入 則dept_code 指定該業務部---
				$dept_id = $sales_dept_ary[$i];  
			}
		}
		if (!$dept_id || $user_team<>'MD')   $manager = 1;  // 當不是業務部人[也不含 K0 的人 ]進入時
		
		
		$op['manager_flag'] = $manager;
		$op['dept_id'] = $dept_id;
		
		// creat cust combo box	 取出 客戶代號
		$where_str=$where_str."order by cust_s_name"; //依cust_s_name排序
		$cust_def = $cust->get_fields('cust_init_name',$where_str);
		$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
		for ($i=0; $i< sizeof($cust_def); $i++) $cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現

		$op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue); 

		// ------ 決定 factory 的參數 = 陣列? 數值?  RD人員進入時有差別 ----
		if($S = $smpl_ord->is_sample_team($user_team)){
			$op['factory'] = $user_team."<input type='hidden' name='PHP_factory' value='".$user_team."'>";
		}else{
			$op['factory'] = $arry2->select($SAMPLER,'','PHP_factory','select','');  	
		}
		if($user_team=="RD"){
			$op['factory'] = $user_dept."<input type='hidden' name='PHP_factory' value='".$user_dept."'>";
		}
		// --------------------------------------------------------------------

//080725message增加		
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];


		page_display($op, "009", $TPL_SMPL_FA);			
		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "smpl_fa_search":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "smpl_fa_search":

		check_authority("009","view");

		$parm = array(	"dept"		=>  $PHP_dept_code,
						"num"		=>  $PHP_num,
						"cust"		=>	$PHP_cust,
						"ref"		=>	$PHP_ref,
						"factory"	=>	$PHP_factory,
						"etdstr"	=>	$PHP_etdstr,
						"etdfsh"	=>	$PHP_etdfsh
				);

		// ---- 利用PHP_dept_code判定是否 業務部門進入
		if (!$op = $smpl_ord->fa_search(1, $PHP_dept_code)) {  
			$op['msg']= $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		// 檢查 相片是否存在 2007.03.23		
	for ($i=0; $i < sizeof($op['sorder']); $i++)
	{
		if(file_exists($GLOBALS['config']['root_dir']."/smpl_pic/s_".$op['sorder'][$i]['num'].".jpg")){
			$op['sorder'][$i]['main_pic'] = "./smpl_pic/s_".$op['sorder'][$i]['num'].".jpg";
		} else {
			$op['sorder'][$i]['main_pic'] = "./images/graydot.gif";
		}
		$img_size = GetImageSize($op['sorder'][$i]['main_pic']);
		if ($img_size[0] < $img_size[1]) $op['sorder'][$i]['height'] = 1;
	
	
	}
		// ---- 如果 不是 呈辦業務部門進入時...
		if (!$PHP_dept_code) {   
			$op['manager_flag'] = 1;
		}

		$op['dept_id'] = $PHP_dept_code;
		$back_str = "&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str'] = $back_str;
		$op['msg']= $smpl_ord->msg->get(2);
		$op['cgi']= $parm;

		page_display($op, "009", $TPL_SMPL_FA_LIST);			
		break;



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 21V sample oreder view
#		case "smpl_ord_view":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "smpl_fa_view":
check_authority("009","view");

$op['order'] = $smpl_ord->get($PHP_id);  //取出該筆記錄
if (!$op['order']) {
	$op['msg'] = $order->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}

//size由scale變成id的儲存
$size_data=$size_des->get($op['order']['size']);
$op['order']['size_id']=$op['order']['size'];		
$op['order']['size']=$size_data['size_scale'];

		// 檢查 相片是否存在 2007.03.23
if(file_exists($GLOBALS['config']['root_dir']."/smpl_pic/".$op['order']['num'].".jpg")){
	$op['main_pic'] = "./smpl_pic/".$op['order']['num'].".jpg";
} else {
	$op['main_pic'] = "./images/graydot.gif";
}
$img_size = GetImageSize($op['main_pic']);
if ($img_size[0] < $img_size[1]) $op['height'] = 1;

//		$op['back_str'] = $PHP_back_str;
// 取出 smpl_log 本訂單 之歷史50筆的計記錄  -------------------
$logs = $smpl_log->search50($op['order']['num']);  //取出該訂單全部log記錄
if (!$logs){
	$op['msg'] = $smpl_log->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}

//主副料取得-------------------------------------------------------------
$where_str="where smpl_code='".$op['order']['num']."'";
$op['fab'] = $smplord_lots->search(0,$where_str);  //取出該筆主料記錄			
if (!isset($op['fab'][0])) {
	$op['fab']['msg']="No  Fabric record";
}

$op['acc'] = $smplord_acc->search(0,$where_str);  //取出該筆副料記錄		
if (!isset($op['acc'][0])) {
	$op['acc']['msg']="No Accessory record";
}

$op['logs'] = $logs['log'];
$op['log_records'] = $logs['records'];
// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來判斷有無資料
//--------------------------------

$parm = $op['order'];

// 加入返回前頁 --------------
$back_str = "&PHP_sr_startno=".$cgino."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
$op['back_str'] = $back_str;

$op['msg'] = $smpl_ord->msg->get(2);
$op['search'] = '1';
$op['now_pp']=$cgino;
page_display($op, "009", $TPL_SMPL_FA_SHOW);			
break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "smpl_fa_edit":	
		check_authority("009","edit");	
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];	
		$op['order'] = $smpl_ord->get($PHP_id);  //取出該筆記錄
		if (!$op['order']) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
				//size由scale變成id的儲存
		$size_data=$size_des->get($op['order']['size']);
		$op['order']['size_id']=$op['order']['size'];		
		$op['order']['size']=$size_data['size_scale'];
		
		//檢視是否可以修改size(即是否存在colorway)
		if ($smpl_wi->check_size($op['order']['num']))
		{
			$op['size_edit']=1;
		}
//		$op['size_edit']=1;
//主副料取得-------------------------------------------------------------
		$where_str="where smpl_code='".$op['order']['num']."'";
		$op['fab'] = $smplord_lots->search(0,$where_str);  //取出該筆主料記錄			
		if (!isset($op['fab'][0])) {
			$op['fab']['msg']="No  Fabric record";
		}else{
			for ($i=0; $i<sizeof($op['fab']); $i++)
				$op['fab'][$i]['unit_select'] = $arry2->select($LOTS_PRICE_UNIT,$op['fab'][$i]['unit'],'PHP_unit','select','');
		}
		
		$op['acc'] = $smplord_acc->search(0,$where_str);  //取出該筆副料記錄		
		if (!isset($op['acc'][0])) {
			$op['acc']['msg']="No Accessory record";
		}else{
			for ($i=0; $i<sizeof($op['acc']); $i++)
				$op['acc'][$i]['unit_select'] = $arry2->select($ACC_PRICE_UNIT,$op['acc'][$i]['unit'],'PHP_unit','select','');
		}

		$op['msg'] = $smpl_ord->msg->get(2);
		
//*****//2007.03.02 在sample中加入size之下拉式 start
		$where_str =" WHERE dept ='".$op['order']['dept']."' and cust='".$op['order']['cust']."' ";
		$size_def = $size_des->get_fields('size_scale',$where_str);   // 取出 尺吋
		if (!isset($size_def[0]))$size_def[0]="";
		$op['size_select'] =  $arry2->select($size_def,$op['order']['size'],'PHP_size','select','');
		$op['use_select']	=	$arry2->select($USAGE_METHOD,'','PHP_use_method','select','');
		$op['fab_unit']	=	$arry2->select($LOTS_PRICE_UNIT,'','PHP_unit','select','');
		$op['acc_unit']	=	$arry2->select($ACC_PRICE_UNIT,'','PHP_unit','select','');
		$op['acc_name'] = $arry2->select($ACC,'','PHP_name','select','');

//*****//2007.03.02 在sample中加入size之下拉式 end

		if (isset($PHP_msg))	$op['msg'][]=$PHP_msg;	//別頁導入之message
		
		$op['search'] = '1';
				// 加入返回前頁 2005/05/05
		if (isset($PHP_back_str))
		{
			$op['back_str'] = $PHP_back_str;
		}else{
			$back_str = "&PHP_sr_startno=".$cgino."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
			$op['back_str'] = $back_str;
		}
		$op['now_pp']=$cgino;
		page_display($op, "009", $TPL_SMPL_FA_EDIT);		
		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "do_smpl_fa_update":	
		check_authority("009","edit");
		
		if(strstr($PHP_use_for,'&#'))
		{
			$PHP_use_for = $ch_cov->check_cov($PHP_use_for);
		}
			
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];
		if (!$PHP_unit) $PHP_unit=$PHP_old_unit;

		if ($PHP_item=='fab')
		{
			$parm=array($PHP_item_id,'unit',$PHP_unit);
			$smplord_lots->update_field($parm);
			
			$parm=array($PHP_item_id,'use_for',$PHP_use_for);
			$smplord_lots->update_field($parm);
		}
		
		if ($PHP_item=='acc')
		{
			$parm=array($PHP_item_id,'unit',$PHP_unit);
			$smplord_acc->update_field($parm);
			
			$parm=array($PHP_item_id,'use_for',$PHP_use_for);
			$smplord_acc->update_field($parm);
			
			if (!isset($PHP_main))$PHP_main=0;
			$parm=array($PHP_item_id,'acc_cat',$PHP_main);
			$smplord_acc->update_field($parm);
		}
			
		$op['order'] = $smpl_ord->get($PHP_id);  //取出該筆記錄
		if (!$op['order']) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
				//size由scale變成id的儲存
		$size_data=$size_des->get($op['order']['size']);
		$op['order']['size_id']=$op['order']['size'];		
		$op['order']['size']=$size_data['size_scale'];
		
		//檢視是否可以修改size(即是否存在colorway)
		if ($smpl_wi->check_size($op['order']['num']))
		{
			$op['size_edit']=1;
		}
		$op['size_edit']=1;
		$op['back_str'] = $PHP_back_str;
		$op['now_pp']=$cgino;
//主副料取得-------------------------------------------------------------
		$where_str="where smpl_code='".$op['order']['num']."'";
		$op['fab'] = $smplord_lots->search(0,$where_str);  //取出該筆主料記錄			
		if (!isset($op['fab'][0])) {
			$op['fab']['msg']="No  Fabric record";
		}else{
			for ($i=0; $i<sizeof($op['fab']); $i++)
				$op['fab'][$i]['unit_select'] = $arry2->select($LOTS_PRICE_UNIT,$op['fab'][$i]['unit'],'PHP_unit','select','');
		}
		
		$op['acc'] = $smplord_acc->search(0,$where_str);  //取出該筆副料記錄		
		if (!isset($op['acc'][0])) {
			$op['acc']['msg']="No Accessory record";
		}else{
			for ($i=0; $i<sizeof($op['acc']); $i++)
				$op['acc'][$i]['unit_select'] = $arry2->select($ACC_PRICE_UNIT,$op['acc'][$i]['unit'],'PHP_unit','select','');
		}

		$op['msg'] = $smpl_ord->msg->get(2);
		
//*****//2007.03.02 在sample中加入size之下拉式 start
		$where_str =" WHERE dept ='".$op['order']['dept']."' and cust='".$op['order']['cust']."' ";
		$size_def = $size_des->get_fields('size_scale',$where_str);   // 取出 尺吋
		if (!isset($size_def[0]))$size_def[0]="";
		$op['size_select'] =  $arry2->select($size_def,$op['order']['size'],'PHP_size','select','');
		$op['use_select']	=	$arry2->select($USAGE_METHOD,'','PHP_use_method','select','');
		$op['fab_unit']	=	$arry2->select($LOTS_PRICE_UNIT,'','PHP_unit','select','');
		$op['acc_unit']	=	$arry2->select($ACC_PRICE_UNIT,'','PHP_unit','select','');
		$op['acc_name'] = $arry2->select($ACC,'','PHP_name','select','');

//*****//2007.03.02 在sample中加入size之下拉式 end

		$message="success update sample order:".$op['order']['num'].$PHP_item.":".$PHP_item_name;
		$op['msg'][]=$message;
		$log->log_add(0,"22A",$message);
		$op['search'] = '1';
				// 加入返回前頁 2005/05/05
		$op['back_str'] = $PHP_back_str;
		page_display($op, "009", $TPL_SMPL_FA_EDIT);		
		break;
		

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "do_smpl_des_fab":	
check_authority("009","edit");

if(strstr($PHP_des_fab,'&#'))
{
	$PHP_des_fab = $ch_cov->check_cov($PHP_des_fab);
}

$parm = array(
	'field_name'	=>	'des_fab',
	'field_value'	=>	$PHP_des_fab,
	'id'			=>	$PHP_id
);

$f1 = $smpl_ord->update_field($parm); 

$message="success update fabric log for sample order:".$op['order']['num'];
$log->log_add(0,"009A",$message);

$redir_str = "index2.php?PHP_action=smpl_fa_edit&PHP_id=".$PHP_id."&PHP_msg=".$message;
redirect_page($redir_str);	
break;



//=======================================================
    case "do_smpl_fa_edit":
		check_authority("009","edit");
		$user_name = $GLOBALS['SCACHE']['ADMIN']['name'];   // 判定進入身份的指標
		$date = date('Y-m-d');
		if (!isset($PHP_main))$PHP_main=0;
		
		if(strstr($PHP_use_for,'&#'))
		{
			$PHP_use_for = $ch_cov->check_cov($PHP_use_for);
		}	
		
		$parm = array(	"name"				=>	$PHP_name,
										"num"					=>	$PHP_smpl_num,
										"smpl_code"		=>	$PHP_smpl_code,
										"unit"				=>	$PHP_unit,
										"est"					=>	$PHP_est,
										"use_method"	=>	'',
										"use_for"			=>	$PHP_use_for,
										"user"				=>	$user_name,
										"acc_cat"			=>	$PHP_main,
										"add_date"		=>	$date,
										"select"			=>	1
			);
			if ($PHP_name = 'hook' && isset($bar)) $parm['name'] = "hook&bar";
		if ($PHP_item=='fab')	$f1 = $smplord_lots->add($parm);
		if ($PHP_item=='acc')	$f1 = $smplord_acc->add($parm);
		if ($f1)
		{
			if ($PHP_item=='fab')	$message= "Sueess add fabric:".$parm['num']."on order:".$parm['smpl_code'];
			if ($PHP_item=='acc')	$message= "Sueess add accessory:".$parm['num']."on order:".$parm['smpl_code'];
					# 記錄使用者動態
			$log->log_add(0,"22A",$message);
			$op['fab_unit']	=	$arry2->select($LOTS_PRICE_UNIT,'','PHP_unit','select','');
			$op['acc_unit']	=	$arry2->select($ACC_PRICE_UNIT,'','PHP_unit','select','');
			$op['acc_name'] = $arry2->select($ACC,'','PHP_name','select','');
		}else{
			if ($PHP_item=='fab')	$msg=$smplord_lots->msg->get(2);
			if ($PHP_item=='acc')	$msg=$smplord_acc->msg->get(2);
			$message=$msg[0];
			if ($PHP_item=='fab')	$op['fab_un_add'] = $parm;
			if ($PHP_item=='acc')	$op['acc_un_add'] = $parm;
			$op['fab_unit']	=	$arry2->select($LOTS_PRICE_UNIT,$PHP_unit,'PHP_unit','select','');
			$op['acc_unit']	=	$arry2->select($ACC_PRICE_UNIT,$PHP_unit,'PHP_unit','select','');
			$op['acc_name'] = $arry2->select($ACC,$PHP_name,'PHP_name','select','');
		}
		
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];	
		$op['order'] = $smpl_ord->get($PHP_id);  //取出該筆記錄
		if (!$op['order']) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
						//size由scale變成id的儲存
		$size_data=$size_des->get($op['order']['size']);
		$op['order']['size_id']=$op['order']['size'];		
		$op['order']['size']=$size_data['size_scale'];
		
		//檢視是否可以修改size(即是否存在colorway)
		if ($smpl_wi->check_size($op['order']['num']))
		{
			$op['size_edit']=1;
		}
		if (isset($PHP_back_str))
		{
			$op['back_str'] = $PHP_back_str;
		}else{
			$back_str = "&PHP_sr_startno=".$PHP_sr_startno."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
			$op['back_str'] = $back_str;
		}			
	$op['now_pp']=$PHP_sr_startno;
		
//主副料取得-------------------------------------------------------------
		$where_str="where smpl_code='".$op['order']['num']."'";
		$op['fab'] = $smplord_lots->search(0,$where_str);  //取出該筆主料記錄			
		if (!isset($op['fab'][0])) {
			$op['fab']['msg']="No  Fabric record";
		}else{
			for ($i=0; $i<sizeof($op['fab']); $i++)
				$op['fab'][$i]['unit_select'] = $arry2->select($LOTS_PRICE_UNIT,$op['fab'][$i]['unit'],'PHP_unit','select','');
		}
		
		$op['acc'] = $smplord_acc->search(0,$where_str);  //取出該筆副料記錄		
		if (!isset($op['acc'][0])) {
			$op['acc']['msg']="No Accessory record";
		}else{
			for ($i=0; $i<sizeof($op['acc']); $i++)
				$op['acc'][$i]['unit_select'] = $arry2->select($ACC_PRICE_UNIT,$op['acc'][$i]['unit'],'PHP_unit','select','');
		}

		$op['msg'][] = $message;

		$op['use_select']	=	$arry2->select($USAGE_METHOD,'','PHP_use_method','select','');

		page_display($op, "009", $TPL_SMPL_FA_EDIT);		
		break;

//=======================================================			
    case "smpl_fab_del_ajx":		
		check_authority("009","edit");
		if ($PHP_item=='fab')	$f1 = $smplord_lots->del($PHP_lots_id);
		if ($PHP_item=='acc')	$f1	= $smplord_acc->del($PHP_lots_id);
		
		if ($f1)
		{
			if ($PHP_item=='fab')	$message= "Sueess del fabric:".$PHP_lots_code."on order:".$PHP_order;
			if ($PHP_item=='acc')	$message= "Sueess del accessory:".$PHP_lots_code."on order:".$PHP_order;
					# 記錄使用者動態
			$log->log_add(0,"22A",$message);
		}else{
			if ($PHP_item=='fab')	$msg=$smpl_lots->msg->get(2);
			if ($PHP_item=='acc')	$msg=$smpl_acc->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
	echo $message;
	break;
	
	exit;

//=======================================================

	case "do_smpl_fa_edit_all":
		check_authority("009","edit");
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
		
		$op['order'] = $smpl_ord->get($PHP_id);  //取出該筆記錄
		if (!$op['order']) {
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$size_id=$PHP_size_id;				
		if ($PHP_size_id==0)		//size_des加入新的
		{
			$PHP_size_item = strtoupper($PHP_size_item);
			$PHP_size = strtoupper($PHP_size);		
			$parm=array(	'cust'			=>	$op['order']['cust'],
							'dept'			=>	$op['order']['dept'],
							'size'			=>	$PHP_size_item,
							'size_scale'	=>	$PHP_size
			);
			$size_id=$size_des->add($parm);
		}
		$parm = array(	'field_name'	=>	'size',
						'field_value'	=>	$size_id,
						'id'			=>	$PHP_id
		);
		$f1 = $smpl_ord->update_field($parm); 	//sample加入新size

		if ($f1)		//message
		{
			$message="successfully update sample order:".$op['order']['num'];
			$log->log_add(0,"22E",$message);
		}else{
			$msg[]=$smpl_ord->msg->get(2);
			$message=$msg[0];
		}
			
		//導向顯示頁
		$back_str = "index2.php?&PHP_action=smpl_fa_edit&cgino=".$PHP_sr_startno."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh."&PHP_msg=".$message."&PHP_id=".$PHP_id;
	
		redirect_page($back_str);
		break;

//=======================================================

	case "do_smpl_fa_edit_ajx":
		check_authority("009","edit");
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
		
		$op['order'] = $smpl_ord->get($PHP_id);  //取出該筆記錄

		$size_id=$PHP_size_id;				
		if ($PHP_size_id==0)		//size_des加入新的
		{
			$PHP_size_item = strtoupper($PHP_size_item);
			$PHP_size = strtoupper($PHP_size);		
			$parm=array(	'cust'			=>	$op['order']['cust'],
							'dept'			=>	$op['order']['dept'],
							'size'			=>	$PHP_size_item,
							'size_scale'	=>	$PHP_size,
							'base_size'		=>	$PHP_base_size,
							'check'			=>	1,
			);
			$size_id=$size_des->add($parm);
		}
		$parm = array(	'field_name'	=>	'size',
						'field_value'	=>	$size_id,
						'id'			=>	$PHP_id
		);
		$f1 = $smpl_ord->update_field($parm); 	//sample加入新size

		if ($f1)		//message
		{
			$message="successfully update sample order:".$op['order']['num'];
			$log->log_add(0,"22E",$message);
		}else{
			$msg[]=$smpl_ord->msg->get(2);
			$message=$msg[0];
		}
			
		$return_var=$PHP_size."|".$message;
		echo $return_var;
		exit;
		break;
//-------------------------------------------------------------------------------------
//			 job 22  製作令
//-------------------------------------------------------------------------------------
    case "smpl_wi":
    	check_authority("010","view");
		//2006/05/02 update
		$where_str = $manager = $dept_id = '';		 
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
		$team = $GLOBALS['SCACHE']['ADMIN']['team_id'];  // 判定進入身份的指標(team)
		$sales_dept_ary = get_sales_dept();// 取出 業務的部門 [不含K0] ------		
		for ($i=0; $i<count($sales_dept_ary);$i++){
			if($user_dept == $sales_dept_ary[$i]){
				// 如果是業務部進入 則dept_code 指定該業務部---
				$dept_id = $sales_dept_ary[$i]; 
				$op['dept_id'] = $dept_id;
			}
		}
		
		if (!$dept_id || $team<>'MD') $op['dept_id'] = $arry2->select($sales_dept_ary,"","PHP_dept_code","select","");     // 當不是業務部人[也不含 K0 的人 ]進入時


				
		// 如果是 manager 進入時...
		if (substr($op['dept_id'],0,7) == "<select"){
			$op['manager_flag'] = 1;
		}
		// creat cust combo box	 取出 客戶代號
		$where_str=$where_str."order by cust_s_name";
		$cust_def = $cust->get_fields('cust_init_name',$where_str); 
		$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);  
		for ($i=0; $i< sizeof($cust_def); $i++) $cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];

		$op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue); 


		$op['msg'] = $wi->msg->get(2);
		// creat sample type combo box
		$sample_def = $smpl_type->get_fields('smpl_type');   // 取出 樣本類別
		$op['smpl_type_select'] =  $arry2->select($sample_def,'','PHP_smpl_type','select','');  	

//080725message增加		
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];

	
		page_display($op, "010", $TPL_SMPL_WI_SEARCH);	    	    
		break;

//=======================================================
    case "smpl_wi_search":
		check_authority("010","view");
		
		if (!$op = $smpl_ord->fa_search(2, $PHP_dept_code)) {  
			$op['msg']= $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		
		for ($i=0; $i< sizeof($op['sorder']);$i++)
		{
			$tmp = substr($op['sorder'][$i]['num'],-1)-1;
			if ($tmp > 0)
			{
				$tmp1=substr($op['sorder'][$i]['num'],0,-1).$tmp;
				$op['sorder'][$i]['copy']=$tmp1;				
			}
			if(file_exists($GLOBALS['config']['root_dir']."/smpl_pic/".$op['sorder'][$i]['num'].".jpg")){
				$op['sorder'][$i]['main_pic'] = "./smpl_pic/".$op['sorder'][$i]['num'].".jpg";
			} else {
				$op['sorder'][$i]['main_pic'] = "./images/graydot.gif";
			}
			if ($op['sorder'][$i]['wi_id'])
			{
				$where_str = "WHERE wi_id = '".$op['sorder'][$i]['wi_id']."'";
				$op['sorder'][$i]['ti'] = $smpl_ti->get_fields('id',$where_str);
				$op['sorder'][$i]['bom_lots'] = $smpl_bom->get_fields_lots('id',$where_str);
				$op['sorder'][$i]['bom_acc'] =  $smpl_bom->get_fields_acc('id',$where_str);
			}
			
		}
		
		$op['dept_id'] = $PHP_dept_code;
		$back_str = "&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str'] = $back_str;
		$op['msg']= $smpl_ord->msg->get(2);


		//2006/05/02 update
		$op['dept_id'] = get_dept_id();
		
		// 如果是 manager 進入時...
		if (substr($op['dept_id'],0,7) == "<select"){
			$op['manager_flag'] = 1;
		}

			page_display($op, "010", $TPL_SMPL_WI);
		break;

//=======================================================
    case "smpl_wi_add":

		check_authority("010","add");

			$op['wi']['cust'] = $PHP_customer;
			if ($PHP_size > 0)
			{
				$size_scale=$size_des->get_fields('size_scale',"where id='$PHP_size'");				
				$PHP_size_scale=$size_scale[0];
			}
			// 取出選項資料 及傳入之參數
			$op['smpl']['size_scale'] = $PHP_size_scale;
			$op['smpl']['size'] = $PHP_size;
			$op['smpl']['style_code'] = $PHP_style_code;
			$op['smpl']['cust_ref'] = $PHP_cust_ref;
			$op['smpl']['id'] = $PHP_smpl_id;
			$op['smpl']['etd'] = $PHP_etd;
			$op['smpl']['unit'] = $PHP_unit;			
			$op['wi']['dept']	 = $PHP_dept;
			// pre  製造令編號....
			$op['wi']['wi_precode'] = $PHP_style_code;

			// 相片的URL決定 ----------------------------------------------------------------
				$style_dir	= "./smpl_pic/";  
				$no_img		= "./images/graydot.gif";
			if(file_exists($style_dir.$PHP_style_code.".jpg")){
				$op['re_adding'] = 1;
				$op['pic_link'] = $style_dir.$PHP_style_code.".jpg";
			} else {
				$op['pic_link']= $no_img;
			}


		    if (isset($PHP_dept_code))
			{
				$PHP_back_str = "&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
				$op['back_str']=$PHP_back_str;
				$PHP_back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
				$op['back_str2']=$PHP_back_str2;
			}else{
				$op['back_str']="&PHP_sr_startno=&PHP_dept_code=&PHP_num=&PHP_cust=&PHP_ref=&PHP_factory=&PHP_etdstr=&PHP_etdfsh=";
				$op['back_str2']="&PHP_sr=&PHP_dept_code=&PHP_num=&PHP_cust=&PHP_ref=&PHP_factory=&PHP_etdstr=&PHP_etdfsh=";
				$PHP_back_str2=$op['back_str2'];
			}

			page_display($op, "010", $TPL_SMPL_WI_ADD);	    	    
		break;

//=======================================================
	case "do_smpl_wi_add_1":

		check_authority("010","add");
		// 取出年碼... 以輸入時之年為年碼[兩位]

		$dt = decode_date(1);
		$size_id=$PHP_Size_id;
		if ($PHP_Size_add==1)
		{
			if ($PHP_Size_id==0)
			{
				$PHP_Size_item = strtoupper($PHP_Size_item);
				$PHP_Size = strtoupper($PHP_Size);	
				$PHP_base_size = strtoupper($PHP_base_size);
				$parm=array(	'cust'			=>	$PHP_cust,
								'dept'			=>	$PHP_dept_code,
								'size'			=>	$PHP_Size_item,
								'size_scale'	=>	$PHP_Size,
								'base_size'		=>	$PHP_base_size,
								'check'			=>	1,
				);
				$size_id=$size_des->add($parm);				
			}			
			$siz_ary['field_name']='size';
			$siz_ary['field_value']=$size_id;
			$siz_ary['id']=$PHP_smpl_id;
			$f1 = $smpl_ord->update_field($siz_ary);
		}

		$parm = array(	"dept"			=>	$PHP_dept_code,
						"cust"			=>	$PHP_cust,
						"cust_ref"		=>	$PHP_cust_ref,
						"smpl_id"		=>	$PHP_smpl_id,

						"etd"			=>	$PHP_etd,						
						"unit"			=>	$PHP_unit,

						"size_scale"	=>	$size_id,	// 不存入 wi

						"style_code"	=>	$PHP_style_code,
						"creator"		=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
						"open_date"		=>	$dt['date_str'],
						"version"		=>	"1"
			);

		// check 寫入 wi 檔	資料		
			$op['wi'] = $parm;
			
		if (!$f1 = $smpl_wi->check($parm)) {  // 沒有成功輸入資料時
			$op['msg'] = $smpl_wi->msg->get(2);
			// 抓入 視窗的樣本參數 ----
			$op['smpl']['size_scale'] = $PHP_Size;
			$op['smpl']['size'] = $size_id;
			$op['smpl']['style_code'] = $parm['style_code'];
			$op['smpl']['cust_ref'] = $parm['cust_ref'];
			$op['smpl']['id'] = $parm['smpl_id'];
			$op['smpl']['unit'] = $parm['unit'];
			$op['smpl']['etd'] = $parm['etd'];
			// 設定 re_adding 標桿---
			$op['re_adding'] = "1";
			// 相片的URL決定 ----------------------------------------------------------------
				$style_dir	= "./smpl_pic/";  
				$no_img		= "./images/graydot.gif";
			if(file_exists($style_dir.$op['wi']['style_code'].".jpg")){
				$op['pic_link'] = $style_dir.$op['wi']['style_code'].".jpg";
			} else {
				$op['pic_link']= $no_img;
			}

			// 列出 新增 製作令 選入樣本的視窗 ---------------------------------------------
					
				// 取出年碼...
				$dt = decode_date(1);
				$year_code = substr($dt['year'],-1);
				// pre  製造令編號....
				$op['wi']['wi_precode'] = $PHP_style_code;
				// creat sample type combo box
				$sample_def = $smpl_type->get_fields('smpl_type');   // 取出 樣本類別
		    	$op['back_str']=$PHP_back_str;
				$op['back_str2']=$PHP_back_str2;

	
			page_display($op, "010", $TPL_SMPL_WI_ADD);	    	    
		break;
		
		
		}   // end check
		
		// 編製 製作令 號碼----------------------------------------------------------------
		//  編製 制作令號碼 也同時更新dept檔內的num值[csv]
		$parm['wi_num'] = $PHP_style_code; 
		$etd['field_name']='etd';
		$etd['field_value']=$PHP_etd;
		$etd['id']=$PHP_smpl_id;
		$f1 = $smpl_ord->update_field($etd);
		$f1 = $smpl_wi->add($parm);
	
		if (!$f1) {  // 沒有成功輸入資料時

			$op['msg'] = $wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);
			break;

		}   // end if (!$F1)---------  結束判斷 ------------------------------------
		$message = "Done ADD [".$parm['wi_num']."] W/I。<br>Please add[colorway / breakdown] and [materiel consumption]。";

// 將 wis [樣本製令]編號 寫入 樣本檔內[ smpl table ] NOTE: 主要是讓該款 樣本不能再做任何製令[需再複製]
				$etd1['field_name']="marked";
				$etd1['field_value']=$parm['wi_num'];
				$etd1['id']=$parm['smpl_id'];
				if (!$smpl_ord->update_field($etd1)) {
					$op['msg']= $order->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
				$etd2['field_name']="m_status";
				$etd2['field_value']='1';
				$etd2['id']=$parm['smpl_id'];
				if (!$smpl_ord->update_field($etd2)) {
					$op['msg']= $order->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}

		
		// 取出該筆 wi 資料 ---------------------------------------------------------- 
			if (!$op['wi']=$smpl_wi->get($f1)) {
				$op['msg']= $smpl_wi->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			$parm_update = array($op['wi']['id'],'last_update',$dt['date_str']);
			$smpl_wi->update_field($parm_update);
			$parm_update = array($op['wi']['id'],'updator',$GLOBALS['SCACHE']['ADMIN']['login_id']);
			$smpl_wi->update_field($parm_update);

			// 送出 網頁參數 ---------------------------------------
					$op['smpl'] =$smpl_ord->get_fieldvalue('','qty',$op['wi']['wi_num']);
					$op['smpl']['cust'] = $parm['cust'];
					$op['smpl']['style'] = $parm['cust_ref'];
					$op['smpl']['size_scale'] = $PHP_Size;
					

		//  wi_qty 數量檔 -----------------------------------------------------------------
		$where_str = " WHERE wi_id='".$f1."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);
	
		// 取出 size_scale --------
		
		$size_A = $size_des->get($size_id);
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
			$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
			$op['show_breakdown'] = $reply['html'];
			$op['total'] = $reply['total'];
		//-----------------------------------------------------------------			
			$op['edit_breakdown'] = edit_breakdown($sizing,$PHP_back_str2,$size_A['base_size']);

			// 相片的URL決定 ----------------------------------------------------------------
				$style_dir	= "./smpl_pic/";  
				$no_img		= "./images/graydot.gif";
			if(file_exists($style_dir.$op['wi']['style_code'].".jpg")){
				$op['wi']['pic_url'] = $style_dir.$op['wi']['style_code'].".jpg";
			} else {
				$op['wi']['pic_url'] = $no_img;
			}

			$op['wi']['etd'] = $parm['etd'];
		
		//  取出主料記錄  --------------------------------------------------------------------
		$where_str = " WHERE smpl_code = '".$op['wi']['style_code']."' ";
		$lots = $smplord_lots->search(0,$where_str);  //取出該筆 樣本主料記錄
		$op['lots_use'] = $lots;

		if (!is_array($op['lots_use'])) {
			$op['msg'] = $smplord_lots->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		if (!count($op['lots_use'])){	$op['lots_NONE'] = "1";		}


		//  取出副料料記錄  ------------------------------------------------------------------
		$where_str = " WHERE smpl_code = '".$op['wi']['style_code']."' ";
		$acc = $smplord_acc->search(0,$where_str);  //取出該筆 樣本主料記錄
		$op['acc_use'] = $acc;

		if (!is_array($op['acc_use'])) {     //~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
			$op['msg'] = $smplord_acc->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		if (!count($op['acc_use'])){	$op['acc_NONE'] = "1";		}
		//------------------------------------------------------------------------------------
		# 記錄使用者動態
		$log->log_add(0,"23A",$message);
		$op['msg'][] = $message;
		$op['back_str']=$PHP_back_str;
		$op['back_str2']=$PHP_back_str2;
				page_display($op, "010", $TPL_SMPL_WI_ADD2);	    	    

			break;

//=======================================================
	case "add_smpl_colorway":      // 新增製作令

		check_authority("010","add");
		// 傳入 javascript傳出的參數 [ colorway : 必然輸入已由 javascript撿查 ]
		$parm['qty']		= $PHP_qty;   // 由javascript傳出的陣列值 自動改成csv傳出
		$parm['wi_id']		= $wi_id;
		$parm['colorway']	= $colorway;

		// 加入 新色組 ----- 加入 wiqty table -----------------
		if(!$T_del =	$smpl_wiqty->add($parm)){    
						$op['msg']= $wi->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
		}

		// 將 製造令 完整show out ---------------------------------------------
		//  wi 主檔 抓出來 ----------------------------------------------------
		if(!$op = $smpl_wi->get_all($wi_id)){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}


				# 記錄使用者動態
		$message = "Successful add w/i[".$op['wi']['wi_num']."] colorway[".$colorway."]•";

		//  wi_qty 數量檔 -----------------------------------------------------------------
		$where_str = " WHERE wi_id='".$wi_id."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		// 取出 size_scale --------
		$size_A = $size_des->get($op['smpl']['size']);
		
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);
//------------search條件記錄
		    if (isset($PHP_dept_code))
			{
				$PHP_back_str = "&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
				$op['back_str']=$PHP_back_str;
				$PHP_back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
				$op['back_str2']=$PHP_back_str2;
			}else{
				$op['back_str']=$PHP_back_str;
				$op['back_str2']=$PHP_back_str2;				
			}
			// 做出 size table--------
			$op['show_del_breakdown'] = show_del_breakdown($T_wiqty,$sizing,$PHP_back_str2,$size_A['base_size']);
			$op['edit_breakdown'] = edit_breakdown($sizing,$PHP_back_str2,$size_A['base_size']);		
			$op['msg'][] = $message;
		page_display($op, "010", $TPL_SMPL_WI_ADD2);	  
		break;

//=======================================================
	case "do_smpl_wi_add_2":

		check_authority("010","add");
	// 輸入項正確後............after check input.........
				// 取出年碼... 以輸入時之年為年碼[兩位]

		// 將主副料 預估寫入 主副料使用檔內 lots_use, acc_use  ....
		// 主料  --------------------------------------------------------------------------
		$parm = array(	"style_code"	=>	$PHP_style_code,
						"cust_ref"		=>	$PHP_cust_ref,
						"size_type"		=>	$PHP_size_type,
						"size_scale"	=>	$PHP_size_scale,
						
						"wi_id"		=>	$PHP_wi_id,
						"wi_num"	=>	$PHP_wi_num,
						"dept"		=>	$PHP_dept,
						"smpl_id"	=>	$PHP_smpl_id,
						"cust"		=>	$PHP_cust,		

						"etd"		=>	$PHP_etd,
						"smpl_type" =>	$PHP_smpl_type,

						"unit"		=>	$PHP_unit,
						"lots_est_array"	=>	$PHP_lots_est,	// 是個 array 
						"acc_est_array"		=>	$PHP_acc_est,  // 是個 array
						"ester"				=>	$GLOBALS['SCACHE']['ADMIN']['login_id']
			);
			
		if($parm['lots_est_array']){
			while(list($key,$val) = each($parm['lots_est_array'])){
				if($val){
					$lots = array($key,"est_1",$val);
					if(!$smplord_lots->update_field($lots)){
						$op['msg']= $smplord_lots->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
					}

					$updt = array($key,"ester_1",$parm['ester']);
					if(!$smplord_lots->update_field($updt)){
						$op['msg']= $smplord_lots->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
					}
				}
			}
		}
		// 副料  ----------------------------------------------------------------------------
		if($parm['acc_est_array']){
			while(list($key,$val) = each($parm['acc_est_array'])){
				if($val){
					$acc = array($key,"est_1",$val);
					if(!$smplord_acc->update_field($acc)){
						$op['msg']= $smplord_acc->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
					}

					$updt = array($key,"ester_1",$parm['ester']);
					if(!$smplord_acc->update_field($updt)){
						$op['msg']= $smplord_acc->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
					}
				}
			}
		}
		
		//------------------------------------ 完成寫入 wi 及 用料預估---------------
		// 將 製造令 完整show out ------
		//  wi 主檔
		if(!$op = $smpl_wi->get_all($parm['wi_id'])){
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
//--------------------------------------------------------------------------
		
		//  wi_qty 數量檔
			$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);

		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
		$op['show_breakdown'] = $reply['html'];
		$op['total'] = $reply['total'];
		//-----------------------------------------------------------------

				# 記錄使用者動態
		$message = "Successfully add full w/i : ".$op['wi']['wi_num']."record。";
		$log->log_add(0,"23A",$message);
		$op['msg'][] = $message;

		$op['back_str']=$PHP_back_str;
		$op['back_str2']=$PHP_back_str2;
			page_display($op, "010", $TPL_SMPL_WI_VIEW);
		break;

//========================================================================================	
case "smpl_wi_view":
check_authority("010","view");

// 將 製造令 完整show out ------
//  wi 主檔

if(is_numeric($PHP_id)){
	
	if(!$op = $smpl_wi->get_all($PHP_id)){    //取出該筆 製造令記錄 ID
				$op['msg']= $smpl_wi->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
	}
	
} else {
	if(!$op = $smpl_wi->get_all(0,$PHP_id)){    //取出該筆 製造令記錄 WI_NUM
				$op['msg']= $smpl_wi->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
	}
}

$op['order'] = $smpl_ord->get($op['smpl']['id']);  //取出該筆記錄
if (!$op['order']) {
	$op['msg'] = $order->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}

$op['order']['stype'] =  '';
$op['order']['smpl_code'] += 0;
foreach($SMPL_TYPE as $key => $val){
	$op['order']['stype'] .= ( !empty($op['order']['smpl_code']) && $op['order']['smpl_code'] & $val )? $key.' , ' : '' ;
}

//--------------------------------------------------------------------------
		//  wi_qty 數量檔
		$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);

		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
		$op['show_breakdown'] = $reply['html'];
		$op['total'] = $reply['total'];
		//-----------------------------------------------------------------
//檔案列表
		$op['done'] = $fils->get_smpl_file($op['wi']['wi_num']);

		if(count($op['ti']))
		{
		 for ($i=0; $i<sizeof($op['ti']); $i++)
			$op['ti'][$i]['detail'] = str_replace( chr(13).chr(10), "<br>", $op['ti'][$i]['detail'] );
		}
		if(isset($op['sub_ti']))
		{
			for ($i=0; $i<sizeof($op['sub_ti']); $i++)
			for($j=0; $j<sizeof($op['sub_ti'][$i]['txt']); $j++)
				$op['sub_ti'][$i]['txt'][$j]['detail'] = str_replace( chr(13).chr(10), "<br>", $op['sub_ti'][$i]['txt'][$j]['detail'] );
		}

		$op['msg'] = $wi->msg->get(2);
		$back_str = "&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str']=$back_str;
		$back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str2']=$back_str2;
		$op['now_pp']=$PHP_sr;
		
		if (isset($PHP_ex_order))
		{
			$op['edit_non']=1;
		}
		// print_r($op); 
		if (isset($PHP_ti))
		{
			if (isset($PHP_msg))$op['msg'][]=$PHP_msg;
			page_display($op, "010", $TPL_SMPL_TI_VIEW);
		}else if (isset($PHP_cfm_view)){
			if (isset($PHP_msg))$op['msg'][]=$PHP_msg;
			page_display($op, "011", $TPL_SMPL_WI_CFM_VIEW);
		}else{
			page_display($op, "010", $TPL_SMPL_WI_VIEW);
		}
		break;


//=======================================================
    case "smpl_wi_print":   //  .......

		check_authority("010","view");

		if(is_numeric($PHP_id)){
			if(!$wi = $smpl_wi->get($PHP_id)){    //取出該筆 製造令記錄 ID
						$op['msg']= $wi->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
			}
		} else {
			if(!$wi = $smpl_wi->get(0,$PHP_id)){    //取出該筆 製造令記錄 WI_NUM
						$op['msg']= $wi->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
			}
		}

		//  smpl 樣本檔
		if(!$smpl = $smpl_ord->get($wi['smpl_id'])){
					$op['msg']= $order->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}

		$op['order']['stype'] =  '';
		$op['order']['smpl_code'] += 0;
		foreach($SMPL_TYPE as $key => $val){
			$op['order']['stype'] .= ( !empty($smpl['smpl_code']) && $smpl['smpl_code'] & $val )? $key.' , ' : '' ;
		}

//--------------------------------------------------------------------------
		//  wi_qty 數量檔
		$where_str = " WHERE wi_id='".$wi['id']."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);

		// 取出 size_scale ----------------------------------------------
//		$where_str = " WHERE cust='".$wi['cust']."' AND size_scale='".$smpl['size']."' ";
		$size_A = $size_des->get($smpl['size']);
		$smpl['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = get_colorway_qty($T_wiqty,$sizing);

		$op['total'] = $reply['total'];   // 總件數
		$data = $reply['data'];

		$colorway_name = $reply['colorway'];
		$colorway_qty = $reply['colorway_qty'];
		//-----------------------------------------------------------------

		//  取出 生產說明 記錄 -------------------------------------------------
		$where_str = " WHERE wi_id = '".$wi['id']."' ";
		$T = $smpl_ti->search(0,$where_str);  //取出該筆 樣本主料記錄
		$op['ti'] = $T['ti'];

		if (!is_array($op['ti'])) {
			$op['msg'] = $ti->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		if (!count($op['ti'])){	$op['ti_NONE'] = "1";		}

		

//-----------------------------------------------------------------------
			// 相片的URL決定
				$style_dir	= "./smpl_pic/";  
				$no_img		= "./images/graydot.jpg";
			if(file_exists($style_dir.$wi['style_code'].".jpg")){
				$wi['pic_url'] = $style_dir.$wi['style_code'].".jpg";
			} else {
				$wi['pic_url'] = $no_img;
			}
		
		//  取出主料記錄 ----------------------------------------------------
		$where_str = " WHERE smpl_code = '".$wi['style_code']."' ";
		$lots = $smplord_lots->search(0,$where_str);  //取出該筆 樣本主料記錄
		$op['lots_use'] = $lots;

		if (!is_array($op['lots_use'])) {
			$op['msg'] = $smplord_lots->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		if (!count($op['lots_use'])){	$op['lots_NONE'] = "1";		}

		//  取出副料料記錄 ---------------------------------------------------
		$where_str = " WHERE smpl_code = '".$wi['style_code']."' ";
		$acc = $smplord_acc->search(0,$where_str);  //取出該筆 樣本主料記錄
		$op['acc_use'] = $acc;

		if (!is_array($op['acc_use'])) {     
			$op['msg'] = $smplord_acc->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

//---------------------------------- 資料庫作業結束 ------------------------------

include_once($config['root_dir']."/lib/class.pdf_wi.php");

$print_title = "Working Instruction";
$stype = $op['order']['stype'];
$des_fab = $smpl['des_fab'];

$wi['cfm_date']=substr($wi['cfm_date'],0,10);
$print_title2 = "VER.".$wi['revise']."  on  ".$wi['cfm_date'];
$creator = $wi['confirmer'];

$pdf=new PDF_bom();
$pdf->AliasNbPages(); 
$pdf->AddBig5Font();
$pdf->Open();
$pdf->AddPage();
$pdf->SetFont('Arial','B',14);
// [表匡] 訂單基本資料
$pdf->hend_title($PHP_id,$wi,$smpl,$op['total'],'Sample Order#');
$pdf->ln(10);
$Y = $pdf->getY();

$img_size = GetImageSize($wi['pic_url']);

if ($img_size[0] > $img_size[1])
{
	$pdf->Image($wi['pic_url'],10,28,40,0);
}else{
	$pdf->Image($wi['pic_url'],10,28,0,40);
}

$pdf->ln();
$Y = $pdf->getY();
$X = $pdf->getX();
$pdf->setXY($X,($Y+3));

// 設定 colorway的數量表 - 欄位的寬  [size breakdown]
// 由 80~200 保留 30為 colorway內容 其它 90分配給數量欄

$num_siz = count($sizing);
$w_qty = intval(155/($num_siz+1));
$w = array('40');  // 第一格為 30寬
for ($i=0;$i<=$num_siz;$i++){
	array_push($w, $w_qty);
}

$pdf->SetFont('Arial','B',14);
$header = array_merge(array('Colorway') , $sizing);	
$table_title = "Size Breakdown";
$R = 100;
$G = 85;
$B = 85;

if (count($sizing)){
	$pdf->Table_1(10,80,$header,$data,$w,$table_title,$R,$G,$B,$size_A['base_size']);
}else{
	$pdf->Cell(10,70,'there is no sizing data exist !',1);
}

$Y = $pdf->getY();

// 定訂 圖以下的座標 
$pdf->SetXY($X,$Y+10);

// 主料
$pdf->SetFont('Big5','',10);
if(!isset($data))$data=array();
$xic = sizeof($data);
$x=1;

// 主料抬頭
if (count($lots)){
	$pdf->setx(10);
	$pdf->SetFont('Arial','B',14);
	$pdf->Cell(190,7,'Fabrics',0,1,'L');
	$pdf->Table_fab_title();
	$xic++;
	for ($i=0; $i<sizeof($lots); $i++)
	{
		if ($xic > 32)
		{
		$pdf->AddPage();
		$pdf->SetFont('Arial','B',14);
		// [表匡] 訂單基本資料
		$pdf->hend_title($PHP_id,$wi,$smpl,$op['total'],'Sample Order#');		
		if ($img_size[0] > $img_size[1])
		{
			$pdf->Image($wi['pic_url'],10,28,40,0);
		}else{
			$pdf->Image($wi['pic_url'],10,28,0,40);
		}

		$pdf->ln();
		$pdf->ln();
		$pdf->ln();
		$pdf->setx(10);
		$pdf->SetFont('Arial','B',14);
		$pdf->Cell(190,7,'Fabrics',0,1,'L');
		$pdf->Table_fab_title();
		$pdf->SetFont('Big5','',10);
		$xic=2;
		$pdf->ln();
		}
		$xic=$xic+2;
		$pdf->Table_fab($lots[$i],$i);
		
		
	}

} // if $num_colors....

	$pdf->ln();

	// 副料抬頭
if (count($acc)){
	$pdf->setx(10);
	$pdf->SetFont('Arial','B',14);
	$pdf->cell(190,7,'Accessories',0,1,'L');
	$pdf->Table_acc_title('');		
	$pdf->ln();	
	$xic=$xic+5;
	for( $i=0; $i<sizeof($acc); $i++)
	{
		if ($xic > 32)
		{
			$pdf->AddPage();
			$pdf->SetFont('Arial','B',14);
			// [表匡] 訂單基本資料
			$pdf->hend_title($PHP_id,$wi,$smpl,$op['total'],'Sample Order#');		
			if ($img_size[0] > $img_size[1])
			{
				$pdf->Image($wi['pic_url'],10,28,40,0);
			}else{
				$pdf->Image($wi['pic_url'],10,28,0,40);
			}

			$pdf->ln();
			$pdf->ln();
			$pdf->ln();
			$pdf->setx(10);
			$pdf->SetFont('Arial','B',14);
			$pdf->cell(190,7,'Accessories',0,1,'L');
			$pdf->SetFont('Arial','B',10);
			$pdf->Table_acc_title('');
			$pdf->SetFont('Big5','',10);
			$pdf->ln();
			$xic=3;
		}	
		$pdf->Table_acc($acc[$i],$i);
		$xic=$xic+2;					
		$pdf->ln();
	}
			
} // if $num_colors....
$pdf->ln();

$name=$wi['wi_num'].'_wi.pdf';
$pdf->Output($name,'D');
break;	

//=======================================================
	case "smpl_ti_comm_print":   //  ....... S1PH-0345-1

	check_authority("010","view");
	
	$full_wi = $smpl_wi->get_all('',$PHP_id);
	$wi = $full_wi['wi'];
	$smpl = $full_wi['smpl'];
	
	if(!empty($smpl['orders'])){
		$tmp_orders = '';
		$tmp_orders_ary = explode("|",$smpl['orders']);
		foreach($tmp_orders_ary as $k => $v_ord){
			$p_etd_v = $smpl_wi->get_pdf_etd($v_ord);
			$tmp_orders .= $v_ord."(".$p_etd_v.")"."|";
		}
		$smpl['orders'] = substr($tmp_orders,0,-1);
	}
	
	$op['order']['stype'] =  '';
	$op['order']['smpl_code'] += 0;
	foreach($SMPL_TYPE as $key => $val){
		$op['order']['stype'] .= ( !empty($smpl['smpl_code']) && $smpl['smpl_code'] & $val )? $key.' , ' : '' ;
	}
	
//--------------------------------------------------------------------------
		//  wi_qty 數量檔
			$where_str = " WHERE wi_id='".$wi['id']."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);

		// 取出 size_scale ----------------------------------------------
//		$where_str = " WHERE cust='".$wi['cust']."' AND size_scale='".$smpl['size']."' ";
		$size_A = $size_des->get($smpl['size']);
		$smpl['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = get_colorway_qty($T_wiqty,$sizing);

		$op['total'] = $reply['total'];   // 總件數
		$data = $reply['data'];

		$colorway_name = $reply['colorway'];
		$colorway_qty = $reply['colorway_qty'];
		//-----------------------------------------------------------------

		//  取出 生產說明 記錄 -------------------------------------------------
		$where_str = " WHERE wi_id = '".$wi['id']."' AND item = 'Comment' AND ti_new = 1";
		$T = $smpl_ti->search(0,$where_str);  //取出該筆 樣本主料記錄
		$op['ti_comm'] = $T['ti'];
		if(count($op['ti_comm']))
		{
		 for ($i=0; $i<sizeof($op['ti_comm']); $i++)
			$op['ti_comm'][$i]['detail'] = str_replace( chr(13).chr(10), "<br>", $op['ti_comm'][$i]['detail'] );
		}



		$op['done'] = $fils->get_smpl_file($wi['wi_num']);		
//		if (!count($op['done'])){	$op['done_NONE'] = "1";		}
//-----------------------------------------------------------------------
			// 相片的URL決定
				$style_dir	= "./smpl_pic/";  
				$no_img		= "./images/graydot.jpg";
			if(file_exists($style_dir.$wi['style_code'].".jpg")){
				$wi['pic_url'] = $style_dir."s_".$wi['style_code'].".jpg";
			} else {
				$wi['pic_url'] = $no_img;
			}

//---------------------------------- 資料庫作業結束 ------------------------------
header("Content-type: application/pdf ");
header("Content-Transfer-Encoding: binary");

include_once($config['root_dir']."/lib/class.pdf_ti.php");


$print_title = "WorkSheet";
$stype = $op['order']['stype'];
$des_fab = $smpl['des_fab'];


$print_title2 = "VER.".$wi['ti_rev']."  on  ".$wi['ti_cfm'];
$creator = $wi['ti_cfm_user'];

$ary_title = array ('prt_ord'	=>	'Sample Order#',
							 'id'				=>	$PHP_id,
							 'cust'			=>	$smpl['cust_iname'],
							 'ref'			=>	$smpl['ref'],
							 'dept'			=>	$smpl['dept'],
							 'size'			=>	$smpl['size_scale'],
							 'style'		=>	$smpl['style'],
							 'style_cat'	=>	$smpl['style_cat'],
							 'orders'		=>	$smpl['orders'],
							 'qty'			=>	$op['total'],
							 'unit'			=>	$wi['unit'],
							 'etd'			=>	$wi['etd'],
							 'img'			=>	$wi['pic_url'],							 
							 'img_size'	=>	GetImageSize($wi['pic_url']),
							);

$pdf=new PDF_ti();
$pdf->AddBig5Font();
$pdf->Open();
$pdf->AddPage();
$pdf->SetFont('Arial','B',14);
// [表匡] 訂單基本資料

		$X = $pdf->getX();

// 設定 colorway的數量表 - 欄位的寬  [size breakdown]
// 由 80~200 保留 30為 colorway內容 其它 90分配給數量欄
	$num_siz = count($sizing);
	$w_qty = intval(155/($num_siz+1));
	$w = array('40');  // 第一格為 30寬
	for ($i=0;$i<= $num_siz;$i++){
		array_push($w, $w_qty);
	}

	$header = array_merge(array('Colorway') , $sizing);	
	$table_title = "Size Breakdown";
	$R = 100;
	$G = 85;
	$B = 85;
	if (count($sizing)){
		$pdf->Table_1(10,80,$header,$data,$w,$table_title,$R,$G,$B,$size_A['base_size']);
	}else{
		$pdf->Cell(10,80,'there is no sizing data exist !',1);
	}

		$Y = $pdf->getY();
		$X = $pdf->getX();

		// 定訂 圖以下的座標 
		$pdf->SetXY($X,$Y+5);

// 主料
		$pdf->SetFont('Big5','',10);

$xic=1;
$x=7;$mark=0;
$pdf->ln();

$x=$x+2;
if(isset($op['ti_comm']) && sizeof($op['ti_comm']) > 0 )
{
	$pdf->ti_name_fields('COMMENT  <<'.$op['ti_comm'][0]['date']."  ".$op['ti_comm'][0]['ti_time'].'>>');
	$pdf->SetFont('Big5','',10);
	for($j=0; $j<sizeof($op['ti_comm']); $j++) 	$x=$pdf->ti_value_fields($op['ti_comm'][$j]['detail'],$x,0,'COMMENT');
	$pdf->setx(10);
	$pdf->Cell(190,5,'','LBR',0,'L');
	$pdf->ln();
}

$name=$wi['wi_num'].'_ws_comm.pdf';

$pdf->Output($name,'D');

break;	

//=======================================================
    case "smpl_ti_print":   //  .......

		check_authority("010","view");
		
		$full_wi = $smpl_wi->get_all('',$PHP_id);
		$wi = $full_wi['wi'];
		$smpl = $full_wi['smpl'];

		
		$op['order']['stype'] =  '';
		$op['order']['smpl_code'] += 0;
		foreach($SMPL_TYPE as $key => $val){
			$op['order']['stype'] .= ( !empty($smpl['smpl_code']) && $smpl['smpl_code'] & $val )? $key.' , ' : '' ;
		}
		
//--------------------------------------------------------------------------
		//  wi_qty 數量檔
			$where_str = " WHERE wi_id='".$wi['id']."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);

		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($smpl['size']);
		$smpl['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = get_colorway_qty($T_wiqty,$sizing);

		$op['total'] = $reply['total'];   // 總件數
		$data = $reply['data'];

		$colorway_name = $reply['colorway'];
		$colorway_qty = $reply['colorway_qty'];
		//-----------------------------------------------------------------

		if(!isset($full_wi['ti']))$full_wi['ti'] = array();
		if(!isset($full_wi['sub_ti']))$full_wi['sub_ti'] = array();
		$op['ti'] = $full_wi['ti'];
		$op['sub_ti'] = $full_wi['sub_ti'];


		$op['done'] = $fils->get_smpl_file($wi['wi_num']);		
//-----------------------------------------------------------------------
			// 相片的URL決定
				$style_dir	= "./smpl_pic/";  
				$no_img		= "./images/graydot.jpg";
			if(file_exists($style_dir.$wi['style_code'].".jpg")){
				$wi['pic_url'] = $style_dir."s_".$wi['style_code'].".jpg";
			} else {
				$wi['pic_url'] = $no_img;
			}

//---------------------------------- 資料庫作業結束 ------------------------------
header("Content-type: application/pdf ");
header("Content-Transfer-Encoding: binary");
header('content-type:text/html;charset=big-5');

include_once($config['root_dir']."/lib/class.pdf_ti.php");


$print_title = "WorkSheet";
$stype = $op['order']['stype'];
$des_fab = $smpl['des_fab'];


$print_title2 = "VER.".$wi['ti_rev']."  on  ".$wi['ti_cfm'];
$creator = $wi['ti_cfm_user'];

$ary_title = array ('prt_ord'	=>	'Sample Order#',
							 'id'				=>	$PHP_id,
							 'cust'			=>	$smpl['cust_iname'],
							 'ref'			=>	$smpl['ref'],
							 'dept'			=>	$smpl['dept'],
							 'size'			=>	$smpl['size_scale'],
							 'style'		=>	$smpl['style'],
							 'style_cat'	=>	$smpl['style_cat'],
							 'orders'		=>	$smpl['orders'],
							 'qty'			=>	$op['total'],
							 'unit'			=>	$wi['unit'],
							 'etd'			=>	$wi['etd'],
							 'img'			=>	$wi['pic_url'],							 
							 'img_size'	=>	GetImageSize($wi['pic_url']),
							);

$pdf=new PDF_ti();
$pdf->AddBig5Font();
$pdf->Open();
$pdf->AddPage();
$pdf->SetFont('Arial','B',14);
// [表匡] 訂單基本資料

		$X = $pdf->getX();

// 設定 colorway的數量表 - 欄位的寬  [size breakdown]
// 由 80~200 保留 30為 colorway內容 其它 90分配給數量欄
	$num_siz = count($sizing);
	$w_qty = intval(155/($num_siz+1));
	$w = array('40');  // 第一格為 30寬
	for ($i=0;$i<= $num_siz;$i++){
		array_push($w, $w_qty);
	}

	$header = array_merge(array('Colorway') , $sizing);	
	$table_title = "Size Breakdown";
	$R = 100;
	$G = 85;
	$B = 85;
	if (count($sizing)){
		$pdf->Table_1(10,80,$header,$data,$w,$table_title,$R,$G,$B,$size_A['base_size']);
	}else{
		$pdf->Cell(10,70,'there is no sizing data exist !',1);
	}

		$Y = $pdf->getY();
		$X = $pdf->getX();

		// 定訂 圖以下的座標 
		$pdf->SetXY($X,$Y+3);

// 主料
		$pdf->SetFont('Big5','',10);

$xic=1;
$x=7;$mark=0;
$pdf->ln();

for ($i=0; $i<sizeof($TI_ITEM); $i++)
{
	$tmp=$i+1;	
	for ($j=0; $j<sizeof($op['ti']); $j++)
	{
		if ($op['ti'][$j]['item']==$TI_ITEM[$i])
		{
			$mark=1;
			$star=$j;
			break;
		}
	}

	if($mark==1)
	{
		$x=$x+2;
		if ($x > 35)
		{
				$pdf->setx(10);
				$pdf->Cell(190,5,'','LBR',0,'L');	
				$pdf->AddPage();
				$x=4;		
		}
		
		$pdf->SetFont('Big5','',10);		
		$pdf->ti_name_fields($tmp.")".$TI_ITEM[$i]);
		for ($j=$star; $j<sizeof($op['ti']); $j++)
		{

			if ($op['ti'][$j]['item']==$TI_ITEM[$i])
			{

				$pdf->SetFont('Big5','',10);
				$x=$pdf->ti_value_fields($op['ti'][$j]['detail'],$x,$tmp,$TI_ITEM[$i]);
			}

		}
		$pdf->setx(10);
		$pdf->Cell(190,5,'','LBR',0,'L');
		$pdf->ln();
		$mark=0;
	}
}


for($i=0; $i<sizeof($op['sub_ti']); $i++)
{	
	$x=$x+2;
	if ($x > 35)
	{
		$pdf->setx(10);
		$pdf->Cell(190,5,'','LBR',0,'L');	
		$pdf->AddPage();
		$x=4;		
	}
	$pdf->ti_sub_name($op['sub_ti'][$i]['name'],'BIG5');
	
	for($j=0; $j<sizeof($op['sub_ti'][$i]['txt']); $j++)
	{
		if($op['sub_ti'][$i]['txt'][$j]['detail'])
		{
			$op['sub_ti'][$i]['txt'][$j]['detail'] = str_replace( chr(13).chr(10), "<br>", $op['sub_ti'][$i]['txt'][$j]['detail'] );
			$tmp=$j+1;
			$x=$x+2;
			if ($x > 35)
			{
				$pdf->setx(10);
				$pdf->Cell(190,5,'','LBR',0,'L');	
				$pdf->AddPage();
				$x=4;		
			}
		
			$pdf->ti_name_fields($tmp.")".$op['sub_ti'][$i]['txt'][$j]['item'],'BIG5');
			$x=$pdf->ti_value_fields($op['sub_ti'][$i]['txt'][$j]['detail'],$x,$tmp,$op['sub_ti'][$i]['txt'][$j]['item']);

			$pdf->setx(10);
			$pdf->Cell(190,5,'','LBR',0,'L');
			$pdf->ln();
		}
		
	}
}


$pdf->SetFont('Arial','B',14);
$pdf->ln();
$x=$x+2;

$pdf->SetLineWidth(0.2);
if (count($op['done']))
{
		if ($x > 35)
		{
				$pdf->AddPage();		

		}
	$pdf->setx(10);
	$pdf->Cell(190,8,'Attached Files',1,0,'C');
	$pdf->ln();
	$pdf->setx(10);
	$pdf->Cell(10,8,'No.',1,0,'C');
	$pdf->Cell(85,8,'File name',1,0,'C');
	$pdf->Cell(95,8,'File Description',1,0,'C');
	$pdf->ln();
	$pdf->setx(10);
	$pdf->Cell(10,0.5,'',1,0,'C');
	$pdf->Cell(85,0.5,'',1,0,'C');
	$pdf->Cell(95,0.5,'',1,0,'C');
	$pdf->ln();
	$x=$x+2;
	for ($i=0; $i< sizeof($op['done']); $i++)
	{
		
		if ($x > 35)
		{
			$pdf->AddPage();		

			$pdf->setx(10);
			$pdf->Cell(190,8,'Attached Files',1,0,'C');
			$pdf->ln();
			$pdf->setx(10);			
			$pdf->Cell(10,8,'No.',1,0,'C');
			$pdf->Cell(85,8,'File name',1,0,'C');
			$pdf->Cell(95,8,'File Description',1,0,'C');
			$pdf->ln();
			$pdf->setx(10);
			$pdf->Cell(10,0.5,'',1,0,'C');
			$pdf->Cell(85,0.5,'',1,0,'C');
			$pdf->Cell(95,0.5,'',1,0,'C');
			$pdf->ln();
			$x=4;
		}
		$j=$i+1;
		
		$pdf->setx(10);
		$pdf->Cell(10,5,$j,1,0,'C');
		$pdf->SetFont('Big5','',10);
		$pdf->Cell(85,5,$op['done'][$i]['file_name'],1,0,'L');
		$pdf->Cell(95,5,$op['done'][$i]['file_des'],1,0,'L');
		$pdf->SetFont('Arial','B',10);
		$pdf->ln();
		$x++;
	}
}


$name=$wi['wi_num'].'_ws.pdf';

$pdf->Output($name,'D');

break;	


//=======================================================
	case "search_smpl_wi_copy":
	
	$op['wi']=$smpl_wi->copy_search($PHP_c_cust, $PHP_c_dept);

  $op['copy_search'] = "&PHP_wi_num=".$PHP_wi_num."&PHP_smpl_id=".$PHP_smpl_id."&PHP_c_dept=".$PHP_c_dept."&PHP_c_cust=".$PHP_c_cust."&PHP_c_etd=".$PHP_c_etd;
		if (isset($PHP_dept_code))
		{
			$PHP_back_str = "&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
			$op['back_str']=$PHP_back_str;
			$PHP_back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
			$op['back_str2']=$PHP_back_str2;

		}else{
			$op['back_str']="&PHP_sr_startno=&PHP_dept_code=&PHP_num=&PHP_cust=&PHP_ref=&PHP_factory=&PHP_etdstr=&PHP_etdfsh=";
			$op['back_str2']="&PHP_sr=&PHP_dept_code=&PHP_num=&PHP_cust=&PHP_ref=&PHP_factory=&PHP_etdstr=&PHP_etdfsh=";
			$PHP_back_str2=$op['back_str2'];
		}
	page_display($op, "010", $TPL_SMPL_WI_COPY_SEARCH);
	break;


//========================================================================================	
	case "smpl_wi_copy_view":

		check_authority("010","view");

		// 將 製造令 完整show out ------
		//  wi 主檔
			if(!$op = $smpl_wi->get_all($PHP_id)){    //取出該筆 製造令記錄 ID
						$op['msg']= $smpl_wi->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
			}
//--------------------------------------------------------------------------
		//  wi_qty 數量檔
		$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);

		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
		$op['show_breakdown'] = $reply['html'];
		$op['total'] = $reply['total'];
		//-----------------------------------------------------------------

		$op['msg'] = $wi->msg->get(2);

   $op['copy_search'] = "&PHP_wi_num=".$PHP_wi_num."&PHP_smpl_id=".$PHP_smpl_id."&PHP_c_dept=".$PHP_c_dept."&PHP_c_cust=".$PHP_c_cust."&PHP_c_etd=".$PHP_c_etd;

    $op['org_wi_num'] = $PHP_wi_num;
    $op['org_smpl_id'] = $PHP_smpl_id;
    $op['org_etd'] = $PHP_c_etd;
    
		$back_str = "&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str']=$back_str;
		$back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str2']=$back_str2;
		
		page_display($op, "010", $TPL_SMPL_WI_COPY_VIEW);

		break;
		
		
		
//=======================================================
		
	case "do_smpl_wi_copy":

		check_authority("010","edit");

		// 將 製造令 完整show out ------
		//  wi 主檔 抓出來
		$f1=$smpl_wi->copy_wi($PHP_wi_num,$PHP_smpl_id,$PHP_new_num,$PHP_etd,$dt['date_str'],$GLOBALS['SCACHE']['ADMIN']['login_id'],$PHP_dept,$PHP_cust);
		if (!$f1)
		{
			$op['msg']= $smpl_wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		
		// 將 wis [樣本製令]編號 寫入 樣本檔內[ smpl table ] NOTE: 主要是讓該款 樣本不能再做任何製令[需再複製]
				$etd1['field_name']="marked";
				$etd1['field_value']=$PHP_new_num;
				$etd1['id']=$PHP_smpl_id;
				if (!$smpl_ord->update_field($etd1)) {
					$op['msg']= $order->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
				$etd2['field_name']="m_status";
				$etd2['field_value']='1';
				$etd2['id']=$PHP_smpl_id;
				if (!$smpl_ord->update_field($etd2)) {
					$op['msg']= $order->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}


		
		
		if(!$op['wi'] = $smpl_wi->get($f1)){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}

			$parm_update = array($op['wi']['id'],'last_update',$dt['date_str']);
			$wi->update_field($parm_update);
			$parm_update = array($op['wi']['id'],'updator',$GLOBALS['SCACHE']['ADMIN']['login_id']);
			$wi->update_field($parm_update);


		//  smpl 樣本檔  抓出來
		if(!$op['smpl'] = $smpl_ord->get($op['wi']['smpl_id'])){
					$op['msg']= $smpl->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
	//檢視是否可以修改size(即是否存在colorway)
		if ($smpl_wi->check_size($op['wi']['style_code']))
		{
			$op['size_edit']=1;
		}

		//  wi_qty 數量檔 -----------------------------------------------------------------
		$where_str = " WHERE wi_id='".$f1."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		// 取出 size_scale --------
//		$where_str = " WHERE cust='".$op['smpl']['cust']."' AND size_scale='".$op['smpl']['size']."' ";
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);


//search條件記錄			
$op['back_str']=$PHP_back_str;
$op['back_str2']=$PHP_back_str2;

		// 做出 size table-------------------------------------------
			$op['show_del_breakdown'] = show_del_breakdown($T_wiqty,$sizing,$PHP_back_str2,$size_A['base_size']);
			$op['edit_breakdown'] = edit_breakdown($sizing,$PHP_back_str2,$size_A['base_size']);



			// 相片的URL決定  ---------------------------------------------
				$style_dir	= "./smpl_pic/";  
				$no_img		= "./images/graydot.gif";
			if(file_exists($style_dir.$op['wi']['style_code'].".jpg")){
				$op['wi']['pic_url'] = $style_dir.$op['wi']['style_code'].".jpg";
			} else {
				$op['wi']['pic_url'] = $no_img;
			}
		
		//  取出主料記錄 -----------------------------------------------------
		$where_str = " WHERE smpl_code = '".$op['wi']['style_code']."' ";
		$lots = $smplord_lots->search(0,$where_str);  //取出該筆 樣本主料記錄
		$op['lots_use'] = $lots;

		if (!is_array($op['lots_use'])) {
			$op['msg'] = $smplord_lots->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		if (!count($op['lots_use'])){	$op['lots_NONE'] = "1";		}

		//  取出副料料記錄  -----------------------------------------------------
		$where_str = " WHERE smpl_code = '".$op['wi']['style_code']."' ";
		$acc = $smplord_acc->search(0,$where_str);  //取出該筆 樣本主料記錄
		$op['acc_use'] = $acc;

		if (!is_array($op['acc_use'])) {     
			$op['msg'] = $smplord_acc->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		if (!count($op['acc_use'])){	$op['acc_NONE'] = "1";		}

			// 做出 unit的 combo
		$op['unit'] = $arry2->select($APPAREL_UNIT,$op['wi']['unit'],'PHP_unit','select','');  	

		// creat sample type combo box
		$sample_def = $smpl_type->get_fields('smpl_type');   // 取出 樣本類別
		$op['smpl_type'] =  $arry2->select($sample_def,$op['wi']['smpl_type'],'PHP_smpl_type','select','');  	
		$mseeage = "Successfully copy [".$op['wi']['wi_num']."] ";
		$log->log_add(0,"23E",$mseeage);
			$op['msg'] = $smpl_wi->msg->get(2);

		page_display($op, "010", $TPL_SMPL_WI_EDIT);
		break;

//=======================================================
	case "smpl_wi_edit":

		check_authority("010","edit");

		// 將 製造令 完整show out ------
		//  wi 主檔 抓出來
		if(!$op = $smpl_wi->get_all($PHP_id)){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
	//檢視是否可以修改size(即是否存在colorway)
		if ($smpl_wi->check_size($op['wi']['style_code']))
		{
			$op['size_edit']=1;
		}

		//  wi_qty 數量檔 -----------------------------------------------------------------
		$where_str = " WHERE wi_id='".$PHP_id."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		// 取出 size_scale --------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);


//search條件記錄			
		if (isset($PHP_dept_code))
		{
			$PHP_back_str = "&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
			$op['back_str']=$PHP_back_str;
			$PHP_back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
			$op['back_str2']=$PHP_back_str2;

		}else{
			$op['back_str']=$PHP_back_str;
			$op['back_str2']=$PHP_back_str2;
		}
		// 做出 size table-------------------------------------------
		$op['show_del_breakdown'] = show_del_breakdown($T_wiqty,$sizing,$PHP_back_str2,$size_A['base_size'],0,0,0,"sample");
		$op['edit_breakdown'] = edit_breakdown($sizing,$PHP_back_str2,$size_A['base_size']);

		// 做出 unit的 combo
		$op['unit'] = $arry2->select($APPAREL_UNIT,$op['wi']['unit'],'PHP_unit','select','');  	

		// creat sample type combo box
		$sample_def = $smpl_type->get_fields('smpl_type');   // 取出 樣本類別
		$op['smpl_type'] =  $arry2->select($sample_def,$op['wi']['smpl_type'],'PHP_smpl_type','select','');  	
			
		$op['msg'] = $smpl_wi->msg->get(2);

		page_display($op, "010", $TPL_SMPL_WI_EDIT);
		break;

//=======================================================
	case "smpl_edit_add_colorway":

		check_authority("010","edit");
		// 傳入 javascript傳出的參數 [ colorway : 必然輸入已由 javascript撿查 ]
		$parm['qty']		= $PHP_qty;   // 由javascript傳出的陣列值 自動改成csv傳出
		$parm['wi_id']		= $wi_id;
		$parm['colorway']	= $colorway;

		// 加入 新色組 ----- 加入 wiqty table -----------------
		if(!$T_del =	$smpl_wiqty->add($parm)){    
						$op['msg']= $wi->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
		}

		// 將 製造令 完整show out ---------------------------------------------
		//  wi 主檔 抓出來 ----------------------------------------------------
		if(!$op = $smpl_wi->get_all($wi_id)){    //取出該筆 製造令記錄
					$op['msg']= $smpl_wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
//檢視是否可以修改size(即是否存在colorway)
		if ($smpl_wi->check_size($op['wi']['style_code']))
		{
			$op['size_edit']=1;
		}

	//  更新 製造令 版本 ----- 更改 wi table -----------------
/*
			$edit_version[0] = $wi_id;
			$edit_version[1] = "version";
			$edit_version[2] = $op['wi']['version']+1;
	
				if(!$T_updt =	$smpl_wi->update_field($edit_version)){    
								$op['msg']= $wi->msg->get(2);
								$layout->assign($op);
								$layout->display($TPL_ERROR);  		    
								break;
				}
			$op['wi']['version'] = $edit_version[2];    // 將新的 version 代入
*/
				# 記錄使用者動態
		$message = "Successfully add wi[".$op['wi']['wi_num']."] colorway[".$colorway."]•";
		$log->log_add(0,"23E",$message);

		//  wi_qty 數量檔 -----------------------------------------------------------------
		$where_str = " WHERE wi_id='".$wi_id."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		// 取出 size_scale --------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);
		
		
		$back_str = "&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str']=$back_str;
		$back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str2']=$back_str2;


		// 做出 size table-------------------------------------------		
		$op['show_del_breakdown'] = show_del_breakdown($T_wiqty,$sizing,$back_str2,$size_A['base_size']);
		$op['edit_breakdown'] = edit_breakdown($sizing,$back_str2,$size_A['base_size']);

		$op['msg'] = $wi->msg->get(2);

			// 做出 unit的 combo
		$op['unit'] = $arry2->select($APPAREL_UNIT,$op['wi']['unit'],'PHP_unit','select','');  	

		// creat sample type combo box
		$sample_def = $smpl_type->get_fields('smpl_type');   // 取出 樣本類別
		$op['smpl_type'] =  $arry2->select($sample_def,$op['wi']['smpl_type'],'PHP_smpl_type','select','');  	
			
		$op['msg'][] = $message;
		$op['new_revise'] = $op['wi']['revise'];
		
		if(!empty($PHP_revice))
		{
			page_display($op, "010", $TPL_SMPL_WI_REVISE);
		}else{
			page_display($op, "010", $TPL_SMPL_WI_EDIT); 
		}
		break;

//=======================================================
		case "smpl_edit_del_colorway_ajx":

		check_authority("010","edit");
		
		$size_edit=0;
		
		// 刪除 指定之色組 ----------------------------
		if(!$T_del =	$smpl_wiqty->del($id)){    
						$op['msg']= $smpl_wiqty->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
		}



//檢視是否可以修改size(即是否存在colorway)
		if ($smpl_wi->check_size($PHP_wi_num))
		{
			$size_edit=1;
		}

		# 記錄使用者動態
		$message = "Success delete wi[".$PHP_wi_num."] colorway[".$colorway."]";
		$log->log_add(0,"23E",$message);
		echo $message.'|'.$size_edit;
		exit;
		break;
		
//=======================================================
	case "do_smpl_wi_edit":

		check_authority("010","edit");
		$argv = array(	"id"			=>  $PHP_wi_id,
									"wi_num"		=>	$PHP_wi_num,
									"smpl_id"		=>	$PHP_smpl_id,						
									"version"		=>	$PHP_version,
										"etd"			=>	$PHP_etd,
						
									"unit"			=>	$PHP_unit,
						"lots_est_array"	=>	$PHP_lots_est,
						"acc_est_array"		=>	$PHP_acc_est,
						"updator"		=>	$GLOBALS['SCACHE']['ADMIN']['login_id']
			);
			
		if(!$f1=$smpl_wi->check2($argv))
		{
					// 將 製造令 完整show out ------
			//  wi 主檔 抓出來
			if(!$op = $smpl_wi->get_all($PHP_wi_id)){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
			}
		//檢視是否可以修改size(即是否存在colorway)
			if ($smpl_wi->check_size($op['wi']['style_code']))
			{
				$op['size_edit']=1;
			}

			//  wi_qty 數量檔 -----------------------------------------------------------------
			$where_str = " WHERE wi_id='".$PHP_wi_id."' ";
			$T_wiqty = $smpl_wiqty->search(1,$where_str);

			// 取出 size_scale --------
			$size_A = $size_des->get($op['smpl']['size']);
			$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
			$sizing = explode(",", $size_A['size']);


//search條件記錄			
			$op['back_str']=$PHP_back_str;
 			$op['back_str2']=$PHP_back_str2;
			// 做出 size table-------------------------------------------
			$op['show_del_breakdown'] = show_del_breakdown($T_wiqty,$sizing,$PHP_back_str2,$size_A['base_size']);
			$op['edit_breakdown'] = edit_breakdown($sizing,$PHP_back_str2,$size_A['base_size']);
			// 做出 unit的 combo
			$op['unit'] = $arry2->select($APPAREL_UNIT,$op['wi']['unit'],'PHP_unit','select','');  	
			
			$op['msg'] = $smpl_wi->msg->get(2);

			page_display($op, "010", $TPL_SMPL_WI_EDIT);
			break;
		}
		if(!$op['wi'] = $smpl_wi->get($PHP_wi_id)){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
		if(!$argv['etd']) $argv['etd']=$op['wi']['etd'];

// UPDATE  wi 資料表內[etd],[smpl_type][unit] 三個欄 且將version 加一
		//加入size部分資料		
		$size_id=$PHP_Size_id;
		if ($PHP_Size_add==1)
		{
			if ($PHP_Size_id==0)
			{
				$PHP_Size_item = strtoupper($PHP_Size_item);
				$PHP_Size = strtoupper($PHP_Size);
				$PHP_base_size = strtoupper($PHP_base_size);
				$parm=array(	'cust'			=>	$PHP_cust,
								'dept'			=>	$PHP_dept_code,
								'size'			=>	$PHP_Size_item,
								'size_scale'	=>	$PHP_Size,
								'base_size'		=>	$PHP_base_size,
								'check'			=>	1,
				);
				$size_id=$size_des->add($parm);				
			}
			$smpl3['field_name']='size';
			$smpl3['field_value']=$size_id;
			$smpl3['id']=$PHP_smpl_id;	
			$f1 = $smpl_ord->update_field($smpl3);
		}
		
		$smpl2['field_name']='etd';
		$smpl2['field_value']=$argv['etd'];
		$smpl2['id']=$PHP_smpl_id;		
		$f1 = $smpl_ord->update_field($smpl2);
		
		$updt = array(	"etd"			=>	$argv['etd'],						
						"unit"			=>	$argv['unit'],
						"version"		=>	$argv['version'] +1,
						"updator"		=>	$argv['updator'],
						"id"			=>	$argv['id']
			);
				if(!$smpl_wi->edit($updt)){
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}


		// 將主副料 修改後 預估寫入 主副料使用檔內 lots_use, acc_use  ....
		// 主料 -----------------------------------------------------------------------------
		if(($argv['lots_est_array'])){
			while(list($key,$val) = each($argv['lots_est_array'])){
				if($val){
					$lots = array($key,"est_1",$val);
					if(!$smplord_lots->update_field($lots)){
						$op['msg']= $smplord_lots->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
					}

					$updt = array($key,"ester_1",$argv['updator']);
					if(!$smplord_lots->update_field($updt)){
						$op['msg']= $smplord_lots->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
					}
				}
			}
		}
		// 副料 ------------------------------------------------------------------------------
		if(($argv['acc_est_array'])){
			while(list($key,$val) = each($argv['acc_est_array'])){
				if($val){
					$acc = array($key,"est_1",$val);
					if(!$smplord_acc->update_field($acc)){
						$op['msg']= $smplord_acc->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
					}

					$updt = array($key,"ester_1",$argv['updator']);
					if(!$smplord_acc->update_field($updt)){
						$op['msg']= $smplord_acc->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
					}
				}
			}
		}

		//--------------- 完成修改寫入------------------

		//--------------- 列出改後之記錄------------------
		//  wi 主檔 --------------------------------------------------------------------------------
		if(!$op = $smpl_wi->get_all($argv['id'])){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}

		//  wi_qty 數量檔 --------------------------------------------------------------------------
			$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);

		// 取出 size_scale -----------------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

		// 做出 size table-------------------------------------------
		$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
		$op['show_breakdown'] = $reply['html'];
		$op['total'] = $reply['total'];
		//-----------------------------------------------------------------

		//檔案列表
		$op['done'] = $fils->get_smpl_file($op['wi']['wi_num']);
	
		# 記錄使用者動態
		$message = "Successfully update wi:[".$op['wi']['wi_num']."]";
		$log->log_add(0,"23E",$message);
		$op['msg'][] = $message;
 		$op['back_str']=$PHP_back_str;
 		$op['back_str2']=$PHP_back_str2;
			page_display($op, "010", $TPL_SMPL_WI_VIEW);	
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "smpl_wi_del":

			// 必需要 manager login 才能真正的刪除 SUPLIER  ----------------------------------
		if(!$admin->is_power("010","del")  && !($GLOBALS['SCACHE']['ADMIN']['id'] == "SA" )) {
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['wi'] = $smpl_wi->get($PHP_id);

		// 刪除 wi 主檔資料 ---------------------------------------------------
		if (!$smpl_wi->del($PHP_id)) {
			$op['msg'] = $smpl_wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}
		// 刪除 wi qty 數量檔資料 ---------------------------------------------------
		if (!$smpl_wiqty->del($PHP_id,'1')) {
			$op['msg'] = $smpl_wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}
					
		// 刪除 TI 說明檔資料 ---------------------------------------------------
		if (!$smpl_ti->del($PHP_id,'1')) {
			$op['msg'] = $wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}

		
		// 刪除 COMMENTS 客戶意見檔資料 ---------------------------------------------------
		

		// 刪除 BOM 檔資料 ---------------------------------------------------

		
		
		
		// 解除 smpl 記錄中之 marked ---------------------------------------------------
		$smpl2['field_name']='marked';
		$smpl2['field_value']='';
		$smpl2['id']=$op['wi']['smpl_id'];
		if (!$smpl_ord->update_field($smpl2)) {
			$op['msg']= $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		// 解除 smpl 記錄中之 marked ---------------------------------------------------
		$smpl1['field_name']='m_status';
		$smpl1['field_value']='0';
		$smpl1['id']=$op['wi']['smpl_id'];
		if (!$smpl_ord->update_field($smpl1)) {
			$op['msg']= $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
					
					
					# 記錄使用者動態
		$message = "Successfully delete wi:[".$op['wi']['wi_num']."] 。";
//		$log->log_add(0,"23D",$message);

		$back_str = "index2.php?&PHP_action=smpl_wi_search&PHP_sr_startno=".$PHP_sr_startno."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		redirect_page($back_str);
    	    
		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//   wi_cfm      //  WI CFM...........
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "smpl_wi_uncfm":
		check_authority("011","view");
		
		if (!$op = $smpl_wi->search_uncfm('wi')) {
			$op['msg']= $smpl_wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$back_str="&PHP_dept_code=&PHP_num=&PHP_cust=&PHP_ref=&PHP_factory=&PHP_etdstr=&PHP_etdfsh=";
		for ($i=0; $i<sizeof($op['wi']); $i++)
		{
			$where_str="WHERE smpl_code = '".$op['wi'][$i]['wi_num']."'";
			$op['wi'][$i]['lots']=$smplord_lots->get_fields('id',$where_str);
			$op['wi'][$i]['acc']=$smplord_acc->get_fields('id',$where_str);
		}
		//2006/05/02 update
		$op['dept_id'] = get_dept_id();
		
		// 如果是 manager 進入時...
		if (substr($op['dept_id'],0,7) == "<select"){
			$op['manager_flag'] = 1;
		}	
				$op['msg']= $smpl_wi->msg->get(2);
				$op['back_str']= $back_str;

//080725message增加		
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];

			page_display($op, "011", $TPL_SMPL_WI_UNCFM_LIST);
		break;
//========================================================================================	
	case "smpl_wi_cfm_qty_edit":

		check_authority("010","view");

		// 將 製造令 完整show out ------
		//  wi 主檔
			
		if(!$op = $smpl_wi->get_all($PHP_id)){    //取出該筆 製造令記錄 ID
						$op['msg']= $smpl_wi->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
		}
//--------------------------------------------------------------------------
		//  wi_qty 數量檔
		$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);

		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = breakdown_cfm_edit($T_wiqty,$sizing,$size_A['base_size']);
		$op['show_breakdown'] = $reply['html'];
		$op['total'] = $reply['total'];
		
		//-----------------------------------------------------------------
		$op['i'] = count($sizing);
		$op['j']= count($T_wiqty);
		
		$back_str = "&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str']=$back_str;
		$back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str2']=$back_str2;
		$op['now_pp']=$PHP_sr;
			if (isset($PHP_msg))$op['msg'][]=$PHP_msg;
		page_display($op, "010", $TPL_SMPL_WI_QTY_EDIT);			
		break;
		
	
//========================================================================================	
	case "smpl_edit_color_qty":

		check_authority("010","view");
		$tmp_qty_csv='';

		$wqty_id=explode(',',$PHP_wqty_id);
		$qty_item=explode(',',$PHP_qty_item);
		$tmp_i=count($wqty_id);
		$tmp_j=count($qty_item);
		$count_qty= count($qty_item)/ count($wqty_id);
		
		$k=0;
			for ($i=0; $i< sizeof($wqty_id); $i++)
			{
				for ($j=0; $j < $count_qty; $j++)
				{
					$tmp_qty_csv=$tmp_qty_csv.$qty_item[$k].',';
					$k++;
				}
				$tmp_qty_csv=substr($tmp_qty_csv,0,-1);
				$smpl_wiqty->update_field('qty', $tmp_qty_csv, $wqty_id[$i]);				
				$tmp_qty_csv='';
			}
			
		//xxxxx訂單數量xxxx
		$s_ord=$smpl_ord->get($PHP_ord_id);

		if ($s_ord['qty'] <>$PHP_ord_qty)
		{
			
			$tmp_qty = $PHP_ord_qty - $s_ord['qty'];
			$backup = $s_ord['backup']+$tmp_qty;
			$rq = $s_ord['rq'];
			if ( $backup < 0)
			{
				$rq = $rq+$backup;
				$backup = 0;
			}
			// 寫入 total qty
			$parm=array('field_name'	=>	'qty',
									'field_value'	=>	$PHP_ord_qty,
									'id'					=>	$PHP_ord_id
			);
			$smpl_ord->update_field($parm);
			// 寫入 back up qty
			$parm=array('field_name'	=>	'backup',
									'field_value'	=>	$backup,
									'id'					=>	$PHP_ord_id
			);
			$smpl_ord->update_field($parm);
			// 寫入 require qty
			$parm=array('field_name'	=>	'rq',
									'field_value'	=>	$rq,
									'id'					=>	$PHP_ord_id
			);
			$smpl_ord->update_field($parm);
			
		}

		$message="success edit sample order qty on wi cfm:[".$s_ord['num']."]";
		$log->log_add(0,"21E",$message);	
		$log->log_add(0,"23E",$message);	
			
			$op['msg'] = $wi->msg->get(2);
			$PHP_back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
			
			$redir_str=$PHP_SELF.'?PHP_action=smpl_wi_view&PHP_id='.$PHP_wi_id.$PHP_back_str2.'&PHP_cfm_view=1&PHP_msg='.$message;
			redirect_page($redir_str);
			break;
	
		
//=======================================================
	case "do_smpl_wi_cfm":
		check_authority("011","view");
		
		$parm = array(	"order_num" =>	$PHP_order_num,
										"id"				=>	$PHP_id,
										"date"			=>	$dt['date_str'],
										"user"			=>	$GLOBALS['SCACHE']['ADMIN']['login_id']
					  );
		
		if (isset($PHP_msg))
		{
		if (substr($PHP_msg,0,1)<> 's')
		{
			//echo $PHP_msg;
			
			if ($PHP_msg == "ERROR! Please check Sample Order Q'TY and Sample WI Q'TY first!")
			{
				//echo "here";
				$redir_str=$PHP_SELF.'?PHP_action=smpl_wi_cfm_qty_edit&PHP_id='.$PHP_id.$PHP_back_str2.'&PHP_cfm_view=1&PHP_msg='.$PHP_msg;
				redirect_page($redir_str);
				break;		
			}
			$redir_str=$PHP_SELF.'?PHP_action=smpl_wi_view&PHP_id='.$PHP_id.$PHP_back_str2.'&PHP_cfm_view=1&PHP_msg='.$PHP_msg;
			redirect_page($redir_str);
			break;
		}
		}
		$f1 = $smpl_wi->cfm($parm);
		if (!$f1) {
			$op['msg']= $smpl_wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}		
		$message="success CFM WI:[".$PHP_wi."]";
		$log->log_add(0,"24A",$message);
		
//傳送message給RD人員
	$rcd['wi'] =  $smpl_wi->get($PHP_id);
	if($rcd['wi']['status'] > 0 && $rcd['wi']['ti_cfm'] <> '0000-00-00' )
	{
	 if($PHP_fty == 'WX') $PHP_fty = 'HJ';
	 $messg  = ' 製造令(Working Instruction) : <a href=index2.php?PHP_action=smpl_wi_view&PHP_id='.$PHP_id.$PHP_back_str2.'>'.$PHP_order_num.'</a>';
	 $messg  .= ' 製造說明 (WorkSheet) : <a href=index2.php?PHP_action=smpl_wi_view&PHP_ti=1&PHP_id='.$PHP_id.$PHP_back_str2.'>'.$PHP_order_num.'</a>';
	 $notify->system_msg_send_with_mail('2-4-S',$PHP_fty,$PHP_order_num,$messg);
	}		
		
			$parm_update = array($PHP_id,'last_update',$dt['date_str']);
			$smpl_wi->update_field($parm_update);
			$parm_update = array($PHP_id,'updator',$GLOBALS['SCACHE']['ADMIN']['login_id']);
			$smpl_wi->update_field($parm_update);

		// --- 判斷如何更改 status   ######  ---------------
		$smpl = $smpl_ord->get($PHP_smpl_id);  //取出該筆記錄
		if (!$smpl) {
			$op['msg'] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		if ($PHP_revise == 0)
		{
				$parm=array($PHP_id,'revise','1');
				$smpl_wi->update_field($parm);
		}

	if ($smpl['status'] < 4)
	{
		// 先寫入  smpl_ord 表內的 wi_date  ---------------
		$argu['field_name'] = 'wi_date';
		$argu['field_value'] = $TODAY;
		$argu['id'] = $PHP_smpl_id;
		if(!$ord = $smpl_ord->update_field($argu)){
			$op['msg'][] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		} 
		if ($smpl['pttn_suppt'] && $smpl['rcvd_pttn'] == '0000-00-00'){
			$new_status = 1;
		}elseif(!$smpl['fab_substu'] && $smpl['rcvd_fab'] == '0000-00-00'){
			$new_status = 2;
		}elseif(!$smpl['acc_substu'] && $smpl['rcvd_acc'] == '0000-00-00'){
			$new_status = 3;
		}else{
			$new_status = 4;
		}
		
		// ---- 寫入  smpl_ord 表內的 status  ---------------
		$argu['field_name'] = 'status';
		$argu['field_value'] = $new_status;
		$argu['id'] = $PHP_smpl_id;
		if(!$ord = $smpl_ord->update_field($argu)){
			$op['msg'][] = $smpl_ord->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		} 
		# 記錄使用者動態
		$message1 = "CFM received W/I of [".$PHP_wi."] on:".$TODAY;
		$log->log_add(0,"27A",$message1);
	}
		
		if (!$op = $smpl_wi->search_uncfm('wi')) {
			$op['msg']= $wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		for ($i=0; $i<sizeof($op['wi']); $i++)
		{
			$where_str="WHERE smpl_code = '".$op['wi'][$i]['wi_num']."'";
			$op['wi'][$i]['lots']=$smplord_lots->get_fields('id',$where_str);
			$op['wi'][$i]['acc']=$smplord_acc->get_fields('id',$where_str);
		}

		$back_str="&PHP_dept_code=&PHP_style_code=&PHP_cust=&PHP_num=&PHP_factory=&PHP_ref=&PHP_etdstr=&PHP_etdfsh=";

		//2006/05/02 update
		$op['dept_id'] = get_dept_id();
		
		// 如果是 manager 進入時...
		if (substr($op['dept_id'],0,7) == "<select"){
			$op['manager_flag'] = 1;
		}
		
				$op['msg'][]= $message;
				$op['back_str']= $back_str;
			page_display($op, "011", $TPL_SMPL_WI_UNCFM_LIST);
		break;

//=======================================================
	case "revise_smpl_wi":
		check_authority("010","edit");

//刪除Bom相關資料
		$f1=$smpl_bom->del_lots($PHP_id,1);
		$f2=$smpl_bom->del_acc($PHP_id,1);	

		// 將 製造令 完整show out ------
		//  wi 主檔 抓出來		
		
		if(!$op = $smpl_wi->get_all($PHP_id)){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
		
//檢視是否可以修改size(即是否存在colorway)
		if ($smpl_wi->check_size($op['wi']['style_code']))
		{
			$op['size_edit']=1;
		}

//revise次數等輸入		
			$parm['date'] 		= '0000-00-00 00:00:00';
			$parm['user'] 		= "";
			$parm['rev'] 		= $op['wi']['revise']+1;
			$parm['id'] 		= $op['wi']['id'];
			$parm['order_num'] 	= $op['wi']['smpl_id'];
	

				if(!$T_updt =	$smpl_wi->revise($parm)){    
								$op['msg']= $wi->msg->get(2);
								$layout->assign($op);
								$layout->display($TPL_ERROR);  		    
								break;
				}		
			$op['wi']['revise']=$parm['rev'];

// 先寫入  smpl_ord 表內的 wi_date  ---------------
			$argu['field_name'] = 'wi_date';
			$argu['field_value'] = '0000-00-00';
			$argu['id'] = $op['smpl']['id'];
		if(!$ord = $smpl_ord->update_field($argu)){
			$op['msg'][] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 
// 更改 status   ######  -----------------
// 寫入  smpl_ord 表內的 status  ---------------
			$argu['field_name'] = 'status';
			$argu['field_value'] = 0;
			$argu['id'] =  $op['smpl']['id'];
		if(!$ord = $smpl_ord->update_field($argu)){
			$op['msg'][] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 

		//  wi_qty 數量檔 -----------------------------------------------------------------
		$where_str = " WHERE wi_id='".$PHP_id."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		// 取出 size_scale --------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);


//search條件記錄			
		if (isset($PHP_dept_code))
		{
			$back_str = "&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
			$op['back_str']=$back_str;
			$back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
			$op['back_str2']=$back_str2;

		}else{
			$op['back_str']=$PHP_back_str;
			$op['back_str2']=$PHP_back_str2;
		}
		// 做出 size table-------------------------------------------
		$op['show_del_breakdown'] = show_del_breakdown($T_wiqty,$sizing,$PHP_back_str2,$size_A['base_size']);
		$op['edit_breakdown'] = edit_breakdown($sizing,$PHP_back_str2,$size_A['base_size']);

		// 做出 unit的 combo
		$op['unit'] = $arry2->select($APPAREL_UNIT,$op['wi']['unit'],'PHP_unit','select','');  	

		// creat sample type combo box
		$sample_def = $smpl_type->get_fields('smpl_type');   // 取出 樣本類別
		$op['smpl_type'] =  $arry2->select($sample_def,$op['wi']['smpl_type'],'PHP_smpl_type','select','');  	
			
		$op['msg'] = $wi->msg->get(2);
		
		$op['new_revise'] = $op['wi']['revise'];

		page_display($op, "010", $TPL_SMPL_WI_REVISE);
		break;

//=======================================================
		case "do_smpl_wi_revise_show":


		check_authority("010","edit");
		$argv = array(	"id"			=>  $PHP_wi_id,
						"wi_num"		=>	$PHP_wi_num,
						"smpl_id"		=>	$PHP_smpl_id,
						"version"		=>	$PHP_version,
						"etd"			=>	$PHP_etd,
						
						"unit"			=>	$PHP_unit,
						"lots_est_array"	=>	$PHP_lots_est,
						"acc_est_array"		=>	$PHP_acc_est,
						"updator"		=>	$GLOBALS['SCACHE']['ADMIN']['login_id']
			);
			
		if(!$f1=$smpl_wi-> check2($argv))
		{
			// 將 製造令 完整show out ------
			//  wi 主檔 抓出來			
			if(!$op = $smpl_wi->get_all($PHP_wi_id)){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
			}
		
			//檢視是否可以修改size(即是否存在colorway)
			if ($smpl_wi->check_size($op['wi']['style_code']))
			{
				$op['size_edit']=1;
			}
			//  wi_qty 數量檔 -----------------------------------------------------------------
			$where_str = " WHERE wi_id='".$PHP_wi_id."' ";
			$T_wiqty = $smpl_wiqty->search(1,$where_str);

			// 取出 size_scale --------
			$size_A = $size_des->get($op['smpl']['size']);
			$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
			$sizing = explode(",", $size_A['size']);


		//search條件記錄			
			$op['back_str']=$PHP_back_str;
			$op['back_str2']=$PHP_back_str2;
		// 做出 size table-------------------------------------------
			$op['show_del_breakdown'] = show_del_breakdown($T_wiqty,$sizing,$PHP_back_str2,$size_A['base_size']);
			$op['edit_breakdown'] = edit_breakdown($sizing,$PHP_back_str2,$size_A['base_size']);
		// 做出 unit的 combo
			$op['unit'] = $arry2->select($APPAREL_UNIT,$op['wi']['unit'],'PHP_unit','select','');  	
			
			$op['msg'] = $smpl_wi->msg->get(2);
		
			$op['new_revise'] = $op['wi']['revise'];

			page_display($op, "010", $TPL_SMPL_WI_REVISE);
			break;
		}
		if(!$op['wi'] = $smpl_wi->get($argv['id'])){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
		if (!$argv['etd'])$argv['etd']=$op['wi']['etd'];

// UPDATE  wi 資料表內[etd],[smpl_type][unit] 三個欄 且將version 加一
		//size修改
		$size_id=$PHP_Size_id;
		if ($PHP_Size_add==1)
		{
			if ($PHP_Size_id==0)
			{
				$PHP_Size_item = strtoupper($PHP_Size_item);
				$PHP_Size = strtoupper($PHP_Size);
				$PHP_base_size = strtoupper($PHP_base_size);
				$parm=array(	'cust'			=>	$PHP_cust,
								'dept'			=>	$PHP_dept_code,
								'size'			=>	$PHP_Size_item,
								'size_scale'	=>	$PHP_Size,
								'base_size'		=>	$PHP_base_size,
								'check'			=>	1,
				);
				$size_id=$size_des->add($parm);				
			}
			$smpl2['field_name']='size';
			$smpl2['field_value']=$size_id;
			$smpl2['id']=$PHP_smpl_id;
			$f1 = $smpl_ord->update_field($smpl2);
		}
		$smpl3['field_name']='etd';
		$smpl3['field_value']=$argv['etd'];
		$smpl3['id']=$PHP_smpl_id;
		$f1 = $smpl_ord->update_field($smpl3);
		
		$updt = array(	"etd"			=>	$argv['etd'],
						"unit"			=>	$argv['unit'],
						"version"		=>	$argv['version'],
						"updator"		=>	$argv['updator'],
						"id"			=>	$argv['id']
			);
				if(!$smpl_wi->edit($updt)){
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}


		// 將主副料 修改後 預估寫入 主副料使用檔內 lots_use, acc_use  ....
		// 主料 -----------------------------------------------------------------------------
		if(($argv['lots_est_array'])){
			while(list($key,$val) = each($argv['lots_est_array'])){
				if($val){
					$lots = array($key,"est_1",$val);
					if(!$smplord_lots->update_field($lots)){
						$op['msg']= $smpl_lots->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
					}

					$updt = array($key,"ester_1",$argv['updator']);
					if(!$smplord_lots->update_field($updt)){
						$op['msg']= $smpl_lots->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
					}
				}
			}
		}
		// 副料 ------------------------------------------------------------------------------
		if(($argv['acc_est_array'])){
			while(list($key,$val) = each($argv['acc_est_array'])){
				if($val){
					$acc = array($key,"est_1",$val);
					if(!$smplord_acc->update_field($acc)){
						$op['msg']= $smpl_acc->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
					}

					$updt = array($key,"ester_1",$argv['updator']);
					if(!$smplord_acc->update_field($updt)){
						$op['msg']= $smpl_acc->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
					}
				}
			}
		}

		//--------------- 完成修改寫入------------------

		//--------------- 列出改後之記錄------------------
		//  wi 主檔 --------------------------------------------------------------------------------
		if(!$op = $smpl_wi->get_all($argv['id'])){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
		//  wi_qty 數量檔 --------------------------------------------------------------------------
		$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);

		// 取出 size_scale -----------------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

		// 做出 size table-------------------------------------------
		$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
		$op['show_breakdown'] = $reply['html'];
		$op['total'] = $reply['total'];
		//-----------------------------------------------------------------

		//檔案列表
		$op['done'] = $fils->get_smpl_file($op['wi']['wi_num']);
	
		# 記錄使用者動態
		$message = "Successfully Revise wi:[".$op['wi']['wi_num']."]•";
		$log->log_add(0,"23E",$message);
		$op['msg'][] = $message;
 		$op['back_str']=$PHP_back_str;
 		$op['back_str2']=$PHP_back_str2;

		page_display($op, "010", $TPL_SMPL_WI_REVISE_SHOW);
		break;



//=======================================================
//		 生產說明
//=======================================================


	case "search_smpl_ti_copy":

	$op['wi']=$smpl_wi->copy_ti_search($PHP_c_cust, $PHP_c_dept);

  $op['copy_search'] = "&PHP_smpl_id=".$PHP_smpl_id."&PHP_c_dept=".$PHP_c_dept."&PHP_c_cust=".$PHP_c_cust;
		if (isset($PHP_dept_code))
		{
			$PHP_back_str = "&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
			$op['back_str']=$PHP_back_str;
			$PHP_back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
			$op['back_str2']=$PHP_back_str2;

		}else{
			$op['back_str']="&PHP_sr_startno=&PHP_dept_code=&PHP_num=&PHP_cust=&PHP_ref=&PHP_factory=&PHP_etdstr=&PHP_etdfsh=";
			$op['back_str2']="&PHP_sr=&PHP_dept_code=&PHP_num=&PHP_cust=&PHP_ref=&PHP_factory=&PHP_etdstr=&PHP_etdfsh=";
			$PHP_back_str2=$op['back_str2'];
		}
	page_display($op, "010", $TPL_SMPL_TI_COPY_SEARCH);
	break;


//========================================================================================	
	case "smpl_ti_copy_view":

		check_authority("010","view");

		// 將 製造令 完整show out ------
		//  wi 主檔

			if(!$op = $smpl_wi->get_all($PHP_id)){    //取出該筆 製造令記錄 ID
						$op['msg']= $smpl_wi->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
			}
//--------------------------------------------------------------------------
		//  wi_qty 數量檔
		$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);

		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
		$op['show_breakdown'] = $reply['html'];
		$op['total'] = $reply['total'];
		//-----------------------------------------------------------------

//檔案列表
		$op['done'] = $fils->get_smpl_file($op['wi']['wi_num']);

		if(count($op['ti']))
		{
		 for ($i=0; $i<sizeof($op['ti']); $i++)
			$op['ti'][$i]['detail'] = str_replace( chr(13).chr(10), "<br>", $op['ti'][$i]['detail'] );
		}

    $op['org_smpl_id'] = $PHP_smpl_id;
    $op['copy_search'] = "&PHP_smpl_id=".$PHP_smpl_id."&PHP_c_dept=".$PHP_c_dept."&PHP_c_cust=".$PHP_c_cust;

		$back_str = "&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str']=$back_str;
		$back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str2']=$back_str2;

		page_display($op, "010", $TPL_SMPL_TI_COPY_VIEW);			
		break;

//=======================================================
    case "do_smpl_ti_copy":
		check_authority("010","add");
		// 將 製造令 完整show out ------
		//  wi 主檔
		
		$f1=$smpl_ti->del_wi_id($PHP_smpl_id);	//COPY動作執行前,先把之前的WS刪除,避免重覆資料
		$f1=$smpl_wi->copy_ti($PHP_id,$PHP_smpl_id);

		$smpl_wi->get_all($PHP_smpl_id);
		$message = "Add WI:[".$op['wi']['wi_num']."] Description Copy。";
		$log->log_add(0,"23C",$message);
		$sub_ti = array();
		$redir_str=$PHP_SELF.'?PHP_action=smpl_ti_add&PHP_id='.$PHP_smpl_id.$PHP_back_str2.'&PHP_msg='.$message;
		redirect_page($redir_str);
		break;

//=======================================================
    case "smpl_ti_add":
		
		check_authority("010","add");
		// 將 製造令 完整show out ------
		//  wi 主檔
		if(!$op = $smpl_wi->get_all($PHP_id)){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
//--------------------------------------------------------------------------
		//  wi_qty 數量檔
		$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);

		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);


		// 做出 size table-------------------------------------------
		$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
		$op['show_breakdown'] = $reply['html'];
		$op['total'] = $reply['total'];
		//---------------------------------------------------------------
		//檔案列表
		$op['done'] = $fils->get_smpl_file($op['wi']['wi_num']);
		if(!isset($PHP_msg) || !$PHP_msg) $sub_ti = array();
		
		if(is_array($sub_ti) && sizeof($sub_ti) > 0) $op['sub_ti'] =  $sub_ti;


		$op['sub_ti_new'] = 0 ;

		if(!isset($op['sub_ti']))
		{
			
				 $op['sub_ti'][0]['name'] = 'main';
				 $op['sub_ti'][0]['i'] = 0;
				 $op['sub_ti'][0]['new_ti'] = 1;
				 $op['sub_ti'][0]['PHP_group_exist'] = 'no';
				 $op['sub_ti_new'] = 1;

			for($i = 0; $i<sizeof($ti_style[$op['smpl']['style']]); $i++)
			{
				$op['sub_ti'][0]['txt'][$i]['id'] = $i;
				$op['sub_ti'][0]['txt'][$i]['item'] = $ti_style[$op['smpl']['style']][$i];
				$op['sub_ti'][0]['txt'][$i]['detail'] = '';
			}		
		}

		if(sizeof($sub_ti) == 0) $sub_ti = $op['sub_ti'];
			
		
		// creat combo
		if (isset($PHP_dept_code))
		{
		$back_str = "&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str']=$back_str;
		$back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str2']=$back_str2;
		}else{
			$op['back_str']=$PHP_back_str;
			$op['back_str2']=$PHP_back_str2;
		}
		foreach($op['sub_ti'] as $subti_key => $subti_value)
		{
			foreach($op['sub_ti'][$subti_key]['txt'] as $subtitxt_key => $subtitxt_value)
			{
				$op['detail_id'][$subti_key][$subtitxt_key] = $subtitxt_value['id'];
				$op['item'][$subti_key][$subtitxt_key] = $subtitxt_value['item'];
			}
		}

		if (isset($PHP_msg) && $PHP_msg)$op['msg'][]=$PHP_msg;
		page_display($op, "010", $TPL_SMPL_TI_ADD);
		break;

//=======================================================
    case "do_smpl_ti_add":
		check_authority("010","add");
		//print_r($_POST);
		//exit;
		if($PHP_new_add == 1)
		{
			echo "1";
			//break;
			//value與key變數要改，看detail傳進的變數為何
			$PHP_detail = urldecode(uniDecode($PHP_detail,'big-5'));//轉碼
			$PHP_item = urldecode(uniDecode($PHP_item,'big-5'));//轉碼
			if($PHP_new_ti == 1)
			{
				if(strstr($PHP_detail,'&#')) $PHP_detail = $ch_cov->check_cov($PHP_detail);				
				if(strstr($PHP_item,'&#')) $PHP_item = $ch_cov->check_cov($PHP_item);	
				$parm = array(	"wi_id"			=>	$PHP_wi_id,
												"item"			=>	$PHP_item,
												"detail"		=>	$PHP_detail,
												'today'			=>	date('Y-m-d'),
												'times'			=>	date('H:i:s'),
												'ti_new'		=> '1',
												'sub_item'	=>	$PHP_sub_name
										 );

				$f1 = $smpl_ti->add($parm);
			}
			else
			{
				if(strstr($PHP_detail,'&#')) $PHP_detail = $ch_cov->check_cov($PHP_detail);
									
				$parm['field_name'] = 'detail';
				$parm['field_value'] = $PHP_detail;
				$parm['id'] = $PHP_id;
				$f1 = $smpl_ti->update_field($parm);
			}
			
		}
		else
		{
			echo "else";
			//break;
			for($i=0; $i<sizeof($PHP_detail); $i++)
			{		
				if($PHP_new_ti[$i] == 1)
				{
					echo "Add";
					//break;
					$status="Add";
					foreach($PHP_detail[$i] as $key => $value)
					{
						if(strstr($value,'&#')) $value = $ch_cov->check_cov($value);				
						if(strstr($PHP_sub_name[$i],'&#')) $PHP_sub_name[$i] = $ch_cov->check_cov($PHP_sub_name[$i]);	
						$parm = array(	"wi_id"			=>	$PHP_wi_id,
														"item"			=>	(($PHP_new_arr=="fromjs")? urldecode(uniDecode($PHP_item[$i][$key],'big-5')):$PHP_item[$i][$key]),
														"detail"		=>	(($PHP_new_arr=="fromjs")? urldecode(uniDecode($value,'big-5')):$value),
														'today'			=>	date('Y-m-d'),
														'times'			=>	date('H:i:s'),
														'ti_new'		=> '1',
														'sub_item'	=>	$PHP_sub_name[$i]
												 );

						$f1 = $smpl_ti->add($parm);
					}
					
				}else{
					echo "edit";
					//break;
					$status="Edit";
					foreach($PHP_detail[$i] as $key => $value)
					{
						if(strstr($value,'&#')) $value = $ch_cov->check_cov($value);
								
						$parm['field_name'] = 'detail';
						$parm['field_value'] = (($PHP_new_arr=="fromjs")? urldecode(uniDecode($value,'big-5')):$value);//$value;
						$parm['id'] = (($PHP_new_arr=="fromjs")? $PHP_id[$i][$key]:$key);
						//print_r($parm);
						$f1 = $smpl_ti->update_field($parm);
					}

				}
			}
		}		
		//break;
// 將 製造令 完整show out ------
		
		if($PHP_new_add == 1)
		{
			$message = "Edit WI:[".$PHP_num."] Description 。";
			$return_message =  $PHP_sub_name." Group\r\n[".mb_convert_encoding($PHP_item, "UTF-8", "UTF-8,big5")."]".mb_convert_encoding("項目。", "UTF-8", "UTF-8,big5")."\r\n".mb_convert_encoding("更新成功!!" , "UTF-8", "UTF-8,big5");
			$log->log_add(0,"10E",$message);
			//$redir_str=$PHP_SELF.'?PHP_action=smpl_wi_view&PHP_id='.$PHP_wi_id.$PHP_back_str2.'&PHP_ti=1&PHP_msg='.$message;
			echo $return_message;
		}
		else
		{
			$message = $status." WI:[".$PHP_num."] Description 。";
			$log->log_add(0,($status=="Add")?"10A":"10E",$message);
			$redir_str=$PHP_SELF.'?PHP_action=smpl_wi_view&PHP_id='.$PHP_wi_id.$PHP_back_str2.'&PHP_ti=1&PHP_msg='.$message;
			//echo $redir_str;
			redirect_page($redir_str);
		}
		
		
		break;
		
		
//=======================================================
    case "do_smpl_ti_comm_add":
		check_authority("010","add");
		
		
		if($PHP_new_flag == 1)
		{
				if(strstr($PHP_comm,'&#')) $PHP_comm = $ch_cov->check_cov($PHP_comm);		
				$parm = array(	"wi_id"		=>	$PHP_wi_id,
												"item"		=>	'Comment',
												"detail"	=>	$PHP_comm,
												'today'		=>	date('Y-m-d'),
												'times'		=>	date('H:i:s'),
												'ti_new'	=> '1'
										 );
				$f1 = $smpl_ti->add($parm);
		}else{
				if(strstr($PHP_comm,'&#')) $PHP_comm = $ch_cov->check_cov($PHP_comm);
		
				$parm['field_name'] = 'detail';
				$parm['field_value'] = $PHP_comm;
				$parm['id'] = $PHP_id;
				$f1 = $smpl_ti->update_field($parm);
		}

// 將 製造令 完整show out ------
		$message = "Add WS :[".$PHP_wi_num."] COMMENT Description 。";
		$log->log_add(0,"23D",$message);



		
		$redir_str=$PHP_SELF.'?PHP_action=smpl_wi_view&PHP_id='.$PHP_wi_id.$PHP_back_str2.'&PHP_ti=1&PHP_msg='.$message;
		redirect_page($redir_str);
		break;

//=======================================================
    case "do_smpl_ti_edit":
		check_authority("010","add");


		if(strstr($PHP_detail,'&#'))
		{
			$PHP_detail = $ch_cov->check_cov($PHP_detail);
		}	
		
		$parm['field_name'] = 'detail';
		$parm['field_value'] = $PHP_detail;
		$parm['id'] = $PHP_id;

		$f1 = $smpl_ti->update_field($parm);
		
//-------------------完成修改-------------

		$message = "Edit WI:[".$PHP_wi_num."] Description。";
		$log->log_add(0,"23E",$message);

		$redir_str=$PHP_SELF.'?PHP_action=smpl_ti_add&PHP_id='.$PHP_wi_id.$PHP_back_str2.'&PHP_msg='.$message;
		redirect_page($redir_str);
		break;		
		
//=======================================================
    case "do_smpl_ti_del":
		
		check_authority("010","edit");
		$parm = array(	"id"		=>	$id,		
										"wi_id" =>	$wi_id,
										"item"	=>	$item
		);

		$f1 = $smpl_ti->del($parm['id']);
		if (!$f1) {
			$op['msg'] = $ti->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

//---------完成刪除--------

		$op = $smpl_wi->get_all($parm['wi_id']);
		$back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		$message = "Delete WI:[".$op['wi']['wi_num']."] Description[".$parm['item']."]。";
		$log->log_add(0,"23D",$message);

		$redir_str=$PHP_SELF.'?PHP_action=smpl_ti_add&PHP_id='.$wi_id.$back_str2.'&PHP_msg='.$message;
		redirect_page($redir_str);
		break;

//=======================================================
   case "do_smpl_ws_file_del":
		
		check_authority("010","edit");	

		$f1 = $fils->del_file($PHP_talbe,$PHP_id);
		if (!$f1) {
			$op['msg'] = $fils->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		if(file_exists($GLOBALS['config']['root_dir']."/smpl_wi_file/".$PHP_file_name)){
			unlink("./smpl_wi_file/".$PHP_file_name);
		}

		$op = $smpl_wi->get_all($PHP_wi_id);
		$message = "Delete WI:[".$op['wi']['wi_num']."] 。";
		$log->log_add(0,"23D",$message);
		$back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;

		$redir_str='index2.php?PHP_action=smpl_wi_view&PHP_id='.$PHP_wi_id.$back_str2.'&PHP_ti=1&PHP_msg='.$message;
		redirect_page($redir_str);
		break;
		
//=======================================================		
    case "do_smpl_ti_other_add":
		check_authority("010","add");

		$sub_ti = array();
		for($i=0; $i<sizeof($PHP_detail); $i++)
		{
			 $sub_ti[$i]['name'] = $PHP_sub_name[$i];
			 $sub_ti[$i]['db_exist'] = "yes";
			 $sub_ti[$i]['i'] = $i;
			 $sub_ti[$i]['new_ti'] = $PHP_new_ti[$i];
			 $j=0;
			foreach($PHP_detail[$i] as $key => $value)
			{
				$sub_ti[$i]['txt'][$j]['id'] = $key;
				$sub_ti[$i]['txt'][$j]['item'] = $PHP_item[$i][$key];
				$sub_ti[$i]['txt'][$j]['detail'] = $value;
				$j++;
			}
		}


		$group_exist=0;
	 if($PHP_other_name)
	 {
		foreach($sub_ti as $sub_key => $sub_value)
		{
			if($sub_value['name'] == $PHP_other_name)
			{
				$group_exist=1;
			}
		}
		if($group_exist)
		{
			$message = "Duplicate name [".$PHP_other_name."] 。";
		}else{
			
		
			$sub_ti[$i]['name'] = $PHP_other_name;

			$sub_ti[$i]['db_exist'] = "no";
			$sub_ti[$i]['i'] = $i;
			$sub_ti[$i]['new_ti'] = 1;
			for($j = 0; $j<sizeof($ti_style[$PHP_style]); $j++)
			{
					$sub_ti[$i]['txt'][$j]['id'] = $j;
					$sub_ti[$i]['txt'][$j]['item'] = $ti_style[$PHP_style][$j];
					$sub_ti[$i]['txt'][$j]['detail'] = '';
			}				
			$message = "Add WI :[".$PHP_wi_num."] NEW GROUP [".$PHP_other_name."] 。";
		}
		foreach($sub_ti as $sub_key => $sub_value)
		{
			if($sub_value['new_ti'] == 1)
			{
				foreach($sub_value['txt'] as $sub_key4txt => $sub_value4txt)
				{
					$parm = array(	"wi_id"			=>	$PHP_wi_id,
									"item"			=>	$sub_value4txt['item'],
									"detail"		=>	$sub_value4txt['detail'],
									'today'			=>	date('Y-m-d'),
									'times'			=>	date('H:i:s'),
									'ti_new'		=> '1',
									'sub_item'	=>	$sub_value['name']
					);
					$f1 = $smpl_ti->add($parm);
					$sub_ti[$sub_key]['txt'][$sub_key4txt]['id'] = $f1;
				}
				$sub_ti[$sub_key]['new_ti'] = 0;
				$sub_ti[$sub_key]['db_exist'] = "yes";
			}
		}
	 }
	 else
	 {
		$message = "Please input new gorup name";
	 }
	

// 將 製造令 完整show out ------		
		
		$redir_str=$PHP_SELF.'?PHP_action=smpl_ti_add&PHP_id='.$PHP_wi_id.$PHP_back_str2.'&PHP_ti=1&PHP_msg='.$message;
		redirect_page($redir_str);
		break;



//=======================================================
    case "do_smpl_ti_other_del":
		check_authority("010","add");

		$tmp_ti = array();
		for($i=0; $i<sizeof($sub_ti); $i++)
		{
			if($sub_ti[$i]['name'] != $sub_name)
			{
				$tmp_ti[$i] = $sub_ti[$i];
			}
		}
		$sub_ti = $tmp_ti;

	$smpl_ti->del_group($wi_id,$sub_name);
		
	

// 將 製造令 完整show out ------
		$message = "DELETE WI :[".$wi_num."] GROUP [".$sub_name."] 。";
		$log->log_add(0,"23D",$message);
		
		$back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		
		$redir_str=$PHP_SELF.'?PHP_action=smpl_ti_add&PHP_id='.$wi_id.$back_str2.'&PHP_ti=1&PHP_msg='.$message;
		redirect_page($redir_str);
		break;


		
//=======================================================
	case "do_smpl_ti_cfm":
		check_authority("011","view");

		$parm = array($PHP_id,'ti_cfm',$TODAY);
		$f1 = $smpl_wi->update_field($parm);
		$parm = array($PHP_id,'ti_cfm_user',$GLOBALS['SCACHE']['ADMIN']['login_id']);
		$f1 = $smpl_wi->update_field($parm);

		if (!$f1) {
			$op['msg']= $smpl_wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}		
		
		if ($PHP_revise == 0)
		{
				$parm=array($PHP_id,'ti_rev','1');
				$smpl_wi->update_field($parm);
		}
		$message="success CFM Sample Worksheet:[".$PHP_wi."]";
		$log->log_add(0,"23A",$message);

//傳送message給RD人員
	$rcd = $smpl_wi->get_all($PHP_id);
	if($rcd['wi']['status'] > 0 && $rcd['wi']['ti_cfm'] <> '0000-00-00' )
	{
	 if($PHP_fty == 'WX') $PHP_fty = 'HJ';
	 $messg  = ' 製造令(Working Instruction) : <a href=index2.php?PHP_action=smpl_wi_view&PHP_id='.$PHP_id.$PHP_back_str2.'>'.$PHP_wi.'</a>';
	 $messg  .= ' 製造說明 (WorkSheet) : <a href=index2.php?PHP_action=smpl_wi_view&PHP_ti=1&PHP_id='.$PHP_id.$PHP_back_str2.'>'.$PHP_wi.'</a>';
	 $notify->system_msg_send_with_mail('2-4-S',$PHP_fty,$PHP_wi,$messg);
	}
		
		$redir_str=$PHP_SELF.'?PHP_action=smpl_wi_view&PHP_id='.$PHP_id.$PHP_back_str2.'&PHP_ti=1&PHP_msg='.$message;
		redirect_page($redir_str);
		break;
		
//=======================================================
	case "revise_smpl_ti":
		check_authority("010","edit");

		$sub_ti = array();		
		$PHP_rev++;		//revies次數+1
		$parm = array($PHP_id,'ti_rev',$PHP_rev);		//revies次數+1存入資料庫
		$f1 = $smpl_wi->update_field($parm);
		

		if (!$f1) {
			$op['msg']= $smpl_wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}		

	
		$parm = array($PHP_id,'ti_cfm','0000-00-00');	//Worksheet變成未cfm
		$f1 = $smpl_wi->update_field($parm);
		$parm = array($PHP_id,'ti_cfm_user','');
		$f1 = $smpl_wi->update_field($parm);
		if (!$f1) {
			$op['msg']= $smpl_wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}		
		$back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		$message="success Revise Worksheet:[".$PHP_wi."]";
		$log->log_add(0,"23A",$message);
		$redir_str=$PHP_SELF.'?PHP_action=smpl_ti_add&PHP_id='.$PHP_id.$back_str2.'&PHP_msg='.$message;
		redirect_page($redir_str);
		break;





		
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 23A sample pattern upload
#		case "upload_smpl_pattern":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "upload_smpl_wi_file":
check_authority("010","add");

$S_ROOT = dirname(__FILE__);
$Flag = substr(($S_ROOT),2,1);

if(strstr($PHP_desp,'&#'))
{
	$PHP_desp = $ch_cov->check_cov($PHP_desp);
}	

$filename = $_FILES['PHP_pttn']['name'];		

$ext =  strtolower(preg_replace("/.*\.([^.]+)$/","\\1", $filename));
$f_check = 0; //判斷副檔名是否存在
for ($i=0; $i<sizeof( $GLOBALS['VALID_TYPES']); $i++)
{
	if ($GLOBALS['VALID_TYPES'][$i] == $ext)
	{
		$f_check = 1;
		break;
	}
}

if ($filename && $PHP_desp) {	
	if ($_FILES['PHP_pttn']['size'] < $max_file_size && $_FILES['PHP_pttn']['size'] > 0) {
		if ($f_check == 1)	{   // 上傳檔的副檔名為 mdl 時 -----

			$today = $GLOBALS['TODAY'];
			$user_name =  $GLOBALS['SCACHE']['ADMIN']['name'];
			$parm = array(
				"file_name"		=>  $PHP_num,				
				"num"			=>  $PHP_num,
				"file_des"		=>	$PHP_desp,
				"file_user"		=>	$user_name,
				"file_date"		=>	$today
			);

			// upload pattern file to server
			$A = $fils->get_name_id('smpl_file_det');
			$pttn_name = $PHP_num."_".$A.".".$ext;
			$parm['file_name'] = $pttn_name;

			$str_long=strlen($pttn_name);
			$upload = new Upload;
			$upload->setMaxSize($max_file_size);
			$fu1 = $upload->UploadFiles($S_ROOT.$Flag.'smpl_wi_file'.$Flag, 'other', 16, $pttn_name );
			$upload->setMaxSize($max_file_size);
			if (!$upload){
				$op['msg'][] = $upload;
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			
			if (!$A = $fils->upload_smpl_file($parm)){
				$op['msg'] = $fils->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			
			$message = "UPLOAD file of ".$PHP_num;
			$log->log_add(0,"010E",$message);

			//傳送message給RD人員
			$rcd = $smpl_wi->get_all($PHP_id);
			if($rcd['wi']['status'] > 0 && $rcd['wi']['ti_cfm'] <> '0000-00-00' ) {
				if($PHP_fty == 'WX') $PHP_fty = 'HJ';
				$messg  = ' 製造令 ( Working Instruction ) : <a href='.$config['root_url'].$_SERVER['PHP_SELF'].'?PHP_action=smpl_wi_view&PHP_id='.$PHP_id.$PHP_back_str2.'>'.$PHP_wi.'</a><br>';
				$messg  .= ' 製造說明 ( WorkSheet ) : <a href='.$config['root_url'].$_SERVER['PHP_SELF'].'?PHP_action=smpl_wi_view&PHP_ti=1&PHP_id='.$PHP_id.$PHP_back_str2.'>'.$PHP_wi.'</a><p>';
				$messg  .= ' 上傳檔案 ( <a href='.$config['root_url'].dirname($PHP_SELF).'/download.php?fname='.$pttn_name.'&fdir=smpl_wi_file>'.$PHP_desp.'</a> ) <p>';
				$notify->system_msg_send_with_mail('010-U',$PHP_fty,$PHP_desp.$PHP_wi,$messg,'',' ( '.$PHP_desp.' )');
			}
			
		} else {  // 上傳檔的副檔名  是  exe 時 -----

			$message = "upload file is incorrect format ! Please re-send.";
		}
		
	} else {  //上傳檔名重覆時
		$message = "upload file is too big!!";
	}
} else {
	$message="You don't pick any file or add any file description.";
}

$redir_str=$PHP_SELF.'?PHP_action=smpl_wi_view&PHP_id='.$PHP_id.$PHP_back_str2.'&PHP_ti=1&PHP_msg='.$message;
redirect_page($redir_str);
break;				


		
// ---------------------- end BOM data layout [副料] ----------------------------//-------------------------------------------------------------------------------------
//		SMPL BOM  生產用料  [4, 1 ]
//-------------------------------------------------------------------------------------
    case "smpl_bom":

		check_authority("012","view");

		$where_str = $manager = $dept_id = '';		 
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
		$team = $GLOBALS['SCACHE']['ADMIN']['team_id'];  // 判定進入身份的指標(team)
		$sales_dept_ary = get_sales_dept();// 取出 業務的部門 [不含K0] ------
		for ($i=0; $i<count($sales_dept_ary);$i++){
			if($user_dept == $sales_dept_ary[$i]){

				// 如果是業務部進入 則dept_code 指定該業務部---
				$dept_id = $sales_dept_ary[$i];  
			}
		}
		$op['dept_id'] = $dept_id;
		if (!$dept_id || $team<>'MD') {    // 當不是業務部人[也不含 K0 的人 ]進入時
			$op['manager_flag'] = 1;
			$manager_v = 1;
			//業務部門 select選單
			$op['dept_id'] = $arry2->select($sales_dept_ary,"","PHP_dept_code","select",""); 
 
		} else {
			$where_str = " WHERE dept = '".$dept_id."' ";	
					
		}

								
		// creat cust combo box	 取出 客戶代號
		$where_str=$where_str."order by cust_s_name";
		if(!$cust_def = $cust->get_fields('cust_init_name',$where_str)){;  
			$op['msg'][] = "sorry! there is no any customer record in your team, please add customer first!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		if(!$cust_def_vue = $cust->get_fields('cust_s_name',$where_str)){;  
			$op['msg'][] = "sorry! there is no any customer record in your team, please add customer first!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		for ($i=0; $i< sizeof($cust_def); $i++)
		{
			$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];
		}
		$op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue); 

		$op['msg']= $smpl_wi->msg->get(2);

//080725message增加		
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];

		page_display($op, "012", $TPL_SMPL_BOM_SEARCH);		    	    
		break;		

//=======================================================
	
	case "smpl_bom_search_wi":   //  先找出製造令.......

		check_authority("012","view");

			if (!$op = $smpl_wi->search(1,1)) {
				$op['msg']= $smpl_wi->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			// op 被清除了 需再判斷一次 

		//2006/05/02 update
		$op['dept_id'] = get_dept_id();
		
		// 如果是 manager 進入時...
		if (substr($op['dept_id'],0,7) == "<select"){
			$op['manager_flag'] = 1;
		}

		$op['msg']= $smpl_wi->msg->get(2);				
		$back_str="&PHP_dept_code=".$PHP_dept_code."&PHP_etdstr=".$PHP_etdstr."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str']=$back_str;

		page_display($op, "012", $TPL_SMPL_BOM);
		break;	
	
    case "smpl_bom_print":   //  .......

		if(!$admin->is_power("012","view")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		//-------------------- 將 製造令 資料 由資料庫取出 ------------------
		//  wi 主檔
		if(!$wi = $smpl_wi->get(0,$PHP_id)){    //取出該筆 製造令記錄
					$op['msg']= $smpl_wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
		//  smpl 樣本檔
		if(!$smpl = $smpl_ord->get($wi['smpl_id'])){
					$op['msg']= $order->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_SMPL_ERROR);     
					break;
		}
		//-------------------- wi_qty 數量檔 -------------------------------
			$where_str = " WHERE wi_id='".$wi['id']."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);
		$op['num_colors'] = $num_colors;
		// 取出 size_scale ----------------------------------------------
//		$where_str = " WHERE cust='".$wi['cust']."' AND size_scale='".$smpl['size']."' ";
		$size_A = $size_des->get($smpl['size']);
		$smpl['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = get_colorway_qty($T_wiqty,$sizing);

		$op['total'] = $reply['total'];   // 總件數
		$data = $reply['data'];

		$colorway_name = $reply['colorway'];
		$colorway_qty = $reply['colorway_qty'];

		//-----------------------------------------------------------------

		// 相片的URL決定 -----------------------------------------------------------------
			$style_dir	= "./smpl_pic/";  
			$no_img		= "./images/graydot.jpg";
			if(file_exists($style_dir.$wi['style_code'].".jpg")){
//				$wi['pic_url'] = $style_dir."s".$wi['smpl_id'].".jpg";
				$wi['pic_url'] = $style_dir.$wi['style_code'].".jpg";
			} else {
				$wi['pic_url'] = $no_img;
			}
		
		//  取出主料用料記錄 --------------------------------------------------------------
		 $op['lots_NONE']= '';
		$where_str = " WHERE smpl_code = '".$wi['style_code']."' ";
		$lots_used['lots_use'] = $smplord_lots->search(0,$where_str);  //取出該筆 樣本主料記錄

		if (!is_array($lots_used['lots_use'])) {
			$op['msg'] = $smplord_lots->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_lots_used = count($lots_used['lots_use']);
		if (!$num_lots_used){	$op['lots_NONE'] = "1";		
		}else{
			for ($i=0; $i<sizeof($lots_used['lots_use']); $i++)
			{
				$lots_det[$i][0]		= $lots_used['lots_use'][$i]['lots_code'];
				$lots_det[$i][1]		= $lots_used['lots_use'][$i]['lots_name'];
				$lots_det[$i][2]		= $lots_used['lots_use'][$i]['use_for'];
				
			}
		}





		//  取出副料用料記錄 --------------------------------------------------------------
		 $op['acc_NONE']= '';
		$where_str = " WHERE smpl_code = '".$wi['style_code']."' ";
		$acc_used['acc_use'] = $smplord_acc->search(0,$where_str);  //取出該筆 樣本主料記錄

		if (!is_array($acc_used['acc_use'])) {     
			$op['msg'] = $smplord_acc->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_acc_used = count($acc_used['acc_use']);
		if (!$num_acc_used){	$op['acc_NONE'] = "1";		
		}else{
			for ($i=0; $i<sizeof($acc_used['acc_use']); $i++)
			{
				$acc_det[$i][0]		= $acc_used['acc_use'][$i]['acc_code'];
				$acc_det[$i][1]		= $acc_used['acc_use'][$i]['acc_name'];
				$acc_det[$i][2]		= $acc_used['acc_use'][$i]['use_for'];
				
			}

		}




		//  取出  BOM  主料記錄 --------------------------------------------------------------
		 $op['bom_lots_NONE']= '';
		$where_str = " WHERE wi_id = '".$wi['id']."' ";
		$bom_lots = $smpl_bom->search_lots(0,$where_str);  //取出該筆 bom 內ALL主料記錄

		if (!is_array($bom_lots['lots'])) {
			$op['msg'] = $smpl_bom->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_bom_lots = count($bom_lots['lots']);
		if (!$num_bom_lots){	$op['bom_lots_NONE'] = "1";		}

		//  取出  BOM  副料記錄 --------------------------------------------------------------
		 $op['bom_acc_NONE']= '';
		$where_str = " WHERE wi_id = '".$wi['id']."' ";
		$bom_acc = $smpl_bom->search_acc(0,$where_str);  //取出該筆 bom 內ALL副料記錄

		if (!is_array($bom_acc['acc'])) {
			$op['msg'] = $smpl_bom->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_bom_acc = count($bom_acc['acc']);
		if (!$num_bom_acc){	$op['bom_acc_NONE'] = "1";		}

		// --------------- 主料 ------------ 做出 layout  array....
			$data_m = array();
		if (!$op['lots_NONE']){   // 樣本有主料用料記錄---

		  for ($i=0;$i<$num_lots_used;$i++){   // 依 主料用料記錄逐項 loop
				$no_found_flag = 1;  // 預設 bom內找不到資料的旗標
			for ($k=0;$k<count($bom_lots['lots']);$k++){  // 依 bom 主料記錄 逐筆 loop
				$T_bom = array();
				if ($bom_lots['lots'][$k]['lots_used_id'] == $lots_used['lots_use'][$i]['id'] ){
					$no_found_flag = "";  // 旗標改變
					
					$T_bom[0]	= $lots_used['lots_use'][$i]['lots_code'];
					$T_bom[1]	= $lots_used['lots_use'][$i]['use_for'];
					$T_bom[2]	= $lots_used['lots_use'][$i]['est_1'].' '.$lots_used['lots_use'][$i]['unit'];
					$T_bom[3]	= $bom_lots['lots'][$k]['color'];
					$T_bom[4]	= '';  // size 因此加入一個空值
					$T_bom[5]	= '';  // layout 為雙線 因此加入一個空值

						$T_qty = explode(",", $bom_lots['lots'][$k]['qty']);
					for ($p=0;$p<$num_colors;$p++){
						$tmp_tqty= number_format($T_qty[$p],0,'',',');
						if ($tmp_tqty==0){	$tmp_tqty = " ";	}
						$T_bom[7 + $p] = $tmp_AAty;					
					}
					$T_bom[$p+6]			= '';
					$T_bom[$p+7]			= number_format((array_sum($T_qty)),0,'',',')." ".$lots_used['lots_use'][$i]['unit'];
					$data_m[]	= $T_bom;
					$tmp='';
					if($lots_used['lots_use'][$i]['weight'])$tmp .="   Weight : ".$lots_used['lots_use'][$i]['weight'].";";
					if($lots_used['lots_use'][$i]['width'])$tmp .="  c.Width : ".$lots_used['lots_use'][$i]['width'].";";
					if($lots_used['lots_use'][$i]['des'])$tmp .="   Supplier's # : ".$lots_used['lots_use'][$i]['des'].";";
					if($lots_used['lots_use'][$i]['comp'])$tmp .="  Construction : ".$lots_used['lots_use'][$i]['comp'].";";
					$tmp = substr($tmp,0,-1);
					$des_m[] = $tmp;

				}   // BOM 檔內的 主料id 等於 用料檔的id 結束

			}  // end for K... bom檔內主料 逐筆 結束
			if ($no_found_flag){  // 當 bom檔內無這筆用料的id時

				$T_bom['lots_code']		= $lots_used['lots_use'][$i]['lots_code'];
				$T_bom['est_1']				= $lots_used['lots_use'][$i]['est_1'];
				$T_bom['unit']				= $lots_used['lots_use'][$i]['unit'];
				$T_bom['use_for']			= $lots_used['lots_use'][$i]['use_for'];

				$data_m[]		= $T_bom;
				$tmp='';
				if($lots_used['lots_use'][$i]['weight'])$tmp .="   Weight : ".$lots_used['lots_use'][$i]['weight'].";";
				if($lots_used['lots_use'][$i]['width'])$tmp .="  c.Width : ".$lots_used['lots_use'][$i]['width'].";";
				if($lots_used['lots_use'][$i]['des'])$tmp .="   Supplier's # : ".$lots_used['lots_use'][$i]['des'].";";
				if($lots_used['lots_use'][$i]['comp'])$tmp .="  Construction : ".$lots_used['lots_use'][$i]['comp'].";";
				$tmp = substr($tmp,0,-1);
				$des_m[] = $tmp;

			}
		  }  // end for 依 主料用料記錄逐項 loop

		}   // end---- if (!$op['lots_NONE']) 
		// ---------------------- end BOM data layout [主料] ----------------------------

		// --------------- 副料 ------------ 做出 $bom_acc_list[]  array....
			$data_a = array();
		if (!$op['acc_NONE']){   // 樣本有副料用料記錄---
			unset($T_bom);
			$T_bom = array();
		  for ($i=0;$i<$num_acc_used;$i++){   // 依 副料用料記錄逐項 loop
				$no_found_flag = 1;  // 預設 bom內找不到資料的旗標
			for ($k=0;$k<count($bom_acc['acc']);$k++){  // 依 bom 副料記錄 逐筆 loop
				$T_bom = array();
				if ($bom_acc['acc'][$k]['acc_used_id'] == $acc_used['acc_use'][$i]['id'] ){
					$no_found_flag = "";  // 旗標改變

					$T_bom[0]		= $acc_used['acc_use'][$i]['acc_code'];
					$T_bom[1]	= $acc_used['acc_use'][$i]['use_for'];
					$T_bom[2]		= $acc_used['acc_use'][$i]['est_1'].' '.$acc_used['acc_use'][$i]['unit'];
					$T_bom[3]		= $bom_acc['acc'][$k]['color'];
					$T_bom[4]	= '';		//size
					$T_bom[5]	= '';  // layout 為雙線 因此加入一個空值

						$T_qty = explode(",", $bom_acc['acc'][$k]['qty']);
					for ($p=0;$p<sizeof($T_qty);$p++){
						$tmp_tqty= number_format($T_qty[$p],0,'',',');
						if ($tmp_tqty==0){	$tmp_tqty = " ";	}
						$T_bom[7 + $p] = $tmp_tqty;					
					}
					$T_bom[$p+6]			= '';
					$T_bom[$p+7]			= number_format((array_sum($T_qty)),0,'',',')." ".$acc_used['acc_use'][$i]['unit'];
					$data_a[]	= $T_bom;
					$tmp='';
					if($acc_used['acc_use'][$i]['specify']) $tmp = "   Construction : ".$acc_used['acc_use'][$i]['specify'];
					$des_a[] = $tmp;

				}   // BOM 檔內的 副料id 等於 用料檔的id 結束

			}  // end for K... bom檔內副料 逐筆 結束

			if ($no_found_flag){  // 當 bom檔內無這筆用料的id時

				if (!$num_colors){	$num_span = 1;	}else{ $num_span = $num_colors; }

				$T_bom['acc_code']		= $acc_used['acc_use'][$i]['acc_code'];
				$T_bom['est_1']			= $acc_used['acc_use'][$i]['est_1'];
				$T_bom['unit']			= $acc_used['acc_use'][$i]['unit'];
				$T_bom['use_for']		= $acc_used['acc_use'][$i]['use_for'];

				$data_a[]			= $T_bom;
				$tmp='';
				if($acc_used['acc_use'][$i]['specify']) $tmp = "   Construction : ".$acc_used['acc_use'][$i]['specify'];
				$des_a[] = $tmp;

			}
		  }  // end for 依 主料用料記錄逐項 loop

		}   // end---- if (!$op['acc_NONE']) 
		// ---------------------- end BOM data layout [副料] ----------------------------
		// ---------------------- end BOM data layout table ----------------------------

//---------------------------------- 資料庫作業結束 ------------------------------

include_once($config['root_dir']."/lib/class.pdf_bom.php");

$print_title = "Bill Of Material";
$wi['bcfm_date']=substr($wi['bcfm_date'],0,10);
$print_title2 = "VER.".$wi['bom_rev']."  on  ".$wi['bcfm_date'];
$creator = $wi['bcfm_user'];
$pdf=new PDF_bom();
$pdf->AddBig5Font();
$pdf->Open();
$pdf->AddPage();

$pdf->SetFont('Arial','B',14);
// [表匡] 訂單基本資料
$parm=array( 'PHP_id'		=>	$PHP_id,
			 'prt_ord'		=>	'Sample Order #',
			 'cust'			=>	$smpl['cust_iname'],
			 'ref'			=>	$smpl['ref'],
			 'dept'			=>	$smpl['dept'],
			 'size_scale'	=>	$smpl['size_scale'],
			 'style'		=>	$smpl['style'],
			 'qty'			=>	$op['total'],
			 'unit'			=>	$wi['unit'],
			 'etd'			=>	$wi['etd'],
			 'pic_url'	=>	$wi['pic_url']
			 );
			
$pdf->hend_title($parm);
	
	


		$Y = $pdf->getY();
//		$pdf->setx(20);
		$img_size = GetImageSize($wi['pic_url']);
		
		if ($img_size[0] > $img_size[1])
		{
			$pdf->Image($wi['pic_url'],10,28,50,0);
		}else{
			$pdf->Image($wi['pic_url'],10,28,0,50);
		}
		$pdf->ln();
		$Y = $pdf->getY();
		$X = $pdf->getX();
// 設定 colorway的數量表 - 欄位的寬  [size breakdown]
// 由 80~200 保留 30為 colorway內容 其它 90分配給數量欄
	$num_siz = count($sizing);
	$w_qty = intval(155/ ($num_siz+1));
	$w = array('40');  // 第一格為 30寬
	for ($i=0;$i<=$num_siz;$i++){
		array_push($w, $w_qty);
	}

	$header = array_merge(array('Colorway') , $sizing);	
	$table_title = "Size Breakdown";
	$R = 100;
	$G = 85;
	$B = 85;
	if (count($sizing)){
		$pdf->Table_1(10,75,$header,$data,$w,$table_title,$R,$G,$B,$size_A['base_size']);
	}else{
		$pdf->Cell(10,75,'there is no sizing data exist !',1);
	}
		// 定訂 圖以下的座標 
		$pdf->SetXY($X,$Y+55);
	$X=$X+10;		
	// 主料
		$pdf->SetFont('Big5','',10);

	// 主料抬頭


if ($num_colors && $op['lots_NONE']<> 1){
	$header1 = array('Fabric #','Placement','Consump.','color/cat.','size','');
	$header2 = $colorway_name;
	for ($i=0;$i<count($colorway_qty);$i++){
		$header3[$i] = $colorway_qty[$i]." ".$wi['unit'];
	}


	$w1 =  array(18,55,18,24,5,0.5);
	$w2 = array();
	$w_color = intval(60/$num_colors);
	for ($i=0;$i<$num_colors;$i++){
		array_push($w2, $w_color);
	}
	$w3 = array(20);
	$title = 'Fabric usage';
	$data = $data_m;
	$ll=$pdf->Table_2(10,$Y+55,$header1,$header2,$header3,$data,$w1,$w2,$w3,$title,$R,$G,$B,0,$des_m);
	
	
} // if $num_colors....



		$Y = $pdf->getY();
		$X = $pdf->getX();
		$pdf->SetXY($X,$Y);


	// 副料 -------------------------
		$pdf->SetFont('Big5','',10);

	// 副料抬頭
if ($num_colors && $op['acc_NONE']<> 1){
	$header1 = array('Acc. #','Placement','Consump.','color/cat.','size','');
	$header2 = $colorway_name;
	for ($i=0;$i<count($colorway_qty);$i++){
		$header3[$i] = $colorway_qty[$i]." ".$wi['unit'];
	}

	$w1 =  array(18,55,18,24,5,0.5);
	$w2 = array();
	$w_color = intval(60/$num_colors);
	for ($i=0;$i<$num_colors;$i++){
		array_push($w2, $w_color);
	}
	$w3 = array(20);
	$title = 'Accessory usage';
	$data = $data_a;
	$X=$X+10;		
	$ll=$pdf->Table_2(10,$Y+10,$header1,$header2,$header3,$data,$w1,$w2,$w3,$title,$R,$G,$B,$ll,$des_a);



} // if $num_colors....


$name=$wi['wi_num'].'_bom.pdf';
$pdf->Output($name,'D');

break;	
	
//=======================================================
case "smpl_bom_add":

check_authority("012","add");
//-------------------- 將 BOM 製造令 show out ------------------
//  wi 主檔
if(!$op['wi'] = $smpl_wi->get($PHP_id)){    //取出該筆 製造令記錄
            $op['msg']= $smpl_wi->msg->get(2);
            $layout->assign($op);
            $layout->display($TPL_ERROR);  		    
            break;
}
//  smpl 樣本檔
if(!$op['smpl'] = $smpl_ord->get($op['wi']['smpl_id'])){
            $op['msg']= $order->msg->get(2);
            $layout->assign($op);
            $layout->display($TPL_ERROR);  		    
            break;
}

//-------------------- wi_qty 數量檔 -------------------------------
$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
$T_wiqty = $smpl_wiqty->search(1,$where_str);

$num_colors = count($T_wiqty);
$op['num_colors'] = $num_colors;
// 取出 size_scale ----------------------------------------------
$size_A = $size_des->get($op['smpl']['size']);

$op['smpl']['size_scale']=$size_A['size_scale'];
    //????????????????????????????????????? 注意 有時沒有 size type 資料時??????
$sizing = explode(",", $size_A['size']);

    // 做出 size table-------------------------------------------
$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
$op['show_breakdown'] = $reply['html'];
$op['total'] = $reply['total'];   // 總件數
//-----------------------------------------------------------------



// 相片的URL決定 ------------------------------------------------------
        $style_dir	= "./smpl_pic/";  
        $no_img		= "./images/graydot.gif";
    if(file_exists($style_dir.$op['wi']['style_code'].".jpg")){
        $op['wi']['pic_url'] = $style_dir.$op['wi']['style_code'].".jpg";
    } else {
        $op['wi']['pic_url'] = $no_img;
    }

//  取出主料用料記錄 --------------------------------------------------------------
 $op['lots_NONE']= '';
$where_str = " WHERE smpl_code = '".$op['wi']['style_code']."' ";
$lots_used['lots_use'] = $smplord_lots->search(0,$where_str);  //取出該筆 樣本主料記錄

if (!is_array($lots_used['lots_use'])) {
    $op['msg'] = $smplord_lots->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}
$num_lots_used = count($lots_used['lots_use']);
if (!$num_lots_used){	$op['lots_NONE'] = "1";		}

//  取出副料用料記錄 --------------------------------------------------------------
 $op['acc_NONE']= '';
$where_str = " WHERE smpl_code = '".$op['wi']['style_code']."' ";
$acc_used['acc_use'] = $smplord_acc->search(0,$where_str);  //取出該筆 樣本主料記錄

if (!is_array($acc_used['acc_use'])) {     
    $op['msg'] = $smplord_acc->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}
$num_acc_used = count($acc_used['acc_use']);
if (!$num_acc_used){	$op['acc_NONE'] = "1";		}

//  取出  BOM  主料記錄 --------------------------------------------------------------
 $op['bom_lots_NONE']= '';
$where_str = " WHERE wi_id = '".$op['wi']['id']."' ";
$bom_lots = $smpl_bom->search_lots(0,$where_str);  //取出該筆 bom 內ALL主料記錄
$op['bom_lots'] = $bom_lots['lots'];

if (!is_array($bom_lots['lots'])) {
    $op['msg'] = $smpl_bom->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}
$num_bom_lots = count($bom_lots['lots']);
if (!$num_bom_lots){	$op['bom_lots_NONE'] = "1";		}

//  取出  BOM  副料記錄 --------------------------------------------------------------
 $op['bom_acc_NONE']= '';
$where_str = " WHERE wi_id = '".$op['wi']['id']."' ";
$bom_acc = $smpl_bom->search_acc(0,$where_str);  //取出該筆 bom 內ALL副料記錄
$op['bom_acc'] = $bom_acc['acc'];

if (!is_array($bom_acc['acc'])) {
    $op['msg'] = $smpl_bom->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}
$num_bom_acc = count($bom_acc['acc']);
if (!$num_bom_acc){	$op['bom_acc_NONE'] = "1";		}

//-------------------- 整理部份資料 ---- for bom table TITLE------------------------------
if ($num_colors){
    for ($i=0;$i<$num_colors;$i++){
        $op['color'][$i]['name'] = $T_wiqty[$i]['colorway'];
        $T_qty = explode(",", $T_wiqty[$i]['qty']);
        $op['color'][$i]['qty'] = array_sum($T_qty);
        $color_qty[$i] = array_sum($T_qty);
        for ($j=0; $j<sizeof($T_qty); $j++)
        {
            $size_qty[$sizing[$j]][$i] = $T_qty[$j];
        }

    }
} else {
        $color_qty[] = 0;   // 避免 error
        $op['colors_NONE'] = "1";
}

// --------------- 主料 ------------ 做出 $bom_lots_list[]  array....
$op['bom_lots_list'] = array();
if (!$op['lots_NONE']){   // 樣本有主料用料記錄---
  $op['bom_lots_list'] =bom_lots_edit($num_lots_used,$bom_lots['lots'],$lots_used['lots_use'],$num_colors, $PHP_id, $color_qty);
} 
// ---------------------- end BOM data layout [主料] ----------------------------

// --------------- 副料 ------------ 做出 $bom_acc_list[]  array....
$op['bom_acc_list'] = array();
if (!$op['acc_NONE']){   // 樣本有副料用料記錄---
    $op['bom_acc_list'] =bom_acc_edit($num_acc_used,$bom_acc['acc'],$acc_used['acc_use'],$num_colors, $PHP_id, $color_qty,$sizing,$size_qty);	
} 
// ---------------------- end BOM data layout [副料] ----------------------------

// 表格 改進用 -----
    if (!$num_colors){	
        $op['total_fields'] = 9;   // BOM table的總欄位數
    }else{
        $op['total_fields'] = 8 + $num_colors;   // BOM table的總欄位數
    }
// ---------------------- end BOM data layout table ----------------------------


if (isset($PHP_dept_code))
{
$back_str="&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_etdstr=".$PHP_etdstr."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdfsh=".$PHP_etdfsh;
$op['back_str']=$back_str;
$back_str2="&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_etdstr=".$PHP_etdstr."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdfsh=".$PHP_etdfsh;
$op['back_str2']=$back_str2;
}else{
$op['back_str']=$PHP_back_str;
$op['back_str2']=$PHP_back_str2;
}

page_display($op, "012", $TPL_SMPL_BOM_ADD);  	    
break;	
	
	
//=======================================================
case "do_smpl_bom_add":

check_authority("012","add");
// 加入 bom 檔
$dt = decode_date(1);

if ($PHP_mat=="lots"){
    $parm = array(
        "wi_id"         =>	$PHP_wi_id,
        "color"         =>	$PHP_color,
        "lots_used_id"	=>	$PHP_mat_use_id,
        "qty"           =>	$PHP_qty,		
        "this_day"      =>	$dt['date']	
    );
    $f1 = $smpl_bom->add_lots($parm);   // 加入
    $K = "Fabric";
}elseif($PHP_mat=="acc"){
    $mat_use_id = explode('x',$PHP_mat_use_id);
    $parm = array(
        "wi_id"             =>	$PHP_wi_id,
        "color"             =>	$PHP_color,
        "acc_used_id"		=>	$mat_use_id[0],
        "qty"               =>	$PHP_qty,		
        "this_day"			=>	$dt['date'],
        "size"				=>	$PHP_size,
    );
    $f1 = $smpl_bom->add_acc($parm);   // 加入
    if ($PHP_size)
    {
        $acc_use = $smplord_acc->get($PHP_mat_use_id);
        if(!strstr($acc_use['use_for'],$PHP_size_des))
        {
            $placement = $acc_use['use_for']." (".$PHP_size_des.")";
            $acc_parm = array ( $mat_use_id[0],'use_for',$placement);
            $smplord_acc->update_field($acc_parm);
        }
    }
    $K = "Accessory";
}else{
    $op['msg'][] = "Error ! Not point materiel catagory of BOM !";
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}

if (!$f1) {  // 沒有成功輸入資料時
    $op['msg'] = $smpl_wi->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}

echo $f1;    
break;
/*
//-------------------- 將 BOM 製造令 show out ------------------
//  wi 主檔
if(!$op['wi'] = $smpl_wi->get($PHP_wi_id)){    //取出該筆 製造令記錄
            $op['msg']= $smpl_wi->msg->get(2);
            $layout->assign($op);
            $layout->display($TPL_ERROR);  		    
            break;
}
//  smpl 樣本檔
if(!$op['smpl'] = $smpl_ord->get($op['wi']['smpl_id'])){
            $op['msg']= $order->msg->get(2);
            $layout->assign($op);
            $layout->display($TPL_ERROR);  		    
            break;
}

$message = "Successfully add ".$K." record on BOM[ ".$op['wi']['wi_num']." ] ";

//------------- wi_qty 數量檔 ----------------------------------
$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
$T_wiqty = $smpl_wiqty->search(1,$where_str);

$num_colors = count($T_wiqty);
$op['num_colors'] = $num_colors;
// 取出 size_scale ----------------------------------------------
$size_A = $size_des->get($op['smpl']['size']);
$op['smpl']['size_scale']=$size_A['size_scale'];
    //????????????????????????????????????? 注意 有時沒有 size type 資料時??????
$sizing = explode(",", $size_A['size']);

    // 做出 size table-------------------------------------------
$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
$op['show_breakdown'] = $reply['html'];
$op['total'] = $reply['total'];   // 總件數
//-----------------------------------------------------------------

// 相片的URL決定 ------------------------------------------------------
$style_dir	= "./smpl_pic/";  
$no_img		= "./images/graydot.gif";
if(file_exists($style_dir.$op['wi']['style_code'].".jpg")){
    $op['wi']['pic_url'] = $style_dir.$op['wi']['style_code'].".jpg";
} else {
    $op['wi']['pic_url'] = $no_img;
}

//  取出主料用料記錄 --------------------------------------------------------------
$op['lots_NONE']= '';
$where_str = " WHERE smpl_code = '".$op['wi']['style_code']."' ";
$lots_used['lots_use'] = $smplord_lots->search(0,$where_str);  //取出該筆 樣本主料記錄

if (!is_array($lots_used['lots_use'])) {
    $op['msg'] = $smplord_lots->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}

$num_lots_used = count($lots_used['lots_use']);
if (!$num_lots_used){	$op['lots_NONE'] = "1";		}

//  取出副料用料記錄 --------------------------------------------------------------
$op['acc_NONE']= '';
$where_str = " WHERE smpl_code = '".$op['wi']['style_code']."' ";
$acc_used['acc_use'] = $smplord_acc->search(0,$where_str);  //取出該筆 樣本主料記錄

if (!is_array($acc_used['acc_use'])) {     
    $op['msg'] = $smplord_acc->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}

$num_acc_used = count($acc_used['acc_use']);
if (!$num_acc_used){ $op['acc_NONE'] = "1"; }

//  取出  BOM  主料記錄 --------------------------------------------------------------
$op['bom_lots_NONE']= '';
$where_str = " WHERE wi_id = '".$op['wi']['id']."' ";
$bom_lots = $smpl_bom->search_lots(0,$where_str);  //取出該筆 bom 內ALL主料記錄
$op['bom_lots'] = $bom_lots['lots'];

if (!is_array($bom_lots['lots'])) {
    $op['msg'] = $smpl_bom->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}

$num_bom_lots = count($bom_lots['lots']);
if (!$num_bom_lots){	$op['bom_lots_NONE'] = "1";		}

//  取出  BOM  副料記錄 --------------------------------------------------------------
$op['bom_acc_NONE']= '';
$where_str = " WHERE wi_id = '".$op['wi']['id']."' ";
$bom_acc = $smpl_bom->search_acc(0,$where_str);  //取出該筆 bom 內ALL副料記錄
$op['bom_acc'] = $bom_acc['acc'];

if (!is_array($bom_acc['acc'])) {
    $op['msg'] = $smpl_bom->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}

$num_bom_acc = count($bom_acc['acc']);
if (!$num_bom_acc){	$op['bom_acc_NONE'] = "1";		}

//-------------------- 整理部份資料 ---- for bom table TITLE------------------------------
if ($num_colors){
    for ($i=0;$i<$num_colors;$i++){
        $op['color'][$i]['name'] = $T_wiqty[$i]['colorway'];
        $T_qty = explode(",", $T_wiqty[$i]['qty']);
        $op['color'][$i]['qty'] = array_sum($T_qty);
        $color_qty[$i] = array_sum($T_qty);
        for ($j=0; $j<sizeof($T_qty); $j++)
        {
            $size_qty[$sizing[$j]][$i] = $T_qty[$j];
        }

    }
} else {
    $color_qty[] = 0;   // 避免 error
    $op['colors_NONE'] = "1";
}

// --------------- 主料 ------------ 做出 $bom_lots_list[]  array....
$op['bom_lots_list'] = array();
if (!$op['lots_NONE']){   // 樣本有主料用料記錄---
  $op['bom_lots_list'] =bom_lots_edit($num_lots_used,$bom_lots['lots'],$lots_used['lots_use'],$num_colors, $PHP_wi_id, $color_qty);
} 
// ---------------------- end BOM data layout [主料] ----------------------------

// --------------- 副料 ------------ 做出 $bom_acc_list[]  array....
$op['bom_acc_list'] = array();
if (!$op['acc_NONE']){   // 樣本有副料用料記錄---
    $op['bom_acc_list'] =bom_acc_edit($num_acc_used,$bom_acc['acc'],$acc_used['acc_use'],$num_colors, $PHP_wi_id, $color_qty,$sizing,$size_qty);	
} 
// ---------------------- end BOM data layout [副料] ----------------------------

// 表格 改進用 -----
if (!$num_colors){	
    $op['total_fields'] = 9;   // BOM table的總欄位數
}else{
    $op['total_fields'] = 8 + $num_colors;   // BOM table的總欄位數
}
// ---------------------- end BOM data layout table ----------------------------

        # 記錄使用者動態
$log->log_add(0,"25A",$message);
$op['msg'][] = $message;

$back_str="&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_etdstr=".$PHP_etdstr."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdfsh=".$PHP_etdfsh;
$op['back_str']=$back_str;
$back_str2="&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_etdstr=".$PHP_etdstr."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdfsh=".$PHP_etdfsh;
$op['back_str2']=$back_str2;
if (isset($PHP_rev))
{
    page_display($op, "012", $TPL_SMPL_BOM_CFM_EDIT);
}else{
    page_display($op, "012", $TPL_SMPL_BOM_ADD);	
}
    echo $f1;    
break;
*/


//=======================================================
    case "smpl_bom_consum":

		check_authority("012","view");
		
		if(!$op = $smpl_wi->get_all($PHP_id)){    //取出該筆 製造令記錄 ID
			$op['msg']= $smpl_wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

//--------------------------------------------------------------------------
		//  wi_qty 數量檔
		$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);

		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
		$op['show_breakdown'] = $reply['html'];
		$op['total'] = $reply['total'];
		//-----------------------------------------------------------------

		$op['msg'] = $wi->msg->get(2);

		// ---------------------- end BOM data layout table ----------------------------
		$back_str="&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_etdstr=".$PHP_etdstr."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str']=$back_str;
		$back_str2="&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_etdstr=".$PHP_etdstr."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str2']=$back_str2;
		

		page_display($op, "012", $TPL_SMPL_BOM_CON_ADD);		    	    
		break;	

//=======================================================
	case "do_smpl_bom_con_edit":

		check_authority("010","view");

		$tmp='';
		$x=0;
		$k=0;
		foreach($PHP_lots_est as $key=>$value)
		{
			$where_str="WHERE wi_id = '$PHP_wi_id' and lots_used_id = '".$key."' order by id" ;
			
			$bom_lots = $smpl_bom->get_fields_lots('qty',$where_str);
			$lots_id = $smpl_bom->get_fields_lots('id',$where_str);
			if (count($bom_lots))
			{
				for ($i=0; $i<sizeof($bom_lots); $i++)
				{
					$tmp_bom=explode(',',$bom_lots[$i]);
					for ($j=0; $j < sizeof($tmp_bom); $j++)
					{
						if ($tmp_bom[$j]=='' ||$tmp_bom[$j]==0)
						{
							$qty=0;
						}else{
							$qty=$bom_size[$j][0]*$value;
						}
						$tmp=$tmp.$qty.",";
					}
					$tmp=substr($tmp,0,-1);	
					$parm_bom[$k]=array($lots_id[$i],'qty',$tmp,'smpl_bom_lots');
					$tmp='';
					$k++;
				}
			}
			$parm_lots[$x]=array($key,'est_1',$value);			
			$x++;			
		}

		$x=0;
		$k=0;
		foreach($PHP_acc_est as $key=>$value)
		{
			$where_str="WHERE wi_id = '$PHP_wi_id' and acc_used_id = '".$key."' order by id" ;
			
			$bom_acc = $smpl_bom->get_fields_acc('qty',$where_str);
			$acc_size = $smpl_bom->get_fields_acc('size',$where_str);
			$acc_id = $smpl_bom->get_fields_acc('id',$where_str);
			if (count($bom_acc))
			{
				for ($i=0; $i<sizeof($bom_acc); $i++)
				{
					$tmp_bom=explode(',',$bom_acc[$i]);
					for ($j=0; $j < sizeof($tmp_bom); $j++)
					{
						if ($tmp_bom[$j]=='' ||$tmp_bom[$j]==0)
						{
							$qty=0;
						}else{
							if($acc_size[$i])
							{
								if(sizeof($tmp_bom) == 1)
								{
									$tmp_size_cout = sizeof($bom_size) - 1;
									$qty=$bom_size[$tmp_size_cout][$acc_size[$i]]*$value;
								}else{
									$qty=$bom_size[$j][$acc_size[$i]]*$value;
								}			
								
							}else{
								if(sizeof($tmp_bom) == 1)
								{
									$tmp_size_cout = sizeof($bom_size) - 1;
									$qty=$bom_size[$tmp_size_cout][0]*$value;
								}else{
									$qty=$bom_size[$j][0]*$value;
								}										}
						}
						$tmp=$tmp.$qty.",";
					}
					$tmp=substr($tmp,0,-1);	
					$parm_bom_acc[$k]=array($acc_id[$i],'qty',$tmp,'smpl_bom_acc');
					$tmp='';
					$k++;
				}
			}
			$parm_acc[$x]=array($key,'est_1',$value);			
			$x++;	
		}
		for ($i=0; $i<sizeof($parm_bom); $i++)		$smpl_bom->update_field($parm_bom[$i]);
		for ($i=0; $i<sizeof($parm_lots); $i++)		$smplord_lots->update_field($parm_lots[$i]);
		for ($i=0; $i<sizeof($parm_bom_acc); $i++)	$smpl_bom->update_field($parm_bom_acc[$i]);
		for ($i=0; $i<sizeof($parm_acc); $i++)		$smplord_acc->update_field($parm_acc[$i]);
		
		$parm=array($PHP_wi_id,'revise',($PHP_revise+1))	;
		$smpl_wi->update_field($parm);

		$redt_p="index2.php?&PHP_action=smpl_bom_view".$PHP_back_str2."&PHP_id=".$PHP_wi_id;
		redirect_page($redt_p);
		break;

		
//=======================================================
    case "smpl_bom_view":

		check_authority("012","view");
		//-------------------- 將 BOM 製造令 show out ------------------
		//  wi 主檔
		if(!$op['wi'] = $smpl_wi->get($PHP_id)){    //取出該筆 製造令記錄
					$op['msg']= $smpl_wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
		//  smpl 樣本檔
		if(!$op['smpl'] = $smpl_ord->get($op['wi']['smpl_id'])){
					$op['msg']= $smpl_ord->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
		
		//-------------------- wi_qty 數量檔 -------------------------------
		$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);
		$op['num_colors'] = $num_colors;
		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
		$op['show_breakdown'] = $reply['html'];
		$op['total'] = $reply['total'];   // 總件數
		//-----------------------------------------------------------------

		// 相片的URL決定 ------------------------------------------------------
				$style_dir	= "./smpl_pic/";  
				$no_img		= "./images/graydot.gif";
			if(file_exists($style_dir.$op['wi']['style_code'].".jpg")){
				$op['wi']['pic_url'] = $style_dir.$op['wi']['style_code'].".jpg";
			} else {
				$op['wi']['pic_url'] = $no_img;
			}
					
		//  取出主料用料記錄 --------------------------------------------------------------
		 $op['lots_NONE']= '';
		$where_str = " WHERE smpl_code = '".$op['wi']['style_code']."' ";
		$lots_used['lots_use'] = $smplord_lots->search(0,$where_str);  //取出該筆 樣本主料記錄

		if (!is_array($lots_used['lots_use'])) {
			$op['msg'] = $smplord_lots->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_lots_used = count($lots_used['lots_use']);
		if (!$num_lots_used){	$op['lots_NONE'] = "1";		}

		//  取出副料用料記錄 --------------------------------------------------------------
		 $op['acc_NONE']= '';
		$where_str = " WHERE smpl_code = '".$op['wi']['style_code']."' ";
		$acc_used['acc_use'] = $smplord_acc->search(0,$where_str);  //取出該筆 樣本主料記錄

		if (!is_array($acc_used['acc_use'])) {     
			$op['msg'] = $smplord_acc->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_acc_used = count($acc_used['acc_use']);
		if (!$num_acc_used){	$op['acc_NONE'] = "1";		}

		//  取出  BOM  主料記錄 --------------------------------------------------------------
		 $op['bom_lots_NONE']= '';
		$where_str = " WHERE wi_id = '".$op['wi']['id']."' ";
		$bom_lots = $smpl_bom->search_lots(0,$where_str);  //取出該筆 bom 內ALL主料記錄

		if (!is_array($bom_lots['lots'])) {
			$op['msg'] = $smpl_bom->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_bom_lots = count($bom_lots['lots']);
		if (!$num_bom_lots){	$op['bom_lots_NONE'] = "1";		}

		//  取出  BOM  副料記錄 --------------------------------------------------------------
		 $op['bom_acc_NONE']= '';
		$where_str = " WHERE wi_id = '".$op['wi']['id']."' ";
		$bom_acc = $smpl_bom->search_acc(0,$where_str);  //取出該筆 bom 內ALL副料記錄

		if (!is_array($bom_acc['acc'])) {
			$op['msg'] = $smpl_bom->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_bom_acc = count($bom_acc['acc']);
		if (!$num_bom_acc){	$op['bom_acc_NONE'] = "1";		}

		//-------------------- 整理 供 title 部份的資料 ----------------------------------
		if ($num_colors){
			for ($i=0;$i<$num_colors;$i++){
				$op['color'][$i]['name'] = $T_wiqty[$i]['colorway'];
				$T_qty = explode(",", $T_wiqty[$i]['qty']);
				$op['color'][$i]['qty'] = array_sum($T_qty);
			}
		}else{
			$op['colors_NONE'] = "1";
		}

		// --------------- 主料 ------------ 做出 $bom_lots_list[]  array....
			$op['bom_lots_list'] = array();
		if (!$op['lots_NONE']){   // 樣本有主料用料記錄---
			$op['bom_lots_list'] =  bom_lots_view($num_lots_used,$bom_lots['lots'],$lots_used['lots_use'],$num_colors);
		}   
		// ---------------------- end BOM data layout [主料] ----------------------------

		// --------------- 副料 ------------ 做出 $bom_acc_list[]  array....
			$op['bom_acc_list'] = array();
		if (!$op['acc_NONE']){   // 樣本有副料用料記錄---
			$op['bom_acc_list'] =  bom_acc_view($num_acc_used,$bom_acc['acc'],$acc_used['acc_use'],$num_colors);
		}  
		// ---------------------- end BOM data layout [副料] ----------------------------

		// 表格 改進用 -----
			if (!$num_colors){	
				$op['total_fields'] = 10;   // BOM table的總欄位數
			}else{
				$op['total_fields'] = 9 + $num_colors;   // BOM table的總欄位數
			}
		// ---------------------- end BOM data layout table ----------------------------
		$back_str="&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_etdstr=".$PHP_etdstr."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str']=$back_str;
		$back_str2="&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_etdstr=".$PHP_etdstr."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str2']=$back_str2;
		
		if (isset($PHP_ex_order))
		{
			$op['edit_non']=1;
		}
		
		if (isset($PHP_cfm_view))
		{
			$op['pp']=$PHP_sr;
			page_display($op, "012", $TPL_SMPL_BOM_CFM_VIEW);	
			
		}else{
			page_display($op, "012", $TPL_SMPL_BOM_VIEW);		    	    
		}
		break;		

//=======================================================
    case "do_smpl_bom_del_ajx":

		check_authority("012","edit");
		// 刪除 bom 檔
		
		if ($PHP_mat=="lots"){
			$T = "Fabric";
			$f1 = $smpl_bom->del_lots($PHP_bom_id);   
		}elseif($PHP_mat=="acc"){
			$T = "Accessory";
			$f1 = $smpl_bom->del_acc($PHP_bom_id);   // 加入
		}else{
			$message = "Error ! Don't point delete information of BOM !";
		}

		if (!$f1) {  // 沒有成功刪除資料時
			$message = $smpl_wi->msg->get(2);
		}
			
		//-------------------- 將 BOM 製造令 show out ------------------
		//  wi 主檔
		if(!$op['wi'] = $smpl_wi->get($PHP_id)){    //取出該筆 製造令記錄
					$op['msg']= $smpl_wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}

		$message = "Delete ".$T." Record on BOM : [ ".$op['wi']['wi_num' ]."] ";
		
		# 記錄使用者動態
		$log->log_add(0,"25D",$message);
		
		echo $message;		

		exit;
		break;
		
//=======================================================
    case "smpl_bom_revise_view":

		check_authority("012","view");
		//-------------------- 將 製造令 show out ------------------
		//  wi 主檔
		if(!$op['wi'] = $smpl_wi->get($PHP_id)){    //取出該筆 製造令記錄
					$op['msg']= $smpl_wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
		//  smpl 樣本檔
		if(!$op['smpl'] = $smpl_ord->get($op['wi']['smpl_id'])){
					$op['msg']= $order->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
		//-------------------- wi_qty 數量檔 -------------------------------
			$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);
		$op['num_colors'] = $num_colors;
		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
		$op['show_breakdown'] = $reply['html'];
		$op['total'] = $reply['total'];   // 總件數
		//-----------------------------------------------------------------

		// 相片的URL決定 ------------------------------------------------------
				$style_dir	= "./smpl_pic/";  
				$no_img		= "./images/graydot.gif";
			if(file_exists($style_dir.$op['wi']['style_code'].".jpg")){
				$op['wi']['pic_url'] = $style_dir.$op['wi']['style_code'].".jpg";
			} else {
				$op['wi']['pic_url'] = $no_img;
			}
					
		//  取出主料用料記錄 --------------------------------------------------------------
		 $op['lots_NONE']= '';
		$where_str = " WHERE smpl_code = '".$op['wi']['style_code']."' ";
		$lots_used['lots_use'] = $smplord_lots->search(0,$where_str);  //取出該筆 樣本主料記錄

		if (!is_array($lots_used['lots_use'])) {
			$op['msg'] = $smplord_lots->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_lots_used = count($lots_used['lots_use']);
		if (!$num_lots_used){	$op['lots_NONE'] = "1";		}

		//  取出副料用料記錄 --------------------------------------------------------------
		 $op['acc_NONE']= '';
		$where_str = " WHERE smpl_code = '".$op['wi']['style_code']."' ";
		$acc_used['acc_use'] = $smplord_acc->search(0,$where_str);  //取出該筆 樣本主料記錄

		if (!is_array($acc_used['acc_use'])) {     
			$op['msg'] = $smplord_acc->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_acc_used = count($acc_used['acc_use']);
		if (!$num_acc_used){	$op['acc_NONE'] = "1";		}

		//  取出  BOM  主料記錄 --------------------------------------------------------------
		 $op['bom_lots_NONE']= '';
		$where_str = " WHERE wi_id = '".$op['wi']['id']."' ";
		$bom_lots = $smpl_bom->search_lots(0,$where_str);  //取出該筆 bom 內ALL主料記錄
//		$op['bom_lots'] = $bom_lots['lots'];

		if (!is_array($bom_lots['lots'])) {
			$op['msg'] = $smpl_bom->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_bom_lots = count($bom_lots['lots']);
		if (!$num_bom_lots){	$op['bom_lots_NONE'] = "1";		}

		//  取出  BOM  副料記錄 --------------------------------------------------------------
		 $op['bom_acc_NONE']= '';
		$where_str = " WHERE wi_id = '".$op['wi']['id']."' ";
		$bom_acc = $smpl_bom->search_acc(0,$where_str);  //取出該筆 bom 內ALL副料記錄
//		$op['bom_acc'] = $bom_acc['acc'];

		if (!is_array($bom_acc['acc'])) {
			$op['msg'] = $smpl_bom->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_bom_acc = count($bom_acc['acc']);
		if (!$num_bom_acc){	$op['bom_acc_NONE'] = "1";		}

		//-------------------- 整理 供 title 部份的資料 ----------------------------------
		if ($num_colors){
			for ($i=0;$i<$num_colors;$i++){
				$op['color'][$i]['name'] = $T_wiqty[$i]['colorway'];
				$T_qty = explode(",", $T_wiqty[$i]['qty']);
				$op['color'][$i]['qty'] = array_sum($T_qty);
			}
		}else{
			$op['colors_NONE'] = "1";
		}

		// --------------- 主料 ------------ 做出 $bom_lots_list[]  array....
			$op['bom_lots_list'] = array();
		if (!$op['lots_NONE']){   // 樣本有主料用料記錄---
			$op['bom_lots_list'] =  bom_lots_view($num_lots_used,$bom_lots['lots'],$lots_used['lots_use'],$num_colors);
		}   
		// ---------------------- end BOM data layout [主料] ----------------------------

		// --------------- 副料 ------------ 做出 $bom_acc_list[]  array....
			$op['bom_acc_list'] = array();
		if (!$op['acc_NONE']){   // 樣本有副料用料記錄---
			$op['bom_acc_list'] =  bom_acc_view($num_acc_used,$bom_acc['acc'],$acc_used['acc_use'],$num_colors);
		}  
		// ---------------------- end BOM data layout [副料] ----------------------------

		// 表格 改進用 -----
			if (!$num_colors){	
				$op['total_fields'] = 10;   // BOM table的總欄位數
			}else{
				$op['total_fields'] = 9 + $num_colors;   // BOM table的總欄位數
			}
		// ---------------------- end BOM data layout table ----------------------------
			$message = "Successfully revise sample wi : ".$op['wi']['wi_num'];
			$log->log_add(0,"25E",$message);
			$op['msg'][] = $message;

			page_display($op, "012", $TPL_SMPL_BOM_REVISE_SHOW);		    	    
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//   bom_cfm      //  WI CFM...........
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "smpl_bom_uncfm":
		check_authority("013","view");
		
		if (!$op = $smpl_wi->search_uncfm('bom')) {
			$op['msg']= $smpl_wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$back_str="&PHP_dept_code=&PHP_etdstr=&PHP_cust=&PHP_wi_num=&PHP_etdfsh=";

		//2006/05/02 update
		$op['dept_id'] = get_dept_id();
		
		// 如果是 manager 進入時...
		if (substr($op['dept_id'],0,7) == "<select"){
			$op['manager_flag'] = 1;
		}	
				$op['msg']= $smpl_wi->msg->get(2);
				$op['back_str']= $back_str;

//080725message增加		
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];

			page_display($op, "013", $TPL_SMPL_BOM_UNCFM_LIST);
		break;
		
//=======================================================
	case "do_smpl_bom_cfm":
		check_authority("013","edit");
		
		$parm = array(	"order_num" =>	$PHP_order_num,
										"id"				=>	$PHP_id,
										"date"			=>	$dt['date_str'],
										"user"			=>	$GLOBALS['SCACHE']['ADMIN']['login_id']
					  );
		$f1 = $smpl_wi->bom_cfm($parm);
		if (!$f1) {
			$op['msg']= $smpl_wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$message="success CFM BOM:[".$PHP_wi."]";
			
		if (!$op = $smpl_wi->search_uncfm('bom')) {
			$op['msg']= $smpl_wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		if ($PHP_revise == 0)
		{
				$parm=array($PHP_id,'bom_rev','1');
				$smpl_wi->update_field($parm);
		}
		$back_str="&PHP_dept_code=&PHP_etdstr=&PHP_cust=&PHP_wi_num=&PHP_etdfsh=";

		//2006/05/02 update
		$op['dept_id'] = get_dept_id();
		
		// 如果是 manager 進入時...
		if (substr($op['dept_id'],0,7) == "<select"){
			$op['manager_flag'] = 1;
		}
		
				$op['msg'][]= $message;
				$log->log_add(0,"26A",$message);
				$op['back_str']= $back_str;
			page_display($op, "013", $TPL_SMPL_BOM_UNCFM_LIST);
		break;


//=======================================================
    case "revise_smpl_bom":

		check_authority("012","edit");
		//-------------------- 將 BOM 製造令 show out ------------------
		//  wi 主檔	
		if(!$op['wi'] = $smpl_wi->get($PHP_id)){    //取出該筆 製造令記錄
					$op['msg']= $smpl_wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
		$op['wi']['bom_rev']=$op['wi']['bom_rev']+1;
		
		$parm = array(	"order_num" =>	$op['wi']['style_code'],
						"id"		=>	$PHP_id,
						"date"		=>	'0000-00-00 00:00:00',
						"user"		=>	'',
						"bom_rev"	=>	$op['wi']['bom_rev']
					  );

		
		$f1=$smpl_wi->revise_bom($parm);
		if (!$f1)
		{
			$op['msg']= $smpl_wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		
		
		
		
		//  smpl 樣本檔
		if(!$op['smpl'] = $smpl_ord->get($op['wi']['smpl_id'])){
					$op['msg']= $order->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}

		//------------- wi_qty 數量檔 ----------------------------------
			$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);
		$op['num_colors'] = $num_colors;
		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
		$op['show_breakdown'] = $reply['html'];
		$op['total'] = $reply['total'];   // 總件數
		//-----------------------------------------------------------------

		// 相片的URL決定 ------------------------------------------------------
				$style_dir	= "./smpl_pic/";  
				$no_img		= "./images/graydot.gif";
			if(file_exists($style_dir.$op['wi']['style_code'].".jpg")){
				$op['wi']['pic_url'] = $style_dir.$op['wi']['style_code'].".jpg";
			} else {
				$op['wi']['pic_url'] = $no_img;
			}

		//  取出主料用料記錄 --------------------------------------------------------------
		 $op['lots_NONE']= '';
		$where_str = " WHERE smpl_code = '".$op['wi']['style_code']."' ";
		$lots_used['lots_use'] = $smplord_lots->search(0,$where_str);  //取出該筆 樣本主料記錄
//		$op['lots_used'] = $lots_used['lots_use'];

		if (!is_array($lots_used['lots_use'])) {
			$op['msg'] = $smplord_lots->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_lots_used = count($lots_used['lots_use']);
		if (!$num_lots_used){	$op['lots_NONE'] = "1";		}

		//  取出副料用料記錄 --------------------------------------------------------------
		 $op['acc_NONE']= '';
		$where_str = " WHERE smpl_code = '".$op['wi']['style_code']."' ";
		$acc_used['acc_use'] = $smplord_acc->search(0,$where_str);  //取出該筆 樣本主料記錄
//		$op['acc_used'] = $acc_used['acc_use'];

		if (!is_array($acc_used['acc_use'])) {     
			$op['msg'] = $smplord_acc->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_acc_used = count($acc_used['acc_use']);
		if (!$num_acc_used){	$op['acc_NONE'] = "1";		}

		//  取出  BOM  主料記錄 --------------------------------------------------------------
		 $op['bom_lots_NONE']= '';
		$where_str = " WHERE wi_id = '".$op['wi']['id']."' ";
		$bom_lots = $smpl_bom->search_lots(0,$where_str);  //取出該筆 bom 內ALL主料記錄
		$op['bom_lots'] = $bom_lots['lots'];

		if (!is_array($bom_lots['lots'])) {
			$op['msg'] = $smpl_bom->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_bom_lots = count($bom_lots['lots']);
		if (!$num_bom_lots){	$op['bom_lots_NONE'] = "1";		}
		
		//  取出  BOM  副料記錄 --------------------------------------------------------------
		 $op['bom_acc_NONE']= '';
		$where_str = " WHERE wi_id = '".$op['wi']['id']."' ";
		$bom_acc = $smpl_bom->search_acc(0,$where_str);  //取出該筆 bom 內ALL副料記錄
		$op['bom_acc'] = $bom_acc['acc'];

		if (!is_array($bom_acc['acc'])) {
			$op['msg'] = $smpl_bom->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_bom_acc = count($bom_acc['acc']);
		if (!$num_bom_acc){	$op['bom_acc_NONE'] = "1";		}

		//-------------------- 整理部份資料 ---- for bom table TITLE------------------------------
		if ($num_colors){
			for ($i=0;$i<$num_colors;$i++){
				$op['color'][$i]['name'] = $T_wiqty[$i]['colorway'];
				$T_qty = explode(",", $T_wiqty[$i]['qty']);
				$op['color'][$i]['qty'] = array_sum($T_qty);
				$color_qty[$i] = array_sum($T_qty);
				for ($j=0; $j<sizeof($T_qty); $j++)
				{
					$size_qty[$sizing[$j]][$i] = $T_qty[$j];
				}

			}
		} else {
				$color_qty[] = 0;   // 避免 error
				$op['colors_NONE'] = "1";
		}

	// --------------- 主料 ------------ 做出 $bom_lots_list[]  array....
		$op['bom_lots_list'] = array();
	    if (!$op['lots_NONE']){   // 樣本有主料用料記錄---
	      $op['bom_lots_list'] =bom_lots_edit($num_lots_used,$bom_lots['lots'],$lots_used['lots_use'],$num_colors, $PHP_id, $color_qty);
	    } 
	// ---------------------- end BOM data layout [主料] ----------------------------

	// --------------- 副料 ------------ 做出 $bom_acc_list[]  array....
		$op['bom_acc_list'] = array();
		if (!$op['acc_NONE']){   // 樣本有副料用料記錄---
	   		$op['bom_acc_list'] =bom_acc_edit($num_acc_used,$bom_acc['acc'],$acc_used['acc_use'],$num_colors, $PHP_id, $color_qty,$sizing,$size_qty);	
		} 
	// ---------------------- end BOM data layout [副料] ----------------------------
			// 表格 改進用 -----
			if (!$num_colors){	
				$op['total_fields'] = 9;   // BOM table的總欄位數
			}else{
				$op['total_fields'] = 8 + $num_colors;   // BOM table的總欄位數
			}
		// ---------------------- end BOM data layout table ----------------------------
		
		
	if (isset($PHP_dept_code))
	{
		$back_str="&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_etdstr=".$PHP_etdstr."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str']=$back_str;
		$back_str2="&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_etdstr=".$PHP_etdstr."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str2']=$back_str2;
	}else{
		$op['back_str']=$PHP_back_str;
		$op['back_str2']=$PHP_back_str2;
	}

		page_display($op, "012", $TPL_SMPL_BOM_CFM_EDIT);  	    
		break;		
		
					
	
		
		










#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//		 job 81-2-1    FTY SCHEDULE 工廠月排產 
//	case "fty_mon_schedule":	job 81-2-1	FTY SCHEDULE 工廠月排產 
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "fty_mon_schedule":
		check_authority('055',"view");

		$string = $PHP_year.$PHP_month;
		$op['dist'] = array();

		$m_array = array();

		if(isset($PHP_mk))
		{
			if($PHP_mk == 1)$where_str = " AND s_order.dept <> '$PHP_fty'";
			if($PHP_mk == 2)$where_str = " AND s_order.dept = '$PHP_fty' AND s_order.line_sex = 'F'";
			if($PHP_mk == 3)$where_str = " AND s_order.dept = '$PHP_fty' AND s_order.line_sex = 'M'";
			if($PHP_mk == 4)$where_str = " AND s_order.line_sex = 'A'";
			if($PHP_mk == 1) $op['title_mk'] = '-- by sales';
			if($PHP_mk == 2) $op['title_mk'] = '-- by factory (女裝線)';
			if($PHP_mk == 3) $op['title_mk'] = '-- by factory (男裝線)';
			if($PHP_mk == 4) $op['title_mk'] = '-- 龍安廠';
		}else{
			$where_str ='';
		}

			$T = (($PHP_month -2) < 1) ? 12:0;
		$mon[0] = substr($PHP_month - 2 + $T + 100,1);
			$T = (($PHP_month -1) < 1) ? 12:0;
		$mon[1] = substr($PHP_month - 1 + $T + 100,1);
		$mon[2] = $PHP_month;
			$T = (($PHP_month +1) > 12) ? 12:0;
		$mon[3] = substr($PHP_month + 1 - $T + 100,1);
			$T = (($PHP_month +2) > 12) ? 12:0;
		$mon[4] = substr($PHP_month + 2 - $T + 100,1);

		if (!$result = $capaci->search_schdl($PHP_fty,$string,500,$where_str)) {   
			$op['msg']= $capaci->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['ttl_su'] = 0;
		$data = array(); // for GANTT chart.....

	if($result != "none"){

		for ($i = 0; $i < count($result); $i++) {   // $i 為 訂單的總數量

			$op['ord'][$i]['ord_num'] = $result[$i]['order_num'];
			$op['ord'][$i]['qty'] = $result[$i]['qty'];
			$op['ord'][$i]['su'] = $result[$i]['su'];
			$op['ord'][$i]['ets'] = $result[$i]['ets'];
			$op['ord'][$i]['etf'] = $result[$i]['etf'];
			$op['ord'][$i]['shp'] = $result[$i]['qty_shp'];
			$op['ord'][$i]['done'] = $result[$i]['qty_done'];
			$op['ord'][$i]['status'] = $result[$i]['status'];
				
			// 計算 前後兩個月及查尋月份之資料 並做html之 layout
			// $etp_mon 為帶有年份的月 即 200503 ...
			$etp_mon = csv2array($result[$i]['fty_su']);   
			for ($k=0; $k < count($mon); $k++){   // 五個月的資料陣列設定
						$op['ord'][$i][$k] = '';  //先將所有值設為null

				for ($j=0; $j < count($etp_mon); $j++){

					$mon_key = substr($etp_mon[$j],4,2);  // $mon_key 為兩位的mon
					$mon_su = substr($etp_mon[$j],6);

						if($mon_key == $mon[$k]){
							$op['ord'][$i][$k] = $mon_su;
						}
				}   //for ($j=0
				
			}  //for ($k=0;

			$op['ttl_su'] = $op['ttl_su'] + $op['ord'][$i][2];
		
		} //for ($i = 0

	} else{ //if($result != "none")
		$op['record_NONE'] = "1";
	}
		$op['fty'] = $PHP_fty;
		$op['year'] = $PHP_year;
		$op['month'] = $PHP_month;
		$op['mon'] = $mon;

		//  強迫將 capaci 內的 月份 schedule 更新~~ 主要是還沒找到為什麼會有差異
		//  check and 實地操作過  revise 及 再確認 核可訂單 之前後 都沒錯
		//  暫時用強迫更新的方式 待觀察沒錯後 再disable這個程序
			
if(!isset($PHP_mk))
{
				$m_key = "m".$PHP_month;
			if ($PHP_su <> $op['ttl_su']){
				if (!$update = $capaci->update_field($PHP_fty,$PHP_year,"schedule",$m_key,$op['ttl_su'])) {   
					$op['msg']= "cannot update capacity database !, please contact system Administraor";
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
			}
}
	//GANTT CHART -----------------------------------------	
//參數
$top_date = $PHP_year.'-'.$PHP_month.'-'.'01';
$btm_date = $PHP_year.'-'.$PHP_month.'-'.getDaysInMonth($PHP_month,$PHP_year);

include_once($config['root_dir']."/lib/src/jpgraph.php");
include_once($config['root_dir']."/lib/src/jpgraph_gantt.php");

$graph = new GanttGraph(700);

$graph->title->Set("FACTORY ORDER SCHEDULE MONTHY Chart");
$graph->subtitle->Set("FTY: ".$PHP_fty." schedule plan of month:[ ".$PHP_month." ]");

// Setup some "very" nonstandard colors
$graph->SetMargin(15,50,20,40);
$graph->title->SetFont(FF_ARIAL,FS_BOLD,10);
$graph->SetMarginColor('lightgreen@0.8');
$graph->SetBox(true,'yellow:0.6',2);
$graph->SetFrame(true,'darkgreen',4);
$graph->scale->divider->SetColor('yellow:0.6');
$graph->scale->dividerh->SetColor('yellow:0.6');
$graph->SetShadow();

$graph->SetDateRange($top_date,$btm_date);

// Display month and year scale with the gridlines
$graph->ShowHeaders(GANTT_HWEEK | GANTT_HDAY | GANTT_HMONTH | GANTT_HYEAR);
$graph->scale->week->SetStyle(WEEKSTYLE_FIRSTDAY2);

$graph->scale->month->SetFontColor("white");
$graph->scale->month->SetBackgroundColor("teal");

$graph->scale->month->grid->SetColor('gray');
$graph->scale->month->grid->Show(true);
$graph->scale->year->grid->SetColor('gray');
$graph->scale->year->grid->Show(true);

// set TODAY Vline
$vline = new GanttVline($TODAY,'Today','red',2,'solid');
$vline->SetDayOffset(0.5);
$vline->title->SetColor('red');
$graph->Add($vline);

// set beg-month Vline
$beg = new GanttVline($top_date,'beg-month','blue',2,'solid');
$beg->SetDayOffset(0.5);
$beg->title->SetColor('blue');
$graph->Add($beg);

// set end-month Vline
$end = new GanttVline($btm_date,'end-month','blue',2,'solid');
$end->SetDayOffset(0.5);
$end->title->SetColor('blue');
$graph->Add($end);

// Setup activity info
// For the titles we also add a minimum width of 100 pixels for the Task name column
$graph->scale->actinfo->SetColTitles(
    array('Order#','days','qty'),array(50,18,25));
$graph->scale->actinfo->SetBackgroundColor('teal');
$graph->scale->actinfo->SetFontColor("white");
$graph->scale->actinfo->SetFont(FF_ARIAL,FS_BOLD,8);
$graph->scale->actinfo->vgrid->SetStyle('solid');
$graph->scale->actinfo->vgrid->SetColor('gray');

// Create GANTT bars data -----------
	$data = array();
	if($result != "none"){

		for ($i = 0; $i < count($result); $i++) {   // $i 為 訂單的總數量

			$duration = strval( (($op['ord'][$i]['ets'] == '0000-00-00') || (!$op['ord'][$i]['ets'])) ? 0 : countDays($op['ord'][$i]['ets'],$op['ord'][$i]['etf']) +1 );
			$O_qty[$i] = number_format($op['ord'][$i]['qty']);
//			$duration = $duration." d";

if($op['ord'][$i]['qty'] != 0){
	$finish_rate = number_format(($op['ord'][$i]['done']/$op['ord'][$i]['qty']),4, '.', ',');
}else{
	$finish_rate = 0;
}
$T = $finish_rate *100;;
$finish[$i] = $T."%";
// 因為 jpgraph 沒法接受 progress 大於 100%
if ($finish_rate > 1){ $progress[$i] = 1; }else{ $progress[$i] = $finish_rate; }

		$data[$i] =  array($i,array($op['ord'][$i]['ord_num'],$duration,$O_qty[$i]),$op['ord'][$i]['ets'],$op['ord'][$i]['etf'],FF_ARIAL,FS_BOLD,8);
		}
	}

// Create the bars and add them to the gantt chart [from $DATA] 
for($i=0; $i<count($data); $i++) {
	$bar = new GanttBar($data[$i][0],$data[$i][1],$data[$i][2],$data[$i][3],$finish[$i],10);
	if( count($data[$i])>4 )
		$bar->title->SetFont($data[$i][4],$data[$i][5],$data[$i][6]);
	$bar->SetPattern(BAND_RDIAG,"yellow");
	$bar->SetFillColor("gray");
	$bar->progress->Set($progress[$i]);
	$bar->progress->SetPattern(GANTT_SOLID,"teal");
	$graph->Add($bar);
}
	
	$op['chart'] = $graph->Stroke('picture/fty_schedule.png');

$op['SIDS'] = date(ymdhis);
		$layout->assign($op);
		$layout->display($TPL_FTY_SCHEDULE2);		    	    
	
	
	break;





#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//			job 91  [SALES][FORECAST]
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//	case "sales_forecast":	job 91  業務預算
//	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "sales_forecast":
		check_authority('061',"view");

				// creat FTY combo box
		$op['factory'] = $arry2->select($FACTORY,'','PHP_fty','select','');  	
				// creat cust combo box
		$where_str="order by cust_s_name"; //依cust_s_name排序
		$cust_def = $cust->get_fields('cust_init_name',$where_str);
		$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
		for ($i=0; $i< sizeof($cust_def); $i++)
		{
			$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
		}

		$op['cust'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue); 

		$op['year_1'] = $arry2->select($YEAR_WORK,'','PHP_year1','select','');  	
		$op['year_2'] = $arry2->select($YEAR_WORK,'','PHP_year2','select','');  	
		$op['year_3'] = $arry2->select($YEAR_WORK,'','PHP_year3','select','');  	


		$op['msg'] = $order->msg->get(2);

//080725message增加		
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];

		page_display($op,'061', $TPL_FORECAST);		    	    
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//	case "forecast_search":		job 91V  預算search
//
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "forecast_search":
		check_authority('061',"view");
		//至少要選擇 fty
		if (!$PHP_fty){
			$op['msg'][] = "Error ! you have to select the target Factory !";
		}
		if (!$PHP_year1){
			$PHP_year1 = $THIS_YEAR;
		}

		if (isset($op['msg'])){	
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$parm = array(	"fty"	=>  $PHP_fty,
						"cust"	=>  $PHP_cust,
						"year"	=>	$PHP_year1,
				);

		//定設定 where_str
		$where_str = " WHERE method='forecast' AND fty='".$PHP_fty."' AND year='".$PHP_year1."' ";
		
		//如果沒有選客戶 就全部搜尋
		if($PHP_cust){
			$where_str = $where_str."AND cust='".$PHP_cust."' ";
		}

		//database search data....
		   if(!$op = $forecast->search(0,$where_str)){
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
		for ($j=0; $j<13; $j++){
			$op['q'][$j] = 0;
			$op['f'][$j] = 0;
			$op['c'][$j] = 0;
			$op['t'][$j] = 0;
			$op['b'][$j] = 0;

		}

		for ($i=0; $i<$op['max_no']; $i++){

			if ($op['fcst'][$i]['cm'] == '') $op['fcst'][$i]['cm'] ='0,0,0,0,0,0,0,0,0,0,0,0,0';
			if ($op['fcst'][$i]['top'] == '') $op['fcst'][$i]['top'] ='0,0,0,0,0,0,0,0,0,0,0,0,0';
			if ($op['fcst'][$i]['botton'] == '') $op['fcst'][$i]['botton'] ='0,0,0,0,0,0,0,0,0,0,0,0,0';
			$op['fcst'][$i]['q'] = csv2array($op['fcst'][$i]['qty']);
			$op['fcst'][$i]['p'] = csv2array($op['fcst'][$i]['uprc']);
			$op['fcst'][$i]['f'] = csv2array($op['fcst'][$i]['fcst']);			
			$op['fcst'][$i]['c'] = csv2array($op['fcst'][$i]['cm']);
			$op['fcst'][$i]['t'] = csv2array($op['fcst'][$i]['top']);
			$op['fcst'][$i]['b'] = csv2array($op['fcst'][$i]['botton']);
			
			//加總全部的客戶預算---
			for ($j=0; $j<13; $j++){

				$op['q'][$j] = $op['q'][$j] + $op['fcst'][$i]['q'][$j];
				$op['f'][$j] = $op['f'][$j] + $op['fcst'][$i]['f'][$j];
				if($j==12)
				{
					$op['c'][$j] = $op['c'][$j] + $op['fcst'][$i]['c'][$j];
				}else{
					$op['c'][$j] = $op['c'][$j] + ($op['fcst'][$i]['c'][$j]*$op['fcst'][$i]['q'][$j]);
				}
				$op['t'][$j] = $op['t'][$j] + $op['fcst'][$i]['t'][$j];
				$op['b'][$j] = $op['b'][$j] + $op['fcst'][$i]['b'][$j];
			}
		}

		for ($j=0; $j<12; $j++){
				if($op['q'][$j] > 0) $op['c'][$j] = $op['c'][$j] / $op['q'][$j];
		}

		//如果搜尋資料庫錄數為 0 時
		if (!$op['max_no']){
			$op['msg'][] = "sorry ! current database found nothig from your request !";

		}

		$op['fty'] = $PHP_fty;
		$op['year'] = $PHP_year1;

		page_display($op,'061', $TPL_FORECAST_SEARCH);	    	    
	break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//	case "forecast_add":		job 91A  預算 ADD
//
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "forecast_add":
		check_authority('061',"add");
		// 如果沒選年份時 為今年
		if(!$PHP_year1)   {	$PHP_year1 = $THIS_YEAR;	}

		$parm = array(	"fty"	=>  $PHP_fty,
						"cust"	=>  $PHP_cust,
						"year"	=>	$PHP_year1,
				);

		$op['fty'] = $PHP_fty;
		$op['cust'] = $PHP_cust;
		$op['year'] = $PHP_year1;

		if (!$op['fty']){
			$op['msg'][] = "Error ! you have to select the target Factory !";
		}
		if(!$op['cust']){
			$op['msg'][] = "Error! you have to select one customer !";
		}
		if(!$op['year']){
			$op['msg'][] = "Error! you have to select target YEAR !";
		}

		if (isset($op['msg'])){	
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		//  檢查看看 資料庫是否已經 存在 ??
		   if($c = $forecast->get(0,$parm,'forecast')){
				$op['msg'][]= 'FY :'.$PHP_year1.'\'s forecast of factory[ '.$PHP_fty.' ] for:[ '.$PHP_cust.' ] is exist already !';
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}

		$op['msg'] ='';

		$op['fty'] = $PHP_fty;
		$op['year1'] = $PHP_year1;
		$op['year2'] = $PHP_year2;
		$op['year3'] = $PHP_year3;
		
		if (!$op['fty']){
			$op['msg'][] = "Error ! you have to select the target Factory !";
		}
		if(!$op['year1']){
			$op['msg'][] = "Error! you have to select one target YEAR at least !";
		}

		if ($op['msg']){	
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['ft_ary'] = array(1,2,3,4,5,6,7,8,9,10,11,12);
		$layout->assign($op);
		$layout->display($TPL_FORECAST_ADD);		    	    
	break;
	

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//	case "do_forecast_add":		job 91A  預算 ADD
//
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "do_forecast_add":

		check_authority('061',"add");

		$parm = array(	"fty"	=>  $PHP_fty,
						"cust"	=>  $PHP_cust,
						"year"	=>	$PHP_year,
						"method"=>	"forecast",
				);

		$tt_top = $tt_botton = $tt_qty = $tt_fcst = $tt_cm = 0;
		$fcst = array();

		for ($i=1; $i<13; $i++){

	//		$qty[$i]	= ($PHP_qty[$i] =='') ? 0 : $PHP_qty[$i];
			
			$top[$i]	= ($PHP_top[$i] =='') ? 0 : $PHP_top[$i];  //上衣
			$botton[$i]	= ($PHP_botton[$i] =='') ? 0 : $PHP_botton[$i];  //下身
			
			$uprc[$i]	= ($PHP_prc[$i] =='') ? 0 : $PHP_prc[$i];  //單價
			$cm[$i]	= ($PHP_cm[$i] =='') ? 0 : $PHP_cm[$i];   //工繳
			
			$qty[$i] = $top[$i]*2 + $botton[$i]; //計算數量
			
			$fcst[$i]	= $qty[$i] * $uprc[$i];		//計算收入
		
			$tt_fcst 		+= $fcst[$i];
			$tt_top			+= $top[$i];
			$tt_botton	+= $botton[$i];
			$tt_qty			+= $qty[$i];
			$tt_cm 			+= ($cm[$i]*$qty[$i]);
		}

			$top[13]		= $tt_top;
			$botton[13]	= $tt_botton;
			$qty[13]		= $tt_qty;
			$fcst[13]		= $tt_fcst;
			$cm[13]			= $tt_cm;
			$uprc[13]		= ($tt_qty !=0) ? number_format($tt_fcst/$tt_qty, 2, '.', '') : 0;

		$parm['uprc'] = Array2csv($uprc);
		$parm['qty'] = Array2csv($qty);
		$parm['top'] = Array2csv($top);
		$parm['botton'] = Array2csv($botton);
		$parm['fcst'] = Array2csv($fcst);
		$parm['cm'] = Array2csv($cm);
		//寫入forecast table
		if (!$result = $forecast->add($parm)) {   
			$op['msg']= $forecast->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		//由forecast table再叫出來 -----------------------
		if (!$f = $forecast->get($result)) {   
			$op['msg']= $forecast->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		
		$op['fcst'] = $f;

		//將csv改成陣列
			$op['fcst']['q'] = csv2array($f['qty']);
			$op['fcst']['p'] = csv2array($f['uprc']);
			$op['fcst']['f'] = csv2array($f['fcst']);
			$op['fcst']['c'] = csv2array($f['cm']);
			$op['fcst']['t'] = csv2array($f['top']);
			$op['fcst']['b'] = csv2array($f['botton']);
			# 記錄使用者動態
		$message = "customer: [".$f['cust']."] in factory:[".$f['fty']."] forecast of year:[".$f['year']."]  done creating";

		$log->log_add(0,"91A",$message);
		$op['msg'][]= $message;

		$layout->assign($op);
		$layout->display($TPL_FORECAST_SHOW);		    	    
	break;






#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//	case "forecast_update":		job 91E  預算更新
//
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "forecast_update":
		check_authority('061',"edit");
		// 如果沒選年份時 為今年
		if(!$PHP_year1)   {	$PHP_year1 = $THIS_YEAR;	}

		$parm = array(	"fty"	=>  $PHP_fty,
						"cust"	=>  $PHP_cust,
						"year"	=>	$PHP_year1,
				);

		$op['fty'] = $PHP_fty;
		$op['cust'] = $PHP_cust;
		$op['year'] = $PHP_year1;

		if (!$op['fty']){
			$op['msg'][] = "Error ! you have to select the target Factory !";
		}
		if(!$op['cust']){
			$op['msg'][] = "Error! you have to select one customer !";
		}
		if(!$op['year']){
			$op['msg'][] = "Error! you have to select target YEAR !";
		}

		if (isset($op['msg'])){	
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		//  檢查看看 資料庫是否 存在 ??
		   if(!$c = $forecast->get(0,$parm,'forecast')){
				$op['msg'][]= 'FY :'.$PHP_year1.'\'s forecast of factory[ '.$PHP_fty.' ] for:[ '.$PHP_cust.' ] is NOT EXIST in database !';
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}

			$op['qty'] = csv2array($c['qty']);
			$op['prc'] = csv2array($c['uprc']);
			$op['cm'] = csv2array($c['cm']);
			$op['top'] = csv2array($c['top']);
			$op['botton'] = csv2array($c['botton']);

			$op['id'] = $c['id'];


		$layout->assign($op);
		$layout->display($TPL_FORECAST_UPDATE);		    	    
	break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//	case "do_forecast_update":		job 91E  預算更新
//
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "do_forecast_update":

		check_authority('061',"edit");
		$parm = array(	"fty"	=>  $PHP_fty,
						"cust"	=>  $PHP_cust,
						"year"	=>	$PHP_year,
						"id"	=>	$PHP_id,
						"method"=>	"forecast",
				);


		$date_check = explode('-',$FTY_ETD_LIMIT);
		$date_mk = 0;
		if($PHP_year <= $date_check[0])
		{
			for($i=1; $i < $date_check[1]; $i++)
			{
				if($PHP_top[$i]) $date_mk = 1;
				if($PHP_botton[$i]) $date_mk = 1;
				if($PHP_prc[$i]) $date_mk = 1;
				if($PHP_cm[$i]) $date_mk = 1;
			}
		}
		
		if($date_mk == 1)
		{
			$parm = array(	"fty"	=>  $PHP_fty,
											"cust"	=>  $PHP_cust,
											"year"	=>	$PHP_year,
										);
	
			$op['fty'] = $PHP_fty;
			$op['cust'] = $PHP_cust;
			$op['year'] = $PHP_year;
			$c = $forecast->get(0,$parm,'forecast');
			

			$op['qty'] = csv2array($c['qty']);
			$op['prc'] = csv2array($c['uprc']);
			$op['cm'] = csv2array($c['cm']);
			$op['top'] = csv2array($c['top']);
			$op['botton'] = csv2array($c['botton']);

			$op['id'] = $c['id'];

			$op['msg'][] = $date_check[1]."月以前Pre-order資料必需消除";
			$layout->assign($op);
			$layout->display($TPL_FORECAST_UPDATE);
			break;
			
			
		}


		$tt_top = $tt_botton = $tt_qty = $tt_fcst = $tt_cm = 0;
		$fcst = array();

		for ($i=1; $i<13; $i++){

//			$qty[$i]	= ($PHP_qty[$i] =='') ? 0 : $PHP_qty[$i];

			$top[$i]	= ($PHP_top[$i] =='') ? 0 : $PHP_top[$i];
			$botton[$i]	= ($PHP_botton[$i] =='') ? 0 : $PHP_botton[$i];


			$uprc[$i]	= ($PHP_prc[$i] =='') ? 0 : $PHP_prc[$i];
			$cm[$i]	  = ($PHP_cm[$i] =='')  ? 0 : $PHP_cm[$i];
			
			$qty[$i] = $top[$i] * 2 + $botton[$i];
			$fcst[$i]	= $qty[$i] * $uprc[$i];

			$tt_fcst 		+= $fcst[$i];
			$tt_cm  		+= ($cm[$i]*$qty[$i]);
			$tt_qty 		+= $qty[$i];
			$tt_top 		+= $top[$i];
			$tt_botton	+= $botton[$i];
		}
		
		
		

			$qty[13]	= $tt_qty;
			$top[13]	=	$tt_top;
			$botton[13] = $tt_botton;
			$cm[13] 	= $tt_cm;
			$fcst[13]	= $tt_fcst;
			$uprc[13]	= ($tt_qty !=0) ? number_format($tt_fcst/$tt_qty, 2, '.', '') : 0;

		$parm['uprc']		= Array2csv($uprc);
		$parm['qty']		= Array2csv($qty);
		$parm['fcst']		= Array2csv($fcst);
		$parm['cm']			= Array2csv($cm);
		$parm['top']		= Array2csv($top);
		$parm['botton']	= Array2csv($botton);
		
		//寫入forecast table
		if (!$result = $forecast->edit($parm)) {   
			$op['msg']= $forecast->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		//由forecast table再叫出來 -----------------------
		if (!$f = $forecast->get($result)) {   
			$op['msg']= $forecast->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		
		$op['fcst'] = $f;

		//將csv改成陣列
			$op['fcst']['q'] = csv2array($f['qty']);
			$op['fcst']['p'] = csv2array($f['uprc']);
			$op['fcst']['f'] = csv2array($f['fcst']);
			$op['fcst']['c'] = csv2array($f['cm']);
			$op['fcst']['t'] = csv2array($f['top']);
			$op['fcst']['b'] = csv2array($f['botton']);
			# 記錄使用者動態
		$message = "customer: [".$f['cust']."] in factory:[".$f['fty']."] forecast of year:[".$f['year']."]  done UPDATE";

		$log->log_add(0,"91E",$message);
		$op['msg'][]= $message;

		$layout->assign($op);
		$layout->display($TPL_FORECAST_SHOW);		    	    
	break;





#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//		job 81  [ADMIN][CAPACITY]
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++




#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//		 job 81-4-1    SHIPPed 
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "shp_out":

		check_authority('055',"view");
		$string = $PHP_year.'-'.$PHP_month;
		$op['shp'] = array();

		if(isset($PHP_mk))
		{

			if($PHP_mk == 1)$where_str = " AND s_order.dept <> '$PHP_fty'";
			if($PHP_mk == 2)$where_str = " AND s_order.dept = '$PHP_fty' AND s_order.line_sex = 'F'";
			if($PHP_mk == 3)$where_str = " AND s_order.dept = '$PHP_fty' AND s_order.line_sex = 'M'";
			if($PHP_mk == 4)$where_str = " AND s_order.line_sex = 'A'";
			if($PHP_mk == 1) $op['title_mk'] = '-- by sales';
			if($PHP_mk == 2) $op['title_mk'] = '-- by factory (女裝線)';
			if($PHP_mk == 3) $op['title_mk'] = '-- by factory (男裝線)';
			if($PHP_mk == 4) $op['title_mk'] = '-- 龍安廠';
		}else{
			$where_str ='';
		}

		if (!$result = $shipping->search_mon_shp($PHP_fty,$string,500,$where_str)) {   
			$op['msg']= $shipping->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['ttl_shp_su'] = $op['ttl_shp_qty'] = $op['sales_fob'] = $op['ttl_odr_qty'] = 0;
	$j = -1; $cust = '';
	if($result != "none"){
		for ($i = 0; $i < count($result); $i++) {   // $i 為出口記錄 筆數			
			if(!isset($result[$i]['ship_fob']) || $result[$i]['ship_fob'] == 0)$result[$i]['ship_fob'] = $result[$i]['uprice'];
			$result[$i]['amt'] = $result[$i]['s_qty']* $result[$i]['ship_fob'];
			if($cust != $result[$i]['cust_iname']) //依客人分類(array)
			{
				$j++;
				$op['shp'][$j]['cust'] = $result[$i]['cust_iname'];
//新array項初始值	
				$op['shp'][$j]['shp_qty'] =$op['shp'][$j]['shp_su'] =0;				
				$op['shp'][$j]['odr_qty'] =$op['shp'][$j]['sales_fob'] =0;			
				$op['shp'][$j]['rowspan'] =0;
				$cust = $result[$i]['cust_iname'];
			}
			$op['shp'][$j]['det'][] = $result[$i]; 
//依客人小計			
			$op['shp'][$j]['shp_qty'] += $result[$i]['s_qty'];
			$op['shp'][$j]['shp_su'] += $result[$i]['su'];
			$op['shp'][$j]['odr_qty'] += $result[$i]['qty'];
			$op['shp'][$j]['sales_fob'] += ($result[$i]['s_qty']* $result[$i]['ship_fob']);
			$op['shp'][$j]['rowspan']++;

			$op['ttl_shp_qty'] = $op['ttl_shp_qty'] + $result[$i]['s_qty'];
			$op['ttl_shp_su'] = $op['ttl_shp_su'] + $result[$i]['su'];
			$op['ttl_odr_qty'] = $op['ttl_odr_qty'] + $result[$i]['qty'];
			$op['sales_fob'] = $op['sales_fob'] + $result[$i]['s_qty']* $result[$i]['ship_fob'];
			
		
		}
if(!isset($PHP_mk))		
{
		// 如果 capacity內的 shp數量與 shipping table的量不同時 更改 capacity內的量
		if ($PHP_qty != $op['ttl_shp_su']){
			if (!$update = $capaci->update_field($PHP_fty,$PHP_year,"shipping","m".$PHP_month,$op['ttl_shp_qty'])) {   
				$op['msg']= "cannot update capacity database !, please contact system Administraor";
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
		}
			// 如果 capacity內的 shp_fob 金額與 計算出來的金額不同時 更改 capacity內的金額
		if ($PHP_amt != $op['sales_fob']){
			if (!$update = $capaci->update_field($PHP_fty,$PHP_year,"shp_fob","m".$PHP_month,$op['sales_fob'])) {   
				$op['msg']= "cannot update capacity database !, please contact system Administraor";
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
		}
}
		$op['pc_avg'] = number_format($op['sales_fob']/$op['ttl_shp_qty'],2);

	} else{ //if($result != "none")
		$op['record_NONE'] = "1";
	}
		$op['fty'] = $PHP_fty;
		$op['year'] = $PHP_year;
		$op['mon'] = $PHP_month;
		$op['mon_mk'] = $PHP_year.'-'.$PHP_month."-01";
		page_display($op, '055', $TPL_MON_SHP);    	    
	
	break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//		 job 81-3-1    FTY SCHEDULE 排產 月報表
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "fty_etp_monthy":

		check_authority('029',"view");
		$string = $PHP_year.$PHP_month;
		$op['dist'] = array();

		$m_array = array();

			$T = (($PHP_month -2) < 1) ? 12:0;
		$mon[0] = substr($PHP_month - 2 + $T + 100,1);
			$T = (($PHP_month -1) < 1) ? 12:0;
		$mon[1] = substr($PHP_month - 1 + $T + 100,1);
		$mon[2] = $PHP_month;
			$T = (($PHP_month +1) > 12) ? 12:0;
		$mon[3] = substr($PHP_month + 1 - $T + 100,1);
			$T = (($PHP_month +2) > 12) ? 12:0;
		$mon[4] = substr($PHP_month + 2 - $T + 100,1);

		if (!$result = $capaci->search_schdl($PHP_fty,$string,500)) {   
			$op['msg']= $capaci->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['ttl_su'] = 0;

	if($result != "none"){

		for ($i = 0; $i < count($result); $i++) {   // $i 為 訂單的總數量

			$op['ord'][$i]['ord_num'] = $result[$i]['order_num'];
			$op['ord'][$i]['qty'] = $result[$i]['qty'];
			$op['ord'][$i]['su'] = $result[$i]['su'];
			$op['ord'][$i]['ets'] = $result[$i]['ets'];
			$op['ord'][$i]['etf'] = $result[$i]['etf'];
			$op['ord'][$i]['shp'] = $result[$i]['qty_shp'];
			$op['ord'][$i]['done'] = $result[$i]['qty_done'];
				
				
				// 計算 前後兩個月及查尋月份之資料 並做html之 layout
			$etp_mon = csv2array($result[$i]['fty_su']);   //$etp_mon 為帶有年份的月 即 200503 ...
			for ($k=0; $k < count($mon); $k++){   // 五個月的資料陣列設定
						$op['ord'][$i][$k] = '';  //先將所有值設為null

				for ($j=0; $j < count($etp_mon); $j++){

					$mon_key = substr($etp_mon[$j],4,2);  // $mon_key 為兩位的mon
					$mon_su = substr($etp_mon[$j],6);

						if($mon_key == $mon[$k]){
							$op['ord'][$i][$k] = $mon_su;
						}
				}   //for ($j=0
				
			}  //for ($k=0;

			$op['ttl_su'] = $op['ttl_su'] + $op['ord'][$i][2];
		
		} //for ($i = 0

	} else{ //if($result != "none")
		$op['record_NONE'] = "1";
	}
		$op['fty'] = $PHP_fty;
		$op['year'] = $PHP_year;
		$op['month'] = $PHP_month;
		$op['mon'] = $mon;

		//  強迫將 capaci 內的 月份 schedule 更新~~ 主要是還沒找到為什麼會有差異
		//  check and 實地操作過  revise 及 再確認 核可訂單 之前後 都沒錯
		//  暫時用強迫更新的方式 待觀察沒錯後 再disable這個程序
			
				$m_key = "m".$PHP_month;
			if ($PHP_su <> $op['ttl_su']){
				if (!$update = $capaci->update_field($PHP_fty,$PHP_year,"schedule",$m_key,$op['ttl_su'])) {   
					$op['msg']= "cannot update capacity database !, please contact system Administraor";
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
			}
		    	    
		page_display($op,'029', $TPL_FTY_SCHEDULE);	
	
	break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//			 job 81-2-1    SALES ETP 月報表
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "etp_monthy":

		check_authority('055',"view");
		$string = $PHP_year.$PHP_month;
		$op['dist'] = array();

		$m_array = array();

		if(isset($PHP_mk))
		{
			if($PHP_mk == 1)$where_str = " AND s_order.dept <> '$PHP_fty'";
			if($PHP_mk == 2)$where_str = " AND s_order.dept = '$PHP_fty' AND s_order.line_sex = 'F'";
			if($PHP_mk == 3)$where_str = " AND s_order.dept = '$PHP_fty' AND s_order.line_sex = 'M' ";
			if($PHP_mk == 4)$where_str = " AND s_order.line_sex = 'A'";
			if($PHP_mk == 1) $op['title_mk'] = '-- by sales';
			if($PHP_mk == 2) $op['title_mk'] = '-- by factory (女裝線)';
			if($PHP_mk == 3) $op['title_mk'] = '-- by factory (男裝線)';
			if($PHP_mk == 4) $op['title_mk'] = '-- 龍安廠';
		}else{
			$where_str ='';
		}

			$T = (($PHP_month -2) < 1) ? 12:0;
		$mon[0] = substr($PHP_month - 2 + $T + 100,1);
			$T = (($PHP_month -1) < 1) ? 12:0;
		$mon[1] = substr($PHP_month - 1 + $T + 100,1);
		$mon[2] = $PHP_month;
			$T = (($PHP_month +1) > 12) ? 12:0;
		$mon[3] = substr($PHP_month + 1 - $T + 100,1);
			$T = (($PHP_month +2) > 12) ? 12:0;
		$mon[4] = substr($PHP_month + 2 - $T + 100,1);

		if (!$result = $capaci->search_etp($PHP_fty,$string,500, $where_str)) {   
			$op['msg']= $capaci->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['ttl_su'] = 0;
		$op['ttl_qty'] = 0;
		$op['sales_fob'] = 0;
		$op['fty_su'] = 0;
		$op['sales_su'] = 0;

	if($result != "none"){

		for ($i = 0; $i < count($result); $i++) {   // $i 為 訂單的總數量

			$op['ord'][$i]['ord_num'] = $result[$i]['order_num'];
			$op['ord'][$i]['qty'] = $result[$i]['qty'];
			$op['ord'][$i]['su'] = $result[$i]['su'];
			$op['ord'][$i]['etp'] = $result[$i]['etp'];
			$op['ord'][$i]['etd'] = $result[$i]['etd'];
			$op['ord'][$i]['shp'] = $result[$i]['qty_shp'];
			$op['ord'][$i]['done'] = $result[$i]['qty_done'];
			$op['ord'][$i]['status'] = $result[$i]['status'];
				
				// 計算 前後兩個月及查尋月份之資料 並做html之 layout
			$etp_mon = csv2array($result[$i]['etp_su']);   //$etp_mon 為帶有年份的月 即 200503 ...
			for ($k=0; $k < count($mon); $k++){   // 五個月的資料陣列設定
						$op['ord'][$i][$k] = '';  //先將所有值設為null

				for ($j=0; $j < count($etp_mon); $j++){

					$mon_key = substr($etp_mon[$j],4,2);  // $mon_key 為兩位的mon
					$mon_su = substr($etp_mon[$j],6);

						if($mon_key == $mon[$k]){
							$op['ord'][$i][$k] = $mon_su;
						}
				}   //for ($j=0
			}  //for ($k=0;

			if ( $op['ord'][$i][2] == 0 || $result[$i]['ie1'] == 0)
			{
				$mon_qty = 0;
			}else{
				$mon_qty = $op['ord'][$i][2]/$result[$i]['ie1'];
			}
			
		//計算工廠和業務接單量=========start=============
		
			if($result[$i]['dept'] == 'LY' || $result[$i]['dept'] == 'J1' ||  $result[$i]['dept'] == 'HJ' ||  $result[$i]['dept'] == 'CF') 
			{
					$op['fty_su'] += $op['ord'][$i][2];	
			}else{
					$op['sales_su'] += $op['ord'][$i][2];
			}
		//計算工廠和業務接單量=========end===============
			
			$op['ttl_su'] = $op['ttl_su'] + $op['ord'][$i][2];
			$op['ttl_qty'] = $op['ttl_qty'] + $mon_qty;
			$op['sales_fob'] = $op['sales_fob'] + $mon_qty*$result[$i]['uprice'];
		
		} //for ($i = 0
		
		//計算工廠和業務接單量=========start=============
			$op['fty_su_pec'] = ($op['fty_su'] / $op['ttl_su']) * 100;	
			$op['sales_su_pec'] = ($op['sales_su'] / $op['ttl_su']) * 100;	
			$op['tol_su'] = $capaci->search_etp_full($PHP_fty,$PHP_year);
			if ($PHP_fty == 'LY')$where_str = " AND (s_order.dept ='LY' OR s_order.dept = 'J1')";
			if ($PHP_fty == 'HJ')$where_str = " AND (s_order.dept ='HJ' OR s_order.dept = 'J1')";
			if ($PHP_fty == 'CF')$where_str = " AND (s_order.dept ='CF' OR s_order.dept = 'J1')";
			$op['tol_fty_su'] = $capaci->search_etp_full($PHP_fty,$PHP_year,$where_str);
			$op['tol_sales_su'] = $op['tol_su'] - $op['tol_fty_su']; 
			$op['tol_fty_pec'] = ($op['tol_fty_su']/$op['tol_su'])*100;
			$op['tol_sales_pec'] = ($op['tol_sales_su']/$op['tol_su'])*100; 
		//計算工廠和業務接單量=========end===============
		
		
		
			if($op['ttl_su']){
				$op['su_avg'] = number_format($op['sales_fob']/$op['ttl_su'],2);
			}else{ $op['su_avg'] = 0; }

			if($op['ttl_qty']){
				$op['pc_avg'] = number_format($op['sales_fob']/$op['ttl_qty'],2);
			}else{$op['pc_avg'] = 0; }

	} else{ //if($result != "none")
		$op['record_NONE'] = "1";
	}
		$op['fty'] = $PHP_fty;
		$op['year'] = $PHP_year;
		$op['month'] = $PHP_month;
		$op['mon'] = $mon;

		//  強迫將 capaci 內的 月份 pre_schedule 更新~~ 主要是還沒找到為什麼會有差異
		//  check and 實地操作過  revise 及 再確認 核可訂單 之前後 都沒錯
		//  暫時用強迫更新的方式 待觀察沒錯後 再disable這個程序
			
if(!isset($PHP_mk))		
{
		$m_key = "m".$PHP_month;
		if ($PHP_su <> $op['ttl_su']){
			if (!$update = $capaci->update_field($PHP_fty,$PHP_year,"pre_schedule",$m_key,$op['ttl_su'])) {   
				$op['msg']= "cannot update capacity database !, please contact system Administraor";
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
		}
}
		$op['mm_wd'] = $MM[$PHP_month];
		page_display($op, '055', $TPL_ETP_OUTPUT);
	break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//			 case "un_etp_monthy":   未核可訂單 ETP 月報表
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "un_etp_monthy":

		check_authority('055',"view");
		$string = $PHP_year.$PHP_month;
	

		$op['dist'] = array();



		$m_array = array();

			$T = (($PHP_month -2) < 1) ? 12:0;
		$mon[0] = substr($PHP_month - 2 + $T + 100,1);
			$T = (($PHP_month -1) < 1) ? 12:0;
		$mon[1] = substr($PHP_month - 1 + $T + 100,1);
		$mon[2] = $PHP_month;
			$T = (($PHP_month +1) > 12) ? 12:0;
		$mon[3] = substr($PHP_month + 1 - $T + 100,1);
			$T = (($PHP_month +2) > 12) ? 12:0;
		$mon[4] = substr($PHP_month + 2 - $T + 100,1);

		if(isset($PHP_mk))
		{
			if($PHP_mk == 1)$where_str = " AND s_order.dept <> '$PHP_fty'";
			if($PHP_mk == 2)$where_str = " AND s_order.dept = '$PHP_fty' AND s_order.line_sex = 'F'";
			if($PHP_mk == 3)$where_str = " AND s_order.dept = '$PHP_fty' AND s_order.line_sex = 'M'";
			if($PHP_mk == 4)$where_str = " AND s_order.line_sex = 'A'";
			if($PHP_mk == 1) $op['title_mk'] = '-- by sales';
			if($PHP_mk == 2) $op['title_mk'] = '-- by factory (女裝線)';
			if($PHP_mk == 3) $op['title_mk'] = '-- by factory (男裝線)';
			if($PHP_mk == 4) $op['title_mk'] = '-- 龍安廠';
		}else{
			$where_str ='';
		}

		if (!$result = $capaci->get_unord_itme($PHP_fty,$PHP_year,$PHP_month,$where_str)) {   
			$op['msg']= $capaci->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['ttl_su'] = 0;
		$op['ttl_qty'] = 0;
		$op['sales_fob'] = 0;

	if($result != "none"){

		for ($i = 0; $i < sizeof($result); $i++) {   // $i 為 訂單的總數量

			$op['ord'][$i]['ord_num'] = $result[$i]['order_num'];
			$op['ord'][$i]['id'] = $result[$i]['id'];	
			$op['ord'][$i]['style'] = $result[$i]['style'];	
			$op['ord'][$i]['qty'] = $result[$i]['qty'];			
			$op['ord'][$i]['etp'] = $result[$i]['etp'];
			$op['ord'][$i]['etd'] = $result[$i]['etd'];
			$op['ord'][$i]['su'] = $result[$i]['su'];
			$op['ord'][$i]['status'] = get_ord_status($result[$i]['status']);
			$op['ord'][$i]['open'] = $result[$i]['opendate'];

				// 計算總 SU				
			if ($result[$i]['ie1'] > 0)
			{
				$T_su=$result[$i]['su'];
			}else if ($result[$i]['style']=='PS' || $result[$i]['style']=='BS' || $result[$i]['style']=='BZ' || $result[$i]['style']=='DR' || $result[$i]['style']=='JK' || $result[$i]['style']=='PS-J' || $result[$i]['style']=='PS-P' || $result[$i]['style']=='PS-S' || $result[$i]['style']=='VS' || $result[$i]['style']=='SS'){
				$T_su=$pre_su['t']*$result[$i]['qty'];
				$op['ord'][$i]['fsu']=$T_su;
				
			}else{
				$T_su=$pre_su['b']*$result[$i]['qty'];
				$op['ord'][$i]['fsu']=$T_su;
			}
			
			//計算每月 SU
			$msu=get_su($result[$i]['etp'],$result[$i]['etd'],$T_su);
			$sum=0;
			$ets=explode('-',$result[$i]['etp']);
			$etf=explode('-',$result[$i]['etd']);
			if ($ets[0]==$etf[0])
			{
				for ($y=0; $y<sizeof($msu); $y++)
				{
					$suc=explode('-',$msu[$y]);
					$sum=$sum+$suc[1];
				}
				$suc=explode('-',$msu[($y-1)]);
				$suc[1]=$suc[1]+($T_su-$sum);
				$msu[($y-1)]=$suc[0]."-".$suc[1];
			}

			for ($k=0; $k < count($mon); $k++){   // 五個月的資料陣列設定
						$op['ord'][$i][$k] = '';  //先將所有值設為null

				for ($j=0; $j < sizeof($msu); $j++){

					$mon_su = explode('-',$msu[$j]);  // $mon_su[0]=月 $mon_su[1]=su值

						if($mon_su[0] == $mon[$k]){
							$op['ord'][$i][$k] = $mon_su[1];
						}
				}   //for ($j=0
			}  //for ($k=0;
			
			if ($result[$i]['ie1'] > 0)
			{
				$mon_qty=$op['ord'][$i][2]/$result[$i]['ie1'];
			}else if ($result[$i]['style']=='PS' || $result[$i]['style']=='PT' || $result[$i]['style']=='SH' || $result[$i]['style']=='SK' || $result[$i]['style']=='SO' || $result[$i]['style']=='SS'){
				$mon_qty=$op['ord'][$i][2]/ 200;				
			}else{
				$mon_qty=$op['ord'][$i][2]/ 100;				
			}

			$op['ttl_su'] = $op['ttl_su'] + $op['ord'][$i][2];
			$op['ttl_qty'] = $op['ttl_qty'] + $mon_qty;
			$op['sales_fob'] = $op['sales_fob'] + $mon_qty*$result[$i]['uprice'];
		
		} //for ($i = 0
			if($op['ttl_su']){
				$op['su_avg'] = number_format($op['sales_fob']/$op['ttl_su'],2);
			}else{ $op['su_avg'] = 0; }

			if($op['ttl_qty']){
				$op['pc_avg'] = number_format($op['sales_fob']/$op['ttl_qty'],2);
			}else{$op['pc_avg'] = 0; }

	} else{ //if($result != "none")
		$op['record_NONE'] = "1";
	}
		$op['fty'] = $PHP_fty;
		$op['year'] = $PHP_year;
		$op['month'] = $PHP_month;
		$op['mon'] = $mon;
		$op['today']=date('Y-m-d');
		    	    
		page_display($op, '055', $TPL_UNETP_OUTPUT);
	break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//			 job 81-1-2    每日產出量 月報表 (外發)
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "monthy_daily_ouput":

		check_authority('055',"view");
		$op['fty'] = $PHP_fty;
		$op['year'] = $PHP_year;
		$op['month'] = $PHP_month;
		
		$mon_days = getDaysInMonth($PHP_month,$PHP_year);

		$op['total_qty'] = 0;
		$op['total_su'] = 0;

		$daily_mon = $result = array();

		if(isset($PHP_mk))
		{
			if($PHP_mk == 1)$where_str = " AND s_order.dept <> '$PHP_fty'";
			if($PHP_mk == 2)$where_str = " AND s_order.dept = '$PHP_fty' AND s_order.line_sex = 'F'";
			if($PHP_mk == 3)$where_str = " AND s_order.dept = '$PHP_fty' AND s_order.line_sex = 'M'";
			if($PHP_mk == 4)$where_str = " AND s_order.line_sex = 'A'";
			if($PHP_mk == 1) $op['title_mk'] = '-- by sales';
			if($PHP_mk == 2) $op['title_mk'] = '-- by factory (女裝線)';
			if($PHP_mk == 3) $op['title_mk'] = '-- by factory (男裝線)';
			if($PHP_mk == 4) $op['title_mk'] = '-- 龍安廠';
			$op['mk'] = $PHP_mk;
		}else{
			$where_str ='';
		}

			if (!$result = $daily->sum_daily_out($PHP_fty,$PHP_year,$PHP_month,$where_str)) {   
				$op['msg']= $daily->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}

		// smarty 計數由零啟始 thus轉換 同時計算必要之管理數據
		$out_data[0] = $schd_data[0] = $etp_data[0] = 0;  // GRAPHIC 用

	    for ($i = 1; $i <= count($result); $i++) {
			$op['total_qty'] = $op['total_qty'] + $result[$i]['qty'];
			
			$out_data[$i] = $op['total_su'] = $op['total_su'] + $result[$i]['su'];
			// out_data 用來給graphic用 
			$op['daily_mon'][$i-1]['accu_su'] = number_format($op['total_su']);
			$op['daily_mon'][$i-1]['avg_su'] = number_format($op['total_su'] / $i);

			$op['daily_mon'][$i-1]['date'] = $result[$i]['date'];
			$op['daily_mon'][$i-1]['qty'] = number_format($result[$i]['qty']);
			$op['daily_mon'][$i-1]['su'] = number_format($result[$i]['su']);
		}
		//  2006/06/02 加入---------- 不知為什麼會有差異
		//  強迫將 capaci 內的 月份 pre_schedule 更新~~ 主要是還沒找到為什麼會有差異
		//  check and 實地操作過  revise 及 再確認 核可訂單 之前後 都沒錯
		//  暫時用強迫更新的方式 待觀察沒錯後 再disable這個程序
if(!isset($PHP_mk))			
{
		$m_key = "m".$PHP_month;
		if ($PHP_su <> $op['total_su']){
			if (!$update = $capaci->update_field($PHP_fty,$PHP_year,"actual",$m_key,$op['total_su'])) {   
				$op['msg']= "cannot update capacity database !, please contact system Administraor";
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
		}
}
		//設定一些變數供graphic用
		$year_mon = $PHP_year.$PHP_month;
		$end_mon = $PHP_year."-".$PHP_month."-".$mon_days;  //月底日
		$beg_mon = $PHP_year."-".$PHP_month."-01";   //月初日
		//----- 設每日的預設值....
		for($i=1;$i<$mon_days+1;$i++){ 
				//$schd_d為日曆日的當天產量; $schd_data為累加產量
			$schd_d[$i] = $schd_data[$i] = 0;  
				//$etp_d為日曆日的當天訂單量; $etp_data為累加訂單量
			$etp_d[$i] = $etp_data[$i] = 0;  
		}
//-----------------------------------------------------------------------------------
		//計算工廠排產之每日量 -------------------------(for graphic)

		if (!$schd_A = $capaci->search_schdl($PHP_fty,$year_mon,500)) {   
			$op['msg']= $capaci->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		//----------------------------- 每筆計算 -----
		if ($schd_A != "none"){
			for($i=0;$i<count($schd_A);$i++){ //由找出來的記錄一筆筆計

				$fy_su = preg_grep("/^$year_mon/",csv2array($schd_A[$i]['fty_su']));
				foreach($fy_su as $su_key => $su_value);  //只取出值來用

				//開始日 及 結束日
				$sdate = ($schd_A[$i]['ets'] < $beg_mon ) ? $beg_mon : $schd_A[$i]['ets'];
				$edate = ($schd_A[$i]['etf'] > $end_mon ) ? $end_mon : $schd_A[$i]['etf'];

				$wdays = countDays($sdate, $edate); //可工作天數
				$t_su = substr($su_value, 6 );
				$day_su = 0;
				if(($wdays+1) <> 0)$day_su = intval($t_su/($wdays+1)); //每日產量

				$d = intval(substr($sdate,8));  //開始的日期

				for($j=$d; $j<$wdays+$d+1; $j++){ //由開始日算起
					if($j == intval(substr($edate,8))){  //最後一天時
						$schd_d[$j] = $schd_d[$j] + ($t_su - ($day_su * $wdays));
					}else{
						$schd_d[$j] = $schd_d[$j] + $day_su;
					}
				}
			}
			for($j=1;$j<$mon_days+1;$j++){  //累加...計算MTD
				$schd_data[$j] = $schd_data[$j-1] + $schd_d[$j];
			}

		}else{  // 沒有該月排產資料 ....
			$no_schd_rec = "1";
		}
//-----------------------------------------------------------------------------------
		//計算 業務訂單排產之每日量 ---------------------(for graphic)
		if (!$etp_A = $capaci->search_etp($PHP_fty,$year_mon,500)) {   
			$op['msg']= $capaci->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		//----------------------------- 每筆計算 -----
		if ($etp_A != "none"){
			for($i=0;$i<count($etp_A);$i++){ //由找出來的記錄一筆筆計
				$ord_su = preg_grep("/^$year_mon/",csv2array($etp_A[$i]['etp_su']));
				foreach($ord_su as $etp_key => $etp_value);  //只取出值來用
				//開始日 及 結束日
				$sdate = ($etp_A[$i]['etp'] < $beg_mon ) ? $beg_mon : $etp_A[$i]['etp'];
				$edate = ($etp_A[$i]['etd'] > $end_mon ) ? $end_mon : $etp_A[$i]['etd'];

					$wdays = countDays($sdate, $edate); //可工作天數
					$t_su = substr($etp_value, 6 );
					$day_su = intval($t_su/($wdays+1)); //每日產量

					$d = intval(substr($sdate,8));

					for($j=$d; $j<$wdays+$d+1; $j++){ //由開始日算起
						if($j == intval(substr($edate,8))){  //最後一天時
							$etp_d[$j] = $etp_d[$j] + ($t_su - ($day_su * $wdays));
						}else{
							$etp_d[$j] = $etp_d[$j] + $day_su;
						}
					}
			}
			for($j=1;$j<$mon_days+1;$j++){  //累加...計算MTD
					$etp_data[$j] = $etp_data[$j-1] + $etp_d[$j];
			}

		}else{  // 沒有該月排產資料 ....
			$no_etp_rec = "1";
		}
//-----------------------------------------------------------------------------------

	//******* Z Chart graph procedure ****************	

		//引入 graph class
		include_once($config['root_dir']."/lib/src/jpgraph.php");
		include_once($config['root_dir']."/lib/src/jpgraph_line.php");

		//計算產能data ---
		if(!$cp = $capaci->get($PHP_fty,$PHP_year)){ 
			$op['msg']= $capaci->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$f = "m".$PHP_month;
		$capa_mon = $cp["$f"];
		$capa_day = intval($capa_mon/$mon_days);
		
		for ($i=0; $i<$mon_days+1; $i++){
		  if($i==0){ 
			$capa_data[$i] = 0; 
		  }elseif($i==$mon_days){
			$capa_data[$i] = $capa_mon;
		  }else{
			$capa_data[$i] = $capa_data[$i-1] + $capa_day;
		  }
			$xx_data[$i] = $i;
		}

		$graphic_title = " FTY: ".$PHP_fty." production Z Chart for month: ".$PHP_year."/".$PHP_month;

		$graph = new Graph(700, 400, "auto");
		$graph->SetScale("textlin");
		$graph->ygrid->SetFill(true,'#EFEFEF@0.5','#BBCCFF@0.5');
		$graph->img->SetMargin(60,80,40,80);    
		$graph->subtitle->Set('( Daily Accumulated Chart )');
		$graph->SetShadow();
		// Setup X-scale
		$graph->xaxis->SetTickLabels($xx_data);
		$graph->xaxis->SetFont(FF_ARIAL,FS_NORMAL,8);

		// setup capacity plot
		$capaplot = new LinePlot($capa_data);
		$capaplot->SetWeight(1.5);
		$capaplot->SetColor('navy');
		$capaplot->SetLegend('capacity '.number_format($capa_data[$mon_days]).' SU');
		$graph->Add($capaplot);

		// setup etp plot
		$etpplot = new LinePlot($etp_data);
		$etpplot->SetWeight(1.5);
		$etpplot->SetColor('teal');
		$etpplot->SetLegend('Order '.number_format($etp_data[$mon_days]).' SU');
		$graph->Add($etpplot);

		// setup schedule plot
		$schdplot = new LinePlot($schd_data);
		$schdplot->SetWeight(1.5);
		$schdplot->SetColor('darkred');
		$schdplot->SetLegend('schedule '.number_format($schd_data[$mon_days]).' SU');
		$graph->Add($schdplot);

		// setup out-put plot
		$outplot = new LinePlot($out_data);
		$outplot->SetWeight(1.5);
		$outplot->SetColor('red');
		$outplot->SetLegend('out-put '.number_format($out_data[$mon_days]).' SU');
		$graph->Add($outplot);
		
		$graph->legend->SetShadow('gray@0.4',5);
		$graph->legend->Pos(0.25,0.3,"center","bottom");
		$graph->title->Set($graphic_title);
		$graph->title->SetFont(FF_FONT1,FS_BOLD);
		if($THIS_MON == $year_mon){  //今天的標示
			// Add a vertical line at the end scale position '7'
			$to_day = intval($TODAY);
			$l1 = new PlotLine(VERTICAL,$THIS_DATE,"red",1.5);

			$graph->Add($l1);
		}

		$op['chart'] = $graph->Stroke('picture/monthy_out.png');




		$layout->assign($op);
		$layout->display($TPL_MONTHY_DAILY_OUTPUT);		    	    
	
	break;



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//			 job 81-1-2    每日產出量 月報表
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "monthy_daily_subouput":

		check_authority('055',"view");
		$op['fty'] = $PHP_fty;
		$op['year'] = $PHP_year;
		$op['month'] = $PHP_month;
		
		$mon_days = getDaysInMonth($PHP_month,$PHP_year);

		$op['total_qty'] = 0;
		$op['total_su'] = 0;

			$daily_mon = $result = array();

		if(isset($PHP_mk))
		{
			if($PHP_mk == 1)$where_str = " AND s_order.dept <> '$PHP_fty'";
			if($PHP_mk == 2)$where_str = " AND s_order.dept = '$PHP_fty' AND s_order.line_sex = 'F'";
			if($PHP_mk == 3)$where_str = " AND s_order.dept = '$PHP_fty' AND s_order.line_sex = 'M'";
			if($PHP_mk == 4)$where_str = " AND s_order.line_sex = 'A'";
			if($PHP_mk == 1) $op['title_mk'] = '-- by sales';
			if($PHP_mk == 2) $op['title_mk'] = '-- by factory (女裝線)';
			if($PHP_mk == 3) $op['title_mk'] = '-- by factory (男裝線)';
			if($PHP_mk == 4) $op['title_mk'] = '-- 龍安廠';
			$op['mk'] = $PHP_mk;
		}else{
			$where_str ='';
		}

			if (!$result = $daily->sum_daily_subout($PHP_fty,$PHP_year,$PHP_month,$where_str)) {   
				$op['msg']= $daily->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}

		// smarty 計數由零啟始 thus轉換 同時計算必要之管理數據
		$out_data[0] = $schd_data[0] = $etp_data[0] = 0;  // GRAPHIC 用

	    for ($i = 1; $i <= count($result); $i++) {
			$op['total_qty'] = $op['total_qty'] + $result[$i]['qty'];
			
			$out_data[$i] = $op['total_su'] = $op['total_su'] + $result[$i]['su'];
			// out_data 用來給graphic用 
			$op['daily_mon'][$i-1]['accu_su'] = number_format($op['total_su']);
			$op['daily_mon'][$i-1]['avg_su'] = number_format($op['total_su'] / $i);

			$op['daily_mon'][$i-1]['date'] = $result[$i]['date'];
			$op['daily_mon'][$i-1]['qty'] = number_format($result[$i]['qty']);
			$op['daily_mon'][$i-1]['su'] = number_format($result[$i]['su']);			
		}

		//設定一些變數供graphic用
		$year_mon = $PHP_year.$PHP_month;
		$end_mon = $PHP_year."-".$PHP_month."-".$mon_days;  //月底日
		$beg_mon = $PHP_year."-".$PHP_month."-01";   //月初日
		//----- 設每日的預設值....
		for($i=1;$i<$mon_days+1;$i++){ 
				//$schd_d為日曆日的當天產量; $schd_data為累加產量
			$schd_d[$i] = $schd_data[$i] = 0;  
				//$etp_d為日曆日的當天訂單量; $etp_data為累加訂單量
			$etp_d[$i] = $etp_data[$i] = 0;  
		}
//-----------------------------------------------------------------------------------
		//計算工廠排產之每日量 -------------------------(for graphic)

		if (!$schd_A = $capaci->search_schdl($PHP_fty,$year_mon,500)) {   
			$op['msg']= $capaci->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		//----------------------------- 每筆計算 -----
		if ($schd_A != "none"){
			for($i=0;$i<count($schd_A);$i++){ //由找出來的記錄一筆筆計

				$fy_su = preg_grep("/^$year_mon/",csv2array($schd_A[$i]['fty_su']));
				foreach($fy_su as $su_key => $su_value);  //只取出值來用

				//開始日 及 結束日
				$sdate = ($schd_A[$i]['ets'] < $beg_mon ) ? $beg_mon : $schd_A[$i]['ets'];
				$edate = ($schd_A[$i]['etf'] > $end_mon ) ? $end_mon : $schd_A[$i]['etf'];

				$wdays = countDays($sdate, $edate); //可工作天數
				$t_su = substr($su_value, 6 );
				$day_su = intval($t_su/($wdays+1)); //每日產量

				$d = intval(substr($sdate,8));  //開始的日期

				for($j=$d; $j<$wdays+$d+1; $j++){ //由開始日算起
					if($j == intval(substr($edate,8))){  //最後一天時
						$schd_d[$j] = $schd_d[$j] + ($t_su - ($day_su * $wdays));
					}else{
						$schd_d[$j] = $schd_d[$j] + $day_su;
					}
				}
			}
			for($j=1;$j<$mon_days+1;$j++){  //累加...計算MTD
				$schd_data[$j] = $schd_data[$j-1] + $schd_d[$j];
			}

		}else{  // 沒有該月排產資料 ....
			$no_schd_rec = "1";
		}
//-----------------------------------------------------------------------------------
		//計算 業務訂單排產之每日量 ---------------------(for graphic)
		if (!$etp_A = $capaci->search_etp($PHP_fty,$year_mon,500)) {   
			$op['msg']= $capaci->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		//----------------------------- 每筆計算 -----
		if ($etp_A != "none"){
			for($i=0;$i<count($etp_A);$i++){ //由找出來的記錄一筆筆計
				$ord_su = preg_grep("/^$year_mon/",csv2array($etp_A[$i]['etp_su']));
				foreach($ord_su as $etp_key => $etp_value);  //只取出值來用
				//開始日 及 結束日
				$sdate = ($etp_A[$i]['etp'] < $beg_mon ) ? $beg_mon : $etp_A[$i]['etp'];
				$edate = ($etp_A[$i]['etd'] > $end_mon ) ? $end_mon : $etp_A[$i]['etd'];

					$wdays = countDays($sdate, $edate); //可工作天數
					$t_su = substr($etp_value, 6 );
					$day_su = intval($t_su/($wdays+1)); //每日產量

					$d = intval(substr($sdate,8));

					for($j=$d; $j<$wdays+$d+1; $j++){ //由開始日算起
						if($j == intval(substr($edate,8))){  //最後一天時
							$etp_d[$j] = $etp_d[$j] + ($t_su - ($day_su * $wdays));
						}else{
							$etp_d[$j] = $etp_d[$j] + $day_su;
						}
					}
			}
			for($j=1;$j<$mon_days+1;$j++){  //累加...計算MTD
					$etp_data[$j] = $etp_data[$j-1] + $etp_d[$j];
			}

		}else{  // 沒有該月排產資料 ....
			$no_etp_rec = "1";
		}
//-----------------------------------------------------------------------------------

	//******* Z Chart graph procedure ****************	

		//引入 graph class
		include_once($config['root_dir']."/lib/src/jpgraph.php");
		include_once($config['root_dir']."/lib/src/jpgraph_line.php");

		//計算產能data ---
		if(!$cp = $capaci->get($PHP_fty,$PHP_year)){ 
			$op['msg']= $capaci->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$f = "m".$PHP_month;
		$capa_mon = $cp["$f"];
		$capa_day = intval($capa_mon/$mon_days);
		
		for ($i=0; $i<$mon_days+1; $i++){
		  if($i==0){ 
			$capa_data[$i] = 0; 
		  }elseif($i==$mon_days){
			$capa_data[$i] = $capa_mon;
		  }else{
			$capa_data[$i] = $capa_data[$i-1] + $capa_day;
		  }
			$xx_data[$i] = $i;
		}

		$graphic_title = " FTY: ".$PHP_fty." production Z Chart for month: ".$PHP_year."/".$PHP_month;

		$graph = new Graph(700, 400, "auto");
		$graph->SetScale("textlin");
		$graph->ygrid->SetFill(true,'#EFEFEF@0.5','#BBCCFF@0.5');
		$graph->img->SetMargin(60,80,40,80);    
		$graph->subtitle->Set('( Daily Accumulated Chart )');
		$graph->SetShadow();
		// Setup X-scale
		$graph->xaxis->SetTickLabels($xx_data);
		$graph->xaxis->SetFont(FF_ARIAL,FS_NORMAL,8);

		// setup capacity plot
		$capaplot = new LinePlot($capa_data);
		$capaplot->SetWeight(1.5);
		$capaplot->SetColor('navy');
		$capaplot->SetLegend('capacity '.number_format($capa_data[$mon_days]).' SU');
		$graph->Add($capaplot);

		// setup etp plot
		$etpplot = new LinePlot($etp_data);
		$etpplot->SetWeight(1.5);
		$etpplot->SetColor('teal');
		$etpplot->SetLegend('Order '.number_format($etp_data[$mon_days]).' SU');
		$graph->Add($etpplot);

		// setup schedule plot
		$schdplot = new LinePlot($schd_data);
		$schdplot->SetWeight(1.5);
		$schdplot->SetColor('darkred');
		$schdplot->SetLegend('schedule '.number_format($schd_data[$mon_days]).' SU');
		$graph->Add($schdplot);

		// setup out-put plot
		$outplot = new LinePlot($out_data);
		$outplot->SetWeight(1.5);
		$outplot->SetColor('red');
		$outplot->SetLegend('out-put '.number_format($out_data[$mon_days]).' SU');
		$graph->Add($outplot);
		
		$graph->legend->SetShadow('gray@0.4',5);
		$graph->legend->Pos(0.25,0.3,"center","bottom");
		$graph->title->Set($graphic_title);
		$graph->title->SetFont(FF_FONT1,FS_BOLD);
		if($THIS_MON == $year_mon){  //今天的標示
			// Add a vertical line at the end scale position '7'
			$to_day = intval($TODAY);
			$l1 = new PlotLine(VERTICAL,$THIS_DATE,"red",1.5);

			$graph->Add($l1);
		}

		$op['chart'] = $graph->Stroke('picture/monthy_subout.png');
		$op['sub_con']=1;
		$op['sub_msg']="(sub-con.)";

	page_display($op, '055', $TPL_MONTHY_DAILY_OUTPUT);    	    	
	break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//			 job 81-1-3    每日產出量 報表
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "daily_ouput":

		check_authority('055',"view");
		$op['fty'] = $PHP_fty;
		$op['year'] = $PHP_year;
		$op['month'] = $PHP_month;
		$op['day'] = $PHP_day;
		$op['sub_con'] = $PHP_sub_con;
		$op['total_qty'] = 0;
		$op['total_su'] = 0;

		$op['the_date'] = $PHP_year."-".$PHP_month."-".$PHP_day;

		if(isset($PHP_mk))
		{
			if($PHP_mk == 1)$where_str = " AND s_order.dept <> '$PHP_fty'";
			if($PHP_mk == 2)$where_str = " AND s_order.dept = '$PHP_fty' AND s_order.line_sex = 'F'";
			if($PHP_mk == 3)$where_str = " AND s_order.dept = '$PHP_fty' AND s_order.line_sex = 'M'";

			if($PHP_mk == 1) $op['title_mk'] = '-- by sales';
			if($PHP_mk == 2) $op['title_mk'] = '-- by factory (女裝線)';
			if($PHP_mk == 3) $op['title_mk'] = '-- by factory (男裝線)';

		}else{
			$where_str ='';
		}

		$daily_out = $result = array();
		if ($PHP_sub_con == 1)
		{
			if (!$result = $daily->daily_subout($PHP_fty, $op['the_date'],$where_str)) {   
				$op['record_NONE'] = 1;				
			}
			$op['sub_msg']="(sub-con.)";
		}else{
			if (!$result = $daily->daily_out($PHP_fty, $op['the_date'],$where_str)) {   
				$op['record_NONE'] = 1;
			}
		}

		// smarty 計數由零啟始 thus轉換 同時計算必要之管理數據
	    for ($i = 0; $i < sizeof($result); $i++) {	    	
			$op['total_qty'] = $op['total_qty'] + $result[$i]['qty'];
			$op['total_su'] = $op['total_su'] + $result[$i]['su'];

			$op['daily_out'][$i]['ord_num'] = $result[$i]['ord_num'];
			$op['daily_out'][$i]['qty'] = number_format($result[$i]['qty']);
			$op['daily_out'][$i]['su'] = number_format($result[$i]['su']);
		}
			$op['total_qty'] = number_format($op['total_qty']);
			$op['total_su'] = number_format($op['total_su']);
	
	page_display($op, '055', $TPL_DAILY_OUTPUT);
	break;




#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//			 job 81-1-4     訂單 產出量記錄 報表
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "order_output":

		check_authority('055',"view");
		$op['ord_num'] = $PHP_ord_num;
		$daily_out = $result = array();

			if (!$ord = $order->get_ord_output($PHP_ord_num)) {   
				$op['msg']= $daily->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			
			$op['order'] = $ord;
			$op['order']['order_num'] = $PHP_ord_num;			
			
			
		$ttl_qty = $ttl_su = 0;
		$plan_days = $schedule_days = $progress_days = 0;
		$est_fdate = ''; // 估算完成日期
		$est_period = 0; // 估算總生產時程(日)

		// GANTT CHART 參數設定
		$bar2_s = $bar2_f = $bar3_s = $bar3_f = '';   // bar2及bar3的起迄日
		$bar2_des = $bar3_des = ''; // bar2, bar3的說明文字
		$duration1 = $duration2 = $duration3 =''; 


	if (!$out = $daily->order_daily_out($PHP_ord_num)) {   
		$op['record_NONE'] = 1;

	}else{
		// smarty 計數由零啟始 thus轉換 同時計算必要之管理數據

	    for ($i = 0; $i < sizeof($out); $i++) {
			$ttl_qty = $ttl_qty + $out[$i]['qty'];
			$ttl_su = $ttl_su + $out[$i]['su'];

			$op['order_out'][$i]['ttl_qty'] = $ttl_qty;
			$op['order_out'][$i]['ttl_su'] = $ttl_su;

			$op['order_out'][$i]['k_date'] = $out[$i]['k_date'];
			$op['order_out'][$i]['qty'] = $out[$i]['qty'];
			$op['order_out'][$i]['su'] = $out[$i]['su'];
			$op['order_out'][$i]['f_rate'] = $ttl_qty/$op['order']['qty']*100;
		}
		$op['order']['finish_qty'] = $ttl_qty;
		$op['order']['finish_su'] = $ttl_su;
		$op['order']['finish_rate'] = $ttl_qty/$op['order']['qty']*100;
	// 計算 in-house days [如果沒有 finish date就顯示 "not finish" ]
		$op['order']['inhouse'] = countDays($op['order_out'][0]['k_date'],$op['order_out'][count($out)-1]['k_date'])+1;

		if (!$op['order']['finish']){
			$op['order']['finish'] ="not finish yet!";
	 	}
		if (!$op['order']['shp_date']){
			$op['order']['shp_date'] ="not ship yet!";
	 	}

		//計算 估計完成日(平均算法) ------------
		//最後一天 有產出的日期
		$last_date = $op['order_out'][count($out)-1]['k_date'];
		if($ord['qty'] > $ttl_qty){
			//平均日產
			$day_avg = $ttl_qty/$op['order']['inhouse'];
			//預計還要幾天
			$more_days = number_format(($ord['qty'] - $ttl_qty)/$day_avg);
			//預計完成日
			$est_fdate = increceDaysInDate($last_date,$more_days);
			$est_period = $op['order']['inhouse'] + $more_days +1;
		}else{
			$est_fdate = increceDaysInDate($last_date,1);
			$est_period = $op['order']['inhouse'] + 1;
		}
	}  //if (!$out


// -------- factors for Gantt chart & anysys -----------------
$plan_days = countDays($ord['etp'],$ord['etd']) +1;
$schedule_days = (($ord['ets'] =='0000-00-00') || (!$ord['ets'])) ? 0 : countDays($ord['ets'],$ord['etf']) +1;
$progress_days = (($ord['finish'] =='0000-00-00') || (!$ord['finish'])) ? 0 : countDays($ord['start'],$ord['finish']) +1;

$duration1 = $plan_days ." days";
$duration2 = $schedule_days ." days";
$duration3 = $progress_days ." days";

	// 預設 bar2, bar3 的值

	//比較哪個日期最小 ;最前面
	$top_date = ($ord['apv_date'] < $ord['etp']) ? $top_date = $ord['apv_date'] : $top_date = $ord['etp'];
$btm_date='0000-00-00';
if (($ord['status'] == 12)){
	$btm_date = $ord['shp_date'];
	$btm_date = increceDaysInDate($btm_date,2);

	$bar2_s = $ord['ets'];
	$bar2_f = $ord['etf'];
	$bar3_s = $ord['start'];
	$bar3_f = $ord['finish'];

	// 如果已出貨 但卻沒有finish時 --- 要估算出可能的 完成日
	if (!$ord['finish'] ||($ord['finish'] =='0000-00-00')){
		$bar3_f = $est_fdate;
		$duration3 = "est.:".$est_period." days";
	}



}elseif(($ord['status'] == 10)){  // finish production
	//比較哪個日期最後
	$btm_date = ($ord['etd'] > $ord['etf']) ? $btm_date = $ord['etd'] : $btm_date = $ord['etf'];
	if($ord['finish'] && ($ord['finish'] !='0000-00-00')){
		$btm_date = ($btm_date > $ord['finish']) ? $btm_date = $btm_date : $btm_date = $ord['finish'];
	}
	$btm_date = increceDaysInDate($btm_date,2);

	$bar2_s = $ord['ets'];
	$bar2_f = $ord['etf'];
	$bar3_s = $ord['start'];
	$bar3_f = $ord['finish'];

}elseif(($ord['status'] == 8)){  // producing
	//比較哪個日期最後
	$btm_date = ($ord['etd'] > $ord['etf']) ? $btm_date = $ord['etd'] : $btm_date = $ord['etf'];
	$btm_date = ($btm_date > $est_fdate) ? $btm_date = $btm_date : $btm_date = $est_fdate;
	$btm_date = increceDaysInDate($btm_date,2);

	$bar2_s = $ord['ets'];
	$bar2_f = $ord['etf'];

	$bar3_s = $ord['start'];
	$bar3_f = $est_fdate;  //以預估日代入
	$duration3 = "est.:".$est_period." days";
//******** bar3 色


}elseif(($ord['status'] == 7)){  //cfm schedule no output
	//比較哪個日期最後
	$btm_date = ($ord['etd'] > $ord['etf']) ? $btm_date = $ord['etd'] : $btm_date = $ord['etf'];
	$btm_date = increceDaysInDate($btm_date,2);

	$bar2_s = $ord['ets'];
	$bar2_f = $ord['etf'];

	$bar3_s = increceDaysInDate($top_date,5);
	$bar3_f = increceDaysInDate($top_date,5);
	$duration3 = "[unset]";

}elseif(($ord['status'] == 6)){  // schedule but not cfm schedule
	//比較哪個日期最後
	$btm_date = ($ord['etd'] > $ord['etf']) ? $btm_date = $ord['etd'] : $btm_date = $ord['etf'];
	$btm_date = increceDaysInDate($btm_date,2);

	$bar2_s = $ord['ets'];
	$bar2_f = $ord['etf'];
	$duration2 = "[un-CFM]";
//******** bar2 色


	$bar3_s = increceDaysInDate($top_date,5);
	$bar3_f = increceDaysInDate($top_date,5);
	$duration3 = "[unset]";


}elseif(($ord['status'] == 4)){  // order APV
	$btm_date = $ord['etd'];
	$btm_date = increceDaysInDate($btm_date,2);

	$bar2_s = increceDaysInDate($top_date,5);
	$bar2_f = increceDaysInDate($top_date,5);
	$duration2 = "[unset]";

	$bar3_s = increceDaysInDate($top_date,5);
	$bar3_f = increceDaysInDate($top_date,5);
	$duration3 = "[unset]";

}else{ 
	# status = 14 or other status
	$btm_date = $ord['shp_date'];
	$btm_date = increceDaysInDate($btm_date,2);

	$bar2_s = $ord['ets'];
	$bar2_f = $ord['etf'];
	$bar3_s = $ord['start'];
	$bar3_f = $ord['finish'];

	// 如果已出貨 但卻沒有finish時 --- 要估算出可能的 完成日
	if (!$ord['finish'] ||($ord['finish'] =='0000-00-00')){
		$bar3_f = $est_fdate;
		$duration3 = "est.:".$est_period." days";
	}
}


if($ord['qty'] != 0){
	$finish_rate = number_format(($ttl_qty/$ord['qty']),4, '.', ',');
}else{
	$finish_rate = 0;
}
$T = $finish_rate *100;;
$finish = $T."%";

// 因為 jpgraph 沒法接受 progress 大於 100%
if ($finish_rate > 1){ $progress = 1; }else{ $progress = $finish_rate; }

// Gantt chart-----------------------------------------------------------------
include_once($config['root_dir']."/lib/src/jpgraph.php");
include_once($config['root_dir']."/lib/src/jpgraph_gantt.php");

$graph = new GanttGraph(700);

$graph->title->Set("ORDER PROGRESS Chart");
$graph->subtitle->Set($PHP_ord_num." - [".$ord['qty']." unit] FTY: ".$ord['factory']." by:[ ".$ord['creator']." ]");

// Setup some "very" nonstandard colors
$graph->SetMargin(15,50,20,40);
$graph->title->SetFont(FF_ARIAL,FS_BOLD,10);
$graph->SetMarginColor('lightgreen@0.8');
$graph->SetBox(true,'yellow:0.6',2);
$graph->SetFrame(true,'darkgreen',4);
$graph->scale->divider->SetColor('yellow:0.6');
$graph->scale->dividerh->SetColor('yellow:0.6');
$graph->SetShadow();

$graph->SetDateRange($top_date,$btm_date);

// Display month and year scale with the gridlines
$graph->ShowHeaders(GANTT_HWEEK | GANTT_HDAY | GANTT_HMONTH | GANTT_HYEAR);
$graph->scale->week->SetStyle(WEEKSTYLE_FIRSTDAY2);

$graph->scale->month->SetFontColor("white");
$graph->scale->month->SetBackgroundColor("teal");

$graph->scale->month->grid->SetColor('gray');
$graph->scale->month->grid->Show(true);
$graph->scale->year->grid->SetColor('gray');
$graph->scale->year->grid->Show(true);

// set TODAY Vline
$vline = new GanttVline($TODAY,'Today','red',2,'solid');
$vline->SetDayOffset(0.5);
$vline->title->SetColor('red');
$graph->Add($vline);


// set APV Vline
$apv = new GanttVline($ord['apv_date'],'APV','blue',2,'solid');
$apv->SetDayOffset(0.5);
$apv->title->SetColor('blue');
$graph->Add($apv);

// Setup activity info

// For the titles we also add a minimum width of 100 pixels for the Task name column
$graph->scale->actinfo->SetColTitles(
    array('Project','Duration'),array(70,20));
$graph->scale->actinfo->SetBackgroundColor('teal');
$graph->scale->actinfo->SetFontColor("white");
$graph->scale->actinfo->SetFont(FF_ARIAL,FS_BOLD,10);
$graph->scale->actinfo->vgrid->SetStyle('solid');
$graph->scale->actinfo->vgrid->SetColor('gray');

// Data for our example activities
$data = array(
	array(0,array("Pre-schedule",$duration1),$ord['etp'],$ord['etd'],FF_ARIAL,FS_BOLD,9),
	array(5,array("FTY schedule",$duration2),$bar2_s,$bar2_f,FF_ARIAL,FS_BOLD,9),
	array(6,array("Production",$duration3),$bar3_s,$bar3_f,FF_ARIAL,FS_BOLD,9)
);
	
// Create the bars and add them to the gantt chart

for($i=0; $i<count($data); ++$i) {

if ($data[$i][3] > 0 && $data[$i][2])
{
	$bar = new GanttBar($data[$i][0],$data[$i][1],$data[$i][2],$data[$i][3],$finish,10);
	if( count($data[$i])>4 )
		$bar->title->SetFont($data[$i][4],$data[$i][5],$data[$i][6]);
	$bar->SetPattern(BAND_RDIAG,"yellow");
	$bar->SetFillColor("gray");
	$bar->progress->Set($progress);
	$bar->progress->SetPattern(GANTT_SOLID,"teal");
	$graph->Add($bar);
}
}
//必要時改變 BAR2 及 BAR3的顏色 =============



// milestone for fabric ship, main acc ship....
// fabric ship
if($ord['mat_shp'] && ($ord['mat_shp'] != '0000-00-00' && $ord['mat_shp'] != '1111-11-11')){
	$mat_date = $ord['mat_shp'];
	$mat_des = $ord['mat_shp'];
}else{
	$mat_date = $top_date;
	$mat_des = 'no info !';
}
$fabric_ship = new MileStone(1,"- fabric receive",$mat_date,"($mat_des)");
$fabric_ship->caption->SetFont(FF_ARIAL,FS_NORMAL,8);
$fabric_ship->title->SetColor('firebrick1');
$fabric_ship->caption->SetColor('black');
$graph->Add($fabric_ship);

// key accessories ship
if($ord['m_acc_shp'] && ($ord['m_acc_shp'] != '0000-00-00' && $ord['m_acc_shp'] != '1111-11-11' )){
	$macc_date = $ord['m_acc_shp'];
	$macc_des = $ord['m_acc_shp'];
}else{
	$macc_date =$top_date;
	$macc_des = 'no info !';
}
$macc_ship = new MileStone(2,"- key acc receive",$macc_date,"($macc_des)");
$macc_ship->caption->SetFont(FF_ARIAL,FS_NORMAL,8);
$macc_ship->title->SetColor('firebrick1');
$macc_ship->caption->SetColor('black');
$graph->Add($macc_ship);

// sample approved
if($ord['smpl_apv'] && ($ord['smpl_apv'] != '0000-00-00')){
	$smpl_date = $ord['smpl_apv'];
	$smpl_des = $ord['smpl_apv'];
}else{
	$smpl_date = $top_date;
	$smpl_des = 'no  info !';
}
$smpl_apv = new MileStone(3,"- sample APV",$smpl_date,"($smpl_des)");
$smpl_apv->caption->SetFont(FF_ARIAL,FS_NORMAL,8);
$smpl_apv->title->SetColor('tomato3');
$smpl_apv->caption->SetColor('black');
$graph->Add($smpl_apv);

// shipping
if($ord['shp_date'] && ($ord['shp_date'] != '0000-00-00')){
	$shp_date = $ord['shp_date'];
	$shp_des = $ord['shp_date'];
}else{
	$shp_date = $top_date;
	$shp_des = 'no info !';
}
$shipping = new MileStone(7,"- shipping",$shp_date,"($shp_des)");
$shipping->caption->SetFont(FF_ARIAL,FS_BOLD,8);
$shipping->title->SetColor('blue');
$shipping->caption->SetColor('black');
$graph->Add($shipping);

		$op['order']['chart'] = $graph->Stroke('picture/order_out.png');
	
		$op['dur1'] = $duration1;
		$op['dur2'] = $duration2;
		$op['dur3'] = $duration3;

		if(file_exists($GLOBALS['config']['root_dir']."/picture/".$PHP_ord_num.".jpg")){
			$op['main_pic'] = "./picture/".$PHP_ord_num.".jpg";
		} else {
			$op['main_pic'] = "./images/graydot.gif";
		}

	page_display($op,'055', $TPL_ORDER_OUTPUT);	
	break;









#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//			job 36  [生產製造][生產 排程]
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//			 job 36X    確認訂單 記錄轉成 excel 檔
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "schedule_excel":

		if(!$admin->is_power(3,6,"view")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$parm = array(	"dept"		=>  $PHP_dept_code,
						"ord_num"	=>  $PHP_order_num,
						"cust"		=>	$PHP_cust,
						"ref"		=>	$PHP_ref,
						"fty"		=>	$PHP_factory,
				);

		if (!$ord = $order->apved_search(2,'',1000)) {  // 2005/11/24 加入第三個參數 改變搜尋大小
			$op['msg']= $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$a = $ord['max_no'];
	
	require_once($config['root_dir']."/lib/spreadsheets/Worksheet.php");
	require_once($config['root_dir']."/lib/spreadsheets/Workbook.php");

	  function HeaderingExcel($filename) {
		  header("Content-type: application/vnd.ms-excel");
		  header("Content-Disposition: attachment; filename=$filename" );
		  header("Expires: 0");
		  header("Cache-Control: must-revalidate, post-check=0,pre-check=0");
		  header("Pragma: public");
		  }

	  // HTTP headers
	  HeaderingExcel('order.apved.xls');
	 
	  // Creating a workbook
	  $workbook = new Workbook("-");

	  // Creating the first worksheet
	  $worksheet1 =& $workbook->add_worksheet('order list');

		$now = $GLOBALS['THIS_TIME'];

	// 寫入 title

	  // Format for the headings
	  $formatot =& $workbook->add_format();
	  $formatot->set_size(10);
	  $formatot->set_align('center');
	  $formatot->set_color('white');
	  $formatot->set_pattern();
	  $formatot->set_fg_color('navy');

	  $f2 =& $workbook->add_format();
	  $f2->set_size(10);
	  $f2->set_align('center');
	  $f2->set_color('navy');
	  $f2->set_fg_color('white');

	  $worksheet1->set_column(0,0,10);
	  $worksheet1->set_column(0,1,5);
	  $worksheet1->set_column(0,2,5);
	  $worksheet1->set_column(0,3,8);
	  $worksheet1->set_column(0,4,3);
	  $worksheet1->set_column(0,5,8);
	  $worksheet1->set_column(0,6,8);
	  $worksheet1->set_column(0,7,8);
	  $worksheet1->set_column(0,8,6);
	  $worksheet1->set_column(0,9,6);
	  $worksheet1->set_column(0,10,14);
	  $worksheet1->set_column(0,11,14);
	  $worksheet1->set_column(0,12,14);
	  $worksheet1->set_column(0,13,14);
	  $worksheet1->set_column(0,14,14);
	  $worksheet1->set_column(0,15,14);
	  $worksheet1->set_column(0,16,5);
	  $worksheet1->set_column(0,17,0);
	  $worksheet1->set_column(0,18,14);
	  $worksheet1->set_column(0,19,14);
	  $worksheet1->set_column(0,20,14);
	  $worksheet1->set_column(0,21,14);
	  $worksheet1->set_column(0,22,14);
	  $worksheet1->set_column(0,23,14);
	  $worksheet1->set_column(0,24,0);
	  $worksheet1->set_column(0,25,4);
	  $worksheet1->set_column(0,26,8);
	  $worksheet1->set_column(0,27,10);
	  $worksheet1->set_column(0,28,10);
	  $worksheet1->set_column(0,29,10);
	  $worksheet1->set_column(0,30,10);
	  $worksheet1->set_column(0,31,6);
	  $worksheet1->set_column(0,32,15);

	  $worksheet1->write_string(0,1,"Order List ( order APVed )");
	  $worksheet1->write(0,8,"printed:".$now);

	  $worksheet1->write_string(1,0,"Order#",$formatot);
	  $worksheet1->write_string(1,1,"cust",$formatot);
	  $worksheet1->write_string(1,2,"style",$formatot);
	  $worksheet1->write_string(1,3,"Q'ty",$formatot);
	  $worksheet1->write_string(1,4,"unit",$formatot);
	  $worksheet1->write_string(1,5,"finish Q'ty",$formatot);
	  $worksheet1->write_string(1,6,"shp Q'ty",$formatot);
	  $worksheet1->write_string(1,7,"order SU",$formatot);
	  $worksheet1->write_string(1,8,"SPT",$formatot);
	  $worksheet1->write_string(1,9,"IE",$formatot);
	  $worksheet1->write_string(1,10,"ETD",$formatot);
	  $worksheet1->write_string(1,11,"ETF",$formatot);
	  $worksheet1->write_string(1,12,"ETP",$formatot);
	  $worksheet1->write_string(1,13,"ETS",$formatot);
	  $worksheet1->write_string(1,14,"start Date",$formatot);
	  $worksheet1->write_string(1,15,"finsh Date",$formatot);
	  $worksheet1->write_string(1,16,"FTY",$formatot);
	  $worksheet1->write_string(1,17,"",$formatot);
	  $worksheet1->write_string(1,18,"open date",$formatot);
	  $worksheet1->write_string(1,19,"order apv",$formatot);
	  $worksheet1->write_string(1,20,"smpl apv",$formatot);
	  $worksheet1->write_string(1,21,"patt upload",$formatot);
	  $worksheet1->write_string(1,22,"fab. shp",$formatot);
	  $worksheet1->write_string(1,23,"m. acc shp",$formatot);
	  $worksheet1->write_string(1,24,"",$formatot);
	  $worksheet1->write_string(1,25,"dept.",$formatot);
	  $worksheet1->write_string(1,26,"in charged",$formatot);
	  $worksheet1->write_string(1,27,"style#",$formatot);
	  $worksheet1->write_string(1,28,"smpl order#",$formatot);
	  $worksheet1->write_string(1,29,"pattn #",$formatot);
	  $worksheet1->write_string(1,30,"Quota cat.",$formatot);
	  $worksheet1->write_string(1,31,"revise",$formatot);
	  $worksheet1->write_string(1,32,"status",$formatot);

	  // Format for the numbers
	  $formatnum =& $workbook->add_format();
	  $formatnum->set_size(10);
	  $formatnum->set_align('center');
	  $formatnum->set_color('black');
	  $formatnum->set_fg_color('B8D7D8');

	for ($i=0; $i<sizeof($ord['sorder']); $i++){

			if ($ord['sorder'][$i]['status'] == 4) { $status_des ="APVED";
			}elseif($ord['sorder'][$i]['status'] == 5) { $status_des ="Reject";
			}elseif($ord['sorder'][$i]['status'] == 6) { $status_des ="SCHDL CFMing";
			}elseif($ord['sorder'][$i]['status'] == 7) { $status_des ="SCHDL CFMed";
			}elseif($ord['sorder'][$i]['status'] == 8) { $status_des ="PRODUCING";
			}elseif($ord['sorder'][$i]['status'] == 10) { $status_des =" FINISHED ";
			}elseif($ord['sorder'][$i]['status'] == 12) { $status_des =" SHIPPED ";
			}

	  $worksheet1->write($i+2,0,$ord['sorder'][$i]['order_num'],$formatnum);
	  $worksheet1->write($i+2,1,$ord['sorder'][$i]['cust'],$f2);
	  $worksheet1->write($i+2,2,$ord['sorder'][$i]['style'],$f2);
	  $worksheet1->write($i+2,3,$ord['sorder'][$i]['qty']);
	  $worksheet1->write($i+2,4,$ord['sorder'][$i]['unit']);
	  $worksheet1->write($i+2,5,$ord['sorder'][$i]['qty_done']);
	  $worksheet1->write($i+2,6,$ord['sorder'][$i]['qty_shp']);
	  $worksheet1->write($i+2,7,$ord['sorder'][$i]['su']);
	  $worksheet1->write($i+2,8,$ord['sorder'][$i]['ie_time1']);
	  $worksheet1->write($i+2,9,$ord['sorder'][$i]['ie1']);
	  $worksheet1->write($i+2,10,$ord['sorder'][$i]['etd'],$f2);
	  $worksheet1->write($i+2,11,$ord['sorder'][$i]['etf'],$f2);
	  $worksheet1->write($i+2,12,$ord['sorder'][$i]['etp'],$f2);
	  $worksheet1->write($i+2,13,$ord['sorder'][$i]['ets'],$f2);
	  $worksheet1->write($i+2,14,$ord['sorder'][$i]['start'],$f2);
	  $worksheet1->write($i+2,15,$ord['sorder'][$i]['finish'],$f2);
	  $worksheet1->write($i+2,16,$ord['sorder'][$i]['factory'],$f2);
	  $worksheet1->write($i+2,17,'',$formatot);
	  $worksheet1->write($i+2,18,$ord['sorder'][$i]['opendate'],$f2);
	  $worksheet1->write($i+2,19,$ord['sorder'][$i]['apv_date'],$f2);
	  $worksheet1->write($i+2,20,$ord['sorder'][$i]['smpl_apv'],$f2);
	  $worksheet1->write($i+2,21,$ord['sorder'][$i]['ptn_upload'],$f2);
	  $worksheet1->write($i+2,22,$ord['sorder'][$i]['mat_shp'],$f2);
	  $worksheet1->write($i+2,23,$ord['sorder'][$i]['m_acc_shp'],$f2);
	  $worksheet1->write($i+2,24,'',$formatot);
	  $worksheet1->write($i+2,25,$ord['sorder'][$i]['dept'],$f2);
	  $worksheet1->write($i+2,26,$ord['sorder'][$i]['creator'],$f2);
	  $worksheet1->write($i+2,27,$ord['sorder'][$i]['style_num'],$f2);
	  $worksheet1->write($i+2,28,$ord['sorder'][$i]['smpl_ord'],$f2);
	  $worksheet1->write($i+2,29,$ord['sorder'][$i]['patt_num'],$f2);
	  $worksheet1->write($i+2,30,$ord['sorder'][$i]['quota'],$f2);
	  $worksheet1->write($i+2,31,$ord['sorder'][$i]['revise'],$f2);
	  $worksheet1->write($i+2,32,$status_des,$f2);
	
	}

  $workbook->close();

	break;




//-------------------------------------------------------------------------------------
//			 job 101X    訂單 記錄轉成 excel 檔
//-------------------------------------------------------------------------------------
	case "order_excel":

		if(!$admin->is_power('065',"view") && !$admin->is_power('068',"view")){  // 加入讓生企也能取excel檔 2006/0106
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

	  $non_cost = 0;
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標(部門)
		$user_team = $GLOBALS['SCACHE']['ADMIN']['team_id'];   // 判定進入身份的指標(部門)
//限制成本分析檢視 2008.10.01			
//		if($user_team == 'TU') $non_cost = 1;
		if($user_dept == 'HJ' || $user_dept == 'LY' || $user_dept == 'CF')
		{
			if($user_team != 'SA')
			{
				$non_cost = 1;
			}
		}


		if (!$ord = $order->search(1,'',1000)) {  // 2005/11/24 加入第三個參數 改變搜尋大小
			$op['msg']= $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$a = $ord['max_no'];
        //print_r($ord );
  //echo sizeof($ord['sorder']);
  //exit;
  //新增output shipping
  for($i=0;$i<sizeof($ord['sorder']);$i++)
  {
    
    $ord['sorder'][$i]['output'] = $order->get_output($ord['sorder'][$i]['order_num']);
    $ord['sorder'][$i]['shipping'] = $order->get_shipping($ord['sorder'][$i]['order_num']);
  }
//print_r($ord );
	
	require_once($config['root_dir']."/lib/spreadsheets/Worksheet.php");
	require_once($config['root_dir']."/lib/spreadsheets/Workbook.php");

	  function HeaderingExcel($filename) {
		  header("Content-type: application/vnd.ms-excel");
		  header("Content-Disposition: attachment; filename=$filename" );
		  header("Expires: 0");
		  header("Cache-Control: must-revalidate, post-check=0,pre-check=0");
		  header("Pragma: public");
		  }

	  // HTTP headers
	  HeaderingExcel('order.xls');
	 
	  // Creating a workbook
	  $workbook = new Workbook("-");

	  // Creating the first worksheet
	  $worksheet1 =& $workbook->add_worksheet('order list');

		$now = $GLOBALS['THIS_TIME'];

	// 寫入 title

	  // Format for the headings
	  $formatot =& $workbook->add_format();
	  $formatot->set_size(10);
	  $formatot->set_align('center');
	  $formatot->set_color('white');
	  $formatot->set_pattern();
	  $formatot->set_fg_color('navy');

	  $f2 =& $workbook->add_format();
	  $f2->set_size(10);
	  $f2->set_align('center');
	  $f2->set_color('navy');
	  $f2->set_pattern();
	  $f2->set_fg_color('white');
      //有新增
	  $ary = array(10,5,5,8,3,8,8,8,8,14,14,5,10,10,10,6,10,10,10,6,0,14,14,14,14,6,6,6,0,4,8,10,10,10,10,10,10,10,6,10,20,20);
	  $ary2 = array(10,5,5,8,3,8,8,8,8,14,14,5,0,14,14,14,14,6,6,6,0,4,8,10,10,10,6,10,20,20);

		if($non_cost == 0)
		{
	  	for ($i=0; $i<sizeof($ary); $i++)	  
	  		$worksheet1->set_column(0,$i,$ary[$i]);
	  }else{
	  	for ($i=0; $i<sizeof($ary2); $i++)	  
	  		$worksheet1->set_column(0,$i,$ary2[$i]);	  
		}
	  

	  $worksheet1->write_string(0,1,"Order List");
	  $worksheet1->write(0,3,$now);
	   //有新增
	  $ary = array("Order#","cust","style","Q'ty","Unit","SU","OutPut","Shipping","FinalIE","ETD","ETP","FTY","@FOB prc","@CM cost","@fabric prc","YY","total Sales","total cost","gross margin","GM %",
	              "","open date","order apv","smpl apv","patt upload","SPT","IE","FNL. IE","","dept.","in charged","style#","smpl order#","pattn #","Quota cat.","Quota fee",
	              "comm. fee","smpl fee","revise","ref.","cust_po","status");

	  $ary2 = array("Order#","cust","style","Q'ty","Unit","SU","OutPut","Shipping","FinalIE","ETD","ETP","FTY",
	              "","open date","order apv","smpl apv","patt upload","SPT","IE","FNL.IE","","dept.","in charged","style#","smpl order#","pattn #",
	              "ref.","cust_po","status");

		if($non_cost == 0)
		{
	  	for ($i=0; $i<sizeof($ary); $i++)	  
	  		 $worksheet1->write_string(1,$i,$ary[$i],$formatot);
	  }else{
	  	for ($i=0; $i<sizeof($ary2); $i++)	  
	  		 $worksheet1->write_string(1,$i,$ary2[$i],$formatot);
		}	
     

	  // Format for the numbers
	  $formatnum =& $workbook->add_format();
	  $formatnum->set_size(10);
	  $formatnum->set_align('center');
	  $formatnum->set_color('black');
	  $formatnum->set_fg_color('B8D7D8');

	for ($i=0; $i < sizeof($ord['sorder']); $i++){
		$order_num = $ord['sorder'][$i]['order_num'];
		// 計算總成本 及毛利率
		$tt_cost = ($ord['sorder'][$i]['mat_u_cost']*$ord['sorder'][$i]['mat_useage']+$ord['sorder'][$i]['acc_u_cost']+$ord['sorder'][$i]['quota_fee']+$ord['sorder'][$i]['comm_fee']+$ord['sorder'][$i]['cm'])*$ord['sorder'][$i]['qty']-$ord['sorder'][$i]['smpl_fee'];
		$total_cost = number_format($tt_cost,2,'.','');

		$tt_sales = number_format($ord['sorder'][$i]['qty']*$ord['sorder'][$i]['uprice'],2,'.','');
		$gross = number_format($tt_sales-$total_cost,2,'.','');
		$status_des = get_ord_status($ord['sorder'][$i]['status']);

	  $worksheet1->write($i+2,0,$order_num,$formatnum);
	  $worksheet1->write($i+2,1,$ord['sorder'][$i]['cust'],$f2);
	  $worksheet1->write($i+2,2,$ord['sorder'][$i]['style'],$f2);
	  $worksheet1->write($i+2,3,$ord['sorder'][$i]['qty']);
	  $worksheet1->write($i+2,4,$ord['sorder'][$i]['unit']);
	  $worksheet1->write($i+2,5,$ord['sorder'][$i]['su']);
      //有新增
      $worksheet1->write($i+2,6,$ord['sorder'][$i]['output']);
      $worksheet1->write($i+2,7,$ord['sorder'][$i]['shipping']);
      $worksheet1->write($i+2,8,$ord['sorder'][$i]['ie2']);
      
	  $worksheet1->write($i+2,9,$ord['sorder'][$i]['etd'],$f2);
	  $worksheet1->write($i+2,10,$ord['sorder'][$i]['etp'],$f2);
	  $worksheet1->write($i+2,11,$ord['sorder'][$i]['factory'],$f2);
	  if($non_cost == 0)
	  {
	  	$worksheet1->write($i+2,12,$ord['sorder'][$i]['uprice']);
	  	$worksheet1->write($i+2,13,$ord['sorder'][$i]['cm']);
	  	$worksheet1->write($i+2,14,$ord['sorder'][$i]['mat_u_cost']);
	  	$worksheet1->write($i+2,15,$ord['sorder'][$i]['mat_useage']);
	  	$worksheet1->write($i+2,16,$tt_sales);
	  	$worksheet1->write($i+2,17,$total_cost);
	  	$worksheet1->write($i+2,18,$gross);
	  	$worksheet1->write($i+2,19,$ord['sorder'][$i]['gmr']);	  	
		  $worksheet1->write($i+2,20,'',$formatot);
		  $worksheet1->write($i+2,21,$ord['sorder'][$i]['opendate'],$f2);
		  $worksheet1->write($i+2,22,$ord['sorder'][$i]['apv_date'],$f2);
		  $worksheet1->write($i+2,23,$ord['sorder'][$i]['smpl_apv'],$f2);
		  $worksheet1->write($i+2,24,$ord['sorder'][$i]['ptn_upload'],$f2);
		  $worksheet1->write($i+2,25,$ord['sorder'][$i]['ie_time1']);
		  $worksheet1->write($i+2,26,$ord['sorder'][$i]['ie1']);
		  $worksheet1->write($i+2,27,$ord['sorder'][$i]['ie2']);
		  $worksheet1->write($i+2,28,'',$formatot);
		  $worksheet1->write($i+2,29,$ord['sorder'][$i]['dept'],$f2);
		  $worksheet1->write($i+2,30,$ord['sorder'][$i]['creator'],$f2);
		  $worksheet1->write($i+2,31,$ord['sorder'][$i]['style_num'],$f2);
		  $worksheet1->write($i+2,32,$ord['sorder'][$i]['smpl_ord'],$f2);
	  	$worksheet1->write($i+2,33,$ord['sorder'][$i]['patt_num'],$f2);
	  	$worksheet1->write($i+2,34,$ord['sorder'][$i]['quota'],$f2);
	  	$worksheet1->write($i+2,35,$ord['sorder'][$i]['quota_fee']);
	  	$worksheet1->write($i+2,36,$ord['sorder'][$i]['comm_fee']);
	  	$worksheet1->write($i+2,37,$ord['sorder'][$i]['smpl_fee']);
	  	$worksheet1->write($i+2,38,$ord['sorder'][$i]['revise'],$f2);
	  	$worksheet1->write($i+2,39,$ord['sorder'][$i]['ref'],$f2);
	  	$worksheet1->write($i+2,40,$ord['sorder'][$i]['cust_po'],$f2);
	  	$worksheet1->write($i+2,41,$status_des,$f2);
	  }else{
		  $worksheet1->write($i+2,12,'',$formatot);
		  $worksheet1->write($i+2,13,$ord['sorder'][$i]['opendate'],$f2);
		  $worksheet1->write($i+2,14,$ord['sorder'][$i]['apv_date'],$f2);
		  $worksheet1->write($i+2,15,$ord['sorder'][$i]['smpl_apv'],$f2);
		  $worksheet1->write($i+2,16,$ord['sorder'][$i]['ptn_upload'],$f2);
		  $worksheet1->write($i+2,17,$ord['sorder'][$i]['ie_time1']);
		  $worksheet1->write($i+2,18,$ord['sorder'][$i]['ie1']);
		  $worksheet1->write($i+2,19,$ord['sorder'][$i]['ie1']);
		  $worksheet1->write($i+2,20,'',$formatot);
		  $worksheet1->write($i+2,21,$ord['sorder'][$i]['dept'],$f2);
		  $worksheet1->write($i+2,22,$ord['sorder'][$i]['creator'],$f2);
		  $worksheet1->write($i+2,23,$ord['sorder'][$i]['style_num'],$f2);
		  $worksheet1->write($i+2,24,$ord['sorder'][$i]['smpl_ord'],$f2);
	  	$worksheet1->write($i+2,25,$ord['sorder'][$i]['patt_num'],$f2);
	 		$worksheet1->write($i+2,26,$ord['sorder'][$i]['ref'],$f2);
	 		$worksheet1->write($i+2,27,$ord['sorder'][$i]['cust_po'],$f2);
	  	$worksheet1->write($i+2,28,$status_des,$f2);
		}
	}


  $workbook->close();


	break;




//-------------------------------------------------------------------------------------
//			 job 82  Forcast 每月彙總
//	
//-------------------------------------------------------------------------------------
case "mm_forcast_show":  
check_authority('057',"view");

$op['msg'] ='';
$mm=array('01','02','03','04','05','06','07','08','09','10','11','12','13');

$op['fty'] = $PHP_fty;
$op['year'] = $PHP_year;
$op['mon'] = $mm[$PHP_month];

//搜尋forcast
$where_str = " WHERE method='forecast' AND fty='".$PHP_fty."' AND year='".$PHP_year."' AND forecast.dept <> 'HJ' AND forecast.dept <> 'LY' AND forecast.dept <> 'CF'";
$m_cast = $forecast->search(0,$where_str);

$op['t'] = $op['b'] = $op['t_su'] = $op['b_su'] = $op['q'] = $op['f'] = $op['c'] = 0;
$k = 0;
for ($i=0; $i < $m_cast['max_no']; $i++){

	if ( !empty($m_cast['fcst'][$i]) ) {
		if ($m_cast['fcst'][$i]['top'] == '') $m_cast['fcst'][$i]['top'] ='0,0,0,0,0,0,0,0,0,0,0,0,0';
		if ($m_cast['fcst'][$i]['botton'] == '') $m_cast['fcst'][$i]['botton'] ='0,0,0,0,0,0,0,0,0,0,0,0,0';
		if ($m_cast['fcst'][$i]['top_su'] == '') $m_cast['fcst'][$i]['top_su'] ='0,0,0,0,0,0,0,0,0,0,0,0,0';
		if ($m_cast['fcst'][$i]['bottom_su'] == '') $m_cast['fcst'][$i]['bottom_su'] ='0,0,0,0,0,0,0,0,0,0,0,0,0';
		if ($m_cast['fcst'][$i]['cm'] == '') $m_cast['fcst'][$i]['cm'] ='0,0,0,0,0,0,0,0,0,0,0,0,0';
		if ($m_cast['fcst'][$i]['uprc'] == '') $m_cast['fcst'][$i]['uprc'] ='0,0,0,0,0,0,0,0,0,0,0,0,0';

		$m_cast['fcst'][$i]['t'] = csv2array($m_cast['fcst'][$i]['top']);
		$m_cast['fcst'][$i]['b'] = csv2array($m_cast['fcst'][$i]['botton']);
		$m_cast['fcst'][$i]['t_su'] = csv2array($m_cast['fcst'][$i]['top_su']);
		$m_cast['fcst'][$i]['b_su'] = csv2array($m_cast['fcst'][$i]['bottom_su']);
		
		$m_cast['fcst'][$i]['q'] = csv2array($m_cast['fcst'][$i]['qty']);
		$m_cast['fcst'][$i]['p'] = csv2array($m_cast['fcst'][$i]['uprc']);
		$m_cast['fcst'][$i]['f'] = csv2array($m_cast['fcst'][$i]['fcst']);
		$m_cast['fcst'][$i]['c'] = csv2array($m_cast['fcst'][$i]['cm']);
		
		if($m_cast['fcst'][$i]['q'][$PHP_month] > 0)
		{
			$op['fcst'][$k]['id'] = $m_cast['fcst'][$i]['id'];
			$op['fcst'][$k]['cust'] = $m_cast['fcst'][$i]['cust_iname']; //記錄當月資訊
			$op['fcst'][$k]['cust_id'] = $m_cast['fcst'][$i]['cust']; //記錄當月資訊
			$op['fcst'][$k]['dept'] = $m_cast['fcst'][$i]['dept']; //記錄當月資訊
			$op['fcst'][$k]['q'] = $m_cast['fcst'][$i]['q'][$PHP_month];  
			$op['fcst'][$k]['t'] = $m_cast['fcst'][$i]['t'][$PHP_month];
			$op['fcst'][$k]['b'] = $m_cast['fcst'][$i]['b'][$PHP_month];
			$op['fcst'][$k]['t_su'] = $m_cast['fcst'][$i]['t_su'][$PHP_month];
			$op['fcst'][$k]['b_su'] = $m_cast['fcst'][$i]['b_su'][$PHP_month];
			$op['fcst'][$k]['p'] = $m_cast['fcst'][$i]['p'][$PHP_month];
			$op['fcst'][$k]['f'] = $m_cast['fcst'][$i]['f'][$PHP_month];
			$op['fcst'][$k]['c'] = $m_cast['fcst'][$i]['c'][$PHP_month];
			
			$op['q'] += $m_cast['fcst'][$i]['q'][$PHP_month]; //加總當月記錄
			$op['t'] += $m_cast['fcst'][$i]['t'][$PHP_month];
			$op['b'] += $m_cast['fcst'][$i]['b'][$PHP_month];
			$op['t_su'] += $m_cast['fcst'][$i]['t_su'][$PHP_month];
			$op['b_su'] += $m_cast['fcst'][$i]['b_su'][$PHP_month];
			$op['f'] += $m_cast['fcst'][$i]['f'][$PHP_month];
			$op['c'] += $m_cast['fcst'][$i]['c'][$PHP_month]*$m_cast['fcst'][$i]['q'][$PHP_month];
			$k++;
		}
	}
}
if(isset($PHP_mk) && $PHP_mk == 2)
{
	$op['t'] = $op['b'] = $op['t_su'] = $op['b_su'] = $op['q'] = $op['f'] = $op['c'] = 0;
	$op['fcst'] = array();
}


//搜尋forcast  工廠輸入的
$op['ft'] = $op['fb'] = $op['ft_su'] = $op['fb_su'] = $op['fq'] = $op['ff'] = $op['fc'] = 0;
$where_str = " WHERE method='forecast' AND fty='".$PHP_fty."' AND year='".$PHP_year."' AND (forecast.dept = 'HJ' OR forecast.dept = 'LY')";
$m_cast = $forecast->search(0,$where_str);	  
$k = 0;
for ($i=0; $i<$m_cast['max_no']; $i++){
	
	if ($m_cast['fcst'][$i]['top'] == '') $m_cast['fcst'][$i]['top'] ='0,0,0,0,0,0,0,0,0,0,0,0,0';
	if ($m_cast['fcst'][$i]['botton'] == '') $m_cast['fcst'][$i]['botton'] ='0,0,0,0,0,0,0,0,0,0,0,0,0';
	if ($m_cast['fcst'][$i]['top_su'] == '') $m_cast['fcst'][$i]['top_su'] ='0,0,0,0,0,0,0,0,0,0,0,0,0';
	if ($m_cast['fcst'][$i]['bottom_su'] == '') $m_cast['fcst'][$i]['bottom_su'] ='0,0,0,0,0,0,0,0,0,0,0,0,0';
	if ($m_cast['fcst'][$i]['cm'] == '') $m_cast['fcst'][$i]['cm'] ='0,0,0,0,0,0,0,0,0,0,0,0,0';
	if ($m_cast['fcst'][$i]['uprc'] == '') $m_cast['fcst'][$i]['uprc'] ='0,0,0,0,0,0,0,0,0,0,0,0,0';

	$m_cast['fcst'][$i]['t'] = csv2array($m_cast['fcst'][$i]['top']);
	$m_cast['fcst'][$i]['b'] = csv2array($m_cast['fcst'][$i]['botton']);
	$m_cast['fcst'][$i]['t_su'] = csv2array($m_cast['fcst'][$i]['top_su']);
	$m_cast['fcst'][$i]['b_su'] = csv2array($m_cast['fcst'][$i]['bottom_su']);
	
	$m_cast['fcst'][$i]['q'] = csv2array($m_cast['fcst'][$i]['qty']);
	$m_cast['fcst'][$i]['p'] = csv2array($m_cast['fcst'][$i]['uprc']);
	$m_cast['fcst'][$i]['f'] = csv2array($m_cast['fcst'][$i]['fcst']);
	$m_cast['fcst'][$i]['c'] = csv2array($m_cast['fcst'][$i]['cm']);
	
	if($m_cast['fcst'][$i]['q'][$PHP_month] > 0)
	{
		
		$op['ftyc'][$k]['cust'] = $m_cast['fcst'][$i]['cust_iname']; 
		$op['ftyc'][$k]['cust_id'] = $m_cast['fcst'][$i]['cust']; 
		
		$op['ftyc'][$k]['dept'] = $m_cast['fcst'][$i]['dept']; 
		$op['ftyc'][$k]['id'] = $m_cast['fcst'][$i]['id'];
		$op['ftyc'][$k]['q'] = $m_cast['fcst'][$i]['q'][$PHP_month];
		
		$op['ftyc'][$k]['t'] = $m_cast['fcst'][$i]['t'][$PHP_month];
		$op['ftyc'][$k]['b'] = $m_cast['fcst'][$i]['b'][$PHP_month];
		$op['ftyc'][$k]['t_su'] = $m_cast['fcst'][$i]['t_su'][$PHP_month];
		$op['ftyc'][$k]['b_su'] = $m_cast['fcst'][$i]['b_su'][$PHP_month];
		
		$op['ftyc'][$k]['p'] = $m_cast['fcst'][$i]['p'][$PHP_month];
		$op['ftyc'][$k]['f'] = $m_cast['fcst'][$i]['f'][$PHP_month];
		$op['ftyc'][$k]['c'] = $m_cast['fcst'][$i]['c'][$PHP_month];
		
		$op['fq'] += $m_cast['fcst'][$i]['q'][$PHP_month]; //加總當月記錄
		$op['ft'] += $m_cast['fcst'][$i]['t'][$PHP_month];
		$op['fb'] += $m_cast['fcst'][$i]['b'][$PHP_month];
		$op['ft_su'] += $m_cast['fcst'][$i]['t_su'][$PHP_month];
		$op['fb_su'] += $m_cast['fcst'][$i]['b_su'][$PHP_month];
		$op['ff'] += $m_cast['fcst'][$i]['f'][$PHP_month];
		$op['fc'] += $m_cast['fcst'][$i]['c'][$PHP_month]*$m_cast['fcst'][$i]['q'][$PHP_month];
		
		$k++;
	}
}		

if(isset($PHP_mk) && $PHP_mk == 1)
{
	$op['ft'] = $op['fb'] = $op['ft_su'] = $op['fb_su'] = $op['fq'] = $op['ff'] = $op['fc'] = 0;
	$op['ftyc'] = array();
}

		$op['tq'] = $op['q'] + $op['fq']; //加總當月記錄
		$op['tt'] = $op['t'] + $op['ft'];
		$op['tb'] = $op['b'] + $op['fb'];
		$op['tt_su'] = $op['t_su'] + $op['ft_su'];
		$op['tb_su'] = $op['b_su'] + $op['fb_su'];
		$op['tf'] = $op['f'] + $op['ff'];
		$op['tc'] = $op['c'] + $op['fc'];

//		if(!$m_cast['max_no'])$op['record_NONE'] = 1;


	$op['user_dept'] = $GLOBALS['SCACHE']['ADMIN']['dept'];

// 取出 全部客戶代號
$where_str="order by cust_s_name"; //依cust_s_name排序
$cust_def = $cust->get_fields('cust_init_name',$where_str);
$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
for ($i=0; $i< sizeof($cust_def); $i++)
{
	$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
}

$op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue);
$sales_dept_ary = get_sales_dept(); // 取出 業務的部門 [不含K0] ------
//業務部門 select選單
$op['dept_select'] = $arry2->select($sales_dept_ary,$GLOBALS['SCACHE']['ADMIN']['dept'],"PHP_dept","select","");  

page_display($op,'055', $TPL_ETP_MON_FCST);		
break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//	case "mm_forcast_append":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "mm_forcast_append":

$parm = array(
    "dept"      =>  $PHP_dept,
    "fty"       =>  $PHP_fty,
    "year"      =>  $PHP_year,
    "month"     =>  $PHP_month,
    "cust"      =>  $PHP_cust,
    "top"       =>	$PHP_top,
    "botton"    =>	$PHP_bot,
    "top_su"    =>	$PHP_top_su,
    "bottom_su" =>	$PHP_bot_su,
    "uprc"      =>	$PHP_uprc,
    "cm"        =>	$PHP_cm,
    "method"    =>	"forecast",
);

$tt_top = $tt_botton = $tt_top_su = $tt_bottom_su = $tt_qty = $tt_uprc = $tt_cm = 0;


$date_check = explode('-',$FTY_ETD_LIMIT);
$date_mk = 0;
if($PHP_year <= $date_check[0])
{
    if($PHP_month <= $date_check[1])
    {
        if($PHP_top) $date_mk = 1;
        if($PHP_bot) $date_mk = 1;
        if($PHP_top_su) $date_mk = 1;
        if($PHP_bot_su) $date_mk = 1;
    }
}

if($date_mk == 1)
{
    $message = $date_check[1]."月 Pre-Order資料僅能消除,不可修改";
    $op['msg'][]= $message;
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}


$fcst = $forecast->get('',$parm);

if(!empty($fcst)){
    check_authority('057',"edit");

    $mm = $PHP_month - 1;
    $qty = explode(',',$fcst['qty']);
    $top = explode(',',$fcst['top']);
    $botton = explode(',',$fcst['botton']);
    $top_su = explode(',',$fcst['top_su']);
    $bottom_su = explode(',',$fcst['bottom_su']);
    $uprc = explode(',',$fcst['uprc']);
    $cm = explode(',',$fcst['cm']);
    $fcsts = explode(',',$fcst['fcst']);
    $qty[12]=$top[12]=$botton[12]=$top_su[12]=$bottom_su[12]=$uprc[12]=$cm[12]=$fcst[12]=0;
    
    for($i=0; $i<sizeof($qty); $i++)
    {
        if($i == $mm)
        {
            $top[$i] = str_replace(",","",$PHP_top);
            $botton[$i] = str_replace(",","",$PHP_bot);
            $top_su[$i] = str_replace(",","",$PHP_top_su);
            $bottom_su[$i] = str_replace(",","",$PHP_bot_su);
            // $qty[$i] = $top[$i] * $pre_su['t'] + $botton[$i] * $pre_su['b'];
            // $qty[$i] = $top_su[$i] + $bottom_su[$i] ;
            $qty[$i] = ( $top[$i] * $top_su[$i] ) + ( $botton[$i] * $bottom_su[$i] );
            $uprc[$i] = str_replace(",","",$PHP_uprc);
            $cm[$i] = str_replace(",","",$PHP_cm);
            $fcsts[$i] = $qty[$i] * $uprc[$i];
        }
        $tt_top += $top[$i];
        $tt_botton += $botton[$i];
        $tt_top_su += $top_su[$i];
        $tt_bottom_su += $bottom_su[$i];
        $tt_qty += $qty[$i];
        $tt_uprc += $uprc[$i];
        $tt_cm += $cm[$i];
        $tt_fcst += $fcsts[$i];
    }
    $qty[12]	= $tt_qty;
    $top[12]	=	$tt_top;
    $botton[12] = $tt_botton;
    $top_su[12]	=	$tt_top_su;
    $bottom_su[12] = $tt_bottom_su;
    $uprc[12]	=	$tt_uprc;
    $cm[12] = $tt_cm;
    $fcsts[12] = $tt_fcst;
    $fcst['top']		= Array2csv($top);
    $fcst['botton']	= Array2csv($botton);
    $fcst['top_su']		= Array2csv($top_su);
    $fcst['bottom_su']	= Array2csv($bottom_su);
    $fcst['qty']		= Array2csv($qty);
    $fcst['uprc']	= Array2csv($uprc);
    $fcst['cm']		= Array2csv($cm);
    $fcst['fcst']		= Array2csv($fcsts);

    //寫入forecast table
    if (!$result = $forecast->edit($fcst)) {   
        $op['msg']= $forecast->msg->get(2);
        $layout->assign($op);
        $layout->display($TPL_ERROR);  		    
        break;
    }
} else {
    check_authority('057',"add");
    $mm = $PHP_month ;
    $tt_top = $tt_botton = $tt_top_su = $tt_bottom_su = $tt_qty = $tt_fcst = $tt_cm = 0;
    $fcst = array();

    for ($i=1; $i<13; $i++){
        
        $top[$i]        = ($mm <> $i) ? 0 : str_replace(",","",$PHP_top);  //上衣
        $botton[$i]     = ($mm <> $i) ? 0 : str_replace(",","",$PHP_bot);  //下身
        $top_su[$i]     = ($mm <> $i) ? 0 : str_replace(",","",$PHP_top_su);  //上衣
        $bottom_su[$i]	= ($mm <> $i) ? 0 : str_replace(",","",$PHP_bot_su);  //下身
        $uprc[$i]       = ($mm <> $i) ? 0 : str_replace(",","",$PHP_uprc);  //單價
        $cm[$i]         = ($mm <> $i) ? 0 : str_replace(",","",$PHP_cm);   //工繳
        
        // $qty[$i] = ($top[$i] * $pre_su['t']) + ($botton[$i] * $pre_su['b']); //計算數量
        // $qty[$i] = ($top_su[$i]) + ($bottom_su[$i]); //計算數量
        $qty[$i] = ( $top[$i] * $top_su[$i] ) + ( $botton[$i] * $bottom_su[$i]); //計算數量
        $fcst[$i]	= $qty[$i] * $uprc[$i];		//計算收入
    
        $tt_fcst        += $fcst[$i];
        $tt_top         += $top[$i];
        $tt_botton		+= $botton[$i];
        $tt_top_su		+= $top_su[$i];
        $tt_bottom_su	+= $bottom_su[$i];
        $tt_qty         += $qty[$i];
        $tt_cm          += ($cm[$i]*$qty[$i]);
    }

    $top[13]            = $tt_top;
    $botton[13]			= $tt_botton;
    $top_su[13]			= $tt_top_su;
    $bottom_su[13]      = $tt_bottom_su;
    $qty[13]            = $tt_qty;
    $fcst[13]			= $tt_fcst;
    $cm[13]				= $tt_cm;
    $uprc[13]			= ($tt_qty !=0) ? number_format($tt_fcst/$tt_qty, 2, '.', '') : 0;

    $parm['uprc'] 		= Array2csv($uprc);
    $parm['qty'] 		= Array2csv($qty);
    $parm['top'] 		= Array2csv($top);
    $parm['botton'] 	= Array2csv($botton);
    $parm['top_su'] 	= Array2csv($top_su);
    $parm['bottom_su']	= Array2csv($bottom_su);
    $parm['fcst'] 		= Array2csv($fcst);
    $parm['cm'] 		= Array2csv($cm);
    
    //寫入forecast table

    if (!$result = $forecast->add($parm)) {
        $op['msg']= $forecast->msg->get(2);
        $layout->assign($op);
        $layout->display($TPL_ERROR);  		    
        break;
    }
        $mm = $PHP_month - 1;
}

# 記錄使用者動態
$message = "customer: [".$PHP_cust."] in factory:[".$PHP_fty."] forecast of year:[".$PHP_year."]; month :[".$PHP_month."]  done Creating";
if(!empty($fcst)){
    $log->log_add(0,"056E",$message);
}else {
    $log->log_add(0,"056A",$message);
}

$op['msg'][]= $message;
$redir_str = "index2.php?PHP_action=mm_forcast_show&PHP_fty=".$PHP_fty."&PHP_year=".$PHP_year."&PHP_month=".$mm."&PHP_qty=";

redirect_page($redir_str);
break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//			 job 81-2-1    SALES ETP 月報表
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "etp_ord_mm":

		check_authority('056',"view");
		$string = $PHP_year."-".$PHP_month;
		$op['dist'] = array();
	
		if(isset($PHP_mk))
		{
			if($PHP_mk == 1)$where_str = " AND s_order.dept <> '$PHP_fty' AND s_order.dept <> 'J1'";
			if($PHP_mk == 2)$where_str = " AND (s_order.dept = '$PHP_fty' OR s_order.dept = 'J1') AND s_order.line_sex = 'F'";
			if($PHP_mk == 3)$where_str = " AND (s_order.dept = '$PHP_fty' OR s_order.dept = 'J1') AND s_order.line_sex = 'M'";
			if($PHP_mk == 4)$where_str = " AND s_order.line_sex = 'A'";
			
			if($PHP_mk == 1) $op['title_mk'] = '-- by sales';
			if($PHP_mk == 2) $op['title_mk'] = '-- by factory (女裝線)';
			if($PHP_mk == 3) $op['title_mk'] = '-- by factory (男裝線)';
			if($PHP_mk == 4) $op['title_mk'] = '-- 龍安廠';
			
		}else{
			$where_str ='';
		}	
		if($GLOBALS['SCACHE']['ADMIN']['login_id']=='morial')
        {
        echo $where_str;
        //exit;
        }
		if (!$result = $capaci->search_etp_ord($PHP_fty,$string,500,$where_str)) {   
			$op['msg']= $capaci->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['ttl_su'] = 0;
		$op['ttl_qty'] = 0;
		$op['sales_fob'] = 0;
		
	if($result != "none"){
		$op['ord']=$result;
		for ($i = 0; $i < count($result); $i++) {   // $i 為 訂單的總數量			
			$op['ord'][$i]['ord_num'] = $result[$i]['order_num'];			
			$op['ord'][$i]['status'] =get_ord_status($result[$i]['status']);
			$op['ttl_su'] = $op['ttl_su'] + $result[$i]['su'];
			$op['ttl_qty'] = $op['ttl_qty'] + $result[$i]['qty'];
		}
	} else{ //if($result != "none")
		$op['record_NONE'] = "1";
	}
		$op['fty'] = $PHP_fty;
		$op['year'] = $PHP_year;
		$op['month'] = $PHP_month;		

//增加訂單量(Q'TY)分類統計訂單數	    	    
	$dist = array ('1000','1500','3000','5000');
	$s_date = $PHP_year."-".$PHP_month."-01";
	$e_date = $PHP_year."-".$PHP_month."-31";
    
	$where_str = 'AND factory = dept';
	$op['fty_qty']=$report->ord_qty_cut_search($PHP_fty,$s_date,$e_date,$dist,$where_str);  //取出記錄	
	$where_str = 'AND factory <> dept';
	$op['sales_qty']=$report->ord_qty_cut_search($PHP_fty,$s_date,$e_date,$dist,$where_str);  //取出記錄
    print_r($op);	
    exit;
	$op['fty_qty_ttl'] = $op['sales_qty_ttl'] = $op['ord_qty_ttl'] = 0;
	for($i=0; $i<sizeof($op['fty_qty']); $i++)
	{
		$op['ord_qty'][$i] = $op['fty_qty'][$i] + $op['sales_qty'][$i];
		$op['fty_qty_ttl'] += $op['fty_qty'][$i];
		$op['sales_qty_ttl'] += $op['sales_qty'][$i];
		$op['ord_qty_ttl']	+= $op['ord_qty'][$i];
	}
	
	for($i=0; $i<sizeof($op['fty_qty']); $i++)
	{
		$op['ord_qty_prc'][$i] =( $op['ord_qty'][$i] / $op['ord_qty_ttl'])*100;
	}	

	$op['dist'] = array('~ 1000', '1000 ~ 1500', '1500 ~ 3000', '3000 ~ 5000', '5000 ~');
	    	    
	    	    
	    	    
	    	    
	page_display($op,'056', $TPL_ETP_ORD);
	break;
		
	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//			 job 81-2-1    SALES ETP 月報表
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "etp_unapv_ord_mm":

		check_authority('056',"view");
		$string = $PHP_year."-".$PHP_month;
		$op['dist'] = array();
	
		if(isset($PHP_mk))
		{
			if($PHP_mk == 1)$where_str = " AND s_order.dept <> '$PHP_fty' AND s_order.dept <> 'J1'";
			if($PHP_mk == 2)$where_str = " AND (s_order.dept = '$PHP_fty' OR s_order.dept = 'J1') AND s_order.line_sex = 'F'";
			if($PHP_mk == 3)$where_str = " AND (s_order.dept = '$PHP_fty' OR s_order.dept = 'J1') AND s_order.line_sex = 'M'";
			if($PHP_mk == 4)$where_str = " AND s_order.line_sex = 'A'";
			if($PHP_mk == 1) $op['title_mk'] = '-- by sales';
			if($PHP_mk == 2) $op['title_mk'] = '-- by factory (女裝線)';
			if($PHP_mk == 3) $op['title_mk'] = '-- by factory (男裝線)';
			if($PHP_mk == 4) $op['title_mk'] = '-- 龍安廠';

		}else{
			$where_str ='';
		}	
		
		if (!$result = $capaci->search_unapv_etp_ord($PHP_fty,$string,500,$where_str)) {   
			$op['msg']= $capaci->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['ttl_su'] = 0;
		$op['ttl_qty'] = 0;
		
	if($result != "none"){
		$op['ord']=$result;
		for ($i = 0; $i < count($result); $i++) {   // $i 為 訂單的總數量			
			$op['ord'][$i]['ord_num'] = $result[$i]['order_num'];			
			$op['ord'][$i]['status'] = get_ord_status($result[$i]['status']);
			$op['ttl_su'] = $op['ttl_su'] + $result[$i]['su'];
			$op['ttl_qty'] = $op['ttl_qty'] + $result[$i]['qty'];
			$op['ord'][$i]['amt'] = $result[$i]['fob'] * $result[$i]['qty'];
            $op['ttl_amt'] = $op['ttl_amt'] + $op['ord'][$i]['amt'];
		}
	} else{ //if($result != "none")
		$op['record_NONE'] = "1";
	}
		$op['fty'] = $PHP_fty;
		$op['year'] = $PHP_year;
		$op['month'] = $PHP_month;		
	    	    
	page_display($op,'056', $TPL_ETP_UNAPV_ORD);
	break;
	

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//			 job 82-2-1    SALES ETP 月報表
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "etp_shp_mm":

	check_authority('056',"view");
		$string = $PHP_year."-".$PHP_month;
		$op['dist'] = array();
		
		if (!$result = $capaci->search_etp_sch($PHP_fty,$string,500)) {   
			$op['msg']= $capaci->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['ttl_su'] = 0;
		$op['ttl_qty'] = 0;
		$op['sales_fob'] = 0;

	if($result != "none"){
		$op['ord']=$result;
		for ($i = 0; $i < count($result); $i++) {   // $i 為 訂單的總數量	
			$op['ord'][$i]['ord_num'] = $result[$i]['order_num'];
					
			$op['ord'][$i]['status'] =get_ord_status($result[$i]['status']);
			$op['ttl_su'] = $op['ttl_su'] + $result[$i]['su'];
			$op['ttl_qty'] = $op['ttl_qty'] + $result[$i]['qty'];
		}
	} else{ //if($result != "none")
		$op['record_NONE'] = "1";
	}
		$op['fty'] = $PHP_fty;
		$op['year'] = $PHP_year;
		$op['month'] = $PHP_month;		

	page_display($op,'056', $TPL_ETP_SCH);       
	
	break;
	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//			 job 82-2-1    SALES ETP 月報表
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "etp_unshp_mm":
	check_authority('056',"view");
		$string = $PHP_year."-".$PHP_month;
		$op['dist'] = array();
		
		if (!$result = $capaci->search_etp_unsch($PHP_fty,$string,500)) {   
			$op['msg']= $capaci->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['ttl_su'] = 0;
		$op['ttl_qty'] = 0;
		$op['sales_fob'] = 0;

	if($result != "none"){
		$op['ord']=$result;
		for ($i = 0; $i < count($result); $i++) {   // $i 為 訂單的總數量
			$op['ord'][$i]['ord_num'] = $result[$i]['order_num'];				
			$op['ord'][$i]['status'] =get_ord_status($result[$i]['status']);
			$op['ttl_su'] = $op['ttl_su'] + $result[$i]['su'];
			$op['ttl_qty'] = $op['ttl_qty'] + $result[$i]['qty'];
		}
	} else{ //if($result != "none")
		$op['record_NONE'] = "1";
	}
		$op['fty'] = $PHP_fty;
		$op['year'] = $PHP_year;
		$op['month'] = $PHP_month;		

		$op['un_sch'] = 1;
		    	    
	page_display($op,'056', $TPL_ETP_UNSHP); 
	break;




#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//		 job 81-4-1    SHIPPed 
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "etp_out_mm":

	check_authority('056',"view");
		$string = $PHP_year.'-'.$PHP_month;
		$op['shp'] = array();
		
		if(isset($PHP_mk))
		{
			if($PHP_mk == 1)$where_str = " AND s_order.dept <> '$PHP_fty' AND s_order.dept <> 'J1'";
			if($PHP_mk == 2)$where_str = " AND (s_order.dept = '$PHP_fty' OR s_order.dept = 'J1') AND s_order.line_sex = 'F'";
			if($PHP_mk == 3)$where_str = " AND (s_order.dept = '$PHP_fty' OR s_order.dept = 'J1') AND s_order.line_sex = 'M'";
			if($PHP_mk == 4)$where_str = " AND  s_order.line_sex = 'A'";

			if($PHP_mk == 1) $op['title_mk'] = '-- by sales';
			if($PHP_mk == 2) $op['title_mk'] = '-- by factory (女裝線)';
			if($PHP_mk == 3) $op['title_mk'] = '-- by factory (男裝線)';
			if($PHP_mk == 4) $op['title_mk'] = '-- 龍安廠';

		}else{
			$where_str ='';
		}
		if(isset($PHP_subout)) $where_str=$where_str." AND pdt_saw_line.sc = '1'"; //外代工
		if(isset($PHP_subout)) $op['sub_title_mk'] = '[sub-con.]';
		if (!$result = $capaci->get_etp_out($PHP_fty,$PHP_year,$PHP_month,$where_str)) {   
			$op['msg']= $capaci->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['ttl_out_su'] = $op['ttl_out_qty'] = $op['sales_fob'] = $op['ttl_ord_qty'] = 0;
		$j=0;
		
	if($result != "none"){

		for ($i = 0; $i < count($result); $i++) {   // $i 為出口記錄 筆數
			$op['out'][$i] = $result[$i];
			$su=0;
			$op['out'][$i]['ord_num']=$result[$i]['order_num'];
			$op['out'][$i]['s_qty']=$result[$i]['qty_done'];
			$op['out'][$i]['sort'] = $result[$i]['status'];	
			$op['ttl_out_qty'] = $op['ttl_out_qty'] + $result[$i]['qty_done'];
			$op['ttl_out_su'] = $op['ttl_out_su'] + $result[$i]['su'];
			$op['ttl_ord_qty'] = $op['ttl_ord_qty'] + $result[$i]['qty'];	
			$op['out'][$i]['status'] =get_ord_status($result[$i]['status']);	
		}
		$op['out'] = bubble_sort($op['out']);
		$s_su = $s_qty = $s_ord_qty = 0; $ship_mk  = 0;
		for ($i = 0; $i < count($op['out']); $i++) { // $i 為 訂單的總數量			
			if($ship_mk == 0 && $op['out'][$i]['sort'] < 12)
			{
				$j = $i-1;
				$op['out'][$j]['sub_out_su'] = $s_su;
				$op['out'][$j]['sub_out_qty'] = $s_qty;
				$op['out'][$j]['sub_ord_qty'] = $s_ord_qty;
				$op['out'][$j]['sub_mk'] = 1;
				$ship_mk = 1;
				$s_su = $s_qty = $s_ord_qty = 0;
			}
			$s_su += $op['out'][$i]['su'];
			$s_qty += $op['out'][$i]['qty_done'];
			$s_ord_qty += $op['out'][$i]['qty'];
		}		
		$j = $i-1;
		$op['out'][$j]['sub_out_su'] = $s_su;
		$op['out'][$j]['sub_out_qty'] = $s_qty;
		$op['out'][$j]['sub_ord_qty'] = $s_ord_qty;
		$op['out'][$j]['sub_mk'] = 1;		
	} else{ //if($result != "none")
		$op['record_NONE'] = "1";
	}
		$op['fty'] = $PHP_fty;
		$op['year'] = $PHP_year;
		$op['mon'] = $PHP_month;
	    	    
	page_display($op,'056', $TPL_ETP_MON_OUT);
	break;	

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//		 job 81-4-1    SHIPPed 
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "etp_unout_mm":

	check_authority('056',"view");
		$string = $PHP_year.'-'.$PHP_month;
		$op['shp'] = array();
		if(isset($PHP_mk))
		{
			if($PHP_mk == 1)$where_str = " AND s_order.dept <> '$PHP_fty' AND s_order.dept <> 'J1'";
			if($PHP_mk == 2)$where_str = " AND (s_order.dept = '$PHP_fty' OR s_order.dept = 'J1') AND s_order.line_sex = 'F'";
			if($PHP_mk == 3)$where_str = " AND (s_order.dept = '$PHP_fty' OR s_order.dept = 'J1') AND s_order.line_sex = 'M'";
			if($PHP_mk == 4)$where_str = " AND s_order.line_sex = 'A'";
			
			if($PHP_mk == 1) $op['title_mk'] = '-- by sales';
			if($PHP_mk == 2) $op['title_mk'] = '-- by factory (女裝線)';
			if($PHP_mk == 3) $op['title_mk'] = '-- by factory (男裝線)';
			if($PHP_mk == 4) $op['title_mk'] = '-- 龍安廠';

		}else{
			$where_str ='';
		}
		if (!$result = $capaci->search_etp_unout($PHP_fty,$string,500,$where_str)) {   
			$op['msg']= $shipping->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
        // print_r($result);
		$op['ttl_out_su'] = $op['ttl_out_qty'] = $op['sales_fob'] = $op['ttl_ord_qty'] = 0;
		$op['ttl_ord_su'] = $op['ttl_rem_su']=0;
		$op['ci_out_su'] = $op['ci_out_qty'] =  $op['ci_ord_qty'] = $op['ci_ord_su'] = $op['ci_rem_su']=0;
		$op['cc_out_su'] = $op['cc_out_qty'] =  $op['cc_ord_qty'] = $op['cc_ord_su'] = $op['cc_rem_su']=0;

		$op['ui_out_su'] = $op['ui_out_qty'] =  $op['ui_ord_qty'] = $op['ui_ord_su'] = $op['ui_rem_su']=0;
		$op['uc_out_su'] = $op['uc_out_qty'] =  $op['uc_ord_qty'] = $op['uc_ord_su'] = $op['uc_rem_su']=0;

		$j=0;$k=0;$x=0;$y=0;
		
	if($result != "none"){

		for ($i = 0; $i < count($result); $i++) {   // $i 為出口記錄 筆數
			
	    	$tmp_su=0;

	    $tmp_su = $result[$i]['out_su'];
	    
	    $su = $result[$i]['su']- $tmp_su;
			$qty = $result[$i]['qty']- $result[$i]['qty_done'];
			
			if($su > 0 && $result[$i]['status'] < 10)
			{
				if((!$result[$i]['mat_shp'] || $result[$i]['mat_shp'] == '0000-00-00' ||!$result[$i]['m_acc_shp'] || $result[$i]['m_acc_shp'] == '0000-00-00' ||$result[$i]['smpl_apv'] == '0000-00-00') && $result[$i]['status'] < 8)
				{
					if($result[$i]['sub_con'] == 0)
					{
						$op['uout_i'][$k] = $result[$i];				
						$op['uout_i'][$k]['rem_su']=$su;
						$op['uout_i'][$k]['out_su']=$tmp_su;
						$op['uout_i'][$k]['ord_num']=$result[$i]['order_num'];
						$op['uout_i'][$k]['s_qty']=$qty;
				
						$op['ui_out_qty'] = $op['ui_out_qty'] + $qty;
						$op['ui_out_su'] = $op['ui_out_su'] + $tmp_su;
						$op['ui_rem_su'] = $op['ui_rem_su'] + $su;
						$op['ui_ord_su'] = $op['ui_ord_su'] + $result[$i]['su'];
						$op['ui_ord_qty'] = $op['ui_ord_qty'] + $result[$i]['qty'];
						$op['uout_i'][$k]['status'] =get_ord_status($result[$i]['status']);						
						$k++;
					}else{
						$op['uout_c'][$x] = $result[$i];				
						$op['uout_c'][$x]['rem_su']=$su;
						$op['uout_c'][$x]['out_su']=$tmp_su;
						$op['uout_c'][$x]['ord_num']=$result[$i]['order_num'];
						$op['uout_c'][$x]['s_qty']=$qty;
				
						$op['uc_out_qty'] = $op['uc_out_qty'] + $qty;
						$op['uc_out_su'] = $op['uc_out_su'] + $tmp_su;
						$op['uc_rem_su'] = $op['uc_rem_su'] + $su;
						$op['uc_ord_su'] = $op['uc_ord_su'] + $result[$i]['su'];
						$op['uc_ord_qty'] = $op['uc_ord_qty'] + $result[$i]['qty'];
						$op['uout_c'][$x]['status'] =get_ord_status($result[$i]['status']);						
						$x++;
						
					}
				}else{
					if($result[$i]['sub_con'] == 0)
					{
						$op['out_i'][$j] = $result[$i];				
						$op['out_i'][$j]['rem_su']=$su;
						$op['out_i'][$j]['out_su']=$tmp_su;
						$op['out_i'][$j]['ord_num']=$result[$i]['order_num'];
						$op['out_i'][$j]['s_qty']=$qty;
				
						$op['ci_out_qty'] = $op['ci_out_qty'] + $qty;
						$op['ci_out_su'] = $op['ci_out_su'] + $tmp_su;
						$op['ci_rem_su'] = $op['ci_rem_su'] + $su;
						$op['ci_ord_su'] = $op['ci_ord_su'] + $result[$i]['su'];
						$op['ci_ord_qty'] = $op['ci_ord_qty'] + $result[$i]['qty'];
						$op['out_i'][$j]['status'] =get_ord_status($result[$i]['status']);						
						$j++;
					}else{
						$op['out_c'][$y] = $result[$i];				
						$op['out_c'][$y]['rem_su']=$su;
						$op['out_c'][$y]['out_su']=$tmp_su;
						$op['out_c'][$y]['ord_num']=$result[$i]['order_num'];
						$op['out_c'][$y]['s_qty']=$qty;
				
						$op['cc_out_qty'] = $op['cc_out_qty'] + $qty;
						$op['cc_out_su'] = $op['cc_out_su'] + $tmp_su;
						$op['cc_rem_su'] = $op['cc_rem_su'] + $su;
						$op['cc_ord_su'] = $op['cc_ord_su'] + $result[$i]['su'];
						$op['cc_ord_qty'] = $op['cc_ord_qty'] + $result[$i]['qty'];
						$op['out_c'][$y]['status'] =get_ord_status($result[$i]['status']);						
						$y++;
					
					}
				}				
				
			}
			
		
		}
		$op['ttl_out_su'] = $op['ci_out_su']+$op['cc_out_su']+$op['ui_out_su']+$op['uc_out_su'];
		$op['ttl_out_qty'] = $op['ci_out_qty']+$op['cc_out_qty']+$op['ui_out_qty']+$op['uc_out_qty'];
		$op['ttl_ord_qty'] = $op['ci_ord_qty']+$op['cc_ord_qty']+$op['ui_ord_qty']+$op['uc_ord_qty'];
		$op['ttl_ord_su'] = $op['ci_ord_su']+$op['cc_ord_su']+$op['ui_ord_su']+$op['uc_ord_su'];
		$op['ttl_rem_su']=$op['ci_rem_su']+$op['cc_rem_su']+$op['ui_rem_su']+$op['uc_rem_su'];

		$op['s_out_su'] = $op['ci_out_su']+$op['cc_out_su'];
		$op['s_out_qty'] = $op['ci_out_qty']+$op['cc_out_qty'];
		$op['s_ord_qty'] = $op['ci_ord_qty']+$op['cc_ord_qty'];
		$op['s_ord_su'] = $op['ci_ord_su']+$op['cc_ord_su'];
		$op['s_rem_su']=$op['ci_rem_su']+$op['cc_rem_su'];

		$op['us_out_su'] = $op['ui_out_su']+$op['uc_out_su'];
		$op['us_out_qty'] = $op['ui_out_qty']+$op['uc_out_qty'];
		$op['us_ord_qty'] = $op['ui_ord_qty']+$op['uc_ord_qty'];
		$op['us_ord_su'] = $op['ui_ord_su']+$op['uc_ord_su'];
		$op['us_rem_su']=$op['ui_rem_su']+$op['uc_rem_su'];

	} else{ //if($result != "none")
		$op['record_NONE'] = "1";
	}

		if ($j == 0 && $k == 0 && $x==0 && $y==0)$op['record_NONE'] = "1";
		$op['fty'] = $PHP_fty;
		$op['year'] = $PHP_year;
		$op['mon'] = $PHP_month;
		$op['un_shp']=1;
	    	    
	page_display($op,'056', $TPL_ETP_MON_UNOUT);
	break;			

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
// job 81-4-1    SHIPPed 
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "etp_shp_out":
check_authority('056',"view");

$string = $PHP_year.'-'.$PHP_month;
$op['shp'] = array();
if(isset($PHP_mk))
{
    if($PHP_mk == 1)$where_str = " AND s_order.dept <> '$PHP_fty' AND s_order.dept <> 'J1'";
    if($PHP_mk == 2)$where_str = " AND (s_order.dept = '$PHP_fty' OR s_order.dept = 'J1') AND s_order.line_sex = 'F'";
    if($PHP_mk == 3)$where_str = " AND (s_order.dept = '$PHP_fty' OR s_order.dept = 'J1') AND s_order.line_sex = 'M'";
    if($PHP_mk == 4)$where_str = " AND s_order.line_sex = 'A'";
    if($PHP_mk == 5)$where_str = " AND ( s_order.order_num LIKE 'A%' or s_order.order_num LIKE 'B%' ) ";
    if($PHP_mk == 6)$where_str = " AND s_order.order_num LIKE 'L%' ";
    
    if($PHP_mk == 1) $op['title_mk'] = '-- by sales';
    if($PHP_mk == 2) $op['title_mk'] = '-- by factory (女裝線)';
    if($PHP_mk == 3) $op['title_mk'] = '-- by factory (男裝線)';
    if($PHP_mk == 4) $op['title_mk'] = '-- 龍安廠';
    if($PHP_mk == 5) $op['title_mk'] = '-- By 台北訂單';
    if($PHP_mk == 6) $op['title_mk'] = '-- By 工廠自接訂單';
    
}else{
    $where_str ='';
}
if (!$result = $capaci->sum_etp_out($PHP_fty,$PHP_year,$PHP_month,$where_str)) {   
    $op['msg']= $shipping->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}
$op['ttl_amt']=$op['ttl_shp_su'] = $op['ttl_shp_qty'] = $op['sales_fob'] = $op['ttl_odr_qty'] = 0;
$j=0;

if($result != "none"){

    for ($i = 0; $i < count($result); $i++) {   // $i 為出口記錄 筆數
        if($result[$i]['qty_shp'] > 0)
        {
            $op['shp'][$j] = $result[$i];
//				$su = (int)($result[$i]['qty_shp'] * $result[$i]['ie1']);
            $op['shp'][$j]['su']=$result[$i]['shp_su'];
            $op['shp'][$j]['ord_num']=$result[$i]['order_num'];
            $op['shp'][$j]['k_date']=$result[$i]['shp_date'];
            $op['shp'][$j]['s_qty']=$result[$i]['qty_shp'];
            
            $op['ttl_shp_qty'] = $op['ttl_shp_qty'] + $result[$i]['qty_shp'];
            $op['ttl_shp_su'] = $op['ttl_shp_su'] + $result[$i]['shp_su'];
            $op['ttl_odr_qty'] = $op['ttl_odr_qty'] + $result[$i]['qty'];
            $op['sales_fob'] = $op['sales_fob'] + $result[$i]['qty_shp']* $result[$i]['uprice'];
            $op['shp'][$j]['amt'] = $result[$i]['qty_shp']* $result[$i]['uprice'];
            $op['ttl_amt'] += $op['shp'][$j]['amt'];
            $j++;
        }
        
    
    }
    
    $op['pc_avg'] = number_format($op['sales_fob']/$op['ttl_shp_qty'],2);

} else{ //if($result != "none")
    $op['record_NONE'] = "1";
}
$op['fty'] = $PHP_fty;
$op['year'] = $PHP_year;
$op['mon'] = $PHP_month;

page_display($op,'056', $TPL_ETP_MON_SHP);
break;	

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
// job 81-4-1    SHIPPed 
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "etd_shp_out":
check_authority('056',"view");

$string = $PHP_year.'-'.$PHP_month;
$op['shp'] = array();
if(isset($PHP_mk))
{
    if($PHP_mk == 1)$where_str = " AND s_order.dept <> '$PHP_fty' AND s_order.dept <> 'J1'";
    if($PHP_mk == 2)$where_str = " AND (s_order.dept = '$PHP_fty' OR s_order.dept = 'J1') AND s_order.line_sex = 'F'";
    if($PHP_mk == 3)$where_str = " AND (s_order.dept = '$PHP_fty' OR s_order.dept = 'J1') AND s_order.line_sex = 'M'";
    if($PHP_mk == 4)$where_str = " AND s_order.line_sex = 'A'";
    if($PHP_mk == 5)$where_str = " AND ( s_order.order_num LIKE 'A%' or s_order.order_num LIKE 'B%' or s_order.order_num LIKE 'D%' ) ";
    if($PHP_mk == 6)$where_str = " AND s_order.order_num LIKE 'L%' ";
    
    if($PHP_mk == 1) $op['title_mk'] = '-- by sales';
    if($PHP_mk == 2) $op['title_mk'] = '-- by factory (女裝線)';
    if($PHP_mk == 3) $op['title_mk'] = '-- by factory (男裝線)';
    if($PHP_mk == 4) $op['title_mk'] = '-- 龍安廠';
    if($PHP_mk == 5) $op['title_mk'] = '-- By 台北訂單';
    if($PHP_mk == 6) $op['title_mk'] = '-- By 工廠自接訂單';
    
}else{
    $where_str ='';
}
if (!$result = $capaci->sum_shp_out($PHP_fty,$PHP_year,$PHP_month,$where_str)) {   
    $op['msg']= $shipping->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}
$op['ttl_amt']=$op['ttl_shp_su'] = $op['ttl_shp_qty'] = $op['sales_fob'] = $op['ttl_odr_qty'] = 0;
$j=0;

if($result != "none"){

    for ($i = 0; $i < count($result); $i++) {   // $i 為出口記錄 筆數
        if($result[$i]['qty_shp'] > 0)
        {
            $op['shp'][$j] = $result[$i];
//				$su = (int)($result[$i]['qty_shp'] * $result[$i]['ie1']);
            $op['shp'][$j]['su']=$result[$i]['shp_su'];
            $op['shp'][$j]['ord_num']=$result[$i]['order_num'];
            $op['shp'][$j]['k_date']=$result[$i]['shp_date'];
            $op['shp'][$j]['s_qty']=$result[$i]['qty_shp'];
            
            $op['ttl_shp_qty'] = $op['ttl_shp_qty'] + $result[$i]['qty_shp'];
            $op['ttl_shp_su'] = $op['ttl_shp_su'] + $result[$i]['shp_su'];
            $op['ttl_odr_qty'] = $op['ttl_odr_qty'] + $result[$i]['qty'];
            $op['sales_fob'] = $op['sales_fob'] + $result[$i]['qty_shp']* $result[$i]['uprice'];
            $op['shp'][$j]['amt'] = $result[$i]['qty_shp']* $result[$i]['uprice'];
            $op['shp'][$j]['amt'] = $result[$i]['amt'];
            $op['ttl_amt'] += $op['shp'][$j]['amt'];
            $j++;
        }
        
    
    }
    
    $op['pc_avg'] = number_format($op['sales_fob']/$op['ttl_shp_qty'],2);

} else{ //if($result != "none")
    $op['record_NONE'] = "1";
}
$op['fty'] = $PHP_fty;
$op['year'] = $PHP_year;
$op['mon'] = $PHP_month;

page_display($op,'056', $TPL_ETP_MON_SHP);
break;


	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//		 job 81-4-1    SHIPPed 
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "etp_un_shp_out":

	check_authority('056',"view");
		$string = $PHP_year.'-'.$PHP_month;
		$op['shp'] = array();

		if (!$result = $capaci->search_etp_ord($PHP_fty,$string,500)) {   
			$op['msg']= $shipping->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['ttl_shp_su'] = $op['ttl_shp_qty'] = $op['sales_fob'] = $op['ttl_ord_qty'] = 0;
		$op['ttl_rem_su'] = $op['ttl_ord_su'] =$op['ttl_fsh_su']=0;
		$j=0;

	if($result != "none"){

		for ($i = 0; $i < count($result); $i++) {   // $i 為出口記錄 筆數
			
			$tmp_shp = (int)($result[$i]['qty_shp'] * $result[$i]['ie1']);
			$qty = $result[$i]['qty']-$result[$i]['qty_shp'];
			$su=$result[$i]['su']-$tmp_shp;
			
			if($qty > 0)
			{				
				$op['shp'][$j] = $result[$i];				
				$op['shp'][$j]['rem_su']=$su;
				$op['shp'][$j]['ord_num']=$result[$i]['order_num'];
				$op['shp'][$j]['s_qty']=$qty;
				$op['shp'][$j]['fsh_su']=(int)($result[$i]['qty_done'] * $result[$i]['ie1']);
				$op['shp'][$j]['shp_su']=$tmp_shp;
				
				$op['ttl_shp_qty'] = $op['ttl_shp_qty'] + $qty;
				$op['ttl_shp_su'] = $op['ttl_shp_su'] + $tmp_shp;
				$op['ttl_rem_su'] = $op['ttl_rem_su'] + $su;
				$op['ttl_fsh_su'] = $op['ttl_fsh_su'] + $op['shp'][$j]['fsh_su'];
				$op['ttl_ord_su'] = $op['ttl_ord_su'] + $op['shp'][$j]['su'];
				
				$op['ttl_ord_qty'] = $op['ttl_ord_qty'] + $result[$i]['qty'];
				$op['sales_fob'] = $op['sales_fob'] + $qty* $result[$i]['uprice'];
				$op['shp'][$j]['amt'] = $qty* $result[$i]['uprice'];
				
				$op['shp'][$j]['status'] =get_ord_status($result[$i]['status']);				
				$j++;
			}
			
		
		}
		
		$op['pc_avg'] = number_format($op['sales_fob']/$op['ttl_shp_qty'],2);

	} else{ //if($result != "none")
		$op['record_NONE'] = "1";
	}
		if ($j == 0)$op['record_NONE'] = "1";
		$op['fty'] = $PHP_fty;
		$op['year'] = $PHP_year;
		$op['mon'] = $PHP_month;
		$op['un_shp']=1;		    	    
	page_display($op,'056', $TPL_ETP_MON_UNSHP);
	break;		
	
	
	
	
	
//-------------------------------------------------------------------------------------
//			 job 81  生產產能
//	
//-------------------------------------------------------------------------------------
    case "capacity_search":
		check_authority('055',"view");
				// creat cust combo box
		$op['factory'] = $arry2->select($FACTORY,'','PHP_fty','select','');  	
		$op['year_1'] = $arry2->select($YEAR_WORK,'','PHP_year1','select','');  	
		$op['year_2'] = $arry2->select($YEAR_WORK,'','PHP_year2','select','');  	
		$op['year_3'] = $arry2->select($YEAR_WORK,'','PHP_year3','select','');  

		$op['msg'] = $order->msg->get(2);

//080725message增加		
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];
	
			page_display($op, '055', $TPL_CAPACITY_SEARCH);    	    
		break;

//-------------------------------------------------------------------------------------
    case "do_capacity_search":
		check_authority('055',"view");

		$op['msg'] ='';

		$op['fty'] = $PHP_fty;
		$op['year1'] = $PHP_year1;
		$op['year2'] = $PHP_year2;
		$op['year3'] = $PHP_year3;
		
		// 判斷當輸入 年份相同時 ------------
		if(($op['year1']) == ($op['year2'])){ $op['year2'] =''; }
		if(($op['year1']) == ($op['year3'])){ $op['year3'] =''; }
		if(($op['year2']) == ($op['year3'])){ $op['year3'] =''; }
		
		if (!$op['fty']){
			$op['msg'][] = "Error ! you have to select target Factory !";
		}

		if(!$op['year1']){ 
			$op['year1'] = $GLOBALS['THIS_YEAR'];
			$PHP_year1 = $GLOBALS['THIS_YEAR'];
		
		}  // 當沒輸入年份時預設為今年

		if ($op['msg']){	
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		//設定graphic (chart)
		require_once ($config['root_dir']."/lib/class.graphic.php");
		$PG = new PowerGraphic;
			$PG->axis_x    = 'Month';
			$PG->axis_y    = 'S.U.';
			$PG->graphic_1 = 'capacity';
			$PG->graphic_2 = 'order';
			$PG->graphic_3 = 'schedule';
			$PG->graphic_4 = 'output';
			$PG->skin      = 1;
			$PG->type      = 1;
			$PG->credits   = 0;
			$mm=array('JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC');
			$mm_2=array('01','02','03','04','05','06','07','08','09','10','11','12','13');

			for ($i=0; $i< 12; $i++)	$PG->x[$i] = $mm[$i];

		// 輸入check 結束  開始search
		$ary1=array('c1','p1','s1','a1','h1','f1');
		$ary2=array('capacity','pre_schedule','schedule','actual','shipping','shp_fob');
//------------------------------------------  1 st year ----------------------
			if($PHP_year1){
				
			  //搜尋forcast
			  $where_str = " WHERE method='forecast' AND fty='".$PHP_fty."' AND year='".$PHP_year1."' ";
			  $m_cast = $forecast->search(0,$where_str);
			  for ($i=0; $i<13; $i++) $op['fcst1'][$mm_2[$i]]=0;
				for ($i=0; $i<sizeof($m_cast['fcst']); $i++){
					$m_cast['fcst'][$i]['f'] = csv2array($m_cast['fcst'][$i]['qty']);			
			//加總全部的客戶預算---
					for ($j=0; $j<13; $j++){
						$op['fcst1'][$mm_2[$j]] = $op['fcst1'][$mm_2[$j]] + $m_cast['fcst'][$i]['f'][$j];
					}
				}				
				
			   if(!$op['u1'] = $capaci->get_unord($PHP_fty, $PHP_year1)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
				if(!$op['so1'] = $capaci->get_subcon($PHP_fty, $PHP_year1)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}		
				if(!$op['cm1'] = $capaci->get_cm($PHP_fty, $PHP_year1,$FTY_CM[$PHP_fty])){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
				// echo "<br>";
			   for ($i=0; $i<sizeof($ary1); $i++)
			   {
			   		if(!$$ary1[$i] = $capaci->get($PHP_fty, $PHP_year1,$ary2[$i])){
						$op['msg']= $capaci->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
					}
			   }	

				// 設定 html 的 format
				$sumc = $sump = $sums = $suma = $sumh = $sumf= 0;
				for ($j=1;$j<13;$j++){
						$sumc = $sumc + $c1[$j+3];
					$op['c1'][$j] = $PG->y[$j-1] = $c1[$j+3];  // 取出陣列內的項數
						$sump = $sump + $p1[$j+3];
					$op['p1'][$j] = $PG->z[$j-1] = $p1[$j+3];  // 取出陣列內的項數
						$sums = $sums + $s1[$j+3];
					$op['s1'][$j] = $PG->a[$j-1] = $s1[$j+3];  // 取出陣列內的項數
						$suma = $suma + $a1[$j+3];
					$op['a1'][$j] = $PG->b[$j-1] = $a1[$j+3];  // 取出陣列內的項數
						$sumh = $sumh + $h1[$j+3];
					$op['h1'][$j] = $h1[$j+3];  // 取出陣列內的項數
						$sumf = $sumf + $f1[$j+3];
					$op['f1'][$j] = $f1[$j+3];  // 取出陣列內的項數
				}
				$op['c1']['sum'] = $sumc;
				$op['p1']['sum'] = $sump;
				$op['s1']['sum'] = $sums;
				$op['a1']['sum'] = $suma;
				$op['h1']['sum'] = $sumh;
				$op['f1']['sum'] = $sumf;
// print_r($op['a1']);
		//設定bar chart的參數
		$PG->title     = $PHP_fty." -".$PHP_year1;
		$op['chart_1'] = "class.graphic.php?" . $PG->create_query_string();
		for ($i=0; $i< 12; $i++) 
		{
			$op['sumy1'][$i] = $op['p1'][($i+1)] + $op['u1'][$mm_2[$i]]+$op['fcst1'][$mm_2[$i]];
		}
		$op['sumy1'][$i] = $op['p1']['sum'] + $op['u1']['13']+$op['fcst1']['13'];
			}   // end if ($PHP_year1)

//------------------------------------------ 2 nd year ----------------------
			if($PHP_year2){

			  //搜尋forcast
			  $where_str = " WHERE method='forecast' AND fty='".$PHP_fty."' AND year='".$PHP_year2."' ";
			  $m_cast = $forecast->search(0,$where_str);
			  for ($i=0; $i<13; $i++) $op['fcst2'][$mm_2[$i]]=0;
				for ($i=0; $i<sizeof($m_cast['fcst']); $i++){
					$m_cast['fcst'][$i]['f'] = csv2array($m_cast['fcst'][$i]['qty']);			
			//加總全部的客戶預算---
					for ($j=0; $j<13; $j++){
						$op['fcst2'][$mm_2[$j]] = $op['fcst2'][$mm_2[$j]] + $m_cast['fcst'][$i]['f'][$j];
					}
				}				


			$ary1=array('c2','p2','s2','a2','h2','f2');
			   if(!$op['u2'] = $capaci->get_unord($PHP_fty, $PHP_year2)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
				if(!$op['so2'] = $capaci->get_subcon($PHP_fty, $PHP_year2)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
				if(!$op['cm2'] = $capaci->get_cm($PHP_fty, $PHP_year2,$FTY_CM[$PHP_fty])){
			 		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
			   for ($i=0; $i<sizeof($ary1); $i++)
			   {
			   		if(!$$ary1[$i] = $capaci->get($PHP_fty, $PHP_year2,$ary2[$i])){
						$op['msg']= $capaci->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
					}
			   }				  
				// 設定 html 的 format
				$sumc = $sump = $sums = $suma = $sumh = $sumf = 0;
				for ($j=1;$j<13;$j++){
					$sumc = $sumc + $c2[$j+3];
					$op['c2'][$j] = $PG->y[$j-1] = $c2[$j+3];  // 取出陣列內的項數
					$sump = $sump + $p2[$j+3];
					$op['p2'][$j] = $PG->z[$j-1] = $p2[$j+3];  // 取出陣列內的項數
					$sums = $sums + $s2[$j+3];
					$op['s2'][$j] = $PG->a[$j-1] = $s2[$j+3];  // 取出陣列內的項數
					$suma = $suma + $a2[$j+3];
					$op['a2'][$j] = $PG->b[$j-1] = $a2[$j+3];  // 取出陣列內的項數
					$sumh = $sumh + $h2[$j+3];
					$op['h2'][$j] = $h2[$j+3];  // 取出陣列內的項數
					$sumf = $sumf + $f2[$j+3];
					$op['f2'][$j] = $f2[$j+3];  // 取出陣列內的項數
				}
				$op['c2']['sum'] = $sumc;
				$op['p2']['sum'] = $sump;
				$op['s2']['sum'] = $sums;
				$op['a2']['sum'] = $suma;
				$op['h2']['sum'] = $sumh;
				$op['f2']['sum'] = $sumf;

		//設定bar chart的參數
		$PG->title     = $PHP_fty." -".$PHP_year2;
		$op['chart_2'] = "class.graphic.php?" . $PG->create_query_string();
		for ($i=0; $i< 12; $i++) 
		{
			$op['sumy2'][$i] = $op['p2'][($i+1)] + $op['u2'][$mm_2[$i]]+$op['fcst2'][$mm_2[$i]];
		}
		$op['sumy2'][$i] = $op['p2']['sum'] + $op['u2']['13']+$op['fcst2']['13'];
			}   // end if ($PHP_year2)

//------------------------------------------  3 rd year ----------------------
			if($PHP_year3){

			  //搜尋forcast
			  $where_str = " WHERE method='forecast' AND fty='".$PHP_fty."' AND year='".$PHP_year3."' ";
			  $m_cast = $forecast->search(0,$where_str);
			  for ($i=0; $i<13; $i++) $op['fcst3'][$mm_2[$i]]=0;
				for ($i=0; $i<sizeof($m_cast['fcst']); $i++){
					$m_cast['fcst'][$i]['f'] = csv2array($m_cast['fcst'][$i]['qty']);			
			//加總全部的客戶預算---
					for ($j=0; $j<13; $j++){
						$op['fcst3'][$mm_2[$j]] = $op['fcst3'][$mm_2[$j]] + $m_cast['fcst'][$i]['f'][$j];
					}
				}				


			   if(!$op['u3'] = $capaci->get_unord($PHP_fty, $PHP_year3)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
				if(!$op['so3'] = $capaci->get_subcon($PHP_fty, $PHP_year3)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
				if(!$op['cm3'] = $capaci->get_cm($PHP_fty, $PHP_year3,$FTY_CM[$PHP_fty])){
			 		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
			   if(!$c3 = $capaci->get($PHP_fty, $PHP_year3,'capacity')){
					$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
			   if(!$p3 = $capaci->get($PHP_fty, $PHP_year3,'pre_schedule')){
					$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
			   if(!$s3 = $capaci->get($PHP_fty, $PHP_year3,'schedule')){
					$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
			   if(!$a3 = $capaci->get($PHP_fty, $PHP_year3,'actual')){
					$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
			   if(!$h3 = $capaci->get($PHP_fty, $PHP_year3,'shipping')){
					$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
			   if(!$f3 = $capaci->get($PHP_fty, $PHP_year3,'shp_fob')){  //2006/03/30 adding
					$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
				// 設定 html 的 format
				$sumc = $sump = $sums = $suma = $sumh = 0;
				for ($j=1;$j<13;$j++){
					$sumc = $sumc + $c3[$j+3];
					$op['c3'][$j] = $PG->y[$j-1] = $c3[$j+3];  // 取出陣列內的項數
					$sump = $sump + $p3[$j+3];
					$op['p3'][$j] = $PG->z[$j-1] = $p3[$j+3];  // 取出陣列內的項數
					$sums = $sums + $s3[$j+3];
					$op['s3'][$j] = $PG->a[$j-1] = $s3[$j+3];  // 取出陣列內的項數
					$suma = $suma + $a3[$j+3];
					$op['a3'][$j] = $PG->b[$j-1] = $a3[$j+3];  // 取出陣列內的項數
					$sumh = $sumh + $h3[$j+3];
					$op['h3'][$j] = $h3[$j+3];  // 取出陣列內的項數
					$sumf = $sumf + $f3[$j+3];
					$op['f3'][$j] = $f3[$j+3];  // 取出陣列內的項數
				}
				$op['c3']['sum'] = $sumc;
				$op['p3']['sum'] = $sump;
				$op['s3']['sum'] = $sums;
				$op['a3']['sum'] = $suma;
				$op['h3']['sum'] = $sumh;
				$op['f3']['sum'] = $sumf;

		//設定bar chart的參數
		$PG->title     = $PHP_fty." -".$PHP_year3;
		$op['chart_3'] = "class.graphic.php?" . $PG->create_query_string();
		for ($i=0; $i< 12; $i++) 
		{
			$op['sumy3'][$i] = $op['p3'][($i+1)] + $op['u3'][$mm_2[$i]]+$op['fcst3'][$mm_2[$i]];
		}
		$op['sumy3'][$i] = $op['p3']['sum'] + $op['u3']['13']+$op['fcst3']['13'];
			}   // end if ($PHP_year3)

//---------------------------------------------------
					$op['msg']= $capaci->msg->get(2);
			page_display($op, '055', $TPL_CAPACITY_VIEW);
		break;








//-------------------------------------------------------------------------------------
    case "do_capacity_det":
		check_authority('055',"view");

		$op['msg'] ='';

		$op['fty'] = $PHP_fty;
		$op['year1'] = $PHP_year1;

		if ($op['msg']){	
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$mm=array('JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC');
		$mm_2=array('01','02','03','04','05','06','07','08','09','10','11','12','13');

		// 輸入check 結束  開始search
		$ary1=array('c1','p1','s1','a1','h1','f1');
		$ary2=array('capacity','pre_schedule','schedule','actual','shipping','shp_fob');

		for ($i=0; $i<sizeof($ary1); $i++)
		{
			if(!$$ary1[$i] = $capaci->get($PHP_fty, $PHP_year1,$ary2[$i])){
				$op['msg']= $capaci->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
		}	
				// 設定 html 的 format
				$sumc = 0;
				for ($j=1;$j<13;$j++){
						$sumc = $sumc + $c1[$j+3];
					$op['c1'][$j] = $PG->y[$j-1] = $c1[$j+3];  // 取出陣列內的項數						
				}
				$op['c1']['sum'] = $sumc;



//------------------------------------------  業務接單 ----------------------				
				$where_str = "AND s_order.dept <> '".$PHP_fty."'";
				
			   if(!$op['u1'] = $capaci->get_unord($PHP_fty, $PHP_year1,$where_str)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
				
				if(!$op['so1'] = $capaci->get_subcon($PHP_fty, $PHP_year1,$where_str)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}		
				if(!$op['cm1'] = $capaci->get_cm($PHP_fty, $PHP_year1,$FTY_CM[$PHP_fty],$where_str)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}	
				if(!$op['p1'] = $capaci->get_ord_qty($PHP_fty, $PHP_year1,$where_str)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}	

				if(!$op['s1'] = $capaci->get_sch_qty($PHP_fty, $PHP_year1,$where_str)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}	

				if(!$op['a1'] = $capaci->get_out_qty($PHP_fty, $PHP_year1,$where_str)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}

				if(!$op['h1'] = $capaci->get_shp_qty($PHP_fty, $PHP_year1,$where_str)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}


		 //搜尋forcast
									
				$where_str = " WHERE method='forecast' AND fty='".$PHP_fty."' AND year='".$PHP_year1."' AND forecast.dept <> '".$PHP_fty."' ";
			  $m_cast = $forecast->search(0,$where_str);
			  for ($j=0; $j<13; $j++)	$op['fc1'][$mm_2[$j]] = 0;
				for ($i=0; $i<sizeof($m_cast['fcst']); $i++){
					$m_cast['fcst'][$i]['f'] = csv2array($m_cast['fcst'][$i]['qty']);			
					//加總全部的客戶預算---
					for ($j=0; $j<13; $j++){
						
						$op['fc1'][$mm_2[$j]] = $op['fc1'][$mm_2[$j]] + $m_cast['fcst'][$i]['f'][$j];
					}
				}			

				for ($i=0; $i< 13; $i++) 
				{
						$op['sumy1'][$i] = $op['p1'][$mm_2[$i]] + $op['u1'][$mm_2[$i]]+$op['fc1'][$mm_2[$i]];
				}
			//	$op['sumy1'][$i] = $op['p1'][13] + $op['u1']['13']+$op['fcst1']['13'];
//------------------------------------------  工廠接單 -- 女裝 ----------------------
		
				$where_str = "AND s_order.dept = '".$PHP_fty."' AND s_order.line_sex = 'F'";
				
			   if(!$op['u2'] = $capaci->get_unord($PHP_fty, $PHP_year1,$where_str)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}
				
				if(!$op['so2'] = $capaci->get_subcon($PHP_fty, $PHP_year1,$where_str)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}		
				if(!$op['cm2'] = $capaci->get_cm($PHP_fty, $PHP_year1,$FTY_CM[$PHP_fty],$where_str)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}	
				if(!$op['p2'] = $capaci->get_ord_qty($PHP_fty, $PHP_year1,$where_str)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}	

				if(!$op['s2'] = $capaci->get_sch_qty($PHP_fty, $PHP_year1,$where_str)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}	

				if(!$op['a2'] = $capaci->get_out_qty($PHP_fty, $PHP_year1,$where_str)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}

				if(!$op['h2'] = $capaci->get_shp_qty($PHP_fty, $PHP_year1,$where_str)){
			   		$op['msg']= $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}


		 //搜尋forcast
				$where_str = " WHERE method='forecast' AND fty='".$PHP_fty."' AND year='".$PHP_year1."' AND forecast.dept = '".$PHP_fty."' ";
			  $m_cast = $forecast->search(0,$where_str);
			  for ($j=0; $j<13; $j++)	$op['fc2'][$mm_2[$j]] = 0;
				for ($i=0; $i<sizeof($m_cast['fcst']); $i++){
					$m_cast['fcst'][$i]['f'] = csv2array($m_cast['fcst'][$i]['qty']);			
					//加總全部的客戶預算---
					for ($j=0; $j<13; $j++){
						$op['fc2'][$mm_2[$j]] = $op['fc2'][$mm_2[$j]] + $m_cast['fcst'][$i]['f'][$j];
					}
				}	
				for ($i=0; $i< 13; $i++) 
				{
						$op['sumy2'][$i] = $op['p2'][$mm_2[$i]] + $op['u2'][$mm_2[$i]]+$op['fc2'][$mm_2[$i]];
				}



//------------------------------------------  工廠接單 -- 男裝 ----------------------
		
				$where_str = "AND s_order.dept = '".$PHP_fty."' AND s_order.line_sex = 'M'";
				$op['u3'] = $capaci->get_unord($PHP_fty, $PHP_year1,$where_str);
				$op['so3'] = $capaci->get_subcon($PHP_fty, $PHP_year1,$where_str);		
				$op['cm3'] = $capaci->get_cm($PHP_fty, $PHP_year1,$FTY_CM[$PHP_fty],$where_str);	
				$op['p3'] = $capaci->get_ord_qty($PHP_fty, $PHP_year1,$where_str);
				$op['s3'] = $capaci->get_sch_qty($PHP_fty, $PHP_year1,$where_str);	
				$op['a3'] = $capaci->get_out_qty($PHP_fty, $PHP_year1,$where_str);
				$op['h3'] = $capaci->get_shp_qty($PHP_fty, $PHP_year1,$where_str);

				for ($i=0; $i< 13; $i++) $op['sumy3'][$i] = $op['p3'][$mm_2[$i]] + $op['u3'][$mm_2[$i]];

//------------------------------------------  龍安廠訂單 ----------------------
			if($PHP_fty == 'LY')
			{
				$where_str = " AND s_order.line_sex = 'A'";
				$op['u4'] = $capaci->get_unord($PHP_fty, $PHP_year1,$where_str);
				$op['so4'] = $capaci->get_subcon($PHP_fty, $PHP_year1,$where_str);
			  $op['cm4'] = $capaci->get_cm($PHP_fty, $PHP_year1,$FTY_CM[$PHP_fty],$where_str);
				$op['p4'] = $capaci->get_ord_qty($PHP_fty, $PHP_year1,$where_str);
				$op['s4'] = $capaci->get_sch_qty($PHP_fty, $PHP_year1,$where_str);
				$op['a4'] = $capaci->get_out_qty($PHP_fty, $PHP_year1,$where_str);
				$op['h4'] = $capaci->get_shp_qty($PHP_fty, $PHP_year1,$where_str);
				for ($i=0; $i< 13; $i++) $op['sumy4'][$i] = $op['p4'][$mm_2[$i]] + $op['u4'][$mm_2[$i]];
			}

					$op['msg']= $capaci->msg->get(2);
			page_display($op, '055', $TPL_CAPACITY_DET);
		break;





//-------------------------------------------------------------------------------------
    case "capacity_add":

	check_authority('055',"add");
		//  檢查看看 資料庫是否已經 存在 ??
		   if($c = $capaci->get($PHP_fty, $PHP_year1,'capacity')){
				$op['msg'][]= 'year :'.$PHP_year1.'\'s capacity of factory[ '.$PHP_fty.' ] is exist already !';
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}

		$op['msg'] ='';

		$op['fty'] = $PHP_fty;
		$op['year1'] = $PHP_year1;
		$op['year2'] = $PHP_year2;
		$op['year3'] = $PHP_year3;
		
		if (!$op['fty']){
			$op['msg'][] = "Error ! you have to select the target Factory !";
		}
		if(!$op['year1']){
			$op['msg'][] = "Error! you have to select one target YEAR at least !";
		}

		if ($op['msg']){	
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		page_display($op, '055', $TPL_ADD_CAPACITY); 
		break;

//-------------------------------------------------------------------------------------
    case "do_capacity_add":

		check_authority('055',"add");
			$parm = array(	"fty"			=>  $PHP_fty,
							"year1"			=>  $PHP_year1,
							"year2"			=>  $PHP_year2,
							"year3"			=>  $PHP_year3,
			);
		$A1 = array();
		$A2 = array();
		$A3 = array();
		
			for ($i=1;$i<13;$i++){  // 轉換輸入值為 陣列
				$t = 100+$i;
				$s = "PHP_".$PHP_year1.substr($t,1);
				$A1[$i] = $$s;
			}

	  if($PHP_year2){	
			for ($i=1;$i<13;$i++){
				$t = 100+$i;
				$s2 = "PHP_".$PHP_year2.substr($t,1);
				$A2[$i] = $$s2;
			}
	  }
		
	  if($PHP_year3){	
			for ($i=1;$i<13;$i++){
				$t = 100+$i;
				$s3 = "PHP_".$PHP_year3.substr($t,1);
				$A3[$i] = $$s3;
			}
	  }
			$parm['A1'] = $A1;
		  if($PHP_year2){	$parm['A2'] = $A2;	  }else{ $parm['A2'] ='';}
		  if($PHP_year3){	$parm['A3'] = $A3;	  }else{ $parm['A3'] ='';}

		if (!$f1 = $capaci->check($parm)) {  // 輸入資料 不正確時
			$op['msg'] = $capaci->msg->get(2);

			// 傳回 給 html 使用之參數 ;包括 輸入的資料也傳回 html
			$op['fty'] = $parm['fty'];
			$op['year1'] = $parm['year1'];
			$op['c1'] = $parm['A1'];
		  if($PHP_year2){	
			$op['year2'] = $parm['year2'];
			$op['c2'] = $parm['A2'];
		  }
		  if($PHP_year3){	
			$op['year3'] = $parm['year3'];
			$op['c3'] = $parm['A3'];
		  }

			$op['msg'] = $capaci->msg->get(2);
			if ($op['msg']){ $op['msg_YES'] = 1; } else { $op['msg_YES'] = "" ;}

			$layout->assign($op);
			$layout->display($TPL_ADD_CAPACITY);  
		break;

		}   // 結束 查尋輸入之資料 正確性

		// 寫入資料庫
		if (!$f1 = $capaci->add($parm)) {  // 寫入資料庫
			$op['msg'] = $capaci->msg->get(2);

			// 傳回 給 html 使用之參數 ;包括 輸入的資料也傳回 html
			$op['fty'] = $parm['fty'];
				$op['year1'] = $parm['year1'];
				$op['c1'] = $parm['A1'];
			  if($PHP_year2){	
				$op['year2'] = $parm['year2'];
				$op['c2'] = $parm['A2'];
			  }
			  if($PHP_year3){	
				$op['year3'] = $parm['year3'];
				$op['c3'] = $parm['A3'];
			  }


			$op['msg'] = $capaci->msg->get(2);
			if ($op['msg']){ $op['msg_YES'] = 1; } else { $op['msg_YES'] = "" ;}

			$layout->assign($op);
			$layout->display($TPL_ADD_CAPACITY);  
		break;

		}   // 結束 加入資料庫


			// 傳回 給 html 使用之參數 ;包括 輸入的資料也傳回 html
			$op['fty'] = $parm['fty'];
			$op['year1'] = $parm['year1'];
			$parm['A1'][13] = array_sum($parm['A1']);   //加入 total 項
			$op['c1'] = $parm['A1'];			
		  if($PHP_year2){	
			$op['year2'] = $parm['year2'];
			$parm['A2'][13] = array_sum($parm['A2']);   //加入 total 項
			$op['c2'] = $parm['A2'];
		  }
		  if($PHP_year3){	
			$op['year3'] = $parm['year3'];
			$parm['A3'][13] = array_sum($parm['A3']);   //加入 total 項
			$op['c3'] = $parm['A3'];
		  }

		$redir_str = $cgiself."?PHP_action=do_capacity_search&PHP_fty=".$PHP_fty."&PHP_year1=".$PHP_year1."&PHP_year2=".$PHP_year2."&PHP_year3=".$PHP_year3;

			redirect_page($redir_str);

		break;



//-------------------------------------------------------------------------------------
    case "capacity_update":

		check_authority('055',"edit");
		$op['msg'] ='';

		$op['fty'] = $PHP_fty;
		$op['year1'] = $PHP_year1;
		$op['year2'] = $PHP_year2;
		$op['year3'] = $PHP_year3;
		
		if (!$op['fty']){
			$op['msg'][] = "Error ! you have to select target Factory !";
		}
		if(!$op['year1']){
			$op['msg'][] = "Error! you have to select one target YEAR !";
		}

		if ($op['msg']){	
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
	// 自資料庫 取出該筆capacity記錄 -------------
			$op['c1'] = $capaci->get($PHP_fty, $PHP_year1, $cat='capacity');
		if ($PHP_year2){ 
			$op['c2'] = $capaci->get($PHP_fty, $PHP_year2, $cat='capacity'); 
			if(!$op['c2']){ $op['year2'] =''; }		
		}
		if ($PHP_year3){ 
			$op['c3'] = $capaci->get($PHP_fty, $PHP_year3, $cat='capacity'); 
			if(!$op['c3']){ $op['year3'] =''; }
		}

			page_display($op, '055', $TPL_CAPACITY_UPDATE); 
		break;

//-------------------------------------------------------------------------------------
    case "do_capacity_edit":

		check_authority('055',"edit");
		$parm = array(	"fty"		=>  $PHP_fty,
						"year1"		=>  $PHP_year1,
						"year2"		=>  $PHP_year2,
						"year3"		=>  $PHP_year3,
						"c_type"	=>  'capacity',
			);
						$parm['A1']['id'] = $PHP_y1_id;
						$parm['A1'][1] = $PHP_y1_01;
						$parm['A1'][2] = $PHP_y1_02;
						$parm['A1'][3] = $PHP_y1_03;
						$parm['A1'][4] = $PHP_y1_04;
						$parm['A1'][5] = $PHP_y1_05;
						$parm['A1'][6] = $PHP_y1_06;
						$parm['A1'][7] = $PHP_y1_07;
						$parm['A1'][8] = $PHP_y1_08;
						$parm['A1'][9] = $PHP_y1_09;
						$parm['A1'][10] = $PHP_y1_10;
						$parm['A1'][11] = $PHP_y1_11;
						$parm['A1'][12] = $PHP_y1_12;

			if($PHP_year2){
						$parm['A2']['id'] = $PHP_y2_id;
						$parm['year2'] = $PHP_year2;
						$parm['A2'][1] = $PHP_y2_01;
						$parm['A2'][2] = $PHP_y2_02;
						$parm['A2'][3] = $PHP_y2_03;
						$parm['A2'][4] = $PHP_y2_04;
						$parm['A2'][5] = $PHP_y2_05;
						$parm['A2'][6] = $PHP_y2_06;
						$parm['A2'][7] = $PHP_y2_07;
						$parm['A2'][8] = $PHP_y2_08;
						$parm['A2'][9] = $PHP_y2_09;
						$parm['A2'][10] = $PHP_y2_10;
						$parm['A2'][11] = $PHP_y2_11;
						$parm['A2'][12] = $PHP_y2_12;
			}
			if($PHP_year3){
						$parm['A3']['id'] = $PHP_y3_id;
						$parm['year3'] = $PHP_year3;
						$parm['A3'][1] = $PHP_y2_01;
						$parm['A3'][2] = $PHP_y2_02;
						$parm['A3'][3] = $PHP_y2_03;
						$parm['A3'][4] = $PHP_y2_04;
						$parm['A3'][5] = $PHP_y2_05;
						$parm['A3'][6] = $PHP_y2_06;
						$parm['A3'][7] = $PHP_y2_07;
						$parm['A3'][8] = $PHP_y2_08;
						$parm['A3'][9] = $PHP_y2_09;
						$parm['A3'][10] = $PHP_y2_10;
						$parm['A3'][11] = $PHP_y2_11;
						$parm['A3'][12] = $PHP_y2_12;
			}

		//------------ 檢查輸入資料之正確性  ---------------------------------

		if (!$f1 = $capaci->check($parm)) {  // 輸入資料 不正確時
			$op['msg'] = $capaci->msg->get(2);

			// 傳回 給 html 使用之參數 ;包括 輸入的資料也傳回 html
			$op['fty'] = $parm['fty'];
			$op['year1'] = $parm['year1'];
				$op['c1']['id'] = $parm['A1']['id'];
				$op['c1']['m01'] = $parm['A1'][1];
				$op['c1']['m02'] = $parm['A1'][2];
				$op['c1']['m03'] = $parm['A1'][3];
				$op['c1']['m04'] = $parm['A1'][4];
				$op['c1']['m05'] = $parm['A1'][5];
				$op['c1']['m06'] = $parm['A1'][6];
				$op['c1']['m07'] = $parm['A1'][7];
				$op['c1']['m08'] = $parm['A1'][8];
				$op['c1']['m09'] = $parm['A1'][9];
				$op['c1']['m10'] = $parm['A1'][10];
				$op['c1']['m11'] = $parm['A1'][11];
				$op['c1']['m12'] = $parm['A1'][12];
		  if($PHP_year2){	
			$op['year2'] = $parm['year2'];
				$op['c2']['id'] = $parm['A2']['id'];
				$op['c2']['m01'] = $parm['A2'][1];
				$op['c2']['m02'] = $parm['A2'][2];
				$op['c2']['m03'] = $parm['A2'][3];
				$op['c2']['m04'] = $parm['A2'][4];
				$op['c2']['m05'] = $parm['A2'][5];
				$op['c2']['m06'] = $parm['A2'][6];
				$op['c2']['m07'] = $parm['A2'][7];
				$op['c2']['m08'] = $parm['A2'][8];
				$op['c2']['m09'] = $parm['A2'][9];
				$op['c2']['m10'] = $parm['A2'][10];
				$op['c2']['m11'] = $parm['A2'][11];
				$op['c2']['m12'] = $parm['A2'][12];
		  }
		  if($PHP_year3){	
			$op['year3'] = $parm['year3'];
				$op['c3']['id'] = $parm['A3']['id'];
				$op['c3']['m01'] = $parm['A3'][1];
				$op['c3']['m02'] = $parm['A3'][2];
				$op['c3']['m03'] = $parm['A3'][3];
				$op['c3']['m04'] = $parm['A3'][4];
				$op['c3']['m05'] = $parm['A3'][5];
				$op['c3']['m06'] = $parm['A3'][6];
				$op['c3']['m07'] = $parm['A3'][7];
				$op['c3']['m08'] = $parm['A3'][8];
				$op['c3']['m09'] = $parm['A3'][9];
				$op['c3']['m10'] = $parm['A3'][10];
				$op['c3']['m11'] = $parm['A3'][11];
				$op['c3']['m12'] = $parm['A3'][12];
		  }

			$op['msg'] = $capaci->msg->get(2);

			page_display($op, '055', $TPL_CAPACITY_UPDATE);
		break;

		}   // 結束 查尋輸入之資料 正確性

	// ---  寫入 capacity 資料庫 ---------------------		
		if(!$A1 = $capaci->update_capacity($parm)){
			$op['msg']= $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
			
				# 記錄使用者動態
			$message = "update [ ".$PHP_fty." ]'s capacity of year :[".$PHP_year1." ".$PHP_year2." ".$PHP_year3."]";

			$log->log_add(0,"81E",$message);

			$redir_str = $cgiself."?PHP_action=do_capacity_search&PHP_fty=".$PHP_fty."&PHP_year1=".$PHP_year1."&PHP_year2=".$PHP_year2."&PHP_year3=".$PHP_year3;

			redirect_page($redir_str);

		break;


//-------------------------------------------------------------------------------------
//			 job 38  生產記錄

#	NOTE: 必需設定進入的 user 身份 [ 不同工廠 ===== ============== ]

//-------------------------------------------------------------------------------------
    case "production":
    	check_authority('028',"view");
//---------------------------------- 判斷是否工廠人員進入 ---------------

		$where_str = $manager = $dept_id = $fty_select ='';
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 叛定進入身份的指標

		for ($i=0; $i<count($GLOBALS['FACTORY']);$i++){
			if($user_dept == $GLOBALS['FACTORY'][$i]){
				$dept_id = $GLOBALS['FACTORY'][$i];   // 如果是工廠部門人員進入 dept_id 指定該工廠---
			}
		}

		if (!$dept_id) {    // 當不是工廠人員進入時
			$manager = 1;
			$fty_select = $arry2->select($FACTORY,"","PHP_factory","select","");  //工廠 select選單
		} else {
			$where_str = " WHERE factory = '".$dept_id."' ";
		}

		$op['manager_flag'] = $manager;
		$op['fty_id'] = $dept_id;
		$op['fty_select'] = $fty_select;

//---------------------------------- 判斷是否工廠人員進入 ---------------

		$op['msg'] = $order->msg->get(2);		
				// creat cust combo box

				$where_str ="";

		// 取出 全部客戶代號
		$where_str="order by cust_s_name"; //依cust_s_name排序
		$cust_def = $cust->get_fields('cust_init_name',$where_str);
		$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
		for ($i=0; $i< sizeof($cust_def); $i++)
		{
			$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
		}
		$op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue); 

		page_display($op,'028', $TPL_PRODUCTION);	
				    	    
		break;



//=======================================================
    case "production_search":
		check_authority('028',"view");		
			// 訂單資料列表
			$parm = array(	
//						"dept"			=>  $PHP_dept_code,
						"order_num"		=>  $PHP_order_num,
						"cust"			=>	$PHP_cust,
						"ref"			=>	$PHP_ref,
						"factory"		=>	$PHP_factory,
				);

			//  先 取出今日 產出記錄列表-------------+++++++++++++
			$argv = array(	"ord_num"	=>  $PHP_order_num,
							"k_date"	=>	$GLOBALS['TODAY'],
							"factory"	=>	$PHP_factory,
			);

				$op['cgi']= $parm;

			//  先 取出今日 產出記錄列表-------------+++++++++++++
			if (!$pd = $daily->search($argv,1)) {   
				$op['msg']= $daily->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			
			if (!$op = $order->ord_search(2)) {   // 排產卻認後 需mode =2 即加入status>=7
				$op['msg']= $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}

			// 轉換給 html用 之參數
			$op['pdt'] = $pd['daily'];
			$op['daily_records'] = $pd['max_no'];
			$op['today_qty'] = 0;  $op['today_su']= 0;
			$entry = count($op['pdt']);
			for($i=0;$i<$entry;$i++){  // 計算 今日生產總數量
				$op['today_qty'] =	$op['today_qty'] + $op['pdt'][$i]['qty'];
				$op['today_su'] =	$op['today_su'] + $op['pdt'][$i]['su'];
			}

				$op['msg']= $order->msg->get(2);
//				$op['msg']= $daily->msg->get(2);

				$op['cgi']= $parm;
		page_display($op,'028', $TPL_PRODUCTION_LIST);
		break;



//-------------------------------------------------------------------------------------
    case "add_production":

		check_authority('028',"add");
		$today = $GLOBALS['TODAY'];

		$parm = array(	"pd_id"		=>  $PHP_pd_id,
						"ord_num"	=>  $PHP_ord_num,
						"back"		=>  $PHP_back,
						"qty"		=>  $PHP_qty,
						"k_date"	=>  $today,

				);

		// 2006/03/24 改成不可輸入 零值 -------------
		if(!$PHP_qty){
			$op['msg'][] = "sorry! you have to key-in out-put Q'ty !";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
##--*****新增頁數部分 start
		$redir_str = $PHP_back."&PHP_sr_startno=".$PHP_sr_startno."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5;
##--*****新增頁數部分 end
//-----||  改寫 pdtion->qty_don,qty_update ||     daily     ||  改寫 capacity->actural(SU)  ||---------

	
	// 設定一些其它的 參數及 必要的 值 ++++++++++++++++++++++++++++++++++++++++++++++++
	// 由 s_order 取出 su_ratio 算出 su
		//   2005/08/31 改由資料庫抓 su [以 ie 計算填入 ]
		$su_ratio = $order->get_field_value('ie1', '', $PHP_ord_num);
		if ($su_ratio == 0)
		{
			$PHP_style = $order->get_field_value('style', '', $PHP_ord_num);
			if ($PHP_style=='PS' || $PHP_style=='BS' || $PHP_style=='BZ' || $PHP_style=='DR' || $PHP_style=='JK' || $PHP_style=='PS-J' || $PHP_style=='PS-P' || $PHP_style=='PS-S' || $PHP_style=='VS' || $PHP_style=='SS'){
				$cac_su=2*$PHP_qty;			
			}else{
				$cac_su=1*$PHP_qty;			
			}
		}else{
			$cac_su = $su_ratio * $PHP_qty;
		}
		$PHP_id = $order->get_field_value('id', '', $PHP_ord_num);
		$parm['factory'] = $order->get_field_value('factory', '', $PHP_ord_num);
		
		$parm['su'] = number_format($cac_su, 0, '', '');  //四捨五入 ----- 單筆

	// 先取出 原來 pdtion table內的資料來加入[qty_done],[out_su]
		$qty_done = $order->get_field_value('qty_done', '', $PHP_ord_num,'pdtion');

	// 當第一次產出時 [找不到資料]--- 要在 pdtion 寫入 start date 及 改變 s_order的status >8
	// 以後有產出時就不必再寫入.....................
		if (!$qty_done) {  

			//-----------  寫入 s_order ....... status ->8
			if(!$A1 = $order->update_field('status','8',$PHP_id)){;   // 更新 訂單狀況記錄  status =>8
				$op['msg']= $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}

			//-------------------------------------------------
			//------------  寫入 pdtion ......... start 今日
			if(!$A1 = $order->update_pdtion_field('start',$GLOBALS['TODAY'],$PHP_pd_id)){ 
				$op['msg']= $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
		}

	// 取出原來 pdtion 內的 out_su 字串
		$out_su = $order->get_field_value('out_su', '', $PHP_ord_num,'pdtion');

	// 改成陣列 月=>su	
		$A_out_su = decode_mon_su($out_su);

	// 本月加入 新的產出 su
		if(array_key_exists ($GLOBALS['THIS_MON'], $A_out_su )){ //先查該月份存不存在
			$A_out_su[$GLOBALS['THIS_MON']] = $A_out_su[$GLOBALS['THIS_MON']] + $parm['su'];
		} else {
			$A_out_su[$GLOBALS['THIS_MON']] = $parm['su'];
		}
			
	// 將 A_out_su 改成 csv 
		$parm['out_su'] = encode_number($A_out_su);  // 轉成 csv 
		
		
		// 設定日期
	// *************************************************
	// *********  寫入 daily table *********************
			$f1 = $daily->check($parm);
		if (!$f1) {  // 輸入資料 不正確時 
			$op['msg'] = $daily->msg->get(2);
			redirect_page($redir_str);
			break;
		}  // end if  輸入資料 不正確 

		if(!$F = $daily->add($parm)){   // 新增 daily 資料庫
				$op['msg']= $daily->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 


	// *************************************************
	// *********  改寫入 pdtion table *********************

		if(!$F1 = $order->pd_out_update($parm)){   // 更新 pdtion 資料庫
				$op['msg'] = $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 


	// *************************************************
	// *************************************************
	// *********  寫入 capacity table *********************
		$m_su = substr($GLOBALS['THIS_MON'],4);

		if(!$F1 = $capaci->update_su($parm['factory'],$GLOBALS['THIS_YEAR'],$m_su,'actual',$parm['su'])){  		$op['msg'][] = $capaci->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 
			
				# 記錄使用者動態
		$message = "Add [ ".$PHP_ord_num." ] in Q'ty:[".$PHP_qty."] to FTY:[".$parm['factory']."]";

			$log->log_add(0,"44A",$message);

			redirect_page($redir_str);

		break;




//-------------------------------------------------------------------------------------
//--------- 相同於add_production 僅多加入 改寫 s_order->status 及 pdtion->finish -----------
 
	case "finish_production":
//-------------------------------------------------------------------------------------
		check_authority('028',"add");

		$today = $GLOBALS['TODAY'];

		$parm = array(	"pd_id"		=>  $PHP_pd_id,
						"ord_num"	=>  $PHP_ord_num,
						"back"		=>  $PHP_back,
						"qty"		=>  $PHP_qty,
						"k_date"	=>  $today,

				);

		// 先取出 s_order 的 id -------------------------------------------------
		$ord_id = $order->get_field_value('id', '',$PHP_ord_num);
		//------------------------------------------------------------ diff production_add ----
##--*****新增頁數 start
		$redir_str = $PHP_back."&PHP_sr_startno=".$PHP_sr_startno."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5;
##--*****新增頁數 end
	// 2006/03/24 改成 當輸入零值時  不寫入 daily out 的table及改寫必要的table -------------
	$parm['factory'] = $order->get_field_value('factory', '', $PHP_ord_num);
	if($PHP_qty){  //當有輸入 finhish數量時

	//------------- 改寫 pdtion->qty_don,qty_update ||     daily     || 改寫 capacity->actural(SU)  ";
	
	// 設定一些其它的 參數及 必要的 值 ++++++++++++++++++++++++++++++++++++++++++++++++
		//   2005/08/31 改由資料庫抓 su [以 ie 計算填入 ]
		$su_ratio = $order->get_field_value('ie1', '', $PHP_ord_num);
		
		if ($su_ratio == 0)
		{
			$PHP_style = $order->get_field_value('style', '', $PHP_ord_num);
			if ($PHP_style=='PS' || $PHP_style=='BS' || $PHP_style=='BZ' || $PHP_style=='DR' || $PHP_style=='JK' || $PHP_style=='PS-J' || $PHP_style=='PS-P' || $PHP_style=='PS-S' || $PHP_style=='VS' || $PHP_style=='SS'){
				$cac_su=2*$PHP_qty;			
			}else{
				$cac_su=1*$PHP_qty;			
			}
		}else{
			$cac_su = $su_ratio * $PHP_qty;
		}
		
		$PHP_id = $order->get_field_value('id', '', $PHP_ord_num);
		$parm['factory'] = $order->get_field_value('factory', '', $PHP_ord_num);		
		$parm['su'] = number_format($cac_su, 0, '', '');  //四捨五入 ----- 單筆

	// 先取出 原來table內的資料來加入[qty_done],[out_su]
		$qty_done = $order->get_field_value('qty_done', '', $PHP_ord_num,'pdtion');

	// 當第一次產出時 [找不到資料]--- 要在 pdtion 寫入 start date 
	// 以後有產出時就不必再寫入.....................
		if (!$qty_done) {  
			//-------------------------------------------------
			//------------  寫入 pdtion ......... start 今日
			if(!$A1 = $order->update_pdtion_field('start',$GLOBALS['TODAY'],$PHP_pd_id)){ 
				$op['msg']= $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
		}

	// 取出原來 pdtion 內的 out_su 字串
		$out_su = $order->get_field_value('out_su', '', $PHP_ord_num,'pdtion');

	// 改成陣列 月=>su	
		$A_out_su = decode_mon_su($out_su);

	// 本月加入 新的產出 su
		if(array_key_exists ($GLOBALS['THIS_MON'], $A_out_su )){ //先查該月份存不存在
			$A_out_su[$GLOBALS['THIS_MON']] = $A_out_su[$GLOBALS['THIS_MON']] + $parm['su'];
		} else {
			$A_out_su[$GLOBALS['THIS_MON']] = $parm['su'];
		}
			
	// 將 A_out_su 改成 csv 
		$parm['out_su'] = encode_number($A_out_su);  // 轉成 csv 
    //	$parm['qty_done'] = $qty_done + $PHP_qty;  // 新的 完成件數
		
		// 設定日期
	// *************************************************
	// *********  寫入 daily table *********************
			$f1 = $daily->check($parm);
		if (!$f1) {  // 輸入資料 不正確時 
			$op['msg'] = $daily->msg->get(2);
			redirect_page($redir_str);
			break;
		}  // end if  輸入資料 不正確 

		if(!$F = $daily->add($parm)){   // 新增 daily 資料庫
				$op['msg']= $daily->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 


	// *************************************************
	// *********  改寫入 pdtion table *********************

		if(!$F1 = $order->pd_out_update($parm)){   // 更新 pdtion 資料庫
				$op['msg'] = $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 

	// *************************************************
	// *********  寫入 capacity table *********************
		$m_su = substr($GLOBALS['THIS_MON'],4);

		if(!$F1 = $capaci->update_su($parm['factory'],$GLOBALS['THIS_YEAR'],$m_su,'actual',$parm['su'])){  		$op['msg'][] = $capaci->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 

	}  // if(!$PHP_qty) :::::::   當有輸日 qty時 才會執行上面的......


	// *************** 與 add_production 不同處 **********
	// *************************************************
	// *********  寫入 S_order->status,  pdtion->finish *********************
	//若己有Ship的數量時,訂單狀態為"==SHIPPED==";若無Ship數量時,訂單狀態為"=FINISHED="
		$shp_qty = $order->get_field_value('qty_shp',$PHP_pd_id,'',$tbl='pdtion');			
		if ($shp_qty > 0){$status = 12;}else{$status=10;}
		if(!$F1 = $order->update_field('status',$status, $ord_id)){
			$op['msg'][] = $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 

		if(!$F1 = $order->update_pdtion_field('finish', $today, $PHP_pd_id)){
			$op['msg'][] = $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 
		//------------------------------------------- diff production_add ----
				
				# 記錄使用者動態
		$message = "Add Q'ty:[".$PHP_qty."] and close:[ ".$PHP_ord_num." ] to FTY:[".$parm['factory']."]";
		$log->log_add(0,"44A",$message);



			redirect_page($redir_str);

		break;

//-------------------------------------------------------------------------------------
//	case "re_open_finish":		讓 生產結束的 order 可再 reopen ,...
//								
//								 加入 shipping 檔
//-------------------------------------------------------------------------------------

	case "re_open_finish":

		check_authority('028',"add");
		$today = $GLOBALS['TODAY'];

		$parm = array(	"pd_id"		=>  $PHP_pd_id,
						"ord_num"	=>  $PHP_ord_num,
						"back"		=>  $PHP_back,
						"k_date"	=>  $today,
				);

		// 先取出 s_order 的 id -------------------------------------------------
		$ord_id = $order->get_field_value('id', '',$PHP_ord_num);
		
		//---------------------------- diff production_add ----

		$redir_str = $PHP_back."&PHP_sr_startno=".$cgino."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5;

	// *************************************************
	// *********  改寫入 pdtion table *********************

		if(!$F1 = $order->update_pdtion_field("finish",'',$PHP_pd_id)){ // 更新 pdtion 資料庫
				$op['msg'] = $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 
	// *************************************************
	// *********  寫入 S_order->status, 
			
		if(!$F1 = $order->update_field('status', 8, $ord_id)){
			$op['msg'][] = $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 

		//------------------------------------------- diff production_add ----
				
				# 記錄使用者動態
		$message = "RE-Open style :[ ".$PHP_ord_num." ] ";
		$log->log_add(0,"44A",$message);



			redirect_page($redir_str);

		break;














//-------------------------------------------------------------------------------------
 
	case "del_production":

//    同 add_production 只是將 qty 改成負值 
//              但要注意原來是否已是finish的訂單......  及 del後是否還沒開始生產
//-------------------------------------------------------------------------------------
		check_authority('028',"edit");
		$today = $GLOBALS['TODAY'];

		$parm = array(	
//						"pd_id"		=>  $PHP_pd_id,
						"ord_num"	=>  $PHP_ord_num,
						"back"		=>  $PHP_back,
						"factory"	=>  $PHP_fty,
						"qty"		=>  $PHP_qty * (-1),	// 直接 將qty改成負值
						"su"		=>  $PHP_su * (-1),	// 直接 將qty改成負值
						"k_date"	=>  $today,

				);
##--****新增頁碼 start
		$redir_str = $PHP_back."&PHP_sr_startno=".$PHP_sr_startno."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5;
##--****新增頁碼 end

	//2006/04/10 改成一 個命令完成原資出料取出動作------原則上是生產的東西 一定有pdtion檔
	if(!$tmp = $order->get_fields_4_del_pdt($PHP_ord_num)){
		$op['msg'][] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
	} 

		$parm['id'] = $tmp['id'];
		$parm['pd_id'] = $tmp['p_id'];
		$ord_status = $tmp['status'];
		$out_su = $tmp['out_su'];

	
	// 改成陣列 月=>su	
		$A_out_su = decode_mon_su($out_su);

	// 本月  減少   新的產出 su
		if(array_key_exists ($GLOBALS['THIS_MON'], $A_out_su )){ //先查該月份存不存在
			$A_out_su[$GLOBALS['THIS_MON']] = $A_out_su[$GLOBALS['THIS_MON']] + $parm['su'];
		} else {
			$A_out_su[$GLOBALS['THIS_MON']] = $parm['su'];
		}

	// 將 陣列 A_out_su 內的值為零的去掉 **************
		$B_out_su = array_filter($A_out_su, 'filter_0_value');
	
	// 將 B_out_su 改成 csv 
		$parm['out_su'] = encode_number($B_out_su);  // 轉成 csv 
		
	// *************************************************
	// *********  刪除 daily table *********************
		if(!$F = $daily->del($PHP_daily_id)){   // 刪除 daily 資料庫
				$op['msg']= $daily->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 

	// *************************************************
	// *********  改寫入 pdtion table *********************

		if(!$F1 = $order->pd_out_update($parm)){   // 更新 pdtion 資料庫
				$op['msg'] = $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 

	// *************************************************
	// *********  寫入 capacity table *********************
		$m_su = substr($GLOBALS['THIS_MON'],4);

		if(!$F1 = $capaci->update_su($parm['factory'],$GLOBALS['THIS_YEAR'],$m_su,'actual',$parm['su'])){  		$op['msg'][] = $capaci->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		} 

		//20060410加入 判斷是否原來的 status為10[結束產出了] 則改成 status 為8 [生產中]
		if ($ord_status == '10'){
			//-----------  寫入 s_order ....... status ->8
			if(!$A1 = $order->update_field('status','8',$parm['id'])){;  // 更新 訂單狀況記錄  status =>8
				$op['msg']= $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
		}


//---------------最後 取出 pdtion->qty_done 看看是否為 0 ; 如果為0 則尚未有產出 ----
//--- 要在 pdtion 將 start date 去掉 及 改變 s_order的status- >7
	// 先取出 原來 pdtion table內的資料來加入[qty_done],[out_su]

		if (!$qty_done = $order->get_field_value('qty_done', '', $PHP_ord_num,'pdtion')) {  

			//-------------------------------------------------
			//-----------  寫入 s_order ....... status ->7
			if(!$A1 = $order->update_field('status','7',$parm['id'])){;   // 更新 訂單狀況記錄  status =>8
				$op['msg']= $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}

			//-------------------------------------------------
			//------------  寫入 pdtion ......... start 今日
			if(!$A1 = $order->update_pdtion_field('start',NULL ,$parm['pd_id'])){ 
				$op['msg']= $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
		}
			
				# 記錄使用者動態
		$message = "delete production [ ".$PHP_ord_num." ] in Q'ty:[".$PHP_qty."] from FTY:[".$parm['factory']."]";

			$log->log_add(0,"44E",$message);


			redirect_page($redir_str);


	break;


//=======================================================
	case "ord_schedule_view":
	check_authority('071',"view");

		$op['cgi'] = array(	"cgiget"	=>  $cgiget,
							"cgino"		=>  $cgino,
							"cgi_1"		=>	$cgi_1,
							"cgi_2"		=>	$cgi_2,
							"cgi_3"		=>	$cgi_3,
							"cgi_4"		=>	$cgi_4,
							"cgi_5"		=>	$cgi_5,
				);
//echo "PHP_ID ====>".$PHP_id;
//exit;
		
		$op['order'] = $order->schedule_get(0,$PHP_order_num);  //取出該筆記錄
		if (!$op['order']) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		// 取出 order_log 本訂單 之歷史50筆的計記錄  -------------------
		$logs = $order_log->search50($op['order']['order_num']);  //取出該訂單全部log記錄
		if (!$logs){
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['logs'] = $logs['order_log'];
		$op['log_records'] = $logs['records'];
			// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來叛斷有無資料
		//--------------------------------

		$parm = $op['order'];
if($parm['start'] =='0000-00-00'){ $parm['start'] =''; $op['order']['start']='';}
if($parm['finish'] =='0000-00-00'){ $parm['finish'] =''; $op['order']['finish']='';}




		// 計算 lead time 供 html 呈現 ------
		if($parm['etp'] && $parm['etd']){	$op['lead_time'] = countDays($parm['etp'],$parm['etd']);	}
		if($parm['ets'] && $parm['etf']){	$op['pd_leadtime'] = countDays($parm['ets'],$parm['etf']);	}
		if($parm['start'] && $parm['finish']){	$op['work_days'] = countDays($parm['start'],$parm['finish']);	}

		// 加入返回前頁 2005/05/05
		$back_str = $cgiget."&PHP_sr_startno=".$cgino."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5;

		$op['back_str'] = $back_str;
//		$op['id'] = $PHP_id;


			// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/picture/".$op['order']['order_num'].".jpg")){
			$op['main_pic'] = "./picture/".$op['order']['order_num'].".jpg";
		} else {
			$op['main_pic'] = "./images/graydot.gif";
		}

			// 計算  SU 供 html -----------------------------
//		$su = $op['order']['qty'] * $op['order']['su_ratio'];
		//   2005/08/31 改由資料庫抓 su [以 ie 計算填入 ]
		$su = $op['order']['su'];
		$op['order']['f_su'] = number_format($su, 0, '', ',');
		$op['order']['qty'] = number_format($op['order']['qty'], 0, '', ',');

			// 計算 日差 供 html 呈現 ----------- late_ship, late_start, late_schedule, late_work
		$today = $GLOBALS['TODAY'];
		if($parm['shp_date']){ $parm['shp'] = $parm['shp_date']; }else{ $parm['shp'] = $today; }
		if($parm['shp'] < $parm['etd']){ $factor =-1; } else { $factor =1; }
			$op['late_ship'] = $factor *(countDays($parm['shp'],$parm['etd']));

		if($parm['start']){ $parm['st'] = $parm['start']; }else{ $parm['st'] = $today; }
		if($parm['st'] < $parm['etp']){ $factor =-1; } else { $factor =1; }
			$op['late_start'] = $factor *(countDays($parm['st'],$parm['etp']));

	if($parm['start']){		
		if($parm['finish']){ $parm['upd'] = $parm['finish']; }else{ $parm['upd'] = $today; }
		if($parm['upd'] < $parm['etf']){ $factor =-1; } else { $factor =1; }
			$op['late_schedule'] = $factor *(countDays($parm['upd'],$parm['etf']));
	}else{
			$op['late_schedule'] = '';
	}

	if($parm['start']){		
//		if($parm['finish']){ $parm['upd'] = $parm['finish']; }else{ $parm['upd'] = $today; }
			$work_utd = countDays($parm['start'],$parm['upd']);
			$op['more_work'] = $work_utd - $op['pd_leadtime'];
	}else{
			$op['more_work'] = '';
	}


		$op['search'] = '1';
		$op['msg'] = $order->msg->get(2);
		page_display($op, 10, 7, $TPL_ORD_SCHEDULE_SHOW);				    
	break;




//-------------------------------------------------------------------------------------
//			 job 37  訂 單 排 程  確認  [  高階授權 的 job ]

#	NOTE: 必需設定進入的 user 身份 [ 不同工廠 ===== ============== ??????????????

//-------------------------------------------------------------------------------------
    case "cfm_pd_schedule":
		check_authority('027',"view");
		$id_ref = $GLOBALS['SCACHE']['ADMIN']['dept'];

		if (($id_ref == "SA") || ($id_ref == "GM")){   // 如果進入的身份是 超級管理員[none] 及總經理室[GM]
			$id_ref ='';
		}


			if (!$op = $order->schedule_uncfm_search($id_ref)) {
				$op['msg']= $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}

				$op['msg']= $order->msg->get(2);
			page_display($op,'027', $TPL_UNCFM_SCHEDULE_LIST);			

//080725message增加		
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];

		break;
//=======================================================
	case "cfm_schedule_view":
		check_authority('027',"add");
		$op['cgi'] = array(	"cgiget"	=>  $cgiget,
							"cgino"		=>  $cgino,
							"cgi_1"		=>	$cgi_1,
							"cgi_2"		=>	$cgi_2,
							"cgi_3"		=>	$cgi_3,
							"cgi_4"		=>	$cgi_4,
							"cgi_5"		=>	$cgi_5,
				);
		$op['order'] = $order->schedule_get($PHP_id);  //取出該筆記錄
			if (!$op['order']) {
				$op['msg'] = $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
		// 取出 order_log 本訂單 之歷史50筆的記錄  -------------------
		$logs = $order_log->search50($op['order']['order_num']);  //取出該訂單全部log記錄
		if (!$logs){
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['logs'] = $logs['order_log'];
		$op['log_records'] = $logs['records'];
			// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來叛斷有無資料
		//--------------------------------

		$parm = $op['order'];

		// 計算 lead time
		$op['lead_time'] = countDays ($parm['etp'],$parm['etd']);

		// 加入返回前頁 2005/05/05
		$back_str = $cgiget."&PHP_sr_startno=".$cgino."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5;

		$op['back_str'] = $back_str;
		$op['id'] = $PHP_id;


				# 記錄使用者動態
//		$log->log_add(0,"37A","瀏覽 排程訂單資料：".$op['order']['order_num']);

			// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/picture/".$op['order']['order_num'].".jpg")){
			$op['main_pic'] = "./picture/".$op['order']['order_num'].".jpg";
		} else {
			$op['main_pic'] = "./images/graydot.gif";
		}

			// 計算  SU 供 html -----------------------------
//		$su = $op['order']['qty'] * $op['order']['su_ratio'];
		//   2005/08/31 改由資料庫抓 su [以 ie 計算填入 ]
		$su = $op['order']['su'];
		$op['order']['f_su'] = number_format($su, 0, '', ',');
		$op['order']['qty'] = number_format($op['order']['qty'], 0, '', ',');

/*  *************************** 20060411考慮是不是多餘的????????????????
		// 設定 網頁上的 acc_etd 如何呈現 --- 如果已經有了acc_etd 則直接出現 如果沒有就出現 下拉 可輸入
		if(!$op['order']['acc_etd']){
			$op['acc_etd_year'] = $arry2->select($YEAR_WORK,'','PHP_acc_etdyear','select','');  	
			$op['acc_etd_mon'] = $arry2->select($MONTH_WORK,'','PHP_acc_etdmon','select','');  	
			$op['acc_etd_day'] = $arry2->select($DAY_WORK,'','PHP_acc_etdday','select','');
		} else {
				$acc_year = substr($op['order']['acc_etd'],0,4);
			$op['acc_etd_year'] =$op['order']['acc_etd']."<input type='hidden' name='PHP_acc_etdyear' value='".$acc_year."'>";
				$acc_mon = substr($op['order']['acc_etd'],5,2);
			$op['acc_etd_mon'] ="<input type='hidden' name='PHP_acc_etdmon' value='".$acc_mon."'>";
				$acc_day = substr($op['order']['acc_etd'],8,2);
			$op['acc_etd_day'] ="<input type='hidden' name='PHP_acc_etdday' value='".$acc_day."'>";
		}
*/		
		
		// === 設定 網頁上的 ets, etf 如何呈現 === 應有 ETS 才會要求 cfm ===== 解開 year, mon, day 成下拉
	if ($op['order']['status'] == 7){

		$op['ets_year'] = $op['order']['ets']." CFMed";
		$op['etf_year'] = $op['order']['etf']." CFMed";

	}else{

		if((!$op['order']['ets']) || (!$op['order']['ets'])) {  // 當 ets 或 etf 有一個沒輸入時 status 改成 4

			if(!$A1 = $order->update_field('status','4',$PHP_id)){;   // 更新 訂單狀況記錄  status =>4
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}

		} else {
			// creat ETS, date combo box
				$ets_year = substr($op['order']['ets'],0,4);
				$ets_mon = substr($op['order']['ets'],5,2);
				$ets_day = substr($op['order']['ets'],8,2);

			$op['ets_year'] = $arry2->select($YEAR_WORK,$ets_year,'PHP_ets_year','select','');  	
			$op['ets_mon'] = $arry2->select($MONTH_WORK,$ets_mon,'PHP_ets_month','select','');  	
			$op['ets_day'] = $arry2->select($DAY_WORK,$ets_day,'PHP_ets_day','select','');  	

			$op['submit_flag'] = "1";
		}   //  END of ETS

		if((!$op['order']['etf']) || (!$op['order']['etf'])) {  // 當 ets 或 etf 有一個沒輸入時 status 改成 4

			if(!$A1 = $order->update_field('status','4',$PHP_id)){;   // 更新 訂單狀況記錄  status =>4
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}

		} else {
			// creat ETF, date combo box
				$etf_year = substr($op['order']['etf'],0,4);
				$etf_mon = substr($op['order']['etf'],5,2);
				$etf_day = substr($op['order']['etf'],8,2);

			$op['etf_year'] = $arry2->select($YEAR_WORK,$etf_year,'PHP_etf_year','select','');  	
			$op['etf_mon'] = $arry2->select($MONTH_WORK,$etf_mon,'PHP_etf_month','select','');  	
			$op['etf_day'] = $arry2->select($DAY_WORK,$etf_day,'PHP_etf_day','select','');  	

			$op['submit_flag'] = "1";
		}   // END of ETF
	}   // end of IF order.status = 6 待 schedule確認 結束--------------

		$op['msg'] = $order->msg->get(2);		
		page_display($op,'027', $TPL_CFM_SCHEDULE_SHOW);	
			    	    
	break;

//-------------------------------------------------------------------------------------
    case "do_cfm_pd_schedule":
//-------------------------------------------------------------------------------------

// 確認排程後  改寫pdtion- ETS, ETF, FTY_SU  || 改寫 s_order -STATUS 7  ||  要寫入 capacity - schedule ;

		check_authority('027',"add");
		$parm = array(	"pd_id"		=>  $PHP_pd_id,
						"ets"		=>  $PHP_ets,
						"etf"		=>  $PHP_etf,
						"sub_con"	=> 	$PHP_sub_con,
				);


			$redir_str = $cgiself."?PHP_action=cfm_schedule_view&PHP_id=".$PHP_id."&cgiget=".$cgiget."&cgino=".$cgino."&cgi_1=".$cgi_1."&cgi_2=".$cgi_2."&cgi_3=".$cgi_3."&cgi_4=".$cgi_4."&cgi_5=".$cgi_5;


		// ++++++++++++======  寫入 排產 之工廠之 SU [FY_SU]  計算出月份 排產資料 fty_su ------------
		//  NOTE :++++++ 參數傳入 由html 送出 hidden 但要注意 format 有千位號的參數 要改參數名子[$PHP_qty]
		//  先取出 該筆 s_order 資料

			if(!$ord = $order->get($PHP_id)){
				$op['msg'] = $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			} 

			// 寫入 capacity ---------------
			// 檢查 capacity 檔內是否已經有記錄 ???
			$s_year = substr($parm['ets'],0,4);
			$e_year = substr($parm['etf'],0,4);
			for($i=$s_year;$i<$e_year+1;$i++){
				
				if (!$T=$capaci->get($ord['factory'], $i)) {
					$op['msg'] = $capaci->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  	
					
					exit;
//					break;	    
				}
			}
		//========= 同時寫入 capacity 內的 schedule 欄內 ===============		
		//   2005/08/31 改由資料庫抓 su [以 ie 計算填入 ]
//		$parm['fty_su'] = $order->divert_month_su($ord['qty'],$ord['su_ratio'],$parm['ets'],$parm['etf'],$ord['factory'],'schedule');
		$parm['fty_su'] = $order->distri_month_su($ord['su'],$parm['ets'],$parm['etf'],$ord['factory'],'schedule');

		$f1 = $order->add_cfm_pd_schedule($parm);   // 更新資料庫

		if (!$f1) {  // 沒有成功輸入資料時
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}   // end if (!$F1)---------  正確寫入  ------------------------------------


	//***********************************************************
	// 寫入 s_order - status 及 schedule的記錄
		// 如果 兩個日期都有了 [ETS][ETF]則更改 訂單的status為 6 >排產待確認 SCHDL CFMing
		//  要考慮========???? 萬一 瞬間斷電 ???? 或許沒寫入 改變時 ???????

		// 取出年碼... 以輸入時之年為年碼[兩位]
		$dt = decode_date(1);

		if($parm['ets'] && $parm['etf']){
			$argv = array(	"id"			=>  $PHP_id,
							"status"		=>  7,
							"schd_er"		=>	$GLOBALS['SCACHE']['ADMIN']['name'],
							"schd_date"		=>	$dt['date']
					);

				$A1 = $order->update_sorder_4_cfm_pd_schedule($argv);   // 更新 訂單狀況記錄  status =>7

			if (!$A1) {  // 沒有成功輸入資料時
				$op['msg'] = $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}  				

		}

//2006/03/20 發現log檔沒寫入order number 及寫錯 job代號 更正				
			if(!$ord_num= $order->get_field_value("order_num", $PHP_id)){  
				$op['msg'] = $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}  				
//echo "<br>order number ===>".$ord_num;
//exit;
	
	//***********************************************************
				# 記錄使用者動態
			$message = "Confirm order [ ".$ord_num." ] production schedule [ETS, ETF] ";

			$log->log_add(0,"37A",$message);

			// 改變 html 的呈現 ----- 不再出現 　確認的 button 及ets, etf 的日期下拉

				$op['ets_year'] = $parm['ets_year'];
				$op['ets_mon'] = $parm['ets_mon'];
				$op['ets_day'] = $parm['ets_day'];

				$op['etf_year'] = $parm['etf_year'];
				$op['etf_mon'] = $parm['etf_mon'];
				$op['etf_day'] = $parm['etf_day'];


			redirect_page($redir_str);

		break;













//-------------------------------------------------------------------------------------
//			 job 104  主副料進度
//-------------------------------------------------------------------------------------
    case "material_schedule":
    	check_authority('068',"view");
		$op['msg'] = $order->msg->get(2);

				// creat cust combo box
			if ($GLOBALS['SCACHE']['ADMIN']['dept']=='HJ' || $GLOBALS['SCACHE']['ADMIN']['dept']=='LY' || $GLOBALS['SCACHE']['ADMIN']['dept']=='CF')
			{
				$op['factory'] = $GLOBALS['SCACHE']['ADMIN']['dept'];
				$op['fty_flag']=1;
			}else{
				$op['factory'] = $arry2->select($FACTORY,'','PHP_factory','select','');  	
			}

		$where_str="order by cust_s_name"; //依cust_s_name排序
		$cust_def = $cust->get_fields('cust_init_name',$where_str);
		$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
		for ($i=0; $i< sizeof($cust_def); $i++)
		{
			$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
		}
		$op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue); 

//080725message增加		
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];

		page_display($op,'068', $TPL_MAT_SCHEDULE);    	    
		break;

//=======================================================
    case "mat_schedule_search":
		check_authority('068',"view");		
		$parm = array(	
						"order_num"		=>  $PHP_order_num,
						"cust"			=>	$PHP_cust,
						"ref"			=>	$PHP_ref,
						"factory"		=>	$PHP_factory,
				);

			if (!$op = $order->mat_schedule_search(1)) {    // 關聯式察尋 ==tabel s_order, pdtion
				$op['msg']= $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}

				$op['msg']= $order->msg->get(2);
				$op['cgi']= $parm;

			$allow = $admin->decode_perm('068');   // 設定 新增刪改權限
			page_display($op,'068', $TPL_MAT_SCHEDULE_LIST);  			
		break;
	
//=======================================================
	case "mat_schedule_view":
		check_authority('068',"view");		
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
		$op['account_dept'] = $user_dept;
		$op['cgi'] = array(	"cgiget"	=>  $cgiget,
							"cgino"		=>  $cgino,
							"cgi_1"		=>	$cgi_1,
							"cgi_2"		=>	$cgi_2,
							"cgi_3"		=>	$cgi_3,
							"cgi_4"		=>	$cgi_4,
							"cgi_5"		=>	$cgi_5,
				);
		$op['is_factory'] = is_dept($GLOBALS['SCACHE']['ADMIN']['dept']);
		$op['order'] = $order->mat_schedule_get($PHP_id);  // 關聯式 查尋 取出該筆記錄
		if (!$op['order']) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		// 取出 order_log 本訂單 之歷史50筆的計記錄  -------------------
		$logs = $order_log->search50($op['order']['order_num']);  //取出該訂單全部log記錄
		if (!$logs){
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['logs'] = $logs['order_log'];
		$op['log_records'] = $logs['records'];
			// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來判斷有無資料
		//--------------------------------


		$parm = $op['order'];

		// 計算 lead time
		$op['lead_time'] = countDays ($parm['etp'],$parm['etd']);


		// 加入返回前頁 2005/05/05
		$back_str = $cgiget."&PHP_sr_startno=".$cgino."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5;

		$op['back_str'] = $back_str;

			// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/picture/".$op['order']['order_num'].".jpg")){
			$op['main_pic'] = "./picture/".$op['order']['order_num'].".jpg";
		} else {
			$op['main_pic'] = "./images/graydot.gif";
		}

			// 計算  SU 供 html -----------------------------
		//   2005/08/31 改由資料庫抓 su [以 ie 計算填入 ]
		$su = $op['order']['su'];
		$op['order']['f_su'] = number_format($su, 0, '', ',');
		$op['order']['qty'] = number_format($op['order']['qty'], 0, '', ',');

	//--------------------------------------------------		
		// 設定 網頁上的 mat_shp 如何呈現 --- 如果已經有了mat_shp 則直接出現 如果沒有 就出現 今日出貨按鈕
		if(!$op['order']['mat_shp']){	$op['mat_not_shp'] = '1';  		} 
		if(!$op['order']['m_acc_shp']){	$op['macc_not_shp'] = '1';  	} 
		if(!$op['order']['acc_shp']){	$op['acc_not_shp'] = '1';		} 

	//  一些 其它的參數
		$op['cgino'] = $cgino;
		$op['id'] = $PHP_id;

		$op['msg'] = $order->msg->get(2);
		$op['search'] = '1';		
		
		if ($user_dept=="HJ" || $user_dept=="LY")//判斷進入者是否來自工廠,若來自工廠..則必須判斷是否有更改權限
		{
			if ($user_dept == $op['order']['dept'])$op['dept_edit']=1;			
		}else{
			$op['dept_edit']=1;
		}
		//print_r($op);
		if(isset($PHP_msg))$op['msg'][] = $PHP_msg;
		page_display($op,'068', $TPL_MAT_SCHEDULE_SHOW);	    	    
	break;

//-------------------------------------------------------------------------------------
    case "do_mat_schedule":

		check_authority('068',"add");
		$parm = array(	"pd_id"			=>  $PHP_pd_id,
										"mat_etd"		=>	$PHP_mat_etd,
										"order_num"	=>  $PHP_order_num,
										"macc_etd"	=>	$PHP_macc_etd,
										"acc_etd"		=>	$PHP_acc_etd,
										"mat_eta"		=>	$PHP_mat_eta,
										"macc_eta"	=>	$PHP_macc_eta,
										"acc_eta"		=>	$PHP_acc_eta,
				);

		
		if ($PHP_mat_etd=='' && $PHP_macc_etd=='' && $PHP_acc_etd=='') {  // 輸入資料 不正確時
			
			// 返回 order mat schedule 訂單 show	
			$msg = "Please choice one of the ETD date";
			$redir_str = $cgiself."?PHP_action=mat_schedule_view&PHP_id=".$PHP_id."&cgiget=".$cgiget."&cgino=".$cgino."&cgi_1=".$cgi_1."&cgi_2=".$cgi_2."&cgi_3=".$cgi_3."&cgi_4=".$cgi_4."&cgi_5=".$cgi_5."&PHP_msg=".$msg;
			redirect_page($redir_str);
			break;
		}  // end if  輸入資料 不正確 

		if ($PHP_mat_eta=='' && $PHP_macc_eta=='' && $PHP_acc_eta=='') {  // 輸入資料 不正確時
			
			// 返回 order mat schedule 訂單 show	
			$msg = "Please choice one of the ETA date";
			$redir_str = $cgiself."?PHP_action=mat_schedule_view&PHP_id=".$PHP_id."&cgiget=".$cgiget."&cgino=".$cgino."&cgi_1=".$cgi_1."&cgi_2=".$cgi_2."&cgi_3=".$cgi_3."&cgi_4=".$cgi_4."&cgi_5=".$cgi_5."&PHP_msg=".$msg;						
			redirect_page($redir_str);
			break;
		}  // end if  輸入資料 不正確 		

		if ($PHP_mat_eta < $PHP_mat_etd) {  // 輸入資料 不正確時
			
			// 返回 order mat schedule 訂單 show	
			$msg = "Fabric ETA must later than ETD ". $PHP_mat_eta.' < '.$PHP_mat_etd;
			$redir_str = $cgiself."?PHP_action=mat_schedule_view&PHP_id=".$PHP_id."&cgiget=".$cgiget."&cgino=".$cgino."&cgi_1=".$cgi_1."&cgi_2=".$cgi_2."&cgi_3=".$cgi_3."&cgi_4=".$cgi_4."&cgi_5=".$cgi_5."&PHP_msg=".$msg;						
			redirect_page($redir_str);
			break;
		}  // end if  輸入資料 不正確 		

		if ($PHP_macc_eta < $PHP_macc_etd) {  // 輸入資料 不正確時
			
			// 返回 order mat schedule 訂單 show	
			$msg = "Main Accessory ETA must later than ETD";
			$redir_str = $cgiself."?PHP_action=mat_schedule_view&PHP_id=".$PHP_id."&cgiget=".$cgiget."&cgino=".$cgino."&cgi_1=".$cgi_1."&cgi_2=".$cgi_2."&cgi_3=".$cgi_3."&cgi_4=".$cgi_4."&cgi_5=".$cgi_5."&PHP_msg=".$msg;						
			redirect_page($redir_str);
			break;
		}  // end if  輸入資料 不正確 			

		if ($PHP_acc_eta < $PHP_acc_etd) {  // 輸入資料 不正確時
			
			// 返回 order mat schedule 訂單 show	
			$msg = "Accessory ETA must later than ETD";
			$redir_str = $cgiself."?PHP_action=mat_schedule_view&PHP_id=".$PHP_id."&cgiget=".$cgiget."&cgino=".$cgino."&cgi_1=".$cgi_1."&cgi_2=".$cgi_2."&cgi_3=".$cgi_3."&cgi_4=".$cgi_4."&cgi_5=".$cgi_5."&PHP_msg=".$msg;						
			redirect_page($redir_str);
			break;
		}  // end if  輸入資料 不正確 	

		$f1 = $order->add_material_etd($parm);   // 更新資料庫

		if (!$f1) {  // 沒有成功輸入資料時

			$op['msg'] = $order->msg->get(2);

			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    

		break;

		}   // end if (!$F1)---------  正確寫入  ------------------------------------

				# 記錄使用者動態
			$message = "Writing material ETD on order : [ ".$parm['order_num']." ] 主副料之ETD及ETA";
			$log->log_add(0,"104A",$message);

			$redir_str = $cgiself."?PHP_action=mat_schedule_view&PHP_id=".$PHP_id."&cgiget=".$cgiget."&cgino=".$cgino."&cgi_1=".$cgi_1."&cgi_2=".$cgi_2."&cgi_3=".$cgi_3."&cgi_4=".$cgi_4."&cgi_5=".$cgi_5."&PHP_msg=".$message;

			redirect_page($redir_str);

		break;
//-------------------------------------------------------------------------------------
    case "mat_ship":

		check_authority('068',"edit");

			if(substr($PHP_order_num,0,1) == 'A' ||substr($PHP_order_num,0,1) == 'B' )
			{
				$op['msg'][] ='sales order can not receive on here.';

				$layout->assign($op);
				$layout->display($TPL_ERROR);  		  
				break;  
				
			}

			$D = decode_date(1,0);
			$to_day = $D['date'];
			$mat_etd = $order->get_field_value('mat_etd',$PHP_pd_id,'','pdtion');				
			if(!$mat_etd) $order->update_pdtion_field('mat_etd', '0000-00-00', $PHP_pd_id);

		$f1 = $order->mat_ship($PHP_pd_id, $to_day);   // 更新資料庫

		if (!$f1) {  // 沒有成功輸入資料時

			$op['msg'] = $order->msg->get(2);

			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    

		break;

		}   // end if (!$F1)---------  正確寫入  ------------------------------------

				# 記錄使用者動態
			$message = "Writing fabric received on order : [ ".$PHP_order_num." ]";
			$log->log_add(0,"104A",$message);

		$redir_str = $cgiself."?PHP_action=mat_schedule_view&PHP_id=".$PHP_id."&cgiget=".$cgiget."&cgino=".$cgino."&cgi_1=".$cgi_1."&cgi_2=".$cgi_2."&cgi_3=".$cgi_3."&cgi_4=".$cgi_4."&cgi_5=".$cgi_5;

		redirect_page($redir_str);

		break;

//-------------------------------------------------------------------------------------
    case "macc_ship":

		check_authority('068',"edit");
			if(substr($PHP_order_num,0,1) == 'A' ||substr($PHP_order_num,0,1) == 'B' )
			{
				$op['msg'][] ='sales order can not receive on here.';

				$layout->assign($op);
				$layout->display($TPL_ERROR);  		  
				break;  
				
			}
			$D = decode_date(1,0);
			$to_day = $D['date'];

		$macc_etd = $order->get_field_value('m_acc_etd',$PHP_pd_id,'','pdtion');				

		if(!$macc_etd) $order->update_pdtion_field('m_acc_etd', '0000-00-00', $PHP_pd_id);

		$f1 = $order->macc_ship($PHP_pd_id, $to_day);   // 更新資料庫

		if (!$f1) {  // 沒有成功輸入資料時

			$op['msg'] = $order->msg->get(2);

			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    

		break;

		}   // end if (!$F1)---------  正確寫入  ------------------------------------

				# 記錄使用者動態
			$message = "Writing main accessory received on order : [ ".$PHP_order_num." ]";
			$log->log_add(0,"104A",$message);

		$redir_str = $cgiself."?PHP_action=mat_schedule_view&PHP_id=".$PHP_id."&cgiget=".$cgiget."&cgino=".$cgino."&cgi_1=".$cgi_1."&cgi_2=".$cgi_2."&cgi_3=".$cgi_3."&cgi_4=".$cgi_4."&cgi_5=".$cgi_5;

		redirect_page($redir_str);

		break;


//-------------------------------------------------------------------------------------
    case "acc_ship":
		check_authority('068',"edit");

			if(substr($PHP_order_num,0,1) == 'A' ||substr($PHP_order_num,0,1) == 'B' )
			{
				$op['msg'][] ='sales order can not receive on here.';

				$layout->assign($op);
				$layout->display($TPL_ERROR);  		  
				break;  
				
			}
			$D = decode_date(1,0);
			$to_day = $D['date'];

		$acc_etd = $order->get_field_value('acc_etd',$PHP_pd_id,'','pdtion');				
		if($acc_etd =='0000-00-00' || !$acc_etd) $order->update_pdtion_field('acc_etd', $TODAY, $PHP_pd_id);


		$f1 = $order->acc_ship($PHP_pd_id, $to_day);   // 更新資料庫

		if (!$f1) {  // 沒有成功輸入資料時

			$op['msg'] = $order->msg->get(2);

			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    

		break;

		}   // end if (!$F1)---------  正確寫入  ------------------------------------

				# 記錄使用者動態
			$message = "Writing other accessory received on order : [ ".$PHP_order_num." ]";
			$log->log_add(0,"104A",$message);

		$redir_str = $cgiself."?PHP_action=mat_schedule_view&PHP_id=".$PHP_id."&cgiget=".$cgiget."&cgino=".$cgino."&cgi_1=".$cgi_1."&cgi_2=".$cgi_2."&cgi_3=".$cgi_3."&cgi_4=".$cgi_4."&cgi_5=".$cgi_5;

		redirect_page($redir_str);

		break;















//-------------------------------------------------------------------------------------
//			 job 36  生產排程
//-------------------------------------------------------------------------------------

#	NOTE: 必需設定進入的 user 身份 [ 不同工廠 ===== ============== ?????????????

//-------------------------------------------------------------------------------------
    case "pd_schedule":
		check_authority('026',"view");
//---------------------------------- 判斷是否工廠人員進入 ---------------
		$where_str = $manager = $dept_id = $fty_select = '';

		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 叛定進入身份的指標

		for ($i=0; $i<count($FACTORY);$i++){
			if($user_dept == $FACTORY[$i]){
				$dept_id = $FACTORY[$i];   // 如果是工廠部門人員進入 dept_id 指定該工廠---
			}
		}
		if (!$dept_id) {    // 當不是工廠人員進入時
			$manager = 1;
			$fty_select = $arry2->select($FACTORY,"","PHP_factory","select","");  //工廠 select選單
		} else {
			$where_str = " WHERE factory = '".$dept_id."' ";
		}

		$op['manager_flag'] = $manager;
		$op['fty_id'] = $dept_id;
		$op['fty_select'] = $fty_select;

		$op['msg'] = $order->msg->get(2);

		// creat cust combo box
		$where_str="order by cust_s_name"; //依cust_s_name排序
		$cust_def = $cust->get_fields('cust_init_name',$where_str);
		$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
		for ($i=0; $i< sizeof($cust_def); $i++)
		{
			$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
		}
		$op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue); 

//080725message增加		
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];
	
			page_display($op,'026', $TPL_SCHEDULE);	    	    
		break;



//=======================================================
    case "schedule_search":

		check_authority('026',"view");
		$parm = array(	"dept"			=>  $PHP_dept_code,
						"order_num"		=>  $PHP_order_num,
						"cust"			=>	$PHP_cust,
						"ref"			=>	$PHP_ref,
						"factory"		=>	$PHP_factory,
				);

			if (!$op = $order->schedule_search(1)) {
				$op['msg']= $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			// op 被清除了 需再判斷一次 

				$op['msg']= $order->msg->get(2);
				$op['cgi']= $parm;
			page_display($op,'026', $TPL_SCHEDULE_ORDER_LIST);
		break;

	

//=======================================================
	case "schedule_view":

		check_authority('026',"view");
		$op['cgi'] = array(	"cgiget"	=>  $cgiget,
							"cgino"		=>  $cgino,
							"cgi_1"		=>	$cgi_1,
							"cgi_2"		=>	$cgi_2,
							"cgi_3"		=>	$cgi_3,
							"cgi_4"		=>	$cgi_4,
							"cgi_5"		=>	$cgi_5,
				);
		
		$op['order'] = $order->schedule_get($PHP_id);  //取出該筆記錄
		if (!$op['order']) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		// 取出 order_log 本訂單 之歷史50筆的計記錄  -------------------
		$logs = $order_log->search50($op['order']['order_num']);  //取出該訂單全部log記錄
		if (!$logs){
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['logs'] = $logs['order_log'];
		$op['log_records'] = $logs['records'];
			// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來判斷有無資料
		//--------------------------------

		$parm = $op['order'];

		// 計算 lead time
		$op['lead_time'] = countDays ($parm['etp'],$parm['etd']);

		// 加入返回前頁 2005/05/05
		$back_str = $cgiget."&PHP_sr_startno=".$cgino."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5;

		$op['back_str'] = $back_str;
		$op['id'] = $PHP_id;


			// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/picture/".$op['order']['order_num'].".jpg")){
			$op['main_pic'] = "./picture/".$op['order']['order_num'].".jpg";
		} else {
			$op['main_pic'] = "./images/graydot.gif";
		}

			// 計算  SU 供 html -----------------------------
		//   2005/08/31 改由資料庫抓 su [以 ie 計算填入 ]
		$su = $op['order']['su'];
		$op['order']['f_su'] = number_format($su, 0, '', ',');
		$op['order']['qty'] = number_format($op['order']['qty'], 0, '', ',');

		
		if ($op['order']['ets'])$op['ets_flag']=1;
		// 設定 網頁上的 ets, etf 如何呈現 --- 如果已經有了 則直接出現 如果沒有就出現 下拉 可輸入
		if (!$op['order']['ets'] || !$op['order']['etf'] ) $op['submit_flag'] = "1";
		$op['msg'] = $order->msg->get(2);	
		page_display($op,'026', $TPL_SCHEDULE_SHOW);	    	    
	break;

//-------------------------------------------------------------------------------------
    case "do_pd_schedule":

		check_authority('026',"add");
		if (!isset($PHP_sub_con))$PHP_sub_con=0;
		$parm = array(	"pd_id"		=>  $PHP_pd_id,
						"ets"	=>  $PHP_ets,		
						"etf"	=>  $PHP_etf,
						"sub_con" => $PHP_sub_con
				);

		
		if (!$PHP_ets && !$PHP_etf) {  // 輸入資料 不正確時
			$op['msg'][] = "Please choice ETS or ETF date";
			// 返回 order schedule 訂單 show	

			$redir_str = $cgiself."?PHP_action=schedule_view&PHP_id=".$PHP_id."&cgiget=".$cgiget."&cgino=".$cgino."&cgi_1=".$cgi_1."&cgi_2=".$cgi_2."&cgi_3=".$cgi_3."&cgi_4=".$cgi_4."&cgi_5=".$cgi_5;


			redirect_page($redir_str);

			break;
		}  // end if  輸入資料 不正確 		

//2007-04-19 工廠可以任意改排程日期(但是在生產後就不能改)	
		$f1 = $order->add_pd_schedule_chk($parm);   // 更新資料庫
		if (!$f1) {  // 沒有成功輸入資料時

			$op['msg'] = $order->msg->get(2);

			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    

		break;

		}   // end if (!$F1)---------  正確寫入  ------------------------------------
	
		if ($PHP_status == 7)
		{
			$op['order'] = $order->schedule_get($PHP_ord_id);  //取出該筆記錄
			if (!$op['order']) {
				$op['msg'] = $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}

			$order->delete_month_su( $op['order']['ets'], $op['order']['etf'],$op['order']['su'],$op['order']['factory'],'schedule');
			$order->del_cfm_pd_schedule($PHP_pd_id);
		}
		$f1 = $order->add_pd_schedule($parm);   // 更新資料庫
		
		if (!$f1) {  // 沒有成功輸入資料時

			$op['msg'] = $order->msg->get(2);

			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    

		break;

		}   // end if (!$F1)---------  正確寫入  ------------------------------------

		// 如果 兩個日期都有了 [ETS][ETF]則更改 訂單的status為 6 >排產待確認 SCHDL CFMing
		//  要考慮========???? 萬一 瞬間斷電 ???? 或許沒寫入 改變時 ???????
		if($parm['ets'] && $parm['etf']){

			if(!$A1 = $order->update_field('status','6',$PHP_id)){;   // 更新 訂單狀況記錄  status =>4
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			
			if (!$A1) {  // 沒有成功輸入資料時
				$op['msg'] = $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}  				

		}

//2006/03/20 發現log檔沒寫入order number 及寫錯 job代號 更正

			// 取出訂單號碼 ------
			if(!$ord_num= $order->get_field_value("order_num", $PHP_pd_id,'',"pdtion")){  
				$op['msg'] = $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}  				
	

				# 記錄使用者動態
			$message = "Production schedule of ETP ETS write on [ ".$ord_num." ]  ";

			$log->log_add(0,"42A",$message);

			$redir_str = $cgiself."?PHP_action=schedule_view&PHP_id=".$PHP_id."&cgiget=".$cgiget."&cgino=".$cgino."&cgi_1=".$cgi_1."&cgi_2=".$cgi_2."&cgi_3=".$cgi_3."&cgi_4=".$cgi_4."&cgi_5=".$cgi_5;

			redirect_page($redir_str);

		break;


//-------------------------------------------------------------------------------------
	case "fabric_excel":

		if(!$admin->is_power('061',"view")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$parm = array(	"art_code"		=>  $PHP_art_code,
						"name"			=>  $PHP_name,
						"cat"			=>	$PHP_cat,
						"content"		=>	$PHP_content,
						"supl"			=>	$PHP_supl,
						"supl_ref"		=>	$PHP_supl_ref
				);

		if (!$fb = $fabric->search(1,'',3000)) {  // 2005/05/16 加入第三個參數 改變搜尋大小
			$op['msg']= $fabric->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$a = count($fb['fabric']);
		//echo "<br> count number.............".$a;

	
	
	require_once($config['root_dir']."/lib/spreadsheets/Worksheet.php");
	require_once($config['root_dir']."/lib/spreadsheets/Workbook.php");

	  function HeaderingExcel($filename) {
		  header("Content-type: application/vnd.ms-excel");
		  header("Content-Disposition: attachment; filename=$filename" );
		  header("Expires: 0");
		  header("Cache-Control: must-revalidate, post-check=0,pre-check=0");
		  header("Pragma: public");
		  }

	  // HTTP headers
	  HeaderingExcel('list.xls');
	 
	  // Creating a workbook
	  $workbook = new Workbook("-");

	  // Creating the first worksheet
	  $worksheet1 =& $workbook->add_worksheet('fabric');

	// 寫入 title

	  // Format for the headings
	  $formatot =& $workbook->add_format();
	  $formatot->set_size(10);
	  $formatot->set_align('center');
	  $formatot->set_color('white');
	  $formatot->set_pattern();
	  $formatot->set_fg_color('navy');

	  $worksheet1->set_column(0,0,15);
	  $worksheet1->set_column(0,1,10);
	  $worksheet1->set_column(0,2,20);
	  $worksheet1->set_column(0,3,10);
	  $worksheet1->set_column(0,4,10);

	  $worksheet1->set_column(0,5,30);
	  $worksheet1->set_column(0,6,10);
	  $worksheet1->set_column(0,7,20);
	  $worksheet1->set_column(0,8,15);
	  $worksheet1->set_column(0,9,15);
	  $worksheet1->set_column(0,10,10);
	  $worksheet1->set_column(0,11,15);
	  $worksheet1->set_column(0,12,15);
	  $worksheet1->set_column(0,13,10);
	  $worksheet1->set_column(0,14,30);

	  $worksheet1->write_string(1,0,"Artical",$formatot);
	  $worksheet1->write_string(1,1,"category",$formatot);
	  $worksheet1->write_string(1,2,"Art. name",$formatot);
	  $worksheet1->write_string(1,3,"suplier.",$formatot);
	  $worksheet1->write_string(1,4,"suplier ref.",$formatot);

	  $worksheet1->write_string(1,5,"content",$formatot);
	  $worksheet1->write_string(1,6,"construct",$formatot);
	  $worksheet1->write_string(1,7,"finish",$formatot);
	  $worksheet1->write_string(1,8,"width",$formatot);
	  $worksheet1->write_string(1,9,"weight",$formatot);
	  $worksheet1->write_string(1,10,"source",$formatot);
	  $worksheet1->write_string(1,11,"price",$formatot);
	  $worksheet1->write_string(1,12,"term",$formatot);
	  $worksheet1->write_string(1,13,"leadtime",$formatot);
	  $worksheet1->write_string(1,14,"remark",$formatot);




	for ($i=0;$i<sizeof($fb['fabric']);$i++){
		$art_code = $fb['fabric'][$i]['art_code'];
		$cat = $fb['fabric'][$i]['cat'];
		$supl = $fb['fabric'][$i]['supl'];
		$supl_ref = $fb['fabric'][$i]['supl_ref'];
		$name = $fb['fabric'][$i]['name'];
		$content = $fb['fabric'][$i]['content'];
		$construct = $fb['fabric'][$i]['construct'];
		$finish = $fb['fabric'][$i]['finish'];
		$width = $fb['fabric'][$i]['width'].' '.$fb['fabric'][$i]['width_unit'];
		$weight = $fb['fabric'][$i]['weight'].' '.$fb['fabric'][$i]['unit_wt'];
		$construct = $fb['fabric'][$i]['construct'];
		$co = $fb['fabric'][$i]['co'];
		if ($fb['fabric'][$i]['price']){
			$price = $fb['fabric'][$i]['currency'].' '.$fb['fabric'][$i]['price'].'/'.$fb['fabric'][$i]['unit_price'];
		}else{
			$price = '';
		}
		$term = $fb['fabric'][$i]['term'].' '.$fb['fabric'][$i]['location'];
		if ($fb['fabric'][$i]['leadtime']){
			$leadtime = $fb['fabric'][$i]['leadtime'].' days';
		}else{
			$leadtime = '';
		}
		$remark = $fb['fabric'][$i]['remark'];


	  $worksheet1->write_string($i+2,0,$art_code);
	  $worksheet1->write_string($i+2,1,$cat);
	  $worksheet1->write_string($i+2,2,$name);
	  $worksheet1->write_string($i+2,3,$supl);
	  $worksheet1->write_string($i+2,4,$supl_ref);
	  $worksheet1->write_string($i+2,5,$content);
	  $worksheet1->write_string($i+2,6,$construct);
	  $worksheet1->write_string($i+2,7,$finish);
	  $worksheet1->write_string($i+2,8,$width);
	  $worksheet1->write_string($i+2,9,$weight);
	  $worksheet1->write_string($i+2,10,$co);
	  $worksheet1->write_string($i+2,11,$price);
	  $worksheet1->write_string($i+2,12,$term);
	  $worksheet1->write_string($i+2,13,$leadtime);
	  $worksheet1->write_string($i+2,14,$remark);

	
	
	}


  $workbook->close();


	break;


//-------------------------------------------------------------------------------------
	case "fabric_print_search":

		if(!$admin->is_power('061',"view")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

			// creat cust combo box
		$op['select_cat'] = $arry2->select($FABRIC_CAT,'','PHP_cat','select','');  	
			// create combo box for vendor fields.....
			$where_str =" WHERE supl_cat ='主料' ";
			$supl_def = $supl->get_fields('supl_s_name',$where_str);   // 取出 供應商類別代號
		$op['select_supl'] = $arry2->select($supl_def,'','PHP_supl','select','');  	

		$op['msg']= $fabric->msg->get(2);

		$allow = $admin->decode_perm('061');   // 設定 新增刪改權限
		if ($op['msg']){ $op['msg_YES'] = 1; } else { $op['msg_YES'] = "" ;}
		if ($allow['view'])		{	$op['view_flag'] = 1;} else {	$op['view_flag'] = "";}
		if ($allow['add'])		{	$op['add_flag'] = 1;} else {	$op['add_flag'] = "";}
		if ($allow['edit'])		{	$op['edit_flag'] = 1;} else {	$op['edit_flag'] = "";}
		if ($allow['del'])		{	$op['del_flag'] = 1;} else {	$op['del_flag'] = "";}
		$layout->assign($op);
		$layout->display($TPL_FABRIC_PRINT_SEARCH);		    	    

	break;

//=======================================================
    case "do_fabric_print_search":

		if(!$admin->is_power('061',"view")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$parm = array(	"art_code"		=>  $PHP_art_code,
						"name"			=>  $PHP_name,
						"cat"			=>	$PHP_cat,
						"content"		=>	$PHP_content,
						"finish"		=>	$PHP_finish,
						"supl"			=>	$PHP_supl,
						"supl_ref"		=>	$PHP_supl_ref
				);
		if (!$op = $fabric->search(1)) {
			$op['msg']= $fabric->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

			$op['msg']= $fabric->msg->get(2);
			$op['cgi']= $parm;

		$allow = $admin->decode_perm('061');   // 設定 新增刪改權限
		if ($op['msg']){ $op['msg_YES'] = 1; } else { $op['msg_YES'] = "" ;}
		if ($allow['view'])		{	$op['view_flag'] = 1;} else {	$op['view_flag'] = "";}
		if ($allow['add'])		{	$op['add_flag'] = 1;} else {	$op['add_flag'] = "";}
		if ($allow['edit'])		{	$op['edit_flag'] = 1;} else {	$op['edit_flag'] = "";}
		if ($allow['del'])		{	$op['del_flag'] = 1;} else {	$op['del_flag'] = "";}
//$op['NEXT_page'] = 1;
//$op['PREV_page'] = 1;

			$layout->assign($op);
			$layout->display($TPL_FABRIC_PRINT_LIST);  
		break;

//=======================================================
    case "fabric_label_print":
		if(!$admin->is_power('061',"view")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$a_code = array();
		$a_copy = array();
		$records = array();


		// 網頁送入 $labels, $numbers, $rows
		$a_code = explode(',',$labels);
		$a_copy = explode(',',$numbers);
		
		for($i=0;$i<$rows;$i++){
			if($a_copy[$i]){
				
				//-------------------- 將 布料 資料 由資料庫取出 ------------------
					if (!$fb = $fabric->get($a_code[$i])) {  //取出該筆 布料記錄
						$op['msg'] = $fabric->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
					}
				for($j=0;$j<$a_copy[$i];$j++){
					$records[] = array(		$fb['art_code'],
											$fb['content'],
											$fb['construct'],
											$fb['width'].' '.$fb['width_unit'],
											$fb['weight'].' '.$fb['unit_wt'],
											$fb['finish']	);

				}  // end for $j
			}  // end if

		}  // end for $i

		$copies = count($records);



	//  開始 設定 pdf 檔
	include($config['root_dir']."/lib/class.pdf_fabric.php");

	$pdf=new PDF_fabric();

	$pdf->SetAutoPageBreak('auto',0);
	$pdf->Open();
	$pdf->AddPage();

	$pdf->SetMargins(0,0,0);

	$w1 = 10;
	$h1 = 5;
	$w2 = 30;
	$h2 = 5;

	$x =0;
	$y =0;

	$title = array('Art. No:','Composition:','Construction:','Width:','Weight:','Finished:');
//	$field = array('FK05W-0610','100% POLYESTER','213X106/75DX150D','61 inch','230 g/yd.','MICROFIBER,SANDING,W/R');

	$left = '1';
	$y = 0;

	for ($i=0;$i<$copies;$i++){
			 // 格線
			 $pdf->SetDrawColor(200,200,200);
			 $pdf->Line(105, 0, 105, 297); 
			 $pdf->Line(0, 37.125, 210, 37.125); 
			 $pdf->Line(0, 74.250, 210, 74.250); 
			 $pdf->Line(0, 111.375, 210, 111.375); 
			 $pdf->Line(0, 148.5, 210, 148.5); 
			 $pdf->Line(0, 185.625, 210, 185.625); 
			 $pdf->Line(0, 222.750, 210, 222.750); 
			 $pdf->Line(0, 259.875, 210, 259.875); 

		 if ($left=='1'){
			$x =0;
			$pdf->record($x,$y,$w1,$h1,$w2,$h2,$title,$records[$i]);
			$left = '';
		 } else {
			$x =105;
			$pdf->record($x,$y,$w1,$h1,$w2,$h2,$title,$records[$i]);
			$left = 1;
			$y= $y + 37.125;
		 }
		 if($y == '297'){ 
			$pdf->AddPage(); 

			$y = 0;
		 }

	}

	$pdf->Output();

	
break;



//=======================================================
    case "fabric_label":
		if(!$admin->is_power('061',"view")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

	$records = array();
	
	$num_art = count($PHP_print_id);
	$copies = 0;

	for ($i=0;$i<$num_art;$i++){
		if ($PHP_print_copy[$PHP_print_id[$i]]){
		
		//-------------------- 將 布料 資料 由資料庫取出 ------------------
			if (!$fb = $fabric->get($PHP_print_id[$i])) {  //取出該筆 布料記錄
				$op['msg'] = $fabric->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			for ($j=0;$j<($PHP_print_copy[$PHP_print_id[$i]]);$j++){
				$records[] = array(	$fb['art_code'],
									$fb['content'],
									$fb['construct'],
									$fb['width'].' '.$fb['width_unit'],
									$fb['weight'].' '.$fb['unit_wt'],
									$fb['remark']	);

			}


			$copies = $copies + $PHP_print_copy[$PHP_print_id[$i]];
		}
	}


	//  開始 設定 pdf 檔
	include_once($config['root_dir']."/lib/class.pdf_fabric.php");

	$pdf=new PDF_fabric();

	$pdf->SetAutoPageBreak('auto',0);
	$pdf->Open();
	$pdf->AddPage();

	$pdf->SetMargins(0,0,0);

	$w1 = 10;
	$h1 = 5;
	$w2 = 30;
	$h2 = 5;

	$x =0;
	$y =0;

	$title = array('Art. No:','Composition:','Construction:','Width:','Weight:','Remark:');
	$field = array('FK05W-0610','100% POLYESTER','213X106/75DX150D','61 inch','230 g/yd.','MICROFIBER,SANDING,W/R');

	$times = 39;
	$left = '1';
	$y = 0;

	for ($i=0;$i<$copies;$i++){
			 // 格線
			 $pdf->SetDrawColor(200,200,200);
			 $pdf->Line(105, 0, 105, 297); 
			 $pdf->Line(0, 37.125, 210, 37.125); 
			 $pdf->Line(0, 74.250, 210, 74.250); 
			 $pdf->Line(0, 111.375, 210, 111.375); 
			 $pdf->Line(0, 148.5, 210, 148.5); 
			 $pdf->Line(0, 185.625, 210, 185.625); 
			 $pdf->Line(0, 222.750, 210, 222.750); 
			 $pdf->Line(0, 259.875, 210, 259.875); 

		 if ($left=='1'){
			$x =0;
			$pdf->record($x,$y,$w1,$h1,$w2,$h2,$title,$records[$i]);
			$left = '';
		 } else {
			$x =105;
			$pdf->record($x,$y,$w1,$h1,$w2,$h2,$title,$records[$i]);
			$left = 1;
			$y= $y + 37.125;
		 }
		 if($y == '297'){ 
			$pdf->AddPage(); 

			$y = 0;
		 }

	}

	$pdf->Output();

	
break;





//-------------------------------------------------------------------------------------
    case "test2":

//  開始 設定 pdf 檔
include_once($config['root_dir']."/lib/class.pdf_fabric.php");
//$pdf=new PDF_fabric('P','mm','A4');
$pdf=new PDF_fabric();
//$pdf->AddBig5Font();
$pdf->SetAutoPageBreak('auto',0);
$pdf->Open();
$pdf->AddPage();
//$pdf->SetFont('Arial','B',14);

	$pdf->SetMargins(0,0,0);

$w1 = 10;
$h1 = 5;
$w2 = 30;
$h2 = 5;

$x =0;
$y =0;

$title = array('Art. No:','Composition:','Construction:','Width:','Weight:','Remark:');
//$field = array('FK05W-0610','100% POLYESTER','213X106/75DX150D','61 inch','230 g/yd.','MICROFIBER,SANDING,W/R');

	$times = 39;
	$left = '1';
	$y = 0;

for ($i=0;$i<$copies;$i++){
		 // 格線
		 $pdf->SetDrawColor(200,200,200);
		 $pdf->Line(105, 0, 105, 297); 
		 $pdf->Line(0, 37.125, 210, 37.125); 
		 $pdf->Line(0, 74.250, 210, 74.250); 
		 $pdf->Line(0, 111.375, 210, 111.375); 
		 $pdf->Line(0, 148.5, 210, 148.5); 
		 $pdf->Line(0, 185.625, 210, 185.625); 
		 $pdf->Line(0, 222.750, 210, 222.750); 
		 $pdf->Line(0, 259.875, 210, 259.875); 

	 if ($left=='1'){
		$x =0;
		$pdf->record($x,$y,$w1,$h1,$w2,$h2,$title,$records[$i]);
		$left = '';
	 } else {
		$x =105;
		$pdf->record($x,$y,$w1,$h1,$w2,$h2,$title,$records[$i]);
		$left = 1;
		$y= $y + 37.125;
	 }
	 if($y == '297'){ 
		$pdf->AddPage(); 

		$y = 0;
	 }

}

$pdf->Output();

	break;
	




//-------------------------------------------------------------------------------------
//		BOM  生產用料  [4, 1 ]
//-------------------------------------------------------------------------------------
	
	case "search_pa_fab":   //  找出BOM己有請購的主料的請購單列表.......

		check_authority('022',"view");

			if (!$op = $apply->search_fab_bom($PHP_id,$PHP_num)) {
				$op['msg']= $wi->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
		page_display($op,'022', $TPL_BOM_PA_LIST);
		break;

//=======================================================
	
	case "search_pa_acc":   //  找出BOM己有請購的主料的請購單列表.......

		check_authority('022',"view");

			if (!$op = $apply->search_acc_bom($PHP_id,$PHP_num)) {
				$op['msg']= $wi->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
		page_display($op,'022', $TPL_BOM_PA_LIST);
		break;

//=======================================================
    case "bom_view":

		check_authority('022',"view");
		//-------------------- 將 製造令 show out ------------------
		//  wi 主檔
	if (isset($PHP_id))
	{
		if(!$op['wi'] = $wi->get($PHP_id)){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
	}else{	
		if(!$op['wi']  = $wi->get(0,$PHP_bom_num)){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
	}
		//  smpl 樣本檔
		if(!$op['smpl'] = $order->get($op['wi']['smpl_id'])){
					$op['msg']= $order->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
		$op['trim_des'] = $order_log->get_multi($op['wi']['wi_num'],'trim-rjt');
		

		
		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);
		
		//  wi_qty 數量檔			
			$where_str2 = " WHERE ord_num = '".$op['wi']['wi_num']."' ORDER BY p_etd";
			$p_id = $order->get_fields('id', $where_str2,'order_partial');
			$p_etd = $order->get_fields('p_etd', $where_str2,'order_partial');
			$op['num_colors'] = $op['total'] =0; $op['g_ttl'] = 0;
			for($i=0; $i<sizeof($sizing); $i++)$op['size_ttl'][$i]=0;
			$k=0;
			for($i=0; $i<sizeof($p_id); $i++)
			{
				$where_str3 =" WHERE wi_id='".$op['wi']['id']."'  AND p_id='".$p_id[$i]."'";
				$T_wiqty = $wiqty->search(1,$where_str3);
				$num_colors = count($T_wiqty);
				$op['num_colors'] += $num_colors;
				$op['partial'][$i]['size'] = $num_colors;
				$op['partial'][$i]['etd'] = $p_etd[$i];
				//-------------------- 整理 供 title 部份的資料 ----------------------------------
				for ($j=0;$j<$num_colors;$j++){					
					$op['color'][$k]['name'] = $T_wiqty[$j]['colorway'];
					$T_qty = explode(",", $T_wiqty[$j]['qty']);
					$op['color'][$k]['qty'] = array_sum($T_qty);
					$k++;
				}
				// 做出 size table-------------------------------------------
				$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size'],$p_etd[$i]);
				$op['show_breakdown'][$i] = $reply['html'];				
				$op['total'] += $reply['total'];
				for($j=0; $j<sizeof($sizing); $j++)
				{
					$op['g_ttl'] += $reply['size_ttl'][$j];				
					$op['size_ttl'][$j] +=$reply['size_ttl'][$j];
				}				
			}

		//-------------------- 整理 供 title 部份的資料 ----------------------------------
		
		//-----------------------------------------------------------------

		// 相片的URL決定 ------------------------------------------------------
				$style_dir	= "./picture/";  
				$no_img		= "./images/graydot.gif";
			if(file_exists($style_dir.$op['wi']['style_code'].".jpg")){
				$op['wi']['pic_url'] = $style_dir.$op['wi']['style_code'].".jpg";
			} else {
				$op['wi']['pic_url'] = $no_img;
			}
					
		//  取出主料用料記錄 --------------------------------------------------------------
		 $op['lots_NONE']= '';
		$where_str = " WHERE smpl_code = '".$op['wi']['style_code']."' ";
		$lots_used['lots_use'] = $smpl_lots->search(0,$where_str);  //取出該筆 樣本主料記錄
		
		if (!is_array($lots_used['lots_use'])) {
			$op['msg'] = $smpl_lots->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['mat_support'] = 0;
		for($i=0; $i<sizeof($lots_used['lots_use']); $i++)
		{
			if(	$lots_used['lots_use'][$i]['support'] > 0)$op['mat_support'] = 1;
		}
		$num_lots_used = count($lots_used['lots_use']);
		if (!$num_lots_used){	$op['lots_NONE'] = "1";		}

		//  取出副料用料記錄 --------------------------------------------------------------
		 $op['acc_NONE']= '';
		$where_str = " WHERE smpl_code = '".$op['wi']['style_code']."' ";
		$acc_used['acc_use'] = $smpl_acc->search(0,$where_str);  //取出該筆 樣本主料記錄
		for($i=0; $i<sizeof($acc_used['acc_use']); $i++)
		{
			if($acc_used['acc_use'][$i]['support'] > 0)$op['mat_support'] = 1;
		}
		if (!is_array($acc_used['acc_use'])) {     
			$op['msg'] = $smpl_acc->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_acc_used = count($acc_used['acc_use']);
		if (!$num_acc_used){	$op['acc_NONE'] = "1";		}

		//  取出  BOM  主料記錄 --------------------------------------------------------------

		$op['pa'] = $op['cust_rcv'] = '';
		 $op['bom_lots_NONE']= '';
		$where_str = " WHERE wi_id = '".$op['wi']['id']."' ";
		$bom_lots = $bom->search_lots(0,$where_str);  //取出該筆 bom 內ALL主料記錄
		for ($pi=0; $pi<sizeof($bom_lots['lots']); $pi++)
		{
			if ($bom_lots['lots'][$pi]['ap_mark'] <> '')
			{
				$op['pa'] = 1;
				break;
			}			
		}
		if (!is_array($bom_lots['lots'])) {
			$op['msg'] = $bom->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_bom_lots = count($bom_lots['lots']);
		if (!$num_bom_lots){	$op['bom_lots_NONE'] = "1";		}

		//  取出  BOM  副料記錄 --------------------------------------------------------------
		 $op['bom_acc_NONE']= '';
		$where_str = " WHERE wi_id = '".$op['wi']['id']."' ";
		$bom_acc = $bom->search_acc(0,$where_str);  //取出該筆 bom 內ALL副料記錄

		for ($pi=0; $pi<sizeof($bom_acc['acc']); $pi++)
		{
			if ($bom_acc['acc'][$pi]['ap_mark'] <> '' || $op['pa'] == 1)
			{
				$op['pa'] = 1;
				break;
			}
		}

		if (!is_array($bom_acc['acc'])) {
			$op['msg'] = $bom->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$num_bom_acc = count($bom_acc['acc']);
		if (!$num_bom_acc){	$op['bom_acc_NONE'] = "1";		}



		// --------------- 主料 ------------ 做出 $bom_lots_list[]  array....
			$op['bom_lots_list'] = array();
		if (!$op['lots_NONE']){   // 樣本有主料用料記錄---
			$op['bom_lots_list'] =  bom_lots_view($num_lots_used,$bom_lots['lots'],$lots_used['lots_use'],$op['num_colors']);
		}   
		// ---------------------- end BOM data layout [主料] ----------------------------

		// --------------- 副料 ------------ 做出 $bom_acc_list[]  array....
			$op['bom_acc_list'] = array();
		if (!$op['acc_NONE']){   // 樣本有副料用料記錄---
			$op['bom_acc_list'] =  bom_acc_view($num_acc_used,$bom_acc['acc'],$acc_used['acc_use'],$op['num_colors']);
		}  
		// ---------------------- end BOM data layout [副料] ----------------------------


			// 表格 改進用 -----
			if (!$num_colors){	
				$op['total_fields'] = 10;   // BOM table的總欄位數
			}else{
				$op['total_fields'] = 9 + $op['num_colors'];   // BOM table的總欄位數
			}


		//  取出  BOM  加購記錄 --------------------------------------------------------------
		$op['ext_mat_NONE']= '';
		$op['ext_mat'] = $po->get_ext_ap($op['wi']['wi_num']);  //取出該筆 bom 內ALL加購記錄
		$num_ext_mat = count($op['ext_mat']);
		if (!$num_ext_mat){	$op['ext_mat_NONE'] = "1";}

		//  取出  BOM  預先採購記錄 --------------------------------------------------------------
		$op['pp_mat_NONE']= '';
		$op['pp_mat'] = $po->get_pp_ap($op['wi']['wi_num']);  //取出該筆 bom 內ALL加購記錄
		$num_ext_mat = count($op['pp_mat']);
		if (!$num_ext_mat){	$op['pp_mat_NONE'] = "1";}

		//  取出  BOM  Disable計錄中己採購主料者 --------------------------------------------------------------
		$op['dis_lots_NONE']= '';
		$op['dis_lots'] = $bom->get_dis_lots($op['wi']['id']);  //取出該筆 bom 內記錄
		$num_lots = count($op['dis_lots']);
		if (!$num_lots){	$op['dis_lots_NONE'] = "1";}

		//  取出  BOM  Disable計錄中己採購副料者 --------------------------------------------------------------
		$op['dis_acc_NONE']= '';
		$op['dis_acc'] = $bom->get_dis_acc($op['wi']['id']);  //取出該筆 bom 內記錄
		$num_acc = count($op['dis_acc']);
		if (!$num_acc){	$op['dis_acc_NONE'] = "1";}




		$op['done']=$fils->get_bom_file($op['wi']['wi_num']);


		$op['bom_log'] = $bom->get_log($op['wi']['id']);

		if (isset($PHP_ex_order))
		{
			$op['edit_non']=1;
		}
		
		if($op['wi']['bom_status'] == 2 && $op['wi']['bsub_user'] == $GLOBALS['SCACHE']['ADMIN']['login_id']) $op['revise_flag'] = 1;
		if($op['wi']['bcfm_user_id'] == $GLOBALS['SCACHE']['ADMIN']['login_id']) $op['revise_flag'] = 1;
		if($GLOBALS['SCACHE']['ADMIN']['dept'] == 'SA')$op['revise_flag'] = 1;
		if(isset($PHP_msg))$op['msg'][] = $PHP_msg;
		if(isset($PHP_cfm_view))
		{
			$op['pp']=$PHP_sr;
			page_display($op,'022', $TPL_BOM_CFM_VIEW);
		}else{
			page_display($op,'022', $TPL_BOM_VIEW);		    	    
		}
		break;



//=======================================================
    case "pa_bom_det":

		check_authority('022',"view");
		//-------------------- 將 製造令 show out ------------------
		//  wi 主檔
	if (isset($PHP_id))
	{
		if(!$op['wi'] = $wi->get($PHP_id)){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
	}else{	
		if(!$op['wi']  = $wi->get(0,$PHP_bom_num)){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
	}
		//  smpl 樣本檔
		if(!$op['order'] = $order->get($op['wi']['smpl_id'])){
					$op['msg']= $order->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
		$size_data=$size_des->get($op['order']['size']);		
		$op['order']['size']=$size_data['size_scale'];

		//-----------------------------------------------------------------

		// 相片的URL決定 ------------------------------------------------------
				$style_dir	= "./picture/";  
				$no_img		= "./images/graydot.gif";
			if(file_exists($style_dir.$op['wi']['style_code'].".jpg")){
				$op['wi']['pic_url'] = $style_dir.$op['wi']['style_code'].".jpg";
			} else {
				$op['wi']['pic_url'] = $no_img;
			}
		//  取出  BOM  主料記錄 --------------------------------------------------------------
		 $op['bom_lots_NONE']= '';
	 	 $op['bom_lots'] = $apply->get_lots_det($op['wi']['id']);  //取出該筆 bom 內ALL主料記錄
		 $num_bom_lots = count($op['bom_lots']);
		 if (!$num_bom_lots){	$op['bom_lots_NONE'] = "1";		}
		 if (isset($PHP_pa_num))
		 {
		 	for ($i =0; $i< sizeof($op['bom_lots']); $i++)
		 	{
		 			if ($op['bom_lots'][$i]['ap_mark'] == $PHP_pa_num) $op['bom_lots'][$i]['ln_mk'] = 1;
		 			if ($op['bom_lots'][$i]['spec_ap'])
		 			{
		 				for ($k =0; $k< sizeof($op['bom_lots'][$i]['spec_ap']); $k++)
		 				{
		 					if ($op['bom_lots'][$i]['spec_ap'][$k]['ap_num'] == $PHP_pa_num) $op['bom_lots'][$i]['ln_mk'] = 1;
		 				}
		 			}
		 	}
		 }

		//  取出  BOM  副料記錄 --------------------------------------------------------------
		$op['bom_acc_NONE']= '';
		$op['bom_acc'] = $apply->get_acc_det($op['wi']['id']);  //取出該筆 bom 內ALL副料記錄
		$num_bom_acc = count($op['bom_acc']);
		if (!$num_bom_acc){	$op['bom_acc_NONE'] = "1";		}

		 if (isset($PHP_pa_num))
		 {
		 	for ($i =0; $i< sizeof($op['bom_acc']); $i++)
		 	{
		 			if ($op['bom_acc'][$i]['ap_mark'] == $PHP_pa_num) $op['bom_acc'][$i]['ln_mk'] = 1;
		 			if ($op['bom_acc'][$i]['spec_ap'])
		 			{
		 				for ($k =0; $k< sizeof($op['bom_acc'][$i]['spec_ap']); $k++)
		 				{
		 					if ($op['bom_acc'][$i]['spec_ap'][$k]['ap_num'] == $PHP_pa_num) $op['bom_acc'][$i]['ln_mk'] = 1;
		 				}
		 			}
		 	}
		 }

		//  取出  BOM  加購記錄 --------------------------------------------------------------
		$op['ext_mat_NONE']= '';
		$op['ext_mat'] = $apply->get_ext_ap($op['wi']['wi_num']);  //取出該筆 bom 內ALL加購記錄
		$num_ext_mat = count($op['ext_mat']);
		if (!$num_ext_mat){	$op['ext_mat_NONE'] = "1";		}
		
		 if (isset($PHP_pa_num))
		 {
		 	for ($i =0; $i< sizeof($op['ext_mat']); $i++)
		 	{
		 			if ($op['ext_mat'][$i]['ap_num'] == $PHP_pa_num) $op['ext_mat'][$i]['ln_mk'] = 1;
		 	}
		 }		
		
		page_display($op,'022', $TPL_BOM_PA_VIEW);
		break;










//=========================================================================
	case "do_wi_add_2":

		check_authority('019',"add");

		//------------------------------------ 完成寫入 wi 及 用料預估---------------
		// 將 製造令 完整show out ------
		//  wi 主檔
		if(!$op = $wi->get_all($PHP_wi_id)){
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}

//--------------------------------------------------------------------------
		//  wi_qty 數量檔
			$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		$T_wiqty = $wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);

		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
		$op['show_breakdown'] = $reply['html'];
		$op['total'] = $reply['total'];
		//-----------------------------------------------------------------

		# 記錄使用者動態
		$message = "Successfully add full w/i : ".$op['wi']['wi_num']."record。";
		$log->log_add(0,"31A",$message);
		$op['msg'][] = $message;
		$op['back_str']=$PHP_back_str;
		$op['back_str2']=$PHP_back_str2;
		page_display($op, '019', $TPL_WI_VIEW);
		break;
	

//========================================================================================	
case "wi_view":
check_authority('019',"view");
		
		//print_r($_GET);
		if(isset($PHP_p_id))$_SESSION['partial_id'] = $PHP_p_id;	//order_partial的ID
		// 將 製造令 完整show out ------
		//  wi 主檔
		if( empty($PHP_mks) ) $PHP_mks = 'A';
		if(is_numeric($PHP_id)){
			if(!$op = $wi->get_all($PHP_id,0,$PHP_mks)){    //取出該筆 製造令記錄 ID
						$op['msg']= $wi->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
			}
		} else {
			if(!$op = $wi->get_all(0,$PHP_id,$PHP_mks)){    //取出該筆 製造令記錄 WI_NUM
				$op['msg']= $wi->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);
				break;
			}
		}

//--------------------------------------------------------------------------
		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);
		
		//  wi_qty 數量檔
		$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		if($_SESSION['partial_id'])
		{
			$where_str .=" AND p_id='".$_SESSION['partial_id']."'";
			$T_wiqty = $wiqty->search(1,$where_str);
			$num_colors = count($T_wiqty);
			// 做出 size table-------------------------------------------
			$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
			$op['show_breakdown'][0] = $reply['html'];
			$op['total'] = $reply['total'];			
		}else{
			$where_str2 = " WHERE ord_num = '".$op['wi']['wi_num']."' ORDER BY p_etd";
			$p_id = $order->get_fields('id', $where_str2,'order_partial');
			$p_etd = $order->get_fields('p_etd', $where_str2,'order_partial');
			$op['total'] =0; $op['g_ttl'] = 0;
			for($i=0; $i<sizeof($sizing); $i++)$op['size_ttl'][$i]=0;
			for($i=0; $i<sizeof($p_id); $i++)
			{
				$where_str3 =$where_str." AND p_id='".$p_id[$i]."'";
				$T_wiqty = $wiqty->search(1,$where_str3);
				$num_colors = count($T_wiqty);
				// 做出 size table-------------------------------------------
				$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size'],$p_etd[$i]);
				$op['show_breakdown'][$i] = $reply['html'];
				$op['total'] += $reply['total'];
				for($j=0; $j<sizeof($sizing); $j++)
				{
					$op['g_ttl'] += $reply['size_ttl'][$j];				
					$op['size_ttl'][$j] +=$reply['size_ttl'][$j];
				}
				
			}
		}
		//-----------------------------------------------------------------
		//儲存完返回submit頁面
		//$op['back_PHP_action'] = $_GET['PHP_action'];
		$op['back_PHP_id'] = $_GET['PHP_id'];
		//$op['back_PHP_style_code'] = $_GET['PHP_style_code'];
		//$op['back_PHP_sr'] = $_GET['PHP_sr'];
		//$op['back_PHP_cfm_view'] = $_GET['PHP_cfm_view'];
		//$op['back_PHP_p_id'] = $_GET['PHP_p_id'];
		//$op['back_PHP_mks'] = $_GET['PHP_mks'];
		//檔案列表
		$op['done'] = $fils->get_file($op['wi']['wi_num']);
		 
		if(count($op['ti']))
		{
		 for ($i=0; $i<sizeof($op['ti']); $i++)
			$op['ti'][$i]['detail'] = str_replace( chr(13).chr(10), "<br>", $op['ti'][$i]['detail'] );
		}

		$op['po_check'] = $wi->check_po($op['wi']['id']);

		
			$op['msg'] = $wi->msg->get(2);

		if (isset($PHP_ex_order))
		{
			$op['edit_non']=1;
		}
		//排產總數
		$op['order_schedule'] = $schedule->get_order_schedule($_GET['PHP_style_code']);

		$op['order_schedule_qty']=0;
		foreach($op['order_schedule'] as $key=>$value)
		{
			$op['order_schedule_qty'] = $op['order_schedule_qty']+$value['qty'];
		}
		//訂單總數 ps_id smpl
		$order_total=0;
		foreach($op['smpl']['ps_id'] as $ord_qty_key => $ord_qty_value)
		{
			//echo $ord_qty_value ;
			//echo "<br>";
			$order_total += $wi->order_qty_sum($ord_qty_value);
			
		}
		$op['order_total_qty']=$order_total;
		//echo $order_total;
		//交期數量
		//PHP_style_code
		$op['wi']['partial_id']=$_GET['PHP_p_id'];
		$op['wi']['partial_mks']=$_GET['PHP_mks'];
		//print_r(sizeof($op['order_schedule']));
		$where_partial="where ord_num='".$_GET['PHP_style_code']."' and mks='".$_GET['PHP_mks']."'";
		$partial_qty = array();
		//$where_partial="where ord_num='DTH12-0897'"; 
		$partial_qty = $order->get_fields_array('ord_num,mks,p_etd,p_qty', $where_partial,'order_partial');
		$op['partial_qty'] = $partial_qty;
		//print_r($op);
		if (isset($PHP_ti))
		{
			// echo '1';
			if (isset($PHP_msg))$op['msg'][]=$PHP_msg;
			page_display($op, '022', $TPL_TI_VIEW);
		}else if (isset($PHP_cfm_view)){
			// echo '2';
			if (isset($PHP_msg))$op['msg'][]=$PHP_msg;
			page_display($op, '020', $TPL_WI_CFM_VIEW);
		}else{
			// echo '3';
			page_display($op, '019', $TPL_WI_VIEW);
		}

			
		break;	
//=======================================================
case "ti_print":   //  .......
check_authority('021',"view");

		$full_wi = $wi->get_all(0,$PHP_id);
		
		// print_r($full_wi);
		
		$wi = $full_wi['wi'];
		$smpl = $full_wi['smpl'];
		//--------------------------------------------------------------------------
		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($smpl['size']);
		$smpl['size_scale']=$size_A['size_scale'];
		$sizing = explode(",", $size_A['size']);

		//  wi_qty 數量檔
		//  wi_qty 數量檔

			$where_str2 = " WHERE ord_num = '".$wi['wi_num']."' ORDER BY p_etd";
			$p_id = $order->get_fields('id', $where_str2,'order_partial');
			$p_etd = $order->get_fields('p_etd', $where_str2,'order_partial');
			$op['total'] =0;			
			for($i=0; $i<sizeof($p_id); $i++)
			{
				$where_str3 =" WHERE wi_id='".$wi['id']."' AND p_id='".$p_id[$i]."'";
				$T_wiqty = $wiqty->search(1,$where_str3);
				$num_colors = count($T_wiqty);
				// 做出 size table-------------------------------------------
				$reply = get_colorway_qty($T_wiqty,$sizing);
				$data[$i] = $reply['data'];
				$op['total'] += $reply['total'];
				$colorway_name[$i] = $reply['colorway'];
				$colorway_qty[$i] = $reply['colorway_qty'];									
			}
		
		//-----------------------------------------------------------------

		//  取出 生產說明 記錄 -------------------------------------------------

		if(!isset($full_wi['ti']))$full_wi['ti'] = array();
		if(!isset($full_wi['sub_ti']))$full_wi['sub_ti'] = array();
		$op['ti'] = $full_wi['ti'];
		$op['sub_ti'] = $full_wi['sub_ti'];
		

//-----------------------------------------------------------------------
			// 相片的URL決定
			$style_dir	= "./picture/";  
			$no_img		= "./images/graydot.jpg";
			if(file_exists($style_dir.$wi['style_code'].".jpg")){
				$wi['pic_url'] = $style_dir.$wi['style_code'].".jpg";
			} else {
				$wi['pic_url'] = $no_img;
			}
		$op['done'] = $fils->get_file($wi['wi_num']);
		
//---------------------------------- 資料庫作業結束 ------------------------------

include_once($config['root_dir']."/lib/class.pdf_ti.php");

$print_title = "WorkSheet";

$print_title2 = "VER.".$wi['ti_rev']."  on  ".$wi['ti_cfm'];
$creator = $wi['ti_cfm_user'];

$ary_title = array ('prt_ord'	=>	'Order #',
							 'id'				=>	$PHP_id,
							 'cust'			=>	$smpl['cust_iname'],
							 'ref'			=>	$smpl['ref'],
							 'dept'			=>	$smpl['dept'],
							 'size'			=>	$smpl['size_scale'],
							 'style'		=>	$smpl['style'],
							 'qty'			=>	$op['total'],
							 'unit'			=>	$wi['unit'],
							 'etd'			=>	$wi['etd'],
							 'img'			=>	$wi['pic_url'],							 
							 'img_size'	=>	GetImageSize($wi['pic_url']),
							);

$pdf=new PDF_ti();
$pdf->AddBig5Font();

$pdf->Open();
$pdf->AddPage();
$pdf->SetFont('Arial','B',14);
$pdf->SetCreator('angel'); 
//$pdf->SetAutoPageBreak(1,25);
// [表匡] 訂單基本資料

		$X = $pdf->getX();

// 設定 colorway的數量表 - 欄位的寬  [size breakdown]
// 由 80~200 保留 30為 colorway內容 其它 90分配給數量欄
$x=4;	
/*
	$num_siz = count($sizing);
	$w_qty = intval(155/ ($num_siz+1));
	$w = array('40');  // 第一格為 30寬
	for ($i=0;$i<=$num_siz;$i++){
		array_push($w, $w_qty);
	}
	
	for($i=0; $i<sizeof($p_etd); $i++)
	{
		$header = array_merge(array('Colorway') , $sizing);	
		$table_title = "Size Breakdown";
		if(sizeof($p_etd) > 1)$table_title .= '[ ETD : '.$p_etd[$i].' ]';
		$R = 100 ;
		$G = 85 ;
		$B = 85 ;
		$Y = 70+($i*(sizeof($data[$i])+1)*8);
		if (count($sizing)){
			$pdf->Table_1(10,$Y,$header,$data[$i],$w,$table_title,$R,$G,$B,$size_A['base_size']);
		}else{
			$pdf->Cell(10,70,'there is no sizing data exist !',1);
		}
		//$pdf->ln();
		$x+=sizeof($data)+2;	
	}
*/
	//$x+=sizeof($p_etd);

		$Y =$pdf->getY();
		// 定訂 圖以下的座標 
		$pdf->SetXY($X,$Y+5);

//Worksheet資料


$mark=0;
for ($i=0; $i<sizeof($TI_ITEM); $i++)
{
	for ($j=0; $j<sizeof($op['ti']); $j++)
	{
		if ($op['ti'][$j]['item']==$TI_ITEM[$i])
		{
			$mark=1;
			$star=$j;
			break;
		}
	}
	$tmp=$i+1;
	if($mark == 1)
	{
		$x=$x+2;

		if ($x > 35)//換頁
		{
			$pdf->setx(10);
			$pdf->Cell(190,5,'','LBR',0,'L');	
			$pdf->AddPage();		
			$pdf->SetFont('Arial','B',14);
			$x=4;
		}
		
		
		$pdf->ti_name_fields($tmp.")".$TI_ITEM[$i]);
		$pdf->SetFont('Big5','',10);
		for ($j=$star; $j<sizeof($op['ti']); $j++)
		{
			if ($op['ti'][$j]['item']==$TI_ITEM[$i])
			{			
				$x=$pdf->ti_value_fields($op['ti'][$j]['detail'],$x,$tmp,$TI_ITEM[$i]);
			}


		}
		$pdf->setx(10);
		$pdf->Cell(190,5,'','LBR',0,'L');
		
		$pdf->ln();
		$mark = 0;
	}
}


for($i=0; $i<sizeof($op['sub_ti']); $i++)
{	
	$x=$x+2;
	if ($x > 35)
	{
		$pdf->setx(10);
		$pdf->Cell(190,5,'','LBR',0,'L');	
		$pdf->AddPage();
		$x=4;		
	}
	$pdf->ti_sub_name($op['sub_ti'][$i]['name'],'BIG5');
	
	for($j=0; $j<sizeof($op['sub_ti'][$i]['txt']); $j++)
	{
		if($op['sub_ti'][$i]['txt'][$j]['detail'])
		{
			$op['sub_ti'][$i]['txt'][$j]['detail'] = str_replace( chr(13).chr(10), "<br>", $op['sub_ti'][$i]['txt'][$j]['detail'] );
			$tmp=$j+1;
			$x=$x+2;
			if ($x > 35)
			{
				$pdf->setx(10);
				$pdf->Cell(190,5,'','LBR',0,'L');	
				$pdf->AddPage();
				$x=4;		
			}
		
			$pdf->ti_name_fields($tmp.")".$op['sub_ti'][$i]['txt'][$j]['item'],'BIG5');
			$x=$pdf->ti_value_fields($op['sub_ti'][$i]['txt'][$j]['detail'],$x,$tmp,$op['sub_ti'][$i]['txt'][$j]['item']);

			$pdf->setx(10);
			$pdf->Cell(190,5,'','LBR',0,'L');
			$pdf->ln();
		}
		
	}
}


$pdf->ln();
$x=$x+2;
$pdf->SetLineWidth(0.2);
$i=sizeof($op['done']);
if ($smpl['ptn_upload']<>'0000-00-00' && $smpl['paper_ptn']<> 1)
{

	$op['done'][$i]['file_name']=$smpl['order_num'].".mdl";
	$op['done'][$i]['file_des']="Order Pattern on : ".$smpl['ptn_upload'];
}
if (count($op['done']))
{


	if ($x > 35)//換頁
	{
			$pdf->AddPage();		
	}

	$pdf->SetFont('Arial','B',14);
	$pdf->setx(10);
	$pdf->Cell(190,8,'Attached Files',1,0,'C');
	$pdf->ln();
	$pdf->setx(10);
	$pdf->Cell(10,8,'No.',1,0,'C');
	$pdf->Cell(85,8,'File name',1,0,'C');
	$pdf->Cell(95,8,'File Description',1,0,'C');
	$pdf->ln();
	$pdf->setx(10);
	$pdf->Cell(10,0.5,'',1,0,'C');
	$pdf->Cell(85,0.5,'',1,0,'C');
	$pdf->Cell(95,0.5,'',1,0,'C');
	$pdf->ln();
	$x=$x+2;
	for ($i=0; $i< sizeof($op['done']); $i++)
	{
		
		if ($x > 35)
		{
			$pdf->AddPage();		
			$pdf->SetFont('Arial','B',14);
			$pdf->setx(10);
			$pdf->Cell(190,8,'Attached Files',1,0,'C');
			$pdf->ln();
			$pdf->setx(10);
			$pdf->Cell(10,8,'No.',1,0,'C');
			$pdf->Cell(85,8,'File name',1,0,'C');
			$pdf->Cell(95,8,'File Description',1,0,'C');
			$pdf->ln();
			$pdf->setx(10);
			$pdf->Cell(10,0.5,'',1,0,'C');
			$pdf->Cell(85,0.5,'',1,0,'C');
			$pdf->Cell(95,0.5,'',1,0,'C');
			$pdf->ln();
			$x=4;
		}
		
		
		
		$j=$i+1;
		$pdf->setx(10);		
		$pdf->Cell(10,5,$j,1,0,'C');
		$pdf->SetFont('Big5','',10);
		$pdf->Cell(85,5,$op['done'][$i]['file_name'],1,0,'L');
		$pdf->Cell(95,5,$op['done'][$i]['file_des'],1,0,'L');
		$pdf->SetFont('Arial','B',10);
		$pdf->ln();
		$x++;
	}
}

$name=$wi['wi_num'].'_ti.pdf';
$pdf->Output($name,'D');
break;	


//=======================================================
//		 生產說明
//=======================================================

//=======================================================
    case "ti":
		check_authority('021',"view");
		$where_str = $manager = $dept_id = '';		 
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
		$team = $GLOBALS['SCACHE']['ADMIN']['team_id'];  // 判定進入身份的指標(team)
		$sales_dept_ary = get_sales_dept();// 取出 業務的部門 [不含K0] ------
		// for ($i=0; $i<count($sales_dept_ary);$i++){
			// if($user_dept == $sales_dept_ary[$i]){

				// 如果是業務部進入 則dept_code 指定該業務部---
				// $dept_id = $sales_dept_ary[$i];  
			// }
		// }
		$op['dept_id'] = $dept_id;
		// if (!$dept_id || $team<>'MD') {    // 當不是業務部人[也不含 K0 的人 ]進入時
			$op['manager_flag'] = 1;
			$manager_v = 1;
			//業務部門 select選單
			$op['dept_id'] = $arry2->select($sales_dept_ary,"","PHP_dept_code","select","");  
		// }							
		// creat cust combo box	 取出 客戶代號
		$where_str=$where_str."order by cust_s_name";
		if(!$cust_def = $cust->get_fields('cust_init_name',$where_str)){;  
			$op['msg'][] = "sorry! there is no any customer record in your team, please add customer first!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		if(!$cust_def_vue = $cust->get_fields('cust_s_name',$where_str)){;  
			$op['msg'][] = "sorry! there is no any customer record in your team, please add customer first!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		for ($i=0; $i< sizeof($cust_def); $i++)
		{
			$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];
		}
		$op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue); 
		$op['fty_select'] =  $arry2->select($FACTORY,'','PHP_fty_sch','select',''); 
		for ($i=0; $i< sizeof($FACTORY); $i++)
		{
			if ($user_dept == $FACTORY[$i]) $op['fty_select'] = $user_dept."<input type='hidden' name='PHP_fty_sch' value='$user_dept'>";
		}

//080725message增加		
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];


		$op['msg']= $wi->msg->get(2);

		page_display($op, '021', $TPL_TI_SEARCH);		    	    
		break;

//=======================================================
	case "ti_search_wi":   //  先找出製造令.......

		check_authority('021',"view");

			if (!$op = $wi->search(1,0)) {
				$op['msg']= $wi->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			// op 被清除了 需再判斷一次 

		//2006/05/02 update
		$op['dept_id'] = get_dept_id();
		
		// 如果是 manager 進入時...
		if (substr($op['dept_id'],0,7) == "<select"){
			$op['manager_flag'] = 1;
		}
// print_r($op);
		$op['msg']= $wi->msg->get(2);				
		$back_str="&PHP_dept_code=".$PHP_dept_code."&PHP_etdfsh=".$PHP_etdfsh."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdstr=".$PHP_etdstr."&PHP_fty_sch=".$PHP_fty_sch;
		$op['back_str']=$back_str;

		page_display($op, '021', $TPL_TI);
		break;

//=======================================================    
    case "ti_view":
		check_authority('021',"view");
		$_SESSION['partial_id'] = '';
		// 將 製造令 完整show out ------
		//  wi 主檔
		if(!$op = $wi->get_all($PHP_id)){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}

//--------------------------------------------------------------------------
		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

		//  wi_qty 數量檔			
			$where_str2 = " WHERE ord_num = '".$op['wi']['wi_num']."' ORDER BY p_etd";
			$p_id = $order->get_fields('id', $where_str2,'order_partial');
			$p_etd = $order->get_fields('p_etd', $where_str2,'order_partial');
			
			$op['total'] =0; $op['g_ttl'] = 0;
			for($i=0; $i<sizeof($sizing); $i++)$op['size_ttl'][$i]=0;
			$etd = 0;
			for($i=0; $i<sizeof($p_id); $i++)
			{
				$where_str3 =" WHERE wi_id='".$op['wi']['id']."'  AND p_id='".$p_id[$i]."'";
				$T_wiqty = $wiqty->search(1,$where_str3);
				$num_colors = count($T_wiqty);
				// 做出 size table-------------------------------------------
				$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size'],$p_etd[$i]);
				$op['show_breakdown'][$i] = $reply['html'];
				$op['total'] += $reply['total'];
				for($j=0; $j<sizeof($sizing); $j++)
				{
					$op['g_ttl'] += $reply['size_ttl'][$j];				
					$op['size_ttl'][$j] +=$reply['size_ttl'][$j];
				}
				$etd = $etd > $p_etd[$i] ? $etd : $p_etd[$i] ;
			}

		$op['wi']['etd'] = $etd;
		//-----------------------------------------------------------------

		if(count($op['ti']))
		{
		 for ($i=0; $i<sizeof($op['ti']); $i++)
			$op['ti'][$i]['detail'] = str_replace( chr(13).chr(10), "<br>", $op['ti'][$i]['detail'] );
		}
		
		if(isset($op['sub_ti']))
		{
		 for ($i=0; $i<sizeof($op['sub_ti']); $i++)
		  for($j=0; $j<sizeof($op['sub_ti'][$i]['txt']); $j++)
				$op['sub_ti'][$i]['txt'][$j]['detail'] = str_replace( chr(13).chr(10), "<br>", $op['sub_ti'][$i]['txt'][$j]['detail'] );
		}				
	
	//檔案列表
		$op['done'] = $fils->get_file($op['wi']['wi_num']);
		
		$op['msg'] = $ti->msg->get(2);
		if(isset($PHP_msg)) $op['msg'][] = $PHP_msg;
		$PHP_back_str = "&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_etdfsh=".$PHP_etdfsh."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdstr=".$PHP_etdstr."&PHP_fty_sch=".$PHP_fty_sch;
		$op['back_str']=$PHP_back_str;
		$PHP_back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_etdfsh=".$PHP_etdfsh."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdstr=".$PHP_etdstr."&PHP_fty_sch=".$PHP_fty_sch;
		$op['back_str2']=$PHP_back_str2;
		page_display($op, '021', $TPL_TI_VIEW);
		break;
//=======================================================
    case "ti_add":
		check_authority('021',"add");
		// 將 製造令 完整show out ------
		//  wi 主檔
		if(!$op = $wi->get_all($PHP_id)){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}

//--------------------------------------------------------------------------
		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);


		//  wi_qty 數量檔			
			$where_str2 = " WHERE ord_num = '".$op['wi']['wi_num']."' ORDER BY p_etd";
			$p_id = $order->get_fields('id', $where_str2,'order_partial');
			$p_etd = $order->get_fields('p_etd', $where_str2,'order_partial');
			$op['total'] =0; $op['g_ttl'] = 0;
			for($i=0; $i<sizeof($sizing); $i++)$op['size_ttl'][$i]=0;
			$etd = 0;
			for($i=0; $i<sizeof($p_id); $i++)
			{
				$where_str3 =" WHERE wi_id='".$op['wi']['id']."'  AND p_id='".$p_id[$i]."'";
				$T_wiqty = $wiqty->search(1,$where_str3);
				$num_colors = count($T_wiqty);
				// 做出 size table-------------------------------------------
				$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size'],$p_etd[$i]);
				$op['show_breakdown'][$i] = $reply['html'];
				$op['total'] += $reply['total'];
				for($j=0; $j<sizeof($sizing); $j++)
				{
					$op['g_ttl'] += $reply['size_ttl'][$j];				
					$op['size_ttl'][$j] +=$reply['size_ttl'][$j];
				}
			$etd = $etd > $p_etd[$i] ? $etd : $p_etd[$i] ;
			}
		$op['wi']['etd'] = $etd;
		//-----------------------------------------------------------------
		
	//檔案列表
		$op['done'] = $fils->get_file($op['wi']['wi_num']);

		if(!isset($PHP_msg) || $PHP_msg == '') $sub_ti = array();
		if(is_array($sub_ti) && sizeof($sub_ti) > 0) $op['sub_ti'] =  $sub_ti;



		$op['sub_ti_new'] = 0 ;
		if(!isset($op['sub_ti']))
		{
				 $op['sub_ti'][0]['name'] = 'main';
				 $op['sub_ti'][0]['i'] = 0;
				 $op['sub_ti'][0]['new_ti'] = 1;
				 $op['sub_ti'][0]['PHP_group_exist'] = 'no';
				 $op['sub_ti_new'] = 1;

			for($i = 0; $i<sizeof($ti_style[$op['smpl']['style']]); $i++)
			{
				$op['sub_ti'][0]['txt'][$i]['id'] = $i;
				$op['sub_ti'][0]['txt'][$i]['item'] = $ti_style[$op['smpl']['style']][$i];
				$op['sub_ti'][0]['txt'][$i]['detail'] = '';
			}		
		}

		if(sizeof($sub_ti) == 0) $sub_ti = $op['sub_ti'];


		
		$op['msg'] = $ti->msg->get(2);
		if(isset($PHP_msg)) $op['msg'][] = $PHP_msg;

			// creat combo
		if (isset($PHP_dept_code))
		{
				$PHP_back_str = "&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_etdfsh=".$PHP_etdfsh."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdstr=".$PHP_etdstr."&PHP_fty_sch=".$PHP_fty_sch;
				$op['back_str']=$PHP_back_str;
				$PHP_back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_etdfsh=".$PHP_etdfsh."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdstr=".$PHP_etdstr."&PHP_fty_sch=".$PHP_fty_sch;
				$op['back_str2']=$PHP_back_str2;
		}else{
				$op['back_str']=$PHP_back_str;
				$op['back_str2']=$PHP_back_str2;				
		}
		foreach($op['sub_ti'] as $subti_key => $subti_value)
		{
			//$op['detail_id']['db_exist'][$subti_key]= $subti_value['db_exist'];//考慮一下
			foreach($op['sub_ti'][$subti_key]['txt'] as $subtitxt_key => $subtitxt_value)
			{
				$op['detail_id'][$subti_key][$subtitxt_key] = $subtitxt_value['id'];
				$op['item'][$subti_key][$subtitxt_key] = $subtitxt_value['item'];
			}
		}
		page_display($op, '021', $TPL_TI_ADD);
		break;

//=======================================================
    case "do_ti_other_add":
		check_authority("010","add");

		$sub_ti = array();
		for($i=0; $i<sizeof($PHP_detail); $i++)
		{
			 $sub_ti[$i]['name'] = $PHP_sub_name[$i];
			 $sub_ti[$i]['db_exist'] = "yes";
			 $sub_ti[$i]['i'] = $i;
			 $sub_ti[$i]['new_ti'] = $PHP_new_ti[$i];
			 $j=0;
			foreach($PHP_detail[$i] as $key => $value)
			{
				$sub_ti[$i]['txt'][$j]['id'] = $key;
				$sub_ti[$i]['txt'][$j]['item'] = $PHP_item[$i][$key];
				$sub_ti[$i]['txt'][$j]['detail'] = $value;
				$j++;
			}
		}


	$group_exist=0;
   if($PHP_other_name)
   {
		foreach($sub_ti as $sub_key => $sub_value)
		{
			if($sub_value['name'] == $PHP_other_name)
			{
				$group_exist=1;
			}
		}
		if($group_exist)
		{
			$message = "Duplicate name [".$PHP_other_name."] 。";
		}
		else
		{
		 	$sub_ti[$i]['name'] = $PHP_other_name;
			$sub_ti[$i]['db_exist'] = "no";
		 	$sub_ti[$i]['i'] = $i;
		 	$sub_ti[$i]['new_ti'] = 1;
		 	for($j = 0; $j<sizeof($ti_style[$PHP_style]); $j++)
		 	{
				$sub_ti[$i]['txt'][$j]['id'] = $j;
				$sub_ti[$i]['txt'][$j]['item'] = $ti_style[$PHP_style][$j];
				$sub_ti[$i]['txt'][$j]['detail'] = '';
			}				
			$message = "Add WI :[".$PHP_wi_num."] NEW GROUP [".$PHP_other_name."] 。";
		}
		foreach($sub_ti as $sub_key => $sub_value)
		{
			if($sub_value['new_ti'] == 1)
			{
				foreach($sub_value['txt'] as $sub_key4txt => $sub_value4txt)
				{
					$parm = array(	"wi_id"			=>	$PHP_wi_id,
									"item"			=>	$sub_value4txt['item'],//會有亂碼問題
									"detail"		=>	$sub_value4txt['detail'],
									'today'			=>	date('Y-m-d'),
									'times'			=>	date('H:i:s'),
									'ti_new'		=> '1',
									'sub_item'	=>	$sub_value['name']
					);
					//$f1 = $smpl_ti->add($parm);
					$f1 = $ti->add($parm);
					$sub_ti[$sub_key]['txt'][$sub_key4txt]['id'] = $f1;
				}
				$sub_ti[$sub_key]['new_ti'] = 0;
				$sub_ti[$sub_key]['db_exist'] = "yes";
			}
		}
	}else{
			$message = "Please input new gorup name";
	}

		
	

// 將 製造令 完整show out ------		
		$redir_str=$PHP_SELF.'?PHP_action=ti_add&PHP_id='.$PHP_wi_id.$PHP_back_str2.'&PHP_msg='.$message;
		redirect_page($redir_str);
		break;


//=======================================================
    case "do_ti_other_del":
		check_authority("010","add");

		$tmp_ti = array();
		for($i=0; $i<sizeof($sub_ti); $i++)
		{
			if($sub_ti[$i]['name'] != $sub_name)
			{
				$tmp_ti[$i] = $sub_ti[$i];
			}
		}
		$sub_ti = $tmp_ti;

	$ti->del_group($wi_id,$sub_name);
		
	

// 將 製造令 完整show out ------
		$message = "DELETE WI :[".$wi_num."] GROUP [".$sub_name."] 。";
		$log->log_add(0,"34D",$message);
		
		$back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_etdfsh=".$PHP_etdfsh."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdstr=".$PHP_etdstr."&PHP_fty_sch=".$PHP_fty_sch;
		
		$redir_str='index2.php?PHP_action=ti_add&PHP_id='.$wi_id.$back_str2.'&PHP_msg='.$message;
		redirect_page($redir_str);
		break;



//=======================================================
    case "do_ti_add":
		check_authority('021',"add");
		
		if($PHP_new_add == 1)
		{
			//value與key變數要改，看detail傳進的變數為何
			$PHP_detail = urldecode(uniDecode($PHP_detail,'big-5'));//轉碼
			$PHP_item = urldecode(uniDecode($PHP_item,'big-5'));//轉碼
			if($PHP_new_ti == 1)
			{
				if(strstr($PHP_detail,'&#')) $PHP_detail = $ch_cov->check_cov($PHP_detail);				
				if(strstr($PHP_item,'&#')) $PHP_item = $ch_cov->check_cov($PHP_item);	
				$parm = array(	"wi_id"			=>	$PHP_wi_id,
												"item"			=>	$PHP_item,
												"detail"		=>	$PHP_detail,
												'today'			=>	date('Y-m-d'),
												'times'			=>	date('H:i:s'),
												'ti_new'		=> '1',
												'sub_item'	=>	$PHP_sub_name
										 );

				$f1 = $ti->add($parm);
			}
			else
			{
				if(strstr($PHP_detail,'&#')) $PHP_detail = $ch_cov->check_cov($PHP_detail);
									
				$parm['field_name'] = 'detail';
				$parm['field_value'] = $PHP_detail;
				$parm['id'] = $PHP_id;
				$f1 = $ti->update_field($parm);
			}
			
		}
		else
		{ 
			for($i=0; $i<sizeof($PHP_detail); $i++)
			{		
				
				if($PHP_new_ti[$i] == 1)
				{
					$status="Add";
					foreach($PHP_detail[$i] as $key => $value)
					{
						if(strstr($value,'&#')) $value = $ch_cov->check_cov($value);			
						if(strstr($PHP_sub_name[$i],'&#')) $PHP_sub_name[$i] = $ch_cov->check_cov($PHP_sub_name[$i]);	
			
						$parm = array(	"wi_id"			=>	$PHP_wi_id,
														"item"			=>	(($PHP_new_arr=="fromjs")? urldecode(uniDecode($PHP_item[$i][$key],'big-5')):$PHP_item[$i][$key]),
														"detail"		=>	(($PHP_new_arr=="fromjs")? urldecode(uniDecode($value,'big-5')):$value),
														'today'			=>	date('Y-m-d'),
														'times'			=>	date('H:i:s'),
														'ti_new'		=> '1',
														'sub_item'	=>	$PHP_sub_name[$i]
												 );

						$f1 = $ti->add($parm);
					}
			
				}else{
					$status="Edit";
					foreach($PHP_detail[$i] as $key => $value)
					{
						if(strstr($value,'&#')) $value = $ch_cov->check_cov($value);
								
						$parm['field_name'] = 'detail';
						$parm['field_value'] = (($PHP_new_arr=="fromjs")? urldecode(uniDecode($value,'big-5')):$value);
						$parm['id'] = (($PHP_new_arr=="fromjs")? $PHP_id[$i][$key]:$key);
						$f1 = $ti->update_field($parm);
					}

				}
			}
		}		


// 將 製造令 完整show out ------
		
		if($PHP_new_add == 1)
		{
			$message = "Edit WI:[".$PHP_num."] Description 。";
			$return_message =  $PHP_sub_name." Group\r\n[".mb_convert_encoding($PHP_item, "UTF-8", "UTF-8,big5")."]".mb_convert_encoding("項目。", "UTF-8", "UTF-8,big5")."\r\n".mb_convert_encoding("更新成功!!" , "UTF-8", "UTF-8,big5");
			$log->log_add(0,"21E",$message);
			//$redir_str=$PHP_SELF.'?PHP_action=ti_view&PHP_id='.$PHP_wi_id.$PHP_back_str2.'&PHP_msg='.$message;
			echo $return_message;
		}
		else
		{
			$message = $status." WI:[".$PHP_num."] Description 。";
			$log->log_add(0,($status=="Add")?"21A":"21E",$message);
			$redir_str=$PHP_SELF.'?PHP_action=ti_view&PHP_id='.$PHP_wi_id.$PHP_back_str2.'&PHP_msg='.$message;
			redirect_page($redir_str);
		}
		break;		
		

//=======================================================
    case "do_ti_edit":
		check_authority('021',"add");

		if(strstr($PHP_detail,'&#'))	$PHP_detail = $ch_cov->check_cov($PHP_detail);

		
		$parm['field_name'] = 'detail';
		$parm['field_value'] = $PHP_detail;
		$parm['id'] = $PHP_id;

		$f1 = $ti->update_field($parm);

	$op['ti_item_select'] = $arry2->select($TI_ITEM,'','PHP_item','select',''); 
	$op['ti0']['detail'] = "";
	// 將 製造令 完整show out ------

		$message = "Add WI:[".$PHP_wi_num."] Description。";
		$log->log_add(0,"34A",$message);
		
		$redir_str=$PHP_SELF.'?PHP_action=ti_add&PHP_id='.$PHP_wi_id.$PHP_back_str2.'&PHP_msg='.$message;
		redirect_page($redir_str);
		break;

//=======================================================
	case "do_ti_cfm":
		check_authority('021',"view");

		$parm = array($PHP_id,'ti_cfm',$TODAY);
		$f1 = $wi->update_field($parm);
		$parm = array($PHP_id,'ti_cfm_user',$GLOBALS['SCACHE']['ADMIN']['login_id']);
		$f1 = $wi->update_field($parm);

		if (!$f1) {
			$op['msg']= $wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}	

		if ($PHP_revise == 0)
		{
				$parm=array($PHP_id,'ti_rev','1');
				$wi->update_field($parm);
		}
	
		$message="success CFM Worksheet:[".$PHP_wi."]";
		$log->log_add(0,"34A",$message);

//傳送message給RD人員
	$rcd = $wi->get_all($PHP_id);
	if($rcd['wi']['status'] > 0 && $rcd['wi']['ti_cfm'] <> '0000-00-00' )
	{
	 if($PHP_fty == 'WX') $PHP_fty = 'HJ';
	 $messg  = ' 製造令(Working Instruction) : <a href=index2.php?PHP_action=wi_view&PHP_id='.$PHP_id.'&PHP_dept_code=&PHP_num=&PHP_cust=&PHP_etdstr=&PHP_etdfsh=&PHP_sch_fty=&PHP_un_fhs=&PHP_sr=1>'.$PHP_wi.'</a>';
 	 $messg .= '製造說明 (WorkSheet) : <a href=index2.php?PHP_action=ti_view&PHP_id='.$PHP_id.$PHP_back_str2.'&PHP_ti=1>'.$PHP_wi.'</a>';
	 $notify->system_msg_send_with_mail('3-3-S',$PHP_fty,$PHP_wi,$messg);
	}
		
		$redir_str=$PHP_SELF.'?PHP_action=ti_view&PHP_id='.$PHP_id.$PHP_back_str2.'&PHP_ti=1&PHP_msg='.$message;
		redirect_page($redir_str);
		break;
		
//=======================================================
	case "revise_ti":
		check_authority('021',"edit");
		$sub_ti = array();
		$PHP_rev++;		//revies次數+1
		$parm = array($PHP_id,'ti_rev',$PHP_rev);		//revies次數+1存入資料庫
		$f1 = $wi->update_field($parm);
		if (!$f1) {
			$op['msg']= $wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}		

	
		$parm = array($PHP_id,'ti_cfm','0000-00-00');	//Worksheet變成未cfm
		$f1 = $wi->update_field($parm);
		$parm = array($PHP_id,'ti_cfm_user','');	//Worksheet變成未cfm
		$f1 = $wi->update_field($parm);
		if (!$f1) {
			$op['msg']= $wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}		
		$back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_etdfsh=".$PHP_etdfsh."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdstr=".$PHP_etdstr."&PHP_fty_sch=".$PHP_fty_sch;
		$message="success Revise Worksheet:[".$PHP_wi."]";
		$log->log_add(0,"23A",$message);
		$redir_str=$PHP_SELF.'?PHP_action=ti_add&PHP_id='.$PHP_id.$back_str2.'&PHP_msg='.$message;
		redirect_page($redir_str);
		break;





//=======================================================
    case "do_ti_del":
		
		check_authority('021',"edit");
		$parm = array(	"id"	=>	$id,		
						"wi_id" =>	$wi_id,
						"item"	=>	$item
		);

		$f1 = $ti->del($parm['id']);
		if (!$f1) {
			$op['msg'] = $ti->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		
//----完成刪除WS項目----

		$op = $wi->get_all($parm['wi_id']);
		$message = "Delete WI:[".$op['wi']['wi_num']."] Description[".$parm['item']."]。";
		$log->log_add(0,"31D",$message);
		$PHP_back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_etdfsh=".$PHP_etdfsh."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdstr=".$PHP_etdstr."&PHP_fty_sch=".$PHP_fty_sch;

		$redir_str=$PHP_SELF.'?PHP_action=ti_add&PHP_id='.$wi_id.$PHP_back_str2.'&PHP_msg='.$message;
		redirect_page($redir_str);
		break;



//=======================================================
    case "do_ws_file_del":

		$f1 = $fils->del_file($PHP_talbe,$PHP_id);
		if (!$f1) {
			$op['msg'] = $fils->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		if(file_exists($GLOBALS['config']['root_dir']."/wi_file/".$PHP_file_name)){
			unlink("./wi_file/".$PHP_file_name);
		}

		//傳送訊息給相關人員
		if($PHP_fty == 'WX') $PHP_fty = 'HJ';
		$messg  = ' 製造令(Working Instruction) : <a href=index2.php?PHP_action=wi_view&PHP_id='.$PHP_id.'&PHP_dept_code=&PHP_num=&PHP_cust=&PHP_etdstr=&PHP_etdfsh=&PHP_sch_fty=&PHP_un_fhs=&PHP_sr=1>'.$PHP_num.'</a>';
		$messg .= ' 製造說明 (WorkSheet) : <a href=index2.php?PHP_action=ti_view&PHP_id='.$PHP_id.$PHP_back_str2.'&PHP_ti=1>'.$PHP_num.'</a>';
		$messg .= ' <BR>已刪除檔案';
		$notify->system_msg_send_with_mail('3-3-F',$PHP_fty,$PHP_num,$messg);
		
//------完成檔案刪除-----
		$op = $wi->get_all($PHP_wi_id);
		$message = "Delete File form :[".$op['wi']['wi_num']."] 。";
		$log->log_add(0,"34D",$message);
		$PHP_back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_etdfsh=".$PHP_etdfsh."&PHP_cust=".$PHP_cust."&PHP_wi_num=".$PHP_wi_num."&PHP_etdstr=".$PHP_etdstr."&PHP_fty_sch=".$PHP_fty_sch;
		$redir_str=$PHP_SELF.'?PHP_action=ti_view&PHP_id='.$PHP_wi_id.$PHP_back_str2.'&PHP_msg='.$message;
		redirect_page($redir_str);
		break;
		
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 24A sample pattern upload
#		case "upload_smpl_pattern":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "upload_order_file":
		check_authority('021',"add");

		if(strstr($PHP_desp,'&#'))	$PHP_des = $ch_cov->check_cov($PHP_desp);
		
		$filename = $_FILES['PHP_pttn']['name'];		
		$ext =  strtolower(preg_replace("/.*\.([^.]+)$/","\\1", $filename));
		
		$f_check = 0;
		for ($i=0; $i<sizeof( $GLOBALS['VALID_TYPES']); $i++)
		{
			if ($GLOBALS['VALID_TYPES'][$i] == $ext)
			{
				$f_check = 1;
				break;
			}
		}
		
		
		
		if ($filename && $PHP_desp)
		{
			echo "111";																	
			if ($_FILES['PHP_pttn']['size'] < $max_file_size && $_FILES['PHP_pttn']['size'] > 0)
			{
				echo "11";
				if ($f_check == 1){   // 上傳檔的副檔名為 mdl 時 -----
					echo "1";
					// upload pattern file to server
					$today = $GLOBALS['TODAY'];
					$user_name =  $GLOBALS['SCACHE']['ADMIN']['name'];
					$parm = array(	"file_name"		=>  $PHP_num,				
									"num"			=>  $PHP_num,
									"file_des"		=>	$PHP_desp,
									"file_user"		=>	$user_name,
									"file_date"		=>	$today
					);

					$A = $fils->get_name_id('file_det');			
					$pttn_name = $PHP_num."_".$A.".".$ext;  // 組合檔名
					$parm['file_name'] = $pttn_name;
					
					$str_long=strlen($pttn_name);
					$upload = new Upload;
					
					$upload->setMaxSize($max_file_size);

					//$upload->uploadFile(dirname($PHP_SELF).'/wi_file/', 'other', 16, $pttn_name );
					$upload->uploadFile(dirname(__FILE__).'\wi_file\\', 'other', 16, $pttn_name );
					$upload->setMaxSize($max_file_size);
					if (!$upload){
						$op['msg'][] = $upload;
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
					}
					if (!$A = $fils->upload_file($parm)){
						$op['msg'] = $fils->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
					}
					
					//傳送message給相關人員
					if($PHP_fty == 'WX') $PHP_fty = 'HJ';
					$messg  = ' 製造令(Working Instruction) : <a href=index2.php?PHP_action=wi_view&PHP_id='.$PHP_id.'&PHP_dept_code=&PHP_num=&PHP_cust=&PHP_etdstr=&PHP_etdfsh=&PHP_sch_fty=&PHP_un_fhs=&PHP_sr=1>'.$PHP_num.'</a>';
					$messg .= ' 製造說明 (WorkSheet) : <a href=index2.php?PHP_action=ti_view&PHP_id='.$PHP_id.$PHP_back_str2.'&PHP_ti=1>'.$PHP_num.'</a>';
					$messg .= ' <BR>已上傳新檔案：'.$pttn_name.'，檔案描述：'.$PHP_desp;
					$notify->system_msg_send_with_mail('3-3-F',$PHP_fty,$PHP_num,$messg);
						
					$message = "UPLOAD file of ".$PHP_num;
					$log->log_add(0,"31E",$message);
				} else {  // 上傳檔的副檔名  是  exe 時 -----
					echo "2";
					$message = "upload file is incorrect format ! Please re-send.";
				}
			}else{  //上傳檔名重覆時
				echo "22";
				$message = "Upload file is too big";
			}
	
		}else{
			echo "222";
			$message="You don't pick any file or add file descript.";
		}	
			
//完成上傳檔案		

		$redir_str=$PHP_SELF.'?PHP_action=ti_view&PHP_id='.$PHP_id.$PHP_back_str2.'&PHP_msg='.$message;
		redirect_page($redir_str);
		break;		

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//   wi_cfm      //  WI CFM...........
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "wi_uncfm":
		check_authority('020',"view");
		
		if (!$op = $wi->search_uncfm('wi')) {
			$op['msg']= $wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		for ($i=0; $i<sizeof($op['wi']); $i++)
		{
			$where_str="WHERE smpl_code = '".$op['wi'][$i]['wi_num']."'";
			$op['wi'][$i]['lots']=$smpl_lots->get_fields('id',$where_str);
			$op['wi'][$i]['acc']=$smpl_acc->get_fields('id',$where_str);
		}

		$PHP_back_str = "&PHP_sr=&PHP_dept_code=&PHP_num=&PHP_cust=&PHP_etdstr=&PHP_etdfsh=&PHP_sch_fty=&PHP_un_fhs=";
		//2006/05/02 update
		$op['dept_id'] = get_dept_id();
		
		// 如果是 manager 進入時...
		if (substr($op['dept_id'],0,7) == "<select"){
			$op['manager_flag'] = 1;
		}	
				$op['msg']= $wi->msg->get(2);
				$op['back_str']= $PHP_back_str;

//080725message增加		
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];

			page_display($op, '020', $TPL_WI_UNCFM_LIST);
		break;




//========================================================================================	
	case "wi_cfm_qty_edit":

		check_authority('019',"edit");

		// 將 製造令 完整show out ------
		//  wi 主檔

			if(!$op = $wi->get_all($PHP_id)){    //取出該筆 製造令記錄 ID
						$op['msg']= $wi->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
			}

//--------------------------------------------------------------------------
		//  wi_qty 數量檔
		$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		$T_wiqty = $wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);

		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = breakdown_cfm_edit($T_wiqty,$sizing,$size_A['base_size']);
		$op['show_breakdown'] = $reply['html'];
		$op['total'] = $reply['total'];
		//-----------------------------------------------------------------
		$op['i'] = count($sizing);
		$op['j']= count($T_wiqty);
		
			$op['msg'] = $wi->msg->get(2);
			$PHP_back_str = "&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh."&PHP_sch_fty=".$PHP_sch_fty."&PHP_un_fhs=".$PHP_un_fhs;
			$op['back_str']=$PHP_back_str;
			$PHP_back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh."&PHP_sch_fty=".$PHP_sch_fty."&PHP_un_fhs=".$PHP_un_fhs;
			$op['back_str2']=$PHP_back_str2;
			if (isset($PHP_msg))$op['msg'][]=$PHP_msg;
		page_display($op, '019', $TPL_WI_QTY_EDIT);			
		break;
		
		
		

//========================================================================================	
	case "edit_color_qty":

		check_authority('019',"edit");
		$tmp_qty_csv='';

		$wqty_id=explode(',',$PHP_wqty_id);
		$qty_item=explode(',',$PHP_qty_item);
		$tmp_i=count($wqty_id);
		$tmp_j=count($qty_item);
		$count_qty= count($qty_item)/ count($wqty_id);
		
		$k=0;
			for ($i=0; $i< sizeof($wqty_id); $i++)
			{
				for ($j=0; $j < $count_qty; $j++)
				{
					$tmp_qty_csv=$tmp_qty_csv.$qty_item[$k].',';
					$k++;
				}
				$tmp_qty_csv=substr($tmp_qty_csv,0,-1);
				$wiqty->update_field('qty', $tmp_qty_csv, $wqty_id[$i]);				
				$tmp_qty_csv='';
			}
			
		//xxxxx訂單數量xxxx
		$s_ord=$order->get($PHP_ord_id);

		if ($s_ord['qty'] <>$PHP_ord_qty)
		{
			$su=(int)($PHP_ord_qty*$s_ord['ie1']);
			
			$ord_pdt = $order->get_pdtion($s_ord['order_num'], $s_ord['factory']);
			if ($s_ord['status'] >= 4 && $s_ord['status'] <> 5)
			{	//ETP~ETD的SU							 
				 $etp_su=decode_mon_yy_su($ord_pdt['etp_su']); //取出己存在etp-su並將su值與年,月分開
				 for ($i=0; $i<sizeof($etp_su); $i++) //將己存在su的年度記錄值刪除
				 {				 	
				 	$f1=$capaci->delete_su($s_ord['factory'], $etp_su[$i]['year'], $etp_su[$i]['mon'], 'pre_schedule', $etp_su[$i]['su']);			 		
				 }
				 $div = $order->distri_month_su($su,$s_ord['etp'],$s_ord['etd'],$s_ord['factory'],'pre_schedule'); //重算每月SU並儲存
				 $order->update_pdtion_field('etp_su', $div, $ord_pdt['id']);  //儲存新etp_su
			}
			if($s_ord['status'] >= 7){
				 //ETS~ETF的SU(工廠排程)
				 $fty_su=decode_mon_yy_su($ord_pdt['fty_su']);//取出己存在fty-su並將su值與年,月分開
				 for ($i=0; $i<sizeof($fty_su); $i++)//將己存在su的年度記錄值刪除
				 {				 	
				 	$f1=$capaci->delete_su($s_ord['factory'], $fty_su[$i]['year'], $fty_su[$i]['mon'], 'schedule', $fty_su[$i]['su']);			 		
				 }
				 $div = $order->distri_month_su($su,$ord_pdt['ets'],$ord_pdt['etf'],$s_ord['factory'],'schedule');//重算每月SU並儲存
				 $order->update_pdtion_field('fty_su', $div, $ord_pdt['id']);//儲存新fty_su
				 
			}

			// 寫入 qty和su
			$order->update_field('qty', $PHP_ord_qty, $PHP_ord_id);
			$order->update_field('su', $su, $PHP_ord_id);
			
		}
		$message="success edit order qty on wi cfm:[".$s_ord['order_num']."]";
		$log->log_add(0,"101A",$message);	
		$log->log_add(0,"31A",$message);	
			
			$op['msg'] = $wi->msg->get(2);
			$PHP_back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh."&PHP_sch_fty=".$PHP_sch_fty."&PHP_un_fhs=".$PHP_un_fhs;
			
			$redir_str=$PHP_SELF.'?PHP_action=wi_view&PHP_id='.$PHP_wi_id.$PHP_back_str2.'&PHP_cfm_view=1&PHP_msg='.$message;
			redirect_page($redir_str);
			break;

//=======================================================
	case "do_wi_cfm":
		check_authority('020',"view");
		
		$parm = array(	"order_num" =>	$PHP_order_num,
						"id"		=>	$PHP_id,
						"date"		=>	$dt['date_str'],
						"user"		=>	$GLOBALS['SCACHE']['ADMIN']['login_id']
					  );
		if (isset($PHP_msg))
		{
		if (substr($PHP_msg,0,1)<> 's')
		{	
			if ($PHP_msg == "ERROR! Please  check Order Q'TY and Order WI Q'TY first!")
			{
		//		echo "here";
				$redir_str=$PHP_SELF.'?PHP_action=wi_cfm_qty_edit&PHP_id='.$PHP_id.$PHP_back_str2.'&PHP_cfm_view=1&PHP_msg='.$PHP_msg;
				redirect_page($redir_str);
				break;				
			}else{
				$redir_str=$PHP_SELF.'?PHP_action=wi_view&PHP_id='.$PHP_id.$PHP_back_str2.'&PHP_cfm_view=1&PHP_msg='.$PHP_msg;
				redirect_page($redir_str);
				break;
			}
		}
		}
		
		$f1 = $wi->cfm($parm);
		if (!$f1) {
			$op['msg']= $wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$message="success CFM WI:[".$PHP_wi."]";
		$log->log_add(0,"33A",$message);	

//傳送message給RD人員
	$rcd = $wi->get_all($PHP_id);
	if($rcd['wi']['status'] > 0 && $rcd['wi']['ti_cfm'] <> '0000-00-00' )
	{
	 if($PHP_fty == 'WX') $PHP_fty = 'HJ';
	 $messg  = ' 製造令(Working Instruction) : <a href=index2.php?PHP_action=wi_view&PHP_id='.$PHP_id.$PHP_back_str2.'>'.$PHP_order_num.'</a>';
	 $messg  .=' 製造說明 (WorkSheet) : <a href=index2.php?PHP_action=ti_view&PHP_id='.$PHP_id.'&PHP_style_code='.$PHP_order_num.'&PHP_dept_code=&PHP_etdfsh=&PHP_cust=&PHP_wi_num=&PHP_etdstr=&PHP_fty_sch=&PHP_sr=1>'.$PHP_order_num.'</a>';
	 $notify->system_msg_send_with_mail('3-3-S',$PHP_fty,$PHP_order_num,$messg);
	}

	//傳送message給主料預估者
	 $messg  = '<a href="fab_comp.php?PHP_action=fab_comp_edit&PHP_id='.$PHP_id.'&PHP_sr=1">'.$PHP_order_num.'</a>';
	 $notify->system_msg_send('3-3-S','RD',$PHP_order_num,$messg);


			$parm_update = array($PHP_id,'last_update',$dt['date_str']);
			$wi->update_field($parm_update);
			$parm_update = array($PHP_id,'updator',$GLOBALS['SCACHE']['ADMIN']['login_id']);
			$wi->update_field($parm_update);


		if (!$op = $wi->search_uncfm('wi')) {
			$op['msg']= $wi->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		if ($PHP_revise == 0)
		{
				$parm=array($PHP_id,'revise','1');
				$wi->update_field($parm);
		}
		for ($i=0; $i<sizeof($op['wi']); $i++)
		{
			$where_str="WHERE smpl_code = '".$op['wi'][$i]['wi_num']."'";
			$op['wi'][$i]['lots']=$smpl_lots->get_fields('id',$where_str);
			$op['wi'][$i]['acc']=$smpl_acc->get_fields('id',$where_str);
		}

		//2006/05/02 update
		$op['dept_id'] = get_dept_id();
		$PHP_back_str = "&PHP_sr=&PHP_dept_code=&PHP_num=&PHP_cust=&PHP_etdstr=&PHP_etdfsh=&PHP_sch_fty=&PHP_un_fhs=";
		
		$op['msg'][]= $message;
		$op['back_str']= $PHP_back_str;
		page_display($op, '020', $TPL_WI_UNCFM_LIST);
	break;



































//================= 為了 新增製造令 使用 =============
    case "show_size_des_search":

		check_authority("053","view");
		$where_str = " AND cust='".$PHP_cust."' ";
		if (!$op = $size_des->search(0,$where_str)) {    // 叫出所屬部門的全部客戶記錄
			$op['msg']= $size_des->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['msg']= $size_des->msg->get(2);
		$op['dept'] = $PHP_dept;
		$op['cust'] = $PHP_cust;

		$layout->assign($op);
		$layout->display($TPL_SIZE_DES_LIST);		    	    
	break;




#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//   size_des 部份      //  2005/01/13 開始修改...........
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "size_des":
 
		check_authority("053","view");
		
		$where_str = $manager = $dept_id = '';		 
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
		$sales_dept_ary = get_sales_dept();// 取出 業務的部門 [不含K0] ------
		for ($i=0; $i<count($sales_dept_ary);$i++){
			if($user_dept == $sales_dept_ary[$i]){

				// 如果是業務部進入 則dept_code 指定該業務部---
				$dept_id = $sales_dept_ary[$i];  
			}
		}
		$op['dept_id'] = $dept_id;
		if (!$dept_id) {    // 當不是業務部人[也不含 K0 的人 ]進入時
			if (!$op = $size_des->search(0)) {    // 叫出全部客戶記錄
				$op['msg']= $size_des->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			$op['mag_falg'] = 1;
			$dept_def = $dept->get_fields('dept_code');   // 取出全部的部門別代號
			$op['dept_id'] = $arry2->select($dept_def,"","PHP_dept_code","select","");  //部門別select選單
		} else {
			$where_str = " AND dept = '".$_SESSION['SCACHE']['ADMIN']['dept']."'";
			if (!$op = $size_des->search(0,$where_str)) {    // 叫出所屬部門的全部客戶記錄
				$op['msg']= $size_des->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			$op['dept_id'] = $_SESSION['SCACHE']['ADMIN']['dept'];
		}

			$op['msg'] = $size_des->msg->get(2);
			if (isset($PHP_msg))$op['msg'][]=$PHP_msg;
			page_display($op, "053", $TPL_SIZE_DES);		    	    
		break;
//=======================================================
    case "size_des_add":
		
		check_authority("053","add");
		$un_choice=0;
		if ($PHP_dept_code ==""){
			$message="please choice dept first";
			$un_choice=1;	    
		}else{
			$op['dept_code'] = $PHP_dept_code;
			// create cust combo box
//			$where_str =" WHERE dept ='$PHP_dept_code' ";
			$where_str = "";
			$cust_def = $cust->get_fields('cust_s_name',$where_str);   // 取出 客戶代號
			$op['cust_select'] =  $arry2->select($cust_def,'','PHP_cust','select','');  	
			if (!isset($cust_def[0]))
			{
				$message = "sorry! This Department hasn't customer, please add customer fist.";
				$un_choice=1;
			}
		}
		if ($un_choice==1)
		{
					$where_str = $manager = $dept_id = '';		 
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
		$sales_dept_ary = get_sales_dept();// 取出 業務的部門 [不含K0] ------
		for ($i=0; $i<count($sales_dept_ary);$i++){
			if($user_dept == $sales_dept_ary[$i]){

				// 如果是業務部進入 則dept_code 指定該業務部---
				$dept_id = $sales_dept_ary[$i];  
			}
		}
		$op['dept_id'] = $dept_id;
		if (!$dept_id) {    // 當不是業務部人[也不含 K0 的人 ]進入時
			if (!$op = $size_des->search(0)) {    // 叫出全部客戶記錄
				$op['msg']= $size_des->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			$op['mag_falg'] = 1;
			$dept_def = $dept->get_fields('dept_code');   // 取出全部的部門別代號
			$op['dept_id'] = $arry2->select($dept_def,"","PHP_dept_code","select","");  //部門別select選單
		} else {
			$where_str = " AND dept = '".$_SESSION['SCACHE']['ADMIN']['dept']."'";
			if (!$op = $size_des->search(0,$where_str)) {    // 叫出所屬部門的全部客戶記錄
				$op['msg']= $size_des->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			$op['dept_id'] = $_SESSION['SCACHE']['ADMIN']['dept'];
		}

			$op['msg'][] = $message;
			page_display($op, "053", $TPL_SIZE_DES);		    	    
		break;
		}
			page_display($op, "053", $TPL_SIZE_DES_ADD);		    	    
		break;
//=======================================================
	case "do_size_des_add":

		check_authority("053","add");
			# size  整理  -------------
				$size_str = "";
				$size_check=0;
				$PHP_base_size = strtoupper($PHP_base_size);	
				for ($i=0;$i<count($PHP_size);$i++)	{
					$PHP_size[$i] = strtoupper($PHP_size[$i]);	
					if ($PHP_size[$i]){
						$size_str = $size_str.",".$PHP_size[$i];
						if ($PHP_size[$i] == $PHP_base_size) $size_check=1;
					}
				}

			$size_str = substr($size_str,1);   // 去掉最前的 ","
			$new_size = explode(',',$size_str);   // 整理後的尺碼陣列
			$size_scale = $new_size[0]." ~ ".$new_size[count($new_size)-1];
			//-----------------------------------------------------------------

		$parm = array(	"dept_code"		=>	$PHP_dept_code,
						"dept"			=>	$PHP_dept_code,
						"cust"			=>	$PHP_cust,
						"size"			=>	$size_str,
						"size_scale"	=>	$size_scale,
						"base_size"		=>	$PHP_base_size,
						"check"			=>	$size_check,
				);

				$op['size_des'] = $parm;
				$op['size_des']['size'] = $new_size;    // 陣列 轉成 op

		$f1 = $size_des->add($parm);
		if ($f1) {  // 成功輸入資料時

			$message= "Successfully add customer:[".$parm['cust']."] size record";

					# 記錄使用者動態
			$log->log_add(0,"75A",$message);

		$where_str = $manager = $dept_id = '';		 
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
		$sales_dept_ary = get_sales_dept();// 取出 業務的部門 [不含K0] ------
		for ($i=0; $i<count($sales_dept_ary);$i++){
			if($user_dept == $sales_dept_ary[$i]){

				// 如果是業務部進入 則dept_code 指定該業務部---
				$dept_id = $sales_dept_ary[$i];  
			}
		}
		$op['dept_id'] = $dept_id;
		if (!$dept_id) {    // 當不是業務部人[也不含 K0 的人 ]進入時
			if (!$op = $size_des->search(0)) {    // 叫出全部客戶記錄
				$op['msg']= $size_des->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			$op['mag_falg'] = 1;
			$dept_def = $dept->get_fields('dept_code');   // 取出全部的部門別代號
			$op['dept_id'] = $arry2->select($dept_def,"","PHP_dept_code","select","");  //部門別select選單
		} else {
			$where_str = " AND dept = '".$_SESSION['SCACHE']['ADMIN']['dept']."'";
			if (!$op = $size_des->search(0,$where_str)) {    // 叫出所屬部門的全部客戶記錄
				$op['msg']= $size_des->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			$op['dept_id'] = $_SESSION['SCACHE']['ADMIN']['dept'];
		}

			$op['msg'][] = $message;
			page_display($op, "053", $TPL_SIZE_DES);
		break;
	
		}	else {  // 當沒有成功輸入新增user的欄位時....

			$op['size_des'] = $parm;
			$op['size_des']['size'] = $new_size;    // 陣列 轉成 op
			$op['dept_code'] = $parm['dept_code'];
				// create cust combo box
//				$where_str =" WHERE dept ='$PHP_dept_code' ";
				$where_str = '';
				$cust_def = $cust->get_fields('cust_s_name',$where_str);   // 取出 客戶代號
				$op['cust_select'] =  $arry2->select($cust_def,$PHP_cust,'PHP_cust','select','');  	

			$op['msg'] = $size_des->msg->get(2);
	
			page_display($op, "053", $TPL_SIZE_DES_ADD);	    	    
		break;

		}
//========================================================================================	
	case "size_des_view":

		check_authority("053","view");
		$op['size_des'] = $size_des->get($PHP_id);  //取出該筆記錄

		if (!$op['size_des']) {
			$op['msg'] = $size_des->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
			$op['msg'] = $size_des->msg->get(2);	
			page_display($op, "053", $TPL_SIZE_DES_VIEW);	    	    
		break;
//=======================================================
	case "size_des_edit":		
		check_authority("053","edit");
		$op['size_des'] = $size_des->get($PHP_id);
		if (!$op['size_des']) {
			$op['msg'] = $size_des->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

			// 處理 size 的問題 ---------------
			$op['size_des']['size']  = explode(",",$op['size_des']['size']); 
			if (isset($PHP_ex_edit))$op['ex_edit']=1;
			$op['msg'] = $size_des->msg->get(2);
  			$op['now_pp']=$PHP_pp;
		page_display($op, "053", $TPL_SIZE_DES_EDIT);
		break;

//=======================================================
	case "do_size_des_edit":

		check_authority("053","edit");
			# size  整理  -------------
				$size_str = "";
				$size_check=0;
				$PHP_base_size = strtoupper($PHP_base_size);	
				for ($i=0;$i<count($PHP_size);$i++)	{
					$PHP_size[$i] = strtoupper($PHP_size[$i]);	

					if ($PHP_size[$i]){
						$size_str = $size_str.",".$PHP_size[$i];
						if ($PHP_size[$i] == $PHP_base_size) $size_check=1;
					}
				}
			$size_str = substr($size_str,1);   // 去掉最前的 ","
			$new_size = explode(',',$size_str);   // 整理後的尺碼陣列
			$size_scale = $new_size[0]." ~ ".$new_size[count($new_size)-1];
			//----------------------------------

		$argv = array(	"id"			=>  $PHP_id,
						"size"			=>	$size_str,
						"size_scale"	=>	$size_scale,
						"base_size"		=>	$PHP_base_size,
						"check"			=>	$size_check,

				);


		if (!$size_des->edit($argv)) {
			$op['msg'] = $size_des->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}


					# 記錄使用者動態
		$message = "Successfully update customer:[$PHP_cust]size:[$size_scale]record•";
		$log->log_add(0,"75E",$message);

		// 列出記錄~~~

		unset($argv);  // 刪除 參數  
	if ($PHP_ex_edit)
	{
		$op['size_des'] = $size_des->get($PHP_id);
		if (!$op['size_des']) {
			$op['msg'] = $size_des->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

			// 處理 size 的問題 ---------------
			$op['size_des']['size']  = explode(",",$op['size_des']['size']); 
			if (isset($PHP_ex_edit))$op['ex_edit']=1;
			$op['msg'] = $size_des->msg->get(2);
  
		page_display($op, "053", $TPL_SIZE_DES_SHOW);
	}else{
		$where_str = $manager = $dept_id = '';		 
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
		$user_team = $GLOBALS['SCACHE']['ADMIN']['team_id'];   // 判定進入身份的指標
		$sales_dept_ary = get_sales_dept();// 取出 業務的部門 [不含K0] ------		
		if ($user_team=='MD')
		{
			$dept_id =  $_SESSION['SCACHE']['ADMIN']['dept'];
			
			$where_str = " AND dept = '".$_SESSION['SCACHE']['ADMIN']['dept']."'";			
		}else{			
			$manager = 1;
			$dept_def = $dept->get_fields('dept_code');   // 取出全部的部門別代號
			$dept_id = $arry2->select($dept_def,"","PHP_dept_code","select","");  //部門別select選單
		}
		if (!$op = $size_des->search(0,$where_str)) {    // 叫出全部客戶記錄
				$op['msg']= $size_des->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
		}
		$op['mag_falg'] =$manager;
		$op['dept_id']=$dept_id;
		page_display($op, "053", $TPL_SIZE_DES);
	}
		break;
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "size_des_del":
						// 必需要 manager login 才能真正的刪除 user
		if(!$admin->is_power("053","del") && !($GLOBALS['SCACHE']['ADMIN']['id'] == "SA" )) { 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$subj = $size_des->get($PHP_id);
		
		if (!$size_des->del($PHP_id)) {
			$op['msg'] = $size_des->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}
					# 記錄使用者動態

		$message = "Delete Customer:[".$subj['cust']."] size:[".$subj['size_scale']."] record。";
		$log->log_add(0,"75D",$message);
		$redirect="index2.php?PHP_action=size_des&PHP_sr_startno=".$PHP_sr_startno."&PHP_msg=".$message;
		redirect_page($redirect);
	break;



//=======================================================
    case "show_size_search":
		check_authority("053","view");		
		$where_str = " AND cust='".$PHP_cust."'";
		if (!$op = $size_des->wi_search(0,$where_str)) {    // 叫出所屬部門指定客戶marked為null的樣本記錄
			$op['msg']= $smpl->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}	
		$op['msg']=$smpl->msg->get(2);
		$op['dept'] = $PHP_dept;
		$op['cust'] = $PHP_cust;	  
		page_display($op, "053", $TPL_SMPL_SIZE_LIST);	  	    
	break;



//========================================================================================	
	case "acc_view":

		check_authority("004","view");
		if (isset($PHP_code))
		{
			$op['acc'] = $acc->get(0,$PHP_code);  //取出該筆記錄
		}else{
			$op['acc'] = $acc->get($PHP_id);  //取出該筆記錄
		}
		

		if (!$op['acc']) {
			$op['msg'] = $acc->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		// 特別設定 :
		if($op['acc']['price1']== "0.00") { $op['acc']['price1']="";}
		if($op['acc']['price2']== "0.00") { $op['acc']['price2']="";}
		if($op['acc']['price3']== "0.00") { $op['acc']['price3']="";}

				# 記錄使用者動態
//		$log->log_add(0,"14V","瀏覽 副料資料：".$op['acc']['acc_code']);

			$op['msg'] = $acc->msg->get(2);
#####2006.11.14增加記錄目前頁次 start			
			$op['now_pp'] = $PHP_sr_startno;
			$parm = array(	"acc_code"		=>	$PHP_acc_code,
											"acc_name"		=>	$PHP_acc_name,
													"des"			=>	$PHP_des,
				);
			$op['cgi'] = $parm;
			$op['back_str'] = "&PHP_acc_code=".$PHP_acc_code."&PHP_acc_name=".$PHP_acc_name."&PHP_des=".$PHP_des;

#####2006.11.14增加記錄目前頁次 end
	
			page_display($op, "004", $TPL_ACC_VIEW);	    	    
		break;





	
//========================================================================================	
	case "lots_view":

		check_authority("003","view");
		if (isset($PHP_code))
		{
			$op['lots'] = $lots->get(0,$PHP_code);  //取出該筆記錄
		}else{
			$op['lots'] = $lots->get($PHP_id);  //取出該筆記錄
		}

		if (!$op['lots']) {
			$op['msg'] = $lots->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		// 特別設定 :
		if($op['lots']['price1']== "0.00") { $op['lots']['price1']="";}
		if($op['lots']['price2']== "0.00") { $op['lots']['price2']="";}
		if($op['lots']['price3']== "0.00") { $op['lots']['price3']="";}


				# 記錄使用者動態

		$op['cat_1']	= substr($op['lots']['lots_code'],1,1);
		$op['cat_2']	= substr($op['lots']['lots_code'],2,1);

			$op['msg'] = $lots->msg->get(2);
#####2006.11.14增加記錄目前頁次 start			
			$op['now_pp'] = $PHP_sr_startno;
			$op['back_str']="&SCH_cat1=".$SCH_cat1."&SCH_cat2=".$SCH_cat2."&SCH_mile=".$SCH_mile."&SCH_cons=".$SCH_cons."&SCH_lots_code=".$SCH_lots_code."&SCH_lots_name=".$SCH_lots_name."&SCH_comp=".$SCH_comp;
			$op['cgi']=$parm;	

#####2006.11.14增加記錄目前頁次 end			
			page_display($op, "003", $TPL_LOTS_VIEW);		    	    
		break;





//=======================================================

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case  "supl_view":	 	JOB 12V
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "supl_view":

		check_authority("002","view");

		$op['supl'] = $supl->get($PHP_id);  //取出該筆記錄

		if (!$op['supl']) {
			$op['msg'] = $supl->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		if ($op['supl']['usance'] == "000")	$op['supl']['usance']="0";		//依代號改為名稱
		$ary=array('A','B','C','D','E','F','G','H','I');
		for ($i=0; $i<sizeof($ary); $i++)
		{
			if ($op['supl']['usance'] == $ary[$i])	$op['supl']['usance']=$usance[$i];
		}
				
		for ($i=0; $i< 4; $i++)
		{
			if ($op['supl']['dm_way'] == $dm_way[1][$i]) $op['supl']['dm_way']=$dm_way[0][$i];
		}
		$op['msg'] = $supl->msg->get(2);
		page_display($op, "002", $TPL_SUPL_VIEW);
		break;
		
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case  "supl_view_open":	 	JOB 12V
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "supl_view_open":

		check_authority("002","view");

		$op['supl'] = $supl->get('',$PHP_num);  //取出該筆記錄

		if (!$op['supl']) {
			$op['msg'] = $supl->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		if ($op['supl']['usance'] == "000")	$op['supl']['usance']="0";		//依代號改為名稱
		$ary=array('A','B','C','D','E','F','G','H','I');
		for ($i=0; $i<sizeof($ary); $i++)
		{
			if ($op['supl']['usance'] == $ary[$i])	$op['supl']['usance']=$usance[$i];
		}
				
		for ($i=0; $i< 4; $i++)
		{
			if ($op['supl']['dm_way'] == $dm_way[1][$i]) $op['supl']['dm_way']=$dm_way[0][$i];
		}

		page_display($op, "002", $TPL_SUPL_VIEW);
		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case  "tmp_supl":	 	JOB 61V
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	  case "tmp_supl":

		check_authority("005","view");
		$parm=array(
						'vndr_no'		=>	$PHP_vndr_no,
						'supl_f_name'	=>	$PHP_supl_f_name,
						'now_page'		=>	$PHP_sr_startno
					);
		$cgi_link="&PHP_vndr_no=".$PHP_vndr_no."&PHP_supl_f_name=".$PHP_supl_f_name;
		if (!$op = $tmps1->search(0)) {		//搜尋列表
			$op['msg']= $tmps1->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		
		   
		$op['cat_select'] = $arry2->select($SUPL_TYPE,"","PHP_supl_cat","select",""); 

		$op['msg'] = $tmps1->msg->get(2);
		$op['supl']=$parm;
		$op['cgi_link']=$cgi_link;

//080725message增加		
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];

		page_display($op, "005", $TPL_TMP_SUPL);
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case  "supl_view":	 	JOB 12V
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "tmp_supl_view":

		check_authority("002","view");

		$op['supl'] = $tmps1->get($PHP_vndr_no);  //取出該筆記錄

		if (!$op['supl']) {
			$op['msg'] = $tmps1->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$ary=array('A','B','C','D','E','F','G','H','I');
		for ($i=0; $i<sizeof($ary); $i++)
		{
			if ($op['supl']['usance'] == $ary[$i])	$op['supl']['usance']=$usance[$i];
		}
		
		for ($i=0; $i< 4; $i++)
		{
			if ($op['supl']['dm_way'] == $dm_way[1][$i]) $op['supl']['dm_way']=$dm_way[0][$i];
		}		
		

		$op['msg'] = $tmps1->msg->get(2);

		page_display($op, "002", $TPL_SUPL_VIEW);
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		  case "do_tmpsup_add":		 	JOB 61A
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	  case "do_tmpsup_add":		
		check_authority("005","add");
		$parm=array(
						'vndr_no'		=>	$PHP_vndr_no,
						'supl_f_name'	=>	$PHP_supl_f_name,
						'now_page'		=>	$PHP_sr_startno
					);
		$cgi_link="&PHP_vndr_no=".$PHP_vndr_no."&PHP_supl_f_name=".$PHP_supl_f_name;
		$f1 = $tmps1->exchange($PHP_id,$PHP_supl_cat);	//將王安的供應商加入parts中
		if (!$op = $tmps1->search(0)) {		//搜尋列表
			$op['msg']= $mec->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		
		$op['cat_select'] = $arry2->select($SUPL_TYPE,"","PHP_supl_cat","select",""); 
		$op['msg'] = $tmps1->msg->get(2);
		$op['supl']=$parm;
		$op['cgi_link']=$cgi_link;
		page_display($op, "005", $TPL_TMP_SUPL);
		break;
 

 
 
 
 
 
 
 
 //----------------------------------------------------------------
 //			job 11  cust
 //----------------------------------------------------------------
    case "cust":
 		check_authority("001","view");
		$in_id = $GLOBALS['SCACHE']['ADMIN']['dept'];
		$in_dept = '';
		$where_str ='';
		$manager ='';
		$dept_select = array();
		

		$sales_dept = get_sales_dept(); // 取出 業務的部門 [不含K0] ------


	
		for ($i=0; $i<count($sales_dept);$i++){
			if($in_id == $sales_dept[$i]){
				$in_dept = $sales_dept[$i];   // 如果是業務部進入 則dept_code 指定該業務部---
			}
		}
		
		if (!$in_dept) {    // 當不是業務部人[也不含 K0 的人 ]進入時
			$manager = 1;
			$dept_select = $arry2->select($sales_dept,"","PHP_dept_code","select","");  //業務部門 select選單
			$dept_search = $arry2->select($sales_dept,"","SCH_dept","select","");  //業務部門 select選單
		} else {
			$where_str = " WHERE dept = '".$in_dept."' ";
			$dept_search = '<b>'.$in_id.'</b><input type=hidden name=SCH_dept value='.$in_id.'>';
		}


		//   因為 search 將 $op重置 所以再帶入其它參數
		$op['dept_code'] = $in_dept;
		$op['dept_select'] = $dept_select;
		$op['manager_flag'] = $manager;
		$op['dept_search'] =	$dept_search ;
		$op['msg'] = $cust->msg->get(2);

//080725message增加		
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];

		page_display($op,"001", $TPL_CUST_SEARCH);		    	    
		break;

//=======================================================
    case "cust_search":
 		check_authority("001","view");
			if (!$op = $cust->search(2,$where_str)) {    // 叫出所屬部門的全部客戶記錄
				$op['msg']= $cust->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}

		$op['back_str'] = "&SCH_cust=".$SCH_cust."&SCH_name=".$SCH_name."&SCH_dept=".$SCH_dept;

		$op['msg'] = $cust->msg->get(2);
		page_display($op,"001", $TPL_CUST);		    	    
		break;

//=======================================================
    case "cust_add":
		check_authority("001","add");
			if ($PHP_dept_code ==""){
				$op['msg'][] = "sorry! Please choice dept. first!";

					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;

				$redir_str = $PHP_SELF.'?PHP_action=cust';
				redirect_page($redir_str);

				break;

			}
			$op['country_select'] = $arry2->select($COUNTRY,"","PHP_cust_country","select","");  //業務部門 select選單

				$op['dept_code'] = $PHP_dept_code;
		page_display($op,"001", $TPL_CUST_ADD);			    	    
		break;
		
//=======================================================
	case "cust_shift":
	$where_str = "WHERE dept = '".$PHP_dept."'";
	$op=$cust->search(0,$where_str,100);
	
	$op['org_dept'] = $PHP_dept;
	$sales_dept = get_sales_dept(); // 取出 業務的部門 [不含K0] ------
	$dept_select = $arry2->select($sales_dept,"","PHP_dept_code","select","");  //業務部門 select選單
	$op['dept_select'] = $dept_select;
	page_display($op,"001", $TPL_CUST_SHIFT);
	break;

//=======================================================
	case "do_cust_shift":

	foreach ($PHP_cust as $key => $value)
	{
		$q_str = "UPDATE cust SET ".$parm['field_name']."='".$parm['field_value']."'  WHERE id='".$parm['id']."'";

		 $parm = array ( 'field_name' 		=>	'dept',
		 								 'field_value'		=>	$PHP_dept_code,
		 								 'id'							=>	$key
		 								 );
		 $cust->update_field($parm);
		 $message = "success shift ".$value." to dept : ".$PHP_dept_code;
		 $log->log_add(0,"11E",$message);
	}
	$redir_str = $PHP_SELF.'?PHP_action=cust';
	redirect_page($redir_str);
	break;

//=======================================================
	case "do_cust_add":
		check_authority("001","add");
		$parm = array(	"dept_code"			=>	$PHP_dept_code,
						"country"					=>	$PHP_cust_country,
						"cust_s_name"			=>	$PHP_cust_s_name,
						"cust_f_name"			=>	$PHP_cust_f_name,
						"cust_init_name"	=>	$PHP_cust_init_name,
						"cntc_phone"			=>	$PHP_cntc_phone,
						"cntc_addr"				=>	$PHP_cntc_addr,
						"cntc_person1"		=>	$PHP_cntc_person1,
						"cntc_cell1"			=>	$PHP_cntc_cell1,
						"email1"					=>	$PHP_email1,
						"cntc_person2"		=>	$PHP_cntc_person2,
						"cntc_cell2"			=>	$PHP_cntc_cell2,
						"email2"					=>	$PHP_email2,
						"cntc_fax"				=>	$PHP_cntc_fax,
						"agent"						=>	$PHP_agent
				);

				$op['cust'] = $parm;

		$f1 = $cust->add($parm);
		if ($f1) {  // 成功輸入資料時

				if (!$op = $cust->search(0)) {
					$op['msg']= $cust->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
				}

				$message= "Append customer:".$PHP_cust_s_name." for dept.:".$PHP_dept_code;

						# 記錄使用者動態
				$log->log_add(0,"11A",$message);




			if (!$op = $cust->search(0,$where_str)) {    // 叫出所屬部門的全部客戶記錄
				$op['msg']= $cust->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}


		//   因為 search 將 $op重置 所以再帶入其它參數
		$op['back_str'] = "&SCH_cust=&SCH_name=&SCH_dept=";
		$op['msg'] = $cust->msg->get(2);
		$op['msg'][] = $message;		
		page_display($op,"001", $TPL_CUST);	    	    
		break;
	

		
		
		}	else {  // 當沒有成功輸入新增user的欄位時....
			$op['country_select'] = $arry2->select($COUNTRY,$PHP_cust_country,"PHP_cust_country","select","");  //業務部門 select選單
			$op['cust'] = $parm;
			$op['dept_code'] = $parm['dept_code'];
			$op['msg'] = $cust->msg->get(2);
		page_display($op,"001", $TPL_CUST_ADD);    	    
		break;

		}

//========================================================================================	
	case "cust_view":
		check_authority("001","view");
		$op['cust'] = $cust->get($PHP_id);  //取出該筆記錄

		if (!$op['cust']) {
			$op['msg'] = $cust->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

				# 記錄使用者動態
//		$log->log_add(0,"11V","瀏覽客戶資料：".$op['cust']['cust_s_name']);

		$op['msg'] = $cust->msg->get(2);
#####2006.11.14增加記錄目前頁次 start			
			$op['now_pp'] = $PHP_sr_startno;
			$op['back_str'] = "&SCH_cust=".$SCH_cust."&SCH_name=".$SCH_name."&SCH_dept=".$SCH_dept."&PHP_sr_startno=".$PHP_sr_startno;
#####2006.11.14增加記錄目前頁次 end
	page_display($op,"001", $TPL_CUST_VIEW);	    	    
	break;


//=======================================================
	case "cust_edit":
		check_authority("001","edit");
		$op['cust'] = $cust->get($PHP_id);
		if (!$op['cust']) {
			$op['msg'] = $cust->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['country_select'] = $arry2->select($COUNTRY,$op['cust']['country'],"PHP_cust_country","select","");  //業務部門 select選單
	
			$op['msg'] = $cust->msg->get(2);
				# 記錄使用者動態
//		$log->log_add(0,"11E","進入更新客戶記錄 :".$op[cust][cust_s_name]);
#####2006.11.14增加記錄目前頁次 start			
			$op['now_pp'] = $PHP_sr_startno;
			$op['back_str'] = "&SCH_cust=".$SCH_cust."&SCH_name=".$SCH_name."&SCH_dept=".$SCH_dept."&PHP_sr_startno=".$PHP_sr_startno;
#####2006.11.14增加記錄目前頁次 end
		page_display($op,"001", $TPL_CUST_EDIT);
		break;


//=======================================================
	case "do_cust_edit":
		check_authority("001","edit");
		$argv = array(	"id"				=>  $PHP_id,
						"dept_code"					=>	$PHP_dept_code,
						"country"						=>	$PHP_cust_country,
						"cust_s_name"				=>	$PHP_cust_s_name,
						"cust_f_name"				=>	$PHP_cust_f_name,
						"cust_init_name"		=>	$PHP_cust_init_name,
						"cntc_phone"				=>	$PHP_cntc_phone,
						"cntc_addr"					=>	$PHP_cntc_addr,
						"cntc_person1"			=>	$PHP_cntc_person1,
						"cntc_cell1"				=>	$PHP_cntc_cell1,
						"email1"						=>	$PHP_email1,
						"cntc_person2"			=>	$PHP_cntc_person2,
						"cntc_cell2"				=>	$PHP_cntc_cell2,
						"email2"						=>	$PHP_email2,
						"cntc_fax"					=>	$PHP_cntc_fax,
						"agent"							=>	$PHP_agent
				);

		if (!$cust->edit($argv)) {
			$op['msg'] = $cust->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}

					# 記錄使用者動態
		$message = "Update customer:[$PHP_cust_s_name]context•";
		$log->log_add(0,"11E",$message);

		$op['cust'] = $cust->get($PHP_id);  //取出該筆記錄

		if (!$op['cust']) {
			$op['msg'] = $cust->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['msg'] = $cust->msg->get(2);
		$op['msg'][] = $message;
		$op['back_str'] = $PHP_back_str;
			page_display($op,"001", $TPL_CUST_VIEW);    	    
		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "cust_del":

						// 必需要 manager login 才能真正的刪除 user
		if(!$admin->is_power("001","view") && !($GLOBALS['SCACHE']['ADMIIN']['id'] == 'SA')){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['cust'] = $cust->get($PHP_id);
		
		if (!$cust->del($PHP_id)) {
			$op['msg'] = $cust->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}
					# 記錄使用者動態

		$message = "Delete customer:[".$op['cust']['cust_s_name']."] Record。";
		$log->log_add(0,"11D",$message);

	//--------------------------------------------------2005/0908

		$in_id = $GLOBALS['SCACHE']['ADMIN']['dept'];
		$in_dept = '';
		$where_str ='';
		$manager ='';
		$dept_select = array();

		$sales_dept = get_sales_dept(); // 取出 業務的部門 [不含K0] ------
		if ($in_id=='HJ' || $in_id=='CL' || $in_id=='WX' || $in_id	=='LY' || $in_id	=='CF')
		{
			$in_dept=$in_id	;
		}else{
		for ($i=0; $i<count($sales_dept);$i++){
			if($in_id == $sales_dept[$i]){
				$in_dept = $sales_dept[$i];   // 如果是業務部進入 則dept_code 指定該業務部---
			}
		}
		}
		if (!$in_dept) {    // 當不是業務部人[也不含 K0 的人 ]進入時
			$manager = 1;
			$dept_select = $arry2->select($sales_dept,"","PHP_dept_code","select","");  //部門別select選單
		} else {
			$where_str = " WHERE dept = '".$in_dept."' ";
		}

			if (!$op = $cust->search(0,$where_str)) {    // 叫出所屬部門的全部客戶記錄
				$op['msg']= $cust->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}

		//   因為 search 將 $op重置 所以再帶入其它參數
		$op['dept_code'] = $in_dept;
		$op['dept_select'] = $dept_select;
		$op['manager_flag'] = $manager;

		$op['msg'] = $cust->msg->get(2);
		$op['msg'][] = $message;
			unset($argv);  // 刪除 參數			
			page_display($op,"001", $TPL_CUST); 		    	    
		break;

  
  
  
  
  
  //=======================================================
  //		job   62   USER  
  //=======================================================
case "user":
check_authority('046',"view");

$where_str = $manager_flag ='';

// -------------------- 判斷 進入的身份 是否為 GM , SA, 或 K0 的人 ------------------------------
$user_id = $GLOBALS['SCACHE']['ADMIN']['dept'];

// 如果是 manager 進入時...
//如果是 GM 或 SA 或 K0則傳回 部門下拉選單  
//業務單位則只列出業務部門選單 -----// 其餘皆傳回該部門ID
$mgr = get_manager_dept();   //找出管轄的部門範圍~~~~

if($user_id == "K0" || $user_id == "J0" || $user_id == "T0" || $user_id == "GM" || $user_id == "SA" || $user_id == "PM" ) {

	$manager_flag = 1;
	$dept_search = $arry2->select($mgr['dept_ary'],"","PHP_dept","select","");
	
} else {

	$dept_search = '<b>'.$user_id.'</b><input type=hidden name=PHP_dept value='.$user_id.'>';
	
}

// -------------------- 判斷 進入的身份 是否為 GM , SA, 或 K0 的人 ------------------------------
$op['dept_select'] = $mgr['dept_select'];
$op['dept_id'] = $mgr['dept_id'];
$op['manager_flag'] = $manager_flag;
$op['dept_search'] = $dept_search;

$op['msg'] = $user->msg->get(2);
if (isset($PHP_sort))$op['sort']=$PHP_sort;

page_display($op,'046', $TPL_USER_MAIN);		    	    
break;



//=======================================================
case "user_search":
check_authority('046',"view");

$where_str = $manager_flag ='';

// -------------------- 判斷 進入的身份 是否為 GM , SA, 或 K0 的人 ------------------------------
$user_id = $GLOBALS['SCACHE']['ADMIN']['dept'];

// 如果是 manager 進入時...
 //如果是 GM 或 SA 或 K0則傳回 部門下拉選單  
 //業務單位則只列出業務部門選單 -----// 其餘皆傳回該部門ID
if($user_id == "K0"){
	$where_str = " dept LIKE 'K%' ";
}elseif($user_id == "J0"){
	$where_str = " dept LIKE 'J%' ";
}elseif($user_id == "T0"){
	$where_str = " dept LIKE 'T%' ";
}elseif($user_id == "GM" || $user_id == "SA"){
}else{
	$where_str = " dept = '".$user_id."' ";
}
$_SESSION['PAGE']['user']['where_str'] = $where_str;
if (!$op = $user->search(2,$where_str)) {
	$op['msg']= $user->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}

$mgr = get_manager_dept();   //找出管轄的部門範圍~~~~

// -------------------- 判斷 進入的身份 是否為 GM , SA, 或 K0 的人 ------------------------------
$op['dept_select'] = $mgr['dept_select'];
$op['dept_id'] = $mgr['dept_id'];
$SCH_del = !empty($SCH_del) ? $SCH_del : '' ;
$op['back_str'] = '&SCH_del='.$SCH_del.'&PHP_logid='.$PHP_logid."&PHP_dept=".$PHP_dept."&PHP_name=".$PHP_name;
$op['msg'] = $user->msg->get(2);
if(isset($PHP_msg)) $op['msg'][] = $PHP_msg;
if (isset($PHP_sort))$op['sort']=$PHP_sort;

page_display($op,'046', $TPL_USER);		    	    
break;



//========================================================================================	
case "user_view":
check_authority('046',"view");

$op['user'] = $user->get($PHP_id);  //取出該筆記錄

if (!$op['user']) {
	$op['msg'] = $team->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);
	break;
}

// 解開 permission
if ($_SESSION['USER']['ADMIN']['team_id'] == "SA" || $_SESSION[$MYSQL_DB]['dept'] == "SA"){
  $op['perm_me'] = $admin->decode_perm_str($_SESSION['USER']['ADMIN']['perm_dec']);
  $perm_array = $admin->extra_perm_str($op['user']['perm']);
  $op['perm'] = $admin->decode_perm_str($perm_array);
}else{
  # 比較Team&User
  $teams = $user->get_team($op['user']['perm'],$_SESSION['USER']['ADMIN']['dept'],$_SESSION['USER']['ADMIN']['team_id']);
  # Team
  $perm_array_me = $admin->extra_perm_str($teams);
  $op['perm_me'] = $admin->decode_perm_str($perm_array_me);	
  # User
  $perm_array = $admin->extra_perm_str($op['user']['perm']);
  $op['perm'] = $admin->decode_perm_str($perm_array);
}	

//menu 的名稱 及權限名稱 以代號帶入
// $op['mtitle'] = $GLOBALS['M_title'];
// $op['job'] = $GLOBALS['p_job'];
$op['now_pp'] = $PHP_sr_startno;
$op['back_str'] = '&PHP_logid='.$PHP_logid."&PHP_dept=".$PHP_dept."&PHP_name=".$PHP_name."&PHP_sr_startno=".$PHP_sr_startno;
$op['sort']=$PHP_sort;

page_display($op,'046', $TPL_USER_VIEW);
break;



//=======================================================
/**\
USER 修改
\**/
case "user_edit":
check_authority('046',"edit");

# 先抓user的資料 back_str
$op['user'] = $user->get($_GET['PHP_id']);

if (!$op['user']){

	page_display($op,'046',$TPL_ERROR);
	
	break;
	
}

if(!empty($PHP_dept)){

    $op['user']['dept'] = $op['dept_k'] = $PHP_dept;

} else {

    $op['dept_k'] = $PHP_dept = $op['user']['dept'];

}

$where_cpn='';
$op['dept'] = $dept->get_field_value(' id,dept_name,dept_code ',$where_cpn);

# 抓取相同 Dept 的 Team Code
$team_code = $team->get_field_value("id,team_code","where dept_code = '".$op['user']['dept']."' ");

#轉換上面的陣列 [id]=>[team_code]
$team_code = array_one($team_code);

# 切換不同的 team 變換變數
if(!isset($PHP_team_code)){
    $op['user']['team'] = $op['PHP_team_code'] = $PHP_team_code = $op['user']['team_id'];
} else {
    $op['user']['team'] = $op['PHP_team_code'] = $PHP_team_code;
}

# 抓取 perm id
if(!empty($op['user']['dept']) && !empty($PHP_team_code) )
    $perm_id = $team->get_team_id($op['user']['dept'],$PHP_team_code);

# 抓 user 隸屬 Team 的 Perm
if(!empty($perm_id))
    $team_perm = $team->get_field('perm',"id ='".$perm_id."'");

# team 選單
if(!empty($team_code))
	$op['team_select'] = $arry2->select2($team_code,$PHP_team_code,'PHP_team_code','select','change_data();');


if ($_SESSION['USER']['ADMIN']['team_id'] == "SA" || $_SESSION[$MYSQL_DB]['dept'] == "SA"){

	if(!empty($team_perm))
		$op['perm_me'] = $admin->decode_perm_str($admin->extra_perm_str($team_perm));
		
	$perm_array = $admin->extra_perm_str($op['user']['perm']);
	
	$op['perm'] = $admin->decode_perm_str($perm_array);
	
} else {

	# 比較Team&User
	$teams = $user->get_team($op['user']['perm'],$_SESSION['USER']['ADMIN']['dept'],$_SESSION['USER']['ADMIN']['team_id']);
	
	# Team
	$perm_array_me = $admin->extra_perm_str($teams);

	$op['perm_me'] = $admin->decode_perm_str($perm_array_me);
	
	# User
	$perm_array = $admin->extra_perm_str($op['user']['perm']);
	
	$op['perm'] = $admin->decode_perm_str($perm_array);
	
}

//menu 的名稱 及權限名稱 以代號帶入
// $op['mtitle'] = $GLOBALS['M_title'];
// $op['job'] = $GLOBALS['p_job'];
$op['now_pp'] = $PHP_sr_startno;
$op['back_str'] = '&PHP_logid='.$PHP_logid."&PHP_dept=".$PHP_dept."&PHP_name=".$PHP_name."&PHP_sr_startno=".$PHP_sr_startno;
$op['sort']=$PHP_sort;

page_display($op,'046', $TPL_USER_EDIT);
break;



//=======================================================
/**\
USER 新增
\**/
case "user_add":
$jobs = check_authority('046',"add");

$PHP_dept = !empty($_POST['PHP_dept']) ? $_POST['PHP_dept'] : '';

$PHP_team_code = !empty($_POST['PHP_team_code']) ? $_POST['PHP_team_code'] : '';



$PHP_dept_code = !empty($_POST['PHP_dept_code']) ? $_POST['PHP_dept_code'] : ( !empty($_SESSION['TEMP']['PHP_temp']['dept_code']) ? $_SESSION['TEMP']['PHP_temp']['dept_code'] : '' );
$PHP_emp_id = !empty($_POST['PHP_emp_id']) ? $_POST['PHP_emp_id'] : ( !empty($_SESSION['TEMP']['PHP_temp']['emp_id']) ? $_SESSION['TEMP']['PHP_temp']['emp_id'] : '' );
$PHP_login_id = !empty($_POST['PHP_login_id']) ? $_POST['PHP_login_id'] : ( !empty($_SESSION['TEMP']['PHP_temp']['login_id']) ? $_SESSION['TEMP']['PHP_temp']['login_id'] : '' );
$PHP_login_pass1 = !empty($_POST['PHP_login_pass1']) ? $_POST['PHP_login_pass1'] : ( !empty($_SESSION['TEMP']['PHP_temp']['login_pass1']) ? $_SESSION['TEMP']['PHP_temp']['login_pass1'] : '' );
$PHP_login_pass2 = !empty($_POST['PHP_login_pass2']) ? $_POST['PHP_login_pass2'] : ( !empty($_SESSION['TEMP']['PHP_temp']['login_pass2']) ? $_SESSION['TEMP']['PHP_temp']['login_pass2'] : '' );
$PHP_name = !empty($_POST['PHP_name']) ? $_POST['PHP_name'] : ( !empty($_SESSION['TEMP']['PHP_temp']['name']) ? $_SESSION['TEMP']['PHP_temp']['name'] : '' );
$PHP_phone = !empty($_POST['PHP_phone']) ? $_POST['PHP_phone'] : ( !empty($_SESSION['TEMP']['PHP_temp']['phone']) ? $_SESSION['TEMP']['PHP_temp']['phone'] : '' );
$PHP_cellphone = !empty($_POST['PHP_cellphone']) ? $_POST['PHP_cellphone'] : ( !empty($_SESSION['TEMP']['PHP_temp']['cellphone']) ? $_SESSION['TEMP']['PHP_temp']['cellphone'] : '' );
$PHP_email = !empty($_POST['PHP_email']) ? $_POST['PHP_email'] : ( !empty($_SESSION['TEMP']['PHP_temp']['email']) ? $_SESSION['TEMP']['PHP_temp']['email'] : '' );

$parm = array(
    "dept_code"		=>	$PHP_dept_code,
    "emp_id"		=>	$PHP_emp_id,
    "login_id"		=>	$PHP_login_id,
    "login_pass1"	=>	$PHP_login_pass1,
    "login_pass2"	=>	$PHP_login_pass2,
    "team_code"		=>	$PHP_team_code,
    "name"			=>	$PHP_name,
    "phone"			=>	$PHP_phone,
    "cellphone"		=>	$PHP_cellphone,
    "email"			=>	$PHP_email
);

$op['user'] = $parm;

$op['dept'] = $dept->get_field_value(' id,dept_name,dept_code ','');

$op['disabled']='disabled';

#如果有部門id開始判斷
if(!empty($PHP_dept)){
    $op['dept_k'] = $PHP_dept;

  # 抓取相同 Dept 的 Team Code
  $team_select = $team->get_field_value("id,team_code","where dept_code = '".$PHP_dept."' ");

  #轉換上面的陣列 [id]=>[team_code]
  $team_select = array_one($team_select);

  $op['team_select'] = $arry2->select_id($team_select,$PHP_team_code,'PHP_team_code','','select','change_data();');
  
  $op['disabled']=(!empty($PHP_team_code))?'':'disabled';
}

$op['dept_code'] = $PHP_dept;
$op['team_code'] = $PHP_team_code;

page_display($op,'046', $TPL_USER_ADD);
break;



case "do_user_add":
check_authority('046',"add");

$PHP_dept = !empty($_POST['PHP_dept']) ? $_POST['PHP_dept'] : '';
$PHP_dept_code = !empty($_POST['PHP_dept_code']) ? $_POST['PHP_dept_code'] : '';
$PHP_emp_id = !empty($_POST['PHP_emp_id']) ? $_POST['PHP_emp_id'] : '';
$PHP_login_id = !empty($_POST['PHP_login_id']) ? $_POST['PHP_login_id'] : '';
$PHP_login_pass1 = !empty($_POST['PHP_login_pass1']) ? $_POST['PHP_login_pass1'] : '';
$PHP_login_pass2 = !empty($_POST['PHP_login_pass2']) ? $_POST['PHP_login_pass2'] : '';
$PHP_team_code = !empty($_POST['PHP_team_code']) ? $_POST['PHP_team_code'] : '';
$PHP_name = !empty($_POST['PHP_name']) ? $_POST['PHP_name'] : '';
$PHP_phone = !empty($_POST['PHP_phone']) ? $_POST['PHP_phone'] : '';
$PHP_cellphone = !empty($_POST['PHP_cellphone']) ? $_POST['PHP_cellphone'] : '';
$PHP_email = !empty($_POST['PHP_email']) ? $_POST['PHP_email'] : '';

$parm = array(	
	"dept_code"		=>	$PHP_dept_code,
	"emp_id"		=>	$PHP_emp_id,
	"login_id"		=>	$PHP_login_id,
	"login_pass1"	=>	$PHP_login_pass1,
	"login_pass2"	=>	$PHP_login_pass2,
	"team_code"		=>	$PHP_team_code,
	"name"			=>	$PHP_name,
	"phone"			=>	$PHP_phone,
	"cellphone"		=>	$PHP_cellphone,
	"email"			=>	$PHP_email
);

// 先檢查 是否已選擇user的工作組別  抓出 perm
if (!$parm['team_code']) {
	$op['msg'][] ="Error ! please select Team code !";
	$_SESSION['TEMP']['PHP_temp'] = $parm;
	header ("Location: ".$PHP_SELF."?Ac=user_add");
	break;
}

$f1 = $user->check($parm);
if ($f1) {  // 成功輸入資料時
	$op['user'] = $parm;
	# 取出該組別代號的 perm
	$where_str = "team_code ='".$PHP_team_code."' AND dept_code='".$PHP_dept_code."' ";
	$parm['perm'] = $team->get_field('perm', $where_str);

	// 解開 permission
	if ($_SESSION['USER']['ADMIN']['team_id'] == "SA" || $_SESSION[$MYSQL_DB]['dept'] == "SA"){
		$perm_id = $team->get_team_id($PHP_dept_code,$PHP_team_code);
		$team_perm = $team->get_field('perm',"id ='".$perm_id."'");

		$team_perm = $admin->extra_perm_str($team_perm);
		$op['perm_me'] = $admin->decode_perm_str($team_perm);


		$perm_array = $admin->extra_perm_str($parm['perm']);
		$op['perm'] = $admin->decode_perm_str($perm_array);
	} else {
		# 比較Team&User
		$teams = $user->get_team($op['team']['perm'],$_SESSION['USER']['ADMIN']['dept'],$_SESSION['USER']['ADMIN']['team_id']);
		# Team
		$perm_array_me = $admin->extra_perm_str($teams);
		$op['perm_me'] = $admin->decode_perm_str($perm_array_me);	
		$op['perm'] = $op['perm_me'];	
	}

	$op['msg'] = $user->msg->get(2);
	unset($_SESSION['TEMP']['PHP_temp']);
	page_display($op,'046', $TPL_CFM_USER_ADD);
	break;

} else {

	$op['msg'] = $user->msg->get(2);
	$op['user'] = $parm;
	page_display($op,'046', $TPL_USER_ADD);
	break;

}


/**\
USER 新增確認
\**/
case "cfm_user_add":
$jobs = check_authority('046',"add");

$PHP_dept_code = !empty($_POST['PHP_dept_code']) ? $_POST['PHP_dept_code'] : '';
$PHP_emp_id = !empty($_POST['PHP_emp_id']) ? $_POST['PHP_emp_id'] : '';
$PHP_login_id = !empty($_POST['PHP_login_id']) ? $_POST['PHP_login_id'] : '';
$PHP_login_pass = !empty($_POST['PHP_login_pass']) ? $_POST['PHP_login_pass'] : '';
$PHP_team_code = !empty($_POST['PHP_team_code']) ? $_POST['PHP_team_code'] : '';
$PHP_name = !empty($_POST['PHP_name']) ? $_POST['PHP_name'] : '';
$PHP_phone = !empty($_POST['PHP_phone']) ? $_POST['PHP_phone'] : '';
$PHP_cellphone = !empty($_POST['PHP_cellphone']) ? $_POST['PHP_cellphone'] : '';
$PHP_email = !empty($_POST['PHP_email']) ? $_POST['PHP_email'] : '';
$PHP_perm_dec = !empty($_POST['PHP_perm_dec']) ? $_POST['PHP_perm_dec'] : '';

$parm = array(	
	"dept_code"		=>	$PHP_dept_code,
	"emp_id"		=>	$PHP_emp_id,
	"login_id"		=>	$PHP_login_id,
	"login_pass"	=>	$PHP_login_pass,
	"team_code"		=>	$PHP_team_code,
	"name"			=>	$PHP_name,
	"phone"			=>	$PHP_phone,
	"cellphone"		=>	$PHP_cellphone,
	"email"			=>	$PHP_email,
	"perm_dec"		=>	$PHP_perm_dec
);

$op['user'] = $parm;

// 權限陣列改成字串
$perm_array = $parm['perm_dec'];
$parm['perm'] = $admin->encode_perm_str($perm_array);

$f1 = $user->add($parm);

$m_sql = "id,login_id,name,dept,team_id,active";
$where_str = !empty($_SESSION['PAGE'][$PHP_action]['where_str']) ? $_SESSION['PAGE'][$PHP_action]['where_str'] : '' ;
if (!$op = $user->search('',$where_str,'user',$m_sql,$PHP_action)) {
	page_display($op,'046',$TPL_ERROR);
	break;
}

$mgr = get_manager_dept();   //找出管轄的部門範圍~~~~
$op['dept_select'] = $mgr['dept_select'];
$op['dept_id'] = $mgr['dept_id'];

# 記錄使用者動態
$log->log_add(0,'046',"Append USER: [".$parm['login_id']."]" );

page_display($op,'046',$TPL_USER,'user');
break;




/**\
USER 修改確認
\**/
case "do_user_edit":
$jobs = check_authority('046',"edit");

$PHP_id = !empty($_POST['PHP_id']) ? $_POST['PHP_id'] : '';
$PHP_dept = !empty($_POST['PHP_dept']) ? $_POST['PHP_dept'] : '';
$PHP_emp_id = !empty($_POST['PHP_emp_id']) ? $_POST['PHP_emp_id'] : '';
$PHP_login_id = !empty($_POST['PHP_login_id']) ? $_POST['PHP_login_id'] : '';
$PHP_team_code = !empty($_POST['PHP_team_code']) ? $_POST['PHP_team_code'] : '';
$PHP_name = !empty($_POST['PHP_name']) ? $_POST['PHP_name'] : '';
$PHP_phone = !empty($_POST['PHP_phone']) ? $_POST['PHP_phone'] : '';
$PHP_cellphone = !empty($_POST['PHP_cellphone']) ? $_POST['PHP_cellphone'] : '';
$PHP_email = !empty($_POST['PHP_email']) ? $_POST['PHP_email'] : '';
$PHP_perm_dec = !empty($_POST['PHP_perm_dec']) ? $_POST['PHP_perm_dec'] : '';

$argv = array(
	"id"			=>	$PHP_id,
	"dept"			=>	$PHP_dept,
	"emp_id"		=>	$PHP_emp_id,
	"login_id"		=>	$PHP_login_id,
	"team_id"		=>	$PHP_team_code,
	"name"			=>	$PHP_name,
	"phone"			=>	$PHP_phone,
	"cellphone"		=>	$PHP_cellphone,
	"email"			=>	$PHP_email,
	"perm_dec"		=>	$PHP_perm_dec
);

# 權限陣列改成字串
$perm_array = $argv['perm_dec'];
$argv['perm'] = $admin->encode_perm_str($perm_array);

# 更改討論版前先抓的檔案
$name = _name($PHP_login_id);

if (!$user->edit($argv)) {
  $op = array();
  page_display($op,'046',$TPL_ERROR);
  break;
}

$m_sql = "id,login_id,name,dept,team_id,active";
$where_str = " dept = '".$PHP_dept."' ";
if (!$op = $user->search(0,$where_str,'user',$m_sql,'user')) {
  page_display($op,'046',$TPL_ERROR);
  break;
}

# 記錄使用者動態
$message = "Update USER：[ $PHP_login_id ] context、limit•";
$log->log_add(0,'046',$message);

$mgr = get_manager_dept();   //找出管轄的部門範圍~~~~
$op['dept_select'] = $mgr['dept_select'];
$op['dept_id'] = $mgr['dept_id'];
$op['back_str'] = '&PHP_logid='.$PHP_logid."&PHP_dept=".$PHP_dept."&PHP_sr_startno=".$PHP_sr_startno;
$op['msg'][] = $message;


page_display($op,'046', $TPL_USER,'user');
break;





//=======================================================
case "user_disable":
check_authority('046',"del");

// 建立更新單獨欄位之陣列資料
$update = array();
$update['id'] = $PHP_id;
$update['field_name'] = "active";
$update['field_value'] = "N";

if (!$user->update_field($update)) {
	$op['msg'] = $user->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;	    
}

# 記錄使用者動態
$message = "USER:[$PHP_login_id]ex-rights•";
$log->log_add(0,"62D",$message);

$where_str = $manager_flag ='';

// -------------------- 判斷 進入的身份 是否為 GM , SA, 或 K0 的人 ------------------------------
$user_id = $GLOBALS['SCACHE']['ADMIN']['dept'];

// 如果是 manager 進入時...
//如果是 GM 或 SA 或 K0則傳回 部門下拉選單  
//業務單位則只列出業務部門選單 -----// 其餘皆傳回該部門ID
if($user_id == "K0"){

	$where_str = "dept LIKE 'K%' ";
	
	$manager_flag = 1;
	
} elseif ($user_id == "J0"){

	$where_str = "dept LIKE 'J%' ";
	
	$manager_flag = 1;
	
} elseif ($user_id == "T0"){

	$where_str = "dept LIKE 'T%' ";
	
	$manager_flag = 1;
	
} elseif ($user_id == "GM" || $user_id == "SA"){

	$manager_flag = 1;
	
} else {

	$where_str = " dept = '".$user_id."' ";
	
}

if (!$op = $user->search(2,$where_str)) {

	$op['msg']= $user->msg->get(2);
	
	$layout->assign($op);
	
	$layout->display($TPL_ERROR);  		
    
	break;
	
}

$mgr = get_manager_dept();   //找出管轄的部門範圍~~~~

// -------------------- 判斷 進入的身份 是否為 GM , SA, 或 K0 的人 ------------------------------
$op['dept_select'] = $mgr['dept_select'];

$op['dept_id'] = $mgr['dept_id'];

$op['manager_flag'] = $manager_flag;

$op['msg'][] = $message;

$op['sort']=$PHP_sort;

$op['back_str'] = '&PHP_logid='.$PHP_logid."&PHP_dept=".$PHP_dept."&PHP_name=".$PHP_name."&PHP_sr_startno=".$PHP_sr_startno;		

page_display($op,'046', $TPL_USER);
break;



//=======================================================
case "user_enable":
check_authority('046',"del");

// 建立更新單獨欄位之陣列資料
$update = array();

$update['id'] = $PHP_id;

$update['field_name'] = "active";

$update['field_value'] = "Y";

if (!$user->update_field($update)) {

	$op['msg'] = $user->msg->get(2);
	
	$layout->assign($op);
	
	$layout->display($TPL_ERROR);
	
	break;
	
}

# 記錄使用者動態
$message = "USER:[$PHP_login_id]re-rights•";

$log->log_add(0,"62D",$message);

$where_str = $manager_flag ='';

// -------------------- 判斷 進入的身份 是否為 GM , SA, 或 K0 的人 ------------------------------
$user_id = $GLOBALS['SCACHE']['ADMIN']['dept'];

// 如果是 manager 進入時...
//如果是 GM 或 SA 或 K0則傳回 部門下拉選單  
//業務單位則只列出業務部門選單 -----// 其餘皆傳回該部門ID
if ($user_id == "K0") {

	$where_str = " WHERE dept LIKE 'K%' ";

	$manager_flag = 1;

} elseif ($user_id == "J0") {

	$where_str = "dept LIKE 'J%' ";

	$manager_flag = 1;

} elseif ($user_id == "T0") {

	$where_str = "dept LIKE 'T%' ";

	$manager_flag = 1;

} elseif ($user_id == "GM" || $user_id == "SA") {

	$manager_flag = 1;

} else {

	$where_str = "dept = '".$user_id."' ";

}

if (!$op = $user->search(2,$where_str)) {

	$op['msg']= $user->msg->get(2);
	
	$layout->assign($op);
	
	$layout->display($TPL_ERROR);  		
    
	break;
	
}

$mgr = get_manager_dept();   //找出管轄的部門範圍~~~~

// -------------------- 判斷 進入的身份 是否為 GM , SA, 或 K0 的人 ------------------------------
$op['dept_select'] = $mgr['dept_select'];

$op['dept_id'] = $mgr['dept_id'];

$op['manager_flag'] = $manager_flag;

$op['msg'][] = $message;

$op['sort']=$PHP_sort;

$op['back_str'] = '&PHP_logid='.$PHP_logid."&PHP_dept=".$PHP_dept."&PHP_name=".$PHP_name."&PHP_sr_startno=".$PHP_sr_startno;		

page_display($op,'046', $TPL_USER);
break;



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "user_del":

// 必需要 manager login 才能真正的刪除 user
check_authority('046',"del");

$op['user'] = $user->get($PHP_id);

if (!$user->del($PHP_id)) {

	$op['msg'] = $user->msg->get(2);
	
	$layout->assign($op);
	
	$layout->display($TPL_ERROR);
	
	break;
	
}

# 記錄使用者動態
$message = "Delete Dept:[".$op['user']['dept']."]  USER:[".$op['user']['login_id']."]。";

$log->log_add(0,"62D",$message);

//----------------------------------------- new ----------------		
$where_str = $manager_flag ='';

// -------------------- 判斷 進入的身份 是否為 GM , SA, 或 K0 的人 ------------------------------
$user_id = $GLOBALS['SCACHE']['ADMIN']['dept'];

// 如果是 manager 進入時...
//如果是 GM 或 SA 或 K0則傳回 部門下拉選單  
//業務單位則只列出業務部門選單 -----// 其餘皆傳回該部門ID
if($user_id == "K0"){

	$where_str = " WHERE dept LIKE 'K%' ";
	
	$manager_flag = 1;
	
}elseif($user_id == "GM" || $user_id == "SA"){

	$manager_flag = 1;
	
}else{

	$where_str = " WHERE dept = '".$user_id."' ";
	
}

if (!$op = $user->search(0,$where_str)) {

	$op['msg']= $user->msg->get(2);

	$layout->assign($op);

	$layout->display($TPL_ERROR);

	break;

}

$mgr = get_manager_dept();   //找出管轄的部門範圍~~~~

// -------------------- 判斷 進入的身份 是否為 GM , SA, 或 K0 的人 ------------------------------
$op['dept_select'] = $mgr['dept_select'];

$op['dept_id'] = $mgr['dept_id'];

$op['manager_flag'] = $manager_flag;

$op['msg'][] = $message;

page_display($op,'046', $TPL_USER);
break;



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 61 TEAM
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "team":

if(!$admin->is_power('045',"view")){

	$op['msg'][] = "sorry! you don't have this Authorized !";
	
	$layout->assign($op);
	
	$layout->display($TPL_ERROR);
	
	break;
	
}

if (!$op = $team->search(0)) {

	$op['msg']= $team->msg->get(2);
	
	$layout->assign($op);
	
	$layout->display($TPL_ERROR);

	break;

}

$op['msg'] = $team->msg->get(2);

$allow = $admin->decode_perm('045');   // 設定 新增刪改權限

if ($op['msg']){ $op['msg_YES'] = 1; } else { $op['msg_YES'] = "" ;}

if ($allow['view'])		{	$op['view_flag'] = 1;} else {	$op['view_flag'] = "";}

if ($allow['add'])		{	$op['add_flag'] = 1;} else {	$op['add_flag'] = "";}

if ($allow['edit'])		{	$op['edit_flag'] = 1;} else {	$op['edit_flag'] = "";}

if ($allow['del'])		{	$op['del_flag'] = 1;} else {	$op['del_flag'] = "";}


$op['now_pp'] = $PHP_sr_startno;

$layout->assign($op);

$layout->display($TPL_TEAM);

break;



/**\
TEAM 新增
\**/
case "team_add":
$jobs = check_authority('045',"add");

$PHP_dept = !empty($_GET['PHP_dept']) ? $_GET['PHP_dept'] : (!empty($_POST['PHP_dept'])?$_POST['PHP_dept']:'') ;
$PHP_team_code = !empty($_GET['PHP_team_code']) ? $_GET['PHP_team_code'] : '';
$PHP_team_name = !empty($_GET['PHP_team_name']) ? $_GET['PHP_team_name'] : '';

# 編碼
if($_SESSION['USER']['ADMIN']['team_id'] == "SA" || $_SESSION[$MYSQL_DB]['dept'] == "SA"){
  $op['perm_me'] = $admin->decode_perm_str($_SESSION['USER']['ADMIN']['perm_dec']);
  $op['perm'] = $op['perm_me'];
}else{
  # 比較Team&User
  $teams = $user->get_team($op['team']['perm'],$_SESSION['USER']['ADMIN']['dept'],$_SESSION['USER']['ADMIN']['team_id']);
  # Team
  $perm_array_me = $admin->extra_perm_str($teams);
  $op['perm_me'] = $admin->decode_perm_str($perm_array_me);
  # User
  $op['perm'] = $op['perm_me'];				
}

$depts = $dept->get_field_value("id,dept_code,dept_name");
$op['dept_list'] = $depts;
$op['dept_k'] = $PHP_dept;#傳回的資料
$op['team_code'] = $PHP_team_code;
$op['team_name'] = $PHP_team_name;

if(!empty($PHP_dept)){
  foreach($depts as $key => $val){
    if($val[1] == $PHP_dept )$op['dept'] = $val[1].' - '.$val[2];
  }
}

page_display($op,'045', $TPL_TEAM_ADD);
break;

 
	
/**\
TEAM 新增確認
\**/
case "do_team_add":
$jobs = check_authority('045',"add");

$PHP_team_code = !empty($_POST['PHP_team_code']) ? $_POST['PHP_team_code'] : '' ;
$PHP_team_name = !empty($_POST['PHP_team_name']) ? $_POST['PHP_team_name'] : '' ;
$PHP_dept_code = !empty($_POST['PHP_dept_code']) ? $_POST['PHP_dept_code'] : '' ;
$PHP_dept = !empty($_POST['PHP_dept']) ? $_POST['PHP_dept'] : '' ;
$PHP_perm_dec = !empty($_POST['PHP_perm_dec']) ? $_POST['PHP_perm_dec'] : '' ;

$parm = array(
	"team_code"	=>	$PHP_team_code,
	"team_name"	=>	$PHP_team_name,
	"dept_code"	=>	$PHP_dept_code,
	"dept"		=>	$PHP_dept,
	"perm"		=>	$PHP_perm_dec
);

$f1 = $team->add($parm);

if ($f1) {

	# 記錄使用者動態
	$log->log_add(0,'045',"Append Dept : [".$PHP_dept_code."] Team : [".$PHP_team_code."] limit" );

	unset($parm);  // 刪除 參數

} else {

	$op['team'] = $parm;
	$op['dept'] = $PHP_dept_code;
	$op['dept_k'] = $PHP_dept_code;

	// manager 進入時... 部門別 select 選單
	$op['dept_id'] = get_dept_id();

	# 編碼
	if($_SESSION['USER']['ADMIN']['team_id'] == "SA" || $_SESSION[$MYSQL_DB]['dept'] == "SA"){

		$op['perm_me'] = $admin->decode_perm_str($_SESSION['USER']['ADMIN']['perm_dec']);
		$parm = $admin->encode_perm_str($parm['perm']);
		$parm = $admin->extra_perm_str($parm);
		$op['perm'] = $admin->decode_perm_str($parm);

	} else {

		# 比較Team&User
		$teams = $user->get_team($op['team']['perm'],$_SESSION['USER']['ADMIN']['dept'],$_SESSION['USER']['ADMIN']['team_id']);

		# Team
		$perm_array_me = $admin->extra_perm_str($teams);
		$op['perm_me'] = $admin->decode_perm_str($perm_array_me);

		# User
		$parm = $admin->encode_perm_str($parm['perm']);
		$parm = $admin->extra_perm_str($parm);
		$op['perm'] = $admin->decode_perm_str($parm);

	}

	$depts = $dept->get_field_value("id,dept_code,dept_name");
	$op['dept_list'] = $depts;
	$op['dept_k'] = $PHP_dept;#傳回的資料
	$op['team_code'] = $PHP_team_code;
	$op['team_name'] = $PHP_team_name;

	if(!empty($PHP_dept)){

		foreach($depts as $key => $val){

			if($val[1] == $PHP_dept )$op['dept'] = $val[1].' - '.$val[2];

		}

	}

	page_display($op,'045', $TPL_TEAM_ADD,'team_add');
	break;
}

$m_sql = "id,dept_code,team_code,team_name";

$PHP_action = 'team';

$where_str = !empty($_SESSION['PAGE'][$PHP_action]['where_str']) ? $_SESSION['PAGE'][$PHP_action]['where_str'] : '' ;

if (!$op = $team->search('',$where_str,'team',$m_sql,'team')) {

	$op = array();
	
	page_display($op,'045',$TPL_ERROR);
	break;

}

page_display($op,'045', $TPL_TEAM,'team');
break;

	

/**\
TEAM 檢視
\**/
case "team_view":
check_authority('045',"view");

$op['team'] = $team->get($_GET['PHP_id']);  //取出該筆記錄

if (!$op['team']) {

	page_display($op,'045',$TPL_ERROR);
	break;
	
}

$dept = $dept->get_field_value("id,dept_code,dept_name");

if(!empty($dept)){

	foreach($dept as $key => $val){
	
		if($val['dept_code'] == $op['team']['dept_code'])$op['depr_list'] = $val['dept_code'].' - '.$val['dept_name'];
		
	}
	
}

if ($_SESSION['USER']['ADMIN']['team_id'] == "SA" || $_SESSION[$MYSQL_DB]['dept'] == "SA"){

	$op['perm_me'] = $admin->decode_perm_str($_SESSION['USER']['ADMIN']['perm_dec']);

	$perm_array = $admin->extra_perm_str($op['team']['perm']);

	$op['perm'] = $admin->decode_perm_str($perm_array);	

} else {

	# 比較Team&User
	$teams = $user->get_team($op['team']['perm'],$_SESSION['USER']['ADMIN']['dept'],$_SESSION['USER']['ADMIN']['team_id']);

	# Team
	$perm_array_me = $admin->extra_perm_str($teams);
	$op['perm_me'] = $admin->decode_perm_str($perm_array_me);

	# User
	$perm_array = $admin->extra_perm_str($op['team']['perm']);
	$op['perm'] = $admin->decode_perm_str($perm_array);

}

page_display($op,'045', $TPL_TEAM_VIEW);
break;



/**\
TEAM 修改
\**/
case "team_edit":
$jobs = check_authority('045',"edit");

$PHP_id = !empty($_GET['PHP_id']) ? $_GET['PHP_id'] : (!empty($_POST['PHP_id'])?$_POST['PHP_id']:'') ;

$PHP_dept = !empty($_GET['PHP_dept']) ? $_GET['PHP_dept'] : (!empty($_POST['PHP_dept'])?$_POST['PHP_dept']:'') ;

$PHP_team_code = !empty($_GET['PHP_team_code']) ? $_GET['PHP_team_code'] : '';

$PHP_team_name = !empty($_GET['PHP_team_name']) ? $_GET['PHP_team_name'] : '';

if($PHP_dept){

	$parm['field_name'] = 'dept_code';
	
	$parm['field_value'] = $PHP_dept;
	
	$parm['id'] = $PHP_id;
	
	#$team->update_field($parm);
	$op['team'] = $team->get($PHP_id);
	
	$op['dept_id'] = get_dept_id();
	
} else {

	$op['team'] = $team->get($PHP_id);
	
	$op['dept_id'] = get_dept_id();
	
	$PHP_dept = $op['team']['dept_code'];
	
}

if (!$op['team']) {

	page_display($op,'045',$TPL_ERROR);
	break;
  
}
// print_r($_SESSION[$MYSQL_DB]);
# 編碼
if ($_SESSION['USER']['ADMIN']['team_id'] == "SA" || $_SESSION[$MYSQL_DB]['dept'] == "SA"){
    // $_SESSION[$MYSQL_DB]['perm_dec']

	$op['perm_me'] = $admin->decode_perm_str($admin->full_perm());
	
	$perm_array = $admin->extra_perm_str($op['team']['perm']);
	
	$op['perm'] = $admin->decode_perm_str($perm_array);
	
}else{

	# 比較Team&User
	$teams = $user->get_team($op['team']['perm'],$_SESSION['USER']['ADMIN']['dept'],$_SESSION['USER']['ADMIN']['team_id']);
	
	# Team
	$perm_array_me = $admin->extra_perm_str($teams);
	$op['perm_me'] = $admin->decode_perm_str($perm_array_me);
	
	# User
	$perm_array = $admin->extra_perm_str($op['team']['perm']);
	$op['perm'] = $admin->decode_perm_str($perm_array);
	
}

$op['dept_k'] = $PHP_dept;#傳回的資料

$_SESSION['TEMP']['dept_k'] = $PHP_dept;

$op['team_code'] = $PHP_team_code;

$op['team_name'] = $PHP_team_name;

$depts = $dept->get_field_value("id,dept_code,dept_name");

$op['dept_list'] = $depts;

if(!empty($PHP_dept)){

	foreach($depts as $key => $val){
	
		if($val['dept_code'] == $PHP_dept )$op['dept'] = $val['dept_code'].' - '.$val['dept_name'];
		
	}
	
}

page_display($op,'045', $TPL_TEAM_EDIT);

break;



/**\
TEAM 修改確認
\**/
case "do_team_edit":
$jobs = check_authority('045',"edit");

$PHP_id = !empty($_POST['PHP_id']) ? $_POST['PHP_id'] : '' ;
$PHP_dept_code = !empty($_POST['PHP_dept_code']) ? $_POST['PHP_dept_code'] : '' ;
$PHP_team_code = !empty($_POST['PHP_team_code']) ? $_POST['PHP_team_code'] : '' ;
$PHP_team_name = !empty($_POST['PHP_team_name']) ? $_POST['PHP_team_name'] : '' ;
$PHP_perm_dec = !empty($_POST['PHP_perm_dec']) ? $_POST['PHP_perm_dec'] : '' ;

$argv = array(
	"id"			=> $PHP_id,
	"team_code"		=> $PHP_team_code,
	"team_name"		=> $PHP_team_name,
	"dept_code"		=> $PHP_dept_code,
	"perm"			=> $PHP_perm_dec
);

if (!$team->edit($argv)) {

	page_display($op,'045',$TPL_ERROR);
	break;
	
}

// 列出所有的記錄~~~
$m_sql = "id,dept_code,team_code,team_name";

$PHP_action = 'team';

$where_str = !empty($_SESSION['PAGE'][$PHP_action]['where_str']) ? $_SESSION['PAGE'][$PHP_action]['where_str'] : '' ;

if (!$op = $team->search('',$where_str,'team',$m_sql,'team')) {

	page_display($op,'045',$TPL_ERROR);
	break;

}

$message = "Success Update Detp : [ $PHP_dept_code ] Team :[ $PHP_team_name ]context and limit•";
$op['msg'][] = $message;

# 記錄使用者動態
$log->log_add(0,'045',$message);

page_display($op,'045', $TPL_TEAM);
break;



/**\
TEAM 刪除
\**/
case "team_del":
$jobs = check_authority('045',"del");

$PHP_id = !empty($_GET['PHP_id']) ? $_GET['PHP_id'] : (!empty($_POST['PHP_id'])?$_POST['PHP_id']:'') ;
$PHP_del = !empty($_GET['PHP_del']) ? $_GET['PHP_del'] : '';

if ($PHP_del == 'ok'){

	$teams = $team->get($PHP_id);

	if (!$team->del($PHP_id)) {
	
		page_display($op,'045',$TPL_ERROR);
		break;
		
	}

}

# 記錄使用者動態
$message = "Delete Dept : [".$teams['dept_code']."] Team :[".$teams['team_name']."]。";

$log->log_add(0,'045',$message);	

$m_sql = "id,dept_code,team_code,team_name";

$PHP_action = 'team';

$where_str = !empty($_SESSION['PAGE'][$PHP_action]['where_str']) ? $_SESSION['PAGE'][$PHP_action]['where_str'] : '' ;

if (!$op = $team->search('',$where_str,'team',$m_sql,'team')) {

	$op = array();
	page_display($op,'045',$TPL_ERROR);
	break;
  
}

$op['msg'][] = $message;

page_display($op,'045', $TPL_TEAM);
break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//   dept 部份
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++



/**\
DEPT 清單
\**/
case "dept":
$jobs = check_authority('054',"view");

$m_sql = "id,dept_name,dept_code,chief";

$set_dept = str_replace ("dept", "dept_code",get_search('dept','dept_code'));

$set_dept = str_replace ("factory", "dept_code",$set_dept);

$where_str = !empty($_SESSION['PAGE'][$PHP_action]['where_str']) ? $_SESSION['PAGE'][$PHP_action]['where_str'] : '' ;

if (!$op = $dept->search('',$where_str,'dept',$m_sql,$PHP_action,10,$set_dept)) {

	page_display($op,'054',$TPL_ERROR);
	break;

}

$op['PHP_action'] = $PHP_action;
page_display($op,'054', $TPL_DEPT);
break;



/**\
DEPT 更新
\**/
case "dept_update":
$jobs = check_authority('054',"edit");

$op['dept'] = $dept->get($_GET['PHP_id']);

page_display($op,'054', $TPL_DEPT_UPDATE,$PHP_action);
break;




/**\
DEPT 更新確認
\**/
case "do_dept_updat":
$jobs = check_authority('054',"edit");

$PHP_id = !empty($_POST['PHP_id']) ? $_POST['PHP_id'] : '' ;
$PHP_dept_code = !empty($_POST['PHP_dept_code']) ? $_POST['PHP_dept_code'] : '' ;
$PHP_dept_name = !empty($_POST['PHP_dept_name']) ? $_POST['PHP_dept_name'] : '' ;
$PHP_chief = !empty($_POST['PHP_chief']) ? $_POST['PHP_chief'] : '' ;

$argv = array(	"id"        => $PHP_id,
                "dept_code" => $PHP_dept_code,
                "dept_name"	=> $PHP_dept_name,
                "chief"     => $PHP_chief);

if (!$dept->update($argv)) {
  page_display($op,'054',$TPL_ERROR);
  break;	    
}

$m_sql = "id,dept_name,dept_code,chief";
$set_dept = str_replace ("dept", "dept_code",get_search('dept','dept_code'));
$set_dept = str_replace ("factory", "dept_code",$set_dept);
$PHP_action= 'dept';
$where_str = !empty($_SESSION['PAGE'][$PHP_action]['where_str']) ? $_SESSION['PAGE'][$PHP_action]['where_str'] : '' ;
if (!$op = $dept->search('',$where_str,'dept',$m_sql,$PHP_action,10,$set_dept)) {
  $op = array();
  page_display($op,'054',$TPL_ERROR);
  break;
}

$_SESSION['msg'][] = "成功更新[ $PHP_dept_name ]部門別資料記錄。";
$log->log_add(0,'054',$jobs.'：'."成功更新[ $PHP_dept_name ]部門別資料記錄。");

page_display($op,'054', $TPL_DEPT,'dept');
break;



/**\
DEPT 刪除
\**/
case "dept_del":
$jobs = check_authority('054',"del");

$PHP_del = !empty($_GET['PHP_del']) ? $_GET['PHP_del'] : '' ;
$PHP_id = !empty($_GET['PHP_id']) ? $_GET['PHP_id'] : '' ;

if ($PHP_del == 'ok'){
  $op['dept'] = $dept->get($PHP_id);
  if (!$dept->del($PHP_id)) {
    page_display($op,'054',$TPL_ERROR);
    break;	    
  }
}

$message = "刪除部門別 :[".$op['dept']['dept_name']."]。";

$m_sql = "id,dept_name,dept_code,chief";
$set_dept = str_replace ("dept", "dept_code",get_search('dept','dept_code'));
$set_dept = str_replace ("factory", "dept_code",$set_dept);
$PHP_action= 'dept';
$where_str = !empty($_SESSION['PAGE'][$PHP_action]['where_str']) ? $_SESSION['PAGE'][$PHP_action]['where_str'] : '' ;
if (!$op = $dept->search('',$where_str,'dept',$m_sql,$PHP_action,10,$set_dept)) {
  $op = array();
  page_display($op,'054',$TPL_ERROR);
  break;
}

$_SESSION['msg'][] = $message;

$log->log_add(0,'054',$jobs.'：'.$message);
page_display($op,'054', $TPL_DEPT,'dept');
break;



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "do_dept_add":
check_authority('054',"add");

$parm = array(
    "dept_code" =>	$PHP_dept_code,
    "dept_name" =>	$PHP_dept_name,
    "chief"     =>	$PHP_chief
);

$f1 = $dept->add($parm);
if ($f1) {
    unset($parm);  // 刪除 參數
}	else {
    $op['dept'] = $parm;
}

if (!$op = $dept->search(0)) {
    $op = array();
    $op['msg']= $dept->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}

$m_sql = "id,dept_name,dept_code,chief";

$set_dept = str_replace ("dept", "dept_code",get_search('dept','dept_code'));

$set_dept = str_replace ("factory", "dept_code",$set_dept);

$where_str = !empty($_SESSION['PAGE'][$PHP_action]['where_str']) ? $_SESSION['PAGE'][$PHP_action]['where_str'] : '' ;

if (!$op = $dept->search('',$where_str,'dept',$m_sql,$PHP_action,10,$set_dept)) {

	page_display($op,'054',$TPL_ERROR);
	break;

}
         
$op['msg'] = $dept->msg->get(2);
         
page_display($op,'054', $TPL_DEPT);   	    
break;




#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//   smpl_type 部份
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	  case "smpl_type":

		if(!$admin->is_power('049',"view")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

if ($PHP_sr_startno){
	$GLOBALS['PHP_sr_startno'] = $PHP_sr_startno;
}

		if (!$op = $smpl_type->search(0)) {
			$op['msg']= $smpl_type->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['msg'] = $smpl_type->msg->get(2);

		if ($op['msg']){ $op['msg_YES'] = 1; } else { $op['msg_YES'] = "" ;}
		$allow = $admin->decode_perm('049');   // 設定 新增刪改權限
		if ($allow['view'])		{	$op['view_flag'] = 1;} else {	$op['view_flag'] = "";}
		if ($allow['add'])		{	$op['add_flag'] = 1;} else {	$op['add_flag'] = "";}
		if ($allow['edit'])		{	$op['edit_flag'] = 1;} else {	$op['edit_flag'] = "";}
		if ($allow['del'])		{	$op['del_flag'] = 1;} else {	$op['del_flag'] = "";}

		$layout->assign($op);
		$layout->display($TPL_SMPL_TYPE);		    	    
	break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "do_smpl_type_add":

		check_authority('049',"add");

		$parm = array(	"smpl_type"		=>	$PHP_smpl_type,
										"des"					=>	$PHP_des
					);

		$f1 = $smpl_type->add($parm);
		if ($f1) {
			unset($parm);  // 刪除 參數
		}	else {
			$op['smpl_type'] = $parm;
		}

		if (!$op = $smpl_type->search(0)) {
			$op = array();
			$op['msg']= $smpl_type->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['msg'] = $smpl_type->msg->get(2);
    
		page_display($op,'049', $TPL_SMPL_TYPE);	    
	break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "smpl_type_update":

		check_authority('049',"edit");
		$op['smpl_type'] = $smpl_type->get($PHP_id);

		page_display($op,'049', $TPL_SMPL_TYPE_UPDATE);
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "do_smpl_type_updat":


		check_authority('049',"edit");

		$argv = array(	"id"			=> $PHP_id,
						"smpl_type"		=> $PHP_smpl_type,
						"des"			=> $PHP_des
					);
		if (!$smpl_type->update($argv)) {
			$op['msg'] = $smpl_type->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}

		if (!$op = $smpl_type->search(0)) {
			$op = array();
			$op['msg']= $smpl_type->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['msg'][] = "成功更新[ $PHP_smpl_type]樣品別資料記錄。";
	    	    
		page_display($op,'049', $TPL_SMPL_TYPE);
	break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "smpl_type_del":

		if(!$admin->is_power('049',"add")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['smpl_type'] = $smpl_type->get($PHP_id);
		
		if (!$smpl_type->del($PHP_id)) {
			$op['msg'] = $smpl_type->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}

		$message = "成功刪除樣品別 :[".$op['smpl_type']['smpl_type']."]。";

		if (!$op = $smpl_type->search(0)) {
			$op = array();
			$op['msg']= $smpl_type->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['msg'][] = $message;

			if ($op['msg']){ $op['msg_YES'] = 1; } else { $op['msg_YES'] = "" ;}
			$allow = $admin->decode_perm('049');   // 設定 新增刪改權限
			if ($allow['view'])	{	$op['view_flag'] = 1;} else {	$op['view_flag'] = "";}
			if ($allow['add'])	{	$op['add_flag'] = 1;} else {	$op['add_flag'] = "";}
			if ($allow['edit'])	{	$op['edit_flag'] = 1;} else {	$op['edit_flag'] = "";}
			if ($allow['del'])	{	$op['del_flag'] = 1;} else {	$op['del_flag'] = "";}

		$layout->assign($op);
		$layout->display($TPL_SMPL_TYPE);		    	    
	break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//   style_type 部份
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	  case "style_type":

		if(!$admin->is_power('050',"view")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		if (!$op = $style_type->search(0)) {
			$op['msg']= $style_type->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['msg'] = $style_type->msg->get(2);

		if ($op['msg']){ $op['msg_YES'] = 1; } else { $op['msg_YES'] = "" ;}
		$allow = $admin->decode_perm('050');   // 設定 新增刪改權限
		if ($allow['view'])		{	$op['view_flag'] = 1;} else {	$op['view_flag'] = "";}
		if ($allow['add'])		{	$op['add_flag'] = 1;} else {	$op['add_flag'] = "";}
		if ($allow['edit'])		{	$op['edit_flag'] = 1;} else {	$op['edit_flag'] = "";}
		if ($allow['del'])		{	$op['del_flag'] = 1;} else {	$op['del_flag'] = "";}

		$layout->assign($op);
		$layout->display($TPL_STYLE_TYPE);		    	    
	break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "do_style_type_add":


		if(!$admin->is_power('050',"add")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$parm = array(	"style_type"	=>	$PHP_style_type,
						"des"			=>	$PHP_des
				);

		$f1 = $style_type->add($parm);
		if ($f1) {
			unset($parm);  // 刪除 參數
		}	else {
			$op['style_type'] = $parm;
		}

		if (!$op = $style_type->search(0)) {
			$op = array();
			$op['msg']= $style_type->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

			$op['msg'] = $style_type->msg->get(2);
			if ($op['msg']){ $op['msg_YES'] = 1; } else { $op['msg_YES'] = "" ;}
			$allow = $admin->decode_perm('050');   // 設定 新增刪改權限
			if ($allow['view'])		{	$op['view_flag'] = 1;} else {	$op['view_flag'] = "";}
			if ($allow['add'])		{	$op['add_flag'] = 1;} else {	$op['add_flag'] = "";}
			if ($allow['edit'])		{	$op['edit_flag'] = 1;} else {	$op['edit_flag'] = "";}
			if ($allow['del'])		{	$op['del_flag'] = 1;} else {	$op['del_flag'] = "";}

		$layout->assign($op);
		$layout->display($TPL_STYLE_TYPE);		    	    
	break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "style_type_update":


		if(!$admin->is_power('050',"edit")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['style_type'] = $style_type->get($PHP_id);
		$op['msg'][] = "更新款式類別資料記錄 :".$op['style_type']['style_type'];
		$msg_YES = 1;
		$layout->assign($op);
		$layout->display($TPL_STYLE_TYPE_UPDATE);  
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "do_style_type_updat":

		if(!$admin->is_power('050',"edit")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$argv = array(	"id"			=> $PHP_id,
						"style_type"	=> $PHP_style_type,
						"des"			=> $PHP_des
					);
		if (!$style_type->update($argv)) {
			$op['msg'] = $style_type->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}

		if (!$op = $style_type->search(0)) {
			$op = array();
			$op['msg']= $style_type->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['msg'][] = "成功更新[ $PHP_style_type ] 款式類別資料記錄。";

			if ($op['msg']){ $op['msg_YES'] = 1; } else { $op['msg_YES'] = "" ;}
			$allow = $admin->decode_perm('050');   // 設定 新增刪改權限
			if ($allow['view'])	{	$op['view_flag'] = 1;} else {	$op['view_flag'] = "";}
			if ($allow['add'])	{	$op['add_flag'] = 1;} else {	$op['add_flag'] = "";}
			if ($allow['edit'])	{	$op['edit_flag'] = 1;} else {	$op['edit_flag'] = "";}
			if ($allow['del'])	{	$op['del_flag'] = 1;} else {	$op['del_flag'] = "";}

		$layout->assign($op);
		$layout->display($TPL_STYLE_TYPE);		    	    
		
	break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "style_type_del":

		if(!$admin->is_power('050',"del")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['style_type'] = $style_type->get($PHP_id);
		
		if (!$style_type->del($PHP_id)) {
			$op['msg'] = $style_type->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}

		$message = "成功 刪除款式類別 :[".$op['style_type']['style_type']."]。";

		if (!$op = $style_type->search(0)) {
			$op = array();
			$op['msg']= $style_type->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['msg'][] = $message;

			if ($op['msg']){ $op['msg_YES'] = 1; } else { $op['msg_YES'] = "" ;}
			$allow = $admin->decode_perm('050');   // 設定 新增刪改權限
			if ($allow['view'])	{	$op['view_flag'] = 1;} else {	$op['view_flag'] = "";}
			if ($allow['add'])	{	$op['add_flag'] = 1;} else {	$op['add_flag'] = "";}
			if ($allow['edit'])	{	$op['edit_flag'] = 1;} else {	$op['edit_flag'] = "";}
			if ($allow['del'])	{	$op['del_flag'] = 1;} else {	$op['del_flag'] = "";}

		$layout->assign($op);
		$layout->display($TPL_STYLE_TYPE);		    	    
	break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//   season 部份
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	  case "season":

		if(!$admin->is_power(7,4,"view")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		if (!$op = $season->search(0)) {
			$op['msg']= $season->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['msg'] = $season->msg->get(2);

		if ($op['msg']){ $op['msg_YES'] = 1; } else { $op['msg_YES'] = "" ;}
		$allow = $admin->decode_perm(7,4);   // 設定 新增刪改權限
		if ($allow['view'])		{	$op['view_flag'] = 1;} else {	$op['view_flag'] = "";}
		if ($allow['add'])		{	$op['add_flag'] = 1;} else {	$op['add_flag'] = "";}
		if ($allow['edit'])		{	$op['edit_flag'] = 1;} else {	$op['edit_flag'] = "";}
		if ($allow['del'])		{	$op['del_flag'] = 1;} else {	$op['del_flag'] = "";}

		$layout->assign($op);
		$layout->display($TPL_SEASON);		    	    
	break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "do_season_add":

		if(!$admin->is_power(7,4,"add")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$parm = array(	"season"	=>	$PHP_season,
						"des"		=>	$PHP_des
				);

		$f1 = $season->add($parm);
		if ($f1) {
			unset($parm);  // 刪除 參數
		}	else {
			$op['season'] = $parm;
		}

		if (!$op = $season->search(0)) {
			$op = array();
			$op['msg']= $season->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

			$op['msg'] = $season->msg->get(2);
			$allow = $admin->decode_perm(7,4);   // 設定 新增刪改權限
			if ($op['msg']){ $op['msg_YES'] = 1; } else { $op['msg_YES'] = "" ;}
			if ($allow['view'])		{	$op['view_flag'] = 1;} else {	$op['view_flag'] = "";}
			if ($allow['add'])		{	$op['add_flag'] = 1;} else {	$op['add_flag'] = "";}
			if ($allow['edit'])		{	$op['edit_flag'] = 1;} else {	$op['edit_flag'] = "";}
			if ($allow['del'])		{	$op['del_flag'] = 1;} else {	$op['del_flag'] = "";}

		$layout->assign($op);
		$layout->display($TPL_SEASON);		    	    
	break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "season_update":

		if(!$admin->is_power(7,4,"edit")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['season'] = $season->get($PHP_id);
		$op['msg'][] = "更新季節類別資料記錄 :".$op['season']['season'];
		$msg_YES = 1;
		$layout->assign($op);
		$layout->display($TPL_SEASON_UPDATE);  
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "do_season_updat":

		if(!$admin->is_power(7,4,"edit")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$argv = array(	"id"		=> $PHP_id,
						"season"	=> $PHP_season,
						"des"		=> $PHP_des
					);
		if (!$season->update($argv)) {
			$op['msg'] = $season->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}
		if (!$op = $season->search(0)) {
			$op = array();
			$op['msg']= $season->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}


		$op['msg'][] = "成功更新[ $PHP_season ] 季節別資料記錄。";

			if ($op['msg']){ $op['msg_YES'] = 1; } else { $op['msg_YES'] = "" ;}
			$allow = $admin->decode_perm(7,4);   // 設定 新增刪改權限
			if ($allow['view'])	{	$op['view_flag'] = 1;} else {	$op['view_flag'] = "";}
			if ($allow['add'])	{	$op['add_flag'] = 1;} else {	$op['add_flag'] = "";}
			if ($allow['edit'])	{	$op['edit_flag'] = 1;} else {	$op['edit_flag'] = "";}
			if ($allow['del'])	{	$op['del_flag'] = 1;} else {	$op['del_flag'] = "";}

		$layout->assign($op);
		$layout->display($TPL_SEASON);		    	    
		
	break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "season_del":

		if(!$admin->is_power(7,4,"del")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['season'] = $season->get($PHP_id);
		
		if (!$season->del($PHP_id)) {
			$op['msg'] = $season->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}

		$message = "成功 刪除季節類別 :[".$op['season']['season']."]。";

		if (!$op = $season->search(0)) {
			$op = array();
			$op['msg']= $season->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		$op['msg'][] = $message;

			if ($op['msg']){ $op['msg_YES'] = 1; } else { $op['msg_YES'] = "" ;}
			$allow = $admin->decode_perm(7,4);   // 設定 新增刪改權限
			if ($allow['view'])	{	$op['view_flag'] = 1;} else {	$op['view_flag'] = "";}
			if ($allow['add'])	{	$op['add_flag'] = 1;} else {	$op['add_flag'] = "";}
			if ($allow['edit'])	{	$op['edit_flag'] = 1;} else {	$op['edit_flag'] = "";}
			if ($allow['del'])	{	$op['del_flag'] = 1;} else {	$op['del_flag'] = "";}

		$layout->assign($op);
		$layout->display($TPL_SEASON);		    	    
	break;



 
 

 
 
 
 
 
 
 
 






#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		system part
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "login":
		if (!is_admin_login()) {
			$layout->display($TPL_LOGIN);		    
		}	else {
			$op['auth'] = $GLOBALS['SCACHE']['ADMIN'];
			$layout->assign($op);
			$layout->display($TPL_ADMIN_MAIN);		    	    
		}
		break;
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//========================== same as "do_login" bellow....=====================
default;
case "exe_login":
	
$PHP_login_id = !empty($PHP_login_id) ? $PHP_login_id : '';
$PHP_login_pass = !empty($PHP_login_pass) ? $PHP_login_pass : '';

$f1 = $admin->login($PHP_login_id, $PHP_login_pass);
// if($GLOBALS['SCACHE']['ADMIN']['team_id'] == 'GT'){
	// header("Location: http://scm-b.carnival.com.tw/mode/demo/index2.php");
// }
if ($f1) {

	# 記錄使用者動態
	$log->log_add($GLOBALS['SCACHE']['ADMIN']['name'],"login","login。");

	# 定義一些個人參數
	$GLOBALS['MY_DEPT'] = $GLOBALS['SCACHE']['ADMIN']['dept'];
	$GLOBALS['MY_TEAM'] = $GLOBALS['SCACHE']['ADMIN']['team_id'];
	$GLOBALS['ME'] = $GLOBALS['SCACHE']['ADMIN']['name'];
	echo "<script></script>";
	$op['forum'] = '<a href="forum.php" target="main">forum</A>';
	if($GLOBALS['SCACHE']['ADMIN']['team_id']=="SA")
	$op['sys_admin'] = '[<a href="para.php?PHP_action=para_set" target="main">Setting</A>]';
	
	$layout->assign($op);
	$layout->display($TPL_MAIN);
	
}	else {
	# 記錄使用者動態
	$log->log_add(0,"login","cannot login。($PHP_login_id : $PHP_login_pass)");

	$op['msg'] = $admin->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_LOGIN);		    
}
break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "main": 
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
  case "main":
	
	if( !isset($GLOBALS['SCACHE']['ADMIN']['login_id']) || !isset( $GLOBALS['SCACHE']['ADMIN']['dept']))
	{
		$op['msg'][] = "停滯時間過久,請重新登入系統";
		$layout->assign($op);
		$layout->display($TPL_ERROR);  		    
		break;
	}
	$where_strs  = " WHERE t_user = '".$GLOBALS['SCACHE']['ADMIN']['login_id']."' ORDER BY id";
	$no_id = $notify->get_fields('id',$where_strs);
	$num_msg = sizeof($no_id) - $msg_del;

	if($num_msg > 0)
	{
		for($i=0; $i<$num_msg; $i++) 
		{
			$notify->del($no_id[$i]);
		}
	}	
	
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['pop'] = $note['pop'];
	$op['max_notify'] = $note['max_no'];	

	if ($GLOBALS['SCACHE']['ADMIN']['dept'] == 'PM' || $GLOBALS['SCACHE']['ADMIN']['dept'] == 'GM')
	{
		$op['order_rec']=$admin->workmsg('order_rec');
		$op['APV_ord']=$admin->workmsg('APV_ord');
        # 3月 新增 6月 移除 review 的權限
		// $op['REV_ord']=$admin->workmsg('REV_ord');
		$op['CFM_ord']=$admin->workmsg('CFM_ord');
		$op['schedule']=$admin->workmsg('schedule');
		$op['CFM_SCHDL']=$admin->workmsg('CFM_SCHDL');
		$op['mater']=$admin->workmsg('mater');
		$op['mat_rcvd']=$admin->workmsg('mat_rcvd');
		// $op['ie_rec']=$admin->workmsg('ie_rec');
		$op['ex_etd']=$admin->workmsg('ex_etd');
		$op['schdl_out']=$admin->workmsg('schdl_out');
		$op['ord_pttn']=$admin->workmsg('ord_pttn');
		// 2007-08 研發alert新增
		$op['smpl_apv']=$admin->workmsg('smpl_apv');
		// 2008-08 研發alert新增
		$op['smpl_apv_undo'] = $admin->workmsg('smpl_apv_undo');
		$op['none_wiws'] = $admin->workmsg('none_wiws');
		
	} elseif ($GLOBALS['SCACHE']['ADMIN']['dept'] == 'RD'){
		$op['order_rec']=$admin->workmsg('order_rec');
		$op['smpl_apv']=$admin->workmsg('smpl_apv');
		$op['ord_pttn']=$admin->workmsg('ord_pttn');
		// 2008-08 研發alert新增
		$op['smpl_apv_undo'] = $admin->workmsg('smpl_apv_undo');
		$op['none_wiws'] = $admin->workmsg('none_wiws');		

		// $op['ie_rec']=$admin->workmsg('ie_rec');
		// $op['ex_etd']=$admin->workmsg('ex_etd');
	} elseif (substr($GLOBALS['SCACHE']['ADMIN']['dept'],0,1) == 'J' || substr($GLOBALS['SCACHE']['ADMIN']['dept'],0,1) == 'K' || substr($GLOBALS['SCACHE']['ADMIN']['dept'],0,1) == 'T'){
		$op['order_rec']=$admin->workmsg('order_rec');		
		if($admin->is_power('066','add')) $op['CFM_ord']=$admin->workmsg('CFM_ord');
		$op['schedule']=$admin->workmsg('schedule');		
		$op['mater']=$admin->workmsg('mater');
		$op['mat_rcvd']=$admin->workmsg('mat_rcvd');
		// $op['ie_rec']=$admin->workmsg('ie_rec');
		$op['ex_etd']=$admin->workmsg('ex_etd');
		$op['schdl_out']=$admin->workmsg('schdl_out');
		$op['smpl_apv']=$admin->workmsg('smpl_apv');
		$op['ord_pttn']=$admin->workmsg('ord_pttn');
		// 2008-08 研發alert新增
		$op['smpl_apv_undo'] = $admin->workmsg('smpl_apv_undo');
		$op['none_wiws'] = $admin->workmsg('none_wiws');

	} elseif ($GLOBALS['SCACHE']['ADMIN']['dept'] == 'HJ' || $GLOBALS['SCACHE']['ADMIN']['dept'] == 'LY'|| $GLOBALS['SCACHE']['ADMIN']['dept'] == 'CF'|| $GLOBALS['SCACHE']['ADMIN']['dept'] == 'V1') {
		if($admin->is_power('065','add')) $op['order_rec']=$admin->workmsg('order_rec');		
		if($admin->is_power('066','add')) $op['CFM_ord']=$admin->workmsg('CFM_ord');
		$op['schedule']=$admin->workmsg('schedule');
		if($admin->is_power('027','add')) $op['CFM_SCHDL']=$admin->workmsg('CFM_SCHDL');
		$op['mater']=$admin->workmsg('mater');
		$op['mat_rcvd']=$admin->workmsg('mat_rcvd');
		// $op['ie_rec']=$admin->workmsg('ie_rec');
		$op['ex_etd']=$admin->workmsg('ex_etd');
		$op['schdl_out']=$admin->workmsg('schdl_out');
		$op['smpl_apv']=$admin->workmsg('smpl_apv');
		$op['ord_pttn']=$admin->workmsg('ord_pttn');
		// 2008-08 研發alert新增
		if($admin->is_power("008",'add') || $admin->is_power('065','add') ) $op['smpl_apv_undo'] = $admin->workmsg('smpl_apv_undo');
	} else {
		if($admin->is_power('065','add')) $op['order_rec']=$admin->workmsg('order_rec');		
		if($admin->is_power('066','add')) $op['CFM_ord']=$admin->workmsg('CFM_ord');
        # 3月 新增 6月 移除 review 的權限 7月恢復
		// if($admin->is_power('075','add')) $op['REV_ord']=$admin->workmsg('REV_ord');
		if($admin->is_power('067','add')) $op['APV_ord']=$admin->workmsg('APV_ord');
		if($admin->is_power('026','add')) $op['schedule']=$admin->workmsg('schedule');
		if($admin->is_power('027','add')) $op['CFM_SCHDL']=$admin->workmsg('CFM_SCHDL');
		if($admin->is_power('068','add') || $admin->is_power('068','edit'))$op['mater']=$admin->workmsg('mater');
		if($admin->is_power('068','add') || $admin->is_power('068','edit')) $op['mat_rcvd']=$admin->workmsg('mat_rcvd');
		// if($admin->is_power(4,1,'add')) $op['ie_rec']=$admin->workmsg('ie_rec');
		if($admin->is_power('065','add')) $op['ex_etd']=$admin->workmsg('ex_etd');
		if($admin->is_power('026','add')) $op['schdl_out']=$admin->workmsg('schdl_out');
		if($admin->is_power('008','add'))$op['smpl_apv']=$admin->workmsg('smpl_apv');
		if($admin->is_power('025','add')) $op['ord_pttn']=$admin->workmsg('ord_pttn');
		// 2008-08 研發alert新增
		if($admin->is_power('008','add'))		$op['smpl_apv_undo'] = $admin->workmsg('smpl_apv_undo');
		if($admin->is_power('019','add'))		$op['none_wiws'] = $admin->workmsg('none_wiws');
	}
	
	//系統提示參數取得 APV_ord APV_ord
	$op['alt_value'] = $alt_value;
	$op['un_rcv_date']	= $un_rcv_date;
		
	$op['today']=date('Y-m-d');
	$op['day30']=increceDaysInDate($TODAY,30);
	$op['cgi_get']="index2.php?PHP_action=main";
	
    page_display($op,'000',$TPL_NOTICE);    
	break;
	
	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "main":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
  case "main_top":
	
	$op['today']=date('Y-m-d');
	$op['day30']=increceDaysInDate($TODAY,30);
	$op['cgi_get']="index2.php?PHP_action=main";
	$layout->assign($op);
	$layout->display($TPL_NOTIC1);		    	    
	break;	



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case "main":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
  case "main_menu":
	
	if(!isset($GLOBALS['SCACHE']['ADMIN']['login_id']) || !isset($GLOBALS['SCACHE']['ADMIN']['dept']))
	{
			$op['msg'][] = "停滯時間過久,請重新登入系統";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
	}
	$where_strs  = " WHERE t_user = '".$GLOBALS['SCACHE']['ADMIN']['login_id']."' ORDER BY id";
	$no_id = $notify->get_fields('id',$where_strs);
	$num_msg = sizeof($no_id) - $msg_del;

	if($num_msg > 0)
	{
		for($i=0; $i<$num_msg; $i++) 
		{
			$notify->del($no_id[$i]);
		}
	}	
	
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];	
	
	if ($GLOBALS['SCACHE']['ADMIN']['dept'] == 'PM' || $GLOBALS['SCACHE']['ADMIN']['dept'] == 'GM')
	{
		$op['order_rec']=$admin->workmsg('order_rec');
		$op['APV_ord']=$admin->workmsg('APV_ord');
		$op['CFM_ord']=$admin->workmsg('CFM_ord');
		$op['schedule']=$admin->workmsg('schedule');
		$op['CFM_SCHDL']=$admin->workmsg('CFM_SCHDL');
		$op['mater']=$admin->workmsg('mater');
		$op['mat_rcvd']=$admin->workmsg('mat_rcvd');
//		$op['ie_rec']=$admin->workmsg('ie_rec');
		$op['ex_etd']=$admin->workmsg('ex_etd');
		$op['schdl_out']=$admin->workmsg('schdl_out');
		$op['ord_pttn']=$admin->workmsg('ord_pttn');
//2007-08 研發alert新增
		$op['smpl_apv']=$admin->workmsg('smpl_apv');
//2008-08 研發alert新增
		$op['smpl_apv_undo'] = $admin->workmsg('smpl_apv_undo');
		$op['none_wiws'] = $admin->workmsg('none_wiws');
		
	}elseif($GLOBALS['SCACHE']['ADMIN']['dept'] == 'RD'){
		$op['order_rec']=$admin->workmsg('order_rec');
		$op['smpl_apv']=$admin->workmsg('smpl_apv');
		$op['ord_pttn']=$admin->workmsg('ord_pttn');
//2008-08 研發alert新增
		$op['smpl_apv_undo'] = $admin->workmsg('smpl_apv_undo');
		$op['none_wiws'] = $admin->workmsg('none_wiws');		


//		$op['ie_rec']=$admin->workmsg('ie_rec');
	//	$op['ex_etd']=$admin->workmsg('ex_etd');
	}elseif(substr($GLOBALS['SCACHE']['ADMIN']['dept'],0,1) == 'J' || substr($GLOBALS['SCACHE']['ADMIN']['dept'],0,1) == 'K' || substr($GLOBALS['SCACHE']['ADMIN']['dept'],0,1) == 'T'){
		$op['order_rec']=$admin->workmsg('order_rec');		
		if($admin->is_power('066','add')) $op['CFM_ord']=$admin->workmsg('CFM_ord');
		$op['schedule']=$admin->workmsg('schedule');		
		$op['mater']=$admin->workmsg('mater');
		$op['mat_rcvd']=$admin->workmsg('mat_rcvd');
//		$op['ie_rec']=$admin->workmsg('ie_rec');
		$op['ex_etd']=$admin->workmsg('ex_etd');
		$op['schdl_out']=$admin->workmsg('schdl_out');
		$op['smpl_apv']=$admin->workmsg('smpl_apv');
		$op['ord_pttn']=$admin->workmsg('ord_pttn');
//2008-08 研發alert新增
		$op['smpl_apv_undo'] = $admin->workmsg('smpl_apv_undo');
		$op['none_wiws'] = $admin->workmsg('none_wiws');


	}elseif($GLOBALS['SCACHE']['ADMIN']['dept'] == 'HJ' || $GLOBALS['SCACHE']['ADMIN']['dept'] == 'LY' || $GLOBALS['SCACHE']['ADMIN']['dept'] == 'CF'|| $GLOBALS['SCACHE']['ADMIN']['dept'] == 'V1'){
		if($admin->is_power('065','add')) $op['order_rec']=$admin->workmsg('order_rec');		
		if($admin->is_power('066','add')) $op['CFM_ord']=$admin->workmsg('CFM_ord');
		$op['schedule']=$admin->workmsg('schedule');
		if($admin->is_power('027','add')) $op['CFM_SCHDL']=$admin->workmsg('CFM_SCHDL');
		$op['mater']=$admin->workmsg('mater');
		$op['mat_rcvd']=$admin->workmsg('mat_rcvd');
//		$op['ie_rec']=$admin->workmsg('ie_rec');
		$op['ex_etd']=$admin->workmsg('ex_etd');
		$op['schdl_out']=$admin->workmsg('schdl_out');
		$op['smpl_apv']=$admin->workmsg('smpl_apv');
		$op['ord_pttn']=$admin->workmsg('ord_pttn');
//2008-08 研發alert新增
		if($admin->is_power("008",'add') || $admin->is_power('065','add') ) $op['smpl_apv_undo'] = $admin->workmsg('smpl_apv_undo');

	}else{
		if($admin->is_power('065','add')) $op['order_rec']=$admin->workmsg('order_rec');		
		if($admin->is_power('066','add')) $op['CFM_ord']=$admin->workmsg('CFM_ord');
		if($admin->is_power('067','add')) $op['APV_ord']=$admin->workmsg('APV_ord');
		if($admin->is_power('026','add')) $op['schedule']=$admin->workmsg('schedule');
		if($admin->is_power('027','add')) $op['CFM_SCHDL']=$admin->workmsg('CFM_SCHDL');
		if($admin->is_power('068','add') || $admin->is_power('068','edit'))$op['mater']=$admin->workmsg('mater');
		if($admin->is_power('068','add') || $admin->is_power('068','edit')) $op['mat_rcvd']=$admin->workmsg('mat_rcvd');
//		if($admin->is_power(4,1,'add')) $op['ie_rec']=$admin->workmsg('ie_rec');
		if($admin->is_power('065','add')) $op['ex_etd']=$admin->workmsg('ex_etd');
		if($admin->is_power('026','add')) $op['schdl_out']=$admin->workmsg('schdl_out');
		if($admin->is_power("008",'add'))$op['smpl_apv']=$admin->workmsg('smpl_apv');
		if($admin->is_power('025','add')) $op['ord_pttn']=$admin->workmsg('ord_pttn');
//2008-08 研發alert新增
		if($admin->is_power("008",'add'))		$op['smpl_apv_undo'] = $admin->workmsg('smpl_apv_undo');
		if($admin->is_power('019','add'))		$op['none_wiws'] = $admin->workmsg('none_wiws');

	}
	//系統提示參數取得
	$op['alt_value'] = $alt_value;
	
	$op['today']=date('Y-m-d');
	$op['day30']=increceDaysInDate($TODAY,30);
	$op['cgi_get']="index2.php?PHP_action=main";
	$layout->assign($op);
	$layout->display($TPL_NOTIC2);		    	    
	break;
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "do_login":
		$f1 = $admin->login($PHP_login_id, $PHP_login_pass);
		if ($f1) {
					# 記錄使用者動態
			$log->log_add($GLOBALS['SCACHE']['ADMIN']['name'],"login","login successfully。");
			$op['auth'] = $GLOBALS['SCACHE']['ADMIN'];

			$layout->assign($op);
			$layout->display($TPL_MAIN);		    	    
		}	else {
					# 記錄使用者動態
			$log->log_add(0,"login","fail to login。($PHP_login_id : $PHP_login_pass)");

			$op['msg'] = $admin->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_LOGIN_FORM);		    
		}
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "changePass":

			$layout->assign($op);
			$layout->display($TPL_CHANGE_FORM);		    

	break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "do_change_pass":

		$parm = array(	"id"			=>	$PHP_id,
						"pass"			=>	$PHP_pass,
						"new1"			=>	$PHP_new1,
						"new2"			=>	$PHP_new2,
			);
	
		$redir_str = $PHP_SELF."?PHP_action=logout";
		
		if(!$admin->change_pass($parm)) { 
			$op['msg'] = $admin->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
				# 記錄使用者動態
		$message = "change password for user ID: [ ".$PHP_id." ] ";

			redirect_page($redir_str);

		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "logout":
//		echo "系統更新中";
//	exit;
				# 記錄使用者動態
		$log->log_add(0,"logout","log out");
		unset($GLOBALS['SCACHE']['ADMIN']);
		$layout->display($TPL_LOGIN);		    
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "change_passwd":
		if (!$admin->is_perm("enable")) {
			$op['msg'][] = "sorry! you don't have this permission!!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
				# 記錄使用者動態
		$log->log_add(0,"password","enter to change password");
		$layout->display($TPL_ADMIN_CHANGE_PASSWD);
		break;
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "change_passwd_step2":
		if (!$admin->is_perm("enable")) {
			$op['msg'][] = "sorry! you don't have this permission!!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$admin_data = $GLOBALS[SCACHE][ADMIN];
		$old_pass = $admin_data[login_pass];
		if ($old_pass != $PHP_login_pass_old) {
			$op['msg'][] = "sorry ! you mistyped your old password !";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    		    
			break;
		}
		$admin_id = $admin_data[id];
		$parm = array ( 
				"id"			=> $admin_id,
				"login_pass1"	=> $PHP_login_pass1,
				"login_pass2"	=> $PHP_login_pass2);

		if (!$admin->admin_update(2,$parm)) {
			$op[msg] = $admin->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;		    
		}
		$admin->login($admin_data[login_id],$PHP_login_pass1);
				# 記錄使用者動態
		$log->log_add(0,"password","change password completely");
		$op[msg][] = "Successfully change your password";
		$layout->assign($op);
		$layout->display($TPL_ERROR);  		    		    
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "show_page":
				# 取得一些資料
		$op[category_names] = array_values($webshop->class_name1);
		$op[category_ids] = array_keys($webshop->class_name1);
		$layout->assign($op);
      $layout->display($PHP_page);
		break;
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "display_page":

			$allow = $admin->decode_perm($PHP_i,$PHP_j);   // 設定 新增刪改權限
			if ($allow['view'])	{	$op['view_flag'] = 1;} else {	$op['view_flag'] = "";}
			if ($allow['add'])	{	$op['add_flag'] = 1;} else {	$op['add_flag'] = "";}
			if ($allow['edit'])	{	$op['edit_flag'] = 1;} else {	$op['edit_flag'] = "";}
			if ($allow['del'])	{	$op['del_flag'] = 1;} else {	$op['del_flag'] = "";}

			$layout->assign($op);
	
			$layout->display($PHP_page);
		break;




//  new adding  ---------------------------- 2005/04/08
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//		job 63  system log
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "log_admin":			//  呈現  admin log 主頁
      check_authority('047',"view");
      
      page_display($op,'047', $TPL_ADMIN_LOG_ADMIN);

		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "log_admin_show":		//  查尋 admin log 檔內容

		check_authority('047',"view");
		if ($PHP_srch_by == 'all'){
			$mode = "all";
		}
		if ($PHP_srch_by == 'id'){
			$mode = "id";
		}
		if ($PHP_srch_by == 'date'){
			if(isset($select_year))$PHP_sr_parm_date = $select_year.$select_month.$select_day;
			if(isset($PHP_sr_parm_date))$PHP_sr_parm_date = $PHP_sr_parm_date;
			$mode = "date";
		}
		if ($PHP_srch_by == 'code'){
			$mode = "code";
		}

		if (!$op = $admin->admin_log_search($mode)) {
			$op = array();
			$op['msg']= $admin->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['msg'] = $admin->msg->get(2);
		if ($PHP_edit_flag) {
			$op['edit_flag'] =1;
		}

		page_display($op,'047', $TPL_ADMIN_LOG_ADMIN_SHOW);
		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case  "do_log_dump":	 	JOB 11A
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "log_dump":
		$where_str = "WHERE date <= '$PHP_date'";

		$op['logs'] = $log->search($where_str);
		$op['del_date'] = $PHP_date;
//		$op['del']['wherestr'] = $str;
		$op['del']['des'] = "Are you sure to delete records? ";
		$op['del']['detail'] = "Before Date: $PHP_date Log records" ;
		
		page_display($op,'047', $TPL_ADMIN_LOG_CFM_DEL);
		
		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case  "do_log_dump":	 	JOB 11A
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "do_log_dump":
		$f1 = $log->dump_log($PHP_date);
		if ($f1) $op['msg'][] = "Success to Delete ".$f1." log field in date <".$PHP_date;
		if (!$f1) $op['msg'] = $log->msg->get(2);
		$layout->assign($op);
		$layout->display($TPL_ERROR);  		
		
		break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "log_admin_cfm_delete": //  刪除 admin log 檔
			$str="";
		check_authority('047',"del");
		if ($PHP_del_mode == 0){  // 逐一勾選id刪除時
				$id_arry = $PHP_del_id;
			$num = count($id_arry);
			if (!$num) {
				$op['msg'][] = "Error ! Please choice delete record on click box !";
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		
			} else {
				$op['del']['id_arry'] = $PHP_del_id;   //  template 要用 session 帶入陣列
				$op['del']['detail'] = implode(", ",$id_arry);
				$op['del']['mode'] = $PHP_del_mode;
				$op['del']['des'] = "Delete log ID : ";

				$layout->assign($op);
				$layout->display($TPL_ADMIN_LOG_CFM_DEL);  
			}
		break;
		} elseif ($PHP_del_mode == 1){  // 全部刪除時

				$op['del']['mode'] = $PHP_del_mode;
				$op['del']['des'] = "You sure to delete ";
				$op['del']['detail'] = "All Log records";
				$layout->assign($op);
				$layout->display($TPL_ADMIN_LOG_CFM_DEL);  		    
		break;
		} elseif ($PHP_del_mode == 2){  // 條件刪除時
				$op['del']['mode'] = $PHP_del_mode;      // 帶出參數用
				//  先設定  $str
				$str = "";
			if (isset($PHP_del_opt_date)) {
				#計算輸入日期項目
					$detail_date = $select_year."-".$select_month."-".$select_day;
				if ($PHP_del_by_date == "yes") {
					$PHP_del_opt_date = $select_year.$select_month.$select_day;
					$str = " WHERE date < $PHP_del_opt_date ";
					$detail = "Before Date: ".$detail_date."Log records ";
				} elseif ($PHP_del_by_date == "no")  {
					$PHP_del_opt_date = $detail_date;
					$str = " WHERE date LIKE '%$PHP_del_opt_date%' ";
					$detail = "Point Date : ".$detail_date." Log records ";
				} else {
					$op['msg'][] = "Error! Please choice one of delete rule! ";
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		
				break;
				}
			} elseif  (isset($PHP_del_opt_user)) {
					$PHP_del_opt_user = trim($PHP_del_opt_user);
				if (!$PHP_del_opt_user) {
					$op['msg'][] = "Error! Please input name! ";
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		
					break;
				}
				$str = " WHERE user =  '$PHP_del_opt_user' ";
				$detail = " USER:[ ".$PHP_del_opt_user." ] Log records. ";
			} elseif  (isset($PHP_del_opt_class)) {
				$PHP_del_opt_class = trim($PHP_del_opt_class);
				if (!$PHP_del_opt_class) {
					$op['msg'][] = "Error! Please input job ID ";
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		
						break;
				}
					$str = " WHERE class =  '$PHP_del_opt_class' ";
					$detail = "job ID above:[ ".$PHP_del_opt_class." ] Log records";
			}	//  $str 設定完成

			if ($str) {
				$op['del']['wherestr'] = $str;
				$op['del']['des'] = "Are you sure to delete records? ";
				$op['del']['detail'] = $detail;
				$layout->assign($op);
				$layout->display($TPL_ADMIN_LOG_CFM_DEL);  		    
			break;
			} else {
					# 記錄使用者動態
				$log->log_add(0,"63","Fall to delete log records");
				$op['msg'][] = "Error !The deletion condition of indetermination  !";
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		
					break;
			}
		}  // end mode=?

		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "log_admin_delete":	//  刪除 admin log 檔
			$str="";
		check_authority('047',"del");
		if ($PHP_del_mode == 0){	// 逐一勾選id刪除時

			$id_arry = $PHP_del_id;
			$num = count($id_arry);	//  刪除檔案數目
			if (!$num) {
				$op['msg'][] = "Error! You don't click any delete record!";
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		
			} else {
				$log->log_del(0, $id_arry,"");	// delete..........

				$new_log = "Delete these log records; id = :".$PHP_del_detail." ";			
				$log->log_add(0,"63D",$new_log);	//  記錄使用者動態

				$op['msg'][] = $num."  log records successfully delete!";
				$layout->assign($op);
				$layout->display($TPL_BACK_LOG);  	
			}
		break;
		} else if ($PHP_del_mode == 1){  // 全部刪除時

			$log->log_del(1);	// delete.........
			$log->log_add(0,"63D","Delete all log records by USER!");	//  記錄使用者動態
			$op['msg'][] = " Successfully delete all log records by USER!";
			$layout->assign($op);
			$layout->display($TPL_BACK_LOG);  		    		    
		break;
		} else if ($PHP_del_mode == 2){  // 條件刪除時
			$str = ereg_replace("[\x5c\]","",$PHP_del_where_str);    //  消除反斜線 \
			if ($str) {

			$num = $log->log_nums($str);//  設定 叛斷刪除檔案數目

			if (!$num) {
				$op['msg'][] = "Error ! Can't find delete records in these rule!";
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		
			} else {
				$log->log_del(2,0,$str);  //  刪除
					//  記錄使用者動態
				$new_log = "Success delete ".$PHP_del_detail." ; Total:".$num."record";	
				$log->log_add(0,"63D",$new_log);
				$op['msg'][] = $num. " Records successfully delete!";
				$layout->assign($op);
				$layout->display($TPL_BACK_LOG);  
			}
			break;
		} else {
			//  記錄使用者動態
			$log->log_add(0,"63D","Fail to delete log records !");
			$op['msg'][] = "Error ! Fail delete command!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		
				break;
		}
		}  // end mode=?

		break;




#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#					order part
#
#	  order status :
#		status == 0			waitt'g for IE rec.
#		status == 1			wait for submit
#		status == 2			waitt'g for CFM
#		status == 3			waitt'g for APV
#		status == 4			APVED
#		status == 5			Reject
#		status == 6			SCHDL CFMing
#		status == 7			SCHDL CFMed
#		status == 8			PRODUCING
#		status == 10		= FINISHED =
#		status == 12		== SHIPPED ==
#		
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#			 job 101  訂 單
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "get_cust_ajx":

$where_str = ( $SCH_dept ) ? " AND dept = '".$SCH_dept."' " : '' ;
$where_str .= " order by cust_s_name";			
$cust_def = $cust->get_fields('cust_init_name',$where_str);
$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
$cust_value = array();
for ($i=0; $i< sizeof($cust_def); $i++)
{
    $cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
}
$cust_select =  $arry2->select($cust_value,'','PHP_cust','select','check_add(this)',$cust_def_vue); 

echo $cust_select;
exit;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "order_search":
check_authority('065',"view");

if(isset($PHP_ref))
{
	$sch_parm = array();
	if(!isset($SCH_del))$SCH_del=0;
	if(!isset($SCH_po))$SCH_po='';
	if(!isset($SCH_picture))$SCH_picture= 0;
	$sch_parm = array(	
		"PHP_dept_code"		=>  $PHP_dept_code,
		"PHP_dept"		=>  $PHP_dept,
		"PHP_order_num"		=>  $PHP_order_num,
		"PHP_cust"			=>	$PHP_cust,
		"PHP_ref"			=>	$PHP_ref,
		"PHP_factory"		=>	$PHP_factory,
		"SCH_style"			=>	$SCH_style,
		"SCH_del"			=>	$SCH_del,
		"SCH_po"			=>	$SCH_po,
		'SCH_year'			=>	$SCH_year,
		'SCH_month'			=>	$SCH_month,
		"PHP_sr_startno"	=>	$PHP_sr_startno,
		"PHP_action"		=>	$PHP_action,
		"SCH_picture"		=>	$SCH_picture
	);			
}else{
	if(isset($PHP_sr_startno))$sch_parm['PHP_sr_startno'] = $PHP_sr_startno;
}			


//可利用PHP_dept_code判定是否 業務部門進入

if (!$op = $order->search(1,$sch_parm['PHP_dept_code'])) {  
	$op['msg']= $order->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}

# 2013/07/11 將今天以後的訂單的 handling_fee 寫回 s_order 內(factory = LY 且 排除 L 開頭的訂單)
# 2013/07/11 由於 工繳 目前是手動挑選單訂，自行加入 handling_fee。改成 工繳 多一欄 將 handling_fee 納入計算(2013/07/11程式更新後所新建立的訂單才納入計算)
# 2013/07/11 今天以前的 handling_fee 欄位不填值，改用程式判斷2012/08/15之後將handling_fee設為0.25，目的是讓前台顯示(order list、order show、order cfm...等)正常
$handling_row = $order->get_fields("set_value", " where set_name='handling_fee'","para_set");
//重新計算 毛利率
foreach($op['sorder'] as $key=>$val){
	if($val['factory'] == 'LY' and $val['opendate'] >= '2013-07-11' and substr($val['order_num'],0,1) <> 'L'){
		$handling_fee = $val['handling_fee'];
	}elseif($val['factory'] == 'LY' and $val['opendate'] >= '2012-08-15' and substr($val['order_num'],0,1) <> 'L'){
		$handling_fee = $handling_row[0];
	}else{
		$handling_fee = 0;
	}
	//計算 C.M. estimate
	if($val['ie2'] > 0){
		$fty_cm = $order->get_fields("set_value", " where set_name='".strtolower($val['factory'])."-cm'","para_set");
		$cm = $val['ie2'] * $fty_cm[0];
	}elseif($val['ie1'] > 0){
		$fty_cm = $order->get_fields("set_value", " where set_name='".strtolower($val['factory'])."-cm'","para_set");
		$cm = $val['ie1'] * $fty_cm[0];
	}else{
		$cm = $val['cm'];
	}
	
	// 計算  gm rate -----------------------------
	$unit_cost = ($val['mat_u_cost'] * $val['mat_useage']) + $val['interline'] + $val['fusible'] + $val['acc_u_cost'] + $val['quota_fee'] + $val['comm_fee'] + $cm + $val['emb'] + $val['wash'] + $val['oth'] + $handling_fee;
	$grand_cost = $unit_cost * $val['qty'] + $val['smpl_fee'];
	$sales = $val['uprice'] * $val['qty'];
	$gm = $sales - $grand_cost;
	
	if ($sales){
		$op['sorder'][$key]['gmr'] = ($gm / $sales) * 100;
	}else{
		$op['sorder'][$key]['gmr'] = 0;
	}
}

if($sch_parm['SCH_picture'])
{	
	$x = $y = 0;
	for($i=0; $i<sizeof($op['sorder']); $i++)
	{
		if(file_exists($GLOBALS['config']['root_dir']."/picture/".$op['sorder'][$i]['order_num'].".jpg")){
			$op['sorder'][$i]['main_pic'] = "./picture/".$op['sorder'][$i]['order_num'].".jpg";
		} else {
			$op['sorder'][$i]['main_pic'] = "./images/graydot.gif";
		}
		if($i > 0 && ($i % 4) == 0) $x++;
		$op['ord_pic'][$x][] = $op['sorder'][$i];
		
		$etp = $order->get_fields("p_etp","where `ord_num` = '".$op['sorder'][$i]['order_num']."' ORDER BY `p_etp` DESC LIMIT 1","order_partial");
		$op['sorder'][$i]['etp'] = $etp[0];
	}
	$op['SCH_pic'] = $sch_parm['SCH_picture'];
}else{
	for($i=0; $i<sizeof($op['sorder']); $i++)
	{
		$etp = $order->get_fields("p_etp","where `ord_num` = '".$op['sorder'][$i]['order_num']."' ORDER BY `p_etp` DESC LIMIT 1","order_partial");
		$op['sorder'][$i]['etp'] = $etp[0];
	}
}
		
$op['msg']= $order->msg->get(2);
if(isset($PHP_msg))$op['msg'][] = $PHP_msg;

$op['non_cost'] = 0;
$user_team = $GLOBALS['SCACHE']['ADMIN']['team_id'];   // 判定進入身份的指標(部門)
//		if($user_team == 'TU') $op['non_cost'] = 1;

page_display($op,'065', $TPL_ORDER_LIST);
break;


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "order_del":
    if (isset($PHP_bk))
    {
			check_authority('065',"add");
		}else{
			check_authority('065',"del");
		}

		$order_rec = $order->get($PHP_id);  //取出該筆記錄	
		
		$f1 = $wi->order_del($order_rec['order_num']);//刪除製造令相關
		
		if ($PHP_status < 4 || $PHP_status == 5)	//訂單未核可
		{
			$op['order'] = $order->get($PHP_id);  //取出該筆記錄

			$f1=$order_log->del($op['order']['order_num']); //刪除order log
			$f1 = $order->del($PHP_id);						//刪除訂單(s_order)
			$f1 = $order->del_pdtion($op['order']['order_num']); //刪除訂單(pdtion)
		}elseif($PHP_status == 4 || $PHP_status == 6) {		//己核可且排產未確認
			$op['order'] = $order->get($PHP_id);  //取出該筆記錄

			$f1 = $order->delete_month_su( $op['order']['etp'], $op['order']['etd'],$op['order']['su'],$op['order']['factory'],'pre_schedule');  //刪除ETD~ETP年度月份分配
			$f1 = $order->del_pdtion($op['order']['order_num']); //刪除訂單(pdtion)
			$f1 = $order_log->del($op['order']['order_num']);  //刪除order log
			$f1 = $order->del($PHP_id);		//刪除訂單(s_order)
		}elseif($PHP_status == 7){  //己排產
			$op['order'] = $order->get($PHP_id);  //取出該筆記錄

			$f1 = $order->delete_month_su( $op['order']['etp'], $op['order']['etd'],$op['order']['su'],$op['order']['factory'],'pre_schedule'); //刪除ETD~ETP年度月份分配

			$op['order'] = $order->schedule_get($PHP_id);  //取出該筆生產相關記錄

			$order->delete_month_su( $op['order']['ets'], $op['order']['etf'],$op['order']['su'],$op['order']['factory'],'schedule');	//刪除ETF~ETS年度月份分配
			$f1 = $order->del_pdtion($op['order']['order_num']);	//刪除訂單(pdtion)
			$f1 = $order_log->del($op['order']['order_num']);	 //刪除order log
			$f1 = $order->del($PHP_id);	//刪除訂單(s_order)
		}elseif($PHP_status == 8 || $PHP_status == 10 || $PHP_status == 12){	//訂單開始生產後
			$op['order'] = $order->get($PHP_id);  //取出該筆記錄

			$f1 = $shipping->order_ship_del($op['order']['order_num'],$op['order']['uprice']);		//刪除ship年度月份分配
			$f1 = $shipping->ship_del($op['order']['order_num']);			//刪除每日ship記錄
			$f1 = $daily->order_daily_del($op['order']['order_num']);		//刪除out-pu年度月份分配	
			$f1 = $daily->daily_del($op['order']['order_num']);			//刪除每日out-put記錄
			$f1 = $order->delete_month_su( $op['order']['etp'], $op['order']['etd'],$op['order']['su'],$op['order']['factory'],'pre_schedule');	//刪除ETD~ETP年度月份分配

			$op['order'] = $order->schedule_get($PHP_id);  //取出該筆生產相關記錄

			$order->delete_month_su( $op['order']['ets'], $op['order']['etf'],$op['order']['su'],$op['order']['factory'],'schedule'); //刪除ETF~ETS年度月份分配
			$f1 = $order->del_pdtion($op['order']['order_num']); //刪除訂單(pdtion)
			$f1 = $order_log->del($op['order']['order_num']); //刪除order log
			$f1 = $order->del($PHP_id);	//刪除訂單(s_order)
			
		}
		
			$op['order']['cancer_date'] = $GLOBALS['THIS_TIME'];  //xxxx-xx-xx : xx.xx.xx日期時間
			$op['order']['cancer_user'] = $GLOBALS['SCACHE']['ADMIN']['login_id']; //使用者帳號
			$old_orders=$smpl_ord->get_fieldvalue('','orders', $order_rec['smpl_ord']); //取得樣本的orders內容
			$id=$smpl_ord->get_fieldvalue('','id', $order_rec['smpl_ord']);//取得樣本的id
			$tmp=explode('|',$old_orders);
			$tmp_orders='';
			for ($i=0; $i< sizeof($tmp); $i++)  //重組orders,將刪除者去除
			{
				if ($tmp[$i]<>$order_rec['order_num'])	$tmp_orders=$tmp_orders.$tmp[$i]."|";
			}
			if($tmp_orders<>'') $tmp_orders=substr($tmp_orders,0,-1);
			$s_parm['field_name']='orders';		$s_parm['field_value']=$tmp_orders;			$s_parm['id']=$id;
			$f1=$smpl_ord->update_field($s_parm);//取得樣本的id
		

		if ($f1)  //記錄刪除訊息
		{
			$message="success delete order : ".$PHP_num;
			$log->log_add(0,"101D",$message);
		}else{
			$message = $op['msg'][0];
		}

		$redirect_str ="index2.php?PHP_action=order_search&PHP_msg=".$message;
		redirect_page($redirect_str); 	

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
case "order_view":
check_authority('065',"view");

$_SESSION['partial_id'] = '';
if(!isset($cgi_del))$cgi_del=0;

$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標(部門)
$user_team = $GLOBALS['SCACHE']['ADMIN']['team_id'];   // 判定進入身份的指標(部門)
$user_id = $GLOBALS['SCACHE']['ADMIN']['login_id']; // 判定進入身份的指標(帳號)
if($PHP_id) 
{
	$op['order'] = $order->get($PHP_id);  //取出該筆記錄
}else{
	$op['order'] = $order->get('',$PHP_ord_num);  //取出該筆記錄
}

$op['combine'] = $order->get_combine($op['order']['combine']);


if (!$op['order']) {
	$op['msg'] = $order->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}
$op = $order->orgainzation_ord($op);

$op['user_e']=$user_dept;
if (substr($user_dept,0,1)=="H" || substr($user_dept,0,1)=="L")  //判斷使用者部門是否為工廠 smpl_flag
{                                                                //以分隔修改等權限
	if ($user_dept == $op['order']['dept'])$op['dept_edit']=1;
	if ($user_dept =="H0" && substr($op['order']['dept'],0,1)=="H")$op['dept_edit']=1;
	if ($user_dept =="L0" && substr($op['order']['dept'],0,1)=="L")$op['dept_edit']=1;
}else{
	$op['dept_edit']=1;
}

// 取出 order_log 本訂單 之歷史50筆的計記錄  -------------------
$logs = $order_log->search50($op['order']['order_num']);  //取出該訂單全部log記錄
if (!$logs){
	$op['msg'] = $order->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}
$op['logs'] = $logs['order_log'];
$op['log_records'] = $logs['records'];
// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來判斷有無資料

if (isset($op['order']['wi_id']))
{
	$acc_po  = $po->chk_po_ok($op['order']['wi_id'], 'bom_acc','a');
	$lots_po = $po->chk_po_ok($op['order']['wi_id'], 'bom_lots','l');
	if ($acc_po == 1 && $lots_po == 1 ) $op['cost_view'] = 1;
}
$op['msg'] = '';
$msg = $order->msg->get(2);
if(!empty($msg))$op['msg'] = $msg;

if (isset($sub_error))$op['msg'][]="Sorry ! please update your unreasonable ETP ( before today at least) or ETD ( 20 days before today at least)";
if (!empty($PHP_msg))$op['msg'][]=$PHP_msg;
$op['search'] = '1';		
$op['check_etp']=$ord_submit_ETP_limit;
$op['check_etd']=$ord_submit_ETD_limit;	

//限制成本分析檢視 2008.10.01	
$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標(部門)
$user_team = $GLOBALS['SCACHE']['ADMIN']['team_id'];   // 判定進入身份的指標(部門)
if($user_dept == 'HJ' || $user_dept == 'LY' || $user_dept == 'CF')
{
	if($user_team != 'SA')
	{
		$op['non_cost'] = 1;
	}
}

if($user_team == 'SU' || $user_dept == 'SA' || $user_dept == 'DA' || $user_dept == 'KA' || $user_dept == 'KB' || $user_dept == 'J1' ) $op['smpl_flag'] = 1;
$op['user_dept'] = $user_dept;
$op['user_team'] = $user_team;
$op['is_factory']= is_dept($user_dept);

//訂單出貨資料
$op['ship_way_select'] =  $arry2->select($ORD_SHIP,'','PHP_ship_way','select','');
$op['ship_dist_select'] =  $arry2->select($ORD_DIST,'','PHP_ship_dist','select','');
$op['order']['ship_way_ary'] = explode('|',$op['order']['ship_way']);
$op['order']['ship_dist_ary'] = explode('|',$op['order']['ship_dist']);
$op['order']['ship_day_ary'] = explode('|',$op['order']['ship_day']);

//年度季節		
$op['season_select'] =  $arry2->select($SEASON,$op['order']['season'],'PHP_season','select',''); 
$op['year_select'] =  $arry2->select($YEAR_WORK,$op['order']['syear'],'PHP_syear','select',''); 

// 判斷 SHIPDOC 是否已經完成 && $smpl_flag
$op['order']['output'] = $order->get_output($op['order']['order_num']);

// 判斷 SHIPDOC 是否已經完成 && $smpl_flag
$op['order']['shipping'] = $order->get_shipping($op['order']['order_num']);

if(!empty($PHP_resize)) $op['resize'] = 1;
//print_r($op);

page_display($op,'065', $TPL_ORDER_SHOW);
break;
	
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "order_pdf":
		check_authority('065',"view");
		$parm = $order->get($PHP_id);  //取出該筆記錄
		
		// 取出 order_log 本訂單 之歷史50筆的計記錄  -------------------
		$logs = $order_log->search50($parm['order_num']);  //取出該訂單全部log記錄
		if (!$logs){
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['logs'] = $logs['order_log'];
		$op['log_records'] = $logs['records'];
			// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來判斷有無資料

	
		// 計算 lead time
		$parm['lead_time'] = countDays ($parm['etp'],$parm['etd']);		

			// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/picture/".$parm['order_num'].".jpg")){
			$main_pic = "./picture/".$parm['order_num'].".jpg";
		} else {
			$main_pic = "./images/graydot.jpg";
		}

//-----------// 計算  SU 供 html -------------------------------------------------------------
		//   2005/08/31 改由資料庫抓 su [以 ie 計算填入 ]
		$su = $parm['su'];   
		$parm['f_su'] = number_format($su, 0, '', ',');

			// 計算  gm rate -----------------------------
		$parm['unit_cost'] = ($parm['mat_u_cost']* $parm['mat_useage'])+ $parm['interline']+ $parm['fusible']+ $parm['acc_u_cost'] + $parm['quota_fee'] + $parm['comm_fee'] + $parm['cm'] + $parm['emb'] + $parm['wash'] + $parm['oth'];
		$parm['grand_cost'] = $parm['unit_cost']*$parm['qty'] + $parm['smpl_fee'];
		$parm['sales'] = $parm['uprice']*$parm['qty'];
		$parm['gm'] = $parm['sales'] - $parm['grand_cost'];
			if ($parm['sales']){
				$parm['gm_rate'] = ($parm['gm']/ $parm['sales'])*100;
			}else{
				$parm['gm_rate'] = 0;
			}


		
		$parm['gmr'] = $parm['gm_rate'];

			// 計算 網頁參數 -------- 成本分析部份 ------------

			$parm['sales'] = number_format($parm['sales'], 2, '.', ',');
			$parm['unit_cost'] = number_format($parm['unit_cost'], 2, '.', ',');
			$parm['grand_cost'] = number_format($parm['grand_cost'], 2, '.', ',');
			$parm['gm'] = number_format($parm['gm'], 2, '.', ',');
			$parm['gm_rate'] = number_format($parm['gm_rate'], 2, '.', ',');
			$parm['qty'] = number_format($parm['qty'], 0, '', ',');


//---------------------------------- 資料庫作業結束 ------------------------------

include_once($config['root_dir']."/lib/class.pdf_order.php");

$print_title="ORDER";
$print_title2 = "VER.".($parm['revise']+1)."        Currency : US$";

$creator = $parm['creator'];
$mark = $parm['order_num'];

$pdf=new PDF_order('P','mm','A4');
$pdf->AddBig5Font();
$pdf->Open();
$pdf->AddPage();
$pdf->SetFont('Arial','B',10);
$pdf->ln(); 

$pdf->base_data($parm);
	
		$Y = $pdf->getY();
		$X = $pdf->getX();
		$pdf->Cell(60,6,' ------------   Picture   -------------------------- ',0,0,'C');
		$pdf->Cell(50,6,' ------------------------------- ',0,0,'C');
		$pdf->Cell(20,6,' Unit Cost ',0,0,'C');
		$pdf->Cell(60,6,'---------------------------------------------- ',0,0,'C');
		$pdf->ln();


$pdf->cost_data($parm);


		$img_size = GetImageSize($main_pic);
		
		if ($img_size[0] > $img_size[1])
		{
			$pdf->Image($main_pic,10,($Y+10),60,0);
		}else{
			$pdf->Image($main_pic,10,($Y+10),0,60);
		}

$pdf->setY(-30);
$pdf->SetFont('Arial','B',10);
$pdf->Cell(25,6,'SUBMIT by :',"TBL",0,'R');
$pdf->SetFont('BIG5','',10);
$pdf->Cell(43,6,$parm['creator']."-[".$parm['opendate']."]","TBR",0,'L');
$pdf->SetFont('Arial','B',10);
$pdf->Cell(18,6,'CFM by : ',"TBL",0,'R');
$pdf->SetFont('BIG5','',10);
$pdf->Cell(43,6,$parm['cfmer']."-[".$parm['cfm_date']."]","TBR",0,'L');
$pdf->SetFont('Arial','B',10);
$pdf->Cell(18,6,'APV by : ',"TBL",0,'R');
$pdf->SetFont('BIG5','',10);
$pdf->Cell(43,6,$parm['apver']."-[".$parm['apv_date']."]","TBR",0,'L');


$name=$parm['order_num'].'.pdf';
$pdf->Output($name,'D');
	break;	


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "order_add":
check_authority('065',"add");
$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標

$op['msg']= $order->msg->get(2);
$op['cust_id'] = $PHP_cust_code;

// 取出年碼...
$dt = decode_date(1);
$year_code = substr($dt['year'],-2);

//*****//2006.12.08	修改sample為下拉式 start
$s_date=increceDaysInDate($TODAY,-1200); //12個月前
// $where="where last_update > '".$s_date."' and cust='".$PHP_cust_code."' AND dept='".$PHP_dept_code."' order by num";
$where="where last_update > '".$s_date."' and cust='".$PHP_cust_code."' and num != '' order by num";
// $smpl_ord = new SMPL_ORD();
$smpl_no=$smpl_ord->get_fields("num",$where);	

$j=0;
if ($smpl_no){
$sml_no[0]=substr($smpl_no[0],0,9);
for($i=1;$i< sizeof($smpl_no); $i++)
{
	if($sml_no[$j] != substr($smpl_no[$i],0,9)){	
		$j++;
		$sml_no[$j]=substr($smpl_no[$i],0,9);
	}
}
}else{
	$sml_no=array('');
}
$op['smpl_no']=$arry2->select($sml_no,'','PHP_smpl_ord','select','');
//*****//2006.12.08	修改sample為下拉式	end

#M11010501
if ( $user_dept=="HJ" || $user_dept=="LY" )
{
	if($user_dept=="HJ") $fty = array($user_dept,'MA');
	if($user_dept=="LY") $fty = array($user_dept);
	if($user_dept=="CF") $fty = array($user_dept);
	$op['factory'] = $arry2->select($fty,'','PHP_factory','select','');
}else{
	$op['factory'] = $arry2->select($FACTORY,'','PHP_factory','select','');  	
}

// creat style type combo box
$style_def = $style_type->get_fields('style_type');   // 取出 款式類別
$op['style'] =  $arry2->select($style_def,'','PHP_style','select','');  	
// creat apparel unit combo box
$op['unit'] = $arry2->select($APPAREL_UNIT,'','PHP_unit','select','');  	

$where_str="ORDER BY cust_s_name"; //依cust_s_name排序
$cust_def = $cust->get_fields('cust_init_name',$where_str);
$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
for ($i=0; $i< sizeof($cust_def); $i++)
{
	$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
}
$op['agent_select'] =  $arry2->select($cust_value,'','PHP_agent','select','',$cust_def_vue); 


//生產線分別男女裝 -- 08.08.27
$line_value = array('F','M','A');
$line_key = array('Woman','Man','Ann');
$op['line_select'] =  $arry2->select($line_key,'','PHP_line','select','',$line_value); 
//主料單位--08.09.22
$op['lots_unit'] =  $arry2->select($LOTS_PRICE_UNIT,'','PHP_lots_unit','select',''); 

//年度季節		
$op['season_select'] =  $arry2->select($SEASON,'','PHP_season','select',''); 
$op['year_select'] =  $arry2->select($YEAR_WORK,date('Y'),'PHP_syear','select',''); 


// 取出選項資料 及傳入之參數
$op['dept_id']	 = $PHP_dept_code;
// pre  訂單編號....
$dept = ( substr($PHP_dept_code,0,1) == 'K' ) ? substr($PHP_dept_code,1,1) : substr($PHP_dept_code,0,1);
$op['order_precode'] = $dept.$PHP_cust_code.$year_code."-xxxx";

// 2005/07/30 加入 由 menu進入新增後的 back page 只向 全部列表
$op['back_str'] = "index2.php?PHP_action=order_search&PHP_sr_startno=0&PHP_dept_code=&PHP_order_num=&PHP_cust_code=&PHP_ref=&PHP_factory=&SCH_style=";

page_display($op,'065', $TPL_ORDER_ADD);		    	    
break;
			
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "order_edit":	
		check_authority('065',"edit");			
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];	
		$op['order'] = $order->get($PHP_id);
		if (!$op['order']) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		// 查看是不是來自新增訂單 後的呼叫???   當新增後 會show的 html 也可 edit ~~ 非來自list

//*****//2006.12.08	修改sample為下拉式 start
		$s_date=increceDaysInDate($TODAY,-1200); //12個月前
		// $where="where last_update > '".$s_date."'and cust='".$op['order']['cust']."' AND dept='".$op['order']['dept']."' order by num";
		$where="where last_update > '".$s_date."'and cust='".$op['order']['cust']."' order by num";
		
		$smpl_no=$smpl_ord->get_fields("num",$where);		
	    $j=0;
	    if($smpl_no){									//將sample order資料中有"-x"的部分消掉"-x"
	    	if(strlen($op['order']['smpl_ord']) > 9)$op['order']['smpl_ord']=substr($op['order']['smpl_ord'],0,-2);	
			$sml_no[0]=substr($smpl_no[0],0,9);
			for($i=1;$i< sizeof($smpl_no); $i++)
			{
				if($sml_no[$j] != substr($smpl_no[$i],0,9)){	
					$j++;
					$sml_no[$j]=substr($smpl_no[$i],0,9);
				}
			}
		}else{
			$sml_no=array('');
			if ($op['order']['smpl_ord'])	$op['sup_null']=1;	//沒有sample order但使用者有卻有打sample order時
		}
		
		
		$op['smpl_no']=$arry2->select($sml_no,$op['order']['smpl_ord'],'PHP_smpl_ord','select','');
//*****//2006.12.08	修改sample為下拉式	end

		if ($op['order']['ie1'] > 0) $op['ie_flag']=1; //判斷是否有IE值
		// creat factory combo box
		if ($user_dept=="HJ" || $user_dept=="LY")
		{
			if($user_dept=="HJ") $fty = array($user_dept,'MA');
			if($user_dept=="LY") $fty = array($user_dept);
			$op['factory'] = $arry2->select($fty,$op['order']['factory'],'PHP_factory','select','');
	//		$op['fac_flag']=0;
		}else{
			$op['factory'] = $arry2->select($FACTORY,$op['order']['factory'],'PHP_factory','select','');  	
		}
		// creat style type combo box
		$style_def = $style_type->get_fields('style_type');   // 取出 款式類別
		$op['style'] =  $arry2->select($style_def,$op['order']['style'],'PHP_style','select','');  	
		// creat apparel unit combo box
		$op['unit'] = $arry2->select($APPAREL_UNIT,$op['order']['unit'],'PHP_unit','select','');  	

		// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/picture/".$op['order']['order_num'].".jpg")){
			$op['main_pic'] = "./picture/".$op['order']['order_num'].".jpg";
		} else {
			$op['main_pic'] = "./images/graydot.gif";
		}

//08.09.23 其他相片加入

	$md = $op['order']['pic_num'] % 5;
	if ($md > 0) $md--;
	$op['order']['pic_num'] = $op['order']['pic_num'] + $md ;
	if(!$op['order']['pic_num'])$op['order']['pic_num'] = 5;
	for($i=0; $i< $op['order']['pic_num']; $i++)
	{		
		if(file_exists($GLOBALS['config']['root_dir']."/picture/".$op['order']['order_num']."_".$i.".jpg")){
			$op['oth_pic'][$i] = "./picture/".$op['order']['order_num']."_".$i.".jpg";
		} else {
			$op['oth_pic'][$i] = "./images/graydot.gif";
		}
		$op['oth_num'][$i] = $i;
		if((($i+1) % 5 == 0) )
		{
			$op['oth_ll'][$i] =1;
		}else{
			$op['oth_ll'][$i] =0;
		}
	}
	$op['ttl_pic'] = $i-1;



		$where_str="ORDER BY cust_s_name"; //依cust_s_name排序
		$cust_def = $cust->get_fields('cust_init_name',$where_str);
		$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
		for ($i=0; $i< sizeof($cust_def); $i++)
		{
			$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
		}
		$op['agent_select'] =  $arry2->select($cust_value,$op['order']['agent'],'PHP_agent','select','',$cust_def_vue); 

//生產線分別男女裝 -- 08.08.27
		$line_value = array('F','M','A');
		$line_key = array('Woman','Man','Ann');
		$op['line_select'] =  $arry2->select($line_key,$op['order']['line_sex'],'PHP_line','select','',$line_value); 
//主料單位--08.09.22
		$op['lots_unit'] =  $arry2->select($LOTS_PRICE_UNIT,$op['order']['lots_unit'],'PHP_lots_unit','select',''); 



		$op['msg'] = $order->msg->get(2);



		$op['search'] = '1';
		page_display($op,"065", $TPL_ORDER_EDIT);		
		break;
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//new case 在order中看sample的資料 
	case "show_sample_det":

		if (isset($PHP_old_ver))
		{
			$op['order']=$smpl_ord->get(0,0,$PHP_smpl_num);
		}else{
			/* if(strlen($PHP_smpl_num) > 9)$PHP_smpl_num=substr($PHP_smpl_num,0,-2);*/	
			$op['order']=$smpl_ord->get(0,0,$PHP_smpl_num);
		}
		if (!$op['order']) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
				// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/smpl_pic/".$op['order']['num'].".jpg")){
			$op['main_pic'] = "./smpl_pic/".$op['order']['num'].".jpg";
		} else {
			$op['main_pic'] = "./images/graydot.gif";
		}
				$op['msg'] = $smpl_ord->msg->get(2);
		$op['search'] = '1';
	$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];
		if (substr($user_dept,0,1)=="H" || substr($user_dept,0,1)=="L")  //判斷使用者部門是否為工廠
		{                                                                //以分隔修改等權限
			if ($user_dept == $op['order']['dept'])$op['dept_edit']=1;
			if ($user_dept =="H0" && substr($op['order']['dept'],0,1)=="H")$op['dept_edit']=1;
			if ($user_dept =="L0" && substr($op['order']['dept'],0,1)=="L")$op['dept_edit']=1;			
		}else{
			$op['dept_edit']=1;
		}
		
		$smpl=substr($op['order']['num'],0,9);
		if (!$op['ord_link']= $order->smpl_search($smpl))
		{
			$op['ord_link_non']=1;
		}
		$logs = $smpl_log->search50($op['order']['num']);  //取出該訂單全部log記錄
		if (!$logs){
			$op['msg'] = $smpl_log->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$tmp_id = substr($op['order']['num'],-1,1);
		
		if ($tmp_id > 1)
		{
			for ($i=1; $i< $tmp_id; $i++)
			{
				$op['ver_num'][($i-1)] = $smpl."-".$i;
			}
			$op['ver_show'] =$i;
		}
		
		$op['logs'] = $logs['log'];
		$op['log_records'] = $logs['records'];
		// creat LOG SUBJ combo box
		$op['logs_subj'] = $arry2->select($SMPL_LOG_SUBJ,'','PHP_subj','select','');  	

		$op['login_id'] = $GLOBALS['SCACHE']['ADMIN']['login_id'];
		
		$img_size = GetImageSize($op['main_pic']);
		if ($img_size[0] < $img_size[1]) $op['height'] = 1;


		page_display($op, "008", $TPL_SMPL_ORD_SHOW);		
	
		break;
		
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//new case 在order中看主料副料的資料
	case "show_sample_fa_det":
//		check_authority(2,2,"view");	
		if(strlen($PHP_smpl_num) > 9)$PHP_smpl_num=substr($PHP_smpl_num,0,-2);	
		$op['order'] = $smpl_ord->get(0,0,$PHP_smpl_num);  //取出該筆記錄
		if (!$op['order']) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		
		//size由scale變成id的儲存
		$size_data=$size_des->get($op['order']['size']);
		$op['order']['size_id']=$op['order']['size'];		
		$op['order']['size']=$size_data['size_scale'];
		
				// 檢查 相片是否存在 2007.03.23
		if(file_exists($GLOBALS['config']['root_dir']."/smpl_pic/".$op['order']['num'].".jpg")){
			$op['main_pic'] = "./smpl_pic/".$op['order']['num'].".jpg";
		} else {
			$op['main_pic'] = "./images/graydot.gif";
		}
		
		// 取出 smpl_log 本訂單 之歷史50筆的計記錄  -------------------
		$logs = $smpl_log->search50($op['order']['num']);  //取出該訂單全部log記錄
		if (!$logs){
			$op['msg'] = $smpl_log->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		//主副料取得-------------------------------------------------------------
		$where_str="where smpl_code='".$op['order']['num']."'";
		$op['fab'] = $smplord_lots->search(0,$where_str);  //取出該筆主料記錄			
		if (!isset($op['fab'][0])) {
			$op['fab']['msg']="No  Fabric record";
		}
		
		$op['acc'] = $smplord_acc->search(0,$where_str);  //取出該筆副料記錄		
		if (!isset($op['acc'][0])) {
			$op['acc']['msg']="No Accessory record";
		}

		
		

		$op['logs'] = $logs['log'];
		$op['log_records'] = $logs['records'];
		// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來判斷有無資料
		//--------------------------------
		
		$parm = $op['order'];

		$op['msg'] = $smpl_ord->msg->get(2);
		$op['search'] = '1';
		page_display($op, "009", $TPL_SMPL_FA_SHOW);			
		break;		




#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "do_order_edit":
		check_authority('065',"edit");			
//*****//2006.12.08確認sample tyep是否改變 start
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];	
		$op['order'] = $order->get($PHP_id);
		$PHP_old_order="";
		if ($op['order']['smpl_ord'] <> $PHP_smpl_ord)
		{
			$smpl=$smpl_ord->get(0,0,$op['order']['smpl_ord']);
			$old_order=$smpl['orders'];		
			$old_smpl_ord=$smpl['num'];
			$old_ord=explode('|',$old_order);			
			if ($PHP_order_num==$old_ord[sizeof($old_ord)-1]){$r_size=sizeof($old_ord)-2;}else{$r_size=sizeof($old_ord)-1;}
			for ($i=0; $i<sizeof($old_ord); $i++)
			{
				if ($old_ord[$i] <> $PHP_order_num)
				{
					if($i==$r_size){
					$PHP_old_order=$PHP_old_order.$old_ord[$i];
					}else{
					$PHP_old_order=$PHP_old_order.$old_ord[$i].'|';
					}
				}
			}
//*****//2006.12.08smpl_type由DB中帶出來 start
		$smpl=$smpl_ord->get(0,0,$PHP_smpl_ord);
		$PHP_num = $smpl['num'];
		$PHP_style_n = $smpl['style'];
		$PHP_style_num =$smpl['ref'];
		$PHP_apv_date=$smpl['apv_date'];
		$PHP_spt=$smpl['spt'];
		$PHP_ie = number_format(($PHP_spt/$GLOBALS['IE_TIME']),2,'.','');
		$PHP_orders=$smpl['orders'];
		// 再計算 su 的值........
		$PHP_su =  number_format(($PHP_qty * $PHP_ie),0,'','');
		if ($PHP_ie>0){$PHP_status=1;}else{$PHP_status=0;}
		if ($PHP_apv_date=='0000-00-00'){$PHP_ie_time2=0;}else{$PHP_ie_time2=$PHP_spt;}	
//*****//2006.12.08smpl_type由DB中帶出來 end
		}else{
			$PHP_old_order="no_order";
			$old_smpl_ord="";
//*****//2006.12.08smpl_type由order_DB中帶出來 start
		$smpl=$smpl_ord->get(0,0,$PHP_smpl_ord);
		$PHP_num = $op['order']['smpl_ord'];
		$PHP_style_n = $PHP_style;
		$PHP_style_num = $op['order']['style_num'];
		$PHP_apv_date=$op['order']['smpl_apv'];
		$PHP_spt=$op['order']['ie_time1'];
		$PHP_ie = $op['order']['ie1'];
		$PHP_orders="";
		// 再計算 su 的值........
		$PHP_su =  number_format(($PHP_qty * $PHP_ie),0,'','');
		if ($PHP_ie>0){$PHP_status=1;}else{$PHP_status=0;}
		$PHP_ie_time2=$op['order']['ie_time2'];
//*****//2006.12.08smpl_type由order_DB中帶出來 end
		}	
//*****//2006.12.08 確認sample tyep是否改變 end

		$argv = array(	"id"			=>	$PHP_id,
						"order_num"				=>	$PHP_order_num,
						"ref"							=>	$PHP_ref,
						"factory"					=>	$PHP_factory,
						"style"						=>	$PHP_style_n,
						"qty"							=>	$PHP_qty,
						"unit"						=>	$PHP_unit,
						"style_num"				=>	$PHP_style_num,
						"patt_num"				=>	$PHP_patt_num,
						"uprice"					=>	$PHP_uprice,
						"quota"						=>	$PHP_quota,
						
						
						"ie1"							=>	$PHP_ie1,
						
						"old_num"					=>	$old_smpl_ord,
						"old_orders"			=>	$PHP_old_order,
						
						"smpl_ord"				=>	$PHP_smpl_ord,
						"num"							=>	$PHP_num,
						"smpl_apv"				=>	$PHP_apv_date,
						"ie1"							=>	$PHP_ie,
						"ie_time1"				=>	$PHP_spt,
						"ie_time2"				=>	$PHP_ie_time2,
						"su"							=>	$PHP_su,
						"orders"					=>	$PHP_orders,
						"status"					=>	$PHP_status,

						"mat_u_cost"			=>	$PHP_mat_u_cost,
						"mat_useage"			=>	$PHP_mat_useage,
						"acc_u_cost"			=>	$PHP_acc_u_cost,
						"quota_fee"				=>	$PHP_quota_fee,
						"comm_fee"				=>	$PHP_comm_fee,
						"cm"							=>	$PHP_cm,
						"smpl_fee"				=>	$PHP_smpl_fee,

						"pic"							=>	$PHP_pic,
						"pic_upload"			=>	$PHP_pic_upload,

						"emb"							=>	$PHP_emb,
						"wash"						=>	$PHP_wash,
						"oth"							=>	$PHP_oth,
						"oth_treat"				=>	$PHP_oth_treat,

						"etd"							=>	$PHP_etd,
						"etp"							=>	$PHP_etp,						
						"last_updator"		=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
						
						"agent"						=>	$PHP_agent,
						"fusible"					=>	$PHP_fus_u_cost,
						"interline"				=>	$PHP_int_u_cost,
						"line_sex"				=>	$PHP_line,
						"lots_unit"				=>	$PHP_lots_unit,
						"oth_pic"					=>	$PHP_oth_pic,
						"oth_pic_upload"	=> $PHP_oth_pic_upload,
						'pic_num'					=>	$PHP_oth_pic_num,
						);

			$op['order'] = $argv;
			$check = $order->check($argv);
	// ..............輸入資料 有錯誤時  再回到樣本輸入表單
	if (!$check) {  
		$op['msg']= $order->msg->get(2);
//---------------------------
		$op['order'] = $order->get($PHP_id);
		if (!$op['order']) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		// creat ETD, ETP date combo box
		$etd = apart_date(0,$op['order']['etd']);
		$etp = apart_date(0,$op['order']['etp']);
		
//*****//2006.12.08	修改sample為下拉式 start
		$s_date=increceDaysInDate($TODAY,-1200); //12個月前
		// $where="where last_update > '".$s_date."'and cust='".$op['order']['cust']."' AND dept='".$op['order']['dept']."' order by num";
		$where="where last_update > '".$s_date."'and cust='".$op['order']['cust']."' order by num";
		
		$smpl_no=$smpl_ord->get_fields("num",$where);		
	    $j=0;
	    if($smpl_no){
		$sml_no[0]=substr($smpl_no[0],0,9);
		for($i=1;$i< sizeof($smpl_no); $i++)
		{
			if($sml_no[$j] != substr($smpl_no[$i],0,9)){	
				$j++;
				$sml_no[$j]=substr($smpl_no[$i],0,9);
			}
		}
		}else{
		$sml_no=array('');
		}
		$op['smpl_no']=$arry2->select($sml_no,$PHP_smpl_ord,'PHP_smpl_ord','select','');
//*****//2006.12.08	修改sample為下拉式	end
				
		// creat factory combo box
		if ($user_dept=="HJ" || $user_dept=="LY")
		{
			if($user_dept=="HJ") $fty = array($user_dept,'MA');
			if($user_dept=="LY") $fty = array($user_dept);
			$op['factory'] = $arry2->select($fty,$op['order']['factory'],'PHP_factory','select','');
//			$op['fac_flag']=1;
		}else{
			$op['factory'] = $arry2->select($FACTORY,$op['order']['factory'],'PHP_factory','select','');  	
		}
		
		// creat style type combo box		
		$style_def = $style_type->get_fields('style_type');   // 取出 款式類別
		$op['style'] =  $arry2->select($style_def,$op['order']['style'],'PHP_style','select','');  	
		// creat apparel unit combo box
		$op['unit'] = $arry2->select($APPAREL_UNIT,$op['order']['unit'],'PHP_unit','select','');  	

		// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/picture/".$op['order']['order_num'].".jpg")){
			$op['main_pic'] = "./picture/".$op['order']['order_num'].".jpg";
		} else {
			$op['main_pic'] = "./images/graydot.gif";
		}

//08.09.23 其他相片加入

		$md = $op['order']['pic_num'] % 5;
		if ($md > 0) $md--;
		$op['order']['pic_num'] = $op['order']['pic_num'] + $md ;
		if(!$op['order']['pic_num'])$op['order']['pic_num'] = 5;
		for($i=0; $i< $op['order']['pic_num']; $i++)
		{		
			if(file_exists($GLOBALS['config']['root_dir']."/picture/".$op['order']['order_num']."_".$i.".jpg")){
				$op['oth_pic'][$i] = "./picture/".$op['order']['order_num']."_".$i.".jpg";
			} else {
				$op['oth_pic'][$i] = "./images/graydot.gif";
			}
			$op['oth_num'][$i] = $i;
			if((($i+1) % 5 == 0) )
			{
				$op['oth_ll'][$i] =1;
			}else{
				$op['oth_ll'][$i] =0;
			}
		}
		$op['ttl_pic'] = $i-1;



		$where_str="ORDER BY cust_s_name"; //依cust_s_name排序
		$cust_def = $cust->get_fields('cust_init_name',$where_str);
		$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
		for ($i=0; $i< sizeof($cust_def); $i++)
		{
			$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
		}
		$op['agent_select'] =  $arry2->select($cust_value,$op['order']['agent'],'PHP_agent','select','',$cust_def_vue); 

//生產線分別男女裝 -- 08.08.27
		$line_value = array('F','M','A');
		$line_key = array('Woman','Man','Ann');
		$op['line_select'] =  $arry2->select($line_key,$op['order']['line_sex'],'PHP_line','select','',$line_value); 
//主料單位--08.09.22
		$op['lots_unit'] =  $arry2->select($LOTS_PRICE_UNIT,$op['order']['lots_unit'],'PHP_lots_unit','select',''); 



		$op['msg'] = $order->msg->get(2);		
		page_display($op,'065', $TPL_ORDER_EDIT);
		break;
		}

		// 輸入項正確後............after check input.........
		
		// 計算  gm rate -----------------------------
		$unit_cost = ($argv['mat_u_cost']* $argv['mat_useage'])+ $argv['interline']+ $argv['fusible']+ $argv['acc_u_cost'] + $argv['quota_fee'] + $argv['comm_fee'] + $argv['cm'] + $argv['emb'] + $argv['wash'] + $argv['oth'];
		$grand_cost = $unit_cost*$argv['qty'] + $argv['smpl_fee'];
		$sales = $argv['uprice']*$argv['qty'];
		$gm = $sales - $grand_cost;
			if ($sales){
				$rate = ($gm/ $sales)*100;
			}
		$argv['gmr'] = number_format($rate, 2, '.', ',');
		// -------------- 計算 su ------------------
		//   2005/08/31 改由資料庫抓 su [以 ie 計算填入 ]
		$argv['su'] = $PHP_qty * $PHP_ie1;


		// ========= add to DB =======
		if (!$order->edit($argv)) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}
					# 記錄使用者動態
		$message = "Edit Order record:[$PHP_order_num]•";
		$log->log_add(0,"101E",$message);

		$back_str ="index2.php?PHP_action=order_view&PHP_id=".$PHP_id."&PHP_msg=".$message;
		redirect_page($back_str);   


//=======================================================
	case "send_order_cfm":	

		check_authority('065',"add");			
		if ($ord_submit_ETP_limit > $PHP_ETP || $ord_submit_ETD_limit > $PHP_ETD) //當ETP小於今日後7日維持原頁出現錯誤訊息
		{
			$op['msg'][] = "Sorry ! please update your unreasonable ETP ( before today at least) or ETD ( 20 days before today at least)";		
			$back_str ="index2.php?PHP_action=order_view&PHP_id=".$PHP_id."&cgiget=".$cgiget."&cgino=".$cgino."&cgi_1=".$cgi_1."&cgi_2=".$cgi_2."&cgi_3=".$cgi_3."&cgi_4=".$cgi_4."&cgi_5=".$cgi_5."&cgi_6=".$cgi_6."&cgi_del=".$cgi_del."&sub_error=1";
			redirect_page($back_str);   	    
			break;		
		}		
		// 修改 status 欄

		$argv = array(	"id"			=>	$PHP_id,
						"last_updator"	=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
						"status"		=>	2
						);

		// ========= add to DB =======
		if (!$order->send_cfm($argv)) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}

				# 記錄使用者動態
		$message = "Success submit order:[$PHP_order_num]•";
		$log->log_add(0,"101CFM",$message);
		$back_str ="index2.php?PHP_action=order_view&PHP_id=".$PHP_id."&PHP_msg=".$message;
		redirect_page($back_str);

		break;
	
//-------------------------------------------------------------------------------------
//			 job 102  訂 單 確 認  [  高階授權 的 job ]
//-------------------------------------------------------------------------------------
case "order_cfm":
check_authority('066',"view");

if (!$op = $order->uncfm_search()) {
	$op['msg']= $order->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}

$tmp = $cost->search_uncfm_cost(2);
$op['cost'] = $tmp['cost'];
$op['c_max_no'] = $tmp['max_no'];
$op['c_maxpage']	=	$tmp['maxpage'];
$op['c_pages']	=	$tmp['pages'];
$op['c_now_pp']	=	$tmp['now_pp'];
$op['c_lastpage']	=	$tmp['lastpage'];

$tmp = $cost->search_remun_check(2);
$op['rem'] = $tmp['rem'];
$op['r_max_no'] = $tmp['max_no'];
$op['r_maxpage']	=	$tmp['maxpage'];
$op['r_pages']	=	$tmp['pages'];
$op['r_now_pp']	=	$tmp['now_pp'];
$op['r_lastpage']	=	$tmp['lastpage'];

$tmp = $except->search_cfm();
$op['exc'] = $tmp['exc'];
$op['e_max_no'] = $tmp['max_no'];
$op['e_maxpage']	=	$tmp['maxpage'];
$op['e_pages']	=	$tmp['pages'];
$op['e_now_pp']	=	$tmp['now_pp'];
$op['e_lastpage']	=	$tmp['lastpage'];
$dept_ary = array( 1 => 'LY' , 2 => 'HJ' , 4 => 'RD' , 8 => 'PM' , 16 => 'CF' );
for($i=0; $i<sizeof($op['exc']); $i++)
{				
	foreach($dept_ary as $key => $value)
	{
		if($op['exc'][$i]['oth_dept'] & $key)
		{						
			$op['exc'][$i][$value] = 1;
		}else{
			$op['exc'][$i][$value] = 0;
		}
	}
	if($op['exc'][$i]['dept'] <> 'KA' &&$op['exc'][$i]['dept'] <> 'KB')
	{
		if(substr($op['exc'][$i]['ord_num'],0,1) == 'A')$op['exc'][$i]['KA'] = 1;
		if(substr($op['exc'][$i]['ord_num'],0,1) == 'B')$op['exc'][$i]['KB'] = 1;
	}
}	

# 2013/07/11 將今天以後的訂單的 handling_fee 寫回 s_order 內(factory = LY 且 排除 L 開頭的訂單)
# 2013/07/11 由於 工繳 目前是手動挑選單訂，自行加入 handling_fee。改成 工繳 多一欄 將 handling_fee 納入計算(2013/07/11程式更新後所新建立的訂單才納入計算)
# 2013/07/11 今天以前的 handling_fee 欄位不填值，改用程式判斷2012/08/15之後將handling_fee設為0.25，目的是讓前台顯示(order list、order show、order cfm...等)正常
//重新計算 毛利率
$handling_row = $order->get_fields("set_value", " where set_name='handling_fee'","para_set");
foreach($op['sorder'] as $key=>$val){
	if($val['factory'] == 'LY' and $val['opendate'] >= '2013-07-11' and substr($val['order_num'],0,1) <> 'L'){
		$handling_fee = $val['handling_fee'];
	}elseif($val['factory'] == 'LY' and $val['opendate'] >= '2012-08-15' and substr($val['order_num'],0,1) <> 'L'){
		$handling_fee = $handling_row[0];
	}else{
		$handling_fee = 0.00;
	}
	//計算 C.M. estimate
	if($val['ie2'] > 0){
		$fty_cm = $order->get_fields("set_value", " where set_name='".strtolower($val['factory'])."-cm'","para_set");
		$cm = $val['ie2'] * $fty_cm[0];
	}elseif($val['ie1'] > 0){
		$fty_cm = $order->get_fields("set_value", " where set_name='".strtolower($val['factory'])."-cm'","para_set");
		$cm = $val['ie1'] * $fty_cm[0];
	}else{
		$cm = $val['cm'];
	}
	
	// 計算  gm rate -----------------------------
	$unit_cost = ($val['mat_u_cost'] * $val['mat_useage']) + $val['interline'] + $val['fusible'] + $val['acc_u_cost'] + $val['quota_fee'] + $val['comm_fee'] + $cm + $val['emb'] + $val['wash'] + $val['oth'] + $handling_fee;
	$grand_cost = $unit_cost * $val['qty'] + $val['smpl_fee'];
	$sales = $val['uprice'] * $val['qty'];
	$gm = $sales - $grand_cost;
	
	if ($sales){
		$op['sorder'][$key]['gmr'] = ( $gm / $sales ) * 100;
	}else{
		$op['sorder'][$key]['gmr'] = 0;
	}
}

// op 被清除了 需再判斷一次 
$op['msg']= $order->msg->get(2);
$op['today']=date('Y-m-d');

//080725message增加		
$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
$op['max_notify'] = $note['max_no'];

if( $GLOBALS['SCACHE']['ADMIN']['team_id'] == 'SU' )$op['exc_flag'] = 1;
if( $GLOBALS['SCACHE']['ADMIN']['dept'] == 'SA') $op['exc_flag'] = 1;

page_display($op,'066', $TPL_UNCFM_ORDER_LIST);				
break;



//=======================================================
	case "order_cfm_view":
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
		check_authority('066',"view");		

		$op['order'] = $order->get($PHP_id);  //取出該筆記錄
		
        $op['combine'] = $order->get_combine($op['order']['combine']);
        
		if (!$op['order']) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op = $order->orgainzation_ord($op);

		// 取出 order_log 本訂單 之歷史50筆的計記錄  -------------------
		$logs = $order_log->search50($op['order']['order_num']);  //取出該訂單全部log記錄
		if (!$logs){
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['logs'] = $logs['order_log'];
		$op['log_records'] = $logs['records'];
			// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來叛斷有無資料

		$parm = $op['order'];

		// 計算 lead time
		$op['lead_time'] = countDays ($parm['etp'],$parm['etd']);

		// 加入返回前頁 2005/05/05
		$op['back_str'] = $cgiget."&PHP_sr_startno=".$cgino."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5; 

		$op['back_str2'] = $cgiget."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5; 

		//傳送 參數入 確認訂單表中 再送出到確認後 或駁回後之計算用
		$op['max_rec'] = $max_rec;
		$op['per_page'] = $per_page;
		$op['PHP_sr_startno'] = $cgino;

				
		if ($user_dept=="HJ" || $user_dept=="LY")//當進入者為工廠的人時,判斷是否可以confirm這張order
		{
			if ($user_dept == $op['order']['dept'])$op['dept_edit']=1;			
		}else{
			$op['dept_edit']=1;
		}		
		$op['msg'] = $order->msg->get(2);		
		$op['search'] = '1';	
		$op['check_etp']=$ord_submit_ETP_limit;
		$op['check_etd']=$ord_submit_ETD_limit;	
		$op['is_factory'] = is_dept($GLOBALS['SCACHE']['ADMIN']['dept']);
		$op['account_dept'] = $GLOBALS['SCACHE']['ADMIN']['dept'];
	//print_r($op);
		page_display($op,'066', $TPL_ORDER_SHOW_CFM);	  // 設定 新增刪改權限  	    
		break;
//=======================================================
case "do_order_cfm":
check_authority('066',"add");

// 修改 status 欄
if (!$PHP_stk_ord && ($ord_submit_ETP_limit > $PHP_ETP || $ord_submit_ETD_limit > $PHP_ETD || $PHP_QTY==0)) 
{//當[ETP小於今日後7日],[ETD小於今日後14日],[Q'ty=0]維持原頁出現錯誤訊息
	$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
	$op['order'] = $order->get($PHP_id);  //取出該筆記錄
	if (!$op['order']) {
		$op['msg'] = $order->msg->get(2);
		$layout->assign($op);
		$layout->display($TPL_ERROR);  		    
		break;
	}
	$op = $order->orgainzation_ord($op);
	// 取出 order_log 本訂單 之歷史50筆的計記錄  -------------------
	$logs = $order_log->search50($op['order']['order_num']);  //取出該訂單全部log記錄
	if (!$logs){
		$op['msg'] = $order->msg->get(2);
		$layout->assign($op);
		$layout->display($TPL_ERROR);  		    
		break;
	}
	$op['logs'] = $logs['order_log'];
	$op['log_records'] = $logs['records'];
	// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來叛斷有無資料

	$parm = $op['order'];

	// 計算 lead time
	$op['lead_time'] = countDays ($parm['etp'],$parm['etd']);

	// 加入返回前頁 2005/05/05
	$op['back_str'] = $cgiget."&PHP_sr_startno=".$cgino."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5; 

	$op['back_str2'] = $cgiget."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5; 

	//傳送 參數入 確認訂單表中 再送出到確認後 或駁回後之計算用
	$op['max_rec'] = $max_rec;
	$op['per_page'] = $per_page;
	$op['PHP_sr_startno'] = $cgino;


	if ($user_dept=="HJ" || $user_dept=="LY")//當進入者為工廠的人時,判斷是否可以confirm這張order
	{
		if ($user_dept == $op['order']['dept'])$op['dept_edit']=1;			
	}else{
		$op['dept_edit']=1;
	}
	
	if ($PHP_QTY == 0)
	{	
		$op['msg'][] = "Sorry ! The Q\'ty  is unreasonable.<br>( Q\'ty must more than 0) <br>Please Reject this order to update it first。";
	}else{	
		$op['msg'][] = "Sorry ! The ETP or ETD date is unreasonable.<br>(ETP : before today at leaset. ETD : 20 days before today at least)<br>Please Reject this order to update it first";				
	}
	
	$op['search'] = '1';	
	$op['check_etp']=$ord_submit_ETP_limit;
	$op['check_etd']=$ord_submit_ETD_limit;	

	page_display($op,'066', $TPL_ORDER_SHOW_CFM);	  // 設定 新增刪改權限  	    
	break;
}	

$argv = array(
	"id"		=>	$PHP_id,
	"cfmer"		=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
	"status"	=>	3
);

// ========= add to DB =======
if (!$order->do_cfm($argv)) {
	$op['msg'] = $order->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;	    
}

# 記錄使用者動態
$message = "Confirm order:[$PHP_order_num]•";
$log->log_add(0,"066A",$message);

//當(開始的記錄筆號 +1 等於總筆數) 且 (總比數除以每頁數餘1)時 要減一頁
if(($PHP_sr_startno +1 == $max_rec) && ($max_rec %  $per_page == 1)){
	if ($PHP_sr_startno != 0 ){
		$PHP_sr_startno = $PHP_sr_startno - $per_page;
	}
}

$PHP_back_str = $PHP_back_str ."&PHP_sr_startno=".$PHP_sr_startno;
redirect_page($PHP_back_str);
break;



//=======================================================
	case "reject_order_cfm":
		check_authority('066',"add");
		// 修改 status 欄

		$argv = array(	"id"		=>	$PHP_id,
						"cfmer"		=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
						"status"	=>	5
						);

		$argv2 = array(	"order_num"	=>	$PHP_order_num,
						"user"		=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
						"des"		=>	"CFM REJECT : for - ".$PHP_detail
						);

		// ========= add to  order DB =======
		if (!$order->reject_cfm($argv)) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}

		// ========= add to  order_log DB =======
		if (!$order_log->add($argv2)) {
			$op['msg'] = $order_log->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}
		# 記錄使用者動態
		$message = "Reject order confirm:[$PHP_order_num]•";
		$log->log_add(0,"102ARJ",$message);

		//當(開始的記錄筆號 +1 等於總筆數) 且 (總比數除以每頁數餘1)時 要減一頁
		if(($PHP_sr_startno +1 == $max_rec) && ($max_rec %  $per_page == 1)){
			if ($PHP_sr_startno != 0 ){
				$PHP_sr_startno = $PHP_sr_startno - $per_page;
			}
		}

		$PHP_back_str = $PHP_back_str ."&PHP_sr_startno=".$PHP_sr_startno;

		redirect_page($PHP_back_str);

		break;

		
		
		
		
		
		
		
#------------------------------------------------------------------------------------------------------------------------------------

//-------------------------------------------------------------------------------------
// job 075  訂 單 覆 核 [  高階授權 的 job ]
//-------------------------------------------------------------------------------------
case "order_rev":
check_authority('075',"view");

$_SESSION['sch_parm']['IE2_sr_startno'] = !empty($_GET['IE2_sr_startno']) ? $_GET['IE2_sr_startno'] : '';
$_SESSION['sch_parm']['IE1_sr_startno'] = !empty($_GET['IE1_sr_startno']) ? $_GET['IE1_sr_startno'] : '';
$_SESSION['sch_parm']['PHP_action'] = !empty($_GET['PHP_action']) ? $_GET['PHP_action'] : '';

if (!$op = $order->unrev_search()) {
	$op['msg']= $order->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}

$tmp = $cost->search_uncfm_cost(4);
if (isset($tmp['max_no'])) {
	$op['cost'] = $tmp['cost'];
	$op['c_max_no'] = $tmp['max_no'];
	$op['c_maxpage']	=	$tmp['maxpage'];
	$op['c_pages']	=	$tmp['pages'];
	$op['c_now_pp']	=	$tmp['now_pp'];
	$op['c_lastpage']	=	$tmp['lastpage'];
}

$tmp = $cost->search_remun_check(4);
$op['rem'] = $tmp['rem'];
$op['r_max_no'] = $tmp['max_no'];
$op['r_maxpage']	=	$tmp['maxpage'];
$op['r_pages']	=	$tmp['pages'];
$op['r_now_pp']	=	$tmp['now_pp'];
$op['r_lastpage']	=	$tmp['lastpage'];


$tmp = $except->search_rev();
$op['exc'] = $tmp['exc'];
$op['e_max_no'] = $tmp['max_no'];
$op['e_maxpage']	=	$tmp['maxpage'];
$op['e_pages']	=	$tmp['pages'];
$op['e_now_pp']	=	$tmp['now_pp'];
$op['e_lastpage']	=	$tmp['lastpage'];
$dept_ary = array( 1	=>	'LY', 2	=>	'HJ', 4	=>	'RD', 8	=>	'PM' , 16	=>	'CF' );
for($i=0; $i<sizeof($op['exc']); $i++)
{				
	foreach($dept_ary as $key => $value)
	{
		if($op['exc'][$i]['oth_dept'] & $key)
		{						
			$op['exc'][$i][$value] = 1;
		}else{
			$op['exc'][$i][$value] = 0;
		}
	}
	if($op['exc'][$i]['dept'] <> 'KA' && $op['exc'][$i]['dept'] <> 'KB' && $op['exc'][$i]['dept'] <> 'DA' )
	{
		if(substr($op['exc'][$i]['ord_num'],0,1) == 'A')$op['exc'][$i]['KA'] = 1;
		if(substr($op['exc'][$i]['ord_num'],0,1) == 'B')$op['exc'][$i]['KB'] = 1;
		if(substr($op['exc'][$i]['ord_num'],0,1) == 'D')$op['exc'][$i]['DA'] = 1;
	}
}	


$tmp = $offer->search_un_apv();
$op['of'] = $tmp['of'];
$op['f_max_no'] = $tmp['max_no'];
$op['f_maxpage']	=	$tmp['maxpage'];
$op['f_pages']	=	$tmp['pages'];
$op['f_now_pp']	=	$tmp['now_pp'];
$op['f_lastpage']	=	$tmp['lastpage'];



$tmp = $debit->search_apv();
$op['dn'] = $tmp['dn'];
$op['d_max_no'] = $tmp['max_no'];
$op['d_maxpage']	=	$tmp['maxpage'];
$op['d_pages']	=	$tmp['pages'];
$op['d_now_pp']	=	$tmp['now_pp'];
$op['d_lastpage']	=	$tmp['lastpage'];
$dept_ary = array( 1	=>	'LY', 2	=>	'HJ', 4	=>	'RD', 8	=>	'PM', 16	=> 'KA', 32	=>	'KB' , 64	=>	'CF' );
for($i=0; $i<sizeof($op['dn']); $i++)
{				
	foreach($dept_ary as $key => $value)
	{
		if($op['dn'][$i]['oth_dept'] & $key)
		{						
			$op['dn'][$i][$value] = 1;
		}else{
			$op['dn'][$i][$value] = 0;
		}
	}
		if($op['dn'][$i]['chk_to'] == 0)
		{
			$tmp = $supl->get_fields('supl_s_name'," WHERE vndr_no='".$op['dn'][$i]['dn_to']."'");			
			$op['dn'][$i]['dn_to_name'] = $tmp[0];

		}else if($op['dn'][$i]['chk_to'] == 1){
			$tmp = $cust->get_fields('cust_init_name'," WHERE cust_s_name='".$op['dn'][$i]['dn_to']."'");
			$op['dn'][$i]['dn_to_name'] = $tmp[0];
		}else{
			$tmp = $dept->get_fields('dept_name'," WHERE dept_code='".$op['dn'][$i]['dn_to']."'");			
				$op['dn'][$i]['dn_to_name'] = $tmp[0];				
		}

}	

//IE未CFM
$tmp = $order->ie_uncfm_search(1);
$op['ord_ie'] = $tmp['ord_ie'];
$op['ie1_max_no'] = $tmp['max_no'];
$op['ie1_maxpage']	=	$tmp['maxpage'];
$op['ie1_pages']	=	$tmp['pages'];
$op['ie1_now_pp']	=	$tmp['now_pp'];
$op['ie1_lastpage']	=	$tmp['lastpage'];


//FINAL IE未CFM
$tmp = $order->ie_uncfm_search(2);
$op['ord_ie2'] = $tmp['ord_ie'];
$op['ie2_max_no'] = $tmp['max_no'];
$op['ie2_maxpage']	=	$tmp['maxpage'];
$op['ie2_pages']	=	$tmp['pages'];
$op['ie2_now_pp']	=	$tmp['now_pp'];
$op['ie2_lastpage']	=	$tmp['lastpage'];
for($i=0; $i<sizeof($op['ord_ie2']); $i++)
{
	if ($op['ord_ie2'][$i]['ie2'] == 0)	$op['ord_ie2'][$i]['final_check'] = $order->check_ftycm($op['ord_ie2'][$i]['order_num']);			
}		

$op['msg']= $order->msg->get(2);
$op['today']=date('Y-m-d');
if(isset($PHP_msg)) $op['msg'][] = $PHP_msg;
//080725message增加		 back_str
$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
$op['max_notify'] = $note['max_no'];

# 2013/07/11 將今天以後的訂單的 handling_fee 寫回 s_order 內(factory = LY 且 排除 L 開頭的訂單)
# 2013/07/11 由於 工繳 目前是手動挑選單訂，自行加入 handling_fee。改成 工繳 多一欄 將 handling_fee 納入計算(2013/07/11程式更新後所新建立的訂單才納入計算)
# 2013/07/11 今天以前的 handling_fee 欄位不填值，改用程式判斷2012/08/15之後將handling_fee設為0.25，目的是讓前台顯示(order list、order show、order cfm...等)正常
//重新計算 毛利率
$handling_row = $order->get_fields("set_value", " where set_name='handling_fee'","para_set");
foreach($op['sorder'] as $key=>$val){
	if($val['factory'] == 'LY' and $val['opendate'] >= '2013-07-11' and substr($val['order_num'],0,1) <> 'L'){
		$handling_fee = $val['handling_fee'];
	}elseif($val['factory'] == 'LY' and $val['opendate'] >= '2012-08-15' and substr($val['order_num'],0,1) <> 'L'){
		$handling_fee = $handling_row[0];
	}else{
		$handling_fee = 0.00;
	}
	//計算 C.M. estimate
	if($val['ie2'] > 0){
		$fty_cm = $order->get_fields("set_value", " where set_name='".strtolower($val['factory'])."-cm'","para_set");
		$cm = $val['ie2'] * $fty_cm[0];
	}elseif($val['ie1'] > 0){
		$fty_cm = $order->get_fields("set_value", " where set_name='".strtolower($val['factory'])."-cm'","para_set");
		$cm = $val['ie1'] * $fty_cm[0];
	}else{
		$cm = $val['cm'];
	}
	
	// 計算  gm rate -----------------------------
	$unit_cost = ($val['mat_u_cost'] * $val['mat_useage']) + $val['interline'] + $val['fusible'] + $val['acc_u_cost'] + $val['quota_fee'] + $val['comm_fee'] + $cm + $val['emb'] + $val['wash'] + $val['oth'] + $handling_fee;
	$grand_cost = $unit_cost * $val['qty'] + $val['smpl_fee'];
	$sales = $val['uprice'] * $val['qty'];
	$gm = $sales - $grand_cost;
	
	if ($sales){
		$op['sorder'][$key]['gmr'] = ($gm / $sales) * 100;
	}else{
		$op['sorder'][$key]['gmr'] = 0;
	}
}

page_display($op,'067', $TPL_UNREV_ORDER_LIST);				
break;



//=======================================================
case "order_rev_view":
check_authority('075',"view");
$op['order'] = $order->get($PHP_id);  //取出該筆記錄

if (!$op['order']) {
	$op['msg'] = $order->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}

$op['combine'] = $order->get_combine($op['order']['combine']);

$op = $order->orgainzation_ord($op);

// 取出 order_log 本訂單 之歷史50筆的計記錄  ------
$logs = $order_log->search50($op['order']['order_num']); 
if (!$logs){
	$op['msg'] = $order->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}
$op['logs'] = $logs['order_log'];
$op['log_records'] = $logs['records'];
// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來叛斷有無資料
//--------------------------------

$parm = $op['order'];

// 計算 lead time
$op['lead_time'] = countDays ($parm['etp'],$parm['etd']);

// 加入返回前頁 2005/05/05
$op['back_str'] = $cgiget."&PHP_sr_startno=".$cgino."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5;

$op['back_str2'] = $cgiget."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5;

//傳送 參數入 確認訂單表中 再送出到確認後 或駁回後之計算用
$op['max_rec'] = $max_rec;
$op['per_page'] = $per_page;
$op['PHP_sr_startno'] = $cgino;

$op['search'] = '1';
$op['check_etp']=$ord_submit_ETP_limit;
$op['check_etd']=$ord_submit_ETD_limit;

page_display($op,'075', $TPL_ORDER_SHOW_REV);
break;



//=======================================================
case "do_order_rev":
check_authority('075',"add");

if (!$PHP_stk_ord && ($ord_submit_ETP_limit > $PHP_etp || $ord_submit_ETD_limit > $PHP_etd || $PHP_QTY==0))
{//當[ETP小於今日後7日],[ETD小於今日後14日],[Q'ty=0]維持原頁出現錯誤訊息
	$op['order'] = $order->get($PHP_id);  //取出該筆記錄

	if (!$op['order']) {
		$op['msg'] = $order->msg->get(2);
		$layout->assign($op);
		$layout->display($TPL_ERROR);  		    
		break;
	}
	
	$op = $order->orgainzation_ord($op);
	// 取出 order_log 本訂單 之歷史50筆的計記錄  ------
	$logs = $order_log->search50($op['order']['order_num']); 
	if (!$logs){
		$op['msg'] = $order->msg->get(2);
		$layout->assign($op);
		$layout->display($TPL_ERROR);  		    
		break;
	}
	
	$op['logs'] = $logs['order_log'];
	$op['log_records'] = $logs['records'];
	// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來叛斷有無資料
	//--------------------------------

	$parm = $op['order'];

	// 計算 lead time
	$op['lead_time'] = countDays ($parm['etp'],$parm['etd']);

	// 加入返回前頁 2005/05/05
	$op['back_str'] = $cgiget."&PHP_sr_startno=".$cgino."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5;

	$op['back_str2'] = $cgiget."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5;

	//傳送 參數入 確認訂單表中 再送出到確認後 或駁回後之計算用
	$op['max_rec'] = $max_rec;
	$op['per_page'] = $per_page;
	$op['PHP_sr_startno'] = $cgino;

	if ($PHP_QTY == 0)
	{	
		$op['msg'][] = "Sorry ! The Q\'ty  is unreasonable.<br>( Q\'ty must more than 0) <br>Please Reject this order to update it first。";
	}else{	
		$op['msg'][] = "Sorry ! The ETP or ETD date is unreasonable.<br>(ETP : before today at leaset. ETD : 20 days before today at least)<br>Please Reject this order to update it first";				
	}
	$op['search'] = '1';
	$op['check_etp']=$ord_submit_ETP_limit;
	$op['check_etd']=$ord_submit_ETD_limit;	
	page_display($op,'067', $TPL_ORDER_SHOW_APV);			
	break;
}	

// 寫入 capaci. pre-schedule ===  
// 先檢查 capacity 檔內是否已經有記錄 ???
$s_year = substr($PHP_etp,0,4);
$e_year = substr($PHP_etd,0,4);
for($i=$s_year;$i<$e_year+1;$i++){
	if (!$T=$capaci->get($PHP_factory, $i)) {
		$op['msg'] = $capaci->msg->get(2);
		$layout->assign($op);
		$layout->display($TPL_ERROR);  		    
		exit;
	}
}

//2007-05-17訂單未算IE,未有SU時以上衣*2下衣*1估算SU
if ($PHP_su == 0)
{
	if ($PHP_style=='PS' || $PHP_style=='BS' || $PHP_style=='BZ' || $PHP_style=='DR' || $PHP_style=='JK' || $PHP_style=='PS-J' || $PHP_style=='PS-P' || $PHP_style=='PS-S' || $PHP_style=='VS' || $PHP_style=='SS'){
		$PHP_su=2*$PHP_QTY;			
	}else{
		$PHP_su=1*$PHP_QTY;			
	}
}

$f1=$order->update_field('su', $PHP_su, $PHP_id); //2007-05-17訂單存入估算SU

// 寫入 capaci. pre-schedule ===  在 order->diver_month_su 內寫入
// 2005/08/31 改由資料庫抓 su [ 以 ie 計算填入 ]
$div = $order->distri_month_su($PHP_su,$PHP_etp,$PHP_etd,$PHP_factory,'pre_schedule');

// 修改 status 欄  --------- s_order table -------------------------------
$argv = array(
	"id"			=>	$PHP_id,
	"rev_user"		=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
	"status"		=>	4
);

// ========= add to s_order APV 記錄 =======  ????????  是否寫入 要看有沒有 capacity 記錄
if (!$order->do_rev($argv)) {
	$op['msg'] = $order->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;	    
}
$order->update_field('org_etd', $PHP_etd, $PHP_id); 

// 如何接下 做預計排產 ????????????????
// 如何接下 做預計排產 ????????????????
// 如何接下 做預計排產 ????????????????
// 計算出月份 排產資料 etp_su ------------
//  NOTE :++++++ 參數傳入 由html 送出 hidden 但要注意 format 有千位號的參數 要改參數名子[$PHP_qty]

$parm = array(
	"order_num"		=>	$PHP_order_num,
	"factory"		=>	$PHP_factory,
	"etp_su"		=>	$div         // 以csv存入 
);

//??????????????????????????????????????????????????????????????????????????? 考慮做個 search 要不會重覆
// 2005/11/20 改為 先判斷是否有該筆 pdtion 如果沒 則新增  如果有 就將原資料更新 ~~~~
		
if (!$pdt = $order->get_pdtion($PHP_order_num, $PHP_factory)){
	// ========= create PDTION 該筆 記錄 =======
	if (!$order->creat_pdtion($parm)) {
		$op['msg'] = $order->msg->get(2);
		$layout->assign($op);
		$layout->display($TPL_ERROR);  		    
		break;	    
	}
}else{

	// ========= 更新  PDTION 該筆 記錄 ==   [ 由 $pdt 找到 id ] =====
	if (!$order->revise_pdtion($parm,$pdt['id'])) { 
		$op['msg'] = $order->msg->get(2);
		$layout->assign($op);
		$layout->display($TPL_ERROR);  		    
		break;	    
	}
	
	//加schedule	
	$schedule->add_ord_schedule($PHP_order_num);	
	if($schedule->check_sch_finish($PHP_order_num))
	{
		$schedule->add_capacity($PHP_order_num);
		$message = "UPDATE order [ ".$PHP_order_num." ] production schedule [ETS, ETF] ";
		$log->log_add(0,"42A",$message);
	}
}

// ====要寫入 capacity - pre_schedule 且要 check 是否有該記錄 如沒 就是沒設定產能
# 記錄使用者動態
$message = "Approval order:[".$PHP_order_num."]";
$log->log_add(0,"103A",$message);

//當(開始的記錄筆號 +1 等於總筆數) 且 (總比數除以每頁數餘1)時 要減一頁
if(($PHP_sr_startno +1 == $max_rec) && ($max_rec %  $per_page == 1)){
	if ($PHP_sr_startno != 0 ){
		$PHP_sr_startno = $PHP_sr_startno - $per_page;
	}
}

echo $PHP_back_str = $PHP_back_str ."&PHP_sr_startno=".$PHP_sr_startno;
redirect_page($PHP_back_str);
break;



//=======================================================
# 沒有在用 ，遷移到 order.php
case "reject_order_rev":
exit;
if(!$admin->is_power('075',"add")){ 
	$op['msg'][] = "sorry! 您沒有這項權限!";
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}

// 修改 status 欄

$argv = array(	"id"		=>	$PHP_id,
				"apver"		=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
				"status"	=>	5
				);

$argv2 = array(	"order_num"	=>	$PHP_order_num,
				"user"		=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
				"des"		=>	"REV REJECT : for - ".$PHP_detail
				);

// ========= add to  order DB =======
if (!$order->reject_rev($argv)) {
	$op['msg'] = $order->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;	    
}

// ========= add to  order_log DB =======
if (!$order_log->add($argv2)) {
	$op['msg'] = $order_log->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;	    
}
			# 記錄使用者動態
$message = "Reject order approval:[$PHP_order_num]•";
$log->log_add(0,"103ARJ",$message);

//當(開始的記錄筆號 +1 等於總筆數) 且 (總比數除以每頁數餘1)時 要減一頁
if(($PHP_sr_startno +1 == $max_rec) && ($max_rec %  $per_page == 1)){
	if ($PHP_sr_startno != 0 ){
		$PHP_sr_startno = $PHP_sr_startno - $per_page;
	}
}

$PHP_back_str = $PHP_back_str ."&PHP_sr_startno=".$PHP_sr_startno;


redirect_page($PHP_back_str);

break;

#------------------------------------------------------------------------------------------------------------------------------------
		
		
		
		
		
		
		
		
		
		
		
		
	
//-------------------------------------------------------------------------------------
//			 job 103  訂 單 核 可  [  高階授權 的 job ]
//-------------------------------------------------------------------------------------
case "order_apv":
check_authority('067',"view");

$_SESSION['sch_parm']['IE2_sr_startno'] = !empty($_GET['IE2_sr_startno']) ? $_GET['IE2_sr_startno'] : '';
$_SESSION['sch_parm']['IE1_sr_startno'] = !empty($_GET['IE1_sr_startno']) ? $_GET['IE1_sr_startno'] : '';
$_SESSION['sch_parm']['PHP_action'] = !empty($_GET['PHP_action']) ? $_GET['PHP_action'] : '';

if (!$op = $order->unapv_search()) {
    $op['msg']= $order->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}

$tmp = $cost->search_uncfm_cost(3);
if (isset($tmp['max_no']))
{
    $op['cost'] = $tmp['cost'];
    $op['c_max_no'] = $tmp['max_no'];
    $op['c_maxpage']	=	$tmp['maxpage'];
    $op['c_pages']	=	$tmp['pages'];
    $op['c_now_pp']	=	$tmp['now_pp'];
    $op['c_lastpage']	=	$tmp['lastpage'];
}

$tmp = $cost->search_remun_check(3);
$op['rem'] = $tmp['rem'];
$op['r_max_no'] = $tmp['max_no'];
$op['r_maxpage']	=	$tmp['maxpage'];
$op['r_pages']	=	$tmp['pages'];
$op['r_now_pp']	=	$tmp['now_pp'];
$op['r_lastpage']	=	$tmp['lastpage'];

$tmp = $except->search_apv();
$op['exc'] = $tmp['exc'];
$op['e_max_no'] = $tmp['max_no'];
$op['e_maxpage']	=	$tmp['maxpage'];
$op['e_pages']	=	$tmp['pages'];
$op['e_now_pp']	=	$tmp['now_pp'];
$op['e_lastpage']	=	$tmp['lastpage'];
$dept_ary = array( 1	=>	'LY', 2	=>	'HJ', 4	=>	'RD', 8	=>	'PM' , 16	=>	'CF' );
for($i=0; $i<sizeof($op['exc']); $i++)
{				
    foreach($dept_ary as $key => $value)
    {
        if($op['exc'][$i]['oth_dept'] & $key)
        {						
            $op['exc'][$i][$value] = 1;
        }else{
            $op['exc'][$i][$value] = 0;
        }
    }
    if($op['exc'][$i]['dept'] <> 'KA' &&$op['exc'][$i]['dept'] <> 'KB')
    {
        if(substr($op['exc'][$i]['ord_num'],0,1) == 'A')$op['exc'][$i]['KA'] = 1;
        if(substr($op['exc'][$i]['ord_num'],0,1) == 'B')$op['exc'][$i]['KB'] = 1;
    }
}	

$tmp = $offer->search_un_apv();
$op['of'] = $tmp['of'];
$op['f_max_no'] = $tmp['max_no'];
$op['f_maxpage']	=	$tmp['maxpage'];
$op['f_pages']	=	$tmp['pages'];
$op['f_now_pp']	=	$tmp['now_pp'];
$op['f_lastpage']	=	$tmp['lastpage'];

$tmp = $debit->search_apv();
$op['dn'] = $tmp['dn'];
$op['d_max_no'] = $tmp['max_no'];
$op['d_maxpage']	=	$tmp['maxpage'];
$op['d_pages']	=	$tmp['pages'];
$op['d_now_pp']	=	$tmp['now_pp'];
$op['d_lastpage']	=	$tmp['lastpage'];
$dept_ary = array( 1	=>	'LY', 2	=>	'HJ', 4	=>	'RD', 8	=>	'PM', 16	=> 'KA', 32	=>	'KB' , 64	=>	'CF' );
for($i=0; $i<sizeof($op['dn']); $i++)
{				
    foreach($dept_ary as $key => $value)
    {
        if($op['dn'][$i]['oth_dept'] & $key)
        {						
            $op['dn'][$i][$value] = 1;
        }else{
            $op['dn'][$i][$value] = 0;
        }
    }
    
    if($op['dn'][$i]['chk_to'] == 0)
    {
        $tmp = $supl->get_fields('supl_s_name'," WHERE vndr_no='".$op['dn'][$i]['dn_to']."'");			
        $op['dn'][$i]['dn_to_name'] = $tmp[0];
    }else if($op['dn'][$i]['chk_to'] == 1){
        $tmp = $cust->get_fields('cust_init_name'," WHERE cust_s_name='".$op['dn'][$i]['dn_to']."'");
        $op['dn'][$i]['dn_to_name'] = $tmp[0];
    }else{
        $tmp = $dept->get_fields('dept_name'," WHERE dept_code='".$op['dn'][$i]['dn_to']."'");			
        $op['dn'][$i]['dn_to_name'] = $tmp[0];				
    }
}	

//IE未CFM
$tmp = $order->ie_uncfm_search(1);
$op['ord_ie'] = $tmp['ord_ie'];
$op['ie1_max_no'] = $tmp['max_no'];
$op['ie1_maxpage']	=	$tmp['maxpage'];
$op['ie1_pages']	=	$tmp['pages'];
$op['ie1_now_pp']	=	$tmp['now_pp'];
$op['ie1_lastpage']	=	$tmp['lastpage'];

//FINAL IE未CFM
$tmp = $order->ie_uncfm_search(2);
$op['ord_ie2'] = $tmp['ord_ie'];
$op['ie2_max_no'] = $tmp['max_no'];
$op['ie2_maxpage']	=	$tmp['maxpage'];
$op['ie2_pages']	=	$tmp['pages'];
$op['ie2_now_pp']	=	$tmp['now_pp'];
$op['ie2_lastpage']	=	$tmp['lastpage'];
for($i=0; $i<sizeof($op['ord_ie2']); $i++)
{
    if ($op['ord_ie2'][$i]['ie2'] == 0)	$op['ord_ie2'][$i]['final_check'] = $order->check_ftycm($op['ord_ie2'][$i]['order_num']);			
}		

$op['msg']= $order->msg->get(2);
$op['today']=date('Y-m-d');
if(isset($PHP_msg)) $op['msg'][] = $PHP_msg;
//080725message增加		
$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
$op['max_notify'] = $note['max_no'];

# 2013/07/11 將今天以後的訂單的 handling_fee 寫回 s_order 內(factory = LY 且 排除 L 開頭的訂單)
# 2013/07/11 由於 工繳 目前是手動挑選單訂，自行加入 handling_fee。改成 工繳 多一欄 將 handling_fee 納入計算(2013/07/11程式更新後所新建立的訂單才納入計算)
# 2013/07/11 今天以前的 handling_fee 欄位不填值，改用程式判斷2012/08/15之後將handling_fee設為0.25，目的是讓前台顯示(order list、order show、order cfm...等)正常
//重新計算 毛利率
$handling_row = $order->get_fields("set_value", " where set_name='handling_fee'","para_set");
foreach($op['sorder'] as $key=>$val){
    if($val['factory'] == 'LY' and $val['opendate'] >= '2013-07-11' and substr($val['order_num'],0,1) <> 'L'){
        $handling_fee = $val['handling_fee'];
    }elseif($val['factory'] == 'LY' and $val['opendate'] >= '2012-08-15' and substr($val['order_num'],0,1) <> 'L'){
        $handling_fee = $handling_row['0'];
    }else{
        $handling_fee = 0.00;
    }
    //計算 C.M. estimate
    if($val['ie2'] > 0){
        $fty_cm = $order->get_fields("set_value", " where set_name='".strtolower($val['factory'])."-cm'","para_set");
        $cm = $val['ie2'] * $fty_cm[0];
    }elseif($val['ie1'] > 0){
        $fty_cm = $order->get_fields("set_value", " where set_name='".strtolower($val['factory'])."-cm'","para_set");
        $cm = $val['ie1'] * $fty_cm[0];
    }else{
        $cm = $val['cm'];
    }
    
    // 計算  gm rate -----------------------------
    $unit_cost = ($val['mat_u_cost'] * $val['mat_useage']) + $val['interline'] + $val['fusible'] + $val['acc_u_cost'] + $val['quota_fee'] + $val['comm_fee'] + $cm + $val['emb'] + $val['wash'] + $val['oth'] + $handling_fee;
    $grand_cost = $unit_cost * $val['qty'] + $val['smpl_fee'];
    $sales = $val['uprice'] * $val['qty'];
    $gm = $sales - $grand_cost;
    
    if ($sales){
        $op['sorder'][$key]['gmr'] = ($gm / $sales) * 100;
    }else{
        $op['sorder'][$key]['gmr'] = 0;
    }
}

page_display($op,'067', $TPL_UNAPV_ORDER_LIST);				
break;



//=======================================================
	case "order_apv_view":
		check_authority('067',"view");
		$op['order'] = $order->get($PHP_id);  //取出該筆記錄
        $op['is_factory'] = is_dept($GLOBALS['SCACHE']['ADMIN']['dept']);
        $op['combine'] = $order->get_combine($op['order']['combine']);

		if (!$op['order']) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op = $order->orgainzation_ord($op);

		// 取出 order_log 本訂單 之歷史50筆的計記錄  ------
		$logs = $order_log->search50($op['order']['order_num']); 
		if (!$logs){
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['logs'] = $logs['order_log'];
		$op['log_records'] = $logs['records'];
		// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來叛斷有無資料
		//--------------------------------

		$parm = $op['order'];

		// 計算 lead time
		$op['lead_time'] = countDays ($parm['etp'],$parm['etd']);

		// 加入返回前頁 2005/05/05
		$op['back_str'] = $cgiget."&PHP_sr_startno=".$cgino."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5;

		$op['back_str2'] = $cgiget."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5;

		//傳送 參數入 確認訂單表中 再送出到確認後 或駁回後之計算用
		$op['max_rec'] = $max_rec;
		$op['per_page'] = $per_page;
		$op['PHP_sr_startno'] = $cgino;

		$op['msg'] = $order->msg->get(2);
		$op['search'] = '1';
		$op['check_etp']=$ord_submit_ETP_limit;
		$op['check_etd']=$ord_submit_ETD_limit;	
		$op['account_dept'] = $GLOBALS['SCACHE']['ADMIN']['dept'];
		page_display($op,'067', $TPL_ORDER_SHOW_APV);
		    	    
	break;

//=======================================================
	case "do_order_apv":
		check_authority('067',"add");

		if (!$PHP_stk_ord && ($ord_submit_ETP_limit > $PHP_etp || $ord_submit_ETD_limit > $PHP_etd || $PHP_QTY==0))
		{//當[ETP小於今日後7日],[ETD小於今日後14日],[Q'ty=0]維持原頁出現錯誤訊息
			$op['order'] = $order->get($PHP_id);  //取出該筆記錄

			if (!$op['order']) {
				$op['msg'] = $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			$op = $order->orgainzation_ord($op);
			// 取出 order_log 本訂單 之歷史50筆的計記錄  ------
			$logs = $order_log->search50($op['order']['order_num']); 
			if (!$logs){
				$op['msg'] = $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			$op['logs'] = $logs['order_log'];
			$op['log_records'] = $logs['records'];
			// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來叛斷有無資料
			//--------------------------------

			$parm = $op['order'];

			// 計算 lead time
			$op['lead_time'] = countDays ($parm['etp'],$parm['etd']);

			// 加入返回前頁 2005/05/05
			$op['back_str'] = $cgiget."&PHP_sr_startno=".$cgino."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5;

			$op['back_str2'] = $cgiget."&PHP_dept_code=".$cgi_1."&PHP_order_num=".$cgi_2."&PHP_cust=".$cgi_3."&PHP_ref=".$cgi_4."&PHP_factory=".$cgi_5;

			//傳送 參數入 確認訂單表中 再送出到確認後 或駁回後之計算用
			$op['max_rec'] = $max_rec;
			$op['per_page'] = $per_page;
			$op['PHP_sr_startno'] = $cgino;

			if ($PHP_QTY == 0)
			{	
				$op['msg'][] = "Sorry ! The Q\'ty  is unreasonable.<br>( Q\'ty must more than 0) <br>Please Reject this order to update it first。";
			}else{	
				$op['msg'][] = "Sorry ! The ETP or ETD date is unreasonable.<br>(ETP : before today at leaset. ETD : 20 days before today at least)<br>Please Reject this order to update it first";				
			}
			$op['search'] = '1';
			$op['check_etp']=$ord_submit_ETP_limit;
			$op['check_etd']=$ord_submit_ETD_limit;	
			page_display($op,'067', $TPL_ORDER_SHOW_APV);			
			break;
		}	
		
	// 寫入 capaci. pre-schedule ===  
	// 先檢查 capacity 檔內是否已經有記錄 ???
	$s_year = substr($PHP_etp,0,4);
	$e_year = substr($PHP_etd,0,4);
	for($i=$s_year;$i<$e_year+1;$i++){
		
		if (!$T=$capaci->get($PHP_factory, $i)) {
			$op['msg'] = $capaci->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			exit;
		}
	}
	//2007-05-17訂單未算IE,未有SU時以上衣*2下衣*1估算SU
	if ($PHP_su == 0)
	{
		if ($PHP_style=='PS' || $PHP_style=='BS' || $PHP_style=='BZ' || $PHP_style=='DR' || $PHP_style=='JK' || $PHP_style=='PS-J' || $PHP_style=='PS-P' || $PHP_style=='PS-S' || $PHP_style=='VS' || $PHP_style=='SS'){
			$PHP_su=2*$PHP_QTY;			
		}else{
			$PHP_su=1*$PHP_QTY;			
		}
	}			
	$f1=$order->update_field('su', $PHP_su, $PHP_id); //2007-05-17訂單存入估算SU
	
	// 寫入 capaci. pre-schedule ===  在 order->diver_month_su 內寫入
		//   2005/08/31 改由資料庫抓 su [以 ie 計算填入 ]
	$div = $order->distri_month_su($PHP_su,$PHP_etp,$PHP_etd,$PHP_factory,'pre_schedule');

		// 修改 status 欄  --------- s_order table -------------------------------
		$argv = array(	"id"			=>	$PHP_id,
						"apver"			=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
						"status"		=>	4
						);
		// ========= add to s_order APV 記錄 =======  ????????  是否寫入 要看有沒有 capacity 記錄
		if (!$order->do_apv($argv)) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}
		$order->update_field('org_etd', $PHP_etd, $PHP_id); 

		// 如何接下 做預計排產 ????????????????
		// 如何接下 做預計排產 ????????????????
		// 如何接下 做預計排產 ????????????????
		// 計算出月份 排產資料 etp_su ------------
		//  NOTE :++++++ 參數傳入 由html 送出 hidden 但要注意 format 有千位號的參數 要改參數名子[$PHP_qty]

		$parm = array(	"order_num"		=>	$PHP_order_num,
										"factory"			=>	$PHP_factory,
										"etp_su"			=>	$div         // 以csv存入 
						);

//??????????????????????????????????????????????????????????????????????????? 考慮做個 search 要不會重覆
		// 2005/11/20 改為 先判斷是否有該筆 pdtion 如果沒 則新增  如果有 就將原資料更新 ~~~~
				
		if (!$pdt = $order->get_pdtion($PHP_order_num, $PHP_factory)){

			// ========= create PDTION 該筆 記錄 =======
			if (!$order->creat_pdtion($parm)) {
				$op['msg'] = $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;	    
			}
		 
		}else{

			// ========= 更新  PDTION 該筆 記錄 ==   [ 由 $pdt 找到 id ] =====
			if (!$order->revise_pdtion($parm,$pdt['id'])) { 
				$op['msg'] = $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;	    
			}
//加schedule	
		$schedule->add_ord_schedule($PHP_order_num);	
		if($schedule->check_sch_finish($PHP_order_num))
 		{
 			$schedule->add_capacity($PHP_order_num);
			$message = "UPDATE order [ ".$PHP_order_num." ] production schedule [ETS, ETF] ";
			$log->log_add(0,"42A",$message);
 		}
		}

		// ====要寫入 capacity - pre_schedule 且要 check 是否有該記錄 如沒 就是沒設定產能

					# 記錄使用者動態
		$message = "Approval order:[".$PHP_order_num."]";
		$log->log_add(0,"103A",$message);

		//當(開始的記錄筆號 +1 等於總筆數) 且 (總比數除以每頁數餘1)時 要減一頁
		if(($PHP_sr_startno +1 == $max_rec) && ($max_rec %  $per_page == 1)){
			if ($PHP_sr_startno != 0 ){
				$PHP_sr_startno = $PHP_sr_startno - $per_page;
			}
		}

		$PHP_back_str = $PHP_back_str ."&PHP_sr_startno=".$PHP_sr_startno;


		redirect_page($PHP_back_str);

		break;

//=======================================================
	case "reject_order_apv":

		if(!$admin->is_power('067',"add")){ 
			$op['msg'][] = "sorry! 您沒有這項權限!";
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		// 修改 status 欄

		$argv = array(	"id"		=>	$PHP_id,
						"apver"		=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
						"status"	=>	5
						);

		$argv2 = array(	"order_num"	=>	$PHP_order_num,
						"user"		=>	$GLOBALS['SCACHE']['ADMIN']['login_id'],
						"des"		=>	"APV REJECT : for - ".$PHP_detail
						);

		// ========= add to  order DB =======
		if (!$order->reject_apv($argv)) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}

		// ========= add to  order_log DB =======
		if (!$order_log->add($argv2)) {
			$op['msg'] = $order_log->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}
					# 記錄使用者動態
		$message = "Reject order approval:[$PHP_order_num]•";
		$log->log_add(0,"103ARJ",$message);

		//當(開始的記錄筆號 +1 等於總筆數) 且 (總比數除以每頁數餘1)時 要減一頁
		if(($PHP_sr_startno +1 == $max_rec) && ($max_rec %  $per_page == 1)){
			if ($PHP_sr_startno != 0 ){
				$PHP_sr_startno = $PHP_sr_startno - $per_page;
			}
		}

		$PHP_back_str = $PHP_back_str ."&PHP_sr_startno=".$PHP_sr_startno;


		redirect_page($PHP_back_str);

		break;




	
//=======================================================
	case "revise_order_view":

		check_authority('065',"view");
		
		$op['order'] = $r_order->get($PHP_id);  //取出該筆記錄
		if (!$op['order']) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}


		$parm = $op['order'];

		// 計算 lead time
		$op['lead_time'] = countDays ($parm['etp'],$parm['etd']);

			// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/picture/".$op['order']['order_num'].".jpg")){
			$op['main_pic'] = "./picture/".$op['order']['order_num'].".jpg";
		} else {
			$op['main_pic'] = "./images/graydot.gif";
		}

//-------------// 計算  SU 供 html -------------------------------------------------------------------------
		$su = $op['order']['su'];   
		$op['order']['f_su'] = number_format($su, 0, '', ',');

			// 計算  gm rate -----------------------------
		$unit_cost = ($parm['mat_u_cost']* $parm['mat_useage'])+ $parm['interline']+ $parm['fusible']+ $parm['acc_u_cost'] + $parm['quota_fee'] + $parm['comm_fee'] + $parm['cm'] + $parm['emb'] + $parm['wash'] + $parm['oth'];
		$grand_cost = $unit_cost*$parm['qty'] + $parm['smpl_fee'];
		$sales = $parm['uprice']*$parm['qty'];
		$gm = $sales - $grand_cost;
			if ($sales){
				$rate = ($gm/ $sales)*100;
			}
		$parm['gmr'] = number_format($rate, 2, '.', ',');

			// 計算 網頁參數 -------- 成本分析部份 ------------
			$op['order']['sales'] = number_format($sales, 2, '.', ',');
			$op['order']['unit_cost'] = number_format($unit_cost, 2, '.', ',');
			$op['order']['grand_cost'] = number_format($grand_cost, 2, '.', ',');
			$op['order']['gm'] = number_format($gm, 2, '.', ',');
			$op['order']['gm_rate'] = number_format($rate, 2, '.', ',');
			$op['order']['qty'] = number_format($op['order']['qty'], 0, '', ',');
		$op['search'] = '1';
		$op['msg'] = $order->msg->get(2);


		page_display($op,'065', $TPL_ORDER_REVISE_SHOW);
	break;



//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//			 job 101S   
//    case "shift_order":		轉換訂單 承製工廠	shift order
//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    case "shift_order":

		check_authority('065',"edit");
		//-------------取出該筆記錄
		$op['order'] = $order->get(0,$PHP_ord_num);  
		if (!$op['order']) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		//-------------creat FACTORY combo box
		$op['factory'] = $arry2->select($FACTORY,$op['order']['factory'],'PHP_fty_new','select','');  	

			// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/picture/".$op['order']['order_num'].".jpg")){
			$op['main_pic'] = "./picture/".$op['order']['order_num'].".jpg";
		} else {
			$op['main_pic'] = "./images/graydot.gif";
		}

			$op['msg'] = $order->msg->get(2);
			if ($op['msg']){ $op['msg_YES'] = 1; } else { $op['msg_YES'] = "" ;}

		$op['search'] = '1'; 
		page_display($op,'065', $TPL_ORDER_SHIFT);
		break;


//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//			 job 101S2   do SHIFT order   執行訂單轉移承製工廠
//    case "do_order_shift":
//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "do_order_shift":
		check_authority('065',"edit");
		//---------取出該筆 S_order記錄
		$ord = $order->get($PHP_id,'');
		
		if (!$ord) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

//-------取出該筆 pdtioin 記錄
			$pdt = $order->get_pdtion($ord['order_num'], $PHP_fty_org);  

		if (!isset($pdt['id']))$pdt['id']="";

	if($ord['status'] == 7){  //排產後 且排產確認

		//將原工廠的 工廠排產量 自capacity中減除
		$test = $order->distri_month_su($ord['su'],$pdt['ets'],$pdt['etf'],$ord['factory'],'schedule',1);
		if (!$test) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}
		//將原工廠的 業務排產量 自capacity中減除
		$test = $order->distri_month_su($ord['su'],$ord['etp'],$ord['etd'],$ord['factory'],'pre_schedule',1);
		if (!$test) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}
		//加入新工廠的 業務排產量 於capacity
		$test = $order->distri_month_su($ord['su'],$ord['etp'],$ord['etd'],$PHP_fty_new,'pre_schedule');
		if (!$test) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}
		//更新 s_order 內容
		$argv = array(	'id'		=>	$PHP_id,
						'schd_er'	=>	'',
						'schd_date' =>	'0000-00-00',
						'factory'	=>	$PHP_fty_new,
						'status'	=>	4,
						"last_updator"	=>	$GLOBALS['SCACHE']['ADMIN']['login_id']
		);
		//更新 pdtion 內容
		$parm = array(	'id'		=>	$pdt['id'],
						'ets'		=>	'0000-00-00',
						'etf'		=>	'0000-00-00',
						'factory'	=>	$PHP_fty_new,
						'fty_su'	=>	'',
		);

	}elseif($ord['status'] == 6){ //排產後 尚未排產確認
		//將原工廠的 業務排產量 自capacity中減除
		$test = $order->distri_month_su($ord['su'],$ord['etp'],$ord['etd'],$ord['factory'],'pre_schedule',1);
		if (!$test) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}
		//加入新工廠的 業務排產量 於capacity
		$test = $order->distri_month_su($ord['su'],$ord['etp'],$ord['etd'],$PHP_fty_new,'pre_schedule');
		if (!$test) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}
		//更新 s_order 內容
		$argv = array(	'id'		=>	$PHP_id,
						'schd_er'	=>	'',
						'schd_date' =>	'0000-00-00',
						'factory'	=>	$PHP_fty_new,
						'status'	=>	4,
						"last_updator"	=>	$GLOBALS['SCACHE']['ADMIN']['login_id']
		);
		//更新 pdtion 內容
		$parm = array(	'id'		=>	$pdt['id'],
						'ets'		=>	'0000-00-00',
						'etf'		=>	'0000-00-00',
						'factory'	=>	$PHP_fty_new,
						'fty_su'	=>	'',
		);
	
	}elseif($ord['status'] == 4){ //訂單 apv
		
		//將原工廠的 業務排產量 自capacity中減除
		$test = $order->distri_month_su($ord['su'],$ord['etp'],$ord['etd'],$ord['factory'],'pre_schedule',1);
		if (!$test) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}
		//加入新工廠的 業務排產量 於capacity
		$test = $order->distri_month_su($ord['su'],$ord['etp'],$ord['etd'],$PHP_fty_new,'pre_schedule');
		if (!$test) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}
		//更新 s_order 內容
		$argv = array(	'id'		=>	$PHP_id,
						'schd_er'	=>	'',
						'schd_date' =>	'0000-00-00',
						'factory'	=>	$PHP_fty_new,
						'status'	=>	$ord['status'],
						"last_updator"	=>	$GLOBALS['SCACHE']['ADMIN']['login_id']
		);
		//更新 pdtion 內容
		$parm = array(	'id'		=>	$pdt['id'],
						'ets'		=>	'0000-00-00',
						'etf'		=>	'0000-00-00',
						'factory'	=>	$PHP_fty_new,
						'fty_su'	=>	'',
		);

	}

	if($ord['status'] < 4){   // status = 2,3

		//更新 s_order 內容
		$argv = array(	'id'		=>	$PHP_id,
						'schd_er'	=>	'',
						'schd_date' =>	'0000-00-00',
						'factory'	=>	$PHP_fty_new,
						'status'	=>	$ord['status'],
						"last_updator"	=>	$GLOBALS['SCACHE']['ADMIN']['login_id']
		);
		//更新 pdtion 內容
		$parm = array(	'id'		=>	$pdt['id'],
						'ets'		=>	'0000-00-00',
						'etf'		=>	'0000-00-00',
						'factory'	=>	$PHP_fty_new,
						'fty_su'	=>	'',
		);

	}
		//執行更新 資料庫單 table 
		if(!$ord_id = $order->shift($argv, $parm)){  
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}

					# 記錄使用者動態
		$message = "SHIFT order#:$PHP_order_num from [".$PHP_fty_org."] to [".$PHP_fty_new."]";
		$log->log_add(0,"101R",$message);

//--------------------------------------------	
	// ---- 寫入 log檔 [加入紅色 且 link到原來的 r_order 記錄] ----
		$argv2['order_num']	= $PHP_ord_num;
		$argv2['user']		= $GLOBALS['SCACHE']['ADMIN']['login_id'];
		$argv2['des']	= "SHIFT from [ <b>".$PHP_fty_org."</b> ] to [ <b>".$PHP_fty_new."</b> ]";

		// ========= add to  order_log DB =======
		if (!$order_log->add($argv2)) {
			$op['msg'] = $order_log->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;	    
		}
//-----------------------------------------

		$op['order'] = $order->get($ord_id);  //取出該筆記錄

		if (!$op['order']) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}

		// 取出 order_log 本訂單 之歷史50筆的計記錄  -------------------
		$logs = $order_log->search50($op['order']['order_num']);  //取出該訂單全部log記錄
		if (!$logs){
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['logs'] = $logs['order_log'];
		$op['log_records'] = $logs['records'];
			// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來判斷有無資料
		//--------------------------------

		$parm = $op['order'];

		// 計算 lead time
		$op['lead_time'] = countDays ($parm['etp'],$parm['etd']);


			// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/picture/".$op['order']['order_num'].".jpg")){
			$op['main_pic'] = "./picture/".$op['order']['order_num'].".jpg";
		} else {
			$op['main_pic'] = "./images/graydot.gif";
		}

//-----------// 計算  SU 供 html -------------------------------------------------------------
		//   2005/08/31 改由資料庫抓 su [以 ie 計算填入 ]
		$su = $op['order']['su'];   
		$op['order']['f_su'] = number_format($su, 0, '', ',');

			// 計算  gm rate -----------------------------
		$unit_cost = ($parm['mat_u_cost']* $parm['mat_useage'])+ $parm['interline']+ $parm['fusible']+ $parm['acc_u_cost'] + $parm['quota_fee'] + $parm['comm_fee'] + $parm['cm'] + $parm['emb'] + $parm['wash'] + $parm['oth'];
		$grand_cost = $unit_cost*$parm['qty'] + $parm['smpl_fee'];
		$sales = $parm['uprice']*$parm['qty'];
		$gm = $sales - $grand_cost;
			if ($sales){
				$rate = ($gm/ $sales)*100;
			}else{
				$rate = 0;
			}
		$parm['gmr'] = number_format($rate, 2, '.', ',');

			// 計算 網頁參數 -------- 成本分析部份 ------------
			$op['order']['sales'] = number_format($sales, 2, '.', ',');
			$op['order']['unit_cost'] = number_format($unit_cost, 2, '.', ',');
			$op['order']['grand_cost'] = number_format($grand_cost, 2, '.', ',');
			$op['order']['gm'] = number_format($gm, 2, '.', ',');
			$op['order']['gm_rate'] = number_format($rate, 2, '.', ',');
			$op['order']['qty'] = number_format($op['order']['qty'], 0, '', ',');

		$op['msg'][] = $message;
		
		# 2013/07/11 將 2013/07/11 以後的訂單 用程式判斷是否加入 handling_fee
		if($PHP_fty_new=='LY' and $ord['opendate'] >= '2013-07-11' and substr($ord['order_num'],0,1) <> 'L'){
			$handling_row = $order->get_fields("set_value", " where set_name='handling_fee'","para_set");
			$order->update_field("handling_fee", $handling_row[0], $ord['id']);
		}
			
		
		page_display($op, '065', $TPL_SHIFT_SHOW);   	    
	break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		case  "order_fa":	建立訂單的主副料資料 2007.03.03 
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//=======================================================
    case "order_fa":
    	check_authority("018","view");
    	$where_str='';
    	$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
    	$team = $GLOBALS['SCACHE']['ADMIN']['team_id'];
		$op['msg'] = $order->msg->get(2);		
		// creat cust combo box
		if ($user_dept =='HJ' || $user_dept =='LY' || $user_dept =='CF')
		{			
			if($user_dept=="HJ") $fty = array($user_dept,'MA');
			if($user_dept=="LY") $fty = array($user_dept);
			$op['factory'] = $arry2->select($fty,'','PHP_factory','select','');
			//$op['fac_flag'] =1;
		}else{
			$op['factory'] = $arry2->select($FACTORY,'','PHP_factory','select',''); 
            $sales_dept = get_sales_dept(); // 取出 業務的部門 [不含K0] ------
			$op['dept_select'] = $arry2->select($sales_dept,"","PHP_dept","select","");
		}
		
		$where_str=$where_str."   order by cust_s_name"; //依cust_s_name排序
		$cust_def = $cust->get_fields('cust_init_name',$where_str);
		$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
		for ($i=0; $i< sizeof($cust_def); $i++)
		{
			$cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
		}
		$op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue); 

//080725message增加		
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];

		page_display($op, "018", $TPL_ORDER_FA);		    	    
		break;

//=======================================================
    case "order_fa_search":
		check_authority("018","view");
		$where_dept='';
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
		$team = $GLOBALS['SCACHE']['ADMIN']['team_id'];
			// 訂單資料列表


		if(isset($PHP_order_num))
		{
			
			$sch_parm = array();
			$sch_parm = array(	
												"PHP_order_num"		=>  $PHP_order_num,
												"PHP_dept"			=>	$PHP_dept,
												"PHP_cust"			=>	$PHP_cust,
												"PHP_ref"			=>	$PHP_ref,
												"PHP_factory"		=>	$PHP_factory,
												"PHP_etdstr"		=>	$PHP_etdstr,
												"PHP_etdfsh"		=>  $PHP_etdfsh,
												"PHP_sr_startno"	=>	$PHP_sr_startno,
												"PHP_action"		=>	$PHP_action
				);
			}else{
				if(isset($PHP_sr_startno))$sch_parm['PHP_sr_startno'] = $PHP_sr_startno;
			}


		
	//			$op['cgi']= $parm;	
		// if($team=='MD') $where_dept=$user_dept;	
			if (!$op = $order->search(1,$where_dept)) {   // 僅取出 s_order tabel內的 資料 不抓pdtion
				$op['msg']= $order->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
//			$op['cgi']= $parm;
			$op['msg'] = $order->msg->get(2);
			if(isset($PHP_msg)) $op['msg'][] = $PHP_msg;
			page_display($op, "018", $TPL_ORDER_FA_LIST); 
		break;
//=======================================================

	case "order_fa_view":
		check_authority("018","view");
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
		$op['account_dept'] = $user_dept ;
		$op['is_factory'] = is_dept($GLOBALS['SCACHE']['ADMIN']['dept']);
		$op['order'] = $order->get($PHP_id);  //取出該筆記錄
		if (!$op['order']) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$size_data=$size_des->get($op['order']['size']);		
		$op['order']['size']=$size_data['size_scale'];
		if (substr($user_dept,0,1)=="H" || substr($user_dept,0,1)=="L")
		{
			if ($user_dept == $op['order']['dept'])$op['dept_edit']=1;
			if ($user_dept =="H0" && substr($op['order']['dept'],0,1)=="H")$op['dept_edit']=1;
			if ($user_dept =="L0" && substr($op['order']['dept'],0,1)=="L")$op['dept_edit']=1;
		}else{
			$op['dept_edit']=1;
		}
		$where_str="where smpl_code='".$PHP_ord_num."'";
		$op['fab'] = $smpl_lots->search(0,$where_str);  //取出該筆主料記錄			
		if (!isset($op['fab'][0])) {
			$op['fab']['msg']="No  Fabric record";
		}
		
		$op['acc'] = $smpl_acc->search(0,$where_str);  //取出該筆副料記錄		
		if (!isset($op['acc'][0])) {
			$op['acc']['msg']="No Accessory record";
		}
		
		// 取出 order_log 本訂單 之歷史50筆的計記錄  -------------------
		$logs = $order_log->search50($op['order']['order_num']);  //取出該訂單全部log記錄
		if (!$logs){
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['logs'] = $logs['order_log'];
		$op['log_records'] = $logs['records'];
			// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來判斷有無資料
		//--------------------------------

		$parm = $op['order'];

		// 計算 lead time
		$op['lead_time'] = countDays ($parm['etp'],$parm['etd']);

			// 檢查 相片是否存在
		if(file_exists($GLOBALS['config']['root_dir']."/picture/".$op['order']['order_num'].".jpg")){
			$op['main_pic'] = "./picture/".$op['order']['order_num'].".jpg";
		} else {
			$op['main_pic'] = "./images/graydot.gif";
		}

//-----------// 計算  SU 供 html -------------------------------------------------------------
		$su = $op['order']['su'];   
		$op['order']['f_su'] = number_format($su, 0, '', ',');

		$op['msg'] = $order->msg->get(2);		
		$op['search'] = '1';
page_display($op, "018", $TPL_ORDER_FA_SHOW);		    	    
break;



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "order_fa_edit":	
check_authority("018","edit");

$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];	
$op['order'] = $order->get($PHP_id);
if (!$op['order']) {
	$op['msg'] = $order->msg->get(2);
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}
//size由scale變成id的儲存
$size_data=$size_des->get($op['order']['size']);
$op['order']['size_id']=$op['order']['size'];		
$op['order']['size']=$size_data['size_scale'];		
//檢視是否可以修改size(即是否存在colorway)
if ($wi->check_size($op['order']['order_num']))
{
	$op['size_edit']=1;
}

// 計算 lead time 供 html 呈現 ------
if($op['order']['etp'] && $op['order']['etd']){	$op['lead_time'] = countDays($op['order']['etp'],$op['order']['etd']);	}

$where_str="where smpl_code='".$op['order']['order_num']."'";
$op['fab'] = $smpl_lots->search(0,$where_str);  //取出該筆主料記錄	
// print_r($op['fab']);
if (!isset($op['fab'][0])) {
	$op['fab']['msg']="No  Fabric record";
}else{
	for ($i=0; $i<sizeof($op['fab']); $i++)
	{
		$op['fab'][$i]['unit_select'] = $arry2->select($LOTS_PRICE_UNIT,$op['fab'][$i]['unit'],'PHP_unit','select','');
		$op['fab'][$i]['support'] = $arry2->select($MAT_SUPPORT,$op['fab'][$i]['support'],'PHP_support','select','',$MAT_SUPPORT_KEY);	
		// $op['fab'][$i]['po'] = $smpl_lots->check_po($op['fab'][$i]['id']);
		$op['fab'][$i]['po'] += $po->check_po_in($op['fab'][$i]['id'],'l');
		
		$use_for = explode(":",$op['fab'][$i]['use_for']);
		if(!isset($use_for[1])) $use_for[1] = '';				
		$op['fab'][$i]['use_for'] = $use_for[1];
		$op['fab'][$i]['fab_type']	= $arry2->select($FAB_TYPE,$use_for[0],'PHP_fab_type','select','');
		$op['fab'][$i]['fab_type_v'] = $use_for[0];
	}
}

$op['acc'] = $smpl_acc->search(0,$where_str);  //取出該筆副料記錄		
if (!isset($op['acc'][0])) {
	$op['acc']['msg']="No Accessory record";
}else{
	for ($i=0; $i<sizeof($op['acc']); $i++)
	{
		$op['acc'][$i]['unit_select'] = $arry2->select($ACC_PRICE_UNIT,$op['acc'][$i]['unit'],'PHP_unit','select','');
		$op['acc'][$i]['support'] = $arry2->select($MAT_SUPPORT,$op['acc'][$i]['support'],'PHP_support','select','',$MAT_SUPPORT_KEY);	
		// $op['acc'][$i]['po'] = $smpl_acc->check_po($op['acc'][$i]['id']);
		$op['acc'][$i]['po'] += $po->check_po_in($op['acc'][$i]['id'],'a');

	}
}

$op['msg'] = $order->msg->get(2);

//*****//2007.03.02 在order中加入size之下拉式 start
$where_str =" WHERE dept ='".$op['order']['dept']."' and cust='".$op['order']['cust']."' ";
$size_def = $size_des->get_fields('size_scale',$where_str);   // 取出 尺吋
if (!isset($size_def[0]))$size_def[0]="";
$op['size_select'] =  $arry2->select($size_def,$op['order']['size'],'PHP_size','select','');
$op['use_select']	=	$arry2->select($USAGE_METHOD,'','PHP_use_method','select','');
$op['fab_unit']	=	$arry2->select($LOTS_PRICE_UNIT,'','PHP_unit','select','');
$op['acc_unit']	=	$arry2->select($ACC_PRICE_UNIT,'','PHP_unit','select','');
$op['support']  = $arry2->select($MAT_SUPPORT,'','PHP_support','select','',$MAT_SUPPORT_KEY);	
$op['fab_type']	= $arry2->select($FAB_TYPE,'','PHP_fab_type','select','');	
//*****//2007.03.02 在order中加入size之下拉式 end


$op['search'] = '1';

if (isset($PHP_msg))	$op['msg'][]=$PHP_msg;	//別頁導入之message

		// 加入返回前頁 2005/05/05

page_display($op, "018", $TPL_ORDER_FA_EDIT);		
break;



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "do_order_fa_update":	
check_authority("018","edit");

$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];
if(strstr($PHP_use_for,'&#'))	$PHP_use_for = $ch_cov->check_cov($PHP_use_for);
$wi_status = $order->get_field_value('m_status','',$PHP_ord_num,'s_order');

if (!$PHP_unit) $PHP_unit=$PHP_old_unit;

if ($PHP_item=='fab')
{
	$parm=array($PHP_item_id,'color',$PHP_color);
	$smpl_lots->update_field($parm);
	
	$parm=array($PHP_item_id,'unit',$PHP_unit);
	$smpl_lots->update_field($parm);
	
	if($PHP_use_for) $PHP_fab_type =$PHP_fab_type.":".$PHP_use_for;
	$parm=array($PHP_item_id,'use_for',$PHP_fab_type);
	$smpl_lots->update_field($parm);
	
	$parm=array($PHP_item_id,'support',$PHP_support);
	$smpl_lots->update_field($parm);
	
	if($wi_status > 1)
	{
		$order->add_non_rcvd('l',$PHP_ord_num); //當沒有主料時rcvd為9999-99-99
		$rcvd_date = $order->get_field_value('mat_shp','',$PHP_ord_num,'pdtion');
		if(!$rcvd_date || $rcvd_date == '0000-00-00')
		{
			$ord_num[0]  = $PHP_ord_num;
			$receive->add_ord_rcvd('','','l',$ord_num);
		}
	}

}

if ($PHP_item=='acc')
{
	$parm=array($PHP_item_id,'color',$PHP_color);
	$smpl_acc->update_field($parm);

	$parm=array($PHP_item_id,'unit',$PHP_unit);
	$smpl_acc->update_field($parm);
	
	$parm=array($PHP_item_id,'use_for',$PHP_use_for);
	$smpl_acc->update_field($parm);
	
	if (!isset($PHP_main))$PHP_main=0;
	$parm=array($PHP_item_id,'acc_cat',$PHP_main);
	$smpl_acc->update_field($parm);

	$parm=array($PHP_item_id,'support',$PHP_support);
	$smpl_acc->update_field($parm);

	if($wi_status > 1)
	{
		$order->add_non_rcvd('a',$PHP_ord_num,3); //當沒有副料時rcvd為9999-99-99
		$ord_num[0]  = $PHP_ord_num;
		$rcvd_date = $order->get_field_value('m_acc_shp','',$PHP_ord_num,'pdtion');
		if(!$rcvd_date || $rcvd_date == '0000-00-00') $receive->add_ord_rcvd('','','a',$ord_num,2);

		$rcvd_date = $order->get_field_value('acc_shp','',$PHP_ord_num,'pdtion');
		if(!$rcvd_date || $rcvd_date == '0000-00-00') $receive->add_ord_rcvd('','','a',$ord_num,1);
	}
					
}

$op['order'] = $order->get($PHP_id);  //取出該筆記錄
$message="success update sample order:".$op['order']['order_num'].$PHP_item.":".$PHP_item_name;
$op['msg'][]=$message;
$log->log_add(0,"32A",$message);

$redir_str = "index2.php?PHP_action=order_fa_edit&PHP_id=".$PHP_id.$PHP_back_str."&PHP_msg=".$message."&cgino=".$cgino;
redirect_page($redir_str);



#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "show_fabric_search":
	
		page_display($op, "018", $TPL_LOT_S_LIST);		
		break;
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "do_get_lot":
 
//		check_authority(10,5,"edit");
		$cgi=array( 'lots_code'	=>	$SCH_lots_code,
								'lots_name'	=>	$SCH_lots_name,
								'comp'		=>	$SCH_comp
					
		);
		if (!$op = $lots->search(1)) {
			$op['msg']= $lots->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		if ($GLOBALS['SCACHE']['ADMIN']['id'] == "SA" ) {   // 如果是 manager 進入時...
			$op['manager_flag'] = 1;
		}
		$op['msg'] = $lots->msg->get(2);
		$op['cgi']=$cgi;
			page_display($op, "018", $TPL_LOT_S_LIST);		    	    
		break;
		
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "show_accessory_search":
//		check_authority(10,5,"edit");
		$op['acc_name'] = $arry2->select($ACC,'','PHP_acc_name','select','');
		page_display($op, "018", $TPL_ACC_S_LIST);		
		break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "do_get_acc": 
//		check_authority(10,5,"edit");
		$cgi=array( 'acc_code'	=>	$PHP_acc_code,
					'acc_name'	=>	$PHP_acc_name,
					'acc_des'	=>	$PHP_des					
		);
		if (!$op = $acc->search(1)) {
			$op['msg']= $lots->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		if ($GLOBALS['SCACHE']['ADMIN']['id'] == "SA" ) {   // 如果是 manager 進入時...
			$op['manager_flag'] = 1;
		}
		$op['acc_name'] = $arry2->select($ACC,$PHP_acc_name,'PHP_acc_name','select','');
		$op['msg'] = $acc->msg->get(2);
		$op['cgi']=$cgi;
		page_display($op, "018", $TPL_ACC_S_LIST);		    	    
		break;
		
//=======================================================
case "do_order_fa_edit":

check_authority("018","edit");

if(strstr($PHP_use_for,'&#'))	$PHP_use_for = $ch_cov->check_cov($PHP_use_for);
$wi_status = $order->get_field_value('m_status','',$PHP_smpl_code,'s_order');

$user_name = $GLOBALS['SCACHE']['ADMIN']['name'];   // 判定進入身份的指標
$date = date('Y-m-d');
if (!isset($PHP_main)) $PHP_main=0;
if (!isset($PHP_fab_type)) $PHP_fab_type = '';

$parm = array(
	"name"				=>	$PHP_name,
	"num"				=>	$PHP_num,
	"smpl_code"			=>	$PHP_smpl_code,
	"unit"				=>	$PHP_unit,
	"use_for"			=>	$PHP_use_for,
	"user"				=>	$user_name,
	"color"				=>	$PHP_color,
	"acc_cat"			=>	$PHP_main,
	"select"			=> 	1,
	"add_date"			=>	$date,
	"support"			=>	$PHP_support,
	"fab_type"			=>	$PHP_fab_type,
);
if ($PHP_name = 'hook' && isset($bar)) $parm['name'] = "hook&bar";
	
if ($PHP_item=='fab')	$f1 = $smpl_lots->add($parm);
if ($PHP_item=='acc')	$f1 = $smpl_acc->add($parm);
if($PHP_item=='fab')
{
	if($wi_status > 1) $order->add_non_rcvd('l',$PHP_smpl_code); //當沒有主料時rcvd為1111-11-11			
}else{
	if($wi_status > 1) $order->add_non_rcvd('a',$PHP_smpl_code,3); //當沒有主料時rcvd為1111-11-11			

}

if ($f1)
{
	$op['acc_unit']	=	$arry2->select($ACC_PRICE_UNIT,'','PHP_unit','select','');
	$op['acc_name'] = $arry2->select($ACC,'','PHP_name','select','');
	$op['fab_unit']	=	$arry2->select($LOTS_PRICE_UNIT,'','PHP_unit','select','');
	$op['support']  = $arry2->select($MAT_SUPPORT,'','PHP_support','select','',$MAT_SUPPORT_KEY);
	if ($PHP_item=='fab')	$message= "Sueess add fabric:".$parm['num']."on order:".$parm['smpl_code'];
	if ($PHP_item=='acc')	$message= "Sueess add accessory:".$parm['num']."on order:".$parm['smpl_code'];
	# 記錄使用者動態
	$log->log_add(0,"32A",$message);
}else{
	if ($PHP_item=='fab')	$msg=$smpl_lots->msg->get(2);
	if ($PHP_item=='acc')	$msg=$smpl_acc->msg->get(2);
	$message=$msg[0];
}

 if(!isset($PHP_back_str))
{
	$PHP_back_str ='';
	
}


$redir_str = "index2.php?PHP_action=order_fa_edit&PHP_id=".$PHP_id.$PHP_back_str."&PHP_msg=".$message;
redirect_page($redir_str);	

//=======================================================			
    case "order_fab_del_ajx":		
		check_authority("018","edit");
		if ($PHP_item=='fab')	$f1 = $smpl_lots->del($PHP_lots_id);
		if ($PHP_item=='acc')	$f1	= $smpl_acc->del($PHP_lots_id);
		
		if ($f1)
		{
			if ($PHP_item=='fab')	$message= "Sueess del fabric:".$PHP_lots_code."on order:".$PHP_order;
			if ($PHP_item=='acc')	$message= "Sueess del accessory:".$PHP_lots_code."on order:".$PHP_order;
					# 記錄使用者動態
			$log->log_add(0,"32A",$message);
		}else{
			if ($PHP_item=='fab')	$msg=$smpl_lots->msg->get(2);
			if ($PHP_item=='acc')	$msg=$smpl_acc->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		echo $message;
		exit;
		break;

//xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

	case "do_order_fa_edit_ajx":
		check_authority("018","edit");		
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
		$op['order'] = $order->get($PHP_id);  //取出該筆記錄
		$size_id=$PHP_size_id;
		if ($PHP_size_id==0)
		{
			$PHP_size_item = strtoupper($PHP_size_item);
			$PHP_size = strtoupper($PHP_size);		
			$PHP_base_size = strtoupper($PHP_base_size);
			$parm=array(	'cust'			=>	$op['order']['cust'],
							'dept'			=>	$op['order']['dept'],
							'size'			=>	$PHP_size_item,
							'size_scale'	=>	$PHP_size,
							'base_size'		=>	$PHP_base_size,
							'check'			=>	1,
			);
			$size_id=$size_des->add($parm);
		}
		
		$f1 = $order->update_field('size', $size_id, $PHP_id); 
		
		if ($f1)
		{
			$message= "Sueess edit Order for FAB/ACC:".$op['order']['order_num'];
					# 記錄使用者動態
			$log->log_add(0,"32A",$message);
		}else{
			$msg[] = $order->msg->get(2);
			$message= $msg[0];
		}
		$return_vaule=$PHP_size.'|'.$message;
		echo $return_vaule;	    	    
		exit;
		break;
//==============================================
case "show_size_add":

	page_display($op, "053", $TPL_SMPL_SIZE_ADD);	

	break;


//====================================================
case "out_search":
	check_authority('072',"view");
				// creat cust combo box
		$login_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];
		//$op['dept']=$arry2->select(get_sales_dept(),'','PHP_dept','select','');
		//print_r($op);
		//exit();
		$op['factory'] = $arry2->select($FACTORY,'','PHP_factory','select','');
		$op['dept']=$arry2->select(get_sales_dept(),'','PHP_dept','select','');		
		$op['sample'] = $arry2->select($SAMPLER,'','PHP_sample','select','');
		$op['smpl_fty'] = $arry2->select($SAMPLER,'','PHP_smpl_fty','select',''); 	
		$op['year_1'] = $arry2->select($YEAR_WORK,date('Y'),'PHP_year1','select','');  	
		$op['month_1'] = $arry2->select($MONTH_WORK,'','PHP_month1','select','');  	
		if ($login_dept == "SA"){
			$op['flag'] = 1;
		}

    // order_lay.php 增加 2009/12/09
		$where_str="order by cust_s_name"; //依cust_s_name排序
		$cust_def = $cust->get_fields('cust_init_name',$where_str);  //取出客戶簡稱
		$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
		for ($i=0; $i< sizeof($cust_def); $i++) $cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
		$op['cust'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue); 
//080725message增加		
	$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
	$op['max_notify'] = $note['max_no'];
	if(isset($PHP_msg))$op['msg'][] = $PHP_msg;

		$user_team = $GLOBALS['SCACHE']['ADMIN']['team_id'];   // 判定進入身份的指標(部門)
//		if($user_team == 'TU') $op['non_cost'] = 1;


	page_display($op,'072', $TPL_OUT_SEARCH);
	break;	
//====================================================
case "out_list":
	check_authority('072',"view");
	if (!$PHP_year1) $PHP_year1=date('Y');
	if (!$PHP_factory)
	{				// creat cust combo box
		$msg = "Please choice factory or year first";
		$redir_str = "index2.php?PHP_action=out_search&PHP_msg=".$msg;
		redirect_page($redir_str);
		
	}
	$parm['s_date']=$PHP_year1.'-01-01';
	$parm['e_date']=$PHP_year1.'-12-31';
	$parm['fty']=$PHP_factory;

	$cal=$capaci->get($PHP_factory,$PHP_year1);
	$op=$report->get_output($parm,$PHP_year1,$cal);
	$op['cal']=$cal;
	$op['cal']['total']=$cal['m01']+$cal['m02']+$cal['m03']+$cal['m04']+$cal['m05']+$cal['m06']
					   +$cal['m07']+$cal['m08']+$cal['m09']+$cal['m10']+$cal['m11']+$cal['m12'];
					   
	$cal_title=array('m01','m02','m03','m04','m05','m06','m07','m08','m09','m10','m11','m12');
	$ary_m_tal=array('jan_tal','fab_tal','mar_tal','apl_tal','may_tal','jun_tal','jly_tal','aug_tal','sep_tal','oct_tal','nov_tal','dec_tal');
	$ary_m=array('jan','fab','mar','apl','may','jun','jly','aug','sep','oct','nov','dec');
	
	for ($i=0; $i<sizeof($ary_m); $i++)
	{
		if ($cal[$cal_title[$i]]==0)
		{
			$op['pec'][$ary_m[$i]]=$op[$ary_m_tal[$i]];
		}else{
			$op['pec'][$ary_m[$i]]=($op[$ary_m_tal[$i]] / $cal[$cal_title[$i]])*100;		
		}
	}
	
	if ($op['cal']['total']==0)
	{
		$op['pec']['total']=$op['total_tal'];
	}else{
		$op['pec']['total']=($op['total_tal'] / $op['cal']['total'])*100;
		$tmp1=explode('.',$op['pec']['total']);	
	}
	
	$now_year=date('Y');
	if ($PHP_year1==$now_year)
	{		
		$op['bord_m']=date('m');
	}
	$op['fty']=$PHP_factory;
	$op['year']=$PHP_year1;
	$op['title']="[Factory : ". $PHP_factory ." Year : ".$PHP_year1."]";

if (!isset($PHP_excel))	
{
	page_display($op,'072', $TPL_OUT_VIEW);
}else{
	require_once($config['root_dir']."/lib/spreadsheets/Worksheet.php");
	require_once($config['root_dir']."/lib/spreadsheets/Workbook.php");

	  function HeaderingExcel($filename) {
		  header("Content-type: application/vnd.ms-excel");
		  header("Content-Disposition: attachment; filename=$filename" );
		  header("Expires: 0");
		  header("Cache-Control: must-revalidate, post-check=0,pre-check=0");
		  header("Pragma: public");
		  }

	  // HTTP headers
	  HeaderingExcel('oup-put_qty.xls');
	 
	  // Creating a workbook
	  $workbook = new Workbook("-");

	  // Creating the first worksheet
	  $worksheet1 =& $workbook->add_worksheet('order list');

		$now = $GLOBALS['THIS_TIME'];

	// 寫入 title

	  // Format for the headings
	  $formatot =& $workbook->add_format();
	  $formatot->set_size(10);
	  $formatot->set_align('center');
	  $formatot->set_color('white');
	  $formatot->set_pattern(1);
	  $formatot->set_fg_color('navy');
	  $formatot->set_num_format(4);

	  $f2 =& $workbook->add_format();
	  $f2->set_size(10);
	  $f2->set_align('center');
	  $f2->set_color('navy');
	  $f2->set_pattern('');
	  $f2->set_fg_color('white');
	  
	  $f3 =& $workbook->add_format();
	  $f3->set_size(10);
	  $f3->set_align('right');
	  $f3->set_num_format(3);
	  
	  $f4 =& $workbook->add_format();
	  $f4->set_size(10);
	  $f4->set_align('center');
	  $f4->set_color('white');
	  $f4->set_pattern(1);
	  $f4->set_fg_color('blue');
	  
	  $f5 =& $workbook->add_format();
	  $f5->set_size(10);
	  $f5->set_align('center');
	  $f5->set_color('black');
	  $f5->set_pattern(1);
	  $f5->set_fg_color('lavender');
	  
	  $f6 =& $workbook->add_format();
	  $f6->set_size(10);
	  $f6->set_color('black');
	  $f6->set_pattern(1);
	  $f6->set_align('right');
	  $f6->set_num_format(3);
	  $f6->set_fg_color('lavender');

	  $f7 =& $workbook->add_format();
	  $f7->set_size(10);
	  $f7->set_align('center');
	  $f7->set_color('black');
	  $f7->set_pattern(1);
	  $f7->set_fg_color(31);
	  $f7->set_num_format(4);

	  $f8 =& $workbook->add_format();
	  $f8->set_size(10);
	  $f8->set_align('center');
	  $f8->set_color('black');
	  $f8->set_pattern(1);
	  $f8->set_fg_color(29);
	  $f8->set_num_format(4);	
	  
	  $fc =& $workbook->add_format();
	  $fc->set_align('center');
	  
	  $fbc =& $workbook->add_format();
	  $fbc->set_bold(1);
	  $fbc->set_align('center');
	  
	  $fb =& $workbook->add_format();
	  $fb->set_bold(1);
	  $fb->set_size(10);
	  $fb->set_align('right');
	  $fb->set_num_format(3);

	  $ary = array(12,9,9,9,9,9,9,9,9,9,9,9,9,10);
	  for ($i=0; $i<14; $i++) $worksheet1->set_column(0,$i,$ary[$i]);	  
	  
	  $worksheet1->write_string(0,0,'Factory : '.$PHP_factory);
	  $worksheet1->write_string(0,2,'Monthy Out-put Q\'ty by Customer ');
	  $worksheet1->write_string(0,10,'( '.$PHP_year1.')');
	   $worksheet1->write_string(0,13,'Print Date : '.$TODAY);

$mons=array('','JAN','FEB','MAR','APL','MAY','JUN','JLY','AUG','SEP','OCT','NOV','DEC','Total');
$mmc=array('','m01','m02','m03','m04','m05','m06','m07','m08','m09','m10','m11','m12');
$mma=array('','jan','fab','mar','apl','may','jun','jly','aug','sep','oct','nov','dec');

	  $worksheet1->write_string(1,0," ");
	  for ($i=1; $i < 14; $i++)
	  {
	  	$worksheet1->write_string(1,$i,$mons[$i],$formatot);
	  }
	  

	  $worksheet1->write_string(2,0,"Capacity",$fbc);
	  for ($i=1; $i < 13; $i++)
	  {
	  	$worksheet1->write_number(2,$i,$op['cal'][$mmc[$i]],$fb);	
	  }
	  $worksheet1->write_number(2,13,$op['cal']['total'],$fb);
	  
	  $worksheet1->write_string(3,0,"FROM",$f7);
	  for ($i=1; $i < 13; $i++)
	  {
	  	$worksheet1->write_number(3,$i,$op['sal_'.$mma[$i]],$f3);	
	  }
	  $worksheet1->write_number(3,13,$op['sal_total'],$f3);
	  
	  $worksheet1->write_string(4,0,"Sales",$f7);
	  for ($i=1; $i < 13; $i++)
	  {
	  	$op['sal_'.$mma[$i].'_p']=get_currency($op['sal_'.$mma[$i].'_p']);
	  	$worksheet1->write_string(4,$i,$op['sal_'.$mma[$i].'_p'].'%',$f3);	
	  }
	  $op['sal_total_p']=get_currency($op['sal_total_p']);
	  $worksheet1->write_string(4,13,$op['sal_total_p'].'%',$f3);
	  
	  $worksheet1->write_string(5,0,"FROM",$f8);
	  for ($i=1; $i < 13; $i++)
	  {
	  	$worksheet1->write_number(5,$i,$op[$mma[$i]],$f3);	
	  }
	  $worksheet1->write_number(5,13,$op['total'],$f3);	 
	  
	  $worksheet1->write_string(6,0,"Factory",$f8);
	  for ($i=1; $i < 13; $i++)
	  {
	  	$op[$mma[$i].'_p']=get_currency($op[$mma[$i].'_p']);
	  	$worksheet1->write_string(6,$i,$op[$mma[$i].'_p'].'%',$f3);	
	  }
	  $op['total_p']=get_currency($op['total_p']);
	  $worksheet1->write_string(6,13,$op['total_p'].'%',$f3); 
	  
	  $worksheet1->write_string(7,0,"Total out-put",$f5);
	  for ($i=1; $i < 13; $i++)
	  {
	  	$worksheet1->write_number(7,$i,$op[$mma[$i].'_tal'],$f6);	
	  }
	  $worksheet1->write_number(7,13,$op['total_tal'],$f6); 

	  $worksheet1->write_string(8,0,"[%] / capacity",$f5);
	  for ($i=1; $i < 13; $i++)
	  {
	  	$op['pec'][$mma[$i]]=get_currency($op['pec'][$mma[$i]]);
	  	$worksheet1->write_string(8,$i,$op['pec'][$mma[$i]].'%',$f6);	
	  }
	  $op['pec']['total']=get_currency($op['pec']['total']);
	  $worksheet1->write_string(8,13,$op['pec']['total'].'%',$f6); 
	  
	  
	  $worksheet1->write_string(10,0,"FROM Sales Order List");
	  $worksheet1->write_string(11,0,"CUST",$formatot);
	  for ($i=1; $i < 14; $i++)
	  {
	  	$worksheet1->write_string(11,$i,$mons[$i],$formatot);
	  }	 
	  
      $j=12;
      for ($k=0; $k< sizeof($op['sals']); $k++)
      {
      	$worksheet1->write_string($j,0,$op['sals'][$k]['cust'],$fc);
      	for ($i=1; $i < 13; $i++)
	 	{	  		
	  		$worksheet1->write_number($j,$i,$op['sals'][$k][$mma[$i]],$f3);	
	 	}
	 	$worksheet1->write_number($j,$i,$op['sals'][$k]['total'],$f3);
	 	$j++;
      }  
      
      $worksheet1->write_string($j,0,'total',$f5);    
      for ($i=1; $i < 13; $i++)
	  {	  		
	  	$worksheet1->write_number($j,$i,$op['sal_'.$mma[$i]],$f6);	
	  }	 
	  $worksheet1->write_number($j,$i,$op['sal_total'],$f6);
	  
	  
	  $j=$j+2;
	  $worksheet1->write_string($j,0,"FROM Factory Order List");
	  $j++;
	  $worksheet1->write_string($j,0,"CUST",$formatot);
	  for ($i=1; $i < 14; $i++)
	  {
	  	$worksheet1->write_string($j,$i,$mons[$i],$formatot);
	  }	 
	  
	  $j++;	  
	  for ($k=0; $k< sizeof($op['prt']); $k++)
      {
      	$worksheet1->write_string($j,0,$op['prt'][$k]['cust'],$fc);
      	for ($i=1; $i < 13; $i++)
	 	{	  		
	  		$worksheet1->write_number($j,$i,$op['prt'][$k][$mma[$i]],$f3);	
	 	}
	 	$worksheet1->write_number($j,$i,$op['prt'][$k]['total'],$f3);
	 	$j++;
      }  
      
      $worksheet1->write_string($j,0,'total',$f5);    
      for ($i=1; $i < 13; $i++)
	  {	  		
	  	$worksheet1->write_number($j,$i,$op[$mma[$i]],$f6);	
	  }	 
	  $worksheet1->write_number($j,$i,$op['total'],$f6);
	  
  $workbook->close();
}
break;

//====================================================
case "rep_sch_list":
	check_authority('072',"view");
	$yy=date('Y');
	$mm=date('m');
	$mm++;
	if ($mm == 13)
	{
		$mm=1;
		$yy++;
	}
	if ($mm < 10) $mm='0'.$mm;
	if (!$PHP_year1) $PHP_year1 = $yy;
	if (!$PHP_month1) $PHP_month1 = $mm;

	if (!$PHP_factory) //沒選擇工廠或月份
	{				
		$msg = 'Please choice factory first';
		$redir_str = "index2.php?PHP_action=out_search&PHP_msg=".$msg;
		redirect_page($redir_str);
	
	}
	
	
	$parm['s_date']=$PHP_year1.'-'.$PHP_month1.'-01';
	$parm['e_date']=$PHP_year1.'-'.$PHP_month1.'-31';
	$parm['fty']=$PHP_factory;
	$rptdo=$report->rep_sch_search($parm);  //取出該筆副料記錄(自己生產)
	$rptun=$report->rep_unsch_search($parm);
	$rptnt=$report->rep_nosch_search($parm);
	$rpt_una=$report->rep_unasch_search($parm);
	$m1=$PHP_month1-2;
	if ($m1 <= 0) $m1=$m1+12;
	if ($m1 < 10 )$m1='0'.$m1;
	$m2=$PHP_month1-1;
	if ($m2 <= 0) $m2=$m2+12;
	if ($m2 < 10 )$m2='0'.$m2;
	
	$target=$PHP_year1.$PHP_month1;
	$targetary=array($target,$PHP_year1.$m1,$PHP_year1.$m2);	
	
	$rptdo_su_tal=$rptdo_un_su=$rptdo_un_qty=$rptdo_tqty_tal=$rptdo_qty_tal=0;
	$rptdo_s_su_tal=$rptdo_s_un_su=$rptdo_s_un_qty=$rptdo_s_tqty_tal=$rptdo_s_qty_tal=0;
	$rptdo_i_su_tal=$rptdo_i_un_su=$rptdo_i_un_qty=$rptdo_i_tqty_tal=$rptdo_i_qty_tal=0;
	$rptun_su_tal=$rptun_tqty_tal=$rptun_qty_tal=$rptun_tsu_tal=0;
	$rptun_s_su_tal=$rptun_s_tqty_tal=$rptun_s_qty_tal=$rptun_s_tsu_tal=0;
	$rptun_i_su_tal=$rptun_i_tqty_tal=$rptun_i_qty_tal=$rptun_i_tsu_tal=0;
	$rptnt_su_tal=$rptnt_tqty_tal=$rptnt_qty_tal=0;	
	
  if (!$rptdo) //己排程且己生產
  {
	$op['avi_no_msg']= "---- None AVIABLE production record ----";
  }else{
     $tmp=substr($rptdo[0]['etd'],0,7);
	for ($i=0; $i<sizeof($rptdo); $i++)
	{
		$fty_su=explode(',',$rptdo[$i]['fty_su']);
		$rptdo[$i]['fty_su_a']=$rptdo[$i]['fty_su']=0;
		for ($j=0; $j< sizeof($fty_su); $j++)  //取得當月su
		{
			if ($target >= substr($fty_su[$j],0,6)) 
			{
				$tmp_fty_out=substr($fty_su[$j],6);
				for ($tg=0; $tg<3; $tg++)
				{
					if($targetary[$tg] == substr($fty_su[$j],0,6))$rptdo[$i]['fty_su']=$rptdo[$i]['fty_su']+$tmp_fty_out;
				}
				
				$rptdo[$i]['fty_su_a']=$rptdo[$i]['fty_su_a']+$tmp_fty_out;							
			}			
		}
		if ($rptdo[$i]['ie1'] == 0)
		{
			$rptdo[$i]['fty_qty']=0;
			$rptdo[$i]['fty_qty_a']=0;
		}else{
			$rptdo[$i]['fty_qty']=(int)($rptdo[$i]['fty_su']/$rptdo[$i]['ie1']);	//由su算qty
			$rptdo[$i]['fty_qty_a']=(int)($rptdo[$i]['fty_su_a']/$rptdo[$i]['ie1']);	//由su算qty
		}
		
		
		
		//計算工廠未完成量			    
			$out_su=explode(',',$rptdo[$i]['out_su']);
			$rptdo[$i]['out_qty']=0; $rptdo[$i]['out_su']=0;
			for ($j=0; $j< sizeof($out_su); $j++)  //取得當月su
			{
				if ($target >= substr($out_su[$j],0,6)) 
				{
					$tmp_out_su=substr($out_su[$j],6);	
					$rptdo[$i]['out_su']=$rptdo[$i]['out_su']+$tmp_out_su;					
				}
			}
			$rptdo[$i]['un_su']=$rptdo[$i]['fty_su_a']-$rptdo[$i]['out_su'];
			if ( $rptdo[$i]['un_su'] <=0)
			{
				$rptdo[$i]['un_qty'] =0;
				$rptdo[$i]['un_su'] =0;
			}else{
				$rptdo[$i]['un_qty'] = $rptdo[$i]['fty_qty_a'] - $rptdo[$i]['qty_done'];
				
	//			echo $rptdo[$i]['order_num']."===>".$rptdo[$i]['un_su']."<br>";
			}
		
		$rptdo_un_qty=$rptdo_un_qty+$rptdo[$i]['un_qty'];
		$rptdo_un_su=$rptdo_un_su+$rptdo[$i]['un_su'];
				
		$rptdo_su_tal=$rptdo_su_tal+$rptdo[$i]['fty_su'];
		$rptdo_qty_tal=$rptdo_qty_tal+$rptdo[$i]['fty_qty'];
		$rptdo_tqty_tal=$rptdo_tqty_tal+$rptdo[$i]['qty'];
		
		if($rptdo[$i]['sub_con'] == 1)
		{
			$rptdo_s_un_qty=$rptdo_s_un_qty+$rptdo[$i]['un_qty'];
			$rptdo_s_un_su=$rptdo_s_un_su+$rptdo[$i]['un_su'];
			$rptdo_s_su_tal=$rptdo_s_su_tal+$rptdo[$i]['fty_su'];
			$rptdo_s_qty_tal=$rptdo_s_qty_tal+$rptdo[$i]['fty_qty'];
			$rptdo_s_tqty_tal=$rptdo_s_tqty_tal+$rptdo[$i]['qty'];
		}else{
			$rptdo_i_un_qty=$rptdo_i_un_qty+$rptdo[$i]['un_qty'];
			$rptdo_i_un_su=$rptdo_i_un_su+$rptdo[$i]['un_su'];
			$rptdo_i_su_tal=$rptdo_i_su_tal+$rptdo[$i]['fty_su'];
			$rptdo_i_qty_tal=$rptdo_i_qty_tal+$rptdo[$i]['fty_qty'];
			$rptdo_i_tqty_tal=$rptdo_i_tqty_tal+$rptdo[$i]['qty'];
		}
		
		
		if ($tmp <> substr($rptdo[$i]['etd'],0,7))
		{
			$rptdo[$i]['bkln']=1;
			$tmp = substr($rptdo[$i]['etd'],0,7);			
		}
		$rptdo[$i]['remark']=get_ord_status($rptdo[$i]['status']);
		$rptdo[$i]['mat_eta']= increceDaysInDate($rptdo[$i]['mat_etd'],10);
		$rptdo[$i]['m_acc_eta']= increceDaysInDate($rptdo[$i]['m_acc_etd'],10);	
	}
	
	$tmp_qty=0; $tmp_su=0; $tmp_tqty=0; $tmp_unqty=0; $tmp_unsu=0;
	$tmp_sub_qty=$tmp_sub_su=$tmp_sub_tqty=$tmp_sub_unqty=$tmp_sub_unsu=0;
	$tmp_i_qty=$tmp_i_su=$tmp_i_tqty=$tmp_i_unqty=$tmp_i_unsu=0;
	for ($i=0; $i<sizeof($rptdo); $i++)
	{
		if (!isset($rptdo[$i]['bkln']))
		{
			$tmp_qty=$tmp_qty+$rptdo[$i]['fty_qty'];
			$tmp_tqty=$tmp_tqty+$rptdo[$i]['qty'];
			$tmp_su=$tmp_su+$rptdo[$i]['fty_su'];
			$tmp_mm= substr($rptdo[$i]['etd'],0,7);	
			$tmp_unqty=$tmp_unqty+$rptdo[$i]['un_qty'];
			$tmp_unsu=$tmp_unsu+$rptdo[$i]['un_su'];
			
			if($rptdo[$i]['sub_con'] == 1) //外發代工小計
			{
				$tmp_sub_qty=$tmp_sub_qty+$rptdo[$i]['fty_qty'];
				$tmp_sub_tqty=$tmp_sub_tqty+$rptdo[$i]['qty'];
				$tmp_sub_su=$tmp_sub_su+$rptdo[$i]['fty_su'];				
				$tmp_sub_unqty=$tmp_sub_unqty+$rptdo[$i]['un_qty'];
				$tmp_sub_unsu=$tmp_sub_unsu+$rptdo[$i]['un_su'];		
			}else{//自產小計
				$tmp_i_qty=$tmp_i_qty+$rptdo[$i]['fty_qty'];
				$tmp_i_tqty=$tmp_i_tqty+$rptdo[$i]['qty'];
				$tmp_i_su=$tmp_i_su+$rptdo[$i]['fty_su'];				
				$tmp_i_unqty=$tmp_i_unqty+$rptdo[$i]['un_qty'];
				$tmp_i_unsu=$tmp_i_unsu+$rptdo[$i]['un_su'];
			}
		
		}else{
			$rptdo[$i]['mm_qty']=$tmp_qty;		//每月小計(total)
			$rptdo[$i]['mm_tqty']=$tmp_tqty;
			$rptdo[$i]['mm_su']=$tmp_su;
			$rptdo[$i]['sub_mm']=$tmp_mm;
			$rptdo[$i]['tal_unqty']=$tmp_unqty;
			$rptdo[$i]['tal_unsu']=$tmp_unsu;
			
			$rptdo[$i]['mm_s_qty']=$tmp_sub_qty;		//每月小計(外發代工)
			$rptdo[$i]['mm_s_tqty']=$tmp_sub_tqty;
			$rptdo[$i]['mm_s_su']=$tmp_sub_su;			
			$rptdo[$i]['tal_s_unqty']=$tmp_sub_unqty;
			$rptdo[$i]['tal_s_unsu']=$tmp_sub_unsu;
			
			$rptdo[$i]['mm_i_qty']=$tmp_i_qty;		//每月小計(自產)
			$rptdo[$i]['mm_i_tqty']=$tmp_i_tqty;
			$rptdo[$i]['mm_i_su']=$tmp_i_su;			
			$rptdo[$i]['tal_i_unqty']=$tmp_i_unqty;
			$rptdo[$i]['tal_i_unsu']=$tmp_i_unsu;
			
			$tmp_qty=$rptdo[$i]['fty_qty'];
			$tmp_tqty=$rptdo[$i]['qty'];
			$tmp_su=$rptdo[$i]['fty_su'];
			$tmp_unqty=$rptdo[$i]['un_qty'];
			$tmp_unsu=$rptdo[$i]['un_su'];
			$tmp_mm= substr($rptdo[$i]['etd'],0,7);
			
			$tmp_sub_qty=$tmp_sub_su=$tmp_sub_tqty=$tmp_sub_unsu=$tmp_sub_unqty=0;
			$tmp_i_qty=$tmp_i_su=$tmp_i_tqty=$tmp_i_unsu=$tmp_i_unqty=0;
			if($rptdo[$i]['sub_con'] == 1) //外發代工小計
			{
				$tmp_sub_qty=$tmp_sub_qty+$rptdo[$i]['fty_qty'];
				$tmp_sub_tqty=$tmp_sub_tqty+$rptdo[$i]['qty'];
				$tmp_sub_su=$tmp_sub_su+$rptdo[$i]['fty_su'];				
				$tmp_sub_unqty=$tmp_sub_unqty+$rptdo[$i]['un_qty'];
				$tmp_sub_unsu=$tmp_sub_unsu+$rptdo[$i]['un_su'];		
			}else{	//自產小計
				$tmp_i_qty=$tmp_i_qty+$rptdo[$i]['fty_qty'];
				$tmp_i_tqty=$tmp_i_tqty+$rptdo[$i]['qty'];
				$tmp_i_su=$tmp_i_su+$rptdo[$i]['fty_su'];				
				$tmp_i_unqty=$tmp_i_unqty+$rptdo[$i]['un_qty'];
				$tmp_i_unsu=$tmp_i_unsu+$rptdo[$i]['un_su'];
			}
			
		}
	}	
	$rptdo[$i]['bkln']=1;		//每月小計(total)
	$rptdo[$i]['mm_qty']=$tmp_qty;
	$rptdo[$i]['mm_tqty']=$tmp_tqty;
	$rptdo[$i]['mm_su']=$tmp_su;
	$rptdo[$i]['sub_mm']=$tmp_mm;
	$rptdo[$i]['tal_unqty']=$tmp_unqty;
	$rptdo[$i]['tal_unsu']=$tmp_unsu;
	
	$rptdo[$i]['mm_s_qty']=$tmp_sub_qty;		//每月小計(外發代工)
	$rptdo[$i]['mm_s_tqty']=$tmp_sub_tqty;
	$rptdo[$i]['mm_s_su']=$tmp_sub_su;			
	$rptdo[$i]['tal_s_unqty']=$tmp_sub_unqty;
	$rptdo[$i]['tal_s_unsu']=$tmp_sub_unsu;
			
	$rptdo[$i]['mm_i_qty']=$tmp_i_qty;		//每月小計(自產)
	$rptdo[$i]['mm_i_tqty']=$tmp_i_tqty;
	$rptdo[$i]['mm_i_su']=$tmp_i_su;			
	$rptdo[$i]['tal_i_unqty']=$tmp_i_unqty;
	$rptdo[$i]['tal_i_unsu']=$tmp_i_unsu;
	
   }
  
   if (!$rptun) //己排程未生產
  {
	$op['unavi_no_msg']= "---- None UNAVIABLE production record ----";
  }else{
    $tmp=substr($rptun[0]['etd'],0,7);    
	for ($i=0; $i<sizeof($rptun); $i++)
	{
		if (!$rptun[$i]['fty_su'])
		{
			$fty_su=get_su($rptun[$i]['ets'],$rptun[$i]['etf'],$rptun[$i]['su']);
			$rptun[$i]['fty_su']=0;
			for ($x=0; $x<sizeof($fty_su); $x++)
			{
				$dfty=explode('-',$fty_su[$x]);				
				if ($dfty[0] == $PHP_month1) 
				{
					$rptun[$i]['fty_su']=$rptun[$i]['fty_su']+$dfty[1];
				}
				if ($dfty[0] == $m1) 
				{
					$rptun[$i]['fty_su']=$rptun[$i]['fty_su']+$dfty[1];
				}
				if ($dfty[0] == $m2) 
				{
					$rptun[$i]['fty_su']=$rptun[$i]['fty_su']+$dfty[1];
				}
				
			}
		}else{
			$fty_su=explode(',',$rptun[$i]['fty_su']);
					$rptun[$i]['fty_su']=0;
			for ($j=0; $j< sizeof($fty_su); $j++)  //取得當月su
			{
				$tmp_fty_out=substr($fty_su[$j],6);
				for ($tg=0; $tg<3; $tg++)
				{
					if($targetary[$tg] == substr($fty_su[$j],0,6)) $rptun[$i]['fty_su']= $rptun[$i]['fty_su']+$tmp_fty_out;
				}

			
			}
		}
		if($rptun[$i]['fty_su'] == 0 || $rptun[$i]['ie1'] == 0)
		{
			$rptun[$i]['fty_qty']=0;
		}else{
			$rptun[$i]['fty_qty']=(int)($rptun[$i]['fty_su']/$rptun[$i]['ie1']);  //由su算qty
		}
		
		$rptun_su_tal=$rptun_su_tal+$rptun[$i]['fty_su'];
		$rptun_qty_tal=$rptun_qty_tal+$rptun[$i]['fty_qty'];
		$rptun_tqty_tal=$rptun_tqty_tal+$rptun[$i]['qty'];
		$rptun_tsu_tal=$rptun_tsu_tal+$rptun[$i]['su'];
		
		if($rptun[$i]['sub_con'] == 1)
		{
			$rptun_s_su_tal=$rptun_s_su_tal+$rptun[$i]['fty_su'];
			$rptun_s_qty_tal=$rptun_s_qty_tal+$rptun[$i]['fty_qty'];
			$rptun_s_tqty_tal=$rptun_s_tqty_tal+$rptun[$i]['qty'];
			$rptun_s_tsu_tal=$rptun_s_tsu_tal+$rptun[$i]['su'];
		}else{
			$rptun_i_su_tal=$rptun_i_su_tal+$rptun[$i]['fty_su'];
			$rptun_i_qty_tal=$rptun_i_qty_tal+$rptun[$i]['fty_qty'];
			$rptun_i_tqty_tal=$rptun_i_tqty_tal+$rptun[$i]['qty'];
			$rptun_i_tsu_tal=$rptun_i_tsu_tal+$rptun[$i]['su'];
		}
		
		if ($tmp <> substr($rptun[$i]['etd'],0,7))
		{
			$rptun[$i]['bkln']=1;
			$tmp = substr($rptun[$i]['etd'],0,7);						
		}

		$rptun[$i]['remark']=get_ord_status($rptun[$i]['status']);
		$rptun[$i]['mat_eta']= increceDaysInDate($rptun[$i]['mat_etd'],10);
		$rptun[$i]['m_acc_eta']= increceDaysInDate($rptun[$i]['m_acc_etd'],10);
	}
	$tmp_qty=0; $tmp_su=0; $tmp_tqty=0; $tmp_tsu=0;
	$tmp_sub_qty=$tmp_sub_su=$tmp_sub_tqty=$tmp_sub_tsu=0;
	$tmp_i_qty=$tmp_i_su=$tmp_i_tqty=$tmp_i_tsu=0;

	for ($i=0; $i<sizeof($rptun); $i++)
	{
		if (!isset($rptun[$i]['bkln']))
		{
			$tmp_qty=$tmp_qty+$rptun[$i]['fty_qty'];
			$tmp_tqty=$tmp_tqty+$rptun[$i]['qty'];
			$tmp_tsu=$tmp_tsu+$rptun[$i]['su'];
			$tmp_su=$tmp_su+$rptun[$i]['fty_su'];
			$tmp_mm= substr($rptun[$i]['etd'],0,7);	
			
			if($rptun[$i]['sub_con'] == 1) //外發代工小計
			{
				$tmp_sub_qty=$tmp_sub_qty+$rptun[$i]['fty_qty'];
				$tmp_sub_tqty=$tmp_sub_tqty+$rptun[$i]['qty'];
				$tmp_sub_tsu=$tmp_sub_tsu+$rptun[$i]['su'];
				$tmp_sub_su=$tmp_sub_su+$rptun[$i]['fty_su'];				
			}else{//自產小計
				$tmp_i_qty=$tmp_i_qty+$rptun[$i]['fty_qty'];
				$tmp_i_tqty=$tmp_i_tqty+$rptun[$i]['qty'];
				$tmp_i_tsu=$tmp_i_tsu+$rptun[$i]['su'];
				$tmp_i_su=$tmp_i_su+$rptun[$i]['fty_su'];				
			}		
		}else{		
			$rptun[$i]['mm_qty']=$tmp_qty;
			$rptun[$i]['mm_tqty']=$tmp_tqty;
			$rptun[$i]['mm_tsu']=$tmp_tsu;
			$rptun[$i]['mm_su']=$tmp_su;
			$rptun[$i]['sub_mm']=$tmp_mm;

			$rptun[$i]['mm_s_qty']=$tmp_sub_qty;		//每月小計(外發代工)
			$rptun[$i]['mm_s_tqty']=$tmp_sub_tqty;
			$rptun[$i]['mm_s_tsu']=$tmp_sub_tsu;
			$rptun[$i]['mm_s_su']=$tmp_sub_su;			
			
			$rptun[$i]['mm_i_qty']=$tmp_i_qty;		//每月小計(自產)
			$rptun[$i]['mm_i_tqty']=$tmp_i_tqty;
			$rptun[$i]['mm_i_tsu']=$tmp_i_tsu;
			$rptun[$i]['mm_i_su']=$tmp_i_su;			
			
			$tmp_qty=$rptun[$i]['fty_qty'];
			$tmp_tqty=$rptun[$i]['qty'];
			$tmp_tsu=$rptun[$i]['su'];
			$tmp_su=$rptun[$i]['fty_su'];
			$tmp_mm= substr($rptun[$i]['etd'],0,7);
			$tmp_sub_qty=$tmp_sub_su=$tmp_sub_tqty=$tmp_sub_tsu=0;
			$tmp_i_qty=$tmp_i_su=$tmp_i_tqty=$tmp_i_tsu=0;
			
			if($rptun[$i]['sub_con'] == 1) //外發代工小計
			{
				$tmp_sub_qty=$tmp_sub_qty+$rptun[$i]['fty_qty'];
				$tmp_sub_tqty=$tmp_sub_tqty+$rptun[$i]['qty'];
				$tmp_sub_tsu=$tmp_sub_tsu+$rptun[$i]['su'];
				$tmp_sub_su=$tmp_sub_su+$rptun[$i]['fty_su'];				
			}else{//自產小計
				$tmp_i_qty=$tmp_i_qty+$rptun[$i]['fty_qty'];
				$tmp_i_tqty=$tmp_i_tqty+$rptun[$i]['qty'];
				$tmp_i_tsu=$tmp_i_tsu+$rptun[$i]['su'];
				$tmp_i_su=$tmp_i_su+$rptun[$i]['fty_su'];				
			}	
			
		}
	}	
	$rptun[$i]['bkln']=1;
	$rptun[$i]['mm_tqty']=$tmp_tqty;
	$rptun[$i]['mm_tsu']=$tmp_tsu;
	$rptun[$i]['mm_qty']=$tmp_qty;
	$rptun[$i]['mm_su']=$tmp_su;
	$rptun[$i]['sub_mm']=$tmp_mm;
	$rptun[$i]['mm_s_qty']=$tmp_sub_qty;		//每月小計(外發代工)
	$rptun[$i]['mm_s_tqty']=$tmp_sub_tqty;
	$rptun[$i]['mm_s_tsu']=$tmp_sub_tsu;
	$rptun[$i]['mm_s_su']=$tmp_sub_su;			
			
	$rptun[$i]['mm_i_qty']=$tmp_i_qty;		//每月小計(自產)
	$rptun[$i]['mm_i_tqty']=$tmp_i_tqty;
	$rptun[$i]['mm_i_tsu']=$tmp_i_tsu;
	$rptun[$i]['mm_i_su']=$tmp_i_su;			

	
  }
  $rptnt_su = 0;
  if (!$rptnt) //需排程
  {
	$op['req_no_msg'] = "---- none pending for SCHEDULE record ----";
  }else{
    $tmp=substr($rptnt[0]['etd'],0,7);
	for ($i=0; $i<sizeof($rptnt); $i++)
	{
		$fty_su=explode(',',$rptnt[$i]['etp_su']);
		$rptnt[$i]['etp_su']=0;
		for ($j=0; $j< sizeof($fty_su); $j++) //取得當月su
		{
			//if ($target == substr($fty_su[$j],0,6)) $rptnt[$i]['etp_su']=substr($fty_su[$j],6);			
			$tmp_fty_out=substr($fty_su[$j],6);
			for ($tg=0; $tg<3; $tg++)
			{
				if($targetary[$tg] == substr($fty_su[$j],0,6)) $rptnt[$i]['etp_su']=  $rptnt[$i]['etp_su']+$tmp_fty_out;
			}

			
		}
		if($rptnt[$i]['etp_su']==0 ||$rptnt[$i]['ie1']==0)
		{
			$rptnt[$i]['etp_qty']=0;
		}else{
			$rptnt[$i]['etp_qty']=(int)($rptnt[$i]['etp_su']/$rptnt[$i]['ie1']); //由su算qty
		}
		
		$rptnt_su_tal=$rptnt_su_tal+$rptnt[$i]['etp_su'];
		$rptnt_qty_tal=$rptnt_qty_tal+$rptnt[$i]['etp_qty'];
		$rptnt_tqty_tal=$rptnt_tqty_tal+$rptnt[$i]['qty'];
		$rptnt_su=$rptnt_su+$rptnt[$i]['su'];
		
		if ($tmp <> substr($rptnt[$i]['etd'],0,7))
		{
			$rptnt[$i]['bkln']=1;
			$tmp = substr($rptnt[$i]['etd'],0,7);			
		}
		
		if ($rptnt[$i]['status'] == 4) $rptnt[$i]['remark']='APVD';
		$rptnt[$i]['mat_eta']= increceDaysInDate($rptnt[$i]['mat_etd'],10);
		$rptnt[$i]['m_acc_eta']= increceDaysInDate($rptnt[$i]['m_acc_etd'],10);		
	}
	
	$tmp_qty=0; $tmp_su=0; $tmp_tqty=0; $tmp_tsu=0;
	for ($i=0; $i<sizeof($rptnt); $i++)
	{
		if (!isset($rptnt[$i]['bkln']))
		{
			$tmp_qty=$tmp_qty+$rptnt[$i]['etp_qty'];
			$tmp_tqty=$tmp_tqty+$rptnt[$i]['qty'];
			$tmp_su=$tmp_su+$rptnt[$i]['etp_su'];
			$tmp_tsu=$tmp_tsu+$rptnt[$i]['su'];
			$tmp_mm= substr($rptnt[$i]['etd'],0,7);			
		}else{
			$rptnt[$i]['mm_qty']=$tmp_qty;
			$rptnt[$i]['mm_tqty']=$tmp_tqty;
			$rptnt[$i]['mm_su']=$tmp_su;
			$rptnt[$i]['mm_tsu']=$tmp_tsu;
			$rptnt[$i]['sub_mm']=$tmp_mm;
			$tmp_qty=$rptnt[$i]['etp_qty'];
			$tmp_tqty=$rptnt[$i]['qty'];
			$tmp_su=$rptnt[$i]['etp_su'];
			$tmp_tsu=$rptnt[$i]['su'];
			$tmp_mm= substr($rptnt[$i]['etd'],0,7);	
			
		}
	}	
	$rptnt[$i]['bkln']=1;
	$rptnt[$i]['mm_qty']=$tmp_qty;
	$rptnt[$i]['mm_tqty']=$tmp_tqty;
	$rptnt[$i]['mm_su']=$tmp_su;
	$rptnt[$i]['mm_tsu']=$tmp_tsu;
	$rptnt[$i]['sub_mm']=$tmp_mm;
	
  }
  
 
   $rpt_una_tqty_tal=$rpt_una_qty_tal=$rpt_una_su_tal=$rpt_una_su = 0;
  if (!$rpt_una) //不可排程
  {
	$op['req_una_msg'] = "---- none pending for SCHEDULE record ----";
  }else{
    $tmp=substr($rpt_una[0]['etd'],0,7);
	for ($i=0; $i<sizeof($rpt_una); $i++)
	{
		$fty_su=explode(',',$rpt_una[$i]['etp_su']);
		$rpt_una[$i]['etp_su']=0;
		for ($j=0; $j< sizeof($fty_su); $j++) //取得當月su
		{
			$tmp_fty_out=substr($fty_su[$j],6);
			for ($tg=0; $tg<3; $tg++)
			{
				if($targetary[$tg] == substr($fty_su[$j],0,6)) $rpt_una[$i]['etp_su']=  $rpt_una[$i]['etp_su']+$tmp_fty_out;
			}

			
		}
		if($rpt_una[$i]['etp_su']==0 ||$rpt_una[$i]['ie1']==0)
		{
			$rpt_una[$i]['etp_qty']=0;
		}else{
			$rpt_una[$i]['etp_qty']=(int)($rpt_una[$i]['etp_su']/$rpt_una[$i]['ie1']); //由su算qty
		}
		
		$rpt_una_su_tal=$rpt_una_su_tal+$rpt_una[$i]['etp_su'];
		$rpt_una_qty_tal=$rpt_una_qty_tal+$rpt_una[$i]['etp_qty'];
		$rpt_una_tqty_tal=$rpt_una_tqty_tal+$rpt_una[$i]['qty'];
		$rpt_una_su=$rpt_una_su+$rpt_una[$i]['su'];
		
		if ($tmp <> substr($rpt_una[$i]['etd'],0,7))
		{
			$rpt_una[$i]['bkln']=1;
			$tmp = substr($rpt_una[$i]['etd'],0,7);			
		}
		
		if ($rpt_una[$i]['status'] == 4) $rpt_una[$i]['remark']='APVD';
		
	}
	
	$tmp_qty=0; $tmp_su=0; $tmp_tqty=0; $tmp_tsu=0;
	for ($i=0; $i<sizeof($rpt_una); $i++)
	{
		if (!isset($rpt_una[$i]['bkln']))
		{
			$tmp_qty=$tmp_qty+$rpt_una[$i]['etp_qty'];
			$tmp_tqty=$tmp_tqty+$rpt_una[$i]['qty'];
			$tmp_su=$tmp_su+$rpt_una[$i]['etp_su'];
			$tmp_tsu=$tmp_tsu+$rpt_una[$i]['su'];
			$tmp_mm= substr($rpt_una[$i]['etd'],0,7);			
		}else{
			$rpt_una[$i]['mm_qty']=$tmp_qty;
			$rpt_una[$i]['mm_tqty']=$tmp_tqty;
			$rpt_una[$i]['mm_su']=$tmp_su;
			$rpt_una[$i]['mm_tsu']=$tmp_tsu;
			$rpt_una[$i]['sub_mm']=$tmp_mm;
			$tmp_qty=$rpt_una[$i]['etp_qty'];
			$tmp_tqty=$rpt_una[$i]['qty'];
			$tmp_su=$rpt_una[$i]['etp_su'];
			$tmp_tsu=$rpt_una[$i]['su'];
			$tmp_mm= substr($rpt_una[$i]['etd'],0,7);	
			
		}
	}	
	$rpt_una[$i]['bkln']=1;
	$rpt_una[$i]['mm_qty']=$tmp_qty;
	$rpt_una[$i]['mm_tqty']=$tmp_tqty;
	$rpt_una[$i]['mm_su']=$tmp_su;
	$rpt_una[$i]['mm_tsu']=$tmp_tsu;
	$rpt_una[$i]['sub_mm']=$tmp_mm;
	
  }
 
 
	$op['rpt_su_tal']=$rptdo_su_tal+$rptun_su_tal+$rptnt_su_tal;
	$op['rpt_qty_tal']=$rptdo_qty_tal+$rptun_qty_tal+$rptnt_qty_tal;
	$op['rpt_tqty_tal']=$rptdo_tqty_tal+$rptun_tqty_tal+$rptnt_tqty_tal ;
	if ($op['rpt_su_tal']==0){$op['rptdo_su_pec']=0;}else{$op['rptdo_su_pec']=(($rptdo_su_tal)/$op['rpt_su_tal'])*100;}
	if ($op['rpt_su_tal']==0){$op['rptun_su_pec']=0;}else{$op['rptun_su_pec']=(($rptun_su_tal+$rptnt_su_tal)/$op['rpt_su_tal'])*100;}
	if ($op['rpt_qty_tal']==0){$op['rptdo_qty_pec']=0;}else{$op['rptdo_qty_pec']=(($rptdo_qty_tal)/$op['rpt_qty_tal'])*100;}
	if ($op['rpt_qty_tal']==0){$op['rptun_qty_pec']=0;}else{$op['rptun_qty_pec']=(($rptun_qty_tal+$rptnt_qty_tal)/$op['rpt_qty_tal'])*100;}

	$op['rptdo']=$rptdo;
	$op['rptdo_su_tal']=$rptdo_su_tal;
	$op['rptdo_qty_tal']=$rptdo_qty_tal;
	$op['rptdo_tqty_tal']=$rptdo_tqty_tal;
	$op['rptdo_unqty_tal']=$rptdo_un_qty;
	$op['rptdo_unsu_tal']=$rptdo_un_su;
	
	$op['rptdo_s_su_tal']=$rptdo_s_su_tal;
	$op['rptdo_s_qty_tal']=$rptdo_s_qty_tal;
	$op['rptdo_s_tqty_tal']=$rptdo_s_tqty_tal;
	$op['rptdo_s_unqty_tal']=$rptdo_s_un_qty;
	$op['rptdo_s_unsu_tal']=$rptdo_s_un_su;
	
	$op['rptdo_i_su_tal']=$rptdo_i_su_tal;
	$op['rptdo_i_qty_tal']=$rptdo_i_qty_tal;
	$op['rptdo_i_tqty_tal']=$rptdo_i_tqty_tal;
	$op['rptdo_i_unqty_tal']=$rptdo_i_un_qty;
	$op['rptdo_i_unsu_tal']=$rptdo_i_un_su;
	
	
	$op['rptun']=$rptun;
	$op['rptun_su_tal']=$rptun_su_tal;
	$op['rptun_qty_tal']=$rptun_qty_tal;
	$op['rptun_tqty_tal']=$rptun_tqty_tal;
	$op['rptun_tsu_tal']=$rptun_tsu_tal;
	
	$op['rptun_s_su_tal']=$rptun_s_su_tal;
	$op['rptun_s_qty_tal']=$rptun_s_qty_tal;
	$op['rptun_s_tqty_tal']=$rptun_s_tqty_tal;
	$op['rptun_s_tsu_tal']=$rptun_s_tsu_tal;
	
	$op['rptun_i_su_tal']=$rptun_i_su_tal;
	$op['rptun_i_qty_tal']=$rptun_i_qty_tal;
	$op['rptun_i_tqty_tal']=$rptun_i_tqty_tal;
	$op['rptun_i_tsu_tal']=$rptun_i_tsu_tal;
	
	$op['rptnt']=$rptnt;
	$op['rptnt_su_tal']=$rptnt_su_tal;
	$op['rptnt_qty_tal']=$rptnt_qty_tal;
	$op['rptnt_tqty_tal']=$rptnt_tqty_tal;
	$op['rptnt_tsu_tal']=$rptnt_su;

	$op['rpt_una']=$rpt_una;
	$op['rpt_una_su_tal']=$rpt_una_su_tal;
	$op['rpt_una_qty_tal']=$rpt_una_qty_tal;
	$op['rpt_una_tqty_tal']=$rpt_una_tqty_tal;
	$op['rpt_una_tsu_tal']=$rpt_una_su;
	
	$op['rpt_su_un']=$rptun_su_tal+$rptnt_su_tal;
	$op['rpt_qty_un']=$rptun_qty_tal+$rptnt_qty_tal;
	
	$op['rpt_su_do']=$rptdo_su_tal;
	$op['rpt_qty_do']=$rptdo_qty_tal;
	
	$op['title']= $m1.'/'.$m2.'/'.$PHP_month1;
	$op['fty']=$PHP_factory;
	$op['year']=$PHP_year1;
	$op['mm']=$PHP_month1;
	$op['today']=date('Y-m-d');

	
if (!isset($PHP_excel))	
{
	page_display($op,'072', $TPL_RPT_SCH_VIEW);
}else{
	require_once($config['root_dir']."/lib/spreadsheets/Worksheet.php");
	require_once($config['root_dir']."/lib/spreadsheets/Workbook.php");

	  function HeaderingExcel($filename) {
		  header("Content-type: application/vnd.ms-excel");
		  header("Content-Disposition: attachment; filename=$filename" );
		  header("Expires: 0");
		  header("Cache-Control: must-revalidate, post-check=0,pre-check=0");
		  header("Pragma: public");
		  }

	  // HTTP headers
	  HeaderingExcel('sch_order.xls');
	 
	  // Creating a workbook
	  $workbook = new Workbook("-");

	  // Creating the first worksheet
	  $worksheet1 =& $workbook->add_worksheet('order list');

		$now = $GLOBALS['THIS_TIME'];

	// 寫入 title

	  // Format for the headings
	  $formatot =& $workbook->add_format();
	  $formatot->set_size(10);
	  $formatot->set_align('center');
	  $formatot->set_color('white');
	  $formatot->set_pattern(1);
	  $formatot->set_fg_color('navy');
	  $formatot->set_num_format(4);


	  $f1 =& $workbook->add_format();
	  $f1->set_size(13);
	  $f1->set_align('center');
	  $f1->set_color('white');
	  $f1->set_pattern(1);
	  $f1->set_fg_color('navy');
	  $f1->set_num_format(4);


	  $f2 =& $workbook->add_format(); //藍字且置中
	  $f2->set_size(10);
	  $f2->set_align('center');
	  $f2->set_color('navy');
	  $f2->set_pattern('');
	  $f2->set_fg_color('white');
	  
	  $f3 =& $workbook->add_format(); //置右
	  $f3->set_size(10);
	  $f3->set_align('right');
	  $f3->set_num_format(3);
	  
	  $f4 =& $workbook->add_format();  //淡藍色底置中黑字
	  $f4->set_size(10);
	  $f4->set_align('center');
	  $f4->set_color('black');
	  $f4->set_pattern(1);
	  $f4->set_fg_color(31);
	  
	  $f5 =& $workbook->add_format();  //灰底白字置中
	  $f5->set_size(10);
	  $f5->set_align('center');
	  $f5->set_color('white');
	  $f5->set_pattern(1);
	  $f5->set_fg_color('grey');
	  
	  $f6 =& $workbook->add_format();  //灰底白字置右
	  $f6->set_size(10);
	  $f6->set_color('white');
	  $f6->set_pattern(1);
	  $f6->set_align('right');
	  $f6->set_num_format(3);
	  $f6->set_fg_color('grey');
	  
	  $f7 =& $workbook->add_format();  //淡紅底置中
	  $f7->set_color(62);	
	  $f7->set_pattern(1);  
	  $f7->set_align('center');
	  $f7->set_fg_color(45);
	  
	  
	  $f8 =& $workbook->add_format();
	  $f8->set_align('center');	  

	  $fld=array(10,14,8,8,8,15,15,15,15,12,10,10,10,10,10);
	  for ($i=0; $i< sizeof($fld); $i++)
	  {
	  	$worksheet1->set_column(0,$i,$fld[$i]);
	  }
	  
//table1:匯總結果
	 $tt1=array('','','','Q\'ty','%(Q\'TY)','SU','%SU',"                      REMARK                    ");
	 for ($i=0; $i<sizeof($tt1); $i++) $worksheet1->write_string(0,$i,$tt1[$i],$formatot);
	 $worksheet1->write(0,10,"Print Date : ".$TODAY,$f3);	 
	 
  		$op['rptun_qty_pec']=get_currency($op['rptun_qty_pec']);
  		$op['rptun_su_pec']=get_currency($op['rptun_su_pec']);
	  $worksheet1->write_string(1,0,"Unavailable production");
	  $worksheet1->write_number(1,3,$op['rpt_qty_un'],$f3);
	  $worksheet1->write_string(1,4,$op['rptun_qty_pec']."%");
	  $worksheet1->write_number(1,5,$op['rpt_su_un'],$f3);
	  $worksheet1->write_string(1,6,$op['rptun_su_pec']."%");
	  $worksheet1->write(1,7,"                                             ");
  		$op['rptdo_qty_pec']=get_currency($op['rptdo_qty_pec']);
  		$op['rptdo_su_pec']=get_currency($op['rptdo_su_pec']);
	  $worksheet1->write_string(2,0,"Available production");
	  $worksheet1->write_number(2,3,$op['rpt_qty_do'],$f3);
	  $worksheet1->write_string(2,4,$op['rptdo_qty_pec']."%");
	  $worksheet1->write_number(2,5,$op['rpt_su_do'],$f3);
	  $worksheet1->write_string(2,6,$op['rptdo_su_pec']."%");
	  $worksheet1->write(2,7,"                                             ");
	  $worksheet1->write_string(3,0,"Total");
	  $worksheet1->write_number(3,3,$op['rpt_qty_tal'],$f3);
	  $worksheet1->write_string(3,4,'100%');
	  $worksheet1->write_number(3,5,$op['rpt_su_tal'],$f3);
	  $worksheet1->write_string(3,6,'100%');
	  $worksheet1->write(3,7,"                                             ");
	  
	  
//table2:己核可未生產  
      $table1=array('','Scheduled','','but','','unavailable','','Production');
      for ($i=0; $i<sizeof($table1); $i++)
      {
      	$worksheet1->write_string(4,$i,$table1[$i],$f1);
      }
	  $tt1=array('Order #','ETD','ORD Q\'ty','ORD SU','Allot SU','Fab.ETA','Fab.Receive','M.ACC. ETA', 'M.ACC. Receive','Smpl APV','ETS','ETF','Pd','Allot Qty');
	  for ($i=0; $i<sizeof($tt1); $i++)
	  {
	  	$worksheet1->write_string(5,$i,$tt1[$i],$f4);
	  }

	  $i=0;	  $x=0;
	  if ($rptun)
	  {	  	
	  for ($i=0; $i< (sizeof($rptun)-1); $i++)
	  {
	  	
	  	if (isset($rptun[$i]['bkln']))
	  	{
	  		$ary[0]=array('mm_s_qty','mm_s_su','mm_s_tqty','mm_s_tsu','mm_s_su','mm_s_qty','(S)');
	  		$ary[1]=array('mm_i_qty','mm_i_su','mm_i_tqty','mm_i_tsu','mm_i_su','mm_i_qty','(I)');
	  		$ary[2]=array('mm_qty','mm_su','mm_tqty','mm_tsu','mm_su','mm_qty','');
	  		for ($z=0; $z<sizeof($ary); $z++)
	  		{
	  			$rptun[$i][$ary[$z][0]]=(int)$rptun[$i][$ary[$z][0]];
	  			$rptun[$i][$ary[$z][1]]=(int)$rptun[$i][$ary[$z][1]];
	  			$worksheet1->write_string($x+6,0,'ETD ['.$rptun[$i]['sub_mm'].'] subtotal'.$ary[$z][6]);	
	  			$worksheet1->write_number($x+6,2,$rptun[$i][$ary[$z][2]],$f3);
	  			$worksheet1->write_number($x+6,3,$rptun[$i][$ary[$z][3]],$f3);
	  			$worksheet1->write_number($x+6,4,$rptun[$i][$ary[$z][4]],$f3);
	  			$worksheet1->write_number($x+6,13,$rptun[$i][$ary[$z][5]],$f3);	  		
	  		 	$x++;	
	  		}	  		 
	  	}
	  	if ($rptun[$i]['smpl_apv']=='0000-00-00') $rptun[$i]['smpl_apv']='';
	  	if ($rptun[$i]['sub_con'] == 0){$sub_c='In House';}else{$sub_c='Sub-con.';}
	  	$con2=$con=array($rptun[$i]['order_num'],$rptun[$i]['etd'],$rptun[$i]['qty'],$rptun[$i]['fty_su'],$rptun[$i]['fty_su'],$rptun[$i]['mat_etd'],$rptun[$i]['mat_shp'],$rptun[$i]['m_acc_etd'],$rptun[$i]['m_acc_shp'],$rptun[$i]['smpl_apv'],$rptun[$i]['ets'],$rptun[$i]['etf'],$sub_c,$rptun[$i]['fty_qty']);
	  	if (date('Y-m-d') > $con[1]) $con2[1]='mk';
	  	if (date('Y-m-d') > $con[5] && ($con[6] == '' || $con[6] =='0000-00-00')) $con2[5]='mk';
	  	if (date('Y-m-d') > $con[7] && ($con[8]=='' || $con[8] == '0000-00-00')) $con2[7]='mk';
	  	if ($con[9]=='') $con2[9]='mk';
	  	for ($z=0; $z<sizeof($con); $z++)
	  	{
	  		if ($z == 2 || $z == 3 || $z ==4 || $z == 13)
	  		{
	  			$worksheet1->write_number($x+6,$z,$con[$z],$f3);
	  		}else if($con2[$z] == 'mk'){
	  			$worksheet1->write_string($x+6,$z,$con[$z],$f7);
	  		}else{
	  			$worksheet1->write_string($x+6,$z,$con[$z],$f8);
	  		}
	  	} 	
	    $x++;
	  }
	  	$j=$x+6;
	  	$ary[0]=array('mm_s_qty','mm_s_su','mm_s_tqty','mm_s_tsu','mm_s_su','mm_s_qty','(S)');
	  	$ary[1]=array('mm_i_qty','mm_i_su','mm_i_tqty','mm_i_tsu','mm_i_su','mm_i_qty','(I)');
	  	$ary[2]=array('mm_qty','mm_su','mm_tqty','mm_tsu','mm_su','mm_qty','');
	  	for ($z=0; $z<sizeof($ary); $z++)
	  	{
	  		$rptun[$i][$ary[$z][0]]=(int)$rptun[$i][$ary[$z][0]];
	  		$rptun[$i][$ary[$z][1]]=(int)$rptun[$i][$ary[$z][1]];
	  		$worksheet1->write_string($j,0,'ETD ['.$rptun[$i]['sub_mm'].'] subtotal'.$ary[$z][6]);	
	  		$worksheet1->write_number($j,2,$rptun[$i][$ary[$z][2]],$f3);
	  		$worksheet1->write_number($j,3,$rptun[$i][$ary[$z][3]],$f3);
	  		$worksheet1->write_number($j,4,$rptun[$i][$ary[$z][4]],$f3);
	  		$worksheet1->write_number($j,13,$rptun[$i][$ary[$z][5]],$f3);	  		
	  	 	$j++;	
	  	}		
	  }	  
	    $worksheet1->write_string($j,0,"Total",$f5);
	  	$worksheet1->write_string($j,1,'',$f5);
	 	$worksheet1->write_number($j,2,$rptun_tqty_tal,$f6);
	  	$worksheet1->write_number($j,3,$rptun_tsu_tal,$f6);
	  	$worksheet1->write_number($j,4,$rptun_su_tal,$f6);
	  	for ($z=5; $z < 13; $z++) $worksheet1->write_string($j,$z,'',$f5);
	  	$worksheet1->write_number($j,13,$rptun_qty_tal,$f6);
	 
	  $j++;
	    $worksheet1->write_string($j,0,"Total",$f5);
	  	$worksheet1->write_string($j,1,'(Sub-con.)',$f5);
	 	$worksheet1->write_number($j,2,$rptun_s_tqty_tal,$f6);
	  	$worksheet1->write_number($j,3,$rptun_s_tsu_tal,$f6);
	  	$worksheet1->write_number($j,4,$rptun_s_su_tal,$f6);
	  	for ($z=5; $z < 13; $z++) $worksheet1->write_string($j,$z,'',$f5);
	  	$worksheet1->write_number($j,13,$rptun_s_qty_tal,$f6);
	  $j++;
	    $worksheet1->write_string($j,0,"Total",$f5);
	  	$worksheet1->write_string($j,1,'(In House)',$f5);
	 	$worksheet1->write_number($j,2,$rptun_i_tqty_tal,$f6);
	  	$worksheet1->write_number($j,3,$rptun_i_tsu_tal,$f6);
	  	$worksheet1->write_number($j,4,$rptun_i_su_tal,$f6);
	  	for ($z=5; $z < 13; $z++) $worksheet1->write_string($j,$z,'',$f5);
	  	$worksheet1->write_number($j,13,$rptun_i_qty_tal,$f6);



//table4 需核可	  	
	 $j=$j+2;  //計算列
	  $table1=array('','Require','Schedule','List','');
      for ($i=0; $i<sizeof($table1); $i++)
      {
      	$ti=$i+5;
      	$worksheet1->write_string($j,$ti,$table1[$i],$f1);
      }
      $j++;
	  $tt1=array('Order #','ETD','ORD Q\'ty','ORD SU','Allot SU','Fab.ETA','Fab.Receive','M.ACC. ETA', 'M.ACC. Receive','Smpl APV','REMARK','Allot Qty');
	  for ($i=0; $i<sizeof($tt1); $i++)
	  {
	  	$worksheet1->write_string($j,$i,$tt1[$i],$f4);
	  }
	 $j++;
	 $i=0; $x=0;
	 if($rptnt)
	 {	  
	  for ($i=0; $i< (sizeof($rptnt)-1); $i++)
	  {
	  	if (isset($rptnt[$i]['bkln']))
	  	{
	  		$rptnt[$i]['mm_qty']=(int)$rptnt[$i]['mm_qty'];
	  		$rptnt[$i]['mm_su']=(int)$rptnt[$i]['mm_su'];
	  		$worksheet1->write_string($x+$j,0,'ETD ['.$rptnt[$i]['sub_mm'].'] subtotal');	
	  		$worksheet1->write_number($x+$j,3,$rptnt[$i]['mm_tqty'],$f3);
	  		$worksheet1->write_number($x+$j,3,$rptnt[$i]['mm_tsu'],$f3);
	  		$worksheet1->write_number($x+$j,4,$rptnt[$i]['mm_su'],$f3);
	  		$worksheet1->write_number($x+$j,11,$rptnt[$i]['mm_qty'],$f3);
	  		 $x++;
	  	}
	  	$worksheet1->write_string($x+$j,0,$rptnt[$i]['order_num']);
	  	$worksheet1->write_string($x+$j,1,$rptnt[$i]['etd']);
	  	if (date('Y-m-d') > $rptnt[$i]['etd']) $worksheet1->write_string($x+$j,1,$rptnt[$i]['etd'],$f7);
	 	$worksheet1->write_number($x+$j,2,$rptnt[$i]['qty'],$f3);
	  	$worksheet1->write_number($x+$j,3,$rptnt[$i]['su'],$f3);
	  	$worksheet1->write_number($x+$j,4,$rptnt[$i]['etp_su'],$f3);
	  	$worksheet1->write_string($x+$j,5,$rptnt[$i]['mat_etd']);
	  	if (date('Y-m-d') > $rptnt[$i]['etd'] && ($rptnt[$i]['mat_shp'] == '' || $rptnt[$i]['mat_shp'] == '0000-00-00')) $worksheet1->write_string($x+$j,5,$rptnt[$i]['mat_etd'],$f7);
	  	$worksheet1->write_string($x+$j,6,$rptnt[$i]['mat_shp']);
	  	$worksheet1->write_string($x+$j,7,$rptnt[$i]['m_acc_etd']);
	  	if (date('Y-m-d') > $rptnt[$i]['m_acc_etd'] && ($rptnt[$i]['m_acc_shp'] == '' || $rptnt[$i]['m_acc_shp'] == '0000-00-00')) $worksheet1->write_string($x+$j,7,$rptnt[$i]['m_acc_etd'],$f7);
	  	$worksheet1->write_string($x+$j,8,$rptnt[$i]['m_acc_shp']);
	  	$worksheet1->write_string($x+$j,9,$rptnt[$i]['smpl_apv']);
	  	if ($rptnt[$i]['smpl_apv']=='0000-00-00') $rptnt[$i]['smpl_apv']='';
	  	$worksheet1->write_string($x+$j,9,$rptnt[$i]['smpl_apv']);
	  	if ($rptnt[$i]['smpl_apv']=='') $worksheet1->write_string($x+$j,9,$rptnt[$i]['smpl_apv'],$f7);
	  	$worksheet1->write_string($x+$j,10,$rptnt[$i]['remark']);	  	
	  	$worksheet1->write_number($x+$j,11,$rptnt[$i]['etp_qty'],$f3);
	    $x++;
	  }
	  	$rptnt[$i]['mm_qty']=(int)$rptnt[$i]['mm_qty'];
	  	$rptnt[$i]['mm_su']=(int)$rptnt[$i]['mm_su'];
	    $worksheet1->write_string($x+$j,0,'ETD ['.$rptnt[$i]['sub_mm'].'] subtotal');	
	  	$worksheet1->write_number($x+$j,2,$rptnt[$i]['mm_tqty'],$f3);
	  	$worksheet1->write_number($x+$j,3,$rptnt[$i]['mm_tsu'],$f3);
	  	$worksheet1->write_number($x+$j,4,$rptnt[$i]['mm_su'],$f3);
	  	$worksheet1->write_number($x+$j,11,$rptnt[$i]['mm_qty'],$f3);

	}
	    
	  	$x++;
	  	$worksheet1->write_string($x+$j,0,"Total",$f5);
	  	$worksheet1->write_string($x+$j,1,'',$f5);
	 	$worksheet1->write_number($x+$j,2,$rptnt_tqty_tal,$f6);
	  	$worksheet1->write_number($x+$j,3,$rptnt_su,$f6);
	  	$worksheet1->write_number($x+$j,4,$rptnt_su_tal,$f6);
	  	for ($z=5; $z < 11; $z++) $worksheet1->write_string($x+$j,$z,'',$f5); 	
	  	$worksheet1->write_number($x+$j,11,$rptnt_qty_tal,$f6);
	  	
	
//table5 不可排程	  	
	  $j=$j+3+$x;  //計算列
	  $table1=array('','Unavailable','Schedule','List','');
      for ($i=0; $i<sizeof($table1); $i++)
      {
      	$ti=$i+5;
      	$worksheet1->write_string($j,$ti,$table1[$i],$f1);
      }
      $j++;
	  $tt1=array('Order #','ETD','ORD Q\'ty','ORD SU','Allot SU','Fab.ETA','Fab.Receive','M.ACC. ETA', 'M.ACC. Receive','Smpl APV','REMARK','Allot Qty');
	  for ($i=0; $i<sizeof($tt1); $i++)
	  {
	  	$worksheet1->write_string($j,$i,$tt1[$i],$f4);
	  }
	 $j++;
	 $i=0; $x=0;
	 if($rpt_una)
	 {	  
	  for ($i=0; $i< (sizeof($rpt_una)-1); $i++)
	  {
	  	if (isset($rpt_una[$i]['bkln']))
	  	{
	  		$rpt_una[$i]['mm_qty']=(int)$rpt_una[$i]['mm_qty'];
	  		$rpt_una[$i]['mm_su']=(int)$rpt_una[$i]['mm_su'];
	  		$worksheet1->write_string($x+$j,0,'ETD ['.$rpt_una[$i]['sub_mm'].'] subtotal');	
	  		$worksheet1->write_number($x+$j,3,$rpt_una[$i]['mm_tqty'],$f3);
	  		$worksheet1->write_number($x+$j,3,$rpt_una[$i]['mm_tsu'],$f3);
	  		$worksheet1->write_number($x+$j,4,$rpt_una[$i]['mm_su'],$f3);
	  		$worksheet1->write_number($x+$j,11,$rpt_una[$i]['mm_qty'],$f3);
	  		 $x++;
	  	}
	  	$worksheet1->write_string($x+$j,0,$rpt_una[$i]['order_num']);
	  	$worksheet1->write_string($x+$j,1,$rpt_una[$i]['etd']);
	  	if (date('Y-m-d') > $rpt_una[$i]['etd']) $worksheet1->write_string($x+$j,1,$rpt_una[$i]['etd'],$f7);
	 	$worksheet1->write_number($x+$j,2,$rpt_una[$i]['qty'],$f3);
	  	$worksheet1->write_number($x+$j,3,$rpt_una[$i]['su'],$f3);
	  	$worksheet1->write_number($x+$j,4,$rpt_una[$i]['etp_su'],$f3);
	  	$worksheet1->write_string($x+$j,5,$rpt_una[$i]['mat_etd']);
	  	if (date('Y-m-d') > $rpt_una[$i]['etd'] && ($rpt_una[$i]['mat_shp'] == '' || $rpt_una[$i]['mat_shp'] == '0000-00-00')) $worksheet1->write_string($x+$j,5,$rpt_una[$i]['mat_etd'],$f7);
	  	$worksheet1->write_string($x+$j,6,$rpt_una[$i]['mat_shp']);
	  	$worksheet1->write_string($x+$j,7,$rpt_una[$i]['m_acc_etd']);
	  	if (date('Y-m-d') > $rpt_una[$i]['m_acc_etd'] && ($rpt_una[$i]['m_acc_shp'] == '' || $rpt_una[$i]['m_acc_shp'] == '0000-00-00')) $worksheet1->write_string($x+$j,7,$rpt_una[$i]['m_acc_etd'],$f7);
	  	$worksheet1->write_string($x+$j,8,$rpt_una[$i]['m_acc_shp']);
	  	$worksheet1->write_string($x+$j,9,$rpt_una[$i]['smpl_apv']);
	  	if ($rpt_una[$i]['smpl_apv']=='0000-00-00') $rpt_una[$i]['smpl_apv']='';
	  	$worksheet1->write_string($x+$j,9,$rpt_una[$i]['smpl_apv']);
	  	if ($rpt_una[$i]['smpl_apv']=='') $worksheet1->write_string($x+$j,9,$rpt_una[$i]['smpl_apv'],$f7);
	  	$worksheet1->write_string($x+$j,10,$rpt_una[$i]['remark']);	  	
	  	$worksheet1->write_number($x+$j,11,$rpt_una[$i]['etp_qty'],$f3);
	    $x++;
	  }
	  	$rpt_una[$i]['mm_qty']=(int)$rpt_una[$i]['mm_qty'];
	  	$rpt_una[$i]['mm_su']=(int)$rpt_una[$i]['mm_su'];
	    $worksheet1->write_string($x+$j,0,'ETD ['.$rpt_una[$i]['sub_mm'].'] subtotal');	
	  	$worksheet1->write_number($x+$j,2,$rpt_una[$i]['mm_tqty'],$f3);
	  	$worksheet1->write_number($x+$j,3,$rpt_una[$i]['mm_tsu'],$f3);
	  	$worksheet1->write_number($x+$j,4,$rpt_una[$i]['mm_su'],$f3);
	  	$worksheet1->write_number($x+$j,11,$rpt_una[$i]['mm_qty'],$f3);

	}
	    
	  	$x++;
	  	$worksheet1->write_string($x+$j,0,"Total",$f5);
	  	$worksheet1->write_string($x+$j,1,'',$f5);
	 	$worksheet1->write_number($x+$j,2,$rpt_una_tqty_tal,$f6);
	  	$worksheet1->write_number($x+$j,3,$rpt_una_su,$f6);
	  	$worksheet1->write_number($x+$j,4,$rpt_una_su_tal,$f6);
	  	for ($z=5; $z < 11; $z++) $worksheet1->write_string($x+$j,$z,'',$f5);	
	  	$worksheet1->write_number($x+$j,11,$rpt_una_qty_tal,$f6);
	  	
	
	
	
	 	  	
//己核可己生產	  
	 $j=$j+$x+2; 
	  $table1=array('','Scheduled','','and','','available','','Production');
      for ($i=0; $i<sizeof($table1); $i++)
      {      	
      	$worksheet1->write_string($j,$i,$table1[$i],$f1);
      }
      $j++;
	  $tt1=array('Order #','ETD','ORD Q\'ty','Allot Q\'ty','Allot SU','Fab.ETA','Fab.Receive','M.ACC. ETA', 'M.ACC. Receive','Smpl APV','ETS','ETF','Avalb. Q\'ty','Avalb. SU','Pd');
	  for ($i=0; $i<sizeof($tt1); $i++)
	  {
	  	$worksheet1->write_string($j,$i,$tt1[$i],$f4);
	  }
	 $j++;
	 $i=0;
	 $x=0;
	 if($rptdo)
	 {	  
	  for ($i=0; $i< (sizeof($rptdo)-1); $i++)
	  {
	  	if (isset($rptdo[$i]['bkln']))
	  	{
	  		$rptdo[$i]['tal_s_unqty']=((int)$rptdo[$i]['tal_s_unqty']);
			$rptdo[$i]['tal_s_unsu']=((int)$rptdo[$i]['tal_s_unsu']);
	  		$worksheet1->write_string($x+$j,0,'ETD ['.$rptdo[$i]['sub_mm'].'] subtotal(S)');	
	  		$worksheet1->write_number($x+$j,2,$rptdo[$i]['mm_s_tqty'],$f3);
	  		$worksheet1->write_number($x+$j,3,$rptdo[$i]['mm_s_qty'],$f3);
	  		$worksheet1->write_number($x+$j,4,$rptdo[$i]['mm_s_su'],$f3);
	  		$worksheet1->write_string($x+$j,13,'ETD ['.$rptdo[$i]['sub_mm'].'] Available Production : '.$rptdo[$i]['tal_s_unqty'].'(PCS)     '.$rptdo[$i]['tal_s_unsu'].'(SU)',$f3);
	  		 $x++;
	  	    
	  	    $rptdo[$i]['tal_i_unqty']=((int)$rptdo[$i]['tal_i_unqty']);
			$rptdo[$i]['tal_i_unsu']=((int)$rptdo[$i]['tal_i_unsu']);
	  		$worksheet1->write_string($x+$j,0,'ETD ['.$rptdo[$i]['sub_mm'].'] subtotal(I)');	
	  		$worksheet1->write_number($x+$j,2,$rptdo[$i]['mm_i_tqty'],$f3);
	  		$worksheet1->write_number($x+$j,3,$rptdo[$i]['mm_i_qty'],$f3);
	  		$worksheet1->write_number($x+$j,4,$rptdo[$i]['mm_i_su'],$f3);
	  		$worksheet1->write_string($x+$j,13,'ETD ['.$rptdo[$i]['sub_mm'].'] Available Production : '.$rptdo[$i]['tal_i_unqty'].'(PCS)     '.$rptdo[$i]['tal_i_unsu'].'(SU)',$f3);
	  		 $x++;
	  		
	  		$rptdo[$i]['tal_unqty']=((int)$rptdo[$i]['tal_unqty']);
			$rptdo[$i]['tal_unsu']=((int)$rptdo[$i]['tal_unsu']);
	  		$worksheet1->write_string($x+$j,0,'ETD ['.$rptdo[$i]['sub_mm'].'] subtotal');	
	  		$worksheet1->write_number($x+$j,2,$rptdo[$i]['mm_tqty'],$f3);	  		
	  		$worksheet1->write_number($x+$j,3,$rptdo[$i]['mm_qty'],$f3);
	  		$worksheet1->write_number($x+$j,4,$rptdo[$i]['mm_su'],$f3);
	  		$worksheet1->write_string($x+$j,13,'ETD ['.$rptdo[$i]['sub_mm'].'] Available Production : '.$rptdo[$i]['tal_unqty'].'(PCS)     '.$rptdo[$i]['tal_unsu'].'(SU)',$f3);
	  		 $x++;
	  	}
	  	$worksheet1->write_string($x+$j,0,$rptdo[$i]['order_num']);
	  	$worksheet1->write_string($x+$j,1,$rptdo[$i]['etd']);
	 	$worksheet1->write_number($x+$j,2,$rptdo[$i]['qty'],$f3);
	  	$worksheet1->write_number($x+$j,3,$rptdo[$i]['fty_qty'],$f3);
	  	$worksheet1->write_number($x+$j,4,$rptdo[$i]['fty_su'],$f3);
	  	$worksheet1->write_string($x+$j,5,$rptdo[$i]['mat_etd']);
	  	$worksheet1->write_string($x+$j,6,$rptdo[$i]['mat_shp']);
	  	$worksheet1->write_string($x+$j,7,$rptdo[$i]['m_acc_etd']);
	  	$worksheet1->write_string($x+$j,8,$rptdo[$i]['m_acc_shp']);
	  	if ($rptdo[$i]['smpl_apv']=='0000-00-00') $rptdo[$i]['smpl_apv']='';
	  	$worksheet1->write_string($x+$j,9,$rptdo[$i]['smpl_apv']);
	  	$worksheet1->write_string($x+$j,10,$rptdo[$i]['ets']);
	  	$worksheet1->write_string($x+$j,11,$rptdo[$i]['etf']);
	  	$worksheet1->write_number($x+$j,12,$rptdo[$i]['un_qty'],$f3);
	  	$worksheet1->write_number($x+$j,13,$rptdo[$i]['un_su'],$f3);
	  	if ($rptdo[$i]['sub_con'] == 0)
	  	{
	  		$worksheet1->write_string($x+$j,14,'In House');
	  	}else{
	  		$worksheet1->write_string($x+$j,14,'Sub-con.');
		}	   
	  
	    $x++;
	  }		
  		
  		$rptdo[$i]['tal_s_unqty']=((int)$rptdo[$i]['tal_s_unqty']);
		$rptdo[$i]['tal_s_unsu']=((int)$rptdo[$i]['tal_s_unsu']);
	  	$worksheet1->write_string($x+$j,0,'ETD ['.$rptdo[$i]['sub_mm'].'] subtotal(S)');	
	  	$worksheet1->write_number($x+$j,2,$rptdo[$i]['mm_s_tqty'],$f3);
	  	$worksheet1->write_number($x+$j,3,$rptdo[$i]['mm_s_qty'],$f3);
	  	$worksheet1->write_number($x+$j,4,$rptdo[$i]['mm_s_su'],$f3);
	  	$worksheet1->write_string($x+$j,13,'ETD ['.$rptdo[$i]['sub_mm'].'] Available Production : '.$rptdo[$i]['tal_s_unqty'].'(PCS)     '.$rptdo[$i]['tal_s_unsu'].'(SU)',$f3);

	  	$x++;	  	    
	  	$rptdo[$i]['tal_i_unqty']=((int)$rptdo[$i]['tal_i_unqty']);
		$rptdo[$i]['tal_i_unsu']=((int)$rptdo[$i]['tal_i_unsu']);
	  	$worksheet1->write_string($x+$j,0,'ETD ['.$rptdo[$i]['sub_mm'].'] subtotal(I)');	
	  	$worksheet1->write_number($x+$j,2,$rptdo[$i]['mm_i_tqty'],$f3);
	  	$worksheet1->write_number($x+$j,3,$rptdo[$i]['mm_i_qty'],$f3);
	  	$worksheet1->write_number($x+$j,4,$rptdo[$i]['mm_i_su'],$f3);
	  	$worksheet1->write_string($x+$j,13,'ETD ['.$rptdo[$i]['sub_mm'].'] Available Production : '.$rptdo[$i]['tal_i_unqty'].'(PCS)     '.$rptdo[$i]['tal_i_unsu'].'(SU)',$f3);  	
		
		$x++;
	  	$rptdo[$i]['tal_unqty']=((int)$rptdo[$i]['tal_unqty']);
		$rptdo[$i]['tal_unsu']=((int)$rptdo[$i]['tal_unsu']);
	    $worksheet1->write_string($x+$j,0,'ETD ['.$rptdo[$i]['sub_mm'].'] subtotal');	
	  	$worksheet1->write_number($x+$j,2,$rptdo[$i]['mm_tqty'],$f3);
	  	$worksheet1->write_number($x+$j,3,$rptdo[$i]['mm_qty'],$f3);
	  	$worksheet1->write_number($x+$j,4,$rptdo[$i]['mm_su'],$f3);
  		$worksheet1->write_string($x+$j,13,'ETD ['.$rptdo[$i]['sub_mm'].'] Available Production : '.$rptdo[$i]['tal_unqty'].'(PCS)     '.$rptdo[$i]['tal_unsu'].'(SU)',$f3);
	
	}
	  	$x++;
	  	$rptdo_s_un_qty=(int)$rptdo_s_un_qty;
	  	$rptdo_s_un_su=(int)$rptdo_s_un_su;
	  	$worksheet1->write_string($x+$j,0,"Total",$f5);
	  	$worksheet1->write_string($x+$j,1,'(Sub-con.)',$f5);
	 	$worksheet1->write_number($x+$j,2,$rptdo_s_tqty_tal,$f6);
	  	$worksheet1->write_number($x+$j,3,$rptdo_s_qty_tal,$f6);
	  	$worksheet1->write_number($x+$j,4,$rptdo_s_su_tal,$f6);
		for ($z=5; $z < 10; $z++) $worksheet1->write_string($x+$j,$z,'',$f5);
	  	$worksheet1->write_string($x+$j,10,'Available Production : '.$rptdo_s_un_qty.'(PCS)     '.$rptdo_s_un_su.'(SU)');	  	

	  	$x++;
	  	$rptdo_i_un_qty=(int)$rptdo_i_un_qty;
	  	$rptdo_i_un_su=(int)$rptdo_i_un_su;
	  	$worksheet1->write_string($x+$j,0,"Total",$f5);
	  	$worksheet1->write_string($x+$j,1,'(In House)',$f5);
	 	$worksheet1->write_number($x+$j,2,$rptdo_i_tqty_tal,$f6);
	  	$worksheet1->write_number($x+$j,3,$rptdo_i_qty_tal,$f6);
	  	$worksheet1->write_number($x+$j,4,$rptdo_i_su_tal,$f6);
	  	for ($z=5; $z < 10; $z++) $worksheet1->write_string($x+$j,$z,'',$f5);
	  	$worksheet1->write_string($x+$j,10,'Available Production : '.$rptdo_i_un_qty.'(PCS)     '.$rptdo_i_un_su.'(SU)');	  	

	  	$x++;
	  	$rptdo_un_qty=(int)$rptdo_un_qty;
	  	$rptdo_un_su=(int)$rptdo_un_su;
	  	$worksheet1->write_string($x+$j,0,"Total",$f5);
	  	$worksheet1->write_string($x+$j,1,'',$f5);
	 	$worksheet1->write_number($x+$j,2,$rptdo_tqty_tal,$f6);
	  	$worksheet1->write_number($x+$j,3,$rptdo_qty_tal,$f6);
	  	$worksheet1->write_number($x+$j,4,$rptdo_su_tal,$f6);
	  	for ($z=5; $z < 10; $z++) $worksheet1->write_string($x+$j,$z,'',$f5);
	  	$worksheet1->write_string($x+$j,10,'Available Production : '.$rptdo_un_qty.'(PCS)     '.$rptdo_un_su.'(SU)');	  	

  $workbook->close();
}
break;



//====================================================
case "rep_oscust_list":
	check_authority('072',"view");
	if (!$PHP_year1) $PHP_year1 = date('Y');

	$rpt=$report->cust_os_search($PHP_year1);  //取出記錄
	for ($i=0; $i<sizeof($rpt); $i++) //計算每個客人的年度總量
	{
		$rpt[$i]['ord_total']=0;
		$rpt[$i]['ord_qty_tal']=0;	
		$rpt[$i]['ord_fob_tal']=0;
		$rpt[$i]['smpl_total']=0;
		$rpt[$i]['smpl_qty_tal']=0;	
		for ($j=0; $j < 12; $j++)
		{
			if (isset($rpt[$i]['order'][$j])){$rpt[$i]['ord_total']=$rpt[$i]['ord_total']+$rpt[$i]['order'][$j];}else{$rpt[$i]['order'][$j]=0;}
			if (isset($rpt[$i]['smpl'][$j])){$rpt[$i]['smpl_total']=$rpt[$i]['smpl_total']+$rpt[$i]['smpl'][$j];}else{$rpt[$i]['smpl'][$j]=0;}	
			if (isset($rpt[$i]['ord_qty'][$j])){$rpt[$i]['ord_qty_tal']=$rpt[$i]['ord_qty_tal']+$rpt[$i]['ord_qty'][$j];}else{$rpt[$i]['ord_qty'][$j]=0;}
			if (isset($rpt[$i]['ord_fob'][$j])){$rpt[$i]['ord_fob_tal'] += $rpt[$i]['ord_fob'][$j];}else{$rpt[$i]['ord_fob'][$j]=0;}
			if (isset($rpt[$i]['smpl_qty'][$j])){$rpt[$i]['smpl_qty_tal']=$rpt[$i]['smpl_qty_tal']+$rpt[$i]['smpl_qty'][$j];}else{$rpt[$i]['smpl_qty'][$j]=0;}
		}
		if($rpt[$i]['ord_qty_tal']>0) $rpt[$i]['ord_a_fob'] = $rpt[$i]['ord_fob_tal'] / $rpt[$i]['ord_qty_tal'];
		
	}
	$rpt_tal=$report->os_tal_search($PHP_year1); //計算所有訂單/樣本單每月總量
	$op['ord_total']=0;	$op['ord_qty_tal']=0; $op['smpl_total']=0; $op['smpl_qty_tal']=0;		
	for ($i=0; $i<sizeof($rpt_tal); $i++)
	{
		$op['ord_total']=$op['ord_total']+$rpt_tal[$i]['order'];
		$op['ord_qty_tal']=$op['ord_qty_tal']+$rpt_tal[$i]['ord_qty'];
		$op['smpl_total']=$op['smpl_total']+$rpt_tal[$i]['smpl'];
		$op['smpl_qty_tal']=$op['smpl_qty_tal']+$rpt_tal[$i]['smpl_qty'];		
	}
	$op['rpt']=$rpt;
	$op['rpt_tal']=$rpt_tal;
	$op['year']=$PHP_year1;
	page_display($op,'072', $TPL_CUST_OS);
break;


//====================================================
case "rep_smplcust_list":
	check_authority('072',"view");
	if (!$PHP_year1) $PHP_year1 = date('Y');
	$mm = array('01','02','03','04','05','06','07','08','09','10','11','12');
	$rpt=$report->cust_os_search($PHP_year1);  //取出記錄
	for ($i=0; $i<sizeof($rpt); $i++) //計算每個客人的年度總量
	{
		$rpt[$i]['smpl_qty_tal']=0;	
		for ($j=0; $j < 12; $j++)
		{
			if (isset($rpt[$i]['smpl_qty'][$j])){$rpt[$i]['smpl_qty_tal']=$rpt[$i]['smpl_qty_tal']+$rpt[$i]['smpl_qty'][$j];}else{$rpt[$i]['smpl_qty'][$j]=0;}
		}
		$rpt[$i]['sort']=$rpt[$i]['smpl_qty_tal'];
	}
	$rpt=bubble_sort($rpt);
	
	$rpt_tal=$report->os_tal_search($PHP_year1); //計算所有訂單/樣本單每月總量
	$op['smpl_qty_tal']=0;		
	for ($i=0; $i<sizeof($rpt_tal); $i++)
	{
		$op['smpl_qty_tal']=$op['smpl_qty_tal']+$rpt_tal[$i]['smpl_qty'];		
	}
	
	$rpt_done=$report->un_done_sample($PHP_year1);
	$op['done_qty_tal']=0;
	for ($i=0; $i<sizeof($rpt_done); $i++)
	{
		
		$op['done_qty_tal']=$op['done_qty_tal']+$rpt_done[$i]['qty_undo'];
		$rpt_done[$i]['mm']=$mm[$i];
	}
	
	$op['rpt']=$rpt;
	$op['rpt_tal']=$rpt_tal;
	$op['rpt_done']=$rpt_done;
	$op['year']=$PHP_year1;
	page_display($op,'072', $TPL_SMPL_CUST);
break;


//====================================================
case "un_qty_monthy":
	check_authority('072',"view");
	
	$mm = array('01','02','03','04','05','06','07','08','09','10','11','12');
	$rpt=$report->qty_unfinsh_searche($PHP_year,$PHP_mm);  //取出記錄
	$op['un_qty_tal']=$op['qty_tal']=0;
	for ($i=0; $i<sizeof($rpt); $i++)
	{
		$rpt[$i]['qty_d']=$rpt[$i]['qty']-$rpt[$i]['qty_done'];
		$op['un_qty_tal']=$op['un_qty_tal']+$rpt[$i]['qty_d'];
		$op['qty_tal']=$op['qty_tal']+$rpt[$i]['qty_d'];
	}

	
	$op['ord']=$rpt;
	$op['year']=$PHP_year;
	$op['mm']="MONTH : <span class=sign><b>{$PHP_mm}</b>";
	$op['today']=$TODAY;
	page_display($op,'072', $TPL_UNFINISH_SAMPLE);
break;

//====================================================
case "cust_smpl_qty":
	check_authority('072',"view");
	
	$rpt=$report->cust_smplqty_searche($PHP_year,$PHP_cust);  //取出記錄	
	$tmp=substr($rpt[0]['open_date'],0,7);	
	$op['un_qty_tal']=$op['qty_tal']=0;
	
	for ($i=0; $i<sizeof($rpt); $i++)
	{
		if (substr($rpt[$i]['open_date'],0,7) <> $tmp)
		{			
			$rpt[$i]['bk_ln']=1;
			$tmp=substr($rpt[$i]['open_date'],0,7);
		}
		$rpt[$i]['qty_d']=$rpt[$i]['qty']-$rpt[$i]['qty_done'];
		if( $rpt[$i]['qty_d'] < 0 || $rpt[$i]['status']==10)$rpt[$i]['qty_d']=0;
		$op['un_qty_tal']=$op['un_qty_tal']+$rpt[$i]['qty_d'];
		$op['qty_tal']=$op['qty_tal']+$rpt[$i]['qty'];
	}

	
	$op['ord']=$rpt;
	$op['year']=$PHP_year;
	$op['mm']="Customer : <span class=sign><b>{$PHP_cust}</b>";
	$op['today']=$TODAY;
	page_display($op,'072', $TPL_UNFINISH_SAMPLE);
break;

//====================================================
case "rep_day_count":
	check_authority('072',"view");
	if (!$PHP_year1)$PHP_year1=date('Y');
	$search_day=$PHP_year1;
	$rpt=$report->order_day_list($search_day);  //取出記錄	
	$tmp=$rpt[0]['cust'];
	$rlt[0]['mk_cust']=$rpt[0]['cust_init'];
	$rlt[0]['cust']=$rpt[0]['cust'];
	
	$apv=0; $avl=0; $x=0; $y=0;
	$rlt[$y]['avi_days']=0;	$rlt[$y]['apv_days'] = 0;	$rlt[$y]['open_days'] =0;
	$rlt[$y]['qty'] = 0;	$rlt[$y]['su'] = 0;
	if ($rpt)
	{
		for ($i=0; $i<sizeof($rpt); $i++)
		{
			if ($tmp<>$rpt[$i]['cust'])
			{
				if ($avl > 0) $rlt[$y]['avi_days'] = (int)($rlt[$y]['avi_days'] / $avl);
				if ($apv > 0) $rlt[$y]['apv_days'] = (int)($rlt[$y]['apv_days'] / $apv);
				if ($x > 0) $rlt[$y]['open_days']  = (int)($rlt[$y]['open_days'] / $x);
				if ($x > 0) $rlt[$y]['avg_qty']        = (int)($rlt[$y]['qty'] / $x);
				if ($x > 0) $rlt[$y]['avg_su']         = (int)($rlt[$y]['su'] / $x);
				$rlt[$y]['sort']=$rlt[$y]['avi_days'];
				$tmp_y=$y;				
				$tmp=$rpt[$i]['cust'];
				$y++;
				$rlt[$y]['mk_cust']=$rpt[$i]['cust_init'];
				$rlt[$y]['cust']=$rpt[$i]['cust'];
				$apv=0; $avl=0; $x=0;
				$rlt[$y]['avi_days']=0;	$rlt[$y]['apv_days'] = 0;	$rlt[$y]['open_days'] =0;
				$rlt[$y]['qty'] = 0;	$rlt[$y]['su'] = 0;
			}
			
			$open_day=countDays($rpt[$i]['opendate'],$rpt[$i]['etd']);
			$rlt[$y]['open_days']=$rlt[$y]['open_days']+$open_day;
			$rlt[$y]['qty']=$rlt[$y]['qty']+$rpt[$i]['qty'];
			$rlt[$y]['su']=$rlt[$y]['su']+$rpt[$i]['su'];	
			
			$x++;
			if ($rpt[$i]['apv_date'] <> '0000-00-00')
			{
				$rlt[$y]['apv_days']=$rlt[$y]['apv_days']+countDays($rpt[$i]['apv_date'],$rpt[$i]['etd']);
				$apv++;
			}
			
			if ($rpt[$i]['mat_shp']<>'' && $rpt[$i]['m_acc_shp']<>'' && $rpt[$i]['smpl_apv'] <>'0000-00-00')
			{
				$tmp1=$rpt[$i]['mat_shp'];
				if ($rpt[$i]['m_acc_shp'] > $tmp1)$tmp1=$rpt[$i]['m_acc_shp'];
				if ($rpt[$i]['smpl_apv'] > $tmp1)$tmp1=$rpt[$i]['smpl_apv'];
				$rpt[$i]['avi_date']=$tmp1;
				$rlt[$y]['avi_days']=$rlt[$y]['avi_days']+countDays($rpt[$i]['avi_date'],$rpt[$i]['etd']);
				$avl++;
			}
			

			
		}
		if ($tmp_y <> $y)
		{
				if ($avl > 0) $rlt[$y]['avi_days'] = (int)($rlt[$y]['avi_days'] / $avl);
				if ($apv > 0) $rlt[$y]['apv_days'] = (int)($rlt[$y]['apv_days'] / $apv);
				if ($x > 0) $rlt[$y]['open_days']  = (int)($rlt[$y]['open_days'] / $x);
				if ($x > 0) $rlt[$y]['avg_qty']        = (int)($rlt[$y]['qty'] / $x);
				if ($x > 0) $rlt[$y]['avg_su']         = (int)($rlt[$y]['su'] / $x);
				$rlt[$y]['sort']=$rlt[$y]['avi_days'];
		}
	}else{
		$op['msg']="Without any records";
	}
	
	$rlt=bubble_sort($rlt);
	$op['ord']=$rlt;
	$op['year']=$PHP_year1;
	$op['today']=$TODAY;
	if (!isset($PHP_excel))
	{
		page_display($op,'072', $TPL_RPT_ORD_COUNT);
		break;
	}else{
	 require_once($config['root_dir']."/lib/spreadsheets/Worksheet.php");
	 require_once($config['root_dir']."/lib/spreadsheets/Workbook.php");

	  function HeaderingExcel($filename) {
		  header("Content-type: application/vnd.ms-excel");
		  header("Content-Disposition: attachment; filename=$filename" );
		  header("Expires: 0");
		  header("Cache-Control: must-revalidate, post-check=0,pre-check=0");
		  header("Pragma: public");
		  }

	  // HTTP headers
	  HeaderingExcel('ord_count.xls');
	 
	  // Creating a workbook
	  $workbook = new Workbook("-");

	  // Creating the first worksheet
	  $worksheet1 =& $workbook->add_worksheet('ORDER Lead-Time Analysis');

		$now = $GLOBALS['THIS_TIME'];

	// 寫入 title

	  $formatot =& $workbook->add_format();
	  $formatot->set_size(10);
	  $formatot->set_align('center');
	  $formatot->set_color('white');
	  $formatot->set_pattern(1);
	  $formatot->set_fg_color('navy');
	  $formatot->set_num_format(4);
	 
	  $f3 =& $workbook->add_format(); //置右
	  $f3->set_size(10);
	  $f3->set_align('right');
	  $f3->set_num_format(3);
	  

	  $clumn = array(10,14,14,20,20,20);
	  $title = array('customer', 'QTY', 'SU', 'Open Lead-Time', 'APV Lead-Time', 'In House Lead-Time');
	  for ($i=0; $i< sizeof($clumn); $i++)  //設格子
	  {
	  	$worksheet1->set_column(0,$i,$clumn[$i]);
	  }
	  $worksheet1->write_string(0,1,'ORDER Lead-Time Analysis by customer');
	  $worksheet1->write_string(0,4,$TODAY);
	  for ($i=0; $i< sizeof($title); $i++)  //標題
	  {
	  	$worksheet1->write_string(1,$i,$title[$i],$formatot);
	  }
	  	  	  
	  $j=2;
	  for ($i=0; $i< sizeof($rlt); $i++)
	  {
	  	$worksheet1->write_string($j,0,$rlt[$i]['mk_cust']);
	  	$worksheet1->write_number($j,1,$rlt[$i]['qty'],$f3);
	  	$worksheet1->write_number($j,2,$rlt[$i]['su'],$f3);
	  	$worksheet1->write_number($j,3,$rlt[$i]['open_days'],$f3);
	  	$worksheet1->write_number($j,4,$rlt[$i]['apv_days'],$f3);
	  	$worksheet1->write_number($j,5,$rlt[$i]['avi_days'],$f3);
	  	$j++;
	  }

  	  $workbook->close();
	break;
		
	}


//====================================================
case "rep_day_count_excel":
	check_authority('072',"view");
	if (!$PHP_year1)$PHP_year1=date('Y');
	$search_day=$PHP_year1;
	$rpt=$report->order_day_list($search_day);  //取出記錄	
	$tmp=$rpt[0]['cust'];
	
	$apv=0; $avl=0; $x=0; $y=0;
	$avi_days=0;	$apv_days = 0;	$open_days =0;	$qty = 0;	$su = 0;
	if ($rpt)
	{
		for ($i=0; $i<sizeof($rpt); $i++)
		{
			if ($tmp<>$rpt[$i]['cust'])
			{
				$j=$i-1;
				$rpt[$j]['tal_avi_days'] = (int)($avi_days);
				$rpt[$j]['tal_apv_days'] = (int)($apv_days);
				$rpt[$j]['tal_open_days']= (int)($open_days);
				$rpt[$j]['tal_qty']      = (int)($qty);
				$rpt[$j]['tal_su']       = (int)($su);
				
				$rpt[$j]['avg_avi_days']=$rpt[$j]['avg_apv_days']=0;
				if ($avl > 0) $rpt[$j]['avg_avi_days'] = (int)($avi_days / $avl);
				if ($apv > 0) $rpt[$j]['avg_apv_days'] = (int)($apv_days / $apv);
				if ($x > 0)   $rpt[$j]['avg_open_days']= (int)($open_days / $x);
				if ($x > 0)   $rpt[$j]['avg_qty']      = (int)($qty / $x);
				if ($x > 0)   $rpt[$j]['avg_su']       = (int)($su / $x);
				$rpt[$j]['bl']=1;				
				
				$tmp=$rpt[$i]['cust'];							
				$apv=0; $avl=0; $x=0;
				$avi_days=0;	$apv_days = 0;	$open_days =0;
				$qty = 0;	$su = 0;
			}			
			$rpt[$i]['open_days'] = countDays($rpt[$i]['opendate'],$rpt[$i]['etd']);
			$open_days=$open_days+$rpt[$i]['open_days'];			
			$qty=$qty+$rpt[$i]['qty'];
			$su=$su+$rpt[$i]['su'];	
			$x++;
			
			$rpt[$i]['apv_days']='';
			if ($rpt[$i]['apv_date'] <> '0000-00-00')
			{
				$rpt[$i]['apv_days'] = countDays($rpt[$i]['apv_date'],$rpt[$i]['etd']);
				$apv_days=$apv_days+$rpt[$i]['apv_days'];
				$apv++;
			}
			
			$rpt[$i]['avi_date']=$rpt[$i]['avi_days']='';
			if ($rpt[$i]['mat_shp']<>'' && $rpt[$i]['m_acc_shp']<>'' && $rpt[$i]['smpl_apv'] <>'0000-00-00')
			{
				$tmp1=$rpt[$i]['mat_shp'];
				if ($rpt[$i]['m_acc_shp'] > $tmp1)$tmp1=$rpt[$i]['m_acc_shp'];
				if ($rpt[$i]['smpl_apv'] > $tmp1)$tmp1=$rpt[$i]['smpl_apv'];
				$rpt[$i]['avi_date']=$tmp1;
				$rpt[$i]['avi_days'] = countDays($rpt[$i]['avi_date'],$rpt[$i]['etd']);
				$avi_days=$avi_days+$rpt[$i]['avi_days'];
				$avl++;
			}		
		}
		$j=$i-1;
		$rpt[$j]['tal_avi_days'] = (int)($avi_days);
		$rpt[$j]['tal_apv_days'] = (int)($apv_days);
		$rpt[$j]['tal_open_days']= (int)($open_days);
		$rpt[$j]['tal_qty']      = (int)($qty);
		$rpt[$j]['tal_su']       = (int)($su);
				
		$rpt[$j]['avg_avi_days']=$rpt[$j]['avg_apv_days']=0;
		if ($avl > 0) $rpt[$j]['avg_avi_days'] = (int)($avi_days / $avl);
		if ($apv > 0) $rpt[$j]['avg_apv_days'] = (int)($apv_days / $apv);
		if ($x > 0)   $rpt[$j]['avg_open_days']= (int)($open_days / $x);
		if ($x > 0)   $rpt[$j]['avg_qty']      = (int)($qty / $x);
		if ($x > 0)   $rpt[$j]['avg_su']       = (int)($su / $x);
		$rpt[$j]['bl']=1;				
	}else{
		$op['msg']="Without any records";
	}

	
	 require_once($config['root_dir']."/lib/spreadsheets/Worksheet.php");
	 require_once($config['root_dir']."/lib/spreadsheets/Workbook.php");

	  function HeaderingExcel($filename) {
		  header("Content-type: application/vnd.ms-excel");
		  header("Content-Disposition: attachment; filename=$filename" );
		  header("Expires: 0");
		  header("Cache-Control: must-revalidate, post-check=0,pre-check=0");
		  header("Pragma: public");
		  }

	  // HTTP headers
	  HeaderingExcel('ord_count_det.xls');
	 
	  // Creating a workbook
	  $workbook = new Workbook("-");

	  // Creating the first worksheet
	  $worksheet1 =& $workbook->add_worksheet('ORDER Lead-Time Analysis');

		$now = $GLOBALS['THIS_TIME'];

	// 寫入 title

	  $formatot =& $workbook->add_format();
	  $formatot->set_size(10);
	  $formatot->set_align('center');
	  $formatot->set_color('white');
	  $formatot->set_pattern(1);
	  $formatot->set_fg_color('navy');
	  $formatot->set_num_format(4);
	  
	  $f3 =& $workbook->add_format(); //置右
	  $f3->set_size(10);
	  $f3->set_align('right');
	  $f3->set_num_format(3);
	  
	  $f5 =& $workbook->add_format();  //灰底白字置中
	  $f5->set_size(10);
	  $f5->set_align('center');
	  $f5->set_color('white');
	  $f5->set_pattern(1);
	  $f5->set_fg_color('grey');
	  
	  $f6 =& $workbook->add_format();  //灰底白字置右
	  $f6->set_size(10);
	  $f6->set_color('white');
	  $f6->set_pattern(1);
	  $f6->set_align('right');
	  $f6->set_num_format(3);
	  $f6->set_fg_color('grey');

	  $clumn = array(10,10,10,10,10,12,10,12,10,12,10);
	  $title = array('customer','order #','ETD','QTY', 'SU', 'Open date','OPN-Ld.T', 'APV date','APV-Ld.T','InH date', 'InH-Ld.T');
	  for ($i=0; $i< sizeof($clumn); $i++)
	  {
	  	$worksheet1->set_column(0,$i,$clumn[$i]);
	  }
	  $worksheet1->write_string(0,1,'ORDER Lead-Time Analysis by customer');
	  $worksheet1->write_string(0,10,$TODAY);
	  for ($i=0; $i< sizeof($title); $i++)
	  {
	  	$worksheet1->write_string(1,$i,$title[$i],$formatot);
	  }
	  	  	  
	  $j=2;
	  for ($i=0; $i< sizeof($rpt); $i++)
	  {	  	
	  	$worksheet1->write_string($j,0,$rpt[$i]['cust_init']);
	  	$worksheet1->write_string($j,1,$rpt[$i]['ord_num']);
	  	$worksheet1->write_string($j,2,$rpt[$i]['etd']);
	  	$worksheet1->write_number($j,3,$rpt[$i]['qty'],$f3);
	  	$worksheet1->write_number($j,4,$rpt[$i]['su'],$f3);
	  	$worksheet1->write_string($j,5,$rpt[$i]['opendate']);
	  	$worksheet1->write_number($j,6,$rpt[$i]['open_days'],$f3);
	  	$worksheet1->write_string($j,7,$rpt[$i]['apv_date']);
	  	$worksheet1->write_number($j,8,$rpt[$i]['apv_days'],$f3);
	  	$worksheet1->write_string($j,9,$rpt[$i]['avi_date']);
	  	$worksheet1->write_number($j,10,$rpt[$i]['avi_days'],$f3);
	  	$j++;
	  	if (isset($rpt[$i]['bl']))
	  	{
	  		$worksheet1->write_string($j,0,'Total');
	  		$worksheet1->write_string($j,1,$rpt[$i]['cust_init']);
	  		$worksheet1->write_number($j,3,$rpt[$i]['tal_qty'],$f3);
	  		$worksheet1->write_number($j,4,$rpt[$i]['tal_su'],$f3);
	  		$worksheet1->write_number($j,6,$rpt[$i]['tal_open_days'],$f3);
	  		$worksheet1->write_number($j,8,$rpt[$i]['tal_apv_days'],$f3);
	  		$worksheet1->write_number($j,10,$rpt[$i]['tal_avi_days'],$f3);
	  		$j++;
	  		
	  		$worksheet1->write_string($j,0,'Average',$f5);
	  		$worksheet1->write_string($j,1,$rpt[$i]['cust_init'],$f5);
	  		$worksheet1->write_string($j,2,'',$f5);
			$worksheet1->write_number($j,3,$rpt[$i]['avg_qty'],$f6);
	  		$worksheet1->write_number($j,4,$rpt[$i]['avg_su'],$f6);
	  		$worksheet1->write_string($j,5,'',$f5);
	  		$worksheet1->write_number($j,6,$rpt[$i]['avg_open_days'],$f6);
	  		$worksheet1->write_string($j,7,'',$f5);
	  		$worksheet1->write_number($j,8,$rpt[$i]['avg_apv_days'],$f6);
	  		$worksheet1->write_string($j,9,'',$f5);
	  		$worksheet1->write_number($j,10,$rpt[$i]['avg_avi_days'],$f6);
	  		$j=$j+2;
	  	}
	  }

  	  $workbook->close();
	break;
		
	

//====================================================
case "ord_count_det":
	check_authority('072',"view");

	$rpt=$report->order_cust_day_list($PHP_year, $PHP_cust);  //取出記錄	
	$mk=explode('-',$rpt[0]['etd']);
	$open_days=0;	$apv_days=0;	$avi_days=0; $qty=0; $su=0; $apv=0; $avl=0; $x=0;
	if ($rpt)
	{
		for ($i=0; $i<sizeof($rpt); $i++)
		{
			$tmp=explode('-',$rpt[$i]['etd']);
			if ($mk[1]<>$tmp[1])
			{
				$mk[1]=$tmp[1];
				$rpt[$i]['bk']=1;
			}
			
			$rpt[$i]['open_days']=countDays($rpt[$i]['opendate'],$rpt[$i]['etd']);
			$open_days=$open_days+$rpt[$i]['open_days'];
			$qty=$qty+$rpt[$i]['qty'];
			$su=$su+$rpt[$i]['su'];	
			$x++;
			if ($rpt[$i]['apv_date'] <> '0000-00-00')
			{
				$rpt[$i]['apv_days']=countDays($rpt[$i]['apv_date'],$rpt[$i]['etd']);
				$apv_days=$apv_days+$rpt[$i]['apv_days'];
				$apv++;
			}
			
			if ($rpt[$i]['mat_shp']<>'' && $rpt[$i]['m_acc_shp']<>'' && $rpt[$i]['smpl_apv'] <>'0000-00-00')
			{
				$tmp1=$rpt[$i]['mat_shp'];
				if ($rpt[$i]['m_acc_shp'] > $tmp1)$tmp1=$rpt[$i]['m_acc_shp'];
				if ($rpt[$i]['smpl_apv'] > $tmp1)$tmp1=$rpt[$i]['smpl_apv'];
				$rpt[$i]['avi_date']=$tmp1;
				$rpt[$i]['avi_days']=countDays($rpt[$i]['avi_date'],$rpt[$i]['etd']);
				$avi_days=$avi_days+$rpt[$i]['avi_days'];
				$avl++;
			}
			

			
		}
		$avg_apv_days=$avg_avi_days=0;
		$avg_open_days=(int)($open_days/$x);
		$avg_qty=(int)($qty/$x);
		$avg_su=(int)($su/$x);
		if ($apv > 0)$avg_apv_days=(int)($apv_days/$apv);
		if ($avl > 0) $avg_avi_days=(int)($avi_days/$avl);
	}else{
		$op['msg']="Without any records";
	}

	
	$op['ord']=$rpt;
	$op['year']=$PHP_year;	$op['cust']=$PHP_cust_ini;
	$op['open_days']=$open_days;	$op['apv_days']=$apv_days;	$op['avi_days']=$avi_days;
	$op['qty']=$qty;	$op['su']=$su;
	$op['avg_open_days']=$avg_open_days;
	$op['avg_apv_days']=$avg_apv_days;
	$op['avg_avi_days']=$avg_avi_days;
	$op['avg_qty']=$avg_qty;
	$op['avg_su']=$avg_su;
	$op['today']=$TODAY;
	page_display($op,'072', $TPL_RPT_ORD_COUNT_DET);
break;


//====================================================
case "rpt_smpl_use_count":
	check_authority('072',"view");
	$alt_value['valid_smpl'] *= -1;
	$search_day = increceDaysInDate($TODAY,$alt_value['valid_smpl']);
	$rpt=$report->smpl_use_search($search_day);
	$j=0;
	$vail =0;
	$tmp_str=$tmp_num='';

	$rlt[0]['cust']=$rpt[0]['cust'];
	$rlt[0]['cust_i']=$rpt[0]['cust_init'];
	$tmp_num='';$tmp_ord='';
	$rlt[0]['smpl']=0;	$rlt[0]['s_qty']=0;	$rlt[0]['use']=0;	$rlt[0]['use_qty']=0;	$rlt[0]['ord']=0;	$rlt[0]['ord_qty']=0;
	for ($i=0; $i<sizeof($rpt); $i++)
	{
		if ($rlt[$j]['cust'] <> $rpt[$i]['cust'])
		{
			$j++;
			$tmp_num='';$tmp_ord='';
			$rlt[$j]['smpl']=0;	$rlt[$j]['s_qty']=0;	$rlt[$j]['use']=0;	$rlt[$j]['use_qty']=0;	$rlt[$j]['ord']=0;	$rlt[$j]['ord_qty']=0;
			$rlt[$j]['cust']=$rpt[$i]['cust'];
			$rlt[$j]['cust_i']=$rpt[$i]['cust_init'];
		}
		$rlt[$j]['smpl'] += $rpt[$i]['num_count'];
		$rlt[$j]['s_qty']=$rlt[$j]['s_qty']+$rpt[$i]['qty'];
		$flag=0;

		if($order_num= $order->smpl_search($rpt[$i]['num_init']))
		{
			$rlt[$j]['use']+= $rpt[$i]['num_count'];		//vail sample數 +1	
			$rlt[$j]['use_qty']=$rlt[$j]['use_qty']+$rpt[$i]['qty'];				

			for ($x=0; $x<sizeof($order_num); $x++)
			{
				if ($order_num[$x]['qty'] > 0)	
				{
					$rlt[$j]['ord']++; //訂單數+1
					$rlt[$j]['ord_qty']=$rlt[$j]['ord_qty']+$order_num[$x]['qty'];
					$flag = 1;											
				}				
			}
		}

		
		
		$rlt[$j]['sort']=$rlt[$j]['use'];		
	}
	$rlt=bubble_sort($rlt);
	$op['ord']=$rlt;
	$op['today']=$TODAY;
	page_display($op,'072', $TPL_RPT_SMPL_USE_COUNT);
break;

//====================================================
case "rpt_smple_use_det":
	check_authority('072',"view");
	$alt_value['valid_smpl'] *= -1;
	$search_day = increceDaysInDate($TODAY,$alt_value['valid_smpl']);
	$where=" and cust = '$PHP_cust'";
	$vail =0;
	$tmp_str=$tmp_num='';
	$rpt=$report->smpl_use_search($search_day,$where);
	$op['smpl_use_qty']=$op['smpl_use_count']=$op['smpl_count']=$op['ord_count']=$op['ord_qty_sum']=$op['qty_sum']=0;
	
	$smpl_rpt = array();
	$j=-1;
	for ($i=0; $i<sizeof($rpt); $i++)
	{
		
		$op['qty_sum']=$op['qty_sum']+$rpt[$i]['qty'];
		$op['smpl_count']+= $rpt[$i]['num_count'];
		$rpt[$i]['order_str']='';		
		
		if($order_num= $order->smpl_search($rpt[$i]['num_init']))
		{
				$op['smpl_use_count']+= $rpt[$i]['num_count'];
				$op['smpl_use_qty']=$op['smpl_use_qty']+$rpt[$i]['qty'];			

				for ($x=0; $x<sizeof($order_num); $x++)
				{											  
					if ($order_num[$x]['qty'] > 0)	
					{
						$op['ord_count']++;
						$op['ord_qty_sum']=$op['ord_qty_sum']+$order_num[$x]['qty'];
						$flag = 1;
					}
					$ord_qty=get_currency($order_num[$x]['qty']);
					$ord_qty=substr($ord_qty,0,-3);
					$tmp_str ="	<a href=\"javascript:show_order_rec('','".$order_num[$x]['order_num']."')\">".$order_num[$x]['order_num']."</a>";
					$rpt[$i]['order_str']=$rpt[$i]['order_str'].$tmp_str."  (".$ord_qty."pcs)  ";								
				}	
		}	

		$j++;
		$smpl_rpt[$j] =$rpt[$i];
		$smpl_rpt[$j]['smpl_link'] = substr($rpt[$i]['num'],0,9);			
		$smpl_rpt[$j]['i'] = $j+1;		
		

	}	
	
	$op['ord']=$smpl_rpt;
	$op['cust']=$PHP_cust_ini;
	page_display($op,'072', $TPL_RPT_SMPL_USE_DET);
break;

//====================================================
case "style_out_search":
	check_authority('072',"view");
	if (!$PHP_start) $PHP_start = date('Y')."-01-01";
	if (!$PHP_finish) $PHP_finish = $TODAY;
	$style_rpt=$report->style_out_search($PHP_factory,$PHP_start,$PHP_finish);  //取出記錄	
	$rpt = array();
	$i = 0;
	foreach($style_rpt as $key => $value)
	{
		$rpt[$i]['style'] = $style_rpt[$key][0]['style'];
		$rpt[$i]['order_count'] = sizeof($style_rpt[$key]);
		$rpt[$i]['sum_qty'] = $rpt[$i]['sum_su'] = $rpt[$i]['avg_qty'] = $rpt[$i]['avg_su'] = 0;
		for($j=0; $j<sizeof($style_rpt[$key]); $j++)
		{
			$rpt[$i]['sum_qty'] += $style_rpt[$key][$j]['qty'];
			$rpt[$i]['sum_su'] += $style_rpt[$key][$j]['su'];
			$rpt[$i]['avg_qty'] += $style_rpt[$key][$j]['avg_qty'];
			$rpt[$i]['avg_su'] += $style_rpt[$key][$j]['avg_su'];
		}
		$rpt[$i]['avg_qty'] /= $rpt[$i]['order_count'];
		$rpt[$i]['avg_su'] /= $rpt[$i]['order_count'];
		$i++;
	}
	
	$op['ord_total'] = 0;
	$op['qty_total'] =$op['su_total'] =0;
	for ($i=0; $i< sizeof($rpt); $i++)
	{
		$op['ord_total'] = $op['ord_total']+$rpt[$i]['order_count'];
		$op['qty_total'] =$op['qty_total'] + $rpt[$i]['sum_qty'];
		$op['su_total'] = $op['su_total'] + $rpt[$i]['sum_su'];
	}
	
	$op['ord']=$rpt;
	$op['today']=$TODAY;
	$op['fty']=$PHP_factory;
	$op['start']=$PHP_start;
	$op['finish']=$PHP_finish;
	page_display($op,'072', $TPL_RPT_STYLE_OUT);
break;

//====================================================
case "rpt_ord_dist_search":
	check_authority('072',"view");
	if (!$PHP_start) $PHP_start = date('Y')."-01-01";
	if (!$PHP_finish) $PHP_finish = $TODAY;
	$dist = array ('1000','1500','3000','5000');
	$rpt=$report->ord_qty_cut_search($PHP_factory,$PHP_start,$PHP_finish,$dist);  //取出記錄	
	
	$op['ord_total'] = 0;
  for ($i=0; $i< sizeof ($rpt); $i++)
  {
  	$op['ord_total'] = $op['ord_total'] + $rpt[$i];
  }

  for ($i=0; $i< sizeof ($rpt); $i++)
  {
  	$ord_rate[$i] = ($rpt[$i] / $op['ord_total']) * 100;
  }


	
	$op['ord']=$rpt;
	$op['ord_rate']=$ord_rate;
	$op['dist']=$dist;
	$op['today']=$TODAY;
	$op['fty']=$PHP_factory;
	$op['start']=$PHP_start;
	$op['finish']=$PHP_finish;
	page_display($op,'072', $TPL_RPT_ORD_DIST);
break;


//====================================================
case "do_user_search":
//	check_authority(10,7,"view");
	
	$op=$user->search(1);
	
	$dept=$dept->get_fields('dept_code');	
	$op['dept_select'] =  $arry2->select($dept,'','PHP_dept','select'); 
	$back_str="&PHP_dept=".$PHP_dept."&PHP_logid=".$PHP_logid."&PHP_name=".$PHP_name;
	$op['back_str'] = $back_str;
	
	page_display($op,'072', $TPL_USER_SEARCH);
break;

//====================================================
case "ord_prd_tal":
#M11010501 修改大表區隔針織和平織的顯示 star
unset($_SESSION['pre_tal_dept']);
// if( !empty($_GET['fabric']) && $_GET['fabric'] == 'woven' )
$_SESSION['pre_tal_type'] = $_GET['fabric'];
#M11010501 修改大表區隔針織和平織的顯示 end
$op['ntype'] = $_GET['fabric'];
page_display($op,'072', $TPL_ORD_PRD_TAL);
break;

case "ord_prd_tal_top":

$CUST = $order->get_fields( ' `s_order`.`cust` ' , "WHERE `order_partial`.`ord_num` = `s_order`.`order_num` AND `s_order`.`cust` = `cust`.`cust_s_name` AND `cust`.`active` = 'Y' AND `order_partial`.`p_etd` >= '".increceDaysInDate(date('Y-m-d'),-365)."' AND `s_order`.`factory` = '".$_SESSION['pre_tal_type']."' AND `s_order`.`status` > '3' AND `s_order`.`status` <> '5' AND `s_order`.`status` <> '14' AND `order_partial`.`pdt_status` < '4' GROUP BY `s_order`.`cust`  " , ' `s_order` , `cust` , `order_partial` ' );
$op['cust_select'] =  $arry2->select($CUST,'','PHP_cust','select','choise_cust_user()');
$USER = $order->get_fields( ' `s_order`.`creator` ' , "WHERE `order_partial`.`ord_num` = `s_order`.`order_num` AND `s_order`.`creator` = `user`.`login_id` AND `user`.`active` = 'Y' AND `order_partial`.`p_etd` >= '".increceDaysInDate(date('Y-m-d'),-365)."' AND `s_order`.`factory` = '".$_SESSION['pre_tal_type']."' AND `s_order`.`status` > '3' AND `s_order`.`status` <> '5' AND `s_order`.`status` <> '14' AND `order_partial`.`pdt_status` < '4' GROUP BY `s_order`.`creator`  " , ' `s_order` , `user` , `order_partial` ' );
$op['user_select'] =  $arry2->select($USER,'','PHP_user','select','choise_cust_user()');
$op['month_select'] =  $arry2->select($MONTH_WORK,'','SCH_mm','select','');
$op['pre_tal_type'] = $_SESSION['pre_tal_type'];

page_display($op,'072', $TPL_ORD_PRD_TAL_TOP);
break;

case "ord_prd_tal_main":
$op['sday'] =  increceDaysInDate(date('Y-m-d'),-365);
$op['rpt']=$report->search_f_ord_tbl('',$PHP_target,$op['sday'],$PHP_cust,$PHP_user);
$op['rpt_m']=$report->search_m_ord_tbl('',$PHP_target,$op['sday'],$PHP_cust,$PHP_user);
// print_r($PHP_user);
$op['today']=$TODAY;
page_display($op,'072', $TPL_ORD_PRD_TAL_MAIN);
break;

case "ord_exceptional":

$op['rpt']=$report->search_ord_exceptional();
// echo '123';
$op['today']=$TODAY;
page_display($op,'072', $TPL_ORD_EXCEPTIONAL);
break;



case "remove_order":

echo $order->remove_order($PHP_ord,$PHP_mks);

break;



//====================================================
case "ord_prd_tal_excel":
	check_authority('072',"view");
	$rpt=$report->search_f_ord_tbl();
	$rpt_m=$report->search_m_ord_tbl();
	 require_once($config['root_dir']."/lib/spreadsheets/Worksheet.php");
	 require_once($config['root_dir']."/lib/spreadsheets/Workbook.php");

	  function HeaderingExcel($filename) {
		  header("Content-type: application/vnd.ms-excel");
		  header("Content-Disposition: attachment; filename=$filename" );
		  header("Expires: 0");
		  header("Cache-Control: must-revalidate, post-check=0,pre-check=0");
		  header("Pragma: public");
		  }

	  // HTTP headers
	  HeaderingExcel('ord_pdt_tal.xls');
	 
	  // Creating a workbook
	  $workbook = new Workbook("-");

	  // Creating the first worksheet
	  $worksheet1 =& $workbook->add_worksheet('Porcution Order Check-List');

		$now = $GLOBALS['THIS_TIME'];

	// 寫入 title

	  $formatot =& $workbook->add_format();
	  $formatot->set_size(10);
	  $formatot->set_align('center');
	  $formatot->set_color('white');
	  $formatot->set_pattern(1);
	  $formatot->set_fg_color('navy');
	  $formatot->set_num_format(4);
	  
	  $f3 =& $workbook->add_format(); //置右
	  $f3->set_size(10);
	  $f3->set_align('right');
	  $f3->set_num_format(3);
	  
	  $f5 =& $workbook->add_format();  //灰底白字置中
	  $f5->set_size(10);
	  $f5->set_align('center');
	  $f5->set_color('white');
	  $f5->set_pattern(1);
	  $f5->set_fg_color('grey');
	  
	  $f6 =& $workbook->add_format();  //灰底白字置右
	  $f6->set_size(10);
	  $f6->set_color('white');
	  $f6->set_pattern(1);
	  $f6->set_align('right');
	  $f6->set_num_format(3);
	  $f6->set_fg_color('grey');

	  $f7 =& $workbook->add_format();  //淡紅底置中
	  $f7->set_color(62);	
	  $f7->set_pattern(1);  
	  $f7->set_align('center');
	  $f7->set_fg_color(45);
	  
	  $clumn = array(       10,   15,     15,   8,     7,   8,  10,    7,     15,    0.5,    12,       11,    0.5,    12,         12,   0.5,    12,  0.5,    10,    10,    8,         8);
	  $title = array('Order #','style#','ref.','Qty','style','SU','ETD','FTY', 'Status','', 'FAB ETA','FAB RCVD','', 'ACC ETA','ACC RCVD','','SMPL APV','', 'ETS', 'ETF', 'Out-Put', 'Lead-T.');
	  for ($i=0; $i< sizeof($clumn); $i++)
	  {
	  	$worksheet1->set_column(0,$i,$clumn[$i]);
	  }
	  $worksheet1->write_string(0,1,'ORDER Lead-Time Analysis by customer -- 女裝線');
	  $worksheet1->write_string(0,10,$THIS_TIME);
	  for ($i=0; $i< sizeof($title); $i++)
	  {
	  	$worksheet1->write_string(1,$i,$title[$i],$formatot);
	  }

	  	  	  
	  $j=2;
	  for ($i=0; $i< sizeof($rpt); $i++)
	  {	  	

	 			
	 		if($rpt[$i]['smpl_apv'] == '0000-00-00') $rpt[$i]['smpl_apv'] ='';
	 		if($rpt[$i]['ets'] == '0000-00-00') $rpt[$i]['ets'] ='';
	 		if($rpt[$i]['etf'] == '0000-00-00') $rpt[$i]['etf'] ='';	  	
			if (isset($rpt[$i]['ln_mk']))
			{
		  	for ($k=0; $k< sizeof($title); $k++)
	 			 {
	  				$worksheet1->write_string($j,$k,'');
	  		 }
	  		 $j++;			
			}
	  	$worksheet1->write_string($j,0,$rpt[$i]['order_num']);
	  	$worksheet1->write_string($j,1,$rpt[$i]['style_num']);
	  	$worksheet1->write_string($j,2,$rpt[$i]['ref']);
	  	$worksheet1->write_number($j,3,$rpt[$i]['qty'],$f3);
	 		$worksheet1->write_string($j,4,$rpt[$i]['style']);
	 		$worksheet1->write_number($j,5,$rpt[$i]['su'],$f3);
	 		if ( $rpt[$i]['etd'] < $TODAY)
	 		{
	 			$worksheet1->write_string($j,6,$rpt[$i]['etd'],$f7);
	 		}else{
	  		$worksheet1->write_string($j,6,$rpt[$i]['etd']);
	  	}
	  	$worksheet1->write_string($j,7,$rpt[$i]['factory']);
			$worksheet1->write_string($j,8,$rpt[$i]['rmk']);
			$worksheet1->write_string($j,9,'');
			if ( $rpt[$i]['mat_etd'] < $TODAY && $rpt[$i]['mat_shp'] == '')
	 		{
	 			$worksheet1->write_string($j,10,$rpt[$i]['mat_eta'],$f7);
	 		}else{
	  		$worksheet1->write_string($j,10,$rpt[$i]['mat_eta']);
	  	}
	  	
	  	$worksheet1->write_string($j,11,$rpt[$i]['mat_shp']);
	  	$worksheet1->write_string($j,12,'');
			if ( $rpt[$i]['m_acc_etd'] < $TODAY && $rpt[$i]['m_acc_shp'] == '')
	 		{
	 			$worksheet1->write_string($j,13,$rpt[$i]['m_acc_eta'],$f7);
	 		}else{
	  		$worksheet1->write_string($j,13,$rpt[$i]['m_acc_eta']);
	  	}	  	
	  	$worksheet1->write_string($j,14,$rpt[$i]['m_acc_shp']);
	  	$worksheet1->write_string($j,15,'');
	  	$worksheet1->write_string($j,16,$rpt[$i]['smpl_apv']);		  	
	  	$worksheet1->write_string($j,17,'');
	  	$worksheet1->write_string($j,18,$rpt[$i]['ets']);
	  		if ( $rpt[$i]['etf'] < $TODAY)
	 		{
	 			$worksheet1->write_string($j,19,$rpt[$i]['etf'],$f7);
	 		}else{
	  		$worksheet1->write_string($j,19,$rpt[$i]['etf']);
	  	}	  
	  	
	  	$worksheet1->write_string($j,20,$rpt[$i]['qty_done']);
	  	$worksheet1->write_string($j,21,$rpt[$i]['lead']);

	  	$j++;

	  }


		$j++;
	  $worksheet1->write_string($j,1,'ORDER Lead-Time Analysis by customer -- 男裝線');
	  $worksheet1->write_string($j,10,$THIS_TIME);
	  $j++;
	  for ($i=0; $i< sizeof($title); $i++)
	  {
	  	$worksheet1->write_string($j,$i,$title[$i],$formatot);
	  }

	 $j++; 	  	  

	  for ($i=0; $i< sizeof($rpt_m); $i++)
	  {	  	

	 			
	 		if($rpt_m[$i]['smpl_apv'] == '0000-00-00') $rpt_m[$i]['smpl_apv'] ='';
	 		if($rpt_m[$i]['ets'] == '0000-00-00') $rpt_m[$i]['ets'] ='';
	 		if($rpt_m[$i]['etf'] == '0000-00-00') $rpt_m[$i]['etf'] ='';	  	
			if (isset($rpt_m[$i]['ln_mk']))
			{
		  	for ($k=0; $k< sizeof($title); $k++)
	 			 {
	  				$worksheet1->write_string($j,$k,'');
	  		 }
	  		 $j++;			
			}
	  	$worksheet1->write_string($j,0,$rpt_m[$i]['order_num']);
	  	$worksheet1->write_string($j,1,$rpt_m[$i]['style_num']);
	  	$worksheet1->write_string($j,2,$rpt_m[$i]['ref']);
	  	$worksheet1->write_number($j,3,$rpt_m[$i]['qty'],$f3);
	 		$worksheet1->write_string($j,4,$rpt_m[$i]['style']);
	 		$worksheet1->write_number($j,5,$rpt_m[$i]['su'],$f3);
	 		if ( $rpt_m[$i]['etd'] < $TODAY)
	 		{
	 			$worksheet1->write_string($j,6,$rpt_m[$i]['etd'],$f7);
	 		}else{
	  		$worksheet1->write_string($j,6,$rpt_m[$i]['etd']);
	  	}
	  	$worksheet1->write_string($j,7,$rpt_m[$i]['factory']);
			$worksheet1->write_string($j,8,$rpt_m[$i]['rmk']);
			$worksheet1->write_string($j,9,'');
			if ( $rpt_m[$i]['mat_etd'] < $TODAY && $rpt_m[$i]['mat_shp'] == '')
	 		{
	 			$worksheet1->write_string($j,10,$rpt_m[$i]['mat_etd'],$f7);
	 		}else{
	  		$worksheet1->write_string($j,10,$rpt_m[$i]['mat_etd']);
	  	}
	  	
	  	$worksheet1->write_string($j,11,$rpt_m[$i]['mat_shp']);
	  	$worksheet1->write_string($j,12,'');
			if ( $rpt_m[$i]['m_acc_etd'] < $TODAY && $rpt_m[$i]['m_acc_shp'] == '')
	 		{
	 			$worksheet1->write_string($j,13,$rpt_m[$i]['m_acc_etd'],$f7);
	 		}else{
	  		$worksheet1->write_string($j,13,$rpt_m[$i]['m_acc_etd']);
	  	}	  	
	  	$worksheet1->write_string($j,14,$rpt_m[$i]['m_acc_shp']);
	  	$worksheet1->write_string($j,15,'');
	  	$worksheet1->write_string($j,16,$rpt_m[$i]['smpl_apv']);		  	
	  	$worksheet1->write_string($j,17,'');
	  	$worksheet1->write_string($j,18,$rpt_m[$i]['ets']);
	  		if ( $rpt_m[$i]['etf'] < $TODAY)
	 		{
	 			$worksheet1->write_string($j,19,$rpt_m[$i]['etf'],$f7);
	 		}else{
	  		$worksheet1->write_string($j,19,$rpt_m[$i]['etf']);
	  	}	  
	  	
	  	$worksheet1->write_string($j,20,$rpt_m[$i]['qty_done']);
	  	$worksheet1->write_string($j,21,$rpt_m[$i]['lead']);

	  	$j++;

	  }
  	  $workbook->close();
	break;
//====================================================
//====================================================
case "out_put_lc":
//	check_authority(10,7,"view");
		$ords = $order->schedule_get(0,$PHP_order_num);  //取出該筆記錄
		if (!$ords) {
			$op['msg'] = $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$years='';
		$prd_out=$daily->daily_out_per_day($PHP_order_num);
		$j=1;
		
		$x_ary[0]=substr($prd_out[0]['k_date'],5);
		$data[0]=$prd_out[0]['su'];
		$yy=substr($prd_out[0]['k_date'],0,4);
		for ($i=1; $i < sizeof($prd_out); $i++)
		{
				$cut_day=countDays ($prd_out[($i-1)]['k_date'],$prd_out[$i]['k_date']);
				if ($cut_day > 1)
				{
					$su=$prd_out[$i]['su'] / $cut_day;
					$tmp_su=0;
					for ($x=1; $x < $cut_day; $x++)
					{
						$tmp_day=increceDaysInDate($prd_out[($i-1)]['k_date'],$x);
						$x_ary[$j] = substr($tmp_day,5);
						$data[$j]=$su;
//						echo $x_ary[$j]."=====>".$data[$j]."<br>";
						$tmp_su=$tmp_su+$su;
						$j++;
					}
					$tmp_day=increceDaysInDate($prd_out[($i-1)]['k_date'],$cut_day);
					$x_ary[$j] = substr($tmp_day,5);
					$su=$prd_out[$i]['su']-$tmp_su;
					$data[$j]=$su;
//					echo $x_ary[$j]."=====>".$data[$j]."<br>";
					$j++;
				}else{				
					$x_ary[$j] = substr($prd_out[$i]['k_date'],5);
					$data[$j]=$prd_out[$i]['su'];
					$j++;
					$su=$prd_out[$i]['su'];
				}
				
				if ($yy <> substr($prd_out[$i]['k_date'],0,4) )	$years=$yy."~".substr($prd_out[($i+1)]['k_date'],0,4);
					
		}



		if (!$ords['finish'] || $ords['finish'] == '0000-00-00') 
		{
			$x_ary[$j]=date('m-d');
			$data[$j]=$data[($j-1)];
		}
		if ($years=='') $years=$yy;
		//引入 graph class
		include_once($config['root_dir']."/lib/src/jpgraph.php");
		include_once($config['root_dir']."/lib/src/jpgraph_line.php");

		include ($config['root_dir']."/lib/src/jpgraph_bar.php");

		$graphic_title = "Order # : ".$PHP_order_num."  Style : ".$ords['style']."  SU: ".$ords['su']."  Q'TY: ".$ords['qty']."  FTY: ".$ords['factory']."  YEAR: ".$years;
		
		// Create the graph. These two calls are always required
		$graph = new Graph(800,300,"auto");    
		$graph->SetScale("textlin");
		
		// Adjust the margin
		$graph->img->SetMargin(60,30,40,40);    
		$graph->SetShadow();
		
		// Create the linear plot
		$lineplot=new LinePlot($data);
		$lineplot->mark->SetType(MARK_UTRIANGLE);
		$lineplot ->value->SetFont( FF_FONT1, FS_BOLD); 
		$lineplot ->value->SetFormat( " %d");
		$lineplot->value->show();

		// Add the plot to the graph
		$graph->Add($lineplot);

		$graph->title->Set($graphic_title);
//		$graph->xaxis->title->Set("Out-Put Date");
		$graph->yaxis->title->Set("SU");

		$graph->title->SetFont(FF_FONT1,FS_BOLD);
		$graph->yaxis->title->SetFont(FF_FONT1,FS_BOLD);
//		$graph->xaxis->title->SetFont(FF_FONT1,FS_BOLD);

		// Setup X-scale
		$graph->xaxis->SetTickLabels($x_ary);
		$graph->xaxis->SetFont(FF_ARIAL,FS_NORMAL,8);
		$graph->xaxis->SetLabelAngle(45);

		$lineplot->SetColor("blue");
		$lineplot->SetWeight(2);

		// Display the graph
		$op['echart_1'] = $graph->Stroke('picture/out_put_lc.png');
		$op['echart_1'] = 'picture/out_put_lc.png';
		
		page_display($op,'072', $TPL_OUT_PUT_LC);
break;


//=======================================================
case "ord_batch_cost":
check_authority('065',"view");

echo '正式系統無法使用，重新製作中!!<br>請暫時先連到<a href="http://scm-b.carnival.com.tw/maintain/index2.php" target="_blank">練習場</a>查看資料！';
// exit;

//-------------------- 將 製造令 show out ------------------
//  wi 主檔
if (isset($PHP_id)) {
	if(!$op['wi'] = $wi->get($PHP_id)){    //取出該筆 製造令記錄
		$op['msg']= $wi->msg->get(2);
		$layout->assign($op);
		$layout->display($TPL_ERROR);  		    
		break;
	}
} else {	
	if(!$op['wi']  = $wi->get(0,$PHP_bom_num)){    //取出該筆 製造令記錄
		$op['msg']= $wi->msg->get(2);
		$layout->assign($op);
		$layout->display($TPL_ERROR);  		    
		break;
	}
}

//  smpl 樣本檔
if(!$op['order'] = $order->get($op['wi']['smpl_id'])){
			$op['msg']= $order->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
}

$size_data=$size_des->get($op['order']['size']);		
$op['order']['size']=$size_data['size_scale'];

//-----------------------------------------------------------------
// 相片的URL決定 ------------------------------------------------------
$style_dir	= "./picture/";  
$no_img		= "./images/graydot.gif";
if(file_exists($style_dir.$op['wi']['style_code'].".jpg")){
	$op['wi']['pic_url'] = $style_dir.$op['wi']['style_code'].".jpg";
} else {
	$op['wi']['pic_url'] = $no_img;
}

//  取出  BOM  主料記錄 --------------------------------------------------------------
//		 $op['fab_bom_tal'] = $op['fab_pur_tal'] = $op['fab_rcv_tal'] = 0;
$tmp_cry = array();
$op['bom_lots_NONE']= '';
$op['bom_lots'] = $po->get_lots_det($op['wi']['id']);  //取出該筆 bom 內ALL主料記錄
$num_bom_lots = count($op['bom_lots']);
if (!$num_bom_lots){	$op['bom_lots_NONE'] = "1";		}

$tmp_date = explode(' ',$op['wi']['bcfm_date']);
$bom_sub_date = $tmp_date[0];

$parm = array(
	"str"		=>	'2008-01-01',
	"end"		=>	$TODAY,
	"ship"		=>	'',
	"cat"		=>	"F",
	"ord"		=>	$op['wi']['wi_num'],
	"price"		=>	1
);

// $fab_rcv = $receive->search_rpt_dtl($parm);
// print_r($op['bom_lots']);

$j = -1;
for ($i =0; $i< sizeof($op['bom_lots']['bom']); $i++) {
    $op['bom_lots'][$i] = $op['bom_lots']['bom'][$i];
	// print_r($op['bom_lots']);
	
	//增加數量總計 080604
	if(!isset($op['bom_lots'][$i]['po']['po_amount'])) $op['bom_lots']['bom'][$i]['po']['po_amount'] ='';
	if(!isset($op['bom_lots'][$i]['po']['price'])) $op['bom_lots']['bom'][$i]['po']['price'] ='';
	if(!isset($op['bom_lots'][$i]['po']['rcv_qty'])) $op['bom_lots']['bom'][$i]['po']['rcv_qty'] ='';
	$bom_price = 0;
	if(isset($op['bom_lots'][$i]['po']['unit']) )				
		$bom_price = change_unit_price($op['bom_lots'][$i]['po']['unit'],$op['bom_lots'][$i]['unit'],$op['bom_lots'][$i]['po']['price']);
					
	$op['bom_lots'][$i]['bom_amount'] = $op['bom_lots']['bom'][$i]['total'] * $bom_price;
	$op['bom_lots'][$i]['po']['rcv_amount'] = $op['bom_lots']['bom'][$i]['po']['rcv_qty'] * $op['bom_lots']['bom'][$i]['po']['price'];

	// $op['fab_rcv_tal'] += $op['bom_lots'][$i]['po']['rcv_amount'];

	if($op['bom_lots'][$i]['po']['price'])
	{
		if($j == -1)
		{
			$j++;
			$fab_bom[$j] = $op['bom_lots'][$i]['bom_amount'];
			$fab_pur[$j] = $op['bom_lots'][$i]['po']['po_amount'];
			$fab_rcv[$j] = $op['bom_lots'][$i]['po']['rcv_amount'];

			$tmp_cry[$j] = $op['bom_lots'][$i]['currency'];
		}else{				
			$tmp_j = -1;
			for($k=0; $k<sizeof($tmp_cry); $k++)
			{
				if($tmp_cry[$k] == $op['bom_lots'][$i]['currency']) 
				{
					$tmp_j = $k;
					break;
				}					
			}
			if($tmp_j > -1)
			{
				$fab_bom[$tmp_j]+= $op['bom_lots'][$i]['bom_amount'];						
				$fab_pur[$tmp_j]+= $op['bom_lots'][$i]['po']['po_amount'];
				$fab_rcv[$tmp_j]+= $op['bom_lots'][$i]['po']['rcv_amount'];

			}else{
				$j++;
				$fab_bom[$j] = $op['bom_lots'][$i]['bom_amount'];
				$fab_pur[$j] = $op['bom_lots'][$i]['po']['po_amount'];
				$fab_rcv[$j] = $op['bom_lots'][$i]['po']['rcv_amount'];
				$tmp_cry[$j] = $op['bom_lots'][$i]['currency'];						
			} // end if($tmp_j > -1)
		}// end if($j == -1)
	}
		
}

$op['fab_bom_tal'] = $op['fab_rcv_tal'] = $op['fab_pur_tal'] = '';
for($k=0; $k<sizeof($tmp_cry); $k++)
{
	if($fab_bom[$k] > 0) $op['fab_bom_tal'].=$tmp_cry[$k]."$".NUMBER_FORMAT($fab_bom[$k],2,'.',',')."+";
	if($fab_pur[$k] > 0) $op['fab_pur_tal'].=$tmp_cry[$k]."$".NUMBER_FORMAT($fab_pur[$k],2,'.',',')."+";
	if($fab_rcv[$k] > 0) $op['fab_rcv_tal'].=$tmp_cry[$k]."$".NUMBER_FORMAT($fab_rcv[$k],2,'.',',')."+";
}

$op['fab_bom_tal'] = substr($op['fab_bom_tal'],0,-1);
$op['fab_pur_tal'] = substr($op['fab_pur_tal'],0,-1);
$op['fab_rcv_tal'] = substr($op['fab_rcv_tal'],0,-1);


//  取出  BOM  工廠採購 主料記錄 --------------------------------------------------------------
$tmp_cry = $fab_bom = $fab_pur = $fab_rcv =array();
 
// $op['fty_lots'] = $po->get_lots_det($op['wi']['id'],1);  //取出該筆 bom 內ALL主料記錄
$num_fty_lots = count($op['fty_lots']);
if (!$num_fty_lots){	$op['fty_lots_NONE'] = "1";		}

	$j = -1;
	for ($i =0; $i< sizeof($op['fty_lots']); $i++)
	{		 		
//增加數量總計 080604
		if(!isset($op['fty_lots'][$i]['po']['po_amount'])) $op['fty_lots'][$i]['po']['po_amount'] ='';
		if(!isset($op['fty_lots'][$i]['po']['price'])) $op['fty_lots'][$i]['po']['price'] ='';
		if(!isset($op['fty_lots'][$i]['po']['rcv_qty'])) $op['fty_lots'][$i]['po']['rcv_qty'] ='';
		$bom_price = 0;
		if(isset($op['fty_lots'][$i]['po']['unit']) )				
			$bom_price = change_unit_price($op['fty_lots'][$i]['po']['unit'],$op['fty_lots'][$i]['unit'],$op['fty_lots'][$i]['po']['price']);
						
		$op['fty_lots'][$i]['bom_amount'] = $op['fty_lots'][$i]['total'] * $bom_price;
		$op['fty_lots'][$i]['po']['rcv_amount'] = $op['fty_lots'][$i]['po']['rcv_qty'] * $op['fty_lots'][$i]['po']['price'];

//			$op['fab_rcv_tal'] += $op['fty_lots'][$i]['po']['rcv_amount'];
		
	if($op['fty_lots'][$i]['po']['price'])
	{
		if($j == -1)
		{
			$j++;
			$fab_bom[$j] = $op['fty_lots'][$i]['bom_amount'];
			$fab_pur[$j] = $op['fty_lots'][$i]['po']['po_amount'];
			$fab_rcv[$j] = $op['fty_lots'][$i]['po']['rcv_amount'];

			$tmp_cry[$j] = $op['fty_lots'][$i]['currency'];
		}else{				
			$tmp_j = -1;
			for($k=0; $k<sizeof($tmp_cry); $k++)
			{
				if($tmp_cry[$k] == $op['fty_lots'][$i]['currency']) 
				{
					$tmp_j = $k;
					break;
				}					
			}
			if($tmp_j > -1)
			{
				$fab_bom[$tmp_j]+= $op['fty_lots'][$i]['bom_amount'];						
				$fab_pur[$tmp_j]+= $op['fty_lots'][$i]['po']['po_amount'];
				$fab_rcv[$tmp_j]+= $op['fty_lots'][$i]['po']['rcv_amount'];

			}else{
				$j++;
				$fab_bom[$j] = $op['fty_lots'][$i]['bom_amount'];
				$fab_pur[$j] = $op['fty_lots'][$i]['po']['po_amount'];
				$fab_rcv[$j] = $op['fty_lots'][$i]['po']['rcv_amount'];
				$tmp_cry[$j] = $op['fty_lots'][$i]['currency'];						
		  } // end if($tmp_j > -1)
		}// end if($j == -1)
	}
		
	}

	$op['fty_fab_bom_tal'] = $op['fty_fab_rcv_tal'] = $op['fty_fab_pur_tal'] = '';
	for($k=0; $k<sizeof($tmp_cry); $k++)
	{
			if($fab_bom[$k] > 0) $op['fty_fab_bom_tal'].=$tmp_cry[$k]."$".NUMBER_FORMAT($fab_bom[$k],2,'.',',')."+";
			if($fab_pur[$k] > 0) $op['fty_fab_pur_tal'].=$tmp_cry[$k]."$".NUMBER_FORMAT($fab_pur[$k],2,'.',',')."+";
			if($fab_rcv[$k] > 0) $op['fty_fab_rcv_tal'].=$tmp_cry[$k]."$".NUMBER_FORMAT($fab_rcv[$k],2,'.',',')."+";
	}

	$op['fty_fab_bom_tal'] = substr($op['fty_fab_bom_tal'],0,-1);
	$op['fty_fab_pur_tal'] = substr($op['fty_fab_pur_tal'],0,-1);
	$op['fty_fab_rcv_tal'] = substr($op['fty_fab_rcv_tal'],0,-1);



//  取出  BOM  客戶提供 主料記錄 --------------------------------------------------------------
 $tmp_cry = $fab_bom = $fab_pur = $fab_rcv =array();
 
 // $op['cust_lots'] = $po->get_lots_det($op['wi']['id'],2);  //取出該筆 bom 內ALL主料記錄
 $num_cust_lots = count($op['cust_lots']);
 if (!$num_cust_lots){	$op['cust_lots_NONE'] = "1";		}

	$j = -1;
	for ($i =0; $i< sizeof($op['cust_lots']); $i++)
	{		 		
//增加數量總計 080604
		if(!isset($op['cust_lots'][$i]['po']['po_amount'])) $op['cust_lots'][$i]['po']['po_amount'] ='';
		if(!isset($op['cust_lots'][$i]['po']['price'])) $op['cust_lots'][$i]['po']['price'] ='';
		if(!isset($op['cust_lots'][$i]['po']['rcv_qty'])) $op['cust_lots'][$i]['po']['rcv_qty'] ='';
		$bom_price = 0;
		if(isset($op['cust_lots'][$i]['po']['unit']) )				
			$bom_price = change_unit_price($op['cust_lots'][$i]['po']['unit'],$op['cust_lots'][$i]['unit'],$op['cust_lots'][$i]['po']['price']);
						
		$op['cust_lots'][$i]['bom_amount'] = $op['cust_lots'][$i]['total'] * $bom_price;
		$op['cust_lots'][$i]['po']['rcv_amount'] = $op['cust_lots'][$i]['po']['rcv_qty'] * $op['cust_lots'][$i]['po']['price'];

//			$op['fab_rcv_tal'] += $op['cust_lots'][$i]['po']['rcv_amount'];
		
	if($op['cust_lots'][$i]['po']['price'])
	{
		if($j == -1)
		{
			$j++;
			$fab_bom[$j] = $op['cust_lots'][$i]['bom_amount'];
			$fab_pur[$j] = $op['cust_lots'][$i]['po']['po_amount'];
			$fab_rcv[$j] = $op['cust_lots'][$i]['po']['rcv_amount'];

			$tmp_cry[$j] = $op['cust_lots'][$i]['currency'];
		}else{				
			$tmp_j = -1;
			for($k=0; $k<sizeof($tmp_cry); $k++)
			{
				if($tmp_cry[$k] == $op['cust_lots'][$i]['currency']) 
				{
					$tmp_j = $k;
					break;
				}					
			}
			if($tmp_j > -1)
			{
				$fab_bom[$tmp_j]+= $op['cust_lots'][$i]['bom_amount'];						
				$fab_pur[$tmp_j]+= $op['cust_lots'][$i]['po']['po_amount'];
				$fab_rcv[$tmp_j]+= $op['cust_lots'][$i]['po']['rcv_amount'];

			}else{
				$j++;
				$fab_bom[$j] = $op['cust_lots'][$i]['bom_amount'];
				$fab_pur[$j] = $op['cust_lots'][$i]['po']['po_amount'];
				$fab_rcv[$j] = $op['cust_lots'][$i]['po']['rcv_amount'];
				$tmp_cry[$j] = $op['cust_lots'][$i]['currency'];						
		  } // end if($tmp_j > -1)
		}// end if($j == -1)
	}
		
	}

	$op['cust_fab_bom_tal'] = $op['cust_fab_rcv_tal'] = $op['cust_fab_pur_tal'] = '';
	for($k=0; $k<sizeof($tmp_cry); $k++)
	{
			if($fab_bom[$k] > 0) $op['cust_fab_bom_tal'].=$tmp_cry[$k]."$".NUMBER_FORMAT($fab_bom[$k],2,'.',',')."+";
			if($fab_pur[$k] > 0) $op['cust_fab_pur_tal'].=$tmp_cry[$k]."$".NUMBER_FORMAT($fab_pur[$k],2,'.',',')."+";
			if($fab_rcv[$k] > 0) $op['cust_fab_rcv_tal'].=$tmp_cry[$k]."$".NUMBER_FORMAT($fab_rcv[$k],2,'.',',')."+";
	}

	$op['cust_fab_bom_tal'] = substr($op['cust_fab_bom_tal'],0,-1);
	$op['cust_fab_pur_tal'] = substr($op['cust_fab_pur_tal'],0,-1);
	$op['cust_fab_rcv_tal'] = substr($op['cust_fab_rcv_tal'],0,-1);






//  取出  BOM  副料記錄 --------------------------------------------------------------
$acc_cry = array();
$op['bom_acc_NONE']= '';
$op['bom_acc'] = $po->get_acc_det($op['wi']['id']);  //取出該筆 bom 內ALL副料記錄
$num_bom_acc = count($op['bom_acc']);
if (!$num_bom_acc){	$op['bom_acc_NONE'] = "1";		}


	$j=-1;
	for ($i =0; $i< sizeof($op['bom_acc']['bom']); $i++)
	{
        $op['bom_acc'][$i] = $op['bom_acc']['bom'][$i];
		if(!isset($op['bom_acc'][$i]['po']['po_amount'])) $op['bom_acc'][$i]['po']['po_amount'] ='';
		if(!isset($op['bom_acc'][$i]['po']['price'])) $op['bom_acc'][$i]['po']['price'] ='';
		if(!isset($op['bom_acc'][$i]['po']['rcv_qty'])) $op['bom_acc'][$i]['po']['rcv_qty'] ='';

		$bom_price = 0;
		if(isset($op['bom_acc'][$i]['po']['unit']))
			$bom_price = change_unit_price($op['bom_acc'][$i]['po']['unit'],$op['bom_acc'][$i]['unit'],$op['bom_acc'][$i]['po']['price']);

		$op['bom_acc'][$i]['bom_amount'] = $op['bom_acc'][$i]['total'] * $bom_price;
		$op['bom_acc'][$i]['po']['rcv_amount'] = $op['bom_acc'][$i]['po']['rcv_qty'] * $op['bom_acc'][$i]['po']['price'];


	
	if($op['bom_acc'][$i]['po']['price'])
	{
		if($j == -1)
		{
			$j++;
			$acc_bom[$j] = $op['bom_acc'][$i]['bom_amount'];
			$acc_pur[$j] = $op['bom_acc'][$i]['po']['po_amount'];
			$acc_rcv[$j] = $op['bom_acc'][$i]['po']['rcv_amount'];
			$acc_cry[$j] = $op['bom_acc'][$i]['currency'];
		}else{				
			$tmp_j = -1;
			for($k=0; $k<sizeof($acc_cry); $k++)
			{
				if($acc_cry[$k] == $op['bom_acc'][$i]['currency']) 
				{
					$tmp_j = $k;
					break;
				}					
			}
			if($tmp_j > -1)
			{
				$acc_bom[$tmp_j]+= $op['bom_acc'][$i]['bom_amount'];						
				$acc_pur[$tmp_j]+= $op['bom_acc'][$i]['po']['po_amount'];
				$acc_rcv[$tmp_j]+= $op['bom_acc'][$i]['po']['rcv_amount'];

			}else{
				$j++;
				$acc_bom[$j] = $op['bom_acc'][$i]['bom_amount'];
				$acc_pur[$j] = $op['bom_acc'][$i]['po']['po_amount'];
				$acc_rcv[$j] = $op['bom_acc'][$i]['po']['rcv_amount'];
				$acc_cry[$j] = $op['bom_acc'][$i]['currency'];						
		  } // end if($tmp_j > -1)
		}// end if($j == -1)
	} // end if(price有)
	
	}
	
	$op['acc_bom_tal'] = $op['acc_rcv_tal'] = $op['acc_pur_tal'] = '';
	for($k=0; $k<sizeof($acc_cry); $k++)
	{
			if($acc_bom[$k] > 0) $op['acc_bom_tal'].=$acc_cry[$k]."$".NUMBER_FORMAT($acc_bom[$k],2,'.',',')."+";
			if($acc_pur[$k] > 0) $op['acc_pur_tal'].=$acc_cry[$k]."$".NUMBER_FORMAT($acc_pur[$k],2,'.',',')."+";
			if($acc_rcv[$k] > 0) $op['acc_rcv_tal'].=$acc_cry[$k]."$".NUMBER_FORMAT($acc_rcv[$k],2,'.',',')."+";
	}

	$op['acc_bom_tal'] = substr($op['acc_bom_tal'],0,-1);
	$op['acc_pur_tal'] = substr($op['acc_pur_tal'],0,-1);
	$op['acc_rcv_tal'] = substr($op['acc_rcv_tal'],0,-1);




//  取出  BOM 工廠採購 副料記錄 --------------------------------------------------------------
$acc_cry = $acc_bom = $acc_pur = $acc_rcv = array();
// $op['fty_acc'] = $po->get_acc_det($op['wi']['id'],1);  //取出該筆 bom 內ALL副料記錄
$num_fty_acc = count($op['fty_acc']);
if (!$num_fty_acc){	$op['fty_acc_NONE'] = "1";		}

	$j=-1;
	for ($i =0; $i< sizeof($op['fty_acc']); $i++)
	{
		if(!isset($op['fty_acc'][$i]['po']['po_amount'])) $op['fty_acc'][$i]['po']['po_amount'] ='';
		if(!isset($op['fty_acc'][$i]['po']['price'])) $op['fty_acc'][$i]['po']['price'] ='';
		if(!isset($op['fty_acc'][$i]['po']['rcv_qty'])) $op['fty_acc'][$i]['po']['rcv_qty'] ='';

		$bom_price = 0;
		if(isset($op['fty_acc'][$i]['po']['unit']))
			$bom_price = change_unit_price($op['fty_acc'][$i]['po']['unit'],$op['fty_acc'][$i]['unit'],$op['fty_acc'][$i]['po']['price']);

		$op['fty_acc'][$i]['bom_amount'] = $op['fty_acc'][$i]['total'] * $bom_price;
		$op['fty_acc'][$i]['po']['rcv_amount'] = $op['fty_acc'][$i]['po']['rcv_qty'] * $op['fty_acc'][$i]['po']['price'];


	
	if($op['fty_acc'][$i]['po']['price'])
	{
		if($j == -1)
		{
			$j++;
			$acc_bom[$j] = $op['fty_acc'][$i]['bom_amount'];
			$acc_pur[$j] = $op['fty_acc'][$i]['po']['po_amount'];
			$acc_rcv[$j] = $op['fty_acc'][$i]['po']['rcv_amount'];
			$acc_cry[$j] = $op['fty_acc'][$i]['currency'];
		}else{				
			$tmp_j = -1;
			for($k=0; $k<sizeof($acc_cry); $k++)
			{
				if($acc_cry[$k] == $op['fty_acc'][$i]['currency']) 
				{
					$tmp_j = $k;
					break;
				}					
			}
			if($tmp_j > -1)
			{
				$acc_bom[$tmp_j]+= $op['fty_acc'][$i]['bom_amount'];						
				$acc_pur[$tmp_j]+= $op['fty_acc'][$i]['po']['po_amount'];
				$acc_rcv[$tmp_j]+= $op['fty_acc'][$i]['po']['rcv_amount'];

			}else{
				$j++;
				$acc_bom[$j] = $op['fty_acc'][$i]['bom_amount'];
				$acc_pur[$j] = $op['fty_acc'][$i]['po']['po_amount'];
				$acc_rcv[$j] = $op['fty_acc'][$i]['po']['rcv_amount'];
				$acc_cry[$j] = $op['fty_acc'][$i]['currency'];						
		  } // end if($tmp_j > -1)
		}// end if($j == -1)
	} // end if(price有)
	
	}
	
	$op['fty_acc_bom_tal'] = $op['fty_acc_rcv_tal'] = $op['fty_acc_pur_tal'] = '';
	for($k=0; $k<sizeof($acc_cry); $k++)
	{
			if($acc_bom[$k] > 0) $op['fty_acc_bom_tal'].=$acc_cry[$k]."$".NUMBER_FORMAT($acc_bom[$k],2,'.',',')."+";
			if($acc_pur[$k] > 0) $op['fty_acc_pur_tal'].=$acc_cry[$k]."$".NUMBER_FORMAT($acc_pur[$k],2,'.',',')."+";
			if($acc_rcv[$k] > 0) $op['fty_acc_rcv_tal'].=$acc_cry[$k]."$".NUMBER_FORMAT($acc_rcv[$k],2,'.',',')."+";
	}

	$op['fty_acc_bom_tal'] = substr($op['fty_acc_bom_tal'],0,-1);
	$op['fty_acc_pur_tal'] = substr($op['fty_acc_pur_tal'],0,-1);
	$op['fty_acc_rcv_tal'] = substr($op['fty_acc_rcv_tal'],0,-1);


//  取出  BOM 客戶提供 副料記錄 --------------------------------------------------------------
$acc_cry = $acc_bom = $acc_pur = $acc_rcv = array();
// $op['cust_acc'] = $po->get_acc_det($op['wi']['id'],2);  //取出該筆 bom 內ALL副料記錄
$num_cust_acc = count($op['cust_acc']);
if (!$num_cust_acc){	$op['cust_acc_NONE'] = "1";		}

	$j=-1;
	for ($i =0; $i< sizeof($op['cust_acc']); $i++)
	{
		if(!isset($op['cust_acc'][$i]['po']['po_amount'])) $op['cust_acc'][$i]['po']['po_amount'] ='';
		if(!isset($op['cust_acc'][$i]['po']['price'])) $op['cust_acc'][$i]['po']['price'] ='';
		if(!isset($op['cust_acc'][$i]['po']['rcv_qty'])) $op['cust_acc'][$i]['po']['rcv_qty'] ='';

		$bom_price = 0;
		if(isset($op['cust_acc'][$i]['po']['unit']))
			$bom_price = change_unit_price($op['cust_acc'][$i]['po']['unit'],$op['cust_acc'][$i]['unit'],$op['cust_acc'][$i]['po']['price']);

		$op['cust_acc'][$i]['bom_amount'] = $op['cust_acc'][$i]['total'] * $bom_price;
		$op['cust_acc'][$i]['po']['rcv_amount'] = $op['cust_acc'][$i]['po']['rcv_qty'] * $op['cust_acc'][$i]['po']['price'];


	
	if($op['cust_acc'][$i]['po']['price'])
	{
		if($j == -1)
		{
			$j++;
			$acc_bom[$j] = $op['cust_acc'][$i]['bom_amount'];
			$acc_pur[$j] = $op['cust_acc'][$i]['po']['po_amount'];
			$acc_rcv[$j] = $op['cust_acc'][$i]['po']['rcv_amount'];
			$acc_cry[$j] = $op['cust_acc'][$i]['currency'];
		}else{				
			$tmp_j = -1;
			for($k=0; $k<sizeof($acc_cry); $k++)
			{
				if($acc_cry[$k] == $op['cust_acc'][$i]['currency']) 
				{
					$tmp_j = $k;
					break;
				}					
			}
			if($tmp_j > -1)
			{
				$acc_bom[$tmp_j]+= $op['cust_acc'][$i]['bom_amount'];						
				$acc_pur[$tmp_j]+= $op['cust_acc'][$i]['po']['po_amount'];
				$acc_rcv[$tmp_j]+= $op['cust_acc'][$i]['po']['rcv_amount'];

			}else{
				$j++;
				$acc_bom[$j] = $op['cust_acc'][$i]['bom_amount'];
				$acc_pur[$j] = $op['cust_acc'][$i]['po']['po_amount'];
				$acc_rcv[$j] = $op['cust_acc'][$i]['po']['rcv_amount'];
				$acc_cry[$j] = $op['cust_acc'][$i]['currency'];						
		  } // end if($tmp_j > -1)
		}// end if($j == -1)
	} // end if(price有)
	
	}
	
	$op['cust_acc_bom_tal'] = $op['cust_acc_rcv_tal'] = $op['cust_acc_pur_tal'] = '';
	for($k=0; $k<sizeof($acc_cry); $k++)
	{
			if($acc_bom[$k] > 0) $op['cust_acc_bom_tal'].=$acc_cry[$k]."$".NUMBER_FORMAT($acc_bom[$k],2,'.',',')."+";
			if($acc_pur[$k] > 0) $op['cust_acc_pur_tal'].=$acc_cry[$k]."$".NUMBER_FORMAT($acc_pur[$k],2,'.',',')."+";
			if($acc_rcv[$k] > 0) $op['cust_acc_rcv_tal'].=$acc_cry[$k]."$".NUMBER_FORMAT($acc_rcv[$k],2,'.',',')."+";
	}

	$op['cust_acc_bom_tal'] = substr($op['cust_acc_bom_tal'],0,-1);
	$op['cust_acc_pur_tal'] = substr($op['cust_acc_pur_tal'],0,-1);
	$op['cust_acc_rcv_tal'] = substr($op['cust_acc_rcv_tal'],0,-1);


//  取出  BOM  加購記錄 --------------------------------------------------------------
$op['ext_mat_NONE']= '';
// $op['ext_mat'] = $po->get_ext_ap($op['wi']['wi_num']);  //取出該筆 bom 內ALL加購記錄

$num_ext_mat = count($op['ext_mat']);
if (!$num_ext_mat){	$op['ext_mat_NONE'] = "1";		}
$j=-1;
	for ($i =0; $i< sizeof($op['ext_mat']); $i++)
	{
	
		if ( !isset( $op['ext_mat'][$i]['rcv_qty'] ) ) $op['ext_mat'][$i]['rcv_qty'] = '';
		
		$ext_price = change_unit_price( $op['ext_mat'][$i]['prc_unit'] , $op['ext_mat'][$i]['unit'] , $op['ext_mat'][$i]['prics'] );
		$op['ext_mat'][$i]['amount'] = $op['ext_mat'][$i]['po_qty'] * $ext_price;
		$op['ext_mat'][$i]['rcv_amount'] = $op['ext_mat'][$i]['rcv_qty'] * $ext_price;

		if($j == -1)
		{
			$j++;
			$ext_pur[$j] = $op['ext_mat'][$i]['amount'];
			$ext_rcv[$j] = $op['ext_mat'][$i]['rcv_amount'];
			$ext_cry[$j] = $op['ext_mat'][$i]['currency'];
		} else {				
			$tmp_j = -1;
			for($k=0; $k<sizeof($ext_cry); $k++)
			{
				if($ext_cry[$k] == $op['ext_mat'][$i]['currency']) 
				{
					$tmp_j = $k;
					break;
				}					
			}
			if($tmp_j > -1)
			{
				$ext_pur[$tmp_j]+= $op['ext_mat'][$i]['amount'];
				$ext_rcv[$tmp_j]+= $op['ext_mat'][$i]['rcv_amount'];

			}else{
				$j++;
				$ext_pur[$j] = $op['ext_mat'][$i]['amount'];
				$ext_rcv[$j] = $op['ext_mat'][$i]['rcv_amount'];
				$ext_cry[$j] = $op['ext_mat'][$i]['currency'];						
		  } // end if($tmp_j > -1)
		}// end if($j == -1)
		
	}	
if(isset($ext_cry))
{
	$op['ext_bom_tal'] = $op['ext_rcv_tal'] = $op['ext_pur_tal'] = '';
	for($k=0; $k<sizeof($ext_cry); $k++)
	{
			if($ext_pur[$k] > 0) $op['ext_pur_tal'].=$ext_cry[$k]."$".NUMBER_FORMAT($ext_pur[$k],2,'.',',')."+";
			if($ext_rcv[$k] > 0) $op['ext_rcv_tal'].=$ext_cry[$k]."$".NUMBER_FORMAT($ext_rcv[$k],2,'.',',')."+";
	}

	$op['ext_pur_tal'] = substr($op['ext_pur_tal'],0,-1);
	$op['ext_rcv_tal'] = substr($op['ext_rcv_tal'],0,-1);
}


//  取出  BOM  Disable計錄中己採購主料者 --------------------------------------------------------------
$op['dis_lots_NONE']= '';
$op['dis_lots'] = $bom->get_dis_lots($op['wi']['id']);  //取出該筆 bom 內記錄
$num_lots = count($op['dis_lots']);
if (!$num_lots){	$op['dis_lots_NONE'] = "1";}
$j=-1;

	for ($i =0; $i< sizeof($op['dis_lots']); $i++)
	{
			if(!isset($op['dis_lots'][$i]['rcv_qty']))$op['dis_lots'][$i]['rcv_qty'] = '';
			$op['dis_lots'][$i]['amount'] = $op['dis_lots'][$i]['po_qty'] * $op['dis_lots'][$i]['prics'];
			$op['dis_lots'][$i]['rcv_amount'] =$op['dis_lots'][$i]['rcv_qty'] * $op['dis_lots'][$i]['prics'];
			
			$bom_price = change_unit_price($op['dis_lots'][$i]['po_unit'],$op['dis_lots'][$i]['unit'],$op['dis_lots'][$i]['prics']);
			$op['dis_lots'][$i]['bom_amount'] = $op['dis_lots'][$i]['bom_qty'] * $bom_price;
		if($j == -1)
		{
			$j++;
			$dis_lots_bom[$j] = $op['dis_lots'][$i]['bom_amount'];
			$dis_lots_pur[$j] = $op['dis_lots'][$i]['amount'];
			$dis_lots_rcv[$j] = $op['dis_lots'][$i]['rcv_amount'];
			$dis_lots_cry[$j] = $op['dis_lots'][$i]['currency'];
			
		}else{				
			$tmp_j = -1;
			for($k=0; $k<sizeof($dis_lots_cry); $k++)
			{
				if($dis_lots_cry[$k] == $op['dis_lots'][$i]['currency']) 
				{
					$tmp_j = $k;
					break;
				}					
			}
			if($tmp_j > -1)
			{
				$dis_lots_bom[$tmp_j]+= $op['dis_lots'][$i]['bom_amount'];
				$dis_lots_pur[$tmp_j]+= $op['dis_lots'][$i]['amount'];
				$dis_lots_rcv[$tmp_j]+= $op['dis_lots'][$i]['rcv_amount'];

			}else{
				$j++;
				$dis_lots_bom[$j] = $op['dis_lots'][$i]['bom_amount'];
				$dis_lots_pur[$j] = $op['dis_lots'][$i]['amount'];
				$dis_lots_rcv[$j] = $op['dis_lots'][$i]['rcv_amount'];
				$dis_lots_cry[$j] = $op['dis_lots'][$i]['currency'];						
		  } // end if($tmp_j > -1)
		}// end if($j == -1)
		
	}	
if(isset($dis_lots_cry))
{
	$op['dis_lots_bom_tal'] =$op['dis_lots_rcv_tal'] = $op['dis_lots_pur_tal'] = '';
	for($k=0; $k<sizeof($dis_lots_cry); $k++)
	{
			
			if($dis_lots_bom[$k] > 0) $op['dis_lots_bom_tal'].=$dis_lots_cry[$k]."$".NUMBER_FORMAT($dis_lots_bom[$k],2,'.',',')."+";
			if($dis_lots_pur[$k] > 0) $op['dis_lots_pur_tal'].=$dis_lots_cry[$k]."$".NUMBER_FORMAT($dis_lots_pur[$k],2,'.',',')."+";
			if($dis_lots_rcv[$k] > 0) $op['dis_lots_rcv_tal'].=$dis_lots_cry[$k]."$".NUMBER_FORMAT($dis_lots_rcv[$k],2,'.',',')."+";
	}

	$op['dis_lots_bom_tal'] = substr($op['dis_lots_bom_tal'],0,-1);
	$op['dis_lots_pur_tal'] = substr($op['dis_lots_pur_tal'],0,-1);
	$op['dis_lots_rcv_tal'] = substr($op['dis_lots_rcv_tal'],0,-1);
}



//  取出  BOM  Disable計錄中己採購副料者 --------------------------------------------------------------
$op['dis_acc_NONE']= '';
// $op['dis_acc'] = $bom->get_dis_acc($op['wi']['id']);  //取出該筆 bom 內記錄
$num_acc = count($op['dis_acc']);
if (!$num_acc){	$op['dis_acc_NONE'] = "1";}
$j = -1;
for ($i =0; $i< sizeof($op['dis_acc']); $i++)
	{
			if(!isset($op['dis_acc'][$i]['rcv_qty']))$op['dis_acc'][$i]['rcv_qty'] = '';
			$op['dis_acc'][$i]['amount'] = $op['dis_acc'][$i]['po_qty'] * $op['dis_acc'][$i]['prics'];
			$op['dis_acc'][$i]['rcv_amount'] =$op['dis_acc'][$i]['rcv_qty'] * $op['dis_acc'][$i]['prics'];

			$bom_price = change_unit_price($op['dis_acc'][$i]['po_unit'],$op['dis_acc'][$i]['unit'],$op['dis_acc'][$i]['prics']);
			$op['dis_acc'][$i]['bom_amount'] = $op['dis_acc'][$i]['bom_qty'] * $bom_price;
		if($j == -1)
		{
			$j++;
			$dis_acc_bom[$j] = $op['dis_acc'][$i]['bom_amount'];
			$dis_acc_pur[$j] = $op['dis_acc'][$i]['amount'];
			$dis_acc_rcv[$j] = $op['dis_acc'][$i]['rcv_amount'];
			$dis_acc_cry[$j] = $op['dis_acc'][$i]['currency'];
		}else{				
			$tmp_j = -1;
			for($k=0; $k<sizeof($dis_acc_cry); $k++)
			{
				if($dis_acc_cry[$k] == $op['dis_acc'][$i]['currency']) 
				{
					$tmp_j = $k;
					break;
				}					
			}
			if($tmp_j > -1)
			{
				$dis_acc_bom[$tmp_j]+= $op['dis_acc'][$i]['bom_amount'];
				$dis_acc_pur[$tmp_j]+= $op['dis_acc'][$i]['amount'];
				$dis_acc_rcv[$tmp_j]+= $op['dis_acc'][$i]['rcv_amount'];

			}else{
				$j++;
				$dis_acc_bom[$j] = $op['dis_acc'][$i]['bom_amount'];
				$dis_acc_pur[$j] = $op['dis_acc'][$i]['amount'];
				$dis_acc_rcv[$j] = $op['dis_acc'][$i]['rcv_amount'];
				$dis_acc_cry[$j] = $op['dis_acc'][$i]['currency'];						
		  } // end if($tmp_j > -1)
		}// end if($j == -1)
		
	}	
if(isset($dis_acc_cry))
{
	$op['dis_acc_bom_tal'] =$op['dis_acc_rcv_tal'] = $op['dis_acc_pur_tal'] = '';
	for($k=0; $k<sizeof($dis_acc_cry); $k++)
	{
			if($dis_acc_bom[$k] > 0) $op['dis_acc_bom_tal'].=$dis_acc_cry[$k]."$".NUMBER_FORMAT($dis_acc_bom[$k],2,'.',',')."+";
			if($dis_acc_pur[$k] > 0) $op['dis_acc_pur_tal'].=$dis_acc_cry[$k]."$".NUMBER_FORMAT($dis_acc_pur[$k],2,'.',',')."+";
			if($dis_acc_rcv[$k] > 0) $op['dis_lacc_rcv_tal'].=$dis_acc_cry[$k]."$".NUMBER_FORMAT($dis_acc_rcv[$k],2,'.',',')."+";
	}

	$op['dis_acc_bom_tal'] = substr($op['dis_acc_bom_tal'],0,-1);
	$op['dis_acc_pur_tal'] = substr($op['dis_acc_pur_tal'],0,-1);
	$op['dis_acc_rcv_tal'] = substr($op['dis_acc_rcv_tal'],0,-1);
}








page_display($op, '065', $TPL_ORD_FANL_VIEW);
break;

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//	case "ord_batch_cost2":		ORDER->order rec.->batch cost 
//	2011.08.18 財務用(查詢指定月份的驗收)
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    case "ord_batch_cost2":

		check_authority('065',"view");
		
		$op['year'] = $arry2->select($YEAR_WORK,date("Y"),'PHP_year','select','');  	
		$op['mon'] = $arry2->select($MONTH_WORK,$PHP_month,'PHP_month','select','');  
		
		//-------------------- 將 製造令 show out ------------------
		//  wi 主檔
	if (isset($PHP_id))
	{
		if(!$op['wi'] = $wi->get($PHP_id)){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
	}else{	
		if(!$op['wi']  = $wi->get(0,$PHP_bom_num)){    //取出該筆 製造令記錄
					$op['msg']= $wi->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
	}
		//  smpl 樣本檔
		if(!$op['order'] = $order->get($op['wi']['smpl_id'])){
					$op['msg']= $order->msg->get(2);
					$layout->assign($op);
					$layout->display($TPL_ERROR);  		    
					break;
		}
		$size_data=$size_des->get($op['order']['size']);		
		$op['order']['size']=$size_data['size_scale'];

		//-----------------------------------------------------------------

		// 相片的URL決定 ------------------------------------------------------
				$style_dir	= "./picture/";  
				$no_img		= "./images/graydot.gif";
			if(file_exists($style_dir.$op['wi']['style_code'].".jpg")){
				$op['wi']['pic_url'] = $style_dir.$op['wi']['style_code'].".jpg";
			} else {
				$op['wi']['pic_url'] = $no_img;
			}
		//  取出  BOM  主料記錄 --------------------------------------------------------------
//		 $op['fab_bom_tal'] = $op['fab_pur_tal'] = $op['fab_rcv_tal'] = 0;
		 $tmp_cry = array();
		 $op['bom_lots_NONE']= '';
	 	 $op['bom_lots'] = $po->get_lots_det($op['wi']['id']);  //取出該筆 bom 內ALL主料記錄
		
		 $num_bom_lots = count($op['bom_lots']);
		 if (!$num_bom_lots){	$op['bom_lots_NONE'] = "1";		}

			$tmp_date = explode(' ',$op['wi']['bcfm_date']);
			$bom_sub_date = $tmp_date[0];
			$parm = array("str"		=>	'2008-01-01',
									"end"		=>	$TODAY,
									"ship"	=>	'',
									"cat"		=>	"F",
									"ord"		=>	$op['wi']['wi_num'],
									"price"	=>	1
									);
//			$fab_rcv = $receive->search_rpt_dtl($parm);
			$j = -1;
		 	for ($i =0; $i< sizeof($op['bom_lots']); $i++)
		 	{
//增加數量總計 080604
				if(!isset($op['bom_lots'][$i]['po']['po_amount'])) $op['bom_lots'][$i]['po']['po_amount'] ='';
				if(!isset($op['bom_lots'][$i]['po']['price'])) $op['bom_lots'][$i]['po']['price'] ='';
				if(!isset($op['bom_lots'][$i]['po']['rcv_qty'])) $op['bom_lots'][$i]['po']['rcv_qty'] ='';
				
				$op['bom_lots'][$i]['receive']['qty'] = $receive->get_revd_det2($op['bom_lots'][$i]['ap_id'],$op['bom_lots'][$i]['po']['id'],$PHP_year."-".$PHP_month);
				
				$bom_price = 0;
				if(isset($op['bom_lots'][$i]['po']['unit']) )				
					$bom_price = change_unit_price($op['bom_lots'][$i]['po']['unit'],$op['bom_lots'][$i]['unit'],$op['bom_lots'][$i]['po']['price']);
								
				$op['bom_lots'][$i]['bom_amount'] = $op['bom_lots'][$i]['total'] * $bom_price;
				//$op['bom_lots'][$i]['po']['rcv_amount'] = $op['bom_lots'][$i]['po']['rcv_qty'] * $op['bom_lots'][$i]['po']['price'];
				$op['bom_lots'][$i]['receive']['rcv_amount'] = $op['bom_lots'][$i]['receive']['qty'] * $op['bom_lots'][$i]['po']['price'];
				
			//$op['fab_rcv_tal'] += $op['bom_lots'][$i]['po']['rcv_amount'];
				
			if($op['bom_lots'][$i]['po']['price'])
			{
				if($j == -1)
				{
					$j++;
					$fab_bom[$j] = $op['bom_lots'][$i]['bom_amount'];
					$fab_pur[$j] = $op['bom_lots'][$i]['po']['po_amount'];
					//$fab_rcv[$j] = $op['bom_lots'][$i]['po']['rcv_amount'];
					$fab_rcv[$j] = $op['bom_lots'][$i]['receive']['rcv_amount'];
					
					$tmp_cry[$j] = $op['bom_lots'][$i]['currency'];
				}else{				
					$tmp_j = -1;
					for($k=0; $k<sizeof($tmp_cry); $k++)
					{
						if($tmp_cry[$k] == $op['bom_lots'][$i]['currency']) 
						{
							$tmp_j = $k;
							break;
						}					
					}
					if($tmp_j > -1)
					{
						$fab_bom[$tmp_j]+= $op['bom_lots'][$i]['bom_amount'];						
						$fab_pur[$tmp_j]+= $op['bom_lots'][$i]['po']['po_amount'];
						//$fab_rcv[$tmp_j]+= $op['bom_lots'][$i]['po']['rcv_amount'];
						$fab_rcv[$tmp_j]+= $op['bom_lots'][$i]['receive']['rcv_amount'];
						
					}else{
						$j++;
						$fab_bom[$j] = $op['bom_lots'][$i]['bom_amount'];
						$fab_pur[$j] = $op['bom_lots'][$i]['po']['po_amount'];
						//$fab_rcv[$j] = $op['bom_lots'][$i]['po']['rcv_amount'];
						$fab_rcv[$j] = $op['bom_lots'][$i]['receive']['rcv_amount'];
						$tmp_cry[$j] = $op['bom_lots'][$i]['currency'];						
				  } // end if($tmp_j > -1)
				}// end if($j == -1)
			}
				
		 	}

			$op['fab_bom_tal'] = $op['fab_rcv_tal'] = $op['fab_pur_tal'] = '';
			for($k=0; $k<sizeof($tmp_cry); $k++)
			{
					if($fab_bom[$k] > 0) $op['fab_bom_tal'].=$tmp_cry[$k]."$".NUMBER_FORMAT($fab_bom[$k],2,'.',',')."+";
					if($fab_pur[$k] > 0) $op['fab_pur_tal'].=$tmp_cry[$k]."$".NUMBER_FORMAT($fab_pur[$k],2,'.',',')."+";
					if($fab_rcv[$k] > 0) $op['fab_rcv_tal'].=$tmp_cry[$k]."$".NUMBER_FORMAT($fab_rcv[$k],2,'.',',')."+";
			}

			$op['fab_bom_tal'] = substr($op['fab_bom_tal'],0,-1);
			$op['fab_pur_tal'] = substr($op['fab_pur_tal'],0,-1);
			$op['fab_rcv_tal'] = substr($op['fab_rcv_tal'],0,-1);


		//  取出  BOM  工廠採購 主料記錄 --------------------------------------------------------------
		 $tmp_cry = $fab_bom = $fab_pur = $fab_rcv =array();
		 
	 	 $op['fty_lots'] = $po->get_lots_det($op['wi']['id'],1);  //取出該筆 bom 內ALL主料記錄
		 $num_fty_lots = count($op['fty_lots']);
		 if (!$num_fty_lots){	$op['fty_lots_NONE'] = "1";		}

			$j = -1;
		 	for ($i =0; $i< sizeof($op['fty_lots']); $i++)
		 	{		 		
//增加數量總計 080604
				if(!isset($op['fty_lots'][$i]['po']['po_amount'])) $op['fty_lots'][$i]['po']['po_amount'] ='';
				if(!isset($op['fty_lots'][$i]['po']['price'])) $op['fty_lots'][$i]['po']['price'] ='';
				if(!isset($op['fty_lots'][$i]['po']['rcv_qty'])) $op['fty_lots'][$i]['po']['rcv_qty'] ='';
				$bom_price = 0;
				if(isset($op['fty_lots'][$i]['po']['unit']) )				
					$bom_price = change_unit_price($op['fty_lots'][$i]['po']['unit'],$op['fty_lots'][$i]['unit'],$op['fty_lots'][$i]['po']['price']);
								
				$op['fty_lots'][$i]['bom_amount'] = $op['fty_lots'][$i]['total'] * $bom_price;
				$op['fty_lots'][$i]['po']['rcv_amount'] = $op['fty_lots'][$i]['po']['rcv_qty'] * $op['fty_lots'][$i]['po']['price'];

//			$op['fab_rcv_tal'] += $op['fty_lots'][$i]['po']['rcv_amount'];
				
			if($op['fty_lots'][$i]['po']['price'])
			{
				if($j == -1)
				{
					$j++;
					$fab_bom[$j] = $op['fty_lots'][$i]['bom_amount'];
					$fab_pur[$j] = $op['fty_lots'][$i]['po']['po_amount'];
					$fab_rcv[$j] = $op['fty_lots'][$i]['po']['rcv_amount'];

					$tmp_cry[$j] = $op['fty_lots'][$i]['currency'];
				}else{				
					$tmp_j = -1;
					for($k=0; $k<sizeof($tmp_cry); $k++)
					{
						if($tmp_cry[$k] == $op['fty_lots'][$i]['currency']) 
						{
							$tmp_j = $k;
							break;
						}					
					}
					if($tmp_j > -1)
					{
						$fab_bom[$tmp_j]+= $op['fty_lots'][$i]['bom_amount'];						
						$fab_pur[$tmp_j]+= $op['fty_lots'][$i]['po']['po_amount'];
						$fab_rcv[$tmp_j]+= $op['fty_lots'][$i]['po']['rcv_amount'];

					}else{
						$j++;
						$fab_bom[$j] = $op['fty_lots'][$i]['bom_amount'];
						$fab_pur[$j] = $op['fty_lots'][$i]['po']['po_amount'];
						$fab_rcv[$j] = $op['fty_lots'][$i]['po']['rcv_amount'];
						$tmp_cry[$j] = $op['fty_lots'][$i]['currency'];						
				  } // end if($tmp_j > -1)
				}// end if($j == -1)
			}
				
		 	}

			$op['fty_fab_bom_tal'] = $op['fty_fab_rcv_tal'] = $op['fty_fab_pur_tal'] = '';
			for($k=0; $k<sizeof($tmp_cry); $k++)
			{
                if($fab_bom[$k] > 0) $op['fty_fab_bom_tal'].=$tmp_cry[$k]."$".NUMBER_FORMAT($fab_bom[$k],2,'.',',')."+";
                if($fab_pur[$k] > 0) $op['fty_fab_pur_tal'].=$tmp_cry[$k]."$".NUMBER_FORMAT($fab_pur[$k],2,'.',',')."+";
                if($fab_rcv[$k] > 0) $op['fty_fab_rcv_tal'].=$tmp_cry[$k]."$".NUMBER_FORMAT($fab_rcv[$k],2,'.',',')."+";
			}

			$op['fty_fab_bom_tal'] = substr($op['fty_fab_bom_tal'],0,-1);
			$op['fty_fab_pur_tal'] = substr($op['fty_fab_pur_tal'],0,-1);
			$op['fty_fab_rcv_tal'] = substr($op['fty_fab_rcv_tal'],0,-1);



		//  取出  BOM  客戶提供 主料記錄 --------------------------------------------------------------
		 $tmp_cry = $fab_bom = $fab_pur = $fab_rcv =array();
		 
	 	 $op['cust_lots'] = $po->get_lots_det($op['wi']['id'],2);  //取出該筆 bom 內ALL主料記錄
		 $num_cust_lots = count($op['cust_lots']);
		 if (!$num_cust_lots){	$op['cust_lots_NONE'] = "1";		}

			$j = -1;
		 	for ($i =0; $i< sizeof($op['cust_lots']); $i++)
		 	{		 		
//增加數量總計 080604
				if(!isset($op['cust_lots'][$i]['po']['po_amount'])) $op['cust_lots'][$i]['po']['po_amount'] ='';
				if(!isset($op['cust_lots'][$i]['po']['price'])) $op['cust_lots'][$i]['po']['price'] ='';
				if(!isset($op['cust_lots'][$i]['po']['rcv_qty'])) $op['cust_lots'][$i]['po']['rcv_qty'] ='';
				$bom_price = 0;
				if(isset($op['cust_lots'][$i]['po']['unit']) )				
					$bom_price = change_unit_price($op['cust_lots'][$i]['po']['unit'],$op['cust_lots'][$i]['unit'],$op['cust_lots'][$i]['po']['price']);
								
				$op['cust_lots'][$i]['bom_amount'] = $op['cust_lots'][$i]['total'] * $bom_price;
				$op['cust_lots'][$i]['po']['rcv_amount'] = $op['cust_lots'][$i]['po']['rcv_qty'] * $op['cust_lots'][$i]['po']['price'];

//			$op['fab_rcv_tal'] += $op['cust_lots'][$i]['po']['rcv_amount'];
				
			if($op['cust_lots'][$i]['po']['price'])
			{
				if($j == -1)
				{
					$j++;
					$fab_bom[$j] = $op['cust_lots'][$i]['bom_amount'];
					$fab_pur[$j] = $op['cust_lots'][$i]['po']['po_amount'];
					$fab_rcv[$j] = $op['cust_lots'][$i]['po']['rcv_amount'];

					$tmp_cry[$j] = $op['cust_lots'][$i]['currency'];
				}else{				
					$tmp_j = -1;
					for($k=0; $k<sizeof($tmp_cry); $k++)
					{
						if($tmp_cry[$k] == $op['cust_lots'][$i]['currency']) 
						{
							$tmp_j = $k;
							break;
						}					
					}
					if($tmp_j > -1)
					{
						$fab_bom[$tmp_j]+= $op['cust_lots'][$i]['bom_amount'];						
						$fab_pur[$tmp_j]+= $op['cust_lots'][$i]['po']['po_amount'];
						$fab_rcv[$tmp_j]+= $op['cust_lots'][$i]['po']['rcv_amount'];

					}else{
						$j++;
						$fab_bom[$j] = $op['cust_lots'][$i]['bom_amount'];
						$fab_pur[$j] = $op['cust_lots'][$i]['po']['po_amount'];
						$fab_rcv[$j] = $op['cust_lots'][$i]['po']['rcv_amount'];
						$tmp_cry[$j] = $op['cust_lots'][$i]['currency'];						
				  } // end if($tmp_j > -1)
				}// end if($j == -1)
			}
				
		 	}

			$op['cust_fab_bom_tal'] = $op['cust_fab_rcv_tal'] = $op['cust_fab_pur_tal'] = '';
			for($k=0; $k<sizeof($tmp_cry); $k++)
			{
					if($fab_bom[$k] > 0) $op['cust_fab_bom_tal'].=$tmp_cry[$k]."$".NUMBER_FORMAT($fab_bom[$k],2,'.',',')."+";
					if($fab_pur[$k] > 0) $op['cust_fab_pur_tal'].=$tmp_cry[$k]."$".NUMBER_FORMAT($fab_pur[$k],2,'.',',')."+";
					if($fab_rcv[$k] > 0) $op['cust_fab_rcv_tal'].=$tmp_cry[$k]."$".NUMBER_FORMAT($fab_rcv[$k],2,'.',',')."+";
			}

			$op['cust_fab_bom_tal'] = substr($op['cust_fab_bom_tal'],0,-1);
			$op['cust_fab_pur_tal'] = substr($op['cust_fab_pur_tal'],0,-1);
			$op['cust_fab_rcv_tal'] = substr($op['cust_fab_rcv_tal'],0,-1);






		//  取出  BOM  副料記錄 --------------------------------------------------------------
		$acc_cry = array();
		$op['bom_acc_NONE']= '';
		$op['bom_acc'] = $po->get_acc_det($op['wi']['id']);  //取出該筆 bom 內ALL副料記錄

		$num_bom_acc = count($op['bom_acc']);
		if (!$num_bom_acc){	$op['bom_acc_NONE'] = "1";		}


			$j=-1;
		 	for ($i =0; $i< sizeof($op['bom_acc']); $i++)
		 	{
				if(!isset($op['bom_acc'][$i]['po']['po_amount'])) $op['bom_acc'][$i]['po']['po_amount'] ='';
				if(!isset($op['bom_acc'][$i]['po']['price'])) $op['bom_acc'][$i]['po']['price'] ='';
				if(!isset($op['bom_acc'][$i]['po']['rcv_qty'])) $op['bom_acc'][$i]['po']['rcv_qty'] ='';

				$op['bom_acc'][$i]['receive']['qty'] = $receive->get_revd_det2($op['bom_acc'][$i]['ap_id'],$op['bom_acc'][$i]['po']['id'],$PHP_year."-".$PHP_month);
				
				$bom_price = 0;
				if(isset($op['bom_acc'][$i]['po']['unit']))
					$bom_price = change_unit_price($op['bom_acc'][$i]['po']['unit'],$op['bom_acc'][$i]['unit'],$op['bom_acc'][$i]['po']['price']);

				$op['bom_acc'][$i]['bom_amount'] = $op['bom_acc'][$i]['total'] * $bom_price;
				//$op['bom_acc'][$i]['po']['rcv_amount'] = $op['bom_acc'][$i]['po']['rcv_qty'] * $op['bom_acc'][$i]['po']['price'];
				$op['bom_acc'][$i]['receive']['rcv_amount'] = $op['bom_acc'][$i]['receive']['qty'] * $op['bom_acc'][$i]['po']['price'];

			
			if($op['bom_acc'][$i]['po']['price'])
			{
				if($j == -1)
				{
					$j++;
					$acc_bom[$j] = $op['bom_acc'][$i]['bom_amount'];
					$acc_pur[$j] = $op['bom_acc'][$i]['po']['po_amount'];
					//$acc_rcv[$j] = $op['bom_acc'][$i]['po']['rcv_amount'];
					$acc_rcv[$j] = $op['bom_acc'][$i]['receive']['rcv_amount'];
					$acc_cry[$j] = $op['bom_acc'][$i]['currency'];
				}else{				
					$tmp_j = -1;
					for($k=0; $k<sizeof($acc_cry); $k++)
					{
						if($acc_cry[$k] == $op['bom_acc'][$i]['currency']) 
						{
							$tmp_j = $k;
							break;
						}					
					}
					if($tmp_j > -1)
					{
						$acc_bom[$tmp_j]+= $op['bom_acc'][$i]['bom_amount'];						
						$acc_pur[$tmp_j]+= $op['bom_acc'][$i]['po']['po_amount'];
						//$acc_rcv[$tmp_j]+= $op['bom_acc'][$i]['po']['rcv_amount'];
						$acc_rcv[$tmp_j]+= $op['bom_acc'][$i]['receive']['rcv_amount'];

					}else{
						$j++;
						$acc_bom[$j] = $op['bom_acc'][$i]['bom_amount'];
						$acc_pur[$j] = $op['bom_acc'][$i]['po']['po_amount'];
						//$acc_rcv[$j] = $op['bom_acc'][$i]['po']['rcv_amount'];
						$acc_rcv[$j] = $op['bom_acc'][$i]['receive']['rcv_amount'];
						$acc_cry[$j] = $op['bom_acc'][$i]['currency'];						
				  } // end if($tmp_j > -1)
				}// end if($j == -1)
			} // end if(price有)
			
		 	}
		 	
			$op['acc_bom_tal'] = $op['acc_rcv_tal'] = $op['acc_pur_tal'] = '';
			for($k=0; $k<sizeof($acc_cry); $k++)
			{
					if($acc_bom[$k] > 0) $op['acc_bom_tal'].=$acc_cry[$k]."$".NUMBER_FORMAT($acc_bom[$k],2,'.',',')."+";
					if($acc_pur[$k] > 0) $op['acc_pur_tal'].=$acc_cry[$k]."$".NUMBER_FORMAT($acc_pur[$k],2,'.',',')."+";
					if($acc_rcv[$k] > 0) $op['acc_rcv_tal'].=$acc_cry[$k]."$".NUMBER_FORMAT($acc_rcv[$k],2,'.',',')."+";
			}

			$op['acc_bom_tal'] = substr($op['acc_bom_tal'],0,-1);
			$op['acc_pur_tal'] = substr($op['acc_pur_tal'],0,-1);
			$op['acc_rcv_tal'] = substr($op['acc_rcv_tal'],0,-1);




		//  取出  BOM 工廠採購 副料記錄 --------------------------------------------------------------
		$acc_cry = $acc_bom = $acc_pur = $acc_rcv = array();
		$op['fty_acc'] = $po->get_acc_det($op['wi']['id'],1);  //取出該筆 bom 內ALL副料記錄
		$num_fty_acc = count($op['fty_acc']);
		if (!$num_fty_acc){	$op['fty_acc_NONE'] = "1";		}

			$j=-1;
		 	for ($i =0; $i< sizeof($op['fty_acc']); $i++)
		 	{
				if(!isset($op['fty_acc'][$i]['po']['po_amount'])) $op['fty_acc'][$i]['po']['po_amount'] ='';
				if(!isset($op['fty_acc'][$i]['po']['price'])) $op['fty_acc'][$i]['po']['price'] ='';
				if(!isset($op['fty_acc'][$i]['po']['rcv_qty'])) $op['fty_acc'][$i]['po']['rcv_qty'] ='';

				$bom_price = 0;
				if(isset($op['fty_acc'][$i]['po']['unit']))
					$bom_price = change_unit_price($op['fty_acc'][$i]['po']['unit'],$op['fty_acc'][$i]['unit'],$op['fty_acc'][$i]['po']['price']);

				$op['fty_acc'][$i]['bom_amount'] = $op['fty_acc'][$i]['total'] * $bom_price;
				$op['fty_acc'][$i]['po']['rcv_amount'] = $op['fty_acc'][$i]['po']['rcv_qty'] * $op['fty_acc'][$i]['po']['price'];


			
			if($op['fty_acc'][$i]['po']['price'])
			{
				if($j == -1)
				{
					$j++;
					$acc_bom[$j] = $op['fty_acc'][$i]['bom_amount'];
					$acc_pur[$j] = $op['fty_acc'][$i]['po']['po_amount'];
					$acc_rcv[$j] = $op['fty_acc'][$i]['po']['rcv_amount'];
					$acc_cry[$j] = $op['fty_acc'][$i]['currency'];
				}else{				
					$tmp_j = -1;
					for($k=0; $k<sizeof($acc_cry); $k++)
					{
						if($acc_cry[$k] == $op['fty_acc'][$i]['currency']) 
						{
							$tmp_j = $k;
							break;
						}					
					}
					if($tmp_j > -1)
					{
						$acc_bom[$tmp_j]+= $op['fty_acc'][$i]['bom_amount'];						
						$acc_pur[$tmp_j]+= $op['fty_acc'][$i]['po']['po_amount'];
						$acc_rcv[$tmp_j]+= $op['fty_acc'][$i]['po']['rcv_amount'];

					}else{
						$j++;
						$acc_bom[$j] = $op['fty_acc'][$i]['bom_amount'];
						$acc_pur[$j] = $op['fty_acc'][$i]['po']['po_amount'];
						$acc_rcv[$j] = $op['fty_acc'][$i]['po']['rcv_amount'];
						$acc_cry[$j] = $op['fty_acc'][$i]['currency'];						
				  } // end if($tmp_j > -1)
				}// end if($j == -1)
			} // end if(price有)
			
		 	}
		 	
			$op['fty_acc_bom_tal'] = $op['fty_acc_rcv_tal'] = $op['fty_acc_pur_tal'] = '';
			for($k=0; $k<sizeof($acc_cry); $k++)
			{
					if($acc_bom[$k] > 0) $op['fty_acc_bom_tal'].=$acc_cry[$k]."$".NUMBER_FORMAT($acc_bom[$k],2,'.',',')."+";
					if($acc_pur[$k] > 0) $op['fty_acc_pur_tal'].=$acc_cry[$k]."$".NUMBER_FORMAT($acc_pur[$k],2,'.',',')."+";
					if($acc_rcv[$k] > 0) $op['fty_acc_rcv_tal'].=$acc_cry[$k]."$".NUMBER_FORMAT($acc_rcv[$k],2,'.',',')."+";
			}

			$op['fty_acc_bom_tal'] = substr($op['fty_acc_bom_tal'],0,-1);
			$op['fty_acc_pur_tal'] = substr($op['fty_acc_pur_tal'],0,-1);
			$op['fty_acc_rcv_tal'] = substr($op['fty_acc_rcv_tal'],0,-1);


		//  取出  BOM 客戶提供 副料記錄 --------------------------------------------------------------
		$acc_cry = $acc_bom = $acc_pur = $acc_rcv = array();
		$op['cust_acc'] = $po->get_acc_det($op['wi']['id'],2);  //取出該筆 bom 內ALL副料記錄
		$num_cust_acc = count($op['cust_acc']);
		if (!$num_cust_acc){	$op['cust_acc_NONE'] = "1";		}

			$j=-1;
		 	for ($i =0; $i< sizeof($op['cust_acc']); $i++)
		 	{
				if(!isset($op['cust_acc'][$i]['po']['po_amount'])) $op['cust_acc'][$i]['po']['po_amount'] ='';
				if(!isset($op['cust_acc'][$i]['po']['price'])) $op['cust_acc'][$i]['po']['price'] ='';
				if(!isset($op['cust_acc'][$i]['po']['rcv_qty'])) $op['cust_acc'][$i]['po']['rcv_qty'] ='';

				$bom_price = 0;
				if(isset($op['cust_acc'][$i]['po']['unit']))
					$bom_price = change_unit_price($op['cust_acc'][$i]['po']['unit'],$op['cust_acc'][$i]['unit'],$op['cust_acc'][$i]['po']['price']);

				$op['cust_acc'][$i]['bom_amount'] = $op['cust_acc'][$i]['total'] * $bom_price;
				$op['cust_acc'][$i]['po']['rcv_amount'] = $op['cust_acc'][$i]['po']['rcv_qty'] * $op['cust_acc'][$i]['po']['price'];


			
			if($op['cust_acc'][$i]['po']['price'])
			{
				if($j == -1)
				{
					$j++;
					$acc_bom[$j] = $op['cust_acc'][$i]['bom_amount'];
					$acc_pur[$j] = $op['cust_acc'][$i]['po']['po_amount'];
					$acc_rcv[$j] = $op['cust_acc'][$i]['po']['rcv_amount'];
					$acc_cry[$j] = $op['cust_acc'][$i]['currency'];
				}else{				
					$tmp_j = -1;
					for($k=0; $k<sizeof($acc_cry); $k++)
					{
						if($acc_cry[$k] == $op['cust_acc'][$i]['currency']) 
						{
							$tmp_j = $k;
							break;
						}					
					}
					if($tmp_j > -1)
					{
						$acc_bom[$tmp_j]+= $op['cust_acc'][$i]['bom_amount'];						
						$acc_pur[$tmp_j]+= $op['cust_acc'][$i]['po']['po_amount'];
						$acc_rcv[$tmp_j]+= $op['cust_acc'][$i]['po']['rcv_amount'];

					}else{
						$j++;
						$acc_bom[$j] = $op['cust_acc'][$i]['bom_amount'];
						$acc_pur[$j] = $op['cust_acc'][$i]['po']['po_amount'];
						$acc_rcv[$j] = $op['cust_acc'][$i]['po']['rcv_amount'];
						$acc_cry[$j] = $op['cust_acc'][$i]['currency'];						
				  } // end if($tmp_j > -1)
				}// end if($j == -1)
			} // end if(price有)
			
		 	}
		 	
			$op['cust_acc_bom_tal'] = $op['cust_acc_rcv_tal'] = $op['cust_acc_pur_tal'] = '';
			for($k=0; $k<sizeof($acc_cry); $k++)
			{
					if($acc_bom[$k] > 0) $op['cust_acc_bom_tal'].=$acc_cry[$k]."$".NUMBER_FORMAT($acc_bom[$k],2,'.',',')."+";
					if($acc_pur[$k] > 0) $op['cust_acc_pur_tal'].=$acc_cry[$k]."$".NUMBER_FORMAT($acc_pur[$k],2,'.',',')."+";
					if($acc_rcv[$k] > 0) $op['cust_acc_rcv_tal'].=$acc_cry[$k]."$".NUMBER_FORMAT($acc_rcv[$k],2,'.',',')."+";
			}

			$op['cust_acc_bom_tal'] = substr($op['cust_acc_bom_tal'],0,-1);
			$op['cust_acc_pur_tal'] = substr($op['cust_acc_pur_tal'],0,-1);
			$op['cust_acc_rcv_tal'] = substr($op['cust_acc_rcv_tal'],0,-1);


		//  取出  BOM  加購記錄 --------------------------------------------------------------
		$op['ext_mat_NONE']= '';
		$op['ext_mat'] = $po->get_ext_ap($op['wi']['wi_num']);  //取出該筆 bom 內ALL加購記錄
		$num_ext_mat = count($op['ext_mat']);
		if (!$num_ext_mat){	$op['ext_mat_NONE'] = "1";		}
		$j=-1;
		 	for ($i =0; $i< sizeof($op['ext_mat']); $i++)
		 	{
		 			if(!isset($op['ext_mat'][$i]['rcv_qty']))$op['ext_mat'][$i]['rcv_qty'] = '';
		 			$op['ext_mat'][$i]['amount'] = $op['ext_mat'][$i]['po_qty'] * $op['ext_mat'][$i]['prics'];
					$op['ext_mat'][$i]['rcv_amount'] = $op['ext_mat'][$i]['rcv_qty'] * $op['ext_mat'][$i]['prics'];


				if($j == -1)
				{
					$j++;
					$ext_pur[$j] = $op['ext_mat'][$i]['amount'];
					$ext_rcv[$j] = $op['ext_mat'][$i]['rcv_amount'];
					$ext_cry[$j] = $op['ext_mat'][$i]['currency'];
				}else{				
					$tmp_j = -1;
					for($k=0; $k<sizeof($ext_cry); $k++)
					{
						if($ext_cry[$k] == $op['ext_mat'][$i]['currency']) 
						{
							$tmp_j = $k;
							break;
						}					
					}
					if($tmp_j > -1)
					{
						$ext_pur[$tmp_j]+= $op['ext_mat'][$i]['amount'];
						$ext_rcv[$tmp_j]+= $op['ext_mat'][$i]['rcv_amount'];

					}else{
						$j++;
						$ext_pur[$j] = $op['ext_mat'][$i]['amount'];
						$ext_rcv[$j] = $op['ext_mat'][$i]['rcv_amount'];
						$ext_cry[$j] = $op['ext_mat'][$i]['currency'];						
				  } // end if($tmp_j > -1)
				}// end if($j == -1)
				
		 	}	
		if(isset($ext_cry))
		{
			$op['ext_bom_tal'] = $op['ext_rcv_tal'] = $op['ext_pur_tal'] = '';
			for($k=0; $k<sizeof($ext_cry); $k++)
			{
					if($ext_pur[$k] > 0) $op['ext_pur_tal'].=$ext_cry[$k]."$".NUMBER_FORMAT($ext_pur[$k],2,'.',',')."+";
					if($ext_rcv[$k] > 0) $op['ext_rcv_tal'].=$ext_cry[$k]."$".NUMBER_FORMAT($ext_rcv[$k],2,'.',',')."+";
			}

			$op['ext_pur_tal'] = substr($op['ext_pur_tal'],0,-1);
			$op['ext_rcv_tal'] = substr($op['ext_rcv_tal'],0,-1);
		}


		//  取出  BOM  Disable計錄中己採購主料者 --------------------------------------------------------------
		$op['dis_lots_NONE']= '';
		$op['dis_lots'] = $bom->get_dis_lots($op['wi']['id']);  //取出該筆 bom 內記錄
		$num_lots = count($op['dis_lots']);
		if (!$num_lots){	$op['dis_lots_NONE'] = "1";}
		$j=-1;

		 	for ($i =0; $i< sizeof($op['dis_lots']); $i++)
		 	{
		 			if(!isset($op['dis_lots'][$i]['rcv_qty']))$op['dis_lots'][$i]['rcv_qty'] = '';
		 			$op['dis_lots'][$i]['amount'] = $op['dis_lots'][$i]['po_qty'] * $op['dis_lots'][$i]['prics'];
					$op['dis_lots'][$i]['rcv_amount'] =$op['dis_lots'][$i]['rcv_qty'] * $op['dis_lots'][$i]['prics'];
					
					$bom_price = change_unit_price($op['dis_lots'][$i]['po_unit'],$op['dis_lots'][$i]['unit'],$op['dis_lots'][$i]['prics']);
					$op['dis_lots'][$i]['bom_amount'] = $op['dis_lots'][$i]['bom_qty'] * $bom_price;
				if($j == -1)
				{
					$j++;
					$dis_lots_bom[$j] = $op['dis_lots'][$i]['bom_amount'];
					$dis_lots_pur[$j] = $op['dis_lots'][$i]['amount'];
					$dis_lots_rcv[$j] = $op['dis_lots'][$i]['rcv_amount'];
					$dis_lots_cry[$j] = $op['dis_lots'][$i]['currency'];
					
				}else{				
					$tmp_j = -1;
					for($k=0; $k<sizeof($dis_lots_cry); $k++)
					{
						if($dis_lots_cry[$k] == $op['dis_lots'][$i]['currency']) 
						{
							$tmp_j = $k;
							break;
						}					
					}
					if($tmp_j > -1)
					{
						$dis_lots_bom[$tmp_j]+= $op['dis_lots'][$i]['bom_amount'];
						$dis_lots_pur[$tmp_j]+= $op['dis_lots'][$i]['amount'];
						$dis_lots_rcv[$tmp_j]+= $op['dis_lots'][$i]['rcv_amount'];

					}else{
						$j++;
						$dis_lots_bom[$j] = $op['dis_lots'][$i]['bom_amount'];
						$dis_lots_pur[$j] = $op['dis_lots'][$i]['amount'];
						$dis_lots_rcv[$j] = $op['dis_lots'][$i]['rcv_amount'];
						$dis_lots_cry[$j] = $op['dis_lots'][$i]['currency'];						
				  } // end if($tmp_j > -1)
				}// end if($j == -1)
				
		 	}	
		if(isset($dis_lots_cry))
		{
			$op['dis_lots_bom_tal'] =$op['dis_lots_rcv_tal'] = $op['dis_lots_pur_tal'] = '';
			for($k=0; $k<sizeof($dis_lots_cry); $k++)
			{
					
					if($dis_lots_bom[$k] > 0) $op['dis_lots_bom_tal'].=$dis_lots_cry[$k]."$".NUMBER_FORMAT($dis_lots_bom[$k],2,'.',',')."+";
					if($dis_lots_pur[$k] > 0) $op['dis_lots_pur_tal'].=$dis_lots_cry[$k]."$".NUMBER_FORMAT($dis_lots_pur[$k],2,'.',',')."+";
					if($dis_lots_rcv[$k] > 0) $op['dis_lots_rcv_tal'].=$dis_lots_cry[$k]."$".NUMBER_FORMAT($dis_lots_rcv[$k],2,'.',',')."+";
			}

			$op['dis_lots_bom_tal'] = substr($op['dis_lots_bom_tal'],0,-1);
			$op['dis_lots_pur_tal'] = substr($op['dis_lots_pur_tal'],0,-1);
			$op['dis_lots_rcv_tal'] = substr($op['dis_lots_rcv_tal'],0,-1);
		}



		//  取出  BOM  Disable計錄中己採購副料者 --------------------------------------------------------------
		$op['dis_acc_NONE']= '';
		$op['dis_acc'] = $bom->get_dis_acc($op['wi']['id']);  //取出該筆 bom 內記錄
		$num_acc = count($op['dis_acc']);
		if (!$num_acc){	$op['dis_acc_NONE'] = "1";}
		$j = -1;
	 	for ($i =0; $i< sizeof($op['dis_acc']); $i++)
		 	{
		 			if(!isset($op['dis_acc'][$i]['rcv_qty']))$op['dis_acc'][$i]['rcv_qty'] = '';
		 			$op['dis_acc'][$i]['amount'] = $op['dis_acc'][$i]['po_qty'] * $op['dis_acc'][$i]['prics'];
					$op['dis_acc'][$i]['rcv_amount'] =$op['dis_acc'][$i]['rcv_qty'] * $op['dis_acc'][$i]['prics'];

					$bom_price = change_unit_price($op['dis_acc'][$i]['po_unit'],$op['dis_acc'][$i]['unit'],$op['dis_acc'][$i]['prics']);
					$op['dis_acc'][$i]['bom_amount'] = $op['dis_acc'][$i]['bom_qty'] * $bom_price;
				if($j == -1)
				{
					$j++;
					$dis_acc_bom[$j] = $op['dis_acc'][$i]['bom_amount'];
					$dis_acc_pur[$j] = $op['dis_acc'][$i]['amount'];
					$dis_acc_rcv[$j] = $op['dis_acc'][$i]['rcv_amount'];
					$dis_acc_cry[$j] = $op['dis_acc'][$i]['currency'];
				}else{				
					$tmp_j = -1;
					for($k=0; $k<sizeof($dis_acc_cry); $k++)
					{
						if($dis_acc_cry[$k] == $op['dis_acc'][$i]['currency']) 
						{
							$tmp_j = $k;
							break;
						}					
					}
					if($tmp_j > -1)
					{
						$dis_acc_bom[$tmp_j]+= $op['dis_acc'][$i]['bom_amount'];
						$dis_acc_pur[$tmp_j]+= $op['dis_acc'][$i]['amount'];
						$dis_acc_rcv[$tmp_j]+= $op['dis_acc'][$i]['rcv_amount'];

					}else{
						$j++;
						$dis_acc_bom[$j] = $op['dis_acc'][$i]['bom_amount'];
						$dis_acc_pur[$j] = $op['dis_acc'][$i]['amount'];
						$dis_acc_rcv[$j] = $op['dis_acc'][$i]['rcv_amount'];
						$dis_acc_cry[$j] = $op['dis_acc'][$i]['currency'];						
				  } // end if($tmp_j > -1)
				}// end if($j == -1)
				
		 	}	
		if(isset($dis_acc_cry))
		{
			$op['dis_acc_bom_tal'] =$op['dis_acc_rcv_tal'] = $op['dis_acc_pur_tal'] = '';
			for($k=0; $k<sizeof($dis_acc_cry); $k++)
			{
					if($dis_acc_bom[$k] > 0) $op['dis_acc_bom_tal'].=$dis_acc_cry[$k]."$".NUMBER_FORMAT($dis_acc_bom[$k],2,'.',',')."+";
					if($dis_acc_pur[$k] > 0) $op['dis_acc_pur_tal'].=$dis_acc_cry[$k]."$".NUMBER_FORMAT($dis_acc_pur[$k],2,'.',',')."+";
					if($dis_acc_rcv[$k] > 0) $op['dis_lacc_rcv_tal'].=$dis_acc_cry[$k]."$".NUMBER_FORMAT($dis_acc_rcv[$k],2,'.',',')."+";
			}

			$op['dis_acc_bom_tal'] = substr($op['dis_acc_bom_tal'],0,-1);
			$op['dis_acc_pur_tal'] = substr($op['dis_acc_pur_tal'],0,-1);
			$op['dis_acc_rcv_tal'] = substr($op['dis_acc_rcv_tal'],0,-1);
		}


		page_display($op, '065', $TPL_ORD_FANL_VIEW);
		break;
		
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
//	case "fcst_mm_edit":		job 91E  預算更新
//
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "fcst_mm_edit":
check_authority('057',"edit");

$parm = array(
    "dept"  =>  $PHP_dept,
	"fty"   =>  $PHP_fty,
	"cust"	=>  $PHP_cust,
	"year"	=>	$PHP_year,
);

$tt_top = $tt_botton = $tt_top_su = $tt_bottom_su = $tt_qty = $tt_uprc = $tt_cm = 0;
$mm = $PHP_month - 1;
		
$date_check = explode('-',$FTY_ETD_LIMIT);
$date_mk = 0;
if($PHP_year <= $date_check[0])
{
	if($PHP_month <= $date_check[1])
	{
		if($PHP_top) $date_mk = 1;
		if($PHP_bot) $date_mk = 1;
		if($PHP_top_su) $date_mk = 1;
		if($PHP_bot_su) $date_mk = 1;
	}
}
		
if($date_mk == 1)
{
	$message = $date_check[1]."月Pre-Order資料僅能消除,不可修改";
	$op['msg'][]= $message;
	$layout->assign($op);
	$layout->display($TPL_ERROR);  		    
	break;
}


$fcst = $forecast->get('',$parm);

$qty = explode(',',$fcst['qty']);
$top = explode(',',$fcst['top']);
$botton = explode(',',$fcst['botton']);
$top_su = explode(',',$fcst['top_su']);
$bottom_su = explode(',',$fcst['bottom_su']);
$uprc = explode(',',$fcst['uprc']);
$cm = explode(',',$fcst['cm']);
$fcsts = explode(',',$fcst['fcst']);
$qty[12]=$top[12]=$botton[12]=$top_su[12]=$bottom_su[12]=$uprc[12]=$cm[12]=$fcst[12]=0;

for($i=0; $i<sizeof($qty); $i++)
{
    if($i == $mm)
    {
        $top[$i] = str_replace(",","",$PHP_top);
        $botton[$i] = str_replace(",","",$PHP_bot);
        $top_su[$i] = str_replace(",","",$PHP_top_su);
        $bottom_su[$i] = str_replace(",","",$PHP_bot_su);
        // $qty[$i] = ($top[$i] * $pre_su['t']) + ($botton[$i] * $pre_su['b']); //計算數量
        // $qty[$i] = ($top_su[$i]) + ($bottom_su[$i]); //計算數量
        $qty[$i] = ($top[$i] * $top_su[$i]) + ($botton[$i] * $bottom_su[$i]); //計算數量
        $uprc[$i] = str_replace(",","",$PHP_uprc);
        $cm[$i] = str_replace(",","",$PHP_cm);
        $fcsts[$i] = $qty[$i] * $uprc[$i];
    }
    $tt_top += $top[$i];
    $tt_botton += $botton[$i];
    $tt_top_su += $top_su[$i];
    $tt_bottom_su += $bottom_su[$i];
    $tt_qty += $qty[$i];
    $tt_uprc += $uprc[$i];
    $tt_cm += $cm[$i];
    $tt_fcst += $fcsts[$i];
}

$qty[12]	= $tt_qty;
$top[12]	=	$tt_top;
$botton[12] = $tt_botton;
$top_su[12]	=	$tt_top_su;
$bottom_su[12] = $tt_bottom_su;
$uprc[12]	=	$tt_uprc;
$cm[12] = $tt_cm;
$fcsts[12] = $tt_fcst;

$fcst['top']    = Array2csv($top);
$fcst['botton']	= Array2csv($botton);
$fcst['top_su'] = Array2csv($top_su);
$fcst['bottom_su']	= Array2csv($bottom_su);
$fcst['qty']    = Array2csv($qty);
$fcst['uprc']	= Array2csv($uprc);
$fcst['cm']		= Array2csv($cm);
$fcst['fcst']   = Array2csv($fcsts);

//寫入forecast table
if (!$result = $forecast->edit($fcst)) {
    $op['msg']= $forecast->msg->get(2);
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}

$message = "customer: [".$PHP_cust."] in factory:[".$PHP_fty."] forecast of year:[".$PHP_year."]; month :[".$PHP_month."]  done UPDATE";
$log->log_add(0,"057E",$message);
$redir_str = "index2.php?PHP_action=mm_forcast_show&PHP_fty=".$PHP_fty."&PHP_year=".$PHP_year."&PHP_month=".$mm."&PHP_qty=";
redirect_page($redir_str);
break;
			

//====================================================
case "ord_pend_list":
page_display($op,'072', $TPL_ORD_PRD_PEND);
break;

case "ord_pend_list_top":
$op['sday'] =  increceDaysInDate(date('Y-m-d'),-365);
page_display($op,'072', $TPL_ORD_PRD_PEND_TOP);
break;

case "ord_pend_list_main":

$op['rpt']=$report->search_ord_pend(increceDaysInDate(date('Y-m-d'),-365));
$op['rpt'] = bubble_sort($op['rpt']);
$ln_mk=substr($op['rpt'][0]['etd'],0,-3);
for($i=0; $i<sizeof($op['rpt']); $i++)
{
	if($ln_mk <> substr($op['rpt'][$i]['etd'],0,-3))
	{
		$ln_mk = substr($op['rpt'][$i]['etd'],0,-3);
		$op['rpt'][$i]['ln_mk'] = 1;
	}
}
$op['today']=$TODAY;

page_display($op,'072', $TPL_ORD_PRD_PEND_MAIN);
break;	


//=======================================================
	case "order_pic_del":
	check_authority('065',"add");
	echo $PHP_img;
		if(file_exists($GLOBALS['config']['root_dir']."/picture/".$PHP_order."_".$PHP_img.".jpg")){
			unlink("./picture/".$PHP_order."_".$PHP_img.".jpg");
		}
			


	exit;
	break;


//=======================================================
//	case "wi_size_edit_ajx":	修改WI的size資料
//
//=======================================================	
case "wi_size_edit_ajx":

			$size_id=$PHP_Size_id;
			if ($PHP_Size_id==0)
			{
				$PHP_Size_item = strtoupper($PHP_Size_item);
				$PHP_Size = strtoupper($PHP_Size);
				$PHP_base_size = strtoupper($PHP_base_size);
				$parm=array(	'cust'			=>	$PHP_cust,
								'dept'			=>	$PHP_dept_code,
								'size'			=>	$PHP_Size_item,
								'size_scale'	=>	$PHP_Size,
								'base_size'		=>	$PHP_base_size,
								'check'			=>	1,
				);
				$size_id=$size_des->add($parm);				
			}
			
			if(isset($PHP_smpl))
			{
				$smpl2['field_name']='size';
				$smpl2['field_value']=$size_id;
				$smpl2['id']=$PHP_smpl_id;
				$f1 = $smpl_ord->update_field($smpl2);
			}else{
				$f1 = $order->update_field('size', $size_id, $PHP_smpl_id);
			}

			// 取出 size_scale --------
			$size_A = $size_des->get($size_id);
			$op['smpl']['size_scale']=$size_A['size_scale'];
			$sizing = explode(",", $size_A['size']);
			$op['edit_breakdown'] = edit_breakdown($sizing,'',$size_A['base_size']);
			
			$message = "Successfully change size scale : ".$size_A['size_scale'];
			echo $message."|".$op['edit_breakdown'];

break;	

#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#		job 24V sample OUTPUT view
#		case "show_smpl_out_det":
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	case "show_smpl_out_det":

		check_authority('008',"view");

		if (isset($PHP_old_ver))
		{
			$op['order']=$smpl_ord->get(0,0,$PHP_smpl_num);
		}else{
			if(strlen($PHP_smpl_num) > 9)$PHP_smpl_num=substr($PHP_smpl_num,0,-2);	
			$op['order']=$smpl_ord->get(0,0,$PHP_smpl_num);
		}
		
		// 檢查 相片是否存在 2007.03.23
		if(file_exists($GLOBALS['config']['root_dir']."/smpl_pic/".$op['order']['num'].".jpg")){
			$op['main_pic'] = "./smpl_pic/".$op['order']['num'].".jpg";
		} else {
			$op['main_pic'] = "./images/graydot.gif";
		}

	//----- 計算 訂單 IE(SPT) 與上一版(同訂單)的 IE(SPT)的差異值 $diff
		$last_v = substr($op['order']['num'],10)-1;
		$last = substr($op['order']['num'],0,10).$last_v;
	
		if($last_v ==0){
			$op['diff'] = 100;
		}else{
			if (!$last_spt = $smpl_ord->get_fieldvalue('','spt', $last)) {
				$op['msg'] = $smpl_ord->msg->get(2);
				$layout->assign($op);
				$layout->display($TPL_ERROR);  		    
				break;
			}
			if($last_spt['spt']){
				$op['diff'] = ($op['order']['spt']/$last_spt['spt']) * 100;
			}else{
				$op['diff'] = 100;
			}
		}
	//---------------------- end of SPT treating -----------------------------

		// 取出 smpl_log 本訂單 之歷史50筆的計記錄  -------------------
		$logs = $smpl_log->search50($op['order']['num']); 
		if (!$logs){
			$op['msg'] = $smpl_log->msg->get(2);
			$layout->assign($op);
			$layout->display($TPL_ERROR);  		    
			break;
		}
		$op['logs'] = $logs['log'];
		$op['log_records'] = $logs['records'];
		// 將會傳出 op['logs'] 為log的資料 由 $op['log_records']=1 來判斷有無資料
		//--------------------------------
		
		$parm = $op['order'];

		// creat LOG SUBJ combo box
		$op['logs_subj'] = $arry2->select($SMPL_LOG_SUBJ,'','PHP_subj','select','');  	

		$img_size = GetImageSize($op['main_pic']);
		if ($img_size[0] < $img_size[1]) $op['height'] = 1;

//增加前面版本連結
		$tmp_id = substr($op['order']['num'],-1,1);
		$smpl = substr($op['order']['num'],0,-2);
		if ($tmp_id > 1)
		{
			for ($i=1; $i< $tmp_id; $i++)
			{
				$op['ver_num'][($i-1)] = $smpl."-".$i;
			}
			$op['ver_show'] =$i;
		}	

		$layout->assign($op);
		$layout->display($TPL_SMPL_OUTPUT_SHOW);		    	    

		break;
		


//====================================================
// 訂單Shipping List組
//====================================================
case "ord_ship_tal":
page_display($op, '065', $TPL_ORD_SHIP_TAL);
break;

case "ord_ship_tal_top":
$op['sday'] =  increceDaysInDate(date('Y-m-d'),-365);
page_display($op, '065', $TPL_ORD_SHIP_TAL_TOP);
break;

case "ord_ship_tal_main":
		$op['rpt']=$report->search_ship_ord_tbl(increceDaysInDate(date('Y-m-d'),-365));
//		$op['rpt_m']=$report->search_m_ord_tbl();
		$op['today']=$TODAY;
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標(部門)
		$user_team = $GLOBALS['SCACHE']['ADMIN']['team_id'];   // 判定進入身份的指標(team)
		if($user_team == 'SU' || $user_dept == 'SA') $op['ship_flag'] = 1;
		if($user_team == 'SP' || $user_dept == 'SA') $op['ob_flag'] = 1;	
		
page_display($op, '065', $TPL_ORD_SHIP_TAL_MAIN);
break;

//====================================================
// 使用AJAX修改Est. SHip Date
//====================================================
case "ord_eship_update":
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];
		if($user_dept == $PHP_dept || $user_dept == 'SA')
		{		
			$f1=$order->update_pdtion_field('e_ship',$PHP_e_ship, $PHP_id, 'pdtion');
			$f1=$order->update_pdtion_field('e_ship_way',$PHP_ship_way, $PHP_id, 'pdtion');
			
			if($PHP_ship_way == 'Air') $PHP_ship_way= "<FONT COLOR=red size=3><B>".$PHP_ship_way."</B></FONT>";
			$mesg = "Successfully update Est. SHIP on ORDER :".$PHP_ord_num;
			$log->log_add(0,"101E",$mesg);		
			$button = "	<span style='cursor:hand' onClick=\"ship_edit".$PHP_id.".style.display='block';ship_show".$PHP_id.".style.display='none'\">&nbsp;&nbsp;<img src='images/Add.gif'  border=0 valign='bottom'> </span>";
			echo "<small>".$PHP_e_ship." BY ".$PHP_ship_way."</small>".$button."|".$mesg."|S";
		}else{
			$mesg = "YOU DON'T HAVE AUTHORITY.";
			echo "|".$mesg."|F";

		}
	break;
	exit;	
//====================================================
// 使用AJAX修改 出貨(上船時間)
//====================================================
case "ord_ob_update":
		$user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];
		$user_team = $GLOBALS['SCACHE']['ADMIN']['team_id'];
		if($user_team == 'SP' || $user_dept == 'SA')
		{		
			$f1=$order->update_pdtion_field('ob_date',$PHP_ob_date, $PHP_id, 'pdtion');
			$f1=$order->update_pdtion_field('ob_way',$PHP_ob_way, $PHP_id, 'pdtion');

			if($PHP_ob_way == 'Air') $PHP_ob_way = "<FONT COLOR=red size=3><B>".$PHP_ob_way."</B></FONT>";

			$mesg = "Successfully update On Boat on ORDER :".$PHP_ord_num;
			$log->log_add(0,"101E",$mesg);		
			$button = "	<span style='cursor:hand' onClick=\"ob_edit".$PHP_id.".style.display='block';ob_show".$PHP_id.".style.display='none'\">&nbsp;&nbsp;<img src='images/Add.gif'  border=0 valign='bottom'> </span>";
			echo "<small>".$PHP_ob_date." BY ".$PHP_ob_way."</small>".$button."|".$mesg."|S|".$PHP_ob_date."|".$PHP_ob_way;
		}else{
			$mesg = "YOU DON'T HAVE AUTHORITY.";
			echo "|".$mesg."|F";

		}		

	break;
	exit;	

				


#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
#			 job 101  訂 單
#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
case "order_entry":
check_authority('065',"view");

$where_str = $manager = $manager_v = $dept_id = '';
$dept_ary = array();
// $sales_dept_ary = get_sales_dept(); // 取出 業務的部門 [不含K0] ------
// $user_dept = $GLOBALS['SCACHE']['ADMIN']['dept'];   // 判定進入身份的指標
// $team = $GLOBALS['SCACHE']['ADMIN']['team_id'];		// 判定進入身份的Team

// $op['factory'] = $arry2->select($FACTORY,'','PHP_factory','select','');

// for ($i=0; $i<count($sales_dept_ary);$i++){
    // if($user_dept == $sales_dept_ary[$i]){

        // # 如果是業務部進入 則dept_code 指定該業務部---
        // $dept_id = $sales_dept_ary[$i];  
    // }
// }

// if (!$dept_id) {    // 當不是業務部人[也不含 K0 的人 ]進入時
    // $manager = 1;
    // #業務部門 select選單
    // $dept_ary = $arry2->select($sales_dept_ary,$GLOBALS['SCACHE']['ADMIN']['dept'],"PHP_dept_code","select","get_dept(this)");  
// }

// if(($user_dept == 'HJ' ||$user_dept == 'LY' ||$user_dept == 'CF' ) && $team <> 'MD' ) 		
// { #當工廠人員但不是MD Team
    // $manager = 1;
    // #業務部門 select選單
    // $dept_ary = $arry2->select($sales_dept_ary,$GLOBALS['SCACHE']['ADMIN']['dept'],"PHP_dept_code","select","get_dept(this)");  
    // $where_str ='';
// }

// $op['manager_flag'] = $manager;
// $op['dept_id'] = $dept_id;
// $op['dept_ary'] = $arry2->select(get_team_group(),$GLOBALS['SCACHE']['ADMIN']['dept'],"PHP_dept_code","select","get_dept(this)");  
$op['factory_select'] = $arry2->select(get_factory_group(),'','PHP_factory','select','');
$op['team_select'] = $arry2->select(get_team_group(),"","PHP_dept_code","select","get_dept(this)"); 
$op['dept_select'] = $arry2->select(get_dept_group(),"","PHP_dept","select",""); 

$op['msg'] = $order->msg->get(2);
// creat cust combo box
// 取出 客戶代號
$where_str=$where_str."order by cust_s_name"; //依cust_s_name排序
if(!$cust_def = $cust->get_fields('cust_init_name',$where_str)){;  //取出客戶簡稱
    $op['msg'][] = "sorry! there is no any customer record in your team, please add customer first!";
    $layout->assign($op);
    $layout->display($TPL_ERROR);  		    
    break;
}

$cust_def_vue = $cust->get_fields('cust_s_name',$where_str);	//取出客戶代號
for ( $i=0; $i< sizeof($cust_def); $i++ ) {
    $cust_value[$i]=$cust_def_vue[$i]." - ".$cust_def[$i];	//以 [客戶代號-客戶簡稱] 呈現
}

$op['cust_select'] =  $arry2->select($cust_value,'','PHP_cust','select','check_add(this)',$cust_def_vue); 
$op['cust_select2'] =  $arry2->select($cust_value,'','PHP_cust','select','',$cust_def_vue); 
$op['year_select'] =  $arry2->select($YEAR_WORK,date('Y'),'SCH_year','select'); 
$op['month_select'] =  $arry2->select($MONTH_WORK,'','SCH_month','select'); 

// creat factory combo box
//080725message增加		
$note=$notify->search($GLOBALS['SCACHE']['ADMIN']['login_id'], "`read`=0");
$op['max_notify'] = $note['max_no'];		  	
// print_r($op);
page_display($op,'065', $TPL_ORDER);			    	    
break;


	
//====================================================
// case "do_order_lots_chk":
//====================================================
case "do_order_lots_chk":
		$order->update_field('lots_chk', 1, $PHP_id);

	break;
	exit;	

//=======================================================2011/11/14
	case "smpl_ti_copy_view2":

		check_authority("010","view");

		// 將 製造令 完整show out ------
		//  wi 主檔

			if(!$op = $smpl_wi->get_all($PHP_id)){    //取出該筆 製造令記錄 ID
						$op['msg']= $smpl_wi->msg->get(2);
						$layout->assign($op);
						$layout->display($TPL_ERROR);  		    
						break;
			}

//--------------------------------------------------------------------------
		//  wi_qty 數量檔
		$where_str = " WHERE wi_id='".$op['wi']['id']."' ";
		$T_wiqty = $smpl_wiqty->search(1,$where_str);

		$num_colors = count($T_wiqty);

		// 取出 size_scale ----------------------------------------------
		$size_A = $size_des->get($op['smpl']['size']);
		$op['smpl']['size_scale']=$size_A['size_scale'];
			//????????????????????????????????????? 注意 有時沒有 size type 資料時??????
		$sizing = explode(",", $size_A['size']);

			// 做出 size table-------------------------------------------
		$reply = show_breakdown($T_wiqty,$sizing,$size_A['base_size']);
		$op['show_breakdown'] = $reply['html'];
		$op['total'] = $reply['total'];
		//-----------------------------------------------------------------

//檔案列表
		$op['done'] = $fils->get_smpl_file($op['wi']['wi_num']);

		if(count($op['ti']))
		{
		 for ($i=0; $i<sizeof($op['ti']); $i++)
			$op['ti'][$i]['detail'] = str_replace( chr(13).chr(10), "<br>", $op['ti'][$i]['detail'] );
		}

    $op['org_smpl_id'] = $PHP_smpl_id;
    $op['copy_search'] = "&PHP_smpl_id=".$PHP_smpl_id."&PHP_c_dept=".$PHP_c_dept."&PHP_c_cust=".$PHP_c_cust;

		$back_str = "&PHP_sr_startno=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str']=$back_str;
		$back_str2 = "&PHP_sr=".$PHP_sr."&PHP_dept_code=".$PHP_dept_code."&PHP_num=".$PHP_num."&PHP_cust=".$PHP_cust."&PHP_ref=".$PHP_ref."&PHP_factory=".$PHP_factory."&PHP_etdstr=".$PHP_etdstr."&PHP_etdfsh=".$PHP_etdfsh;
		$op['back_str2']=$back_str2;

		page_display($op, "010", $TPL_SMPL_TI_COPY_VIEW2);			
		break;	
		
//====================================================2011/11/14
    case "do_smpl_ti_copy2":
	
		check_authority('021',"add");
		// 將 製造令 完整show out ------
		//  wi 主檔
		
		$f1=$ti->del_wi_id($PHP_smpl_id,0);	//COPY動作執行前,先把之前的WS刪除,避免重覆資料
		$f1=$smpl_wi->copy_ti2($PHP_id,$PHP_smpl_id);

		$op=$smpl_wi->get_all($PHP_id);
		
		$message = "Add WI:[".$op['wi']['wi_num']."] Description Copy。";
		$log->log_add(0,"34C",$message);
		$sub_ti = array();
		$redir_str=$PHP_SELF.'?PHP_action=ti_add&PHP_id='.$PHP_smpl_id.$PHP_back_str2.'&PHP_msg='.$message;
		redirect_page($redir_str);
		break;
	
//-------------------------------------------------------------------------

}   // end case ---------

?>
